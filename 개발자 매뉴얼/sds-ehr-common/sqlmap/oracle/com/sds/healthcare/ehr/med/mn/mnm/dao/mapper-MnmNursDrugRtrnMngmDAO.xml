<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : mapper_MnmNursDrugRtrnMngmDAO_sql.xml 
    Description : -->
<mapper namespace="MnmNursDrugRtrnMngmDAO">




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpRtrnResnSave () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpRtrnResnSave"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpRtrnResnSave  mnd_medordt_u85$I01_예외사유반납약처방테이블업데이트 */
				   MDMEDORDT
			  set
				   RTRN_EXRE_CTN       = decode(#{rtrnExreCtn}, '04', '', #{rtrnExreCtn})
				,  EXRE_RTRN_QTY       = decode(#{rtrnExreCtn}, '04', null, #{exreRtrnQty})
				,  EXRE_RTPR_ID        = #{exreRtprId}
				,  EXRE_RTRN_DT        = sysdate
				,  LAST_UPDR_ID        = #{gvUserId}
				,  LAST_UPDT_IP        = #{gvUserIp}
				,  LAST_UPDT_DT        = SYSDATE
				,  LAST_UPDT_CLNT_PRGM_ID   = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID   = #{gvSrvrPrgmId}
			where
				   ptno     = #{ptno}
			  and  ordr_ymd = to_date(#{ordrYmd}, 'YYYYMMDD')
			  and  ordr_sno = #{ordrSno}
			]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="evntTypCd" column="EVNT_TYP_CD"/>
		<result property="afiMdprRtrnNtmStr" column="AFI_MDPR_RTRN_NTM_STR"/>
		<result property="afiRtrnRqstCqyStr" column="AFI_RTRN_RQST_CQY_STR"/>
		<result property="afiPtadRtrnQtyStr" column="AFI_PTAD_RTRN_QTY_STR"/>
		<result property="afiTotlQtyStr1" column="AFI_TOTL_QTY_STR_1"/>
		<result property="afiTotlQtyStr2" column="AFI_TOTL_QTY_STR_2"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnInqr  mnd_sdjdgrt_s01$S01_약처방별 반납내역 단건조회DAM */
				   'U' as EVNT_TYP_CD
				,  to_char(sum(a.MDPR_RTRN_NTM)) as AFI_MDPR_RTRN_NTM_STR  /* 총 반납횟수 */
				,  to_char(sum(a.RTRN_RQST_CQY)) as AFI_RTRN_RQST_CQY_STR  /* 총 반납요청수량*/
				,  to_char(sum(a.PTAD_RTRN_QTY)) as AFI_PTAD_RTRN_QTY_STR  /* 총 원무반납량*/
				,  to_char(
					   FN_SD_TOTIVQTY_S(
						   #{afiPcknUnadQtyStr}    /* 포장단위투여량스트링*/
						 , #{afiNtmStr}              /* 횟수*/
						 , #{afiDdcnStr}
						 , #{totlQtyClclCd}
						 , #{drapDvsnCd}
						 , #{drugOrdrPrssCd})
				   ) as AFI_TOTL_QTY_STR_1               /* 총량 */
				,  to_char(
					   FN_SD_TOTIVQTY_S(
						   #{afiPcknUnadQtyStr}
						 , #{afiNtmStr} - #{afiRtrnNtmStr} - nvl(sum(a.MDPR_RTRN_NTM), 0)  /* 처방횟수-반납횟수-이미반납처리된횟수 */
						 , #{afiDdcnStr}
						 , #{totlQtyClclCd}
						 , #{drapDvsnCd}
						 , #{drugOrdrPrssCd})
				   ) as AFI_TOTL_QTY_STR_2              /* 남은총량 */
			 from  SDJDGRTNT a
			where  a.ORDR_YMD          = to_date(#{ordrYmd}, 'YYYYMMDD')
			  and  a.MDTN_NO_DVSN_CD   = #{mdtnNoDvsnCd}
			  and  a.MDTN_NO           = #{mdtnNo}
			  and  a.RTRN_DETL_DVSN_CD <> 'Z'
			  and  a.PTNO              = #{ptno}
			  and  a.ORDR_SNO          = #{ordrSno}
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnOrdrInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="evntTypCd" column="EVNT_TYP_CD"/>
		<result property="afiMdprRtrnNtmStr" column="AFI_MDPR_RTRN_NTM_STR"/>
		<result property="afiRtrnRqstCqyStr" column="AFI_RTRN_RQST_CQY_STR"/>
		<result property="afiPtadRtrnQtyStr" column="AFI_PTAD_RTRN_QTY_STR"/>
		<result property="afiTotlQtyStr1" column="AFI_TOTL_QTY_STR_1"/>
		<result property="afiTotlQtyStr2" column="AFI_TOTL_QTY_STR_2"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnOrdrInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnOrdrInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnOrdrInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnOrdrInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnOrdrInqr  mnd_sdjdgrt_s02$S01_약처방별 반납내역2 단건조회DAM */
				   'I' as EVNT_TYP_CD
				,  '' as AFI_MDPR_RTRN_NTM_STR
				,  '' as AFI_RTRN_RQST_CQY_STR
				,  '' as AFI_PTAD_RTRN_QTY_STR
				,  to_char(
					   FN_SD_TOTIVQTY_S(
						   #{afiPcknUnadQtyStr}
						 , to_char(to_number(#{afiNtmStr}) * decode(to_number(#{afiDdcnStr}), 0, 1, to_number(#{afiDdcnStr}))) 
						 , '1'
						 , #{totlQtyClclCd}
						 , #{drapDvsnCd}
						 , #{drugOrdrPrssCd})
				   ) as AFI_TOTL_QTY_STR_1
				,  to_char(
					   FN_SD_TOTIVQTY_S(
						   #{afiPcknUnadQtyStr}
						 , to_char((to_number(#{afiNtmStr}) - to_number(#{afiRtrnNtmStr})) * decode(to_number(#{afiDdcnStr}), 0, 1, to_number(#{afiDdcnStr})))
						 , '1'
						 , #{totlQtyClclCd}
						 , #{drapDvsnCd}
						 , #{drugOrdrPrssCd})
				   ) as AFI_TOTL_QTY_STR_2
			 from  DUAL
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnNoInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="mdtnNo" column="MDTN_NO"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnNoInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnNoInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnNoInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnNoInqr-result" useCache="true" flushCache="false">
			<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnNoInqr  mnd_sdpordb_l01$S01_투약번호조회 다건조회DAM */
					   a.MDTN_NO as MDTN_NO               /*  투약번호         */
				 from
					   SDPORDBAT a      /*  처방조제기본 */
					,  SDPORDDET b      /*  처방조제상세 */
				where  a.PTNO         = #{ptno}
				  and  a.ORDR_YMD     = to_date(#{ordrYmd}, 'YYYYMMDD')
				  and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
				  and  a.MDTN_NO      = #{mdtnNo}
				  and  a.MDTN_LCDV_CD = #{mdtnLcdvCd}
				  and  a.NNRC_RTRN_CNFM_ID is not null
				  and  a.ORDR_YMD     = b.ORDR_YMD
				  and  a.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
				  and  a.MDTN_NO      = b.MDTN_NO
				  and  a.MDTN_LCDV_CD = b.MDTN_LCDV_CD
				  and  b.MDPR_CD = nvl(#{ordrCd}, b.MDPR_CD)
				  and  (
					   (#{ordrCd} is not null and b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7'))
					   or
					   (#{ordrCd} is null)
					   )
		   /*        and  exists (select 'Y'                              /*  미수령반납은 진행상태가 1일때만 가능함. 그 이후는 미수령 반납 불가.*/ /* => asis대로 바꿈 이거왜걸렸을까? */
		   /*                       from mdmedordt x */
		   /*                      where x.ptno = b.ptno */
		   /*                        and x.ordr_ymd = b.ordr_ymd */
		   /*                        and x.ordr_sno = b.ordr_sno */
		   /*                        and x.drug_ordr_prss_cd not in ('0', '1')) */
				]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDschChckInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="chckSttsCd" column="CHCK_STTS_CD"/>
		<result property="dschPrrnDt" column="DSCH_PRRN_DT"/>
		<result property="dschDt" column="DSCH_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDschChckInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDschChckInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDschChckInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDschChckInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDschChckInqr  mdd_rcrptnt_s85$S01_퇴원심사체크 */
				   z.CHCK_STTS_CD as CHCK_STTS_CD
				,  z.DSCH_PRRN_DT as DSCH_PRRN_DT
				,  z.DSCH_DT as DSCH_DT
			 from
				(
				   select
						   CHCK_STTS_CD                        CHCK_STTS_CD
						,  to_char(DSCH_PRRN_DT , 'YYYYMMDD')  DSCH_PRRN_DT
						,  to_char(DSCH_DT      , 'YYYYMMDD')  DSCH_DT      /*  퇴원예정일           */
					 from
						   APRCRPTNT
					where
						   MDRP_NO = #{mdrpNo}
					  and  #{codvCd} = 'I'
					  and  CNCL_DT is null
					union  all
				   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDschChckInqr  mdd_rcrptnt_s85$S01_퇴원심사체크 */
						   a.CHCK_STTS_CD                       CHCK_STTS_CD
						,  to_char(a.DSCH_PRRN_DT , 'YYYYMMDD') DSCH_PRRN_DT
						,  to_char(DSCH_DT      , 'YYYYMMDD')  DSCH_DT      /*  퇴원예정일           */
					 from
						   APRCRPTNT a
						,  MNEERRPAT b
					where
						   a.MDRP_NO = #{mdrpNo}
					  and  #{codvCd} = 'E'
					  and  b.MDRP_NO   = a.MDRP_NO
					  and  CNCL_DT is null
					  and  nvl(to_char(b.CHOT_DT  , 'YYYYMMDD'), '29991231') <> '29991231'  /* 퇴실일자가 안들어간경우 */
				  ) z
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listCmmdBefRtrnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="cmmdBefrRtrnDvsnCd" column="CMMD_BEFR_RTRN_DVSN_CD"/>
		<result property="cmmdBefrRtrnDt" column="CMMD_BEFR_RTRN_DT"/>
		<result property="cmmdBefrRtprId" column="CMMD_BEFR_RTPR_ID"/>
		<result property="afiRtprNm" column="AFI_RTPR_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listCmmdBefRtrnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listCmmdBefRtrnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listCmmdBefRtrnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listCmmdBefRtrnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listCmmdBefRtrnInqr  mnd_medordt_l80$S01_조제전 반납정보 조회 DAM */
				   a.CMMD_BEFR_RTRN_DVSN_CD as CMMD_BEFR_RTRN_DVSN_CD
				,  to_char(a.CMMD_BEFR_RTRN_DT, 'yyyymmdd') as CMMD_BEFR_RTRN_DT
				,  a.CMMD_BEFR_RTPR_ID as CMMD_BEFR_RTPR_ID
				,  (select USER_NM from CCUSRDPHT where USER_ID = a.CMMD_BEFR_RTPR_ID) as AFI_RTPR_NM
			 from  MDMEDORDT a
			where  PTNO     = #{ptno}
			  and  ORDR_SNO = #{ordrSno}
			  and  ORDR_YMD = to_date(#{ordrYmd}, 'yyyymmdd')
			]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateCmmdBefDrugRtrnUpdt () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateCmmdBefDrugRtrnUpdt"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateCmmdBefDrugRtrnUpdt  mnd_medordt_u01$I01_조제전 약반납 저장 DAM */
				   MDMEDORDT
			  set
				   CMMD_BEFR_RTRN_DVSN_CD  = decode(nvl(#{cmmdBefrRtrnDvsnCd}, '-'), 'C', '', #{cmmdBefrRtrnDvsnCd})
				,  CMMD_BEFR_RTRN_DT       = decode(nvl(#{cmmdBefrRtrnDvsnCd}, '-'), 'C', '',
														decode(#{cmmdBefrRtrnDt}, '', sysdate
																							 , to_date(#{cmmdBefrRtrnDt}||to_char(SYSDATE,'hh24:mi:ss'), 'yyyymmddhh24:mi:ss')))
				,  CMMD_BEFR_RTPR_ID       = #{cmmdBefrRtprId}
				,  SRRQ_CMNT_CTN           = #{srrqCmntCtn}
				,  DURV_RTRN_DDCN          = decode(nvl(#{cmmdBefrRtrnDvsnCd}, '-'), 'C', 0, DURV_RTRN_DDCN)
				,  LAST_UPDR_ID            = #{gvUserId}
				,  LAST_UPDT_IP            = #{gvUserIp}
				,  LAST_UPDT_DT            = sysdate
				,  LAST_UPDT_CLNT_PRGM_ID       = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID       = #{gvSrvrPrgmId}
			where
				   PTNO                    = #{ptno}
			  and  ORDR_YMD                = to_date(#{ordrYmd}, 'YYYYMMDD')
			  and  ORDR_SNO                = #{ordrSno}
			]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDurvYnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="durvYn" column="DURV_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDurvYnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDurvYnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDurvYnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDurvYnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDurvYnInqr  mnd_medordt_s10$S01_DUR여부조회 DAM */
				   'Y' as DURV_YN
			 from  MDMEDORDT
			where  PTNO     = #{ptno}
			  and  ORDR_YMD = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  ORDR_SNO = #{ordrSno}
			  and  (( PTAD_CODV_CD = 'E' )
				   or
				   ( PTAD_CODV_CD = 'O' )
				   or
				   ( PTAD_CODV_CD = 'D' )
				   or
				   (( PTAD_CODV_CD = 'I' )
					and
					( ODKI_CD = 'D' )))
			 and   ORDR_YMD >= trunc(sysdate)
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrDdcnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="ddcn" column="DDCN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrDdcnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrDdcnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrDdcnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrDdcnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrDdcnInqr  mnd_medordt_s11$S01_해당처방의 일수조회 */
				   DDCN as DDCN
			 from  MDMEDORDT
			where  PTNO     = #{ptno}
			  and  ORDR_YMD = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  ORDR_SNO = #{ordrSno}
			]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDurvDdcnSave () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDurvDdcnSave"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDurvDdcnSave  mnd_medordt_u02$I01_DUR일수 저장 DAM */
				   MDMEDORDT
			  set  DURV_RTRN_DDCN    = nvl(#{ddcn}, 0)
				,  LAST_UPDR_ID      = #{gvUserId}
				,  LAST_UPDT_IP      = #{gvUserIp}
				,  LAST_UPDT_DT      = sysdate
				,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
			where
				   PTNO      = #{ptno}
			  and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  ORDR_SNO  = #{ordrSno}
			]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDrugRtrnDprtMdfc () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDrugRtrnDprtMdfc"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDrugRtrnDprtMdfc  sdd_mngrtnt_u01$U01_약반납부서변경DAM */
				   SDJDGRTNT
			  set  ARVL_DPRT_CD         = #{arvlDprtCd}
				,  LAST_UPDR_ID         = #{gvUserId}
				,  LAST_UPDT_IP         = #{gvUserIp}
				,  LAST_UPDT_DT         = sysdate
				,  LAST_UPDT_CLNT_PRGM_ID    = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID    = #{gvSrvrPrgmId}
			where  ORDR_YMD             = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  MDTN_NO_DVSN_CD      = #{mdtnNoDvsnCd}
			  and  MDTN_NO              = to_number(#{mdtnNo})
			  and  MDTN_LCDV_CD         = #{mdtnLcdvCd}
			  and  ORDR_SNO             = to_number(#{ordrSno})
			  and  RTRN_RQST_DT         = to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')
			  and  MDPR_CD              = #{mdprCd}
			  and  RTRN_CNFR_YMD is null
			]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseGnrlDrugRtrnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="arvlDprtCd" column="ARVL_DPRT_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="afiAdmnVlmStr" column="AFI_ADMN_VLM_STR"/>
		<result property="icunCd1" column="ICUN_CD_1"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="afiRtrnCqyStr" column="AFI_RTRN_CQY_STR"/>
		<result property="afiRtrnCqyStr1" column="AFI_RTRN_CQY_STR_1"/>
		<result property="rtrnYn" column="RTRN_YN"/>
		<result property="refnYn" column="REFN_YN"/>
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
		<result property="orfrCd" column="ORFR_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="afiPcknUnadQtyStr" column="AFI_PCKN_UNAD_QTY_STR"/>
		<result property="afiAdmnVlmStr1" column="AFI_ADMN_VLM_STR_1"/>
		<result property="afiDdcnStr" column="AFI_DDCN_STR"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="rtrnRqprId" column="RTRN_RQPR_ID"/>
		<result property="afiRtrnRqprNm" column="AFI_RTRN_RQPR_NM"/>
		<result property="drugOrdrPrssCd" column="DRUG_ORDR_PRSS_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="mdprCd1" column="MDPR_CD_1"/>
		<result property="afiAdmnVlmStr2" column="AFI_ADMN_VLM_STR_2"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="rtrnDvsnCd" column="RTRN_DVSN_CD"/>
		<result property="afiRtrnCqyStr2" column="AFI_RTRN_CQY_STR_2"/>
		<result property="cockYn" column="COCK_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="frnsCtrlDvsnCd" column="FRNS_CTRL_DVSN_CD"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="carePrinDt" column="CARE_PRIN_DT"/>
		<result property="userNm" column="USER_NM"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="userNm2" column="USER_NM_2"/>
		<result property="rtrnCnfrDt" column="RTRN_CNFR_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseGnrlDrugRtrnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseGnrlDrugRtrnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseGnrlDrugRtrnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseGnrlDrugRtrnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseGnrlDrugRtrnInqr  mnd_jdgrtnt_l01$S01_약반납내역 조회 반납일자기준DAM */
				   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss') as RTRN_RQST_DT                     /*  반납요청자일시       */
				,  to_char(a.ORDR_YMD, 'yyyymmdd') as ORDR_YMD                         /*  처방일자             */
				,  e.ARVL_DPRT_CD as ARVL_DPRT_CD                     /*  병동                 */
				,  e.PTNO as PTNO                             /*  환자번호             */
				,  ( select  PTNT_NM from  APPTPTNTT where  PTNO = e.PTNO ) as PTNT_NM                             /*  환자번호             */
				,  e.MDPR_CD as MDPR_CD                          /*  약품코드             */
				,  c.ORDR_NM as ORDR_NM                          /*  처방명               */
				,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)) as AFI_ADMN_VLM_STR             /*  투여량(함량단위)     */
				,  decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCUN_CD, a.ICUN_CD) as ICUN_CD_1                                         /*  단위(함량단위)       */
				,  a.DC_DVSN_CD as DC_DVSN_CD                       /*  D/C여부     */
				,  e.DRUG_RTRE_CD as DRUG_RTRE_CD                     /*  반납사유             */
				,  decode(e.DSCH_ATMT_RTRN_YN, 'Y'
											 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
												   from CCCMCDDMT A, CCCMCDDLT B
												   where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													 and A.COMN_GRP_CD  = 'SD068'
													 and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													 and B.LNGG_CD(+)   = nvl('', '*'))||'(퇴)'
											, ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
												   from CCCMCDDMT A, CCCMCDDLT B
												   where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													 and A.COMN_GRP_CD  = 'SD068'
													 and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													 and B.LNGG_CD(+)   = nvl('', '*'))) as CD_NM     /*  반납사유(퇴원자동반납여부) */
				,  to_char(e.MDPR_RTRN_NTM) as AFI_RTRN_NTM_STR                 /*  반납횟수       */
				,  to_char(e.RTRN_RQST_CQY) as AFI_RTRN_CQY_STR                 /*  반납요청수량         */
				,  to_char(e.PTAD_RTRN_QTY) as AFI_RTRN_CQY_STR_1                /*  원무반납량         */
				,  e.RTRN_YN as RTRN_YN                          /*  반납확인여부         */
				,  decode(e.REFN_YN, 'N', '', e.REFN_YN) as REFN_YN                          /*  환불여부             */
				,  to_char(a.NTM) as AFI_NTM_STR                      /*  횟수                 */
				,  a.ORFR_CD as ORFR_CD                          /*  처방형태             */
				,  to_char(a.MDTN_NO) as AFI_MDTN_NO_STR                  /*  투약번호             */
				,  to_char(a.ORDR_SNO) as AFI_ORDR_SNO_STR                 /*  처방순번             */
				,  a.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD                /*  선택단위구분         */
				,  to_char(a.PCKN_UNAD_QTY) as AFI_PCKN_UNAD_QTY_STR            /*  투여량(포장단위)     */
				,  to_char(a.ICUN_ADMN_VLM) as AFI_ADMN_VLM_STR_1                /*  투여량(함량단위)     */
				,  to_char(a.DDCN) as AFI_DDCN_STR                     /*  일수                 */
				,  a.DRAP_DVSN_CD as DRAP_DVSN_CD                     /*  약적용구분(SD002)      */
				,  c.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD                 /*  총량계산코드         */
				,  a.ODKI_CD as ODKI_CD
				,  e.RTRN_RQPR_ID as RTRN_RQPR_ID
				, ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
				,  a.DRUG_ORDR_PRSS_CD as DRUG_ORDR_PRSS_CD
				,  e.PTRM_NO as PTRM_NO
				,  e.SCKB_NO as SCKB_NO
				,  a.WARD_CD as WARD_CD
				,  a.PCUN_CD as PCUN_CD                          /*  포장단위코드           */
				,  c.MDPR_CLSF_CD as MDPR_CLSF_CD                     /*  약품분류코드 (SD001)  */
				,  d.MDPR_CD as MDPR_CD_1
				,  to_char((decode(a.SLCT_UNIT_DVSN_CD, '2'
													  , decode(sign(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)
																  - decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, c.PCUN_INLS_QTY))
																   , 1, ceil(e.PTAD_RTRN_QTY)
																	  , trunc(e.PTAD_RTRN_QTY))
													  , trunc(e.PTAD_RTRN_QTY)
								   )
							)
						   ) as AFI_ADMN_VLM_STR_2
				,  e.PTDV_CD as PTDV_CD
				,  e.RTRN_DVSN_CD as RTRN_DVSN_CD                          /*  반납구분코드 (SD051)(N:간호입력 P:약국입력) */
				,  e.RTRN_CNFR_CQY as AFI_RTRN_CQY_STR_2                     /*  반납(확인)수량     */
				,  d.COCK_YN as COCK_YN
				,  nvl(c.STST_DVSN_CD, '*') as STST_DVSN_CD                          /*  통계구분(약품코드:SD008) */
				,  a.OROC_DPRT_CD as OROC_DPRT_CD
				,  a.FRNS_CTRL_DVSN_CD as FRNS_CTRL_DVSN_CD                     /*  **. 불출제어 플래그(SD800) - B1:모호한, B2:명확한 */
				,  c.CLNC_EXAM_DRUG_YN as CLNC_EXAM_DRUG_YN
				,  e.MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD                       /*  투약번호구분코드(BDGORDTYP)   */
				,  e.MDTN_LCDV_CD as MDTN_LCDV_CD                          /*  투약위치구분코드(DGLOCATFG)   */
				, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = e.ARVL_DPRT_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD
				, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.WARD_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD_1
				, to_char(e.CARE_PRIN_DT, 'yyyymmddhh24miss') as CARE_PRIN_DT
				, (select x.USER_NM
					 from ccuseramt x
					where x.lgin_id = e.CARE_PNPR_ID
					  and rownum = 1) as USER_NM
			    , e.MDTN_NO as MDTN_NO
			    , e.ORDR_SNO as ORDR_SNO
			    , ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_CNFM_ID ) as USER_NM_2
			    , to_char(e.RTRN_CNFR_DT, 'yyyymmddhh24miss') as RTRN_CNFR_DT
			 from
				   SDJREQADT d              /*  부서약품청구보조관리(부서별 청구가능 약품별 수량을 미리 정해둔 엔터티) */
				,  MDORDRCMT c              /*  처방코드기본 */
				,  MDMEDORDT a              /*  약처방 */
				,  SDJDGRTNT e              /*  처방성약품반납관리 */
			where
				   e.PTNO                      = a.PTNO                                                  /*  환자번호             */
			  and  e.ORDR_YMD                  = a.ORDR_YMD                                              /*  처방일자             */
			  and  e.ORDR_SNO                  = a.ORDR_SNO                                              /*  처방순번             */
			  and  e.MDTN_LCDV_CD              = a.MDTN_LCDV_CD                                          /*  투약위치             */
			  and  nvl(e.ARVL_DPRT_CD, 'ZZ')   = nvl(#{wardCd}, nvl(e.ARVL_DPRT_CD, 'ZZ'))                /*  발생처(도착지-약국)  */
			  and  e.RTRN_RQST_DT             between to_date(#{inqrStrtYmd} || nvl(#{inqrStrtDt}, '00') || '0000', 'yyyymmddhh24miss')
			  									   and to_date(#{inqrStrtYmd} || nvl(#{inqrFnshDt}, '23') || '5959', 'yyyymmddhh24miss')                             /*  반납요청자일시       */
			  and  e.PTNO                      = nvl(#{ptno}, e.PTNO)
			  and  e.MDPR_CD                   = c.ORDR_CD                                               /*  처방코드             */
			  and  nvl(e.TEAM_CD, 'Z')         = decode(#{teamCd}, '*', nvl(e.TEAM_CD, 'Z'), #{teamCd})
			  and  e.ARVL_DPRT_CD              = d.DPRT_CD(+)
			  and  e.MDPR_CD                   = d.MDPR_CD(+)
			  and  nvl(e.STDL_DETL_DVSN_CD, 'Z')   <> 'T'                                                      /*  입출고상세구분코드 (SD010) TPN 반납약 제외  */
			  and  a.MDPR_CLSF_CD  not in  ('2', '3')                                                    /*  향정, 마약 아니거나 */
			  /* and  a.DRAP_DVSN_CD <> '2'                                                 /*  주사약 아니거나     */
			  and  e.DRUG_RTRE_CD <> '7'                                                                   /*  2009.06.02 미수령자동반납 제외 */
			  and  (
					  ( ((#{dprtCd} = 'W') and ( #{wardCd} = fn_cc_get_dprt_cd('WARD_DLR') ) and fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'W|MDP_408|MDP_410') = 'Y') /* 분만 171138 */
						or
						((#{dprtCd} = 'W') and ( #{wardCd} <> fn_cc_get_dprt_cd('WARD_DLR') ))   ) or   /* 171138 */
					  (#{dprtCd} = 'O') or        /*  기타장소(ORDACPPL) */
					  ((#{dprtCd} = 'DSC'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411|MDP_412|MDP_413|MDP_414|MDP_415|MDP_416') = 'Y') or   /*  DSC                */
					   (#{dprtCd} = 'DF'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411') = 'Y') or        /*  DSC                */
					   (#{dprtCd} = 'DG'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_412|MDP_415') = 'Y') or       /*  DSC                */
					   (#{dprtCd} = 'DH'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_413') = 'Y') or       /*  DSC                */
					   (#{dprtCd} = 'DI'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_414') = 'Y') or       /*  DSC                */
					   (#{dprtCd} = 'DK'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_416') = 'Y') or        /*  DSC                */
					   (#{dprtCd} = '01H'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419') = 'Y') or        /*  투석실(혈액)       */
					   (#{dprtCd} = '022'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_436') = 'Y') or        /*  투석실(복막)       */
					   (#{dprtCd} = 'ETC'
							and  (a.OROC_DPRT_CD = #{dprtCd1} or a.FRNS_DPRT_CD = #{dprtCd1})                        ) or        /*  기타장소(ORDACPPL) */
					   (#{dprtCd} = 'OP'
							and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_AN')) or /* 마취통증의학과 */
					   (#{dprtCd} = 'OP3'
							and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_OPRM')) or /* 수술실 */
					   (#{dprtCd} = 'OP2'
							and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_PACU')) or /* 회복실 */
					   (#{dprtCd} = 'OP4'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_422') = 'Y') or        /*  PMC-DSC통증관리실  */
					   (#{dprtCd} = 'OP5'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_443') = 'Y') or        /*  마취실(COR)        */
					   (#{dprtCd} = 'OP6'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_439') = 'Y') or        /*  수술실(COR)        */
					   (#{dprtCd} = 'OP7'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_437') = 'Y') or        /*  회복실(COR)        */
					   (#{dprtCd} = 'OP8'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_446') = 'Y') or        /* 기관지내시경실     */
					   (#{dprtCd} = 'BR'
							and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD, 'Z') =  'BR')) or   /*  영상의학과 */
					   (#{dprtCd} = 'WARD2'
							and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y' ))                      /*  병동-분만  */
					 )
			order
			   by  e.PTRM_NO
				,  e.SCKB_NO
				,  a.PTNO
				,  a.ORDR_YMD
				,  a.ORDR_SNO
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseGnrlDrugRtrnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="arvlDprtCd" column="ARVL_DPRT_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="afiAdmnVlmStr" column="AFI_ADMN_VLM_STR"/>
		<result property="icunCd1" column="ICUN_CD_1"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="afiRtrnCqyStr" column="AFI_RTRN_CQY_STR"/>
		<result property="afiRtrnCqyStr1" column="AFI_RTRN_CQY_STR_1"/>
		<result property="rtrnYn" column="RTRN_YN"/>
		<result property="refnYn" column="REFN_YN"/>
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
		<result property="orfrCd" column="ORFR_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="afiPcknUnadQtyStr" column="AFI_PCKN_UNAD_QTY_STR"/>
		<result property="afiAdmnVlmStr1" column="AFI_ADMN_VLM_STR_1"/>
		<result property="afiDdcnStr" column="AFI_DDCN_STR"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="rtrnRqprId" column="RTRN_RQPR_ID"/>
		<result property="afiRtrnRqprNm" column="AFI_RTRN_RQPR_NM"/>
		<result property="drugOrdrPrssCd" column="DRUG_ORDR_PRSS_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="mdprCd1" column="MDPR_CD_1"/>
		<result property="afiAdmnVlmStr2" column="AFI_ADMN_VLM_STR_2"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="rtrnDvsnCd" column="RTRN_DVSN_CD"/>
		<result property="afiRtrnCqyStr2" column="AFI_RTRN_CQY_STR_2"/>
		<result property="cockYn" column="COCK_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="frnsCtrlDvsnCd" column="FRNS_CTRL_DVSN_CD"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="carePrinDt" column="CARE_PRIN_DT"/>
		<result property="userNm" column="USER_NM"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseGnrlDrugRtrnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseGnrlDrugRtrnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseGnrlDrugRtrnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseGnrlDrugRtrnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseGnrlDrugRtrnInqr  mnd_jdgrtnt_l02$S01_약반납내역 조회 처방일자기준DAM */
				   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss') as RTRN_RQST_DT                      /*  반납요청자일시       */
				,  to_char(a.ORDR_YMD, 'yyyymmdd') as ORDR_YMD                          /*  처방일자             */
				,  f.OPRM_CD as OPRM_CD                           /*  수술실코드 */
				,  e.ARVL_DPRT_CD as ARVL_DPRT_CD                      /*  병동                 */
				,  e.PTNO as PTNO                              /*  환자번호             */
				,  ( select  PTNT_NM from  APPTPTNTT where  PTNO = e.PTNO ) as PTNT_NM                             /*  환자번호             */
				,  e.MDPR_CD as MDPR_CD                           /*  약품코드             */
				,  c.ORDR_NM as ORDR_NM                           /*  처방명               */
				,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)) as AFI_ADMN_VLM_STR              /*  투여량(함량단위)     */
				,  decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCUN_CD, a.ICUN_CD) as ICUN_CD_1                                          /*  단위(함량단위)       */
				,  a.DC_DVSN_CD as DC_DVSN_CD                        /*  D/C여부              */
				,  e.DRUG_RTRE_CD as DRUG_RTRE_CD                      /*  반납사유             */
				,  decode(e.DSCH_ATMT_RTRN_YN, 'Y'
											 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
												   from CCCMCDDMT A, CCCMCDDLT B
												   where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													 and A.COMN_GRP_CD  = 'SD068'
													 and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													 and B.LNGG_CD(+)   = nvl('', '*'))||'(퇴)'
											, ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
												   from CCCMCDDMT A, CCCMCDDLT B
												   where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													 and A.COMN_GRP_CD  = 'SD068'
													 and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													 and B.LNGG_CD(+)   = nvl('', '*'))) as CD_NM     /*  반납사유(퇴원자동반납여부) */
				,  to_char(e.MDPR_RTRN_NTM) as AFI_RTRN_NTM_STR                  /*  반납횟수             */
				,  to_char(e.RTRN_RQST_CQY) as AFI_RTRN_CQY_STR                  /*  반납요청수량         */
				,  to_char(e.PTAD_RTRN_QTY) as AFI_RTRN_CQY_STR_1                 /*  원무반납량         */
				,  e.RTRN_YN as RTRN_YN                           /*  반납확인여부         */
				,  decode(e.REFN_YN, 'N', '', e.REFN_YN) as REFN_YN                           /*  환불여부             */
				,  to_char(a.NTM) as AFI_NTM_STR                       /*  횟수                 */
				,  a.ORFR_CD as ORFR_CD                           /*  처방형태             */
				,  to_char(a.MDTN_NO) as AFI_MDTN_NO_STR                   /*  투약번호             */
				,  to_char(a.ORDR_SNO) as AFI_ORDR_SNO_STR                  /*  처방순번             */
				,  a.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD                 /*  선택단위구분         */
				,  to_char(a.PCKN_UNAD_QTY) as AFI_PCKN_UNAD_QTY_STR             /*  투여량(포장단위)     */
				,  to_char(a.ICUN_ADMN_VLM) as AFI_ADMN_VLM_STR_1                 /*  투여량(함량단위)     */
				,  to_char(a.DDCN) as AFI_DDCN_STR                      /*  일수                 */
				,  a.DRAP_DVSN_CD as DRAP_DVSN_CD                      /*  약적용구분(SD002)      */
				,  c.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD                  /*  총량계산코드         */
				,  a.ODKI_CD as ODKI_CD
				,  e.RTRN_RQPR_ID as RTRN_RQPR_ID
				, ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
				,  a.DRUG_ORDR_PRSS_CD as DRUG_ORDR_PRSS_CD
				,  e.PTRM_NO as PTRM_NO
				,  e.SCKB_NO as SCKB_NO
				,  a.WARD_CD as WARD_CD
				,  a.PCUN_CD as PCUN_CD                           /*  포장단위코드           */
				,  c.MDPR_CLSF_CD as MDPR_CLSF_CD                      /*  약품분류코드 (SD001)  */
				,  d.MDPR_CD as MDPR_CD_1
				,  to_char((decode(a.SLCT_UNIT_DVSN_CD, '2'
													  , decode(sign(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)
																	   - decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, c.PCUN_INLS_QTY))
																   , 1, ceil(e.PTAD_RTRN_QTY)
																	  , trunc(e.PTAD_RTRN_QTY))
													  , trunc(e.PTAD_RTRN_QTY)
								   )
							)
						   ) as AFI_ADMN_VLM_STR_2
				,  e.PTDV_CD as PTDV_CD
				,  e.RTRN_DVSN_CD as RTRN_DVSN_CD                    /*  반납구분코드 (SD051)(N:간호입력 P:약국입력) */
				,  e.RTRN_CNFR_CQY as AFI_RTRN_CQY_STR_2               /*  반납(확인)수량     */
				,  d.COCK_YN as COCK_YN
				,  nvl(c.STST_DVSN_CD, '*') as STST_DVSN_CD                    /*  통계구분(약품코드:SD008) */
				,  a.OROC_DPRT_CD as OROC_DPRT_CD
				,  a.FRNS_CTRL_DVSN_CD as FRNS_CTRL_DVSN_CD               /*  **. 불출제어 플래그(SD800) - B1:모호한, B2:명확한 */
				,  c.CLNC_EXAM_DRUG_YN as CLNC_EXAM_DRUG_YN
				,  e.MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD                 /*  투약번호구분코드(BDGORDTYP)   */
				,  e.MDTN_LCDV_CD as MDTN_LCDV_CD                    /*  투약위치구분코드(DGLOCATFG)   */
				, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = e.ARVL_DPRT_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD
				, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.WARD_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD_1
				, to_char(e.CARE_PRIN_DT, 'yyyymmddhh24miss') as CARE_PRIN_DT
				, (select x.USER_NM
					 from ccuseramt x
					where x.lgin_id = e.CARE_PNPR_ID
					  and rownum = 1) as USER_NM
			    , e.MDTN_NO as MDTN_NO
			    , e.ORDR_SNO as ORDR_SNO
			 from
				   SDJREQADT d              /*  부서약품청구보조관리(부서별 청구가능 약품별 수량을 미리 정해둔 엔터티) */
				,  MDORDRCMT c              /*  처방코드기본 */
				,  MDMEDORDT a              /*  약처방 */
				,  SDJDGRTNT e              /*  처방성약품반납관리 */
				,  MDOPSCHET f  /*  수술스케줄 */
			where
				   e.PTNO                      = a.PTNO                                                  /*  환자번호             */
			  and  e.ORDR_YMD                  = a.ORDR_YMD                                              /*  처방일자             */
			  and  e.ORDR_SNO                  = a.ORDR_SNO                                              /*  처방순번             */
			  and  e.MDTN_LCDV_CD              = a.MDTN_LCDV_CD                                          /*  투약위치             */
			  and  nvl(e.ARVL_DPRT_CD, 'ZZ')   = nvl(#{wardCd}, nvl(e.ARVL_DPRT_CD, 'ZZ'))                /*  발생처(도착지-약국)  */
			  and  a.ORDR_YMD  between to_date(#{inqrStrtYmd}, 'yyyymmdd')                             /*  처방일자기준       */
								   and to_date(#{inqrFnshYmd}, 'yyyymmdd')
			  and  (( nvl(#{dprtCd1}, '-') = 'h' )
				   or
					(( nvl(#{dprtCd1}, '-') <> 'h' )
					and  a.FRST_RGST_DT    >=  to_date(#{inqrStrtYmd} || nvl(#{inqrStrtDt}, '00') || '0000', 'yyyymmddhh24miss')
					and  a.FRST_RGST_DT    <   to_date(#{inqrStrtYmd} || nvl(#{inqrFnshDt}, '23') || '5959', 'yyyymmddhh24miss')
					)
				   )
			  and  e.PTNO                      = nvl(#{ptno}, e.PTNO)
			  and  e.MDPR_CD                   = c.ORDR_CD                                               /*  처방코드             */
			  and  nvl(e.TEAM_CD, 'Z')         = decode(#{teamCd}, '*', nvl(e.TEAM_CD, 'Z'), #{teamCd})
			  and  e.ARVL_DPRT_CD              = d.DPRT_CD(+)
			  and  e.MDPR_CD                   = d.MDPR_CD(+)
			  and  nvl(e.STDL_DETL_DVSN_CD, 'Z')   <> 'T'                                                      /*  입출고상세구분코드 (SD010) TPN 반납약 제외  */
			  and  ( a.MDPR_CLSF_CD  not in  ('2', '3')                                                    /*  향정, 마약 아니거나 */
								or  a.DRAP_DVSN_CD <> '2')                                                 /*  주사약 아니거나     */
			  and  e.DRUG_RTRE_CD <> '7'                                                                   /*  2009.06.02 미수령자동반납 제외 */
			  /* - */
			  and  f.OPRT_YMD  (+) = a.OPRT_YMD     /*  수술스케쥴 2008.06.13 추가 김명종 */
			  and  f.PTNO      (+) = a.PTNO         /*  수술스케쥴 2008.06.13 추가 김명종 */
			  and  f.OPRT_SNO  (+) = a.OPRT_SNO     /*  수술스케쥴 2008.06.13 추가 김명종 */
			  /* - */
			  and  (    (#{dprtCd} = 'OP4')   /*  DSC통증관리실 -- PMC */
					 or (#{dprtCd} = 'ETC')   /*  기타장소 */
					 or ((#{dprtCd} = 'DSC' or
						  #{dprtCd} = 'DF'  or    /*  DSC */
						  #{dprtCd} = 'DG'  or    /*  DSC */
						  #{dprtCd} = 'DH'  or    /*  DSC */
						  #{dprtCd} = 'DI'  or    /*  DSC */
						  #{dprtCd} = 'DK'  or    /*  DSC */
						  #{dprtCd} = 'Di'  or    /*  PTC */
						  #{dprtCd} = 'Dk'  or    /*  PTC */
						  #{dprtCd} = 'OP'  or    /*  MOR 회복실 */
						  #{dprtCd} = 'OP2' or    /*  MOR 마취준비실 - AN */
						  #{dprtCd} = 'OP3' or    /*  MOR 수술실 */
						  #{dprtCd} = 'OP5' or    /*  마취실(COR)   */
						  #{dprtCd} = 'OP6' or    /*  수술실(COR)   */
						  #{dprtCd} = 'OP7' or    /*  회복실(COR)   */
						  #{dprtCd} = 'OP8' or    /*  통증관리(COR) */
						  #{dprtCd} = '01H' or    /*  투석 */
						  #{dprtCd} = 'BR'  or    /*  영상의학과(본관) */
						  #{dprtCd} = 'WARD2')    /*  분만장 */
						)
				   )
				   and  ((#{dprtCd} = 'DSC'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411|MDP_412|MDP_413|MDP_414|MDP_415|MDP_416') = 'Y') or          /*  DSC */
						 (#{dprtCd} = 'DF'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411') = 'Y') or          /*  DSC */
						 (#{dprtCd} = 'DG'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_412|MDP_415') = 'Y') or          /*  DSC */
						 (#{dprtCd} = 'DH'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_413') = 'Y') or          /*  DSC */
						 (#{dprtCd} = 'DI'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_414') = 'Y') or          /*  DSC */
						 (#{dprtCd} = 'DK'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_416') = 'Y') or          /*  DSC */
						 (#{dprtCd} = 'Di'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_434') = 'Y') or       /*  PTC-마취준비실       */
						 (#{dprtCd} = 'Dk'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_435') = 'Y') or       /*  PTC-회복실           */
						 (#{dprtCd} = '01H'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419|MDP_436') = 'Y') or          /*  투석실 */
						 (#{dprtCd} = 'ETC'
								 and  a.OROC_DPRT_CD = #{dprtCd1}                        ) or          /*  기타장소(ORDACPPL) */
						 (#{dprtCd} = 'OP'
								and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_AN')) or /* 마취통증의학과 */
						 (#{dprtCd} = 'OP3'
								and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_OPRM')) or /* 수술실 */
						 (#{dprtCd} = 'OP2'
								and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_PACU')) or /* 회복실 */
						 (#{dprtCd} = 'OP4'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_422') = 'Y') or          /*  PMC-DSC통증관리실  */
						 (#{dprtCd} = 'OP5'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_443') = 'Y') or          /*  마취실(COR)    */
						 (#{dprtCd} = 'OP6'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_439') = 'Y') or          /*  수술실(COR)    */
						 (#{dprtCd} = 'OP7'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_437') = 'Y') or          /*  회복실(COR)    */
						 (#{dprtCd} = 'OP8'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_438') = 'Y') or          /*  통증관리(COR)  */
						 (#{dprtCd} = 'WARD'
								 and  a.WARD_CD   = #{wardCd}
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'W') = 'Y') or        /*  병동-병동 */
						 (#{dprtCd} = 'BR'
								 and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD
												   ,  'Z'
									   ) =  'BR')) or          /*  영상의학과 */
						 (#{dprtCd} = 'WARD2'
								 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y')             /*  병동-분만 */
						)
			order
			   by  e.PTRM_NO
				,  e.SCKB_NO
				,  a.PTNO
				,  a.ORDR_YMD
				,  a.ORDR_SNO
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseNrdrRtrnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="arvlDprtCd" column="ARVL_DPRT_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="afiAdmnVlmStr" column="AFI_ADMN_VLM_STR"/>
		<result property="icunCd1" column="ICUN_CD_1"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="afiRtrnCqyStr" column="AFI_RTRN_CQY_STR"/>
		<result property="afiRtrnCqyStr1" column="AFI_RTRN_CQY_STR_1"/>
		<result property="rtrnYn" column="RTRN_YN"/>
		<result property="refnYn" column="REFN_YN"/>
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
		<result property="orfrCd" column="ORFR_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="afiPcknUnadQtyStr" column="AFI_PCKN_UNAD_QTY_STR"/>
		<result property="afiAdmnVlmStr1" column="AFI_ADMN_VLM_STR_1"/>
		<result property="afiDdcnStr" column="AFI_DDCN_STR"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="rtrnRqprId" column="RTRN_RQPR_ID"/>
		<result property="afiRtrnRqprNm" column="AFI_RTRN_RQPR_NM"/>
		<result property="drugOrdrPrssCd" column="DRUG_ORDR_PRSS_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="mdprCd1" column="MDPR_CD_1"/>
		<result property="afiAdmnVlmStr2" column="AFI_ADMN_VLM_STR_2"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="rtrnDvsnCd" column="RTRN_DVSN_CD"/>
		<result property="afiRtrnCqyStr2" column="AFI_RTRN_CQY_STR_2"/>
		<result property="cockYn" column="COCK_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="frnsCtrlDvsnCd" column="FRNS_CTRL_DVSN_CD"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="afiRtrnCqyStr3" column="AFI_RTRN_CQY_STR_3"/>
		<result property="afiRtrnCqyStr4" column="AFI_RTRN_CQY_STR_4"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="afiPcunInlsQtyStr" column="AFI_PCUN_INLS_QTY_STR"/>
		<result property="afiPrinNtmStr" column="AFI_PRIN_NTM_STR"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="rtrnExreCtn" column="RTRN_EXRE_CTN"/>
		<result property="afiTotlQtyStr" column="AFI_TOTL_QTY_STR"/>
		<result property="afiTotlQtyStr1" column="AFI_TOTL_QTY_STR_1"/>
		<result property="afiExreRtrnQtyStr" column="AFI_EXRE_RTRN_QTY_STR"/>
		<result property="afiNrdrPrtxPrinNtmStr" column="AFI_NRDR_PRTX_PRIN_NTM_STR"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiTotlQtyStr2" column="AFI_TOTL_QTY_STR_2"/>
		<result property="afiTotlQtyStr3" column="AFI_TOTL_QTY_STR_3"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="carePrinDt" column="CARE_PRIN_DT"/>
		<result property="userNm" column="USER_NM"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="userNm2" column="USER_NM_2"/>
		<result property="rtrnCnfrDt" column="RTRN_CNFR_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseNrdrRtrnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseNrdrRtrnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseNrdrRtrnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseNrdrRtrnInqr-result" useCache="true" flushCache="false">
			<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseNrdrRtrnInqr  mnd_jdgrtnt_l03$S01_약반납내역 조회 반납일자기준DAM */
					   ZZ.RTRN_RQST_DT as RTRN_RQST_DT                                                    /*  반납요청일시                */
					,  ZZ.ORDR_YMD as ORDR_YMD                                                        /*  처방일자                    */
					,  ZZ.ARVL_DPRT_CD as ARVL_DPRT_CD                                                    /*  도착부서코드                */
					,  ZZ.PTNO as PTNO                                                            /*  환자번호                    */
					,  ZZ.PTNT_NM as PTNT_NM                                                         /*  환자명                      */
					,  ZZ.MDPR_CD as MDPR_CD                                                         /*  약품코드                    */
					,  ZZ.ORDR_NM as ORDR_NM                                                         /*  처방명                      */
					,  ZZ.AFI_ADMN_VLM_STR as AFI_ADMN_VLM_STR                                                /*  AFI투여용량스트링           */
					,  ZZ.ICUN_CD1 as ICUN_CD_1                                                        /*  함량단위코드1             */
					,  ZZ.DC_DVSN_CD as DC_DVSN_CD                                                      /*  DC구분코드                  */
					,  ZZ.DRUG_RTRE_CD as DRUG_RTRE_CD                                                    /*  약반납사유코드              */
					,  ZZ.CD_NM as CD_NM                                                           /*  코드명                      */
					,  ZZ.AFI_RTRN_NTM_STR as AFI_RTRN_NTM_STR                                                /*  AFI반납횟수스트링           */
					,  ZZ.AFI_RTRN_CQY_STR as AFI_RTRN_CQY_STR                                                /*  AFI반납수량스트링           */
					,  ZZ.AFI_RTRN_CQY_STR1 as AFI_RTRN_CQY_STR_1                                               /*  AFI반납수량스트링1        */
					,  ZZ.RTRN_YN as RTRN_YN                                                         /*  반납여부                    */
					,  ZZ.REFN_YN as REFN_YN                                                         /*  환불여부                    */
					,  ZZ.AFI_NTM_STR as AFI_NTM_STR                                                     /*  AFI횟수스트링               */
					,  ZZ.ORFR_CD as ORFR_CD                                                         /*  처방형태코드                */
					,  ZZ.AFI_MDTN_NO_STR as AFI_MDTN_NO_STR                                                 /*  AFI투약번호스트링           */
					,  ZZ.AFI_ORDR_SNO_STR as AFI_ORDR_SNO_STR                                                /*  AFI처방일련번호스트링       */
					,  ZZ.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD                                               /*  선택단위구분코드            */
					,  ZZ.AFI_PCKN_UNAD_QTY_STR as AFI_PCKN_UNAD_QTY_STR                                           /*  AFI포장단위투여량스트링     */
					,  ZZ.AFI_ADMN_VLM_STR1 as AFI_ADMN_VLM_STR_1                                               /*  AFI투여용량스트링1        */
					,  ZZ.AFI_DDCN_STR as AFI_DDCN_STR                                                    /*  AFI일수스트링               */
					,  ZZ.DRAP_DVSN_CD as DRAP_DVSN_CD                                                    /*  약적용구분코드              */
					,  ZZ.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD                                                /*  총량계산코드                */
					,  ZZ.ODKI_CD as ODKI_CD                                                         /*  처방종류코드                */
					,  ZZ.RTRN_RQPR_ID as RTRN_RQPR_ID                                                    /*  반납요청자ID              */
					,  ZZ.AFI_RTRN_RQPR_NM as AFI_RTRN_RQPR_NM                                                /*  AFI반납요청자명             */
					,  ZZ.DRUG_ORDR_PRSS_CD as DRUG_ORDR_PRSS_CD                                               /*  약처방진행상태코드          */
					,  ZZ.PTRM_NO as PTRM_NO                                                         /*  병실번호                    */
					,  ZZ.SCKB_NO as SCKB_NO                                                         /*  병상번호                    */
					,  ZZ.WARD_CD as WARD_CD                                                         /*  병동코드                    */
					,  ZZ.PCUN_CD as PCUN_CD                                                         /*  포장단위코드                */
					,  ZZ.MDPR_CLSF_CD as MDPR_CLSF_CD                                                    /*  약품분류코드                */
					,  ZZ.MDPR_CD1 as MDPR_CD_1                                                        /*  약품코드1                */
					,  ZZ.AFI_ADMN_VLM_STR2 as AFI_ADMN_VLM_STR_2                                               /*  AFI투여용량스트링2        */
					,  ZZ.PTDV_CD as PTDV_CD                                                         /*  환자구분코드                */
					,  ZZ.RTRN_DVSN_CD as RTRN_DVSN_CD                                                    /*  반납구분코드                */
					,  ZZ.AFI_RTRN_CQY_STR2 as AFI_RTRN_CQY_STR_2                                               /*  AFI반납수량스트링2        */
					,  ZZ.COCK_YN as COCK_YN                                                         /*  COCK여부                   */
					,  ZZ.STST_DVSN_CD as STST_DVSN_CD                                                    /*  통계구분코드                */
					,  ZZ.OROC_DPRT_CD as OROC_DPRT_CD                                                         /*  처방발생원코드              */
					,  ZZ.FRNS_CTRL_DVSN_CD as FRNS_CTRL_DVSN_CD                                               /*  불출제어구분코드            */
					,  ZZ.CLNC_EXAM_DRUG_YN as CLNC_EXAM_DRUG_YN                                               /*  임상시험약여부              */
					,  ZZ.MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD                                                 /*  투약번호구분코드            */
					,  ZZ.MDTN_LCDV_CD as MDTN_LCDV_CD                                                    /*  투약위치구분코드            */
					,  ZZ.AFI_RTRN_CQY_STR3 as AFI_RTRN_CQY_STR_3                                               /*  AFI반납수량스트링3        */
					,  ZZ.AFI_RTRN_CQY_STR4 as AFI_RTRN_CQY_STR_4                                               /*  AFI반납수량스트링4        */
					,  ZZ.ICUN_CD as ICUN_CD                                                         /*  함량단위코드                */
					,  ZZ.AFI_PCUN_INLS_QTY_STR as AFI_PCUN_INLS_QTY_STR                                           /*  AFI포장단위포함량스트링     */
					,  ZZ.AFI_PRIN_NTM_STR as AFI_PRIN_NTM_STR                                                /*  AFI출력횟수스트링           */
					,  ZZ.LAST_UPDT_DT as LAST_UPDT_DT                                                    /*  최종수정일시                */
					,  ZZ.RTRN_EXRE_CTN as RTRN_EXRE_CTN                                                   /*  반납예외사유내용            */
					,  ZZ.AFI_TOTL_QTY_STR as AFI_TOTL_QTY_STR                                                /*  AFI총량스트링               */
					,  ZZ.AFI_TOTL_QTY_STR1 as AFI_TOTL_QTY_STR_1                                               /*  AFI총량스트링1            */
					,  ZZ.AFI_EXRE_RTRN_QTY_STR as AFI_EXRE_RTRN_QTY_STR                                           /*  AFI예외사유반납량스트링     */
					,  ZZ.AFI_NRDR_PRTX_PRIN_NTM_STR as AFI_NRDR_PRTX_PRIN_NTM_STR                                      /*  AFI마약처방전출력횟수스트링 */
					,  ZZ.OPRM_CD as OPRM_CD                                                         /*  수술실코드                  */
					,  ZZ.AFI_TOTL_QTY_STR2 as AFI_TOTL_QTY_STR_2                                               /*  AFI총량스트링2            */
					,  ZZ.AFI_TOTL_QTY_STR3 as AFI_TOTL_QTY_STR_3                                               /*  AFI총량스트링3            */
					,  ZZ.ABRV_DPRT_CD as ABRV_DPRT_CD                                                    /*  약어부서코드                */
					,  ZZ.ABRV_DPRT_CD1 as ABRV_DPRT_CD_1                                                   /*  약어부서코드1             */
					,  ZZ.CARE_PRIN_DT as CARE_PRIN_DT
					,  ZZ.USER_NM as USER_NM
					,  ZZ.MDTN_NO as MDTN_NO
					,  ZZ.ORDR_SNO as ORDR_SNO
					,  ZZ.USER_NM_2 as USER_NM_2
					,  ZZ.RTRN_CNFR_DT as RTRN_CNFR_DT
				 from
					   (
					   select
							   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss')                             as RTRN_RQST_DT                    /*  반납요청자일시       */
							,  to_char(a.ORDR_YMD, 'yyyymmdd')                                         as ORDR_YMD                        /*  처방일자             */
							,  e.ARVL_DPRT_CD                                                          as ARVL_DPRT_CD                    /*  병동                 */
							,  e.PTNO                                                                  as PTNO                            /*  환자번호             */
							,  ( select  PTNT_NM from  APPTPTNTT where  PTNO = e.PTNO )         as PTNT_NM                         /*  환자번호             */
							,  e.MDPR_CD                                                               as MDPR_CD                         /*  약품코드             */
							,  c.ORDR_NM                                                               as ORDR_NM                         /*  처방명               */
							,  case when a.SLCT_UNIT_DVSN_CD = '1' and a.PCKN_UNAD_QTY < 1 then '0'||a.PCKN_UNAD_QTY
										 when a.SLCT_UNIT_DVSN_CD = '1' and a.PCKN_UNAD_QTY >= 1 then to_char(a.PCKN_UNAD_QTY)
										 when a.SLCT_UNIT_DVSN_CD = '2' and a.ICUN_ADMN_VLM < 1 then '0'||a.ICUN_ADMN_VLM
										 when a.SLCT_UNIT_DVSN_CD = '2' and a.ICUN_ADMN_VLM >= 1 then to_char(a.ICUN_ADMN_VLM)
							   end                                                                     as AFI_ADMN_VLM_STR            /*  투여량(함량단위)     */
							,  decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCUN_CD, a.ICUN_CD)  as ICUN_CD1                                        /*  단위(함량단위)       */
							,  a.DC_DVSN_CD                                                            as DC_DVSN_CD                      /*  D/C여부              */
							,  e.DRUG_RTRE_CD                                                          as DRUG_RTRE_CD                    /*  반납사유             */
							 ,  decode(e.DSCH_ATMT_RTRN_YN, 'Y'
														  , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
																from CCCMCDDMT A, CCCMCDDLT B
																where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
																  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
																  and A.COMN_GRP_CD  = 'SD068'
																  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
																  and B.LNGG_CD(+)   = nvl('', '*'))||'(퇴)'
														 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
																from CCCMCDDMT A, CCCMCDDLT B
																where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
																  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
																  and A.COMN_GRP_CD  = 'SD068'
																  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
																  and B.LNGG_CD(+)   = nvl('', '*')))  as CD_NM     /*  반납사유(퇴원자동반납여부) */
							,  to_char(e.MDPR_RTRN_NTM)                                                as AFI_RTRN_NTM_STR                /*  반납횟수             */
							,  to_char(e.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR                /*  반납요청수량         */
							,  to_char(e.PTAD_RTRN_QTY)                                                as AFI_RTRN_CQY_STR1               /*  원무반납량         */
							,  e.RTRN_YN                                                               as RTRN_YN                         /*  반납확인여부         */
							,  decode(e.REFN_YN, 'N', '', e.REFN_YN)                                   as REFN_YN                         /*  환불여부             */
							,  to_char(a.NTM)                                                          as AFI_NTM_STR                     /*  횟수                 */
							,  a.ORFR_CD                                                               as ORFR_CD                         /*  처방형태             */
							,  to_char(a.MDTN_NO)                                                      as AFI_MDTN_NO_STR                 /*  투약번호             */
							,  to_char(a.ORDR_SNO)                                                     as AFI_ORDR_SNO_STR                /*  처방순번             */
							,  a.SLCT_UNIT_DVSN_CD                                                     as SLCT_UNIT_DVSN_CD               /*  선택단위구분         */
							,  to_char(a.PCKN_UNAD_QTY)                                                as AFI_PCKN_UNAD_QTY_STR           /*  투여량(포장단위)     */
							,  to_char(a.ICUN_ADMN_VLM)                                                as AFI_ADMN_VLM_STR1               /*  투여량(함량단위)     */
							,  to_char(a.DDCN)                                                         as AFI_DDCN_STR                    /*  일수                 */
							,  a.DRAP_DVSN_CD                                                          as DRAP_DVSN_CD                    /*  약적용구분(SD002)      */
							,  c.TOTL_QTY_CLCL_CD                                                      as TOTL_QTY_CLCL_CD                /*  총량계산코드         */
							,  a.ODKI_CD                                                               as ODKI_CD
							,  e.RTRN_RQPR_ID                                                          as RTRN_RQPR_ID
							, ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
							,  a.DRUG_ORDR_PRSS_CD                                                     as DRUG_ORDR_PRSS_CD
							,  e.PTRM_NO                                                               as PTRM_NO
							,  e.SCKB_NO                                                               as SCKB_NO
							,  a.WARD_CD                                                               as WARD_CD
							,  a.PCUN_CD                                                               as PCUN_CD                         /*  포장단위코드           */
							,  c.MDPR_CLSF_CD                                                          as MDPR_CLSF_CD                    /*  약품분류코드 (SD001)  */
							,  d.MDPR_CD                                                               as MDPR_CD1
							,  to_char((decode(a.SLCT_UNIT_DVSN_CD, '2'
														  , decode(sign(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)
																			   - decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, c.PCUN_INLS_QTY))
																			   , 1, ceil(e.PTAD_RTRN_QTY)
																				  , trunc(e.PTAD_RTRN_QTY))
																  , trunc(e.PTAD_RTRN_QTY)
											   )
										)
									   )                                                               as AFI_ADMN_VLM_STR2
							,  e.PTDV_CD                                                               as PTDV_CD
							,  e.RTRN_DVSN_CD                                                          as RTRN_DVSN_CD                    /*  반납구분코드 (SD051)(N:간호입력 P:약국입력) */
							,  e.RTRN_CNFR_CQY                                                         as AFI_RTRN_CQY_STR2               /*  반납(확인)수량     */
							,  d.COCK_YN                                                               as COCK_YN
							,  nvl(c.STST_DVSN_CD, '*')                                                as STST_DVSN_CD                    /*  통계구분(약품코드:SD008) */
							,  a.OROC_DPRT_CD                                                               as OROC_DPRT_CD
							,  a.FRNS_CTRL_DVSN_CD                                                     as FRNS_CTRL_DVSN_CD               /*  **. 불출제어 플래그(SD800) - B1:모호한, B2:명확한 */
							,  c.CLNC_EXAM_DRUG_YN                                                     as CLNC_EXAM_DRUG_YN
							,  e.MDTN_NO_DVSN_CD                                                       as MDTN_NO_DVSN_CD                 /*  투약번호구분코드(BDGORDTYP)   */
							,  e.MDTN_LCDV_CD                                                          as MDTN_LCDV_CD                    /*  투약위치구분코드(DGLOCATFG)   */
							,  to_char(f.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR3
							,  case when a.DRAP_DVSN_CD = '2' and (a.MDPR_CLSF_CD in ('2', '3')) then
										to_char(e.RTRN_RQST_CQY * c.PCUN_INLS_QTY )
									else
									  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', e.MDPR_RTRN_NTM*c.PCUN_INLS_QTY*a.PCKN_UNAD_QTY,
																		   '2', e.MDPR_RTRN_NTM*a.ICUN_ADMN_VLM) )
								end	  																	as AFI_RTRN_CQY_STR4
							,  c.ICUN_CD                                                               as ICUN_CD
							,  to_char(c.PCUN_INLS_QTY)                                                as AFI_PCUN_INLS_QTY_STR
							,  to_char(a.NRDR_RTRN_PRTX_PRIN_NTM)                                      as AFI_PRIN_NTM_STR
							,  decode(e.RTRN_YN, 'Y', to_char(e.LAST_UPDT_DT, 'yyyymmddhh24mi'), '')   as LAST_UPDT_DT
							,  a.RTRN_EXRE_CTN                                                         as RTRN_EXRE_CTN
							,  to_char(g.INVN_TOTL_QTY*c.PCUN_INLS_QTY)                                as AFI_TOTL_QTY_STR
							,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '2', g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
																	  , g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.PCKN_UNAD_QTY*a.NTM*c.PCUN_INLS_QTY)) as AFI_TOTL_QTY_STR1
							,  a.EXRE_RTRN_QTY                                                         as AFI_EXRE_RTRN_QTY_STR
							,  to_char(decode(a.MDPR_CLSF_CD, '2', a.NRDR_PRTX_PRIN_NTM
															, '3', a.NRDR_RTRN_PRTX_PRIN_NTM))         as AFI_NRDR_PRTX_PRIN_NTM_STR                  /* (약) 마약처방전출력횟수 */
							,  ''  as OPRM_CD
							,  ''  as AFI_TOTL_QTY_STR2
							,  ''  as AFI_TOTL_QTY_STR3
							, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = e.ARVL_DPRT_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD
							, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.WARD_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD1
							, to_char(e.CARE_PRIN_DT, 'yyyymmddhh24miss') as CARE_PRIN_DT
							, (select x.USER_NM
								 from ccuseramt x
								where x.lgin_id = e.CARE_PNPR_ID
								  and rownum = 1) as USER_NM
						    , e.MDTN_NO as MDTN_NO
						    , e.ORDR_SNO as ORDR_SNO
						    , ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_CNFM_ID ) as USER_NM_2
						    , to_char(e.RTRN_CNFR_DT, 'yyyymmddhh24miss') as RTRN_CNFR_DT
						 from
							   SDJREQADT d              /*  부서약품청구보조관리(부서별 청구가능 약품별 수량을 미리 정해둔 엔터티) */
							,  MDORDRCMT c              /*  처방코드기본 */
							,  MDMEDORDT a              /*  약처방 */
							,  SDJDGRTNT e              /*  처방성약품반납관리 */
							,  SDJDGRTNT f
							,  SDPORDDET g              /*  처방조제상세 */
						where
							   e.PTNO                      = a.PTNO                                                  /*  환자번호             */
						  and  e.ORDR_YMD                  = a.ORDR_YMD                                              /*  처방일자             */
						  and  e.ORDR_SNO                  = a.ORDR_SNO                                              /*  처방순번             */
						  and  e.MDTN_LCDV_CD              = a.MDTN_LCDV_CD                                          /*  투약위치             */
						  /* - */
						  and  nvl(e.ARVL_DPRT_CD, 'ZZ')   = nvl(#{wardCd}, nvl(e.ARVL_DPRT_CD, 'ZZ'))                /*  발생처(도착지-약국)  */
						  /* - */
						  and  e.RTRN_RQST_DT             between to_date(#{inqrStrtYmd} || nvl(#{inqrStrtDt}, '00') || '0000', 'yyyymmddhh24miss')
						  									   and to_date(#{inqrStrtYmd} || nvl(#{inqrFnshDt}, '23') || '5959', 'yyyymmddhh24miss')                             /*  반납요청자일시       */
						  and  e.PTNO                      = nvl(#{ptno}, e.PTNO)
						  and  e.DRUG_RTRE_CD              not in ('6','7')                                         /*  2009.06.02 미수령자동반납 제외 */
						  and  e.MDPR_CD                   = c.ORDR_CD                                               /*  처방코드             */
						  and  nvl(e.TEAM_CD, 'Z')         = decode(#{teamCd}, '*', nvl(e.TEAM_CD, 'Z'), #{teamCd})
						  and  e.ARVL_DPRT_CD              = d.DPRT_CD(+)
						  and  e.MDPR_CD                   = d.MDPR_CD(+)
						  and  nvl(e.STDL_DETL_DVSN_CD, 'Z')   <> 'T'                                                      /*  입출고상세구분코드 (SD010) TPN 반납약 제외  */
						  /* - */
						  and  f.PTNO                   (+)= a.PTNO                        /*  환자번호             */
						  and  f.ORDR_YMD               (+)= a.ORDR_YMD                   /*  처방일자             */
						  and  f.ORDR_SNO               (+)= a.ORDR_SNO                 /*  처방순번             */
						  and  f.MDTN_LCDV_CD           (+)= a.MDTN_LCDV_CD                /*  투약위치             */
						  and  f.DRUG_RTRE_CD           (+)= '6X' /* (SELECT X.MDCR_DTLS_CTRL_CD FROM MZCTRLMMT X WHERE MDCR_CTRL_CD = 'MNW917' AND ROWNUM = 1) */
						  and  (
								(
								  (#{dvsnVl1} = 'D')
								  and
								  (a.MDPR_CLSF_CD  in  ('2', '3'))
								 )
								 or
								 (
								  (#{dvsnVl1} != 'D')
								  and
								  (a.MDPR_CLSF_CD  = #{dvsnVl1})
								 )
							   )
						  and  a.DRAP_DVSN_CD             = '2'
						  /* - */
						  and  g.ORDR_YMD              (+)= a.ORDR_YMD                    /*  처방일자             */
						  and  g.MDTN_NO_DVSN_CD       (+)= a.MDTN_NO_DVSN_CD                  /*  투약번호구분         */
						  and  g.MDTN_NO               (+)= a.MDTN_NO                        /*  투약번호             */
						  and  g.ORDR_SNO              (+)= a.ORDR_SNO                  /*  처방순번             */
						  and  g.MDTN_LCDV_CD          (+)= a.MDTN_LCDV_CD                /*  투약위치             */
						  and  (
								(((#{dprtCd} = 'W') and ( #{wardCd} = fn_cc_get_dprt_cd('WARD_DLR') ) and fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'W|MDP_408|MDP_410') = 'Y') /* 분만장 */
								 or
								 ((#{dprtCd} = 'W') and ( #{wardCd} <> fn_cc_get_dprt_cd('WARD_DLR') ))   ) or
								(#{dprtCd} = 'O') or        /*  기타장소(ORDACPPL) */
							   ((#{dprtCd} = '01H' and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419|MDP_436') = 'Y') or        /*  투석실(혈액)       */
								(#{dprtCd} = 'ETC' and  (a.OROC_DPRT_CD = #{dprtCd1} or a.FRNS_DPRT_CD = #{dprtCd1})                        ) or        /*  기타장소(ORDACPPL) */
								(#{dprtCd} = 'OP' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_AN') ) or /* 마취통증의학과 */
								(#{dprtCd} = 'OP3' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_OPRM')) or /* 수술실 */
								(#{dprtCd} = 'OP2' and a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_PACU')) or /* 회복실 */
								(#{dprtCd} = 'BR' and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD, 'Z') =  'BR')) or   /*  영상의학과 */
								(#{dprtCd} = 'WARD2' and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y' ))                      /*  병동-분만  */
							  )
						union all
					   select
							   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss')                             as RTRN_RQST_DT                    /*  반납요청자일시       */
							,  to_char(a.ORDR_YMD, 'yyyymmdd')                                         as ORDR_YMD                        /*  처방일자             */
							,  e.ARVL_DPRT_CD                                                          as ARVL_DPRT_CD                    /*  병동                 */
							,  e.PTNO                                                                  as PTNO                            /*  환자번호             */
							,  ( select  PTNT_NM from  APPTPTNTT where  PTNO = e.PTNO )         as PTNT_NM                         /*  환자번호             */
							,  e.MDPR_CD                                                               as MDPR_CD                         /*  약품코드             */
							,  c.ORDR_NM                                                               as ORDR_NM                         /*  처방명               */
							,  case when a.SLCT_UNIT_DVSN_CD = '1' and a.PCKN_UNAD_QTY < 1 then '0'||a.PCKN_UNAD_QTY
									when a.SLCT_UNIT_DVSN_CD = '1' and a.PCKN_UNAD_QTY >= 1 then to_char(a.PCKN_UNAD_QTY)
									when a.SLCT_UNIT_DVSN_CD = '2' and a.ICUN_ADMN_VLM < 1 then '0'||a.ICUN_ADMN_VLM
									when a.SLCT_UNIT_DVSN_CD = '2' and a.ICUN_ADMN_VLM >= 1 then to_char(a.ICUN_ADMN_VLM)
									end                                                                as AFI_ADMN_VLM_STR                /*  투여량(함량단위)     */
							,  decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCUN_CD, a.ICUN_CD)  as UNIT_CD1                                        /*  단위(함량단위)       */
							,  a.DC_DVSN_CD                                                            as DC_DVSN_CD                      /*  D/C여부              */
							,  e.DRUG_RTRE_CD                                                          as DRUG_RTRE_CD                    /*  반납사유             */
							,  decode(e.DSCH_ATMT_RTRN_YN, 'Y'
														  , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
																from CCCMCDDMT A, CCCMCDDLT B
																where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
																  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
																  and A.COMN_GRP_CD  = 'SD068'
																  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
																  and B.LNGG_CD(+)   = nvl('', '*'))||'(퇴)'
														 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
																from CCCMCDDMT A, CCCMCDDLT B
																where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
																  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
																  and A.COMN_GRP_CD  = 'SD068'
																  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
																  and B.LNGG_CD(+)   = nvl('', '*')))  as CD_NM     /*  반납사유(퇴원자동반납여부) */
							,  to_char(e.MDPR_RTRN_NTM)                                                as AFI_RTRN_NTM_STR                /*  반납횟수             */
							,  to_char(e.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR                /*  반납요청수량         */
							,  to_char(e.PTAD_RTRN_QTY)                                                as AFI_RTRN_CQY_STR1               /*  원무반납량         */
							,  e.RTRN_YN                                                               as RTRN_YN                         /*  반납확인여부         */
							,  decode(e.REFN_YN, 'N', '', e.REFN_YN)                                   as REFN_YN                         /*  환불여부             */
							,  to_char(a.NTM)                                                          as AFI_NTM_STR                     /*  횟수                 */
							,  a.ORFR_CD                                                               as ORFR_CD                         /*  처방형태             */
							,  to_char(a.MDTN_NO)                                                      as AFI_MDTN_NO_STR                 /*  투약번호             */
							,  to_char(a.ORDR_SNO)                                                     as AFI_ORDR_SNO_STR                /*  처방순번             */
							,  a.SLCT_UNIT_DVSN_CD                                                     as SLCT_UNIT_DVSN_CD               /*  선택단위구분         */
							,  to_char(a.PCKN_UNAD_QTY)                                                as AFI_PCKN_UNAD_QTY_STR           /*  투여량(포장단위)     */
							,  to_char(a.ICUN_ADMN_VLM)                                                as AFI_ADMN_VLM_STR1               /*  투여량(함량단위)     */
							,  to_char(a.DDCN)                                                         as AFI_DDCN_STR                    /*  일수                 */
							,  a.DRAP_DVSN_CD                                                          as DRAP_DVSN_CD                    /*  약적용구분(SD002)      */
							,  c.TOTL_QTY_CLCL_CD                                                      as TOTL_QTY_CLCL_CD                /*  총량계산코드         */
							,  a.ODKI_CD                                                               as ODKI_CD
							,  e.RTRN_RQPR_ID                                                          as RTRN_RQPR_ID
							, ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
							,  a.DRUG_ORDR_PRSS_CD                                                     as DRUG_ORDR_PRSS_CD
							,  e.PTRM_NO                                                               as PTRM_NO
							,  e.SCKB_NO                                                               as SCKB_NO
							,  a.WARD_CD                                                               as WARD_CD
							,  a.PCUN_CD                                                               as PCUN_CD                         /*  포장단위코드           */
							,  c.MDPR_CLSF_CD                                                          as MDPR_CLSF_CD                    /*  약품분류코드 (SD001)  */
							,  d.MDPR_CD                                                               as MDPR_CD1
							,  to_char((decode(a.SLCT_UNIT_DVSN_CD, '2'
																  , decode(sign(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)
																		  - decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, c.PCUN_INLS_QTY))
																			   , 1, ceil(e.PTAD_RTRN_QTY)
																				  , trunc(e.PTAD_RTRN_QTY))
																  , trunc(e.PTAD_RTRN_QTY)
											   )
										)
									   )                                                               as AFI_ADMN_VLM_STR2
							,  e.PTDV_CD                                                               as PTDV_CD
							,  e.RTRN_DVSN_CD                                                          as RTRN_DVSN_CD               /*  반납구분코드 (SD051)(N:간호입력 P:약국입력) */
							,  e.RTRN_CNFR_CQY                                                         as AFI_RTRN_CQY_STR2          /*  반납(확인)수량     */
							,  d.COCK_YN                                                               as COCK_YN
							,  nvl(c.STST_DVSN_CD, '*')                                                as STST_DVSN_CD               /*  통계구분(약품코드:SD008) */
							,  a.OROC_DPRT_CD                                                               as OROC_DPRT_CD
							,  a.FRNS_CTRL_DVSN_CD                                                     as FRNS_CTRL_DVSN_CD          /*  **. 불출제어 플래그(SD800) - B1:모호한, B2:명확한 */
							,  c.CLNC_EXAM_DRUG_YN                                                     as CLNC_EXAM_DRUG_YN
							,  e.MDTN_NO_DVSN_CD                                                       as MDTN_NO_DVSN_CD            /*  투약번호구분코드(BDGORDTYP)   */
							,  e.MDTN_LCDV_CD                                                          as MDTN_LCDV_CD               /*  투약위치구분코드(DGLOCATFG)   */
							,  to_char(e.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR3
							,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', e.MDPR_RTRN_NTM*c.PCUN_INLS_QTY*a.PCKN_UNAD_QTY,
																   '2', e.MDPR_RTRN_NTM*a.ICUN_ADMN_VLM))  as AFI_RTRN_CQY_STR4
							,  c.ICUN_CD                                                               as ICUN_CD
							,  to_char(c.PCUN_INLS_QTY)                                                as AFI_PCUN_INLS_QTY_STR
							,  to_char(a.NRDR_RTRN_PRTX_PRIN_NTM)                                      as AFI_PRIN_NTM_STR
							,  decode(e.RTRN_YN, 'Y', to_char(e.LAST_UPDT_DT, 'yyyymmddhh24mi'), '')   as LAST_UPDT_DT
							,  a.RTRN_EXRE_CTN                                                         as RTRN_EXRE_CTN
							,  to_char(g.INVN_TOTL_QTY*c.PCUN_INLS_QTY)                                as AFI_TOTL_QTY_STR
							,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '2', g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
																	  , g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.PCKN_UNAD_QTY*a.NTM*c.PCUN_INLS_QTY)) as AFI_TOTL_QTY_STR1
							,  a.EXRE_RTRN_QTY                                                         as AFI_EXRE_RTRN_QTY_STR
							,  to_char(decode(a.MDPR_CLSF_CD, '2', a.NRDR_PRTX_PRIN_NTM
															, '3', a.NRDR_RTRN_PRTX_PRIN_NTM))         as AFI_NRDR_PRTX_PRIN_NTM_STR                  /* (약) 마약처방전출력횟수 */
							,  ''  as OPRM_CD
							,  ''  as AFI_TOTL_QTY_STR2
							,  ''  as AFI_TOTL_QTY_STR3
							, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = e.ARVL_DPRT_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD
							, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.WARD_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD1
							, to_char(e.CARE_PRIN_DT, 'yyyymmddhh24miss') as CARE_PRIN_DT
							, (select x.USER_NM
								 from ccuseramt x
								where x.lgin_id = e.CARE_PNPR_ID
								  and rownum = 1) as USER_NM
						    , e.MDTN_NO as MDTN_NO
						    , e.ORDR_SNO as ORDR_SNO
						    , ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_CNFM_ID ) as USER_NM_2
						    , to_char(e.RTRN_CNFR_DT, 'yyyymmddhh24miss') as RTRN_CNFR_DT
						 from
							   SDJREQADT d              /*  부서약품청구보조관리(부서별 청구가능 약품별 수량을 미리 정해둔 엔터티) */
							,  MDORDRCMT c              /*  처방코드기본 */
							,  MDMEDORDT a              /*  약처방 */
							,  SDJDGRTNT e              /*  처방성약품반납관리 */
							,  SDPORDDET g              /*  처방조제상세 */
						where
							   e.PTNO                      = a.PTNO                                                  /*  환자번호             */
						  and  e.ORDR_YMD                  = a.ORDR_YMD                                              /*  처방일자             */
						  and  e.ORDR_SNO                  = a.ORDR_SNO                                              /*  처방순번             */
						  and  e.MDTN_LCDV_CD              = a.MDTN_LCDV_CD                                          /*  투약위치             */
						  and  nvl(e.ARVL_DPRT_CD, 'ZZ')   = nvl(#{wardCd}, nvl(e.ARVL_DPRT_CD, 'ZZ'))                /*  발생처(도착지-약국)  */
						  and  e.RTRN_RQST_YMD             = to_date(#{inqrStrtYmd}, 'yyyymmdd')                             /*  반납요청자일시       */
						  and  e.PTNO                      = nvl(#{ptno}, e.PTNO)
						  and  e.DRUG_RTRE_CD              = (SELECT X.MDCR_DTLS_CTRL_CD
																FROM MZCTRLMMT X
															   WHERE MDCR_CTRL_CD = 'MNW917'
															     AND MDCR_DTLS_CTRL_NM = 'X'
																 AND ROWNUM = 1)                                                       /*  약반납사유코드 */
						  and  e.MDPR_CD                   = c.ORDR_CD                                               /*  처방코드             */
						  and  nvl(e.TEAM_CD, 'Z')         = decode(#{teamCd}, '*', nvl(e.TEAM_CD, 'Z'), #{teamCd})
						  and  e.ARVL_DPRT_CD              = d.DPRT_CD(+)
						  and  e.MDPR_CD                   = d.MDPR_CD(+)
						  and  nvl(e.STDL_DETL_DVSN_CD, 'Z')   <> 'T'                                                      /*  입출고상세구분코드 (SD010) TPN 반납약 제외  */
						  and  (
								(
								  (#{dvsnVl1} = 'D')
								  and
								  (a.MDPR_CLSF_CD  in  ('2', '3'))
								 )
								 or
								 (
								  (#{dvsnVl1} != 'D')
								  and
								  (a.MDPR_CLSF_CD  = #{dvsnVl1})
								 )
							   )
						  and  a.DRAP_DVSN_CD             = '2'
						  /* - */
						  and  g.ORDR_YMD              (+)= a.ORDR_YMD                    /*  처방일자             */
						  and  g.MDTN_NO_DVSN_CD       (+)= a.MDTN_NO_DVSN_CD                  /*  투약번호구분         */
						  and  g.MDTN_NO               (+)= a.MDTN_NO                        /*  투약번호             */
						  and  g.ORDR_SNO              (+)= a.ORDR_SNO                  /*  처방순번             */
						  and  g.MDTN_LCDV_CD          (+)= a.MDTN_LCDV_CD                /*  투약위치             */
						  and  not exists (
										   select  1
											 from  SDJDGRTNT f
											where  f.PTNO           =  a.PTNO
											  and  f.ORDR_YMD       =  a.ORDR_YMD
											  and  f.ORDR_SNO       =  a.ORDR_SNO
											  and  f.MDTN_LCDV_CD   =  a.MDTN_LCDV_CD                /*  투약위치             */
											  and  f.DRUG_RTRE_CD   <>  '6'
											)
						  and  (
								(((#{dprtCd} = 'W') and ( #{wardCd} = fn_cc_get_dprt_cd('WARD_DLR') ) and fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'W|MDP_408|MDP_410') = 'Y') /* 분만장 */
								 or
								 ((#{dprtCd} = 'W') and ( #{wardCd} <> fn_cc_get_dprt_cd('WARD_DLR') ))   ) or
								(#{dprtCd} = 'O' ) or        /*  기타장소(ORDACPPL) */
							    ((#{dprtCd} = '01H' and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419|MDP_436') = 'Y') or        /*  투석실(혈액)       */
								(#{dprtCd} = 'ETC' and  (a.OROC_DPRT_CD = #{dprtCd1} or a.FRNS_DPRT_CD = #{dprtCd1})                        ) or        /*  기타장소(ORDACPPL) */
								(#{dprtCd} = 'OP' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_AN') ) or /* 마취통증의학과*/
								(#{dprtCd} = 'OP3' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_OPRM') ) or /* 수술실 */
								(#{dprtCd} = 'OP2' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_PACU') ) or /* 회복실 */
								(#{dprtCd} = 'BR' and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD, 'Z') =  'BR')) or   /*  영상의학과 */
								(#{dprtCd} = 'WARD2' and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y' ))                      /*  병동-분만  */
							   )
						union all
					   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnYmdBaseNrdrRtrnInqr  mnd_jdgrtnt_l03$S01_약반납내역 조회 반납일자기준DAM */
							   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss')                             as RTRN_RQST_DT                    /*  반납요청자일시       */
							,  to_char(a.ORDR_YMD, 'yyyymmdd')                                         as ORDR_YMD                        /*  처방일자             */
							,  e.ARVL_DPRT_CD                                                          as ARVL_DPRT_CD                    /*  병동                 */
							,  e.PTNO                                                                  as PTNO                            /*  환자번호             */
							,  ( select  PTNT_NM from  APPTPTNTT where  PTNO = e.PTNO )         as PTNT_NM                         /*  환자번호             */
							,  e.MDPR_CD                                                               as MDPR_CD                         /*  약품코드             */
							,  c.ORDR_NM                                                               as ORDR_NM                         /*  처방명               */
							,  case when a.SLCT_UNIT_DVSN_CD = '1' and a.PCKN_UNAD_QTY < 1 then '0'||a.PCKN_UNAD_QTY
									when a.SLCT_UNIT_DVSN_CD = '1' and a.PCKN_UNAD_QTY >= 1 then to_char(a.PCKN_UNAD_QTY)
									when a.SLCT_UNIT_DVSN_CD = '2' and a.ICUN_ADMN_VLM < 1 then '0'||a.ICUN_ADMN_VLM
									when a.SLCT_UNIT_DVSN_CD = '2' and a.ICUN_ADMN_VLM >= 1 then to_char(a.ICUN_ADMN_VLM)
									end                                                                as AFI_ADMN_VLM_STR                /*  투여량(함량단위)     */
							,  decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCUN_CD, a.ICUN_CD)  as ICUN_CD1                                        /*  단위(함량단위)       */
							,  a.DC_DVSN_CD                                                            as DC_DVSN_CD                      /*  D/C여부              */
							,  e.DRUG_RTRE_CD                                                          as DRUG_RTRE_CD                    /*  반납사유             */
							,  decode(e.DSCH_ATMT_RTRN_YN, 'Y'
														  , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
																from CCCMCDDMT A, CCCMCDDLT B
																where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
																  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
																  and A.COMN_GRP_CD  = 'SD068'
																  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
																  and B.LNGG_CD(+)   = nvl('', '*'))||'(퇴)'
														 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
																from CCCMCDDMT A, CCCMCDDLT B
																where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
																  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
																  and A.COMN_GRP_CD  = 'SD068'
																  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
																  and B.LNGG_CD(+)   = nvl('', '*')))  as CD_NM     /*  반납사유(퇴원자동반납여부) */
							,  to_char(e.MDPR_RTRN_NTM)                                                as AFI_RTRN_NTM_STR                /*  반납횟수             */
							,  to_char(e.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR                /*  반납요청수량         */
							,  to_char(e.PTAD_RTRN_QTY)                                                as AFI_RTRN_CQY_STR1               /*  원무반납량         */
							,  e.RTRN_YN                                                               as RTRN_YN                         /*  반납확인여부         */
							,  decode(e.REFN_YN, 'N', '', e.REFN_YN)                                   as REFN_YN                         /*  환불여부             */
							,  to_char(a.NTM)                                                          as AFI_NTM_STR                     /*  횟수                 */
							,  a.ORFR_CD                                                               as ORFR_CD                         /*  처방형태             */
							,  to_char(a.MDTN_NO)                                                      as AFI_MDTN_NO_STR                 /*  투약번호             */
							,  to_char(a.ORDR_SNO)                                                     as AFI_ORDR_SNO_STR                /*  처방순번             */
							,  a.SLCT_UNIT_DVSN_CD                                                     as SLCT_UNIT_DVSN_CD               /*  선택단위구분         */
							,  to_char(a.PCKN_UNAD_QTY)                                                as AFI_PCKN_UNAD_QTY_STR           /*  투여량(포장단위)     */
							,  to_char(a.ICUN_ADMN_VLM)                                                as AFI_ADMN_VLM_STR1               /*  투여량(함량단위)     */
							,  to_char(a.DDCN)                                                         as AFI_DDCN_STR                    /*  일수                 */
							,  a.DRAP_DVSN_CD                                                          as DRAP_DVSN_CD                    /*  약적용구분(SD002)      */
							,  c.TOTL_QTY_CLCL_CD                                                      as TOTL_QTY_CLCL_CD                /*  총량계산코드         */
							,  a.ODKI_CD                                                               as ODKI_CD
							,  e.RTRN_RQPR_ID                                                          as RTRN_RQPR_ID
							, ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
							,  a.DRUG_ORDR_PRSS_CD                                                     as DRUG_ORDR_PRSS_CD
							,  e.PTRM_NO                                                               as PTRM_NO
							,  e.SCKB_NO                                                               as SCKB_NO
							,  a.WARD_CD                                                               as WARD_CD
							,  a.PCUN_CD                                                               as PCUN_CD                         /*  포장단위코드           */
							,  c.MDPR_CLSF_CD                                                          as MDPR_CLSF_CD                    /*  약품분류코드 (SD001)  */
							,  d.MDPR_CD                                                               as MDPR_CD1
							,  to_char((decode(a.SLCT_UNIT_DVSN_CD, '2'
																  , decode(sign(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)
																			   - decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, c.PCUN_INLS_QTY))
																			   , 1, ceil(e.PTAD_RTRN_QTY)
																				  , trunc(e.PTAD_RTRN_QTY))
																  , trunc(e.PTAD_RTRN_QTY)
											   )
										)
									   )                                                               as AFI_ADMN_VLM_STR2
							,  e.PTDV_CD                                                               as PTDV_CD
							,  e.RTRN_DVSN_CD                                                          as RTRN_DVSN_CD                    /*  반납구분코드 (SD051)(N:간호입력 P:약국입력) */
							,  e.RTRN_CNFR_CQY                                                         as AFI_RTRN_CQY_STR2               /*  반납(확인)수량     */
							,  d.COCK_YN                                                               as COCK_YN
							,  nvl(c.STST_DVSN_CD, '*')                                                as STST_DVSN_CD                    /*  통계구분(약품코드:SD008) */
							,  a.OROC_DPRT_CD                                                               as OROC_DPRT_CD
							,  a.FRNS_CTRL_DVSN_CD                                                     as FRNS_CTRL_DVSN_CD               /*  **. 불출제어 플래그(SD800) - B1:모호한, B2:명확한 */
							,  c.CLNC_EXAM_DRUG_YN                                                     as CLNC_EXAM_DRUG_YN
							,  e.MDTN_NO_DVSN_CD                                                       as MDTN_NO_DVSN_CD                 /*  투약번호구분코드(BDGORDTYP)   */
							,  e.MDTN_LCDV_CD                                                          as MDTN_LCDV_CD                    /*  투약위치구분코드(DGLOCATFG)   */
							,  to_char(f.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR3
							,  to_char(e.RTRN_RQST_CQY * c.PCUN_INLS_QTY)                              as AFI_RTRN_CQY_STR4
		   /*                  ,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', e.MDPR_RTRN_NTM*c.PCUN_INLS_QTY*a.PCKN_UNAD_QTY, */
		   /*                                                         '2', e.MDPR_RTRN_NTM*a.ICUN_ADMN_VLM))  as AFI_RTRN_CQY_STR4 */
							,  c.ICUN_CD                                                               as ICUN_CD
							,  to_char(c.PCUN_INLS_QTY)                                                as AFI_PCUN_INLS_QTY_STR
							,  to_char(a.NRDR_RTRN_PRTX_PRIN_NTM)                                      as AFI_PRIN_NTM_STR
							,  decode(e.RTRN_YN, 'Y', to_char(e.LAST_UPDT_DT, 'yyyymmddhh24mi'), '')   as LAST_UPDT_DT
							,  a.RTRN_EXRE_CTN                                                         as RTRN_EXRE_CTN
							,  to_char(g.INVN_TOTL_QTY*c.PCUN_INLS_QTY)                                as AFI_TOTL_QTY_STR
							,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '2', g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
																	  , g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.PCKN_UNAD_QTY*a.NTM*c.PCUN_INLS_QTY)) as AFI_TOTL_QTY_STR1
							,  a.EXRE_RTRN_QTY                                                         as AFI_EXRE_RTRN_QTY_STR
							,  to_char(decode(a.MDPR_CLSF_CD, '2', a.NRDR_PRTX_PRIN_NTM
															, '3', a.NRDR_RTRN_PRTX_PRIN_NTM))         as AFI_NRDR_PRTX_PRIN_NTM_STR                  /* (약) 마약처방전출력횟수 */
							,  ''  as OPRM_CD
							,  ''  as AFI_TOTL_QTY_STR2
							,  ''  as AFI_TOTL_QTY_STR3
							, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = e.ARVL_DPRT_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD
							, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.WARD_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD1
							, to_char(e.CARE_PRIN_DT, 'yyyymmddhh24miss') as CARE_PRIN_DT
							, (select x.USER_NM
								 from ccuseramt x
								where x.lgin_id = e.CARE_PNPR_ID
								  and rownum = 1) as USER_NM
						    , e.MDTN_NO as MDTN_NO
						    , e.ORDR_SNO as ORDR_SNO
						    , ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_CNFM_ID ) as USER_NM_2
						    , to_char(e.RTRN_CNFR_DT, 'yyyymmddhh24miss') as RTRN_CNFR_DT
						 from
							   SDJREQADT d              /*  부서약품청구보조관리(부서별 청구가능 약품별 수량을 미리 정해둔 엔터티) */
							,  MDORDRCMT c              /*  처방코드기본 */
							,  MDMEDORDT a              /*  약처방 */
							,  SDJDGRTNT e              /*  처방성약품반납관리 */
							,  SDJDGRTNT f
							,  SDPORDDET g              /*  처방조제상세 */
						where
							   e.PTNO                      = a.PTNO                                                  /*  환자번호             */
						  and  e.ORDR_YMD                  = a.ORDR_YMD                                              /*  처방일자             */
						  and  e.ORDR_SNO                  = a.ORDR_SNO                                              /*  처방순번             */
						  and  e.MDTN_LCDV_CD              = a.MDTN_LCDV_CD                                          /*  투약위치             */
						  and  nvl(e.ARVL_DPRT_CD, 'ZZ')   = nvl(#{wardCd}, nvl(e.ARVL_DPRT_CD, 'ZZ'))                /*  발생처(도착지-약국)  */
						  and  e.RTRN_RQST_YMD             = to_date(#{inqrStrtYmd}, 'yyyymmdd')                             /*  반납요청자일시       */
						  and  e.PTNO                      = nvl(#{ptno}, e.PTNO)
						  and  e.DRUG_RTRE_CD              not in ('6','7')                                         /*  2009.06.02 미수령자동반납 제외 */
						  and  e.MDPR_CD                   = c.ORDR_CD                                               /*  처방코드             */
						  and  nvl(e.TEAM_CD, 'Z')         = decode(#{teamCd}, '*', nvl(e.TEAM_CD, 'Z'), #{teamCd})
						  and  e.ARVL_DPRT_CD              = d.DPRT_CD(+)
						  and  e.MDPR_CD                   = d.MDPR_CD(+)
						  and  nvl(e.STDL_DETL_DVSN_CD, 'Z')   <> 'T'                                                      /*  입출고상세구분코드 (SD010) TPN 반납약 제외  */
						  and  f.PTNO                   (+)= a.PTNO                        /*  환자번호             */
						  and  f.ORDR_YMD               (+)= a.ORDR_YMD                   /*  처방일자             */
						  and  f.ORDR_SNO               (+)= a.ORDR_SNO                 /*  처방순번             */
						  and  f.MDTN_LCDV_CD           (+)= a.MDTN_LCDV_CD                /*  투약위치             */
						  and  f.DRUG_RTRE_CD           (+)= '6X' /* (SELECT X.MDCR_DTLS_CTRL_CD FROM MZCTRLMMT X WHERE MDCR_CTRL_CD = 'MNW917' AND ROWNUM = 1) */
						  and  (#{dvsnVl2} = '2')
						  /* - */
						  and  a.MDPR_CLSF_CD            in ('2', '3')
						  and  a.DRAP_DVSN_CD            <> '2'                           /*  마약이고, 경구약/기타약 */
						  /* - */
						  and  g.ORDR_YMD              (+)= a.ORDR_YMD                    /*  처방일자             */
						  and  g.MDTN_NO_DVSN_CD       (+)= a.MDTN_NO_DVSN_CD                  /*  투약번호구분         */
						  and  g.MDTN_NO               (+)= a.MDTN_NO                        /*  투약번호             */
						  and  g.ORDR_SNO              (+)= a.ORDR_SNO                  /*  처방순번             */
						  and  g.MDTN_LCDV_CD          (+)= a.MDTN_LCDV_CD                /*  투약위치             */
						  and  (
								(((#{dprtCd} = 'W') and ( #{wardCd} = fn_cc_get_dprt_cd('WARD_DLR') ) and fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'W|MDP_408|MDP_410') = 'Y') /* 분만장 */
								 or
								 ((#{dprtCd} = 'W') and ( #{wardCd} <> fn_cc_get_dprt_cd('WARD_DLR') ))   ) or
								(#{dprtCd} = 'O') or        /*  기타장소(ORDACPPL) */
								((#{dprtCd} = '01H' and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419|MDP_436') = 'Y') or        /*  투석실(혈액)       */
								 (#{dprtCd} = 'ETC' and  (a.OROC_DPRT_CD = #{dprtCd1} or a.FRNS_DPRT_CD = #{dprtCd1})                        ) or        /*  기타장소(ORDACPPL) */
								 (#{dprtCd} = 'OP' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_AN') ) or /* 마취통증의학과 */
								 (#{dprtCd} = 'OP3' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_OPRM') ) or /* 수술실 */
								 (#{dprtCd} = 'OP2' and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_PACU') ) or /* 회복실 */
								 (#{dprtCd} = 'BR' and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD, 'Z') =  'BR')) or   /*  영상의학과 */
								 (#{dprtCd} = 'WARD2' and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y' ))                      /*  병동-분만  */
							   )) ZZ
				order
				   by  ZZ.MDPR_CLSF_CD desc
					,  decode(ZZ.DRAP_DVSN_CD, '2', 1, '3', 2, '1', 3)
					,  ZZ.PTRM_NO
					,  ZZ.SCKB_NO
					,  ZZ.PTNO
					,  ZZ.ORDR_YMD
					,  ZZ.AFI_ORDR_SNO_STR
					,  ZZ.RTRN_RQST_DT
				]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseNrdrRtrnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="arvlDprtCd" column="ARVL_DPRT_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="afiAdmnVlmStr" column="AFI_ADMN_VLM_STR"/>
		<result property="icunCd1" column="ICUN_CD_1"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="afiRtrnCqyStr" column="AFI_RTRN_CQY_STR"/>
		<result property="afiRtrnCqyStr1" column="AFI_RTRN_CQY_STR_1"/>
		<result property="rtrnYn" column="RTRN_YN"/>
		<result property="refnYn" column="REFN_YN"/>
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
		<result property="orfrCd" column="ORFR_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="afiPcknUnadQtyStr" column="AFI_PCKN_UNAD_QTY_STR"/>
		<result property="afiAdmnVlmStr1" column="AFI_ADMN_VLM_STR_1"/>
		<result property="afiDdcnStr" column="AFI_DDCN_STR"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="rtrnRqprId" column="RTRN_RQPR_ID"/>
		<result property="afiRtrnRqprNm" column="AFI_RTRN_RQPR_NM"/>
		<result property="drugOrdrPrssCd" column="DRUG_ORDR_PRSS_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="mdprCd1" column="MDPR_CD_1"/>
		<result property="afiAdmnVlmStr2" column="AFI_ADMN_VLM_STR_2"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="rtrnDvsnCd" column="RTRN_DVSN_CD"/>
		<result property="afiRtrnCqyStr2" column="AFI_RTRN_CQY_STR_2"/>
		<result property="cockYn" column="COCK_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="frnsCtrlDvsnCd" column="FRNS_CTRL_DVSN_CD"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="carePrinDt" column="CARE_PRIN_DT"/>
		<result property="userNm" column="USER_NM"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseNrdrRtrnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseNrdrRtrnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseNrdrRtrnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseNrdrRtrnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrYmdBaseNrdrRtrnInqr  mnd_jdgrtnt_l04$S01_약반납내역 조회 처방일자기준DAM */
				   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss') as RTRN_RQST_DT                   /*  반납요청자일시       */
				,  to_char(a.ORDR_YMD, 'yyyymmdd') as ORDR_YMD                       /*  처방일자             */
				,  e.ARVL_DPRT_CD as ARVL_DPRT_CD                   /*  병동                 */
				,  e.PTNO as PTNO                           /*  환자번호             */
				,  ( select  PTNT_NM from  APPTPTNTT where  PTNO = e.PTNO ) as PTNT_NM                           /*  환자번호             */
				,  e.MDPR_CD as MDPR_CD                        /*  약품코드             */
				,  c.ORDR_NM as ORDR_NM                        /*  처방명               */
				,  case when a.DRAP_DVSN_CD = 1 and a.PCKN_UNAD_QTY < 1 then '0'||a.PCKN_UNAD_QTY
						when a.DRAP_DVSN_CD = 1 and a.PCKN_UNAD_QTY >= 1 then to_char(a.PCKN_UNAD_QTY)
						when a.DRAP_DVSN_CD = 2 and a.ICUN_ADMN_VLM < 1 then '0'||a.ICUN_ADMN_VLM
						when a.DRAP_DVSN_CD = 2 and a.ICUN_ADMN_VLM >= 1 then to_char(a.ICUN_ADMN_VLM)
				   else
						 case when decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM) < 1 then '0'
						 else ''
						  end
						 || to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM))
					end as AFI_ADMN_VLM_STR           /*  투여량(함량단위)     */
				,  decode(a.DRAP_DVSN_CD,'1',a.PCUN_CD,'2',a.ICUN_CD, decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCUN_CD, a.ICUN_CD)) as ICUN_CD_1                                       /*  단위(함량단위)       */
				,  a.DC_DVSN_CD as DC_DVSN_CD                     /*  D/C여부              */
				,  e.DRUG_RTRE_CD as DRUG_RTRE_CD                   /*  반납사유             */
				,  decode(e.DSCH_ATMT_RTRN_YN, 'Y'
											 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
												   from CCCMCDDMT A, CCCMCDDLT B
												   where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													 and A.COMN_GRP_CD  = 'SD068'
													 and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													 and B.LNGG_CD(+)   = nvl('', '*'))||'(퇴)'
											 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
												   from CCCMCDDMT A, CCCMCDDLT B
												   where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													 and A.COMN_GRP_CD  = 'SD068'
													 and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													 and B.LNGG_CD(+)   = nvl('', '*'))) as CD_NM                          /*  반납사유(퇴원자동반납여부) */
				,  to_char(e.MDPR_RTRN_NTM) as AFI_RTRN_NTM_STR               /*  반납횟수             */
				,  to_char(e.RTRN_RQST_CQY) as AFI_RTRN_CQY_STR               /*  반납요청수량         */
				,  to_char(e.PTAD_RTRN_QTY) as AFI_RTRN_CQY_STR_1              /*  원무반납량         */
				,  e.RTRN_YN as RTRN_YN                        /*  반납확인여부         */
				,  decode(e.REFN_YN, 'N', '', e.REFN_YN) as REFN_YN                        /*  환불여부             */
				,  to_char(a.NTM) as AFI_NTM_STR                    /*  횟수                 */
				,  a.ORFR_CD as ORFR_CD                        /*  처방형태             */
				,  to_char(a.MDTN_NO) as AFI_MDTN_NO_STR                /*  투약번호             */
				,  to_char(a.ORDR_SNO) as AFI_ORDR_SNO_STR               /*  처방순번             */
				,  a.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD              /*  선택단위구분         */
				,  to_char(a.PCKN_UNAD_QTY) as AFI_PCKN_UNAD_QTY_STR          /*  투여량(포장단위)     */
				,  to_char(a.ICUN_ADMN_VLM) as AFI_ADMN_VLM_STR_1              /*  투여량(함량단위)     */
				,  to_char(a.DDCN) as AFI_DDCN_STR                   /*  일수                 */
				,  a.DRAP_DVSN_CD as DRAP_DVSN_CD                   /*  약적용구분(SD002)      */
				,  c.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD               /*  총량계산코드         */
				,  a.ODKI_CD as ODKI_CD
				,  e.RTRN_RQPR_ID as RTRN_RQPR_ID
				, ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
				,  a.DRUG_ORDR_PRSS_CD as DRUG_ORDR_PRSS_CD
				,  e.PTRM_NO as PTRM_NO
				,  e.SCKB_NO as SCKB_NO
				,  a.WARD_CD as WARD_CD
				,  a.PCUN_CD as PCUN_CD                        /*  포장단위코드           */
				,  c.MDPR_CLSF_CD as MDPR_CLSF_CD                   /*  약품분류코드 (SD001)  */
				,  d.MDPR_CD as MDPR_CD_1
				,  to_char((decode(a.SLCT_UNIT_DVSN_CD, '2'
													  , decode(sign(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)
																  - decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, c.PCUN_INLS_QTY))
																   , 1, ceil(e.PTAD_RTRN_QTY)
																	  , trunc(e.PTAD_RTRN_QTY))
													  , trunc(e.PTAD_RTRN_QTY)
								   )
							)
						   ) as AFI_ADMN_VLM_STR_2
				,  e.PTDV_CD as PTDV_CD
				,  e.RTRN_DVSN_CD as RTRN_DVSN_CD                  /*  반납구분코드 (SD051)(N:간호입력 P:약국입력) */
				,  e.RTRN_CNFR_CQY as AFI_RTRN_CQY_STR_2             /*  반납(확인)수량     */
				,  d.COCK_YN as COCK_YN
				,  nvl(c.STST_DVSN_CD, '*') as STST_DVSN_CD                  /*  통계구분(약품코드:SD008) */
				,  a.OROC_DPRT_CD as OROC_DPRT_CD
				,  a.FRNS_CTRL_DVSN_CD as FRNS_CTRL_DVSN_CD             /*  **. 불출제어 플래그(SD800) - B1:모호한, B2:명확한 */
				,  c.CLNC_EXAM_DRUG_YN as CLNC_EXAM_DRUG_YN
				,  e.MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD               /*  투약번호구분코드(BDGORDTYP)   */
				,  e.MDTN_LCDV_CD as MDTN_LCDV_CD                  /*  투약위치구분코드(DGLOCATFG)   */
				,  to_char(f.RTRN_RQST_CQY) as ABRV_DPRT_CD
				,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', e.MDPR_RTRN_NTM*c.PCUN_INLS_QTY*a.PCKN_UNAD_QTY,
													   '2', e.MDPR_RTRN_NTM*a.ICUN_ADMN_VLM)) as ABRV_DPRT_CD_1
		/* EHR_MOD		,  c.ICUN_CD as INDEX OF(51) ERROR
				,  to_char(c.PCUN_INLS_QTY) as INDEX OF(52) ERROR    */     /*  포장단위포함량 */
		/* EHR_MOD		,  to_char(a.NRDR_RTRN_PRTX_PRIN_NTM) as INDEX OF(53) ERROR
				,  decode(e.RTRN_YN, 'Y', to_char(e.LAST_UPDT_DT, 'yyyymmddhh24mi'), '') as INDEX OF(54) ERROR
				,  a.RTRN_EXRE_CTN as INDEX OF(55) ERROR
				,  to_char(g.INVN_TOTL_QTY*c.PCUN_INLS_QTY) as INDEX OF(56) ERROR
				,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '2', g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
														  , g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.PCKN_UNAD_QTY*a.NTM*c.PCUN_INLS_QTY)) as INDEX OF(57) ERROR
				,  a.EXRE_RTRN_QTY as INDEX OF(58) ERROR
				,  to_char(decode(a.MDPR_CLSF_CD, '2', a.NRDR_PRTX_PRIN_NTM
												, '3', a.NRDR_RTRN_PRTX_PRIN_NTM)) as INDEX OF(59) ERROR   */               /* (약) 마약처방전출력횟수 */
			/* EHR_MOD		, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = e.ARVL_DPRT_CD group by ABRV_DPRT_CD ) as INDEX OF(60) ERROR
				, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.WARD_CD group by ABRV_DPRT_CD ) as INDEX OF(61) ERROR */
				, to_char(e.CARE_PRIN_DT, 'yyyymmddhh24miss') as CARE_PRIN_DT
				, (select x.USER_NM
					 from ccuseramt x
					where x.lgin_id = e.CARE_PNPR_ID
					  and rownum = 1) as USER_NM 
			    , e.MDTN_NO as MDTN_NO
			    , e.ORDR_SNO as ORDR_SNO
			 from
				   SDJREQADT d              /*  부서약품청구보조관리(부서별 청구가능 약품별 수량을 미리 정해둔 엔터티) */
				,  MDORDRCMT c              /*  처방코드기본 */
				,  MDMEDORDT a              /*  약처방 */
				,  SDJDGRTNT e              /*  처방성약품반납관리 */
				,  SDJDGRTNT f
				,  SDPORDDET g              /*  처방조제상세 */
			where
				   e.PTNO                      = a.PTNO                                                  /*  환자번호             */
			  and  e.ORDR_YMD                  = a.ORDR_YMD                                              /*  처방일자             */
			  and  e.ORDR_SNO                  = a.ORDR_SNO                                              /*  처방순번             */
			  and  e.MDTN_LCDV_CD              = a.MDTN_LCDV_CD                                          /*  투약위치             */
			  and  nvl(e.ARVL_DPRT_CD, 'ZZ')   = nvl(#{wardCd}, nvl(e.ARVL_DPRT_CD, 'ZZ'))                /*  발생처(도착지-약국)  */
			  and  e.ORDR_YMD between to_date(#{inqrStrtYmd}, 'yyyymmdd') and to_date(#{inqrFnshYmd},'yyyymmdd')
			  and  e.PTNO                      = nvl(#{ptno}, e.PTNO)
			  and  e.DRUG_RTRE_CD              not in ('6','7')                                         /*  2009.06.02 미수령자동반납 제외 */
			  and  e.MDPR_CD                   = c.ORDR_CD                                               /*  처방코드             */
			  and  nvl(e.TEAM_CD, 'Z')         = decode(#{teamCd}, '*', nvl(e.TEAM_CD, 'Z'), #{teamCd})
			  and  e.ARVL_DPRT_CD              = d.DPRT_CD(+)
			  and  e.MDPR_CD                   = d.MDPR_CD(+)
			  and  nvl(e.STDL_DETL_DVSN_CD, 'Z')   <> 'T'                                                      /*  입출고상세구분코드 (SD010) TPN 반납약 제외  */
			  and  f.PTNO                   (+)= a.PTNO                        /*  환자번호             */
			  and  f.ORDR_YMD               (+)= a.ORDR_YMD                   /*  처방일자             */
			  and  f.ORDR_SNO               (+)= a.ORDR_SNO                 /*  처방순번             */
			  and  f.MDTN_LCDV_CD           (+)= a.MDTN_LCDV_CD                /*  투약위치             */
			  and  f.DRUG_RTRE_CD           (+)= '6'
			  /* - */
			  and  (
					(
					  (#{dvsnVl1} = 'D')
					  and
					  (a.MDPR_CLSF_CD  in  ('2', '3'))
					 )
					 or
					 (
					  (#{dvsnVl1} != 'D')
					  and
					  (a.MDPR_CLSF_CD  = #{dvsnVl1})
					 )
					)
			  /* - */
			  and  a.DRAP_DVSN_CD = '2'
			  /* - */
			  and  g.ORDR_YMD              (+)= a.ORDR_YMD                    /*  처방일자             */
			  and  g.MDTN_NO_DVSN_CD       (+)= a.MDTN_NO_DVSN_CD                  /*  투약번호구분         */
			  and  g.MDTN_NO               (+)= a.MDTN_NO                        /*  투약번호             */
			  and  g.ORDR_SNO              (+)= a.ORDR_SNO                  /*  처방순번             */
			  and  g.MDTN_LCDV_CD          (+)= a.MDTN_LCDV_CD                /*  투약위치             */
			  /* - */
			  and  ((#{dprtCd} = 'W') or
					(#{dprtCd} = 'O'
					 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'O') = 'Y') or        /*  기타장소(ORDACPPL) */
					((#{dprtCd} = 'DSC'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411|MDP_412|MDP_413|MDP_414|MDP_415|MDP_416') = 'Y') or       /*  DSC                */
					(#{dprtCd} = 'DF'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411') = 'Y') or        /*  DSC                */
					(#{dprtCd} = 'DG'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_412|MDP_415') = 'Y') or       /*  DSC                */
					(#{dprtCd} = 'DH'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_413') = 'Y') or       /*  DSC                */
					(#{dprtCd} = 'DI'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_414') = 'Y') or       /*  DSC                */
					(#{dprtCd} = 'DK'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_416') = 'Y') or        /*  DSC                */
					(#{dprtCd} = 'Di'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_434') = 'Y') or       /*  PTC-마취준비실       */
					(#{dprtCd} = 'Dk'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_435') = 'Y') or       /*  PTC-회복실           */
					(#{dprtCd} = '01H'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419|MDP_436') = 'Y') or        /*  투석실(혈액)       */
					(#{dprtCd} = 'ETC'
						 and  a.OROC_DPRT_CD = #{dprtCd1}                        ) or        /*  기타장소(ORDACPPL) */
					(#{dprtCd} = 'OP3'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_421') = 'Y') or        /*  MOR-수술실         */
					(#{dprtCd} = 'OP'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_420') = 'Y') or        /*  MOR-회복실         */
					(#{dprtCd} = 'OP2'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_407') = 'Y') or        /*  MOR-준비실         */
					(#{dprtCd} = 'OP4'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_422') = 'Y') or        /*  PMC-DSC통증관리실  */
					(#{dprtCd} = 'OP5'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_443') = 'Y') or        /*  마취실(COR)        */
					(#{dprtCd} = 'OP6'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_439') = 'Y') or        /*  수술실(COR)        */
					(#{dprtCd} = 'OP7'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_437') = 'Y') or        /*  회복실(COR)        */
					(#{dprtCd} = 'OP8'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_446') = 'Y') or        /*  기관지내시경실   */
					(#{dprtCd} = 'BR'
						 and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD, 'Z') =  'BR')) or   /*  영상의학과 */
					(#{dprtCd} = 'WARD2'
						 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y' ))                      /*  병동-분만  */
					)
		   union all
		   select
				   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss')                             as RTRN_RQST_DT                    /*  반납요청자일시       */
				,  to_char(a.ORDR_YMD, 'yyyymmdd')                                         as ORDR_YMD                        /*  처방일자             */
				,  e.ARVL_DPRT_CD                                                          as ARVL_DPRT_CD                    /*  병동                 */
				,  e.PTNO                                                                  as PTNO                            /*  환자번호             */
				,  ( select  PTNT_NM from  APPTPTNTT where  PTNO = e.PTNO )         as PTNM                             /*  환자번호             */
				,  e.MDPR_CD                                                               as MDPR_CD                         /*  약품코드             */
				,  c.ORDR_NM                                                               as ORDR_NM                         /*  처방명               */
				,  case when a.DRAP_DVSN_CD = 1 and a.PCKN_UNAD_QTY < 1 then '0'||a.PCKN_UNAD_QTY
						when a.DRAP_DVSN_CD = 1 and a.PCKN_UNAD_QTY >= 1 then to_char(a.PCKN_UNAD_QTY)
						when a.DRAP_DVSN_CD = 2 and a.ICUN_ADMN_VLM < 1 then '0'||a.ICUN_ADMN_VLM
						when a.DRAP_DVSN_CD = 2 and a.ICUN_ADMN_VLM >= 1 then to_char(a.ICUN_ADMN_VLM)
				   else
						 case when decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM) < 1 then '0'
						 else ''
						  end
						 || to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM))
					end  as AFI_ADMN_VLM_STR           /*  투여량(함량단위)     */
				,  decode(a.DRAP_DVSN_CD,'1',a.PCUN_CD,'2',a.ICUN_CD, decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCUN_CD, a.ICUN_CD)) as UNIT_CD1                                       /*  단위(함량단위)       */
				,  a.DC_DVSN_CD                                                            as DC_DVSN_CD                      /*  D/C여부              */
				,  e.DRUG_RTRE_CD                                                          as DRUG_RTRE_CD                    /*  반납사유             */
				,  decode(e.DSCH_ATMT_RTRN_YN, 'Y'
											  , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
													from CCCMCDDMT A, CCCMCDDLT B
													where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													  and A.COMN_GRP_CD  = 'SD068'
													  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													  and B.LNGG_CD(+)   = nvl('', '*'))||'(퇴)'
											 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
													from CCCMCDDMT A, CCCMCDDLT B
													where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
													  and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
													  and A.COMN_GRP_CD  = 'SD068'
													  and A.COMN_DTLS_CD = e.DRUG_RTRE_CD
													  and B.LNGG_CD(+)   = nvl('', '*')))  as CD_NM     /*  반납사유(퇴원자동반납여부) */
				,  to_char(e.MDPR_RTRN_NTM)                                                as AFI_RTRN_NTM_STR                /*  반납횟수             */
				,  to_char(e.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR                /*  반납요청수량         */
				,  to_char(e.PTAD_RTRN_QTY)                                                as AFI_RTRN_CQY_STR1               /*  원무반납량         */
				,  e.RTRN_YN                                                               as RTRN_YN                         /*  반납확인여부         */
				,  decode(e.REFN_YN, 'N', '', e.REFN_YN)                                   as REFN_YN                         /*  환불여부             */
				,  to_char(a.NTM)                                                          as AFI_NTM_STR                     /*  횟수                 */
				,  a.ORFR_CD                                                               as ORFR_CD                         /*  처방형태             */
				,  to_char(a.MDTN_NO)                                                      as AFI_MDTN_NO_STR                 /*  투약번호             */
				,  to_char(a.ORDR_SNO)                                                     as AFI_ORDR_SNO_STR                /*  처방순번             */
				,  a.SLCT_UNIT_DVSN_CD                                                     as SLCT_UNIT_DVSN_CD               /*  선택단위구분         */
				,  to_char(a.PCKN_UNAD_QTY)                                                as AFI_PCKN_UNAD_QTY_STR           /*  투여량(포장단위)     */
				,  to_char(a.ICUN_ADMN_VLM)                                                as AFI_ADMN_VLM_STR1               /*  투여량(함량단위)     */
				,  to_char(a.DDCN)                                                         as AFI_DDCN_STR                    /*  일수                 */
				,  a.DRAP_DVSN_CD                                                          as DRAP_DVSN_CD                    /*  약적용구분(SD002)      */
				,  c.TOTL_QTY_CLCL_CD                                                      as TOTL_QTY_CLCL_CD                /*  총량계산코드         */
				,  a.ODKI_CD                                                               as ODKI_CD
				,  e.RTRN_RQPR_ID                                                          as RTRN_RQPR_ID
				, ( select  USER_NM from CCUSRDPHT where   USER_ID = e.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
				,  a.DRUG_ORDR_PRSS_CD                                                     as DRUG_ORDR_PRSS_CD
				,  e.PTRM_NO                                                               as PTRM_NO
				,  e.SCKB_NO                                                               as SCKB_NO
				,  a.WARD_CD                                                               as WARD_CD
				,  a.PCUN_CD                                                               as PCUN_CD                         /*  포장단위코드           */
				,  c.MDPR_CLSF_CD                                                          as MDPR_CLSF_CD                    /*  약품분류코드 (SD001)  */
				,  d.MDPR_CD                                                               as MDPR_CD1
				,  to_char((decode(a.SLCT_UNIT_DVSN_CD, '2'
													  , decode(sign(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)
																  - decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, c.PCUN_INLS_QTY))
																   , 1, ceil(e.PTAD_RTRN_QTY)
																	  , trunc(e.PTAD_RTRN_QTY))
													  , trunc(e.PTAD_RTRN_QTY)
								   )
							)
						   )                                                               as AFI_ADMN_VLM_STR2
				,  e.PTDV_CD                                                               as PTDV_CD
				,  e.RTRN_DVSN_CD                                                          as RTRN_DVSN_CD                  /*  반납구분코드 (SD051)(N:간호입력 P:약국입력) */
				,  e.RTRN_CNFR_CQY                                                         as AFI_RTRN_CQY_STR2             /*  반납(확인)수량     */
				,  d.COCK_YN                                                               as COCK_YN
				,  nvl(c.STST_DVSN_CD, '*')                                                as STST_DVSN_CD                  /*  통계구분(약품코드:SD008) */
				,  a.OROC_DPRT_CD                                                               as OROC_DPRT_CD
				,  a.FRNS_CTRL_DVSN_CD                                                     as FRNS_CTRL_DVSN_CD             /*  **. 불출제어 플래그(SD800) - B1:모호한, B2:명확한 */
				,  c.CLNC_EXAM_DRUG_YN                                                     as CLNC_EXAM_DRUG_YN
				,  e.MDTN_NO_DVSN_CD                                                       as MDTN_NO_DVSN_CD               /*  투약번호구분코드(BDGORDTYP)   */
				,  e.MDTN_LCDV_CD                                                          as MDTN_LCDV_CD                  /*  투약위치구분코드(DGLOCATFG)    */
				,  to_char(e.RTRN_RQST_CQY)                                                as AFI_RTRN_CQY_STR3
				,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', e.MDPR_RTRN_NTM*c.PCUN_INLS_QTY*a.PCKN_UNAD_QTY,
													   '2', e.MDPR_RTRN_NTM*a.ICUN_ADMN_VLM))  as AFI_RTRN_CQY_STR4
				,  c.ICUN_CD                                                               as ICUN_CD
				,  to_char(c.PCUN_INLS_QTY)                                                as AFI_PCUN_INLS_QTY_STR
				,  to_char(a.NRDR_RTRN_PRTX_PRIN_NTM)                                      as AFI_PRIN_NTM_STR
				,  decode(e.RTRN_YN, 'Y', to_char(e.LAST_UPDT_DT, 'yyyymmddhh24mi'), '')   as LAST_UPDT_DT
				,  a.RTRN_EXRE_CTN                                                         as RTRN_EXRE_CTN
				,  to_char(g.INVN_TOTL_QTY*c.PCUN_INLS_QTY)                                as AFI_TOTL_QTY_STR
				,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '2', g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
														  , g.INVN_TOTL_QTY*c.PCUN_INLS_QTY-a.PCKN_UNAD_QTY*a.NTM*c.PCUN_INLS_QTY)) as AFI_TOTL_QTY_STR1
				,  a.EXRE_RTRN_QTY                                                         as AFI_EXRE_RTRN_QTY_STR
				,  to_char(decode(a.MDPR_CLSF_CD, '2', a.NRDR_PRTX_PRIN_NTM
												, '3', a.NRDR_RTRN_PRTX_PRIN_NTM))         as AFI_NRDR_PRTX_PRIN_NTM_STR                  /* (약) 마약처방전출력횟수 */
				, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = e.ARVL_DPRT_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD
				, ( select  ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.WARD_CD group by ABRV_DPRT_CD ) as ABRV_DPRT_CD1
				, to_char(e.CARE_PRIN_DT, 'yyyymmddhh24miss') as CARE_PRIN_DT
				, (select x.USER_NM
					 from ccuseramt x
					where x.lgin_id = e.CARE_PNPR_ID
					  and rownum = 1) as USER_NM
			    , e.MDTN_NO as MDTN_NO
			    , e.ORDR_SNO as ORDR_SNO
			 from
				   SDJREQADT d              /*  부서약품청구보조관리(부서별 청구가능 약품별 수량을 미리 정해둔 엔터티) */
				,  MDORDRCMT c              /*  처방코드기본 */
				,  MDMEDORDT a              /*  약처방 */
				,  SDJDGRTNT e              /*  처방성약품반납관리 */
				,  SDPORDDET g              /*  처방조제상세 */
			where
				   e.PTNO                      = a.PTNO                                                  /*  환자번호             */
			  and  e.ORDR_YMD                  = a.ORDR_YMD                                              /*  처방일자             */
			  and  e.ORDR_SNO                  = a.ORDR_SNO                                              /*  처방순번             */
			  and  e.MDTN_LCDV_CD              = a.MDTN_LCDV_CD                                          /*  투약위치             */
			  and  nvl(e.ARVL_DPRT_CD, 'ZZ')   = nvl(#{wardCd}, nvl(e.ARVL_DPRT_CD, 'ZZ'))                /*  발생처(도착지-약국)  */
			  and  e.ORDR_YMD between to_date(#{inqrStrtYmd}, 'yyyymmdd') and to_date(#{inqrFnshYmd},'yyyymmdd')
			  and  e.PTNO                      = nvl(#{ptno}, e.PTNO)
			  /* - */
			  and  e.DRUG_RTRE_CD              = '6'
			  and  e.MDPR_CD                   = c.ORDR_CD                                               /*  처방코드             */
			  and  nvl(e.TEAM_CD, 'Z')         = decode(#{teamCd}, '*', nvl(e.TEAM_CD, 'Z'), #{teamCd})
			  and  e.ARVL_DPRT_CD              = d.DPRT_CD(+)
			  and  e.MDPR_CD                   = d.MDPR_CD(+)
			  and  nvl(e.STDL_DETL_DVSN_CD, 'Z')   <> 'T'                                                      /*  입출고상세구분코드 (SD010) TPN 반납약 제외  */
			  /* - */
			  and  (
					(
					  (#{dvsnVl1} = 'D')
					  and
					  (a.MDPR_CLSF_CD  in  ('2', '3'))
					 )
					 or
					 (
					  (#{dvsnVl1} != 'D')
					  and
					  (a.MDPR_CLSF_CD  = #{dvsnVl1})
					 )
					)
			  and  a.DRAP_DVSN_CD = '2'
			  /* - */
			  and  g.ORDR_YMD              (+)= a.ORDR_YMD                    /*  처방일자             */
			  and  g.MDTN_NO_DVSN_CD       (+)= a.MDTN_NO_DVSN_CD                  /*  투약번호구분         */
			  and  g.MDTN_NO               (+)= a.MDTN_NO                        /*  투약번호             */
			  and  g.ORDR_SNO              (+)= a.ORDR_SNO                  /*  처방순번             */
			  and  g.MDTN_LCDV_CD          (+)= a.MDTN_LCDV_CD                /*  투약위치             */
			  and  not exists (
							   select  1
								 from  SDJDGRTNT f
								where  f.PTNO           =  a.PTNO
								  and  f.ORDR_YMD       =  a.ORDR_YMD
								  and  f.ORDR_SNO       =  a.ORDR_SNO
								  and  f.MDTN_LCDV_CD   =  a.MDTN_LCDV_CD                /*  투약위치             */
								  and  f.DRUG_RTRE_CD   <>  '6'
								)
			  and  ((#{dprtCd} = 'W') or
					((#{dprtCd} = 'DSC'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411|MDP_412|MDP_413|MDP_414|MDP_415|MDP_416') = 'Y') or       /*  DSC                */
					 (#{dprtCd} = 'DF'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411') = 'Y') or        /*  DSC                */
					 (#{dprtCd} = 'DG'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_412|MDP_415') = 'Y') or       /*  DSC                */
					 (#{dprtCd} = 'DH'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_413') = 'Y') or       /*  DSC                */
					 (#{dprtCd} = 'DI'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_414') = 'Y') or       /*  DSC                */
					 (#{dprtCd} = 'DK'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_416') = 'Y') or        /*  DSC                */
					 (#{dprtCd} = '01H'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419|MDP_436') = 'Y') or        /*  투석실(혈액)       */
					 (#{dprtCd} = 'ETC'
						  and  a.OROC_DPRT_CD = #{dprtCd1}                        ) or        /*  기타장소(ORDACPPL) */
					 (#{dprtCd} = 'OP3'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_421') = 'Y') or        /*  MOR-수술실         */
					 (#{dprtCd} = 'OP'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_420') = 'Y') or        /*  MOR-회복실         */
					 (#{dprtCd} = 'OP2'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_407') = 'Y') or        /*  MOR-준비실         */
					 (#{dprtCd} = 'OP4'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_422') = 'Y') or        /*  PMC-DSC통증관리실  */
					 (#{dprtCd} = 'OP5'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_443') = 'Y') or        /*  마취실(COR)        */
					 (#{dprtCd} = 'OP6'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_439') = 'Y') or        /*  수술실(COR)        */
					 (#{dprtCd} = 'OP7'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_437') = 'Y') or        /*  회복실(COR)        */
					 (#{dprtCd} = 'OP8'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_446') = 'Y') or        /*  기관지내시경실      */
					 (#{dprtCd} = 'BR'
						  and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD, 'Z') =  'BR')) or   /*  영상의학과 */
					 (#{dprtCd} = 'WARD2'
						  and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y'))                      /*  병동-분만  */
				   )
			   order
				  by  MDPR_CLSF_CD desc
				   ,  PTNO
				   ,  ORDR_YMD
				   ,  AFI_ORDR_SNO_STR
				   ,  RTRN_RQST_DT
			]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-insertAtmtCupQtyRtrnCrtn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<insert id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-insertAtmtCupQtyRtrnCrtn"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
			<![CDATA[
			   INSERT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-insertAtmtCupQtyRtrnCrtn  sdd_mnjdgrt_i99$I01_자동잔량반납생성DAM */
			 into  SDJDGRTNT
				   (
				   ORDR_YMD
				,  MDTN_LCDV_CD
				,  MDTN_NO_DVSN_CD
				,  MDTN_NO
				,  ORDR_SNO
				,  RTRN_RQST_YMD
				,  RTRN_RQST_DT
				,  PTNO
				,  PTDV_CD
				,  ARVL_DPRT_CD
				,  PTRM_NO
				,  SCKB_NO
				,  RTRN_DETL_DVSN_CD
				,  DRUG_RTRE_CD
				,  MDPR_CD
				,  CARE_ITDV_CD
				,  SHDT_CD
				,  TEAM_CD
				,  PTAD_RTRN_QTY
				,  RTRN_RQST_CQY
				,  RTRN_RQPR_ID
				,  RTRN_RQST_IP
				,  MDPR_RTRN_NTM
				,  STDL_DVSN_CD
				,  RTRN_DVSN_CD
				,  STDL_DETL_DVSN_CD
				,  DSCH_ATMT_RTRN_YN
				,  FRNS_RTRN_CQY
				,  FRST_RGSR_ID
				,  FRST_RGST_IP
				,  FRST_RGST_DT
				,  FRST_RGST_CLNT_PRGM_ID
				,  FRST_RGST_SRVR_PRGM_ID
				,  LAST_UPDR_ID
				,  LAST_UPDT_IP
				,  LAST_UPDT_DT
				,  LAST_UPDT_CLNT_PRGM_ID
				,  LAST_UPDT_SRVR_PRGM_ID
				   )
			 select /*+ index(a MDMEDORDT_I19) */  /*  병동 */
				   a.ORDR_YMD
				,  a.MDTN_LCDV_CD
				,  a.MDTN_NO_DVSN_CD
				,  a.MDTN_NO
				,  a.ORDR_SNO
				,  trunc(b.acim_dt) as RTRN_RQST_YMD
				,  b.acim_dt as RTRN_RQST_DT
				,  a.PTNO
				,  c.PTDV_CD
				,  c.INJC_PLAC_CD as ARVL_DPRT_CD
				,  (select y.care_ptrm_no
					  from APRCRPTNT y
					 where y.mdrp_no = a.mdrp_no) as PTRM_NO
				,  (select y.care_sckb_no
					  from APRCRPTNT y
					 where y.mdrp_no = a.mdrp_no) as SCKB_NO
				,  'Z' as RTRN_DETL_DVSN_CD
				,  '6' as DRUG_RTRE_CD
				,  c.MDPR_CD
				,  'R' as CARE_ITDV_CD
				,  null SHDT_CD
				,  (select DAY_SCKB_TEAM_CD
					  from MNWBTEAMT x
						 , APRCRPTNT y
					 where x.WARD_CD = y.care_ward_cd
					   and  x.PTRM_NO = y.care_ptrm_no
					   and  x.SCKB_NO = y.care_sckb_no
					   and y.mdrp_no = a.mdrp_no) as TEAM_CD
				,  decode(A.SLCT_UNIT_DVSN_CD, '2',
														(FN_SD_TOTIVQTY_S(
																				a.pckn_unad_qty    /* 포장단위투여량스트링*/
																			  , a.ntm              /* 횟수*/
																			  , a.ddcn
																			  , d.totl_qty_clcl_cd
																			  , a.drap_dvsn_cd
																			  , a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
													  , (FN_SD_TOTIVQTY_S(
															  a.pckn_unad_qty    /* 포장단위투여량스트링*/
															, a.ntm              /* 횟수*/
															, a.ddcn
															, d.totl_qty_clcl_cd
															, a.drap_dvsn_cd
															, a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.pckn_unad_qty*a.NTM*d.PCUN_INLS_QTY) as PTAD_RTRN_QTY
				,  decode(A.SLCT_UNIT_DVSN_CD, '2',
														(FN_SD_TOTIVQTY_S(
																				a.pckn_unad_qty    /* 포장단위투여량스트링*/
																			  , a.ntm              /* 횟수*/
																			  , a.ddcn
																			  , d.totl_qty_clcl_cd
																			  , a.drap_dvsn_cd
																			  , a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
													  , (FN_SD_TOTIVQTY_S(
															  a.pckn_unad_qty    /* 포장단위투여량스트링*/
															, a.ntm              /* 횟수*/
															, a.ddcn
															, d.totl_qty_clcl_cd
															, a.drap_dvsn_cd
															, a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.pckn_unad_qty*a.NTM*d.PCUN_INLS_QTY) as RTRN_RQST_CQY
				,  b.ACTN_IMPT_ID as RTRN_RQPR_ID
				,  #{gvUserIp} as RTRN_RQST_IP
				,  0 as MDPR_RTRN_NTM
				,  'B' as STDL_DVSN_CD
				,  'N' as RTRN_DVSN_CD
				,  case when a.codv_cd = 'O' then 'C'
						when a.codv_cd = 'I' then 'E'
						when a.codv_cd = 'E' then 'G'
						when a.codv_cd = 'D' then 'I'
						when a.codv_cd = 'H' then 'C'
					end as STDL_DETL_DVSN_CD
				,  null DSCH_ATMT_RTRN_YN
				,  null FRNS_RTRN_CQY
				,  #{gvUserId}
				,  #{gvUserIp}
				,  SYSDATE
				,  #{gvClntPrgmId}
				,  #{gvSrvrPrgmId}
				,  #{gvUserId}
				,  #{gvUserIp}
				,  SYSDATE
				,  #{gvClntPrgmId}
				,  #{gvSrvrPrgmId}
			 from mnwadacnt b
				, mdmedordt a
				, SDPORDDET c
				, mdordrcmt d
			where #{dcDvsnCd} <> 'O'
			  and b.ACIM_DT between to_date(#{ordrYmd}||'000000', 'yyyymmddhh24miss') and to_date(#{ordrYmd}||'235959', 'yyyymmddhh24miss')
			  and b.actn_kind_cd is not null
			  and b.ward_drug_ijac_rno = 1
			  and b.ptno = a.ptno
			  and b.ordr_ymd = a.ordr_ymd
			  and b.ordr_sno = a.ordr_sno
			  and a.frns_dprt_cd = #{arvlDprtCd}
			  and a.dc_dvsn_cd not in ('X', 'P', 'E', 'F')
			  and a.orfr_cd <> 'P'
			  and a.mdpr_clsf_cd in ('2', '3')
			  and a.ordr_clty_cd = 'B1'
			  and a.codv_cd in ('I', 'E')
			  and ceil(a.pckn_unad_qty * a.ntm) - (a.pckn_unad_qty * a.ntm) <> 0
			  and c.ptno = a.ptno
			  and c.ordr_ymd = a.ordr_ymd
			  and c.ordr_sno = a.ordr_sno
			  and not exists (select 'Y'
								from SDJDGRTNT x
							   where x.ptno = a.ptno
								 and x.ordr_ymd = a.ordr_ymd
								 and x.ordr_sno = a.ordr_sno
								 and x.rtrn_detl_dvsn_cd = 'Z'
								 and x.drug_rtre_cd = '6'
								 /*  and x.rtrn_rqst_cqy <> 0  -- 폐기있으면 insert 하지 않도록...폐기한줄, 잔량한줄 생성되면 반납리스트에서 각각 조회됨.*/
								 )
			  and a.ordr_cd = d.ordr_cd
		   union all
			select /*+ index(a MDMEDORDT_I19) */   /*  응급실 */
				   a1.ORDR_YMD
				,  a1.MDTN_LCDV_CD
				,  a1.MDTN_NO_DVSN_CD
				,  a1.MDTN_NO
				,  a1.ORDR_SNO
				,  trunc(b.acim_dt) as RTRN_RQST_YMD
				,  b.acim_dt as RTRN_RQST_DT
				,  a.PTNO
				,  c.PTDV_CD
				,  c.INJC_PLAC_CD as ARVL_DPRT_CD
				,  (select y.care_ptrm_no
					  from APRCRPTNT y
					 where y.mdrp_no = a.mdrp_no) as PTRM_NO
				,  (select y.care_sckb_no
					  from APRCRPTNT y
					 where y.mdrp_no = a.mdrp_no) as SCKB_NO
				,  'Z' as RTRN_DETL_DVSN_CD
				,  '6' as DRUG_RTRE_CD
				,  c.MDPR_CD
				,  'R' as CARE_ITDV_CD
				,  null SHDT_CD
				,  (select DAY_SCKB_TEAM_CD
					  from MNWBTEAMT x
						 , APRCRPTNT y
					 where x.WARD_CD = y.care_ward_cd
					   and  x.PTRM_NO = y.care_ptrm_no
					   and  x.SCKB_NO = y.care_sckb_no
					   and y.mdrp_no = a.mdrp_no) as TEAM_CD
				,  decode(A.SLCT_UNIT_DVSN_CD, '2',
														(FN_SD_TOTIVQTY_S(
																				a1.pckn_unad_qty    /* 포장단위투여량스트링*/
																			  , a1.ntm              /* 횟수*/
																			  , a1.ddcn
																			  , d.totl_qty_clcl_cd
																			  , a1.drap_dvsn_cd
																			  , a1.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a1.ICUN_ADMN_VLM*a1.NTM
													  , (FN_SD_TOTIVQTY_S(
															  a1.pckn_unad_qty    /* 포장단위투여량스트링*/
															, a1.ntm              /* 횟수*/
															, a1.ddcn
															, d.totl_qty_clcl_cd
															, a1.drap_dvsn_cd
															, a1.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a1.pckn_unad_qty*a1.NTM*d.PCUN_INLS_QTY) as PTAD_RTRN_QTY
				,  decode(A.SLCT_UNIT_DVSN_CD, '2',
														(FN_SD_TOTIVQTY_S(
																				a1.pckn_unad_qty    /* 포장단위투여량스트링*/
																			  , a1.ntm              /* 횟수*/
																			  , a1.ddcn
																			  , d.totl_qty_clcl_cd
																			  , a1.drap_dvsn_cd
																			  , a1.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a1.ICUN_ADMN_VLM*a1.NTM
													  , (FN_SD_TOTIVQTY_S(
															  a1.pckn_unad_qty    /* 포장단위투여량스트링*/
															, a1.ntm              /* 횟수*/
															, a1.ddcn
															, d.totl_qty_clcl_cd
															, a1.drap_dvsn_cd
															, a1.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a1.pckn_unad_qty*a1.NTM*d.PCUN_INLS_QTY) as RTRN_RQST_CQY
				,  b.ACTN_IMPT_ID as RTRN_RQPR_ID
				,  #{gvUserIp} as RTRN_RQST_IP
				,  0 as MDPR_RTRN_NTM
				,  'B' as STDL_DVSN_CD
				,  'N' as RTRN_DVSN_CD
				,  case when a1.codv_cd = 'O' then 'C'
						when a1.codv_cd = 'I' then 'E'
						when a1.codv_cd = 'E' then 'G'
						when a1.codv_cd = 'D' then 'I'
						when a1.codv_cd = 'H' then 'C'
					end as STDL_DETL_DVSN_CD
				,  null DSCH_ATMT_RTRN_YN
				,  null FRNS_RTRN_CQY
				,  #{gvUserId}
				,  #{gvUserIp}
				,  SYSDATE
				,  #{gvClntPrgmId}
				,  #{gvSrvrPrgmId}
				,  #{gvUserId}
				,  #{gvUserIp}
				,  SYSDATE
				,  #{gvClntPrgmId}
				,  #{gvSrvrPrgmId}
			 from mnwadacnt b
				, mdmedordt a   /*  1차처방 */
				, mdmedordt a1  /*  실처방 */
				, SDPORDDET c
				, mdordrcmt d
			where #{dcDvsnCd} <> 'O'
			  and b.ACIM_DT between to_date(#{ordrYmd}||'000000', 'yyyymmddhh24miss') and to_date(#{ordrYmd}||'235959', 'yyyymmddhh24miss')
			  and b.actn_kind_cd is not null
			  and b.ward_drug_ijac_rno = 1
			  and b.ptno = a.ptno
			  and b.ordr_ymd = a.ordr_ymd
			  and b.ordr_sno = a.ordr_sno
			  and a1.ptno = a.ptno
			  and a1.orgl_ordr_ymd = a.ordr_ymd
			  and a1.orgl_ordr_sno = a.ordr_sno
			  and a.frns_dprt_cd = #{arvlDprtCd}
			  and a.dc_dvsn_cd not in ('X', 'P', 'E', 'F')
			  and a.orfr_cd <> 'P'
			  and a.mdpr_clsf_cd in ('2', '3')
			  and a.ordr_clty_cd = 'B1'
			  and a.codv_cd = 'E'
			  and ceil(a1.pckn_unad_qty * a1.ntm) - (a1.pckn_unad_qty * a1.ntm) <> 0
			  and c.ptno = a1.ptno
			  and c.ordr_ymd = a1.ordr_ymd
			  and c.ordr_sno = a1.ordr_sno
			  and not exists (select 'Y'
								from SDJDGRTNT x
							   where x.ptno = a1.ptno
								 and x.ordr_ymd = a1.ordr_ymd
								 and x.ordr_sno = a1.ordr_sno
								 and x.rtrn_detl_dvsn_cd = 'Z'
								 and x.drug_rtre_cd = '6'
								 /*  and x.rtrn_rqst_cqy <> 0  -- 폐기있으면 insert 하지 않도록...폐기한줄, 잔량한줄 생성되면 반납리스트에서 각각 조회됨.*/
								 )
			  and a1.ordr_cd = d.ordr_cd
		   union all
			select /*+ index(b MNIOUTCNT_I02) */   /*  외래처방 */
				   a.ORDR_YMD
				,  a.MDTN_LCDV_CD
				,  a.MDTN_NO_DVSN_CD
				,  a.MDTN_NO
				,  a.ORDR_SNO
				,  trunc(b.IJAC_DT) as RTRN_RQST_YMD
				,  b.IJAC_DT as RTRN_RQST_DT
				,  a.PTNO
				,  c.PTDV_CD
				,  c.INJC_PLAC_CD as ARVL_DPRT_CD
				,  (select y.care_ptrm_no
					  from APRCRPTNT y
					 where y.mdrp_no = a.mdrp_no) as PTRM_NO
				,  (select y.care_sckb_no
					  from APRCRPTNT y
					 where y.mdrp_no = a.mdrp_no) as SCKB_NO
				,  'Z' as RTRN_DETL_DVSN_CD
				,  '6' as DRUG_RTRE_CD
				,  c.MDPR_CD
				,  'R' as CARE_ITDV_CD
				,  null SHDT_CD
				,  (select DAY_SCKB_TEAM_CD
					  from MNWBTEAMT x
						 , APRCRPTNT y
					 where x.WARD_CD = y.care_ward_cd
					   and  x.PTRM_NO = y.care_ptrm_no
					   and  x.SCKB_NO = y.care_sckb_no
					   and y.mdrp_no = a.mdrp_no) as TEAM_CD
				,  decode(A.SLCT_UNIT_DVSN_CD, '2',
														(FN_SD_TOTIVQTY_S(
																				a.pckn_unad_qty    /* 포장단위투여량스트링*/
																			  , a.ntm              /* 횟수*/
																			  , a.ddcn
																			  , d.totl_qty_clcl_cd
																			  , a.drap_dvsn_cd
																			  , a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
													  , (FN_SD_TOTIVQTY_S(
															  a.pckn_unad_qty    /* 포장단위투여량스트링*/
															, a.ntm              /* 횟수*/
															, a.ddcn
															, d.totl_qty_clcl_cd
															, a.drap_dvsn_cd
															, a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.pckn_unad_qty*a.NTM*d.PCUN_INLS_QTY) as PTAD_RTRN_QTY
				,  decode(A.SLCT_UNIT_DVSN_CD, '2',
														(FN_SD_TOTIVQTY_S(
																				a.pckn_unad_qty    /* 포장단위투여량스트링*/
																			  , a.ntm              /* 횟수*/
																			  , a.ddcn
																			  , d.totl_qty_clcl_cd
																			  , a.drap_dvsn_cd
																			  , a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
													  , (FN_SD_TOTIVQTY_S(
															  a.pckn_unad_qty    /* 포장단위투여량스트링*/
															, a.ntm              /* 횟수*/
															, a.ddcn
															, d.totl_qty_clcl_cd
															, a.drap_dvsn_cd
															, a.drug_ordr_prss_cd))*d.PCUN_INLS_QTY-a.pckn_unad_qty*a.NTM*d.PCUN_INLS_QTY) as RTRN_RQST_CQY
				,  b.IJAC_INPR_ID as RTRN_RQPR_ID
				,  #{gvUserIp} as  RTRN_RQST_IP
				,  0 as MDPR_RTRN_NTM
				,  'B' as STDL_DVSN_CD
				,  'N' as RTRN_DVSN_CD
				,  case when a.codv_cd = 'O' then 'C'
						when a.codv_cd = 'I' then 'E'
						when a.codv_cd = 'E' then 'G'
						when a.codv_cd = 'D' then 'I'
						when a.codv_cd = 'H' then 'C'
					end as STDL_DETL_DVSN_CD
				,  null DSCH_ATMT_RTRN_YN
				,  null FRNS_RTRN_CQY
				,  #{gvUserId}
				,  #{gvUserIp}
				,  SYSDATE
				,  #{gvClntPrgmId}
				,  #{gvSrvrPrgmId}
				,  #{gvUserId}
				,  #{gvUserIp}
				,  SYSDATE
				,  #{gvClntPrgmId}
				,  #{gvSrvrPrgmId}
			 from mnioutcnt b
				, mdmedordt a
				, SDPORDDET c
				, mdordrcmt d
			where #{dcDvsnCd} = 'O'
			  and b.IJAC_DT between to_date(#{ordrYmd}||'000000', 'yyyymmddhh24miss') and to_date(#{ordrYmd}||'235959', 'yyyymmddhh24miss')
			  and b.actn_kind_cd is not null
			  and b.ijac_rno = 1
			  and b.ptno = a.ptno
			  and b.ordr_ymd = a.ordr_ymd
			  and b.ordr_sno = a.ordr_sno
			  and a.mcdp_cd = #{arvlDprtCd}
			  and a.dc_dvsn_cd not in ('X', 'P', 'E', 'F')
			  and a.orfr_cd <> 'P'
			  and a.mdpr_clsf_cd in ('2', '3')
			  and a.ordr_clty_cd = 'B1'
			  and a.codv_cd in ('O', 'H')
			  and ceil(a.pckn_unad_qty * a.ntm) - (a.pckn_unad_qty * a.ntm) <> 0
			  and c.ptno = a.ptno
			  and c.ordr_ymd = a.ordr_ymd
			  and c.ordr_sno = a.ordr_sno
			  and not exists (select 'Y'
								from SDJDGRTNT x
							   where x.ptno = a.ptno
								 and x.ordr_ymd = a.ordr_ymd
								 and x.ordr_sno = a.ordr_sno
								 and x.rtrn_detl_dvsn_cd = 'Z'
								 and x.drug_rtre_cd = '6'
								 /*  and x.rtrn_rqst_cqy <> 0  -- 폐기있으면 insert 하지 않도록...폐기한줄, 잔량한줄 생성되면 반납리스트에서 각각 조회됨.*/
								 )
			  and a.ordr_cd = d.ordr_cd
				]]>
	</insert>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOprtDrrtInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
		<result property="afiAdmnVlmStr" column="AFI_ADMN_VLM_STR"/>
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="afiRtrnCqyStr4" column="AFI_RTRN_CQY_STR_4"/>
		<result property="afiRtrnCqyStr3" column="AFI_RTRN_CQY_STR_3"/>
		<result property="afiTotlQtyStr1" column="AFI_TOTL_QTY_STR_1"/>
		<result property="afiTotlQtyStr2" column="AFI_TOTL_QTY_STR_2"/>
		<result property="rtrnExreCtn" column="RTRN_EXRE_CTN"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="afiTotlQtyStr" column="AFI_TOTL_QTY_STR"/>
		<result property="afiTotlQtyStr3" column="AFI_TOTL_QTY_STR_3"/>
		<result property="afiNrdrPrtxPrinNtmStr" column="AFI_NRDR_PRTX_PRIN_NTM_STR"/>
		<result property="afiRtrnCqyStr1" column="AFI_RTRN_CQY_STR_1"/>
		<result property="afiRtrnCqyStr" column="AFI_RTRN_CQY_STR"/>
		<result property="afiPcunInlsQtyStr" column="AFI_PCUN_INLS_QTY_STR"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="afiAbrvDprtNm1" column="AFI_ABRV_DPRT_NM_1"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOprtDrrtInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOprtDrrtInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOprtDrrtInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOprtDrrtInqr-result" useCache="true" flushCache="false">
			<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOprtDrrtInqr  mnd_jdgrtnt_l05$S01_약반납내역 조회 반납일자기준DAM */
					   z.ORDR_YMD as ORDR_YMD                                                                  /*  처방일자   */
					,  z.OPRM_CD as OPRM_CD
					,  z.PTNO as PTNO
					,  z.PTNM as PTNT_NM
					,  z.MDPR_CD as MDPR_CD
					,  z.ORDR_NM as ORDR_NM
					,  z.AFI_NTM_STR as AFI_NTM_STR                                                               /*  처방횟수  */
					,  case when ( z.AFI_ADMN_VLM_STR > 0 and z.AFI_ADMN_VLM_STR < 1 )then to_char(z.AFI_ADMN_VLM_STR, 'FM9990.099')  /* 함량단위투여용량/포장단위투여량 + 함량단위코드/포장단위코드  */
							else to_char(z.AFI_ADMN_VLM_STR)
							end || z.AFI_ADMN_VLM_STR_CD as AFI_ADMN_VLM_STR      /*  처방 1회량  -- 약처방TB */
					,  z.AFI_RTRN_NTM_STR as AFI_RTRN_NTM_STR                                                         /*  약품반납횟수 -- 약국TB  */
					,  case when ( z.AFI_RTRN_CQY_STR_4 > 0 and z.AFI_RTRN_CQY_STR_4 < 1 )then to_char(z.AFI_RTRN_CQY_STR_4, 'FM9990.099')  /* 함량단위투여용량/포장단위투여량 + 함량단위코드/포장단위코드  */
									 else to_char(z.AFI_RTRN_CQY_STR_4)
									 end as AFI_RTRN_CQY_STR_4                                   /*  약국반납량   -- 약처방TB*/
					,  case when ( z.AFI_RTRN_CQY_STR_3 > 0 and z.AFI_RTRN_CQY_STR_3 < 1 ) then to_char(z.AFI_RTRN_CQY_STR_3, 'FM9990.099')
							else to_char(z.AFI_RTRN_CQY_STR_3)
							end || z.ICUN_CD as AFI_RTRN_CQY_STR_3  /*  잔량 + 함량코드 */
					,  case when ( z.AFI_TOTL_QTY_STR_1 > 0 and z.AFI_TOTL_QTY_STR_1 < 1 ) then to_char(z.AFI_TOTL_QTY_STR_1, 'FM9990.099')
							else to_char(z.AFI_TOTL_QTY_STR_1)
							end || z.ICUN_CD as AFI_TOTL_QTY_STR_1 /*  총반납량 */
					/* ,  to_char(decode(nvl(z.AFI_RTRN_CQY_STR_1, 0), 0, (to_char(z.INVN_TOTL_QTY, 0)), (z.AFI_TOTL_QTY-z.AFI_RTRN_CQY_STR_1)/z.PCUN_INLS_QTY), 'FM9990.099') as AFI_TOTL_QTY_STR_2 /*  사용량 * (20160618)/ */
					,  z.AFI_TOTL_QTY_STR_2 as AFI_TOTL_QTY_STR_2 /*  사용량 (201606201 - 결함이라고 올라와서 다시 걍 총량보여주는거로 바꿈)*/
					,  z.RTRN_EXRE_CTN as RTRN_EXRE_CTN      /* 반납예외사유내용*/
					,  z.MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD    /*  투약번호구분코드 */
					,  z.AFI_MDTN_NO_STR as AFI_MDTN_NO_STR    /*  투약번호         */
					,  z.MDTN_LCDV_CD as MDTN_LCDV_CD       /*  투약위치구분코드 */
					,  z.AFI_ORDR_SNO_STR as AFI_ORDR_SNO_STR   /*  투약순번         */
					,  z.ODKI_CD as ODKI_CD            /*  처방종류코드     */
					,  z.AFI_TOTL_QTY_STR as AFI_TOTL_QTY_STR   /*  재고총량         */
					,  case when ( z.AFI_RTRN_CQY_STR_3 > 0 and z.AFI_RTRN_CQY_STR_3 < 1 ) then to_char(z.AFI_RTRN_CQY_STR_3, 'FM9990.099')
							else to_char(z.AFI_RTRN_CQY_STR_3)
							end as AFI_TOTL_QTY_STR_3   /*  잔량 */
					,  z.AFI_NRDR_PRTX_PRIN_NTM_STR as AFI_NRDR_PRTX_PRIN_NTM_STR   /*  마약/향정 출력건수 */
					,  z.AFI_RTRN_CQY_STR_1 as AFI_RTRN_CQY_STR_1           /*   반납량(함량)   */
					,  z.AFI_RTRN_CQY_STR as AFI_RTRN_CQY_STR             /*  반납요청수량    */
					,  z.AFI_PCUN_INLS_QTY_STR as AFI_PCUN_INLS_QTY_STR        /*  포장단위포함량  */
					,  z.PCUN_CD as PCUN_CD                      /*  포장단위코드    */
					,  z.ICUN_CD as ICUN_CD
					,  z.DRUG_RTRE_CD as DRUG_RTRE_CD                 /*  약반납사유코드  */
					, ( select A.DETL_CD_NM
						from CCCMCDDMT A
						where A.COMN_GRP_CD  = 'SD068'
						  and A.COMN_DTLS_CD = z.DRUG_RTRE_CD) as CD_NM                        /*  약반납사유명   */
					,  z.ABRV_DPRT_NM1 as AFI_ABRV_DPRT_NM_1
				 from  (
					   select
							   to_char(a.ORDR_YMD, 'yyyymmdd')                 as ORDR_YMD      /*  처방일자   */
							,  d.OPRM_CD                                       as OPRM_CD       /*  수술실코드 */
							,  a.PTNO                                          as PTNO          /*  환자번호   */
							,  f.PTNT_NM                                       as PTNM          /*  환자명     */
							,  a.ORDR_CD                                       as MDPR_CD       /*  처방코드   */
							,  b.ORDR_NM                                       as ORDR_NM       /*  처방명     */
							,  to_char(decode(a.NTM, null, 1, 0, 1, a.NTM))    as AFI_NTM_STR   /*  횟수       */
							,  a.ORDR_SNO
							,  decode(a.SLCT_UNIT_DVSN_CD, '2', a.ICUN_ADMN_VLM, a.PCKN_UNAD_QTY) AFI_ADMN_VLM_STR  /* 선택단위구분코드 '2'/'' - 함량단위투여용량/포장단위투여량 + 함량단위코드/포장단위코드  */
							,  decode(a.SLCT_UNIT_DVSN_CD, '2', a.ICUN_CD, a.PCUN_CD) AFI_ADMN_VLM_STR_CD
							,
							  (
							  select  to_char(sum(nvl(MDPR_RTRN_NTM, 1)))
								from  SDJDGRTNT z   /*  처방성약품반납관리 */
							   where  z.ORDR_YMD        = g.ORDR_YMD
								 and  z.MDTN_NO_DVSN_CD = g.MDTN_NO_DVSN_CD
								 and  z.MDTN_NO         = g.MDTN_NO
								 and  z.MDTN_LCDV_CD    = g.MDTN_LCDV_CD
								 and  z.ORDR_SNO        = g.ORDR_SNO
								 and  z.MDPR_CD         = g.MDPR_CD
							   )                                           as AFI_RTRN_NTM_STR     /*  약품반납횟수 */
							/* - */
							,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', nvl(i.MDPR_RTRN_NTM, h.MDPR_RTRN_NTM)*b.PCUN_INLS_QTY*a.PCKN_UNAD_QTY,
																   '2', nvl(i.MDPR_RTRN_NTM, h.MDPR_RTRN_NTM)*a.ICUN_ADMN_VLM))   AFI_RTRN_CQY_STR_4
							/* ,  decode(a.PHRM_RTRN_QTY, '0', '', a.PHRM_RTRN_QTY)  AFI_RTRN_CQY_STR_4   /*  약국반납량  (0617)*/
							/* - */
							,  decode(a.SLCT_UNIT_DVSN_CD, '2', g.INVN_TOTL_QTY*b.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM   /*  선택단위구분코드가 '2' 재고총량*포장단위포함량 - 함량단위투여용량*횟수 */
															  , g.INVN_TOTL_QTY*b.PCUN_INLS_QTY-a.PCKN_UNAD_QTY*a.NTM*b.PCUN_INLS_QTY) as AFI_RTRN_CQY_STR_3
							,  a.ICUN_CD                       as ICUN_CD                       /* 잔량+합량코드 */
							/* - */
							,  decode(a.SLCT_UNIT_DVSN_CD, '2', g.INVN_TOTL_QTY*b.PCUN_INLS_QTY-a.ICUN_ADMN_VLM*a.NTM
															  , g.INVN_TOTL_QTY*b.PCUN_INLS_QTY-a.PCKN_UNAD_QTY*a.NTM*b.PCUN_INLS_QTY)+nvl(a.PHRM_RTRN_QTY, 0) as AFI_TOTL_QTY_STR_1 /*  총반납량 */
							/* ,  decode(nvl(h.RTRN_RQST_CQY, 0), 0, to_char(g.INVN_TOTL_QTY)||a.PCUN_CD, to_char(g.INVN_TOTL_QTY)||'('||to_char(g.INVN_TOTL_QTY-nvl(h.RTRN_RQST_CQY, 0))||')'||a.PCUN_CD) */
							,  to_char(g.INVN_TOTL_QTY)   as  AFI_TOTL_QTY_STR_2
							,  decode(a.RTRN_EXRE_CTN, null , null
													 , a.EXRE_RTRN_QTY||'cc'   /* decode(a.RTRN_EXRE_CTN, '01', 'cc - Mix(cc)', '02', 'mg - 폐기', '03', 'mg - 1A초과잔량') */
									  )    as RTRN_EXRE_CTN    /* 반납예외사유내용*/
							,  g.MDTN_NO_DVSN_CD                       as MDTN_NO_DVSN_CD    /*  투약번호구분코드 */
							,  to_char(g.MDTN_NO)                      as AFI_MDTN_NO_STR    /*  투약번호         */
							,  g.MDTN_LCDV_CD                          as MDTN_LCDV_CD       /*  투약위치구분코드 */
							,  to_char(a.ORDR_SNO)                     as AFI_ORDR_SNO_STR   /*  투약순번         */
							,  a.ODKI_CD                               as ODKI_CD            /*  처방종류코드     */
							,  g.INVN_TOTL_QTY                         as AFI_TOTL_QTY_STR   /*  재고총량         */  /* g.INVN_TOTL_QTY(0617)*/
							,   g.INVN_TOTL_QTY*b.PCUN_INLS_QTY        as AFI_TOTL_QTY       /*  재고총량 * 함량코드 */
							,  to_char(decode(a.MDPR_CLSF_CD, '2', a.NRDR_PRTX_PRIN_NTM
															, '3', a.NRDR_RTRN_PRTX_PRIN_NTM))   as AFI_NRDR_PRTX_PRIN_NTM_STR  /* (약) 마약처방전출력횟수 */
							,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', nvl(i.MDPR_RTRN_NTM, 1)*b.PCUN_INLS_QTY*a.PCKN_UNAD_QTY
																 , '2', nvl(i.MDPR_RTRN_NTM, 1)*a.ICUN_ADMN_VLM)) as AFI_RTRN_CQY_STR_1
							,  to_char(i.RTRN_RQST_CQY)        as AFI_RTRN_CQY_STR             /*  반납요청수량    */
							,  to_char(b.PCUN_INLS_QTY)        as AFI_PCUN_INLS_QTY_STR        /*  포장단위포함량  */
							,  a.PCUN_CD                       as PCUN_CD                      /*  포장단위코드    */
							,  nvl(h.DRUG_RTRE_CD, i.DRUG_RTRE_CD)  as DRUG_RTRE_CD
							,  g.INVN_TOTL_QTY                      as INVN_TOTL_QTY
							,  b.PCUN_INLS_QTY                      as PCUN_INLS_QTY
							, ( select  KORN_DPRT_NM from HZDEPTMMT where DPRT_CD = g.INJC_PLAC_CD group by KORN_DPRT_NM ) as ABRV_DPRT_NM1  /*  불출장소 */
						 from
							   (
							   select
									   ORDR_YMD             ORDR_YMD
									,  MDTN_NO_DVSN_CD      MDTN_NO_DVSN_CD
									,  MDTN_NO              MDTN_NO
									,  ORDR_SNO             ORDR_SNO
									,  MDPR_CD              MDPR_CD
									,  MDTN_LCDV_CD         MDTN_LCDV_CD
									,  nvl(DRUG_RTRE_CD, 'P') DRUG_RTRE_CD
									,  sum(MDPR_RTRN_NTM)   MDPR_RTRN_NTM
									,  sum(RTRN_RQST_CQY)   RTRN_RQST_CQY
								 from
									   SDJDGRTNT
								where  ORDR_YMD between to_date(#{inqrStrtYmd}, 'yyyymmdd')
													and to_date(#{inqrFnshYmd}, 'yyyymmdd')
								  and  RTRN_DETL_DVSN_CD = 'B'             /*  반납상세구분코드 - 미수령반납 : B / 그외 : A */								  
								  and  nvl(MDPR_RTRN_NTM, -1) != 0
								group
								   by
									   ORDR_YMD
									,  MDTN_NO_DVSN_CD
									,  MDTN_NO
									,  ORDR_SNO
									,  MDPR_CD
									,  MDTN_LCDV_CD
									,  DRUG_RTRE_CD
								)  h
							,  (
							   select
									   ORDR_YMD                ORDR_YMD
									,  MDTN_NO_DVSN_CD         MDTN_NO_DVSN_CD
									,  MDTN_NO                 MDTN_NO
									,  ORDR_SNO                ORDR_SNO
									,  MDPR_CD                 MDPR_CD
									,  MDTN_LCDV_CD            MDTN_LCDV_CD
									,  nvl(DRUG_RTRE_CD, 'P')  DRUG_RTRE_CD
									,  sum(nvl(MDPR_RTRN_NTM, 1))  MDPR_RTRN_NTM
									,  sum(decode(DRUG_RTRE_CD, '6', nvl(RTRN_RQST_CQY, 0), 0)) RTRN_RQST_CQY
								 from
									   SDJDGRTNT
								where  ORDR_YMD between to_date(#{inqrStrtYmd}, 'yyyymmdd')
													and to_date(#{inqrFnshYmd}, 'yyyymmdd')
								  and  nvl(RTRN_DETL_DVSN_CD, 'X') != 'B'         /*  반납상세구분코드 A:수령반납 B:미수령반납 Z:잔량반납 */
								  and  nvl(MDPR_RTRN_NTM, -1) != 0
								group
								   by
									   ORDR_YMD
									,  MDTN_NO_DVSN_CD
									,  MDTN_NO
									,  ORDR_SNO
									,  MDPR_CD
									,  MDTN_LCDV_CD
									,  DRUG_RTRE_CD
							   )  i
							,  MDMEDORDT a  /*  약처방 */
							,  MDORDRCMT b  /*  처방코드기본 */
							,  MDOPSCHET d  /*  수술스케줄 */
							,  APRCRPTNT e
							,  APPTPTNTT f
							,  SDPORDDET g  /*  처방조제상세 */
						where  a.ORDR_YMD between to_date(#{inqrStrtYmd}, 'yyyymmdd')
											  and to_date(#{inqrFnshYmd}, 'yyyymmdd')
						  and  a.ORDR_CD         = b.ORDR_CD
						  and  a.PTNO            = nvl(#{ptno}, a.PTNO)
		   /*                and  nvl(a.DRUG_RTRE_CD, 'Z') <> '5'                                /*  미수령반납 제외 */
						  and  nvl(a.ORFR_CD, 'A') <> 'P'                                     /*  PRN처방 제외 */
						  and  a.DRAP_DVSN_CD = decode(#{dvsnVl1}, 'Y', '2', a.DRAP_DVSN_CD)   /*  주사약만 조회 */
						   and  (
								  (
										(#{dvsnVl1} <> 'Y')
								   and  (a.MDPR_CLSF_CD not in ('2', '3'))           /* 일반약이고 반납이 있는것들(잔량반납말고) */
								   and  (exists (
												select  'Y'
												  from  SDJDGRTNT z
												 where  z.ORDR_YMD        = g.ORDR_YMD
												   and  z.MDTN_NO_DVSN_CD = g.MDTN_NO_DVSN_CD
												   and  z.MDTN_NO         = g.MDTN_NO
												   and  z.MDTN_LCDV_CD    = g.MDTN_LCDV_CD
												   and  z.ORDR_SNO        = g.ORDR_SNO
												   and  z.MDPR_CD         = g.MDPR_CD
												   and  nvl(z.DRUG_RTRE_CD, 'Z') not in ( '6', '7' )     /*  <> '6'   /* 병동은 미수령안나와서 이렇게 똑같이함 */
												   and  rownum <2)
										 )
								  )
								  or
								  (
								   (#{dvsnVl1} = 'Y')
									and (a.MDPR_CLSF_CD     = #{dvsnVl3})
									and  nvl(a.DRUG_RTRE_CD, 'Z') <> '5'                                /*  미수령반납 제외  nvl(a.DRUG_RTRE_CD, 'Z') <> '5'*/
								  )
								 )
						  and  ((#{dvsnVl2}  = 'C'            /* 'C'는 기본임 */
								and  a.DC_DVSN_CD in ( 'N', 'Y')) or
								(#{dvsnVl2}  = 'D'            /* 미포함시:1/포함시:2  */
								and  nvl(a.PHRM_RTRN_QTY, 0) > 0))
						  /* - */
						  and  nvl(nvl(h.DRUG_RTRE_CD, i.DRUG_RTRE_CD), 'Z') <> 'P'        /* --약국반납은 제외 */
						  /* - */
						  and  d.OPRT_YMD  (+) = a.OPRT_YMD     
						  and  d.PTNO      (+) = a.PTNO         
						  and  d.OPRT_SNO  (+) = a.OPRT_SNO     
						  /* - */
						  and  e.PTNO      (+) = a.PTNO
						  and  e.MDRP_NO   (+) = a.MDRP_NO
						  and  e.CODV_CD   (+) = a.CODV_CD
						  and  e.CNCL_DT   (+) is null
						  /* - */
						  and  (    (#{dprtCd} = 'WARD'
										  and  e.CODV_CD  = 'I')  /*  병동 */
								   or (#{dprtCd} = 'OP4')   /*  DSC통증관리실 -- PMC */
								   or (#{dprtCd} = 'ETC')   /*  기타장소 */
								   or ((
								        #{dprtCd} = 'OP'  or    /*  MOR 회복실 */
										#{dprtCd} = 'OP2' or    /*  MOR 마취준비실 - AN */
										#{dprtCd} = 'OP3' or    /*  MOR 수술실 */
										#{dprtCd} = '01H' or    /*  투석 */
										#{dprtCd} = 'BR'  or    /*  영상의학과(본관) */
										#{dprtCd} = 'WARD2')    /*  분만장 */
									  )
								 )
						   and  (
						         (#{dprtCd} = 'DSC'
										 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_411|MDP_412|MDP_413|MDP_414|MDP_415|MDP_416') = 'Y') or          /*  DSC */
								 (#{dprtCd} = '01H'
										 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_419|MDP_436') = 'Y') or          /*  투석실 */
								 (#{dprtCd} = 'ETC'
										 and  a.FRNS_DPRT_CD = #{dprtCd1}                        ) or          /*  기타장소(ORDACPPL) */
								  (#{dprtCd} = 'OP'
												 and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_PACU') ) or          /*  회복실 */
										 (#{dprtCd} = 'OP3'
												 and  a.FRNS_DPRT_CD = FN_CC_GET_DPRT_CD('DPRT_OPRM')) or          /*  MOR-수술실 */
								  (#{dprtCd} = 'OP2'
										 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_407') = 'Y') or          /*  MOR-준비실 */
								  (#{dprtCd} = 'WARD'
										 and  a.WARD_CD   = #{wardCd}
										 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'W') = 'Y') or        /*  병동-병동 */
								 (#{dprtCd} = 'BR'
										 and  (fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_427') = 'Y' or nvl(a.FRNS_DPRT_CD
														   ,  'Z'
											   ) =  'BR')) or          /*  영상의학과 */
								 (#{dprtCd} = 'WARD2'
										 and  fn_mn_check_orocdprtcd(a.oroc_dprt_cd, 'MDP_417|MDP_418|MDP_424|MDP_425') = 'Y')             /*  병동-분만 */
								)
						   and  f.PTNO             = a.PTNO
						   and  g.ORDR_YMD         = a.ORDR_YMD
						   and  g.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
						   and  g.MDTN_NO          = a.MDTN_NO
						   and  g.ORDR_SNO         = a.ORDR_SNO
						   and  g.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
						   and  h.ORDR_YMD          (+)= g.ORDR_YMD
						   and  h.MDTN_NO_DVSN_CD   (+)= g.MDTN_NO_DVSN_CD
						   and  h.MDTN_NO           (+)= g.MDTN_NO
						   and  h.ORDR_SNO          (+)= g.ORDR_SNO
						   and  h.MDPR_CD           (+)= g.MDPR_CD
						   and  h.MDTN_LCDV_CD      (+)= g.MDTN_LCDV_CD
						   and  i.ORDR_YMD          (+)= g.ORDR_YMD
						   and  i.MDTN_NO_DVSN_CD   (+)= g.MDTN_NO_DVSN_CD
						   and  i.MDTN_NO           (+)= g.MDTN_NO
						   and  i.ORDR_SNO          (+)= g.ORDR_SNO
						   and  i.MDPR_CD           (+)= g.MDPR_CD
						   and  i.MDTN_LCDV_CD      (+)= g.MDTN_LCDV_CD
		 	                   and  exists (
		                                 select *   /* 약반납 정보가 있는 케이스만 조회 되도록  */
		                                   from SDJDGRTNT h /* 처방성약품반납관리 */
		                                  where 1=1
		                                    and  h.ORDR_YMD         = a.ORDR_YMD
		                                    and  h.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		                                    and  h.MDTN_NO          = a.MDTN_NO
		                                    and  h.ORDR_SNO         = a.ORDR_SNO
		                                    and  h.MDTN_LCDV_CD     = a.MDTN_LCDV_CD                                 
		                              )
					  ) z
				order
				   by
					   z.MDPR_CD, 2, z.ORDR_SNO
				]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDetlInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="arvlDprtCd" column="ARVL_DPRT_CD"/>
		<result property="arvlDprtNm" column="ARVL_DPRT_NM"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="afiRqstCqyStr" column="AFI_RQST_CQY_STR"/>
		<result property="cnfrYn" column="CNFR_YN"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="afiRtrnRqprNm" column="AFI_RTRN_RQPR_NM"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDetlInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDetlInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDetlInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDetlInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDetlInqr  mnd_jdgrtnt_l06$S01_약품별 세부반납내역 조회DAM */
				   to_char(a.RTRN_RQST_DT, 'yyyymmdd') as RTRN_RQST_DT
				,  a.ARVL_DPRT_CD as ARVL_DPRT_CD
				,  (select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.ARVL_DPRT_CD) as ARVL_DPRT_NM
				,  decode(a.DRUG_RTRE_CD, '6', '잔량반납', '7', '자동미수령반납', ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
																				   from CCCMCDDMT A, CCCMCDDLT B
																				   where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
																					 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
																					 and A.COMN_GRP_CD  = 'SD068'
																					 and A.COMN_DTLS_CD = nvl(a.DRUG_RTRE_CD, '')
																					 and B.LNGG_CD(+)   = nvl('', '*') )) as CD_NM
				,  to_char(a.MDPR_RTRN_NTM) as AFI_RTRN_NTM_STR
				,  decode(a.DRUG_RTRE_CD, '6', a.RTRN_RQST_CQY||b.ICUN_CD, decode(b.SLCT_UNIT_DVSN_CD, '1'
																				  ,a.PTAD_RTRN_QTY||b.PCUN_CD, '2', a.PTAD_RTRN_QTY*c.PCUN_INLS_QTY||b.ICUN_CD)) as AFI_RQST_CQY_STR
				,  decode(a.RTRN_CNFR_YMD, null, 'N', 'Y') as CNFR_YN
				,  b.RCST_CD as RCST_CD
				,  to_char(b.MDTN_NO) as AFI_MDTN_NO_STR
				, ( select  USER_NM from CCUSRDPHT where USER_ID = a.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
				,  to_char(a.FRST_RGST_DT, 'yyyymmddhh24miss') as FRST_RGST_DT
			 from  SDJDGRTNT a    /*  처방성약품반납관리 */
				,  MDMEDORDT b
				,  MDORDRCMT c
			where  a.PTNO             = #{ptno}
			  and  a.ORDR_YMD         = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  a.ORDR_SNO         = to_number(#{afiOrdrSnoStr})
			  and  a.MDPR_CD          = #{mdprCd}
			  and  a.MDTN_NO          = to_number(#{afiMdtnNoStr})
			  and  b.PTNO             = a.PTNO
			  and  b.ORDR_YMD         = a.ORDR_YMD
			  and  b.ORDR_SNO         = a.ORDR_SNO
			  and  c.ORDR_CD          = a.MDPR_CD
			union  all
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnDetlInqr  mnd_jdgrtnt_l06$S01_약품별 세부반납내역 조회DAM */
				   to_char(b.EXRE_RTRN_DT, 'yyyymmdd')
				,  a.ARVL_DPRT_CD
				,  (select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD = a.ARVL_DPRT_CD) as ABRV_DPRT_CD
				,  decode(b.RTRN_EXRE_CTN, '01', 'Mix반납', '02', '폐기반납', '03', '1A초과잔량')
				,  '1'
				,  b.EXRE_RTRN_QTY||decode(b.RTRN_EXRE_CTN, '01', 'cc', '02', 'mg', '03', 'mg')
				,  decode(a.RTRN_CNFR_YMD, null, 'N', 'Y')
				,  b.RCST_CD
				,  to_char(b.MDTN_NO)
				, ( select  USER_NM from CCUSRDPHT where USER_ID = a.RTRN_RQPR_ID )
				,  to_char(a.FRST_RGST_DT, 'yyyymmddhh24miss')
			 from  SDJDGRTNT a
				,  MDMEDORDT b
				,  MDORDRCMT c
			where  a.PTNO                  = #{ptno}
			  and  a.ORDR_YMD              = to_date(#{ordrYmd}, 'yyyy-mm-dd')
			  and  a.ORDR_SNO              = to_number(#{afiOrdrSnoStr})
			  and  a.MDPR_CD               = #{mdprCd}
			  and  a.MDTN_NO               = to_number(#{afiMdtnNoStr})
			  and  a.RTRN_DETL_DVSN_CD  = 'Z'
			  and  b.RTRN_EXRE_CTN is not null
			  and  b.PTNO                  = a.PTNO
			  and  b.ORDR_YMD              = a.ORDR_YMD
			  and  b.ORDR_SNO              = a.ORDR_SNO
			  and  c.ORDR_CD               = a.MDPR_CD
			order
			   by  1 desc
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTxOrdrNtmInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="ordrNtm" column="ORDR_NTM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTxOrdrNtmInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTxOrdrNtmInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTxOrdrNtmInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTxOrdrNtmInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTxOrdrNtmInqr  mnd_trtordt_l09$S01_특정처치코드 처방횟수 조회DAM */   
		   		   ORDR_CD as ORDR_CD
				,  ORDR_NM as ORDR_NM
				,  count(*)  as ORDR_NTM
			 from
				(
				   select
						   a.ORDR_CD
						,  c.ORDR_NM
						,  a.ORDR_YMD
					 from
						   MDTRTORDT a
						,  MDORDRCMT c
					where
							a.PTNO       = #{ptno}
					  and  a.ORDR_YMD between trunc(sysdate) - to_number(nvl(#{afiDdcnRangNm}, '0'))  and trunc(sysdate)
					  and  a.ORDR_CD     = #{ordrCd}
					  and  nvl(a.DC_DVSN_CD, 'N') = 'N'
					  and  a.ORDR_NTM_QTY > 0
					  and  nvl(a.RTRN_STTS_CD, 'X') <> 'Y'
					  and  c.ORDR_CD     = a.ORDR_CD
					union  all
				   select
						   a.ORDR_CD
						,  c.ORDR_NM
						,  a.ORDR_YMD
					 from
						   MDTRTORDT a
						,  MNZTRTRET b
						,  MDORDRCMT c
					where  a.PTNO       = #{ptno}
					  and  a.ORDR_YMD between trunc(sysdate) - to_number(nvl(#{afiDdcnRangNm}, '0'))  and trunc(sysdate)
					  and  a.ORDR_CD     = #{ordrCd}
					  and  nvl(a.DC_DVSN_CD, 'N') = 'N'
					  and  a.ORDR_NTM_QTY > 0
					  and  nvl(a.RTRN_STTS_CD, 'X') = 'Y'
					  and  b.PTNO        = a.PTNO
					  and  b.ORDR_YMD  = a.ORDR_YMD
					  and  b.ORDR_SNO  = a.ORDR_SNO
					  and  b.RTRN_NTM_QTY  > 0
					  and  b.RTRN_NTM_QTY  > a.ORDR_NTM_QTY
					  and  c.ORDR_CD   = a.ORDR_CD
				)
			group
			   by  ORDR_CD
				,  ORDR_NM
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnUpdtTrgtInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="icunCd1" column="ICUN_CD_1"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="afiRtrnRqprNm" column="AFI_RTRN_RQPR_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="updtPsblYn" column="UPDT_PSBL_YN"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="afiDdcnStr" column="AFI_DDCN_STR"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="orfrCd" column="ORFR_CD"/>
		<result property="afiPcknUnadQtyStr" column="AFI_PCKN_UNAD_QTY_STR"/>
		<result property="drugOrdrPrssCd" column="DRUG_ORDR_PRSS_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="afiAdmnVlmStr" column="AFI_ADMN_VLM_STR"/>
		<result property="rtrnExreCtn" column="RTRN_EXRE_CTN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnUpdtTrgtInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnUpdtTrgtInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnUpdtTrgtInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnUpdtTrgtInqr-result" useCache="true" flushCache="false">
			<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnUpdtTrgtInqr  mnd_jdgrtnt_l07$S01_반납수정 대상내역 조회DAM */
					   to_char(a.RTRN_RQST_DT, 'yyyymmddhh24miss') as RTRN_RQST_DT
					,  decode(a.DRUG_RTRE_CD, '7', to_char(a.MDPR_RTRN_NTM)
											 , decode(sign(to_number(nvl(a.DRUG_RTRE_CD, 9))-6), -1
													 , to_char(a.MDPR_RTRN_NTM), to_char(a.RTRN_RQST_CQY))) as AFI_RTRN_NTM_STR
					,  decode(a.DRUG_RTRE_CD, '6', b.ICUN_CD, '회') as ICUN_CD_1
					,  decode(a.DRUG_RTRE_CD, '6', '잔량반납'
											 , '7', '자동미수령반납'
											 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
												 from CCCMCDDMT A, CCCMCDDLT B
												 where A.COMN_GRP_CD  = B.COMN_GRP_CD(+)
												   and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
												   and A.COMN_GRP_CD  = 'SD068'
												   and A.COMN_DTLS_CD = nvl(a.DRUG_RTRE_CD, '')
												   and B.LNGG_CD(+)   = nvl('', '*') )) as CD_NM
					, ( select  USER_NM from CCUSRDPHT where USER_ID = a.RTRN_RQPR_ID ) as AFI_RTRN_RQPR_NM
					,  a.PTNO as PTNO
					,  to_char(a.ORDR_YMD, 'yyyymmdd') as ORDR_YMD
					,  to_char(a.ORDR_SNO) as AFI_ORDR_SNO_STR
					,  a.MDPR_CD as MDPR_CD
					, case when a.DRUG_RTRE_CD = '6' then 'Y'
						   when a.DRUG_RTRE_CD = '5' and ((( d.MDPR_CLSF_CD = '3' ) or ( d.MDPR_CLSF_CD = '2' )) and (d.DRAP_DVSN_CD = '2')) then 'N' /* 4:수령반납  /* 병동응급, /주사제일때만 부분반납가능.. */
		                   /* 2021.11.24 홍창한 수정함. 퇴원 후 가퇴원상태에서는 퇴원일자와 상관없이 반납 수정할 수 있도록 수정함. Start */
					 /* else decode(b.RCST_CD, 'R', 'N' */
					 /*							, decode(sign(nvl(c.DSCH_DT, to_date('29991231', 'yyyymmdd'))-sysdate), -1, 'N' */
					 /*																									  , decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'))) */
					       else decode(b.RCST_CD, 'R', 'N'
												, decode(sign(nvl(c.DSCH_DT, to_date('29991231', 'yyyymmdd'))-sysdate)
		                                              , -1
		                                              , decode(b.CODV_CD, 'I'
		                                                                , (select decode(sign(count(x.PTNO)), 1, decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'), 'N') 
		                                                                     from APRCRPTNT x
		                                                                    where x.MDRP_NO  = b.MDRP_NO 
		                                                                      and nvl(x.CHCK_STTS_CD, 'N')      =  'N'  /* N 미심사, P 심사 완료, I 심사중 */
		                                                                      and nvl(x.DSCH_STTS_CD, '*')      <> '1'  /* 0 계산서 발행, 1 정상퇴원, 2 가퇴원, 3 도주, 9  기타(정퇴원 후 심사 취소) */
		                                                                      and nvl(x.DSCH_CHCK_RQST_YN, 'N') <> 'S'  /* S 심사요청, C 심사 취소 */
		                                                                      and x.CNCL_DT is null)
		                                                                , 'E'     
		                                                                , (select decode(sign(count(x.PTNO)), 1, decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'), 'N')
		                                                                     from APRCRPTNT x
		                                                                    where x.MDRP_NO  = b.MDRP_NO 
		                                                                      and nvl(x.MCRC_YN, 'N') in ('N', 'M')     /* N 미수납, M 화면 풀기 */
		                                                                      and x.CNCL_DT is null)
		                                                                , 'N' )
													  , decode(a.RTRN_CNFR_YMD, null, 'Y', 'N')
		                                                 )
		                              ) 
		                   /* 2021.11.24 홍창한 수정함. 퇴원 후 가퇴원상태에서는 퇴원일자와 상관없이 반납 수정할 수 있도록 수정함. End */
					  end as UPDT_PSBL_YN
		   /*          ,  decode(a.DRUG_RTRE_CD, '6', 'Y' */
		   /*                                  , '5', decode( d.MDPR_CLSF_CD, '3', 'N') */
		   /*                                       , decode(b.RCST_CD, 'R', 'N'     /* 수납확인이 되었으면 N */
		   /*                                       , decode(sign(nvl(c.DSCH_DT, to_date('29991231', 'yyyymmdd'))-sysdate), -1, 'N' */
		   /*                                       , decode(a.RTRN_CNFR_YMD, null, 'Y', 'N')))) as UPDT_PSBL_YN */
					,  a.MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD
					,  to_char(a.MDTN_NO) as AFI_MDTN_NO_STR
					,  a.MDTN_LCDV_CD as MDTN_LCDV_CD
					,  a.DRUG_RTRE_CD as DRUG_RTRE_CD
					,  b.DRAP_DVSN_CD as DRAP_DVSN_CD
					,  d.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD
					,  to_char(b.NTM) as AFI_NTM_STR
					,  d.MDPR_CLSF_CD as MDPR_CLSF_CD
					,  to_char(b.DDCN) as AFI_DDCN_STR
					,  b.ODKI_CD as ODKI_CD
					,  b.ORFR_CD as ORFR_CD
					,  to_char(b.PCKN_UNAD_QTY) as AFI_PCKN_UNAD_QTY_STR
					,  b.DRUG_ORDR_PRSS_CD as DRUG_ORDR_PRSS_CD
					,  a.PTRM_NO as PTRM_NO
					,  a.SCKB_NO as SCKB_NO
					,  decode(b.SLCT_UNIT_DVSN_CD, '1', b.PCKN_UNAD_QTY, b.ICUN_ADMN_VLM) as AFI_ADMN_VLM_STR
					,  '' as RTRN_EXRE_CTN     /* 포장단위투여량(함량단위투여량) */
				 from  SDJDGRTNT a
					,  MDMEDORDT b
					,  APRCRPTNT c
					,  MDORDRCMT d
				where  a.PTNO        = #{ptno}
				  and  a.ORDR_YMD    = to_date(#{ordrYmd}, 'yyyymmdd')
				  and  a.ORDR_SNO    = to_number(#{afiOrdrSnoStr})
				  and  b.PTNO        = a.PTNO
				  and  b.ORDR_YMD    = a.ORDR_YMD
				  and  b.ORDR_SNO    = a.ORDR_SNO
				  and  c.PTNO(+)     = b.PTNO
				  and  c.MDRP_NO(+)  = b.MDRP_NO
				  and  c.CODV_CD(+)  = b.CODV_CD
				  and  d.ORDR_CD     = a.MDPR_CD
				union  all
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnUpdtTrgtInqr  mnd_jdgrtnt_l07$S01_반납수정 대상내역 조회DAM */
					   to_char(b.EXRE_RTRN_DT, 'yyyymmddhh24miss')
					,  to_char(b.EXRE_RTRN_QTY)
					,  case when b.EXRE_RTRN_DT > to_date('20160222', 'yyyymmdd') then 'cc'
					   else  decode(b.RTRN_EXRE_CTN, '01', ' cc', b.ICUN_CD)
					   end
					/* , decode(b.RTRN_EXRE_CTN, '01', ' cc', b.ICUN_CD) */
					,  decode(b.RTRN_EXRE_CTN, '01', 'Mix', '02', '폐기', '03', '1A초과잔량')
					, ( select  USER_NM from CCUSRDPHT where USER_ID = b.EXRE_RTPR_ID )
					,  a.PTNO
					,  to_char(a.ORDR_YMD, 'yyyymmdd')
					,  to_char(a.ORDR_SNO)
					,  a.MDPR_CD
					, case when a.DRUG_RTRE_CD = '6' then 'Y'
		                   /* 2021.11.24 홍창한 수정함. 퇴원 후 가퇴원상태에서는 퇴원일자와 상관없이 반납 수정할 수 있도록 수정함. Start */
					  /*     when a.DRUG_RTRE_CD = '5' and (( d.MDPR_CLSF_CD = '3' ) or ( d.MDPR_CLSF_CD = '2' )) then 'N' */
					  /* else decode(b.RCST_CD, 'R', 'N' */
					  /* 						, decode(sign(nvl(c.DSCH_DT, to_date('29991231', 'yyyymmdd'))-sysdate), -1, 'N' */
					  /*																									  , decode(a.RTRN_CNFR_YMD, null, 'Y', 'N')))  */
						   when a.DRUG_RTRE_CD = '5' and ((( d.MDPR_CLSF_CD = '3' ) or ( d.MDPR_CLSF_CD = '2' )) and (d.DRAP_DVSN_CD = '2')) then 'N' /* 2021.11.24 홍창한 수정함. 상단의 조건과 동일하게 수정함. */
		  			       else decode(b.RCST_CD, 'R', 'N'
												, decode(sign(nvl(c.DSCH_DT, to_date('29991231', 'yyyymmdd'))-sysdate)
		                                               , -1
		                                               , decode(b.CODV_CD, 'I'
		                                                                 , (select decode(sign(count(x.PTNO)), 1, decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'), 'N') 
		                                                                      from APRCRPTNT x
		                                                                     where x.MDRP_NO  = b.MDRP_NO 
		                                                                       and nvl(x.CHCK_STTS_CD, 'N')      =  'N'  /* N 미심사, P 심사 완료, I 심사중 */
		                                                                       and nvl(x.DSCH_STTS_CD, '*')      <> '1'  /* 0 계산서 발행, 1 정상퇴원, 2 가퇴원, 3 도주, 9  기타(정퇴원 후 심사 취소) */
		                                                                       and nvl(x.DSCH_CHCK_RQST_YN, 'N') <> 'S'  /* S 심사요청, C 심사 취소 */
		                                                                       and x.CNCL_DT is null)
		                                                                 , 'E'     
		                                                                 , (select decode(sign(count(x.PTNO)), 1, decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'), 'N')
		                                                                      from APRCRPTNT x
		                                                                     where x.MDRP_NO  = b.MDRP_NO 
		                                                                       and nvl(x.MCRC_YN, 'N') in ('N', 'M')     /* N 미수납, M 화면 풀기 */
		                                                                       and x.CNCL_DT is null)
		                                                                 , 'N' )
													   , decode(a.RTRN_CNFR_YMD, null, 'Y', 'N')
		                                                 )
		                               ) 
		                   /* 2021.11.24 홍창한 수정함. 퇴원 후 가퇴원상태에서는 퇴원일자와 상관없이 반납 수정할 수 있도록 수정함. End   */
					  end  as UPDT_PSBL_YN
					,  a.MDTN_NO_DVSN_CD
					,  to_char(a.MDTN_NO)
					,  a.MDTN_LCDV_CD
					,  a.DRUG_RTRE_CD
					,  b.DRAP_DVSN_CD
					,  d.TOTL_QTY_CLCL_CD
					,  to_char(b.NTM)
					,  d.MDPR_CLSF_CD
					,  to_char(b.DDCN)
					,  b.ODKI_CD
					,  b.ORFR_CD
					,  to_char(b.PCKN_UNAD_QTY)
					,  b.DRUG_ORDR_PRSS_CD
					,  a.PTRM_NO
					,  a.SCKB_NO
					,  decode(b.SLCT_UNIT_DVSN_CD, '1', b.PCKN_UNAD_QTY, b.ICUN_ADMN_VLM)
					,  b.RTRN_EXRE_CTN
				 from  SDJDGRTNT a
					,  MDMEDORDT b
					,  APRCRPTNT c
					,  MDORDRCMT d
				where  a.PTNO        = #{ptno}
				  and  a.ORDR_YMD    = to_date(#{ordrYmd}, 'yyyymmdd')
				  and  a.ORDR_SNO    = to_number(#{afiOrdrSnoStr})
				  and  b.PTNO        = a.PTNO
				  and  b.ORDR_YMD    = a.ORDR_YMD
				  and  b.ORDR_SNO    = a.ORDR_SNO
				  and  b.RTRN_EXRE_CTN is not null
				  and  a.RTRN_DETL_DVSN_CD = 'Z'
				  and  c.PTNO(+)     = b.PTNO
				  and  c.MDRP_NO(+)  = b.MDRP_NO
				  and  c.CODV_CD(+)  = b.CODV_CD
				  and  d.ORDR_CD     = a.MDPR_CD
				order
				   by  1 desc
				]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listNnrcRtrnUpdtPsblYn-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listNnrcRtrnUpdtPsblYn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listNnrcRtrnUpdtPsblYn-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listNnrcRtrnUpdtPsblYn"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listNnrcRtrnUpdtPsblYn-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listNnrcRtrnUpdtPsblYn  mnd_jdgrtnt_l08$S01_미수령반납 수정가능여부 조회DAM */
				   a.MDTN_NO as AFI_MDTN_NO_STR
			 from
				   SDPORDBAT a
				,  SDPORDDET b
			where  a.PTNO                 = #{ptno}
			  and  a.ORDR_YMD          = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  a.MDTN_NO_DVSN_CD   = #{mdtnNoDvsnCd}
			  and  a.MDTN_NO           = #{afiMdtnNoStr}
			  and  a.MDTN_LCDV_CD      = #{mdtnLcdvCd}
			  and  a.NNRC_RTRN_CNFM_ID is not null
			  and  a.ORDR_YMD          = b.ORDR_YMD
			  and  a.MDTN_NO_DVSN_CD   = b.MDTN_NO_DVSN_CD
			  and  a.MDTN_NO           = b.MDTN_NO
			  and  a.MDTN_LCDV_CD      = b.MDTN_LCDV_CD
			  and  b.MDPR_CD           = nvl(#{ordrCd}, b.MDPR_CD)
			  and  (
					   (
						   #{ordrCd} is not null
						   and  b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7')
					   )
					   or
					   #{ordrCd} is null
					)
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnPrgrSttsInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="rtrnExreCtn" column="RTRN_EXRE_CTN"/>
		<result property="rtrnYn" column="RTRN_YN"/>
		<result property="refnYn" column="REFN_YN"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnPrgrSttsInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnPrgrSttsInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnPrgrSttsInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnPrgrSttsInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnPrgrSttsInqr  mnd_jdgrtnt_l09$S01_약반납 진행상태 조회DAM */    
				   to_char(a.EXRE_RTRN_DT, 'yyyymmddhh24miss') as RTRN_RQST_DT
				,  a.RTRN_EXRE_CTN as RTRN_EXRE_CTN
				,  '' as RTRN_YN          /* 반납여부 */
				,  '' as REFN_YN
				,  a.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD
				,  '' as DRUG_RTRE_CD
			 from
				   MDMEDORDT a
			where  a.PTNO       = #{ptno}
			  and  a.ORDR_YMD   = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  a.ORDR_SNO   = to_number(#{afiOrdrSnoStr})
			  and  a.RTRN_EXRE_CTN is not null
			  and  #{drugRtreCd} is null        /* 약반납사유코드 */
			union  all
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnPrgrSttsInqr  mnd_jdgrtnt_l09$S01_약반납 진행상태 조회DAM */  
				   to_char(e.RTRN_RQST_DT, 'yyyymmddhh24miss')    as RTRN_RQST_DT
				,  a.RTRN_EXRE_CTN                                as RTRN_EXRE_CTN
				,  e.RTRN_YN                                      as RTRN_YN          /* 반납여부 */
				,  e.REFN_YN                                      as REFN_YN
				,  a.SLCT_UNIT_DVSN_CD                            as SLCT_UNIT_DVSN_CD
				,  nvl(e.DRUG_RTRE_CD, '')                        as DRUG_RTRE_CD
			 from
				   MDMEDORDT a
				,  MDORDRCMT c
				,  APRCRPTNT d
				,  SDJDGRTNT e
			where  a.PTNO             = #{ptno}
			  and  a.ORDR_YMD         = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  a.ORDR_SNO         = to_number(#{afiOrdrSnoStr})
			  and  a.PTNO             = d.PTNO
			  and  a.MDRP_NO          = d.MDRP_NO
			  and  a.ORDR_CD          = c.ORDR_CD
			  and  e.PTNO            (+)= a.PTNO
			  and  e.ORDR_YMD        (+)= a.ORDR_YMD
			  and  e.ORDR_SNO        (+)= a.ORDR_SNO
			  and  e.ORDR_YMD        (+)= a.ORDR_YMD
			  and  e.MDTN_LCDV_CD    (+)= a.MDTN_LCDV_CD
			  and  e.DRUG_RTRE_CD    (+)= nvl(#{drugRtreCd}, e.DRUG_RTRE_CD(+))
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCqyBrkdInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="afiRtrnNtmStr" column="AFI_RTRN_NTM_STR"/>
		<result property="afiRtrnCqyStr" column="AFI_RTRN_CQY_STR"/>
		<result property="afiRtrnCqyStr1" column="AFI_RTRN_CQY_STR_1"/>
		<result property="afiTotlQtyStr" column="AFI_TOTL_QTY_STR"/>
		<result property="afiTotlQtyStr1" column="AFI_TOTL_QTY_STR_1"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCqyBrkdInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCqyBrkdInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCqyBrkdInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCqyBrkdInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCqyBrkdInqr  mnd_jdgrtnt_l10$S01_약반납 수량내역 조회DAM */
				   to_char(sum(decode(a.RTRN_RQST_DT, to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss'), 0, MDPR_RTRN_NTM))) as AFI_RTRN_NTM_STR  /*  약품반납횟수 */
				,  to_char(sum(decode(a.RTRN_RQST_DT, to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss'), 0, RTRN_RQST_CQY))) as AFI_RTRN_CQY_STR  /*  반납요청수량 */
				,  to_char(sum(decode(a.RTRN_RQST_DT, to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss'), 0, PTAD_RTRN_QTY))) as AFI_RTRN_CQY_STR_1 /*  원무반납량   */
				,  to_char(fn_sd_totivqty_s(to_number(#{afiPcknUnadQtyStr}),
													to_number(#{afiNtmStr}),
													to_number(#{afiDdcnStr}),
													#{totlQtyClclCd},
													#{drapDvsnCd},
													#{drugOrdrPrssCd})) as AFI_TOTL_QTY_STR
				,  to_char(fn_sd_totivqty_s(to_number(#{afiPcknUnadQtyStr}),
													to_number(#{afiNtmStr})-to_number(#{afiRtrnNtmStr})
														-sum(decode(a.RTRN_RQST_DT, to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')
																					, 0, MDPR_RTRN_NTM)),
													to_number(#{afiDdcnStr}),
													#{totlQtyClclCd},
													#{drapDvsnCd},
													#{drugOrdrPrssCd})) as AFI_TOTL_QTY_STR_1
			 from
				   SDJDGRTNT a
			where  ORDR_YMD   = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  MDTN_NO    = to_number(#{afiMdtnNoStr})
			  and  RTRN_DETL_DVSN_CD  != 'Z'
			  and  PTNO       = #{ptno}
			  and  ORDR_SNO   = to_number(#{afiOrdrSnoStr})
			]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateCupQtyRtrnUpdt () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateCupQtyRtrnUpdt"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateCupQtyRtrnUpdt  sdd_mngrtnt_u02$U01_마약향정 잔량반납DAM */
				  SDJDGRTNT
			 set  RTRN_RQST_CQY      = to_number(#{afiRtrnNtmStr})
			   ,  PTAD_RTRN_QTY      = to_number(#{afiRtrnNtmStr})
			   ,  RTRN_RQPR_ID       = #{gvUserId}
			   ,  RTRN_RQST_IP       = #{gvUserIp}
			   ,  MDPR_RTRN_NTM      = 0
			   ,  LAST_UPDR_ID       = #{gvUserId}
			   ,  LAST_UPDT_IP       = #{gvUserIp}
			   ,  LAST_UPDT_DT       = sysdate
			   ,  LAST_UPDT_CLNT_PRGM_ID  = #{gvClntPrgmId}
			   ,  LAST_UPDT_SRVR_PRGM_ID  = #{gvSrvrPrgmId}
		   where  ORDR_YMD           = to_date(#{ordrYmd}, 'yyyymmdd')
			 and  ORDR_SNO           = to_number(#{afiOrdrSnoStr})
			 and  DRUG_RTRE_CD       = '6'
			 and  PTNO               = #{ptno}
			 and  nvl(RTRN_YN, 'N') != 'Y'
			 and  nvl(REFN_YN, 'N') != 'R'
			]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpResnRtrnUpdt () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpResnRtrnUpdt"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
			   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpResnRtrnUpdt  mnd_medordt_u08$U01_잔량예외사유반납 수정DAM */
					   MDMEDORDT
				  set  RTRN_EXRE_CTN       = decode(#{rtrnExreCtn}, '04', '', #{rtrnExreCtn})
					,  EXRE_RTRN_QTY       = decode(#{rtrnExreCtn}, '04', '', #{afiExreRtrnQtyStr})
					,  EXRE_RTPR_ID        = #{gvUserId}
					,  EXRE_RTRN_DT        = sysdate
					,  LAST_UPDR_ID        = #{gvUserId}
					,  LAST_UPDT_IP        = #{gvUserIp}
					,  LAST_UPDT_DT        = sysdate
					,  LAST_UPDT_CLNT_PRGM_ID   = #{gvClntPrgmId}
					,  LAST_UPDT_SRVR_PRGM_ID   = #{gvSrvrPrgmId}
				where  PTNO                = #{ptno}
				  and  ORDR_YMD            = to_date(#{ordrYmd}, 'yyyymmdd')
				  and  ORDR_SNO            = to_number(#{afiOrdrSnoStr})
			]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnInfmCncl () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnInfmCncl"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnInfmCncl  mnd_medordt_u09$U01_약처방 반납정보수정DAM */
				   MDMEDORDT
			  set
				   DRRT_DVSN_CD    = decode(#{afiNtmStr}, '0', null, DRRT_DVSN_CD)         /*  약반납구분 '1'의사, '2'약국, '3'간호사 */
				,  DRUG_RTRE_CD    = decode(#{afiNtmStr}, '0', null, DRUG_RTRE_CD)         /*  반납사유코드                           */
				,  DRRT_CNNU_ID    = decode(#{afiNtmStr}, '0', null, #{gvUserId})        /*  약반납확인간호사                       */
				,  PHRM_RTRN_QTY   = (
									   select  decode(QTY, 0, 0, decode(substr(#{frnsCtrlDvsnCd}, 1, 1), 'B', to_number(#{afiFrnsVlmStr})
											   , decode(#{clncExamDrugYn}, 'X', #{afiPcknUnadQtyStr}, QTY)))
										 from
											   (
											   select
													   sum(decode(#{totlQtyClclCd}, 'OT', 1, MDPR_RTRN_NTM)) *to_number(#{afiAdmnVlmStr}) QTY
												 from
													   SDJDGRTNT
												 where
													   ORDR_YMD   = to_date(#{ordrYmd}, 'yyyymmdd')
												  and  PTNO       = #{ptno}
												  and  MDTN_NO    = to_number(#{afiMdtnNoStr})
												  and  ORDR_SNO   = to_number(#{afiOrdrSnoStr})
												  and  RTRN_DETL_DVSN_CD   <> 'Z'
											   )
									  )
				,  PACL_AFTR_DRRT_QTY  = (
										   select
												   sum(PTAD_RTRN_QTY)
											 from
												   SDJDGRTNT
											where
													ORDR_YMD      = to_date(#{ordrYmd}, 'yyyymmdd')
											   and  PTNO          = #{ptno}
											   and  MDTN_NO       = to_number(#{afiMdtnNoStr})
											   and  ORDR_SNO      = to_number(#{afiOrdrSnoStr})
											   and  MDTN_LCDV_CD  = nvl(#{mdtnLcdvCd}, 'M')
											   and  RTRN_DETL_DVSN_CD     <> 'Z'
										   )
				,  FRNS_RTRN_CQY = null
				,  LAST_UPDR_ID      = #{gvUserId}
				,  LAST_UPDT_IP      = #{gvUserIp}
				,  LAST_UPDT_DT      = sysdate
				,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
			where
				   PTNO      = #{ptno}                          /*  환자번호 */
			  and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd') /*  처방일자 */
			  and  ORDR_SNO  = to_number(#{afiOrdrSnoStr})           /*  처방순번 */
			  and  ORDR_CD   = #{ordrCd}
			]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpResnRtrnCncl () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpResnRtrnCncl"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateExcpResnRtrnCncl  mnd_medordt_u10$U01_예외사유 반납취소DAM */
				   MDMEDORDT
			  set
				   RTRN_EXRE_CTN     = null
				,  EXRE_RTRN_QTY     = null
				,  EXRE_RTPR_ID      = null
				,  EXRE_RTRN_DT      = null
				,  LAST_UPDR_ID      = #{gvUserId}
				,  LAST_UPDT_IP      = #{gvUserIp}
				,  LAST_UPDT_DT      = sysdate
				,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
			where  PTNO      = #{ptno}
			  and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  ORDR_SNO  = to_number(#{afiOrdrSnoStr})
			]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNrdrPrtxPrinNtmUpdt () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNrdrPrtxPrinNtmUpdt"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
			   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNrdrPrtxPrinNtmUpdt  mnd_mdmedor_u03$I01_마약처방전출력횟수증가 다건수정DAM */
					   MDMEDORDT
				  set  NRDR_PRTX_PRIN_NTM = nvl(NRDR_PRTX_PRIN_NTM, 0) + 1
					,  LAST_UPDR_ID       = #{gvUserId}
					,  LAST_UPDT_IP       = #{gvUserIp}
					,  LAST_UPDT_DT       = sysdate
					,  LAST_UPDT_CLNT_PRGM_ID  = #{gvClntPrgmId}
					,  LAST_UPDT_SRVR_PRGM_ID  = #{gvSrvrPrgmId}
				where  PTNO =     #{ptno}
				  and  ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
				  and  ORDR_SNO = #{ordrSno}
			]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNrdrPrtxPrinNtmUpdt2 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNrdrPrtxPrinNtmUpdt2"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
			   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNrdrPrtxPrinNtmUpdt2  mnd_mdmedor_u04$I01_마약반납처방전출력횟수증가 다건수정DAM */
					   MDMEDORDT
				  set  NRDR_RTRN_PRTX_PRIN_NTM = nvl(NRDR_RTRN_PRTX_PRIN_NTM, 0) + 1
					,  LAST_UPDR_ID       = #{gvUserId}
					,  LAST_UPDT_IP       = #{gvUserIp}
					,  LAST_UPDT_DT       = sysdate
					,  LAST_UPDT_CLNT_PRGM_ID  = #{gvClntPrgmId}
					,  LAST_UPDT_SRVR_PRGM_ID  = #{gvSrvrPrgmId}
				where  PTNO     = #{ptno}
				  and  ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
				  and  ORDR_SNO = #{ordrSno}
			]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCnfrYn-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="vlExstYn" column="VL_EXST_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCnfrYn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCnfrYn-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCnfrYn"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCnfrYn-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrugRtrnCnfrYn  sdd_mngrtnt_s01$S01_약반납확인 여부 조회 */
				   decode(count(*), 0, 'N', 'Y') as VL_EXST_YN
			 from
				   SDJDGRTNT
			where
				   ORDR_YMD             = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  MDTN_NO_DVSN_CD      = #{mdtnNoDvsnCd}
			  and  MDTN_NO              = to_number(#{mdtnNo})
			  and  MDTN_LCDV_CD         = #{mdtnLcdvCd}
			  and  ORDR_SNO             = to_number(#{ordrSno})
			  and  RTRN_RQST_DT         = to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')
			  and  MDPR_CD              = #{mdprCd}
			  and  RTRN_CNFR_YMD is null
			]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDurvRtrnDdcnUpdt () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDurvRtrnDdcnUpdt"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateDurvRtrnDdcnUpdt  mnd_medordt_u07$U01_약처방 DUR반납일수수정DAM */
				   MDMEDORDT
			 set  DURV_RTRN_DDCN = to_number(nvl(#{afiDurvRtrnDdcnStr}, 0))
			   /*  서버 프로그램 전환시 자동 추가된 항목 */
			   ,  LAST_UPDR_ID = #{gvUserId}
			   ,  LAST_UPDT_IP = #{gvUserIp}
			   ,  LAST_UPDT_DT = sysdate
			   ,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
			   ,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
			   where  PTNO      = #{ptno}
				 and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
				 and  ORDR_SNO  = to_number(#{afiOrdrSnoStr})
			]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listPhdpRtrnCnfrYn-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="ntm" column="NTM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listPhdpRtrnCnfrYn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listPhdpRtrnCnfrYn-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listPhdpRtrnCnfrYn"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listPhdpRtrnCnfrYn-result" useCache="true" flushCache="false">
		<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listPhdpRtrnCnfrYn  sdo_mngrtnt_m02$S01_약반납 취소SVC */
					   count(*) as NTM
				 from  SDJDGRTNT
				where  ORDR_YMD         = to_date(#{ordrYmd}, 'yyyymmdd')
				  and  MDTN_NO_DVSN_CD  = #{mdtnNoDvsnCd}
				  and  MDTN_NO          = to_number(#{afiMdtnNoStr})
				  and  MDTN_LCDV_CD     = #{mdtnLcdvCd}
				  and  ORDR_SNO         = to_number(#{afiOrdrSnoStr})
				  and  RTRN_RQST_DT     = to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')
				  and  MDPR_CD          = #{ordrCd}
				  and  RTRN_CNFR_YMD is not null
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrrtRcpcStts-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="dltnYn" column="DLTN_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrrtRcpcStts () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrrtRcpcStts-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrrtRcpcStts"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrrtRcpcStts-result" useCache="true" flushCache="false">
		<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listDrrtRcpcStts  sdo_mngrtnt_m02$S02_약반납 취소SVC */
					   decode(b.RCST_CD, 'R', 'N'
		                                    /* 2021.11.24 홍창한 수정함. 퇴원 후 가퇴원상태에서는 퇴원일자와 상관없이 반납 수정할 수 있도록 수정함. Start
											, decode(sign(nvl(c.DSCH_DT, to_date('29991231', 'yyyymmdd'))-sysdate), -1, 'N'
																													  , decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'))) as DLTN_YN  */
		 									, decode(sign(nvl(c.DSCH_DT, to_date('29991231', 'yyyymmdd'))-sysdate)
		                                           , -1
		                                           -- , 'N'
		                                           , decode(b.CODV_CD, 'I'
		                                                             , (select decode(sign(count(x.PTNO)), 1, decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'), 'N') 
		                                                                  from APRCRPTNT x
		                                                                 where x.MDRP_NO  = b.MDRP_NO 
		                                                                   and nvl(x.CHCK_STTS_CD, 'N')      =  'N'  /* N 미심사, P 심사 완료, I 심사중 */
		                                                                   and nvl(x.DSCH_STTS_CD, '*')      <> '1'  /* 0 계산서 발행, 1 정상퇴원, 2 가퇴원, 3 도주, 9  기타(정퇴원 후 심사 취소) */
		                                                                   and nvl(x.DSCH_CHCK_RQST_YN, 'N') <> 'S'  /* S 심사요청, C 심사 취소 */
		                                                                   and x.CNCL_DT is null)
		                                                             , 'E'
		                                                             , (select decode(sign(count(x.PTNO)), 1, decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'), 'N')
		                                                                  from APRCRPTNT x
		                                                                 where x.MDRP_NO  = b.MDRP_NO 
		                                                                   and nvl(x.MCRC_YN, 'N') in ('N', 'M')     /* N 미수납, M 화면 풀기 */
		                                                                   and x.CNCL_DT is null)
		                                                             , 'N' )
												   , decode(a.RTRN_CNFR_YMD, null, 'Y', 'N'))) as DLTN_YN
		                                    /* 2021.11.24 홍창한 수정함. 퇴원 후 가퇴원상태에서는 퇴원일자와 상관없이 반납 수정할 수 있도록 수정함. End */
				 from
					   SDJDGRTNT a
					,  MDMEDORDT b
					,  APRCRPTNT c
				where
					   a.ORDR_YMD          = to_date(#{ordrYmd}, 'yyyymmdd')
				  and  a.MDTN_NO_DVSN_CD   = #{mdtnNoDvsnCd}
				  and  a.MDTN_NO           = to_number(#{afiMdtnNoStr})
				  and  a.MDTN_LCDV_CD      = #{mdtnLcdvCd}
				  and  a.ORDR_SNO          = to_number(#{afiOrdrSnoStr})
				  and  a.RTRN_RQST_DT      = to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')
				  and  a.MDPR_CD           = #{ordrCd}
				  and  b.PTNO              = a.PTNO
				  and  b.ORDR_YMD          = a.ORDR_YMD
				  and  b.ORDR_SNO          = a.ORDR_SNO
				  and  c.MDRP_NO(+)        = b.MDRP_NO   /*수정했음 */
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnRtrnYn-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="cnt" column="ICNT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnRtrnYn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnRtrnYn-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnRtrnYn"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnRtrnYn-result" useCache="true" flushCache="false">
		<![CDATA[
					   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnRtrnYn  sdo_mngrtnt_m02$S04_약반납 취소SVC */
							   count(*) as ICNT
						 from  MDMEDORDT a
						where  a.PTNO      = #{ptno}
						  and  a.ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
						  and  a.ORDR_SNO  = to_number(#{afiOrdrSnoStr})
						  and  a.RTRN_EXRE_CTN is not null
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnCupQtyRtrnCnfr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="cnt" column="ICNT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnCupQtyRtrnCnfr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnCupQtyRtrnCnfr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnCupQtyRtrnCnfr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnCupQtyRtrnCnfr-result" useCache="true" flushCache="false">
		<![CDATA[
					   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listExcpResnCupQtyRtrnCnfr  sdo_mngrtnt_m02$S05_약반납 취소SVC */
							   count(*) as ICNT
						 from  SDJDGRTNT
						where  ORDR_YMD         = to_date(#{ordrYmd}, 'yyyymmdd')
						  and  MDTN_NO_DVSN_CD  = #{mdtnNoDvsnCd}
						  and  MDTN_NO          = to_number(#{afiMdtnNoStr})
						  and  MDTN_LCDV_CD     = #{mdtnLcdvCd}
						  and  ORDR_SNO         = to_number(#{afiOrdrSnoStr})
						/*  and  RTRN_RQST_DT     = to_date(:mns_jdgrtnt_011[0].rtrn_rqst_dt, 'yyyymmddhh24miss') */
						  and  MDPR_CD          = #{ordrCd}
						  and  DRUG_RTRE_CD     = '6'
						  and  nvl(RTRN_RQST_CQY, 0)  > 0    /*반납요청수량 */
			]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-deleteRtrnInfmDltn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<delete id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-deleteRtrnInfmDltn"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
				   DELETE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-deleteRtrnInfmDltn  sdo_mngrtnt_m02$D01_약반납 취소SVC */
					 from  SDJDGRTNT
					where  ORDR_YMD            = to_date(#{ordrYmd}, 'yyyymmdd')
					  and  MDTN_LCDV_CD        = #{mdtnLcdvCd}                              /*처방일자 */
					  and  MDTN_NO_DVSN_CD     = #{mdtnNoDvsnCd}                           /*투약번호구분코드 */
					  and  MDTN_NO             = to_number(#{afiMdtnNoStr})                /*투약번호 */
					  and  ORDR_SNO            = to_number(#{afiOrdrSnoStr})               /*처방일련번호 */
					  and  MDPR_CD             = #{ordrCd}                                   /*약품코드 */
					  /*and  RTRN_RQST_DT        = to_date(:mns_jdgrtnt_011[0].rtrn_rqst_dt, 'yyyymmddhh24miss') /*반납요청일시 */
					  and  ((DRUG_RTRE_CD = decode(#{drugRtreCd}, '6', '6', DRUG_RTRE_CD)) or
							(DRUG_RTRE_CD is null and #{drugRtreCd} is null and FRST_RGST_SRVR_PRGM_ID like 'mn%' )  /*반납사유안들어간거 간호에서 만든거만 지울수있게 해줬음..왜안들어올꺼 */
						   )
					  and  RTRN_RQST_DT        = decode(#{drugRtreCd}, '6', RTRN_RQST_DT, to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss'))
					  and  RTRN_CNFR_YMD is null
			]]>
	</delete>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrRtrnInfmInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="frnsCtrlDvsnCd" column="FRNS_CTRL_DVSN_CD"/>
		<result property="afiFrnsVlmStr" column="AFI_FRNS_VLM_STR"/>
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
		<result property="afiDdcnStr" column="AFI_DDCN_STR"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="afiPcknUnadQtyStr" column="AFI_PCKN_UNAD_QTY_STR"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="afiIcunAdmnVlmStr" column="AFI_ICUN_ADMN_VLM_STR"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrRtrnInfmInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrRtrnInfmInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrRtrnInfmInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrRtrnInfmInqr-result" useCache="true" flushCache="false">
		<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listOrdrRtrnInfmInqr  sdo_mngrtnt_m02$S06_약반납 취소SVC */
					   nvl(a.MDTN_LCDV_CD, 'M') as MDTN_LCDV_CD
					,  a.FRNS_CTRL_DVSN_CD as FRNS_CTRL_DVSN_CD
					,  a.FRNS_VLM as AFI_FRNS_VLM_STR
					,  nvl(a.NTM, 1) as AFI_NTM_STR
					,  a.DDCN as AFI_DDCN_STR
					,  b.CLNC_EXAM_DRUG_YN as CLNC_EXAM_DRUG_YN
					,  a.PCKN_UNAD_QTY as AFI_PCKN_UNAD_QTY_STR
					,  b.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD
					,  to_char(decode(a.SLCT_UNIT_DVSN_CD, '1', a.PCKN_UNAD_QTY, a.ICUN_ADMN_VLM)) as AFI_ICUN_ADMN_VLM_STR
				 from
					   MDMEDORDT a
					,  MDORDRCMT b
				where  a.PTNO      = #{ptno}
				  and  a.ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
				  and  a.ORDR_SNO  = to_number(#{afiOrdrSnoStr})
				  and  a.MDTN_NO   = to_number(#{afiMdtnNoStr})
				  and  b.ORDR_CD   = a.ORDR_CD
				  and  rownum = 1
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnTablCnfr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="afiNtmStr" column="AFI_NTM_STR"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnTablCnfr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnTablCnfr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnTablCnfr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnTablCnfr-result" useCache="true" flushCache="false">
		<![CDATA[
				   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnTablCnfr  sdo_mngrtnt_m02$S07_약반납 취소SVC */
						   to_char(count(*)) as AFI_NTM_STR
					 from  SDJDGRTNT
					where  PTNO      = #{ptno}                          /* 환자번호   */
					  and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd') /* 처방일자   */
					  and  ORDR_SNO  = to_number(#{afiOrdrSnoStr})           /* 처방순번   */
					  and  MDPR_CD   = #{ordrCd}
			]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnTablExcpResnRtrnCncl () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnTablExcpResnRtrnCncl"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
					   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnTablExcpResnRtrnCncl  sdo_mngrtnt_m02$U01_예외사유 반납취소DAM */
							   SDJDGRTNT
						  set  RTRN_RQST_CQY         = 0
							,  PTAD_RTRN_QTY         = 0
							,  MDPR_RTRN_NTM         = 0
							,  RTRN_CUP_QTY_DVSN_CD  = ''
				,  LAST_UPDR_ID        = #{gvUserId}
				,  LAST_UPDT_IP        = #{gvUserIp}
				,  LAST_UPDT_DT        = sysdate
				,  LAST_UPDT_CLNT_PRGM_ID   = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID   = #{gvSrvrPrgmId} 
						where  PTNO     = #{ptno}
						  and  ORDR_YMD = to_date(#{ordrYmd}, 'yyyymmdd')
						  and  ORDR_SNO = to_number(#{afiOrdrSnoStr})
						  and  RTRN_DETL_DVSN_CD = 'Z'
			]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclDurvYnInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="durvYn" column="DURV_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclDurvYnInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclDurvYnInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclDurvYnInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclDurvYnInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclDurvYnInqr  sdo_mngrtnt_m02$S08_약반납 취소SVC */
				   'Y' as DURV_YN
			 from  MDMEDORDT
			where  PTNO      = #{ptno}
			  and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  ORDR_SNO  = to_number(#{afiOrdrSnoStr})
			  and  (
					  PTAD_CODV_CD = 'E' or PTAD_CODV_CD = 'O' or PTAD_CODV_CD = 'D' or (PTAD_CODV_CD = 'I' and  ODKI_CD = 'D')
				   )
			  and  ORDR_YMD  >= trunc(sysdate)  /*  과거 것은 할 필요가 없다고 함. */
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclOrdrNtmInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="afiDurvRtrnDdcnStr" column="DURV_RTRN_DDCN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclOrdrNtmInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclOrdrNtmInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclOrdrNtmInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclOrdrNtmInqr-result" useCache="true" flushCache="false">
		<![CDATA[
			   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listRtrnCnclOrdrNtmInqr  sdo_mngrtnt_m02$S09_약반납 취소SVC */
					   decode(sign(nvl(c.DDCN, 1)-(b.MDPR_RTRN_NTM/a.NTM)), 1, null, to_char(b.MDPR_RTRN_NTM/a.NTM)) as DURV_RTRN_DDCN
				 from
					   (
					   select
							   nvl(NTM, 1) NTM
						 from  MDMEDORDT
						where  PTNO      = #{ptno}
						  and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
						  and  ORDR_SNO  = to_number(#{afiOrdrSnoStr})
					   )  a
					,  (
					   select  sum(MDPR_RTRN_NTM) MDPR_RTRN_NTM
						 from  SDJDGRTNT
						where  PTNO      = #{ptno}
						  and  ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
						  and  ORDR_SNO  = to_number(#{afiOrdrSnoStr})
					   )  b
					,  MDMEDORDT c
			   where  c.PTNO      = #{ptno}
				 and  c.ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
				 and  c.ORDR_SNO  = to_number(#{afiOrdrSnoStr})
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOne000-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="mdprRtrnNtm" column="MDPR_RTRN_NTM"/>
		<result property="etcYn" column="ETC_YN"/>
		<result property="stdlDetlDvsnCd" column="STDL_DETL_DVSN_CD"/>
		<result property="wodvCd" column="WODV_CD"/>
		<result property="careItdvCd" column="CARE_ITDV_CD"/>
		<result property="mngyn" column="MNGYN"/>
		<result property="afiAbrvDprtNm" column="AFI_ABRV_DPRT_NM"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="dvsnVl" column="DVSN_VL"/>
		<result property="exreRtrnDt" column="EXRE_RTRN_DT"/>
		<result property="orocCd" column="OROC_CD"/>
		<result property="stdlDvsnCd" column="STDL_DVSN_CD"/>
		<result property="drugAdmnQty" column="DRUG_ADMN_QTY"/>
		<result property="ntm" column="NTM"/>
		<result property="rtrnRqstYmd" column="RTRN_RQST_YMD"/>
		<result property="rtrnDetlDvsnCd" column="RTRN_DETL_DVSN_CD"/>
		<result property="rtrnRqstCqy" column="RTRN_RQST_CQY"/>
		<result property="frnsVlm" column="FRNS_VLM"/>
		<result property="rtrnRqstDt2" column="RTRN_RQST_DT_2"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="dschAtmtRtrnYn" column="DSCH_ATMT_RTRN_YN"/>
		<result property="etcCot" column="ETC_COT"/>
		<result property="shdtCd" column="SHDT_CD"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="daySckbTeamCd" column="DAY_SCKB_TEAM_CD"/>
		<result property="ptadRtrnQty" column="PTAD_RTRN_QTY"/>
		<result property="durvRtrnDdcn" column="DURV_RTRN_DDCN"/>
		<result property="dvsnCd" column="DVSN_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOne000 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOne000-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOne000"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOne000-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOne000 */
		SELECT 
			  #{mdprRtrnNtm} as MDPR_RTRN_NTM
			, #{etcYn} as ETC_YN
			, #{stdlDetlDvsnCd} as STDL_DETL_DVSN_CD
			, #{wodvCd} as WODV_CD
			, #{careItdvCd} as CARE_ITDV_CD
			, #{mngyn} as MNGYN
			, #{afiAbrvDprtNm} as AFI_ABRV_DPRT_NM
			, #{pcknUnadQty} as PCKN_UNAD_QTY
			, #{dvsnVl} as DVSN_VL
			, #{exreRtrnDt} as EXRE_RTRN_DT
			, #{orocCd} as OROC_CD
			, #{stdlDvsnCd} as STDL_DVSN_CD
			, #{drugAdmnQty} as DRUG_ADMN_QTY
			, #{ntm} as NTM
			, #{rtrnRqstYmd} as RTRN_RQST_YMD
			, #{rtrnDetlDvsnCd} as RTRN_DETL_DVSN_CD
			, #{rtrnRqstCqy} as RTRN_RQST_CQY
			, #{frnsVlm} as FRNS_VLM
			, #{rtrnRqstDt2} as RTRN_RQST_DT_2
			, #{injcPlacCd} as INJC_PLAC_CD
			, #{dschAtmtRtrnYn} as DSCH_ATMT_RTRN_YN
			, #{etcCot} as ETC_COT
			, #{shdtCd} as SHDT_CD
			, #{mdcrDt} as MDCR_DT
			, #{daySckbTeamCd} as DAY_SCKB_TEAM_CD
			, #{ptadRtrnQty} as PTAD_RTRN_QTY
			, #{durvRtrnDdcn} as DURV_RTRN_DDCN
			, #{dvsnCd} as DVSN_CD
		from dual
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnRnoClbyRmnnQtyInqr-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="rtrnRqstYmd" column="RTRN_RQST_YMD"/>
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="arvlDprtCd" column="ARVL_DPRT_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="rtrnDetlDvsnCd" column="RTRN_DETL_DVSN_CD"/>
		<result property="drugRtreCd" column="DRUG_RTRE_CD"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="careItdvCd" column="CARE_ITDV_CD"/>
		<result property="shdtCd" column="SHDT_CD"/>
		<result property="teamCd" column="TEAM_CD"/>
		<result property="ptadRtrnQty" column="PTAD_RTRN_QTY"/>
		<result property="rtrnRqstCqy" column="RTRN_RQST_CQY"/>
		<result property="rtrnRqprId" column="RTRN_RQPR_ID"/>
		<result property="mdprRtrnNtm" column="MDPR_RTRN_NTM"/>
		<result property="stdlDvsnCd" column="STDL_DVSN_CD"/>
		<result property="rtrnDvsnCd" column="RTRN_DVSN_CD"/>
		<result property="stdlDetlDvsnCd" column="STDL_DETL_DVSN_CD"/>
		<result property="dschAtmtRtrnYn" column="DSCH_ATMT_RTRN_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnRnoClbyRmnnQtyInqr () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnRnoClbyRmnnQtyInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnRnoClbyRmnnQtyInqr"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnRnoClbyRmnnQtyInqr-result" useCache="true" flushCache="false">
		<![CDATA[	
		SELECT /*SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listMdtnRnoClbyRmnnQtyInqr */ 
			   to_char(ORDR_YMD, 'yyyymmdd') as ORDR_YMD
			,  MDTN_LCDV_CD as MDTN_LCDV_CD
			,  MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD
			,  MDTN_NO as MDTN_NO
			,  ORDR_SNO as ORDR_SNO
			,  to_char(RTRN_RQST_YMD, 'yyyymmdd') as RTRN_RQST_YMD
			,  to_char(RTRN_RQST_DT, 'yyyymmddhh24miss') as RTRN_RQST_DT
			,  PTNO as PTNO
			,  PTDV_CD as PTDV_CD
			,  ARVL_DPRT_CD as ARVL_DPRT_CD
			,  PTRM_NO as PTRM_NO
			,  SCKB_NO as SCKB_NO
			,  RTRN_DETL_DVSN_CD as RTRN_DETL_DVSN_CD
			,  DRUG_RTRE_CD as DRUG_RTRE_CD
			,  MDPR_CD as MDPR_CD
			,  CARE_ITDV_CD as CARE_ITDV_CD
			,  SHDT_CD as SHDT_CD
			,  TEAM_CD as TEAM_CD
			,  sum(PTAD_RTRN_QTY) as PTAD_RTRN_QTY
			,  sum(RTRN_RQST_CQY) as RTRN_RQST_CQY
			,  RTRN_RQPR_ID as RTRN_RQPR_ID
			,  MDPR_RTRN_NTM as MDPR_RTRN_NTM
			,  STDL_DVSN_CD as STDL_DVSN_CD
			,  RTRN_DVSN_CD as RTRN_DVSN_CD
			,  STDL_DETL_DVSN_CD as STDL_DETL_DVSN_CD
			,  DSCH_ATMT_RTRN_YN as DSCH_ATMT_RTRN_YN
		  from (
					 select /*+ INDEX(B MNWADACNT_I02) LEADING(B) USE_NL(A) */ -- 힌트 수정
						   a.ORDR_YMD
						,  a.MDTN_LCDV_CD
						,  a.MDTN_NO_DVSN_CD
						,  a.MDTN_NO
						,  a.ORDR_SNO
						,  trunc(b.acim_dt) as RTRN_RQST_YMD
						,  null as RTRN_RQST_DT
						,  a.PTNO
						,  c.PTDV_CD
						,  c.INJC_PLAC_CD as ARVL_DPRT_CD
						,  (select y.care_ptrm_no
							  from APRCRPTNT y
							 where y.mdrp_no = a.mdrp_no) as PTRM_NO
						,  (select y.care_sckb_no
							  from APRCRPTNT y
							 where y.mdrp_no = a.mdrp_no) as SCKB_NO
						,  'Z' as RTRN_DETL_DVSN_CD
						,  '6' as DRUG_RTRE_CD
						,  c.MDPR_CD
						,  'R' as CARE_ITDV_CD
						,  null SHDT_CD
						,  (select DAY_SCKB_TEAM_CD
							  from MNWBTEAMT x
								 , APRCRPTNT y
							 where x.WARD_CD = y.care_ward_cd
							   and  x.PTRM_NO = y.care_ptrm_no
							   and  x.SCKB_NO = y.care_sckb_no
							   and y.mdrp_no = a.mdrp_no) as TEAM_CD
						,  b.MDTN_CUP_QTY * d.PCUN_INLS_QTY as PTAD_RTRN_QTY
						,  b.MDTN_CUP_QTY * d.PCUN_INLS_QTY as RTRN_RQST_CQY
						,  #{gvUserId} as RTRN_RQPR_ID
						,  0 as MDPR_RTRN_NTM
						,  'B' as STDL_DVSN_CD
						,  'N' as RTRN_DVSN_CD
						,  case when a.codv_cd = 'O' then 'C'
								when a.codv_cd = 'I' then 'E'
								when a.codv_cd = 'E' then 'G'
								when a.codv_cd = 'D' then 'I'
								when a.codv_cd = 'H' then 'C'
							end as STDL_DETL_DVSN_CD
						,  null DSCH_ATMT_RTRN_YN
					 from mnwadacnt b
						, mdmedordt a
						, SDPORDDET c
						, mdordrcmt d
					where #{dcDvsnCd} <> 'O'
					  and b.ACIM_DT between to_date(#{ordrYmd}||'000000', 'yyyymmddhh24miss') and to_date(#{ordrYmd}||'235959', 'yyyymmddhh24miss')
					  and b.actn_kind_cd is not null
					  and nvl(b.MDTN_CUP_QTY, 0) <> 0
					  and b.ptno = a.ptno
					  and b.ordr_ymd = a.ordr_ymd
					  and b.ordr_sno = a.ordr_sno
					  and a.frns_dprt_cd = #{arvlDprtCd}
					  and a.dc_dvsn_cd not in ('X', 'P', 'E', 'F')
					  and a.orfr_cd <> 'P'
					  and a.mdpr_clsf_cd in ('2', '3')
					  /* and a.ordr_clty_cd = 'B1' */
					  and a.codv_cd in ('I', 'E')
					  and c.ptno = a.ptno
					  and c.ordr_ymd = a.ordr_ymd
					  and c.ordr_sno = a.ordr_sno
					  and a.ordr_cd = d.ordr_cd
				   union all
					select /*+ USE_NL(b a c d) index(b MNIOUTCNT_I02) */
						   a.ORDR_YMD
						,  a.MDTN_LCDV_CD
						,  a.MDTN_NO_DVSN_CD
						,  a.MDTN_NO
						,  a.ORDR_SNO
						,  trunc(b.IJAC_DT) as RTRN_RQST_YMD
						,  null as RTRN_RQST_DT
						,  a.PTNO
						,  c.PTDV_CD
						,  c.INJC_PLAC_CD as ARVL_DPRT_CD
						,  (select y.care_ptrm_no
							  from APRCRPTNT y
							 where y.mdrp_no = a.mdrp_no) as PTRM_NO
						,  (select y.care_sckb_no
							  from APRCRPTNT y
							 where y.mdrp_no = a.mdrp_no) as SCKB_NO
						,  'Z' as RTRN_DETL_DVSN_CD
						,  '6' as DRUG_RTRE_CD
						,  c.MDPR_CD
						,  'R' as CARE_ITDV_CD
						,  null SHDT_CD
						,  (select DAY_SCKB_TEAM_CD
							  from MNWBTEAMT x
								 , APRCRPTNT y
							 where x.WARD_CD = y.care_ward_cd
							   and  x.PTRM_NO = y.care_ptrm_no
							   and  x.SCKB_NO = y.care_sckb_no
							   and y.mdrp_no = a.mdrp_no) as TEAM_CD
						,  b.MDTN_CUP_QTY * d.PCUN_INLS_QTY as PTAD_RTRN_QTY
						,  b.MDTN_CUP_QTY * d.PCUN_INLS_QTY as RTRN_RQST_CQY
						,  #{gvUserId} as RTRN_RQPR_ID
						,  0 as MDPR_RTRN_NTM
						,  'B' as STDL_DVSN_CD
						,  'N' as RTRN_DVSN_CD
						,  case when a.codv_cd = 'O' then 'C'
								when a.codv_cd = 'I' then 'E'
								when a.codv_cd = 'E' then 'G'
								when a.codv_cd = 'D' then 'I'
								when a.codv_cd = 'H' then 'C'
							end as STDL_DETL_DVSN_CD
						,  null DSCH_ATMT_RTRN_YN
					 from mnioutcnt b
						, mdmedordt a
						, SDPORDDET c
						, mdordrcmt d
					where (#{dcDvsnCd} = 'O' or #{dcDvsnCd} = 'ETC')
					  and b.IJAC_DT between to_date(#{ordrYmd}||'000000', 'yyyymmddhh24miss') and to_date(#{ordrYmd}||'235959', 'yyyymmddhh24miss')
					  and b.actn_kind_cd is not null
					  and nvl(b.MDTN_CUP_QTY, 0) <> 0
					  and b.ptno = a.ptno
					  and b.ordr_ymd = a.ordr_ymd
					  and b.ordr_sno = a.ordr_sno
					  and (a.mcdp_cd = #{arvlDprtCd} or a.frns_dprt_cd = #{arvlDprtCd})
					  and a.dc_dvsn_cd not in ('X', 'P', 'E', 'F')
					  and a.orfr_cd <> 'P'
					  and a.mdpr_clsf_cd in ('2', '3')
					  /* and a.ordr_clty_cd = 'B1' */
					  and a.codv_cd in ('O', 'H')
					  and c.ptno = a.ptno
					  and c.ordr_ymd = a.ordr_ymd
					  and c.ordr_sno = a.ordr_sno
					  and a.ordr_cd = d.ordr_cd )
		 group by  ORDR_YMD
				,  MDTN_LCDV_CD
				,  MDTN_NO_DVSN_CD
				,  MDTN_NO
				,  ORDR_SNO
				,  RTRN_RQST_YMD
				,  RTRN_RQST_DT
				,  PTNO
				,  PTDV_CD
				,  ARVL_DPRT_CD
				,  PTRM_NO
				,  SCKB_NO
				,  RTRN_DETL_DVSN_CD
				,  DRUG_RTRE_CD
				,  MDPR_CD
				,  CARE_ITDV_CD
				,  SHDT_CD
				,  TEAM_CD
				,  RTRN_RQPR_ID
				,  MDPR_RTRN_NTM
				,  STDL_DVSN_CD
				,  RTRN_DVSN_CD
				,  STDL_DETL_DVSN_CD
				,  DSCH_ATMT_RTRN_YN
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOneMdtnRnoClbyRmnnQtyYn-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="cnt" column="CNT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOneMdtnRnoClbyRmnnQtyYn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOneMdtnRnoClbyRmnnQtyYn-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOneMdtnRnoClbyRmnnQtyYn"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOneMdtnRnoClbyRmnnQtyYn-result" useCache="true" flushCache="false">
		<![CDATA[	
			select /*SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-selectOneMdtnRnoClbyRmnnQtyYn */
					decode(count(*), 0, 'N', 'Y') as CNT 
			  from SDJDGRTNT x
			 where x.ptno = #{ptno}
			   and x.ordr_ymd = to_date(#{ordrYmd}, 'yyyymmdd')
			   and x.ordr_sno = #{ordrSno}
			   and x.rtrn_detl_dvsn_cd = 'Z'
			   and x.drug_rtre_cd = '6'
		   		]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-insertMdtnRnoClbyRmnnQty () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<insert id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-insertMdtnRnoClbyRmnnQty"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
			INSERT  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-insertMdtnRnoClbyRmnnQty */
				into SDJDGRTNT
				(
					  ORDR_YMD
					, MDTN_LCDV_CD
					, MDTN_NO_DVSN_CD
					, MDTN_NO
					, ORDR_SNO
					, RTRN_RQST_YMD
					, RTRN_RQST_DT
					, PTNO
					, PTDV_CD
					, ARVL_DPRT_CD
					, PTRM_NO
					, SCKB_NO
					, RTRN_DETL_DVSN_CD
					, DRUG_RTRE_CD
					, MDPR_CD
					, CARE_ITDV_CD
					, SHDT_CD
					, TEAM_CD
					, PTAD_RTRN_QTY
					, RTRN_RQST_CQY
					, RTRN_RQPR_ID
					, RTRN_RQST_IP
					, MDPR_RTRN_NTM
					, STDL_DVSN_CD
					, RTRN_DVSN_CD
					, STDL_DETL_DVSN_CD
					, DSCH_ATMT_RTRN_YN
					, FRNS_RTRN_CQY
					, FRST_RGSR_ID
					, FRST_RGST_IP
					, FRST_RGST_DT
					, FRST_RGST_CLNT_PRGM_ID
					, FRST_RGST_SRVR_PRGM_ID
					, LAST_UPDR_ID
					, LAST_UPDT_IP
					, LAST_UPDT_DT
					, LAST_UPDT_CLNT_PRGM_ID
					, LAST_UPDT_SRVR_PRGM_ID
				)
				values (
					  to_date(#{ordrYmd}, 'yyyymmdd')
					, #{mdtnLcdvCd}
					, #{mdtnNoDvsnCd}
					, #{mdtnNo}
					, #{ordrSno}
					, to_date(#{rtrnRqstYmd}, 'yyyymmdd')
					, sysdate
					, #{ptno}
					, #{ptdvCd}
					, #{arvlDprtCd}
					, #{ptrmNo}
					, #{sckbNo}
					, #{rtrnDetlDvsnCd}
					, #{drugRtreCd}
					, #{mdprCd}
					, #{careItdvCd}
					, null
					, #{teamCd}
					, #{ptadRtrnQty}
					, #{rtrnRqstCqy}
					, #{rtrnRqprId}
					, #{gvUserIp}
					, #{mdprRtrnNtm}
					, #{stdlDvsnCd}
					, #{rtrnDvsnCd}
					, #{stdlDetlDvsnCd}
					, null
					, null		
					, #{gvUserId}
					, #{gvUserIp}
					, SYSDATE
					, #{gvClntPrgmId}
					, #{gvSrvrPrgmId}
					, #{gvUserId}
					, #{gvUserIp}
					, SYSDATE
					, #{gvClntPrgmId}
					, #{gvSrvrPrgmId}		   
				)
			]]>
	</insert>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-deleteMdtnRnoClbyRmnnQty () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<delete id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-deleteMdtnRnoClbyRmnnQty"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
			delete /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-deleteMdtnRnoClbyRmnnQty */
				   SDJDGRTNT x
			 where x.ptno = #{ptno}
			   and x.ordr_ymd = to_date(#{ordrYmd}, 'yyyymmdd')
			   and x.ordr_sno = #{ordrSno}
			   and x.rtrn_detl_dvsn_cd = 'Z'
			   and x.drug_rtre_cd = '6'
			]]>
	</delete>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnCarePrinInfo () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnCarePrinInfo"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE  /*+ SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateRtrnCarePrinInfo */
				   SDJDGRTNT
			  set
				   CARE_PRIN_DT        = SYSDATE
				,  CARE_PNPR_ID        = #{gvUserId}
				,  CARE_PNPR_IP        = #{gvUserIp}
				,  LAST_UPDR_ID        = #{gvUserId}
				,  LAST_UPDT_IP        = #{gvUserIp}
				,  LAST_UPDT_DT        = SYSDATE
				,  LAST_UPDT_CLNT_PRGM_ID   = #{gvClntPrgmId}
				,  LAST_UPDT_SRVR_PRGM_ID   = #{gvSrvrPrgmId}
			where
				   ORDR_YMD    = to_date(#{ordrYmd}, 'yyyymmdd')
			  and  MDTN_LCDV_CD = #{mdtnLcdvCd}
			  and  MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
			  and  MDTN_NO = #{mdtnNo}
			  and  ORDR_SNO = #{ordrSno}
			  and  RTRN_RQST_DT = to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')
			  and  MDPR_CD = #{mdprCd}
			]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNursDrugRtrnRefnCncl2 (약품 반납 신청 후 약제팀 반납확인 전 환불 된 내역 환불 취소(투약처방)) 
        Description :                                           약품 반납 신청 후 약제팀 반납확인 전 환불 된 내역 환불 취소(투약처방)
                                            
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNursDrugRtrnRefnCncl2"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE /*+SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNursDrugRtrnRefnCncl2 */
				  MDMEDORDT
			  set
		          RTRN_STTS_CD        = 'N'     /* 반납상태코드 */
		        , RCPC_DT             = null    /* 수납일시 */
		        , RCST_CD             = 'N'     /* 수납상태코드 */
		        , RPNT_ID             = ''      /* 수납자ID */
		        , VIA_ADMS_RCST_CD    = 'N'     /* 경유입원수납상태코드 */
		        , PHRM_RTRN_QTY       = 0       /* 약국반납량 */
		        , PACL_AFTR_DRRT_QTY  = 0       /* 원무계산이후약반납량 */       
				, LAST_UPDR_ID        = #{gvUserId}
				, LAST_UPDT_IP        = #{gvUserIp}
				, LAST_UPDT_DT        = SYSDATE
				, LAST_UPDT_CLNT_PRGM_ID   = #{gvClntPrgmId}
				, LAST_UPDT_SRVR_PRGM_ID   = #{gvSrvrPrgmId}
			where
				  ptno     = #{ptno}
			  and ordr_ymd = to_date(#{ordrYmd}, 'YYYYMMDD')
			  and ordr_sno = to_number(#{afiOrdrSnoStr})
		]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNursDrugRtrnRefnCncl (약품 반납 신청 후 약제팀 반납확인 전 환불 된 내역 환불 취소(처방성약품반납관리)) 
        Description :                                           약품 반납 신청 후 약제팀 반납확인 전 환불 된 내역 환불 취소(처방성약품반납관리)
                                            
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNursDrugRtrnRefnCncl"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  >
		<![CDATA[
		   UPDATE /*+SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-updateNursDrugRtrnRefnCncl */ 
				  SDJDGRTNT
			  set 
		          REFN_YN              = null
				, LAST_UPDR_ID         = #{gvUserId}
				, LAST_UPDT_IP         = #{gvUserIp}
				, LAST_UPDT_DT         = sysdate
				, LAST_UPDT_CLNT_PRGM_ID    = #{gvClntPrgmId}
				, LAST_UPDT_SRVR_PRGM_ID    = #{gvSrvrPrgmId}
			where 
		          ORDR_YMD             = to_date(#{ordrYmd}, 'yyyymmdd')
			  and MDTN_NO_DVSN_CD      = #{mdtnNoDvsnCd}
			  and MDTN_NO              = to_number(#{afiMdtnNoStr})
			  and MDTN_LCDV_CD         = #{mdtnLcdvCd}
			  and ORDR_SNO             = to_number(#{afiOrdrSnoStr})
			  and RTRN_RQST_DT         = to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')
			  and MDPR_CD              = #{ordrCd}
			  and RTRN_CNFR_YMD is null 
			]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTempSQL-result" type="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO">
	
		<result property="carePnprId" column="CARE_PNPR_ID"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTempSQL () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO
		resultMap : com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTempSQL-result
    -->
	<select id="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTempSQL"  parameterType="com.sds.healthcare.ehr.med.mn.mnm.vo.MnmNursDrugRtrnMngmDVO"  resultMap="com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTempSQL-result" useCache="true" flushCache="false">
		<![CDATA[
		/*SQL_ID: com-sds-healthcare-ehr-med-mn-mnm-dao-MnmNursDrugRtrnMngmDAO-listTempSQL */
		select 
		       '' as CARE_PNPR_ID
		  from dual
		]]>
	</select>



</mapper>