<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : mapper_MdpOrdrCivMngmDAO_sql.xml 
    Description : -->
<mapper namespace="MdpOrdrCivMngmDAO">


	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneOrdrCivMngmDual-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO">
	
		<result property="afiOrglOrdrDcDvsnCd" column="AFI_ORGL_ORDR_DC_DVSN_CD"/>
		<result property="afiTmprOrdrSno" column="AFI_TMPR_ORDR_SNO"/>
		<result property="afiOrglOrdrSaveDvsnVl" column="AFI_ORGL_ORDR_SAVE_DVSN_VL"/>
		<result property="mdppBdwgVl" column="MDPP_BDWG_VL"/>
		<result property="ordrInrfClotYn" column="ORDR_INRF_CLOT_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneOrdrCivMngmDual (DVO Parameter 를 유지하기 위한 DUAL SELECT) 
        Description :                                           DVO Parameter 를 유지하기 위한 DUAL SELECT
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneOrdrCivMngmDual-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneOrdrCivMngmDual"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneOrdrCivMngmDual-result" useCache="true" flushCache="false">
		select  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneOrdrCivMngmDual */
		           '' as AFI_ORGL_ORDR_DC_DVSN_CD
		        ,  0 as AFI_TMPR_ORDR_SNO
		        ,  '' as AFI_ORGL_ORDR_SAVE_DVSN_VL
		        ,  0 as MDPP_BDWG_VL
		        ,  '' as ORDR_INRF_CLOT_YN
		from dual
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOnePtntLtstCivBefOrdr-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO">
	
		<result property="saveDvsnCd" column="SAVE_DVSN_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="orglOrdrYmd" column="ORGL_ORDR_YMD"/>
		<result property="orglOrdrSno" column="ORGL_ORDR_SNO"/>
		<result property="civInptDt" column="CIV_INPT_DT"/>
		<result property="civIfsnSpedVl" column="CIV_IFSN_SPED_VL"/>
		<result property="civIfsnSpedUnitCd" column="CIV_IFSN_SPED_UNIT_CD"/>
		<result property="civIfsnSpedHhunCd" column="CIV_IFSN_SPED_HHUN_CD"/>
		<result property="civIfsnVlm" column="CIV_IFSN_VLM"/>
		<result property="civIfsnVlunCd" column="CIV_IFSN_VLUN_CD"/>
		<result property="civIfsnVlmHhunCd" column="CIV_IFSN_VLM_HHUN_CD"/>
		<result property="civMdppBdwgVl" column="CIV_MDPP_BDWG_VL"/>
		<result property="blsgVl" column="BLSG_VL"/>
		<result property="apttHh" column="APTT_HH"/>
		<result property="civMdteGoalCtn" column="CIV_MDTE_GOAL_CTN"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="careSttsCd" column="CARE_STTS_CD"/>
		<result property="adtnOrdvCd" column="ADTN_ORDV_CD"/>
		<result property="rgorFndrId" column="RGOR_FNDR_ID"/>
		<result property="rgorFinsDt" column="RGOR_FINS_DT"/>
		<result property="orcnNursId" column="ORCN_NURS_ID"/>
		<result property="orcnDt" column="ORCN_DT"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="dcOddrId" column="DC_ODDR_ID"/>
		<result property="dcOrdrDt" column="DC_ORDR_DT"/>
		<result property="dcCnnuId" column="DC_CNNU_ID"/>
		<result property="dcCnfrDt" column="DC_CNFR_DT"/>
		<result property="inptUserDvsnCd" column="INPT_USER_DVSN_CD"/>
		<result property="crtfDvsnCd" column="CRTF_DVSN_CD"/>
		<result property="athnId" column="ATHN_ID"/>
		<result property="crtfIp" column="CRTF_IP"/>
		<result property="crtfDt" column="CRTF_DT"/>
		<result property="lnkdOrdrCd" column="LNKD_ORDR_CD"/>
		<result property="ordrCrtnDvsnCd" column="ORDR_CRTN_DVSN_CD"/>
		<result property="ordrCrtnLnknNo" column="ORDR_CRTN_LNKN_NO"/>
		<result property="civClclDvsnCd" column="CIV_CLCL_DVSN_CD"/>
		<result property="ordrCltyCd" column="ORDR_CLTY_CD"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="ordrPsblDvsnCd" column="ORDR_PSBL_DVSN_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOnePtntLtstCivBefOrdr (CIV 전처방 조회) 
        Description :                                           CIV 전처방을 조회한다.
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOnePtntLtstCivBefOrdr-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOnePtntLtstCivBefOrdr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOnePtntLtstCivBefOrdr-result" useCache="true" flushCache="false">
		<![CDATA[
		   SELECT  /*+ SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOnePtntLtstCivBefOrdr_최근전처방_CIV처방조회 */
				   'S'  as SAVE_DVSN_CD
				,  PTNO as PTNO
				,  to_char(ORDR_YMD, 'yyyymmdd') as ORDR_YMD
				,  ORDR_SNO as ORDR_SNO
				,  CODV_CD as CODV_CD
				,  OROC_DPRT_CD as OROC_DPRT_CD
				,  to_char(ORGL_INJC_ORDR_YMD, 'yyyymmdd') as ORGL_ORDR_YMD
				,  ORGL_INJC_ORDR_SNO as ORGL_ORDR_SNO
				 ,  to_char ( CIV_INPT_DT, 'YYYYMMDDhh24miss') as CIV_INPT_DT
				,  CIV_IFSN_SPED_VL as CIV_IFSN_SPED_VL
				,  CIV_IFSN_SPED_UNIT_CD as CIV_IFSN_SPED_UNIT_CD
				,  CIV_IFSN_SPED_HHUN_CD as CIV_IFSN_SPED_HHUN_CD
				,  CIV_IFSN_VLM as CIV_IFSN_VLM
				,  CIV_IFSN_VLUN_CD as CIV_IFSN_VLUN_CD
				,  CIV_IFSN_VLM_HHUN_CD as CIV_IFSN_VLM_HHUN_CD
				,  CIV_MDPP_BDWG_VL as CIV_MDPP_BDWG_VL
				,  BLSG_VL as BLSG_VL
				,  APTT_HH as APTT_HH
				,  CIV_MDTE_GOAL_CTN as CIV_MDTE_GOAL_CTN
				,  ODDR_ID as ODDR_ID
				,  CARE_STTS_CD as CARE_STTS_CD
				,  ADTN_ORDV_CD as ADTN_ORDV_CD
				,  RGOR_FNDR_ID as RGOR_FNDR_ID
				 ,  to_char ( RGOR_FINS_DT, 'YYYYMMDDhh24miss') as RGOR_FINS_DT
				,  ORCN_NURS_ID as ORCN_NURS_ID
				 ,  to_char ( ORCN_DT, 'YYYYMMDDhh24miss') as ORCN_DT
				,  DC_DVSN_CD as DC_DVSN_CD
				,  DC_ODDR_ID as DC_ODDR_ID
				 ,  to_char ( DC_ORDR_DT, 'YYYYMMDDhh24miss') as DC_ORDR_DT
				,  DC_CNNU_ID as DC_CNNU_ID
				 ,  to_char ( DC_CNFR_DT, 'YYYYMMDDhh24miss') as DC_CNFR_DT
				,  INPT_USER_DVSN_CD as INPT_USER_DVSN_CD
				,  CRTF_DVSN_CD as CRTF_DVSN_CD
				,  ATHN_ID as ATHN_ID
				,  CRTF_IP as CRTF_IP
				 ,  to_char ( CRTF_DT, 'YYYYMMDDhh24miss') as CRTF_DT
				,  LNKD_ORDR_CD as LNKD_ORDR_CD
				,  ORDR_CRTN_DVSN_CD as ORDR_CRTN_DVSN_CD
				,  ORDR_CRTN_LNKN_NO as ORDR_CRTN_LNKN_NO
				,  CIV_CLCL_DVSN_CD as CIV_CLCL_DVSN_CD
				,  'CIV' as ORDR_CLTY_CD
				,  'CIV' as ORDR_CD
				,  'CIV' as DRUS_CD
				,  'Y'   as ORDR_PSBL_DVSN_CD				
			 from (
					 SELECT 
							 'S' SAVE_DVSN_CD
						  ,  PTNO
						  ,  ORDR_YMD
						  ,  ORDR_SNO
						  ,  CODV_CD
						  ,  OROC_DPRT_CD
						  ,  ORGL_INJC_ORDR_YMD
						  ,  ORGL_INJC_ORDR_SNO
						  ,  CIV_INPT_DT
						  ,  CIV_IFSN_SPED_VL
						  ,  CIV_IFSN_SPED_UNIT_CD
						  ,  CIV_IFSN_SPED_HHUN_CD
						  ,  CIV_IFSN_VLM
						  ,  CIV_IFSN_VLUN_CD
						  ,  CIV_IFSN_VLM_HHUN_CD
						  ,  CIV_MDPP_BDWG_VL
						  ,  BLSG_VL
						  ,  APTT_HH
						  ,  CIV_MDTE_GOAL_CTN
						  ,  ODDR_ID
						  ,  CARE_STTS_CD
						  ,  ADTN_ORDV_CD
						  ,  RGOR_FNDR_ID
						  ,  RGOR_FINS_DT
						  ,  ORCN_NURS_ID
						  ,  ORCN_DT
						  ,  DC_DVSN_CD
						  ,  DC_ODDR_ID
						  ,  DC_ORDR_DT
						  ,  DC_CNNU_ID
						  ,  DC_CNFR_DT
						  ,  INPT_USER_DVSN_CD
						  ,  CRTF_DVSN_CD
						  ,  ATHN_ID
						  ,  CRTF_IP
						  ,  CRTF_DT
						  ,  LNKD_ORDR_CD
						  ,  ORDR_CRTN_DVSN_CD
						  ,  ORDR_CRTN_LNKN_NO						  
						  ,  CIV_CLCL_DVSN_CD
						  ,  rank() over (order by ORDR_SNO desc)    as RANK
					   from  MDCIVORDT
					  where  PTNO = #{ptno}
						and  ORDR_YMD = to_date ( #{ordrYmd}, 'YYYYMMDD' )
						and  ORGL_INJC_ORDR_YMD = to_date ( #{orglOrdrYmd}, 'YYYYMMDD' )
						and  ORGL_INJC_ORDR_SNO = #{orglOrdrSno}
						and  DC_DVSN_CD = 'N'
				  )
			where RANK = 1
			]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneCivOrdrSno-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO">
	
		<result property="ordrSno" column="ORDR_SNO"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneCivOrdrSno (Civ 처방 Sequence 조회) 
        Description :                                           Civ 처방 처방일련번호에 사용되는 sequence를 조회한다.
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneCivOrdrSno-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneCivOrdrSno"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneCivOrdrSno-result" useCache="true" flushCache="false">
		select  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-selectOneCivOrdrSno */
		          MDCIVORDTQ.nextval as ORDR_SNO
		 from  dual
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-insertCivOrdr (CIV 처방 저장) 
        Description :                                           환자 치료를 위한 처방 내림 중 CIV 처방을 저장한다.
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO
    -->	
	<insert id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-insertCivOrdr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO"  >
		INSERT  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-insertCivOrdr */
		into  MDCIVORDT
		(
		       PTNO
		       ,  ORDR_YMD
		       ,  ORDR_SNO
		       ,  CODV_CD
		       ,  OROC_DPRT_CD
		       ,  TMPR_ORDR_YN
		       ,  ORGL_INJC_ORDR_YMD
		       ,  ORGL_INJC_ORDR_SNO
		       ,  CIV_INPT_DT             /*  CIV입력일시 */
		       ,  CIV_CLCL_DVSN_CD        /*  CIV계산구분코드 */
		       ,  CIV_IFSN_SPED_VL        /*  CIV주입속도값 */
		       ,  CIV_IFSN_SPED_UNIT_CD   /*  CIV주입속도단위코드 */
		       ,  CIV_IFSN_SPED_HHUN_CD   /*  CIV주입속도시간단위코드 */
		       ,  CIV_IFSN_VLM            /*  CIV주입용량 */
		       ,  CIV_IFSN_VLUN_CD        /*  CIV주입용량단위코드 */
		       ,  CIV_IFSN_VLM_HHUN_CD    /*  CIV주입용량시간단위코드 */
		       ,  CIV_MDPP_BDWG_VL        /*  CIV투약용체중값 */
		       ,  BLSG_VL                 /*  혈당값 */
		       ,  APTT_HH                 /*  APTT시간 */
		       ,  CIV_MDTE_GOAL_CTN       /*  CIV치료목표내용 */
		       ,  LNKD_ORDR_CD            /*  연계처방코드 */
		       ,  ODDR_ID                 /*  처방의사ID */
		       ,  CIV_MDSS_CD             /*  CIV투약상태코드 */
		       ,  CARE_STTS_CD            /*  간호상태코드 */
		       ,  ADTN_ORDV_CD            /*  추가처방구분코드 */
		       ,  RGOR_FNDR_ID            /*  정규처방완료의사ID */
		       ,  RGOR_FINS_DT            /*  정규처방완료일시 */
		       ,  ORCN_NURS_ID            /*  처방확인간호사ID */
		       ,  DC_DVSN_CD              /*  DC구분코드 */
		       ,  INPT_USER_DVSN_CD       /*  입력사용자구분코드 */
		       ,  CRTF_DVSN_CD            /*  인증구분코드 */
		       ,  ATHN_ID                 /*  인증자ID */
		       ,  CRTF_IP                 /*  인증IP */
		       ,  CRTF_DT                 /*  인증일시 */
		       ,  ORDR_CRTN_DVSN_CD
		       ,  ORDR_CRTN_LNKN_NO
		       ,  ORCN_DT
		       ,  FRST_RGSR_ID
		       ,  FRST_RGST_IP
		       ,  FRST_RGST_DT
		       ,  FRST_RGST_CLNT_PRGM_ID
		       ,  FRST_RGST_SRVR_PRGM_ID
		       ,  LAST_UPDR_ID
		       ,  LAST_UPDT_IP
		       ,  LAST_UPDT_DT
		       ,  LAST_UPDT_CLNT_PRGM_ID
		       ,  LAST_UPDT_SRVR_PRGM_ID
		       ,  ORDR_UPDT_DT             /* 처방수정일시*/
		       ,  ORDR_UPDR_ID             /* 처방수정자ID*/
		)
		values  (
		          #{ptno}
		        , to_date ( #{ordrYmd}, 'YYYYMMDD' )
		        , #{ordrSno}
		        , #{codvCd}
		        , #{orocDprtCd}
		        , #{tmprOrdrYn}
		        , to_date ( #{orglOrdrYmd}, 'YYYYMMDD' )
		        , #{orglOrdrSno}
		        , case when #{civInptDt} is not null
		               then to_date ( #{civInptDt}, 'YYYYMMDDhh24miss' )
		               else sysdate end
		        , #{civClclDvsnCd}
		        , #{civIfsnSpedVl}
		        , #{civIfsnSpedUnitCd}
		        , #{civIfsnSpedHhunCd}
		        , #{civIfsnVlm}
		        , #{civIfsnVlunCd}
		        , #{civIfsnVlmHhunCd}
		        , #{civMdppBdwgVl}
		        , #{blsgVl}
		        , #{apttHh}
		        , #{civMdteGoalCtn}
		        , #{lnkdOrdrCd}
		        , #{oddrId}
		        , #{civMdssCd}
		        , #{careSttsCd}
		        , #{adtnOrdvCd}
		        , #{rgorFndrId}
		        , to_date ( #{rgorFinsDt}, 'YYYYMMDDhh24miss' )
		        , #{orcnNursId}
		        , #{dcDvsnCd}
		        , #{inptUserDvsnCd}
		        ,  case when #{crtfDvsnCd} is null then '0' else #{crtfDvsnCd} end  /* 인증구분코드*/
		        , #{athnId}
		        , #{crtfIp}
		        , to_date ( #{crtfDt}, 'YYYYMMDDhh24miss' )
		        , #{ordrCrtnDvsnCd}
		        , #{ordrCrtnLnknNo}
		        , to_date ( #{orcnDt}, 'YYYYMMDDhh24miss' )
		        , #{gvUserId}             /* 최초등록자ID */
		        , #{gvUserIp}                  /* 최초등록IP */
		        , to_date ( #{frstRgstDt}, 'YYYYMMDDhh24miss') /* 최초등록일시 */
		        , #{gvClntPrgmId}                 /* 최초등록SMC클라이언트프로그램ID */
		        , #{gvSrvrPrgmId}                 /* 최초등록SMC서버프로그램ID */
		        , #{gvUserId}             /* 최종수정자ID */
		        , #{gvUserIp}                  /* 최종수정IP */
		        , to_date ( #{frstRgstDt}, 'YYYYMMDDhh24miss') /* 최종수정일시 */
		        , #{gvClntPrgmId}                 /* 최종수정SMC클라이언트프로그램ID */
		        , #{gvSrvrPrgmId}                 /* 최종수정SMC서버프로그램ID */
		        , to_date ( #{frstRgstDt}, 'YYYYMMDDhh24miss') /* 처방수정일시*/
		        , #{gvUserId}                                     /* 처방수정자ID*/
		)
	</insert>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-updateCivOrdr (CIV 처방 수정) 
        Description :                                           CIV 처방을 수정한다.
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-updateCivOrdr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO"  >
		UPDATE  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-updateCivOrdr */
		             MDCIVORDT
		       set  CIV_INPT_DT = case when #{civInptDt} is null
		                                          then CIV_INPT_DT
		                                          else to_date ( #{civInptDt}, 'YYYYMMDDhh24miss' ) end  /*  CIV입력일시 */
		          ,  CIV_IFSN_SPED_VL = case when #{civIfsnSpedVl} is null
		                                                 then CIV_IFSN_SPED_VL
		                                                 else #{civIfsnSpedVl} end  /*  CIV주입속도값 */
		         ,  CIV_IFSN_VLM = case when #{civIfsnVlm} is null
		                                          then CIV_IFSN_VLM
		                                          else #{civIfsnVlm} end /*  CIV주입용량 */
		         ,  CIV_MDPP_BDWG_VL = case when #{civMdppBdwgVl} is null
		                                                    then CIV_MDPP_BDWG_VL
		                                                    else #{civMdppBdwgVl} end /*  CIV투약용체중값 */
		         ,  BLSG_VL = case when #{blsgVl} is null
		                                  then BLSG_VL
		                                  else #{blsgVl} end /*  혈당값 */
		         ,  APTT_HH = case when #{apttHh} is null
		                                   then APTT_HH
		                                   else #{apttHh} end/*  APTT시간 */
		         ,  CIV_MDTE_GOAL_CTN = case when #{civMdteGoalCtn} is null
		                                                    then CIV_MDTE_GOAL_CTN
		                                                    else #{civMdteGoalCtn} end /*  CIV치료목표내용 */
		         ,  LAST_UPDR_ID = #{gvUserId}       /*  최종수정자ID */
		         ,  LAST_UPDT_IP = #{gvUserIp}            /*  최종수정IP */
		         ,  LAST_UPDT_DT = sysdate                /*  최종수정일시 */
		         ,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}           /*  최종수정SMC클라이언트프로그램ID */
		         ,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}           /*  최종수정SMC서버프로그램ID */
		         ,  ORDR_UPDT_DT = sysdate                /*  처방수정일시*/
		         ,  ORDR_UPDR_ID = #{gvUserId}       /*  처방수정자ID*/
		 where  PTNO = #{ptno}
		   and  ORDR_YMD = to_date ( #{ordrYmd}, 'YYYYMMDD' ) /* 처방일자 */
		   and  ORDR_SNO = #{ordrSno}                         /* 처방일련번호 */
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-updateCivOrdrDc (CIV처방 DC 및 취소) 
        Description :                                           CIV처방을 DC 및 취소한다.
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-updateCivOrdrDc"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO"  >
		     UPDATE  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-updateCivOrdrDc */
		             MDCIVORDT a
		        set  DC_DVSN_CD = case when ((select DC_DVSN_CD
		                                       from MDMEDORDT
		                                      where PTNO = a.PTNO
		                                        and ORDR_YMD = a.ORGL_INJC_ORDR_YMD
		                                        and ORDR_SNO = a.ORGL_INJC_ORDR_SNO) = 'N')
		                               then #{dcDvsnCd}
		                               else (case when (#{dcDvsnCd} <![CDATA[ <> ]]> (select DC_DVSN_CD
		                                                                                from MDMEDORDT
		                                                                               where PTNO = a.PTNO
		                                                                                 and ORDR_YMD = a.ORGL_INJC_ORDR_YMD
		                                                                                 and ORDR_SNO = a.ORGL_INJC_ORDR_SNO))
		                                          then (select DC_DVSN_CD
		                                                  from MDMEDORDT
		                                                 where PTNO = a.PTNO
		                                                   and ORDR_YMD = a.ORGL_INJC_ORDR_YMD
		                                                   and ORDR_SNO = a.ORGL_INJC_ORDR_SNO)
		                                          else #{dcDvsnCd}
		                                      end)
		                           end  
		          ,  DC_ODDR_ID = #{dcOddrId}
		          ,  DC_ORDR_DT = to_date ( #{dcOrdrDt}, 'YYYYMMDDhh24miss' )
		          ,  CNCL_CNNU_ID = decode(#{dcDvsnCd}, 'X'
		                                              , #{dcOddrId}
		                                              , (case when (select DC_DVSN_CD
		                                                              from MDMEDORDT
		                                                             where PTNO = a.PTNO
		                                                               and ORDR_YMD = a.ORGL_INJC_ORDR_YMD
		                                                               and ORDR_SNO = a.ORGL_INJC_ORDR_SNO) = 'X'
		                                                      then #{dcOddrId}
		                                                      else null
		                                                  end)
		                                  )
		          ,  CNCL_CNFR_DT = decode(#{dcDvsnCd}, 'X'
		                                              , to_date ( #{dcOrdrDt}, 'YYYYMMDDhh24miss' )
		                                              , (case when (select DC_DVSN_CD
		                                                              from MDMEDORDT
		                                                             where PTNO = a.PTNO
		                                                               and ORDR_YMD = a.ORGL_INJC_ORDR_YMD
		                                                               and ORDR_SNO = a.ORGL_INJC_ORDR_SNO) = 'X'
		                                                      then to_date ( #{dcOrdrDt}, 'YYYYMMDDhh24miss' )
		                                                      else null
		                                                  end)
		                                  )
		          ,  LAST_UPDR_ID = #{gvUserId}     /*  최종수정자ID                  */
		          ,  LAST_UPDT_IP = #{gvUserIp}          /*  최종수정IP                    */
		          ,  LAST_UPDT_DT = to_date ( #{dcOrdrDt}, 'YYYYMMDDhh24miss' )              /*  최종수정일시                     */
		          ,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}    /*  최종수정SMC클라이언트프로그램ID */
		          ,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}    /*  최종수정SMC서버프로그램ID      */
		 where  PTNO = #{ptno}
		    and  ORDR_YMD = to_date ( #{ordrYmd}, 'YYYYMMDD' ) /* 처방일자 */
		    and  ORDR_SNO = #{ordrSno}                         /* 처방일련번호 */
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-listBefOrdrCivList-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO">
	
		<result property="saveDvsnCd" column="SAVE_DVSN_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="tmprOrdrYn" column="TMPR_ORDR_YN"/>
		<result property="orglOrdrYmd" column="ORGL_ORDR_YMD"/>
		<result property="orglOrdrSno" column="ORGL_ORDR_SNO"/>
		<result property="civInptDt" column="CIV_INPT_DT"/>
		<result property="civClclDvsnCd" column="CIV_CLCL_DVSN_CD"/>
		<result property="civIfsnSpedVl" column="CIV_IFSN_SPED_VL"/>
		<result property="civIfsnSpedUnitCd" column="CIV_IFSN_SPED_UNIT_CD"/>
		<result property="civIfsnSpedHhunCd" column="CIV_IFSN_SPED_HHUN_CD"/>
		<result property="civIfsnVlm" column="CIV_IFSN_VLM"/>
		<result property="civIfsnVlunCd" column="CIV_IFSN_VLUN_CD"/>
		<result property="civIfsnVlmHhunCd" column="CIV_IFSN_VLM_HHUN_CD"/>
		<result property="civMdppBdwgVl" column="CIV_MDPP_BDWG_VL"/>
		<result property="blsgVl" column="BLSG_VL"/>
		<result property="apttHh" column="APTT_HH"/>
		<result property="civMdteGoalCtn" column="CIV_MDTE_GOAL_CTN"/>
		<result property="lnkdOrdrCd" column="LNKD_ORDR_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="civMdssCd" column="CIV_MDSS_CD"/>
		<result property="careSttsCd" column="CARE_STTS_CD"/>
		<result property="adtnOrdvCd" column="ADTN_ORDV_CD"/>
		<result property="rgorFndrId" column="RGOR_FNDR_ID"/>
		<result property="rgorFinsDt" column="RGOR_FINS_DT"/>
		<result property="orcnNursId" column="ORCN_NURS_ID"/>
		<result property="orcnDt" column="ORCN_DT"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="dcOddrId" column="DC_ODDR_ID"/>
		<result property="dcOrdrDt" column="DC_ORDR_DT"/>
		<result property="dcCnnuId" column="DC_CNNU_ID"/>
		<result property="dcCnfrDt" column="DC_CNFR_DT"/>
		<result property="inptUserDvsnCd" column="INPT_USER_DVSN_CD"/>
		<result property="crtfDvsnCd" column="CRTF_DVSN_CD"/>
		<result property="athnId" column="ATHN_ID"/>
		<result property="crtfIp" column="CRTF_IP"/>
		<result property="crtfDt" column="CRTF_DT"/>
		<result property="ordrCrtnDvsnCd" column="ORDR_CRTN_DVSN_CD"/>
		<result property="ordrCrtnLnknNo" column="ORDR_CRTN_LNKN_NO"/>
		<result property="mdrpNo" column="MDRP_NO"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-listBefOrdrCivList (CIV 처방 조회) 
        Description :                                           환자의 CIV 처방 정보를 조회한다.
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-listBefOrdrCivList-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-listBefOrdrCivList"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpOrdrCivMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-listBefOrdrCivList-result" useCache="true" flushCache="false">
		SELECT  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpOrdrCivMngmDAO-listBefOrdrCivList */
		            'S'  as SAVE_DVSN_CD
		         ,  PTNO as PTNO
		         ,  to_char(ORDR_YMD, 'yyyymmdd') as ORDR_YMD
		         ,  ORDR_SNO as ORDR_SNO
		         ,  CODV_CD as CODV_CD
		         ,  OROC_DPRT_CD as OROC_DPRT_CD
		         ,  TMPR_ORDR_YN as TMPR_ORDR_YN
		         ,  to_char(ORGL_INJC_ORDR_YMD, 'yyyymmdd') as ORGL_ORDR_YMD
		         ,  ORGL_INJC_ORDR_SNO as ORGL_ORDR_SNO
		         ,  to_char ( CIV_INPT_DT, 'YYYYMMDDhh24miss') as CIV_INPT_DT
		         ,  CIV_CLCL_DVSN_CD as CIV_CLCL_DVSN_CD
		         ,  CIV_IFSN_SPED_VL as CIV_IFSN_SPED_VL
		         ,  CIV_IFSN_SPED_UNIT_CD as CIV_IFSN_SPED_UNIT_CD
		         ,  CIV_IFSN_SPED_HHUN_CD as CIV_IFSN_SPED_HHUN_CD
		         ,  CIV_IFSN_VLM as CIV_IFSN_VLM
		         ,  CIV_IFSN_VLUN_CD as CIV_IFSN_VLUN_CD
		         ,  CIV_IFSN_VLM_HHUN_CD as CIV_IFSN_VLM_HHUN_CD
		         ,  CIV_MDPP_BDWG_VL as CIV_MDPP_BDWG_VL
		         ,  BLSG_VL as BLSG_VL
		         ,  APTT_HH as APTT_HH
		         ,  CIV_MDTE_GOAL_CTN as CIV_MDTE_GOAL_CTN
		         ,  LNKD_ORDR_CD as LNKD_ORDR_CD
		         ,  ODDR_ID as ODDR_ID
		         ,  CIV_MDSS_CD as CIV_MDSS_CD
		         ,  CARE_STTS_CD as CARE_STTS_CD
		         ,  ADTN_ORDV_CD as ADTN_ORDV_CD
		         ,  RGOR_FNDR_ID as RGOR_FNDR_ID
		         ,  to_char ( RGOR_FINS_DT, 'YYYYMMDDhh24miss') as RGOR_FINS_DT
		         ,  ORCN_NURS_ID as ORCN_NURS_ID
		         ,  to_char ( ORCN_DT, 'YYYYMMDDhh24miss') as ORCN_DT
		         ,  DC_DVSN_CD as DC_DVSN_CD
		         ,  DC_ODDR_ID as DC_ODDR_ID
		         ,  to_char ( DC_ORDR_DT, 'YYYYMMDDhh24miss') as DC_ORDR_DT
		         ,  DC_CNNU_ID as DC_CNNU_ID
		         ,  to_char ( DC_CNFR_DT, 'YYYYMMDDhh24miss') as DC_CNFR_DT
		         ,  INPT_USER_DVSN_CD as INPT_USER_DVSN_CD
		         ,  CRTF_DVSN_CD as CRTF_DVSN_CD
		         ,  ATHN_ID as ATHN_ID
		         ,  CRTF_IP as CRTF_IP
		         ,  to_char ( CRTF_DT, 'YYYYMMDDhh24miss') as CRTF_DT
		         ,  ORDR_CRTN_DVSN_CD as ORDR_CRTN_DVSN_CD
		         ,  ORDR_CRTN_LNKN_NO as ORDR_CRTN_LNKN_NO
		         ,  (select MDRP_NO 
		               from MDMEDORDT sb
		              where sb.PTNO = a.PTNO
		                and sb.ORDR_YMD = a.ORGL_INJC_ORDR_YMD
		                and sb.ORDR_SNO = a.ORGL_INJC_ORDR_SNO) as MDRP_NO
		  from  MDCIVORDT a
		where  PTNO = #{ptno}
		   and  ORDR_YMD = to_date ( #{ordrYmd}, 'YYYYMMDD' )
		<if test='codvCd == "O"'>
		   and #{codvCd} = 'O'
		   and exists (select 1 
		                 from MDMEDORDT sb
		                    , APRCRPTNT rcr
		                where sb.PTNO = a.PTNO
		                  and sb.ORDR_YMD = a.ORGL_INJC_ORDR_YMD
		                  and sb.ORDR_SNO = a.ORGL_INJC_ORDR_SNO
		                  and sb.MDRP_NO = rcr.MDRP_NO
		                <if test='codvCd == "O" and chdrId != null and chdrId != ""'>
		                  and sb.CHDR_ID = #{chdrId}
		                </if>
		                  and rcr.CNCL_DT is null)
		</if>		
		<choose>
		  <when test='dcDvsnCd=="T"'>
		   and  DC_DVSN_CD = #{dcDvsnCd}
		  </when>  
		  <otherwise>
		   and  DC_DVSN_CD not in ( 'X' , 'F' , 'E', 'T' ) /*  취소, 실처방 전환, 임시처방 취소, 외래당일입원가처방은 조회 제외 */
		   and  DC_DVSN_CD LIKE case when #{dcDvsnCd} <![CDATA[ <> ]]> 'N' then #{dcDvsnCd} end ||'%'
		  </otherwise>
		</choose>
		<![CDATA[		   and  'TRUE' = case when #{ordrSno} > 0   /*  단독 처방 조회 */
		                          then case when ORDR_SNO = #{ordrSno} then 'TRUE' else 'FALSE' end
		                     else 'TRUE' end
		  order by ORGL_INJC_ORDR_SNO, CIV_INPT_DT desc
		]]>
	</select>



</mapper>