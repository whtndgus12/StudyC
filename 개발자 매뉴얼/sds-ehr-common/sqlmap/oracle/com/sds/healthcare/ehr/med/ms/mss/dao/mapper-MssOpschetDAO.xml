<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : mapper_MssOpschetDAO_sql.xml 
    Description : -->
<mapper namespace="MssOpschetDAO">


	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtCd" column="CLNC_OPRT_CD"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="cdNm" column="CD_NM"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="opplCd" column="OPPL_CD"/>
		<result property="afiOpplNm" column="AFI_OPPL_NM"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="opsrNm1" column="OPSR_NM_1"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1-result" useCache="true" flushCache="false">
		<![CDATA[
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1 */
		select a.PTNO as PTNO          /*  환자번호 */
			 , to_char(a.OPRT_YMD,'yyyymmdd') as OPRT_YMD      /*  수술일자 */
			 , a.OPRT_SNO as OPRT_SNO      /*  수술순번 */
			 , to_char(a.OPST_PRRN_DT,'hh24:mi') as OPST_PRRN_DT  /*  수술예정시간 */
			 , a.CSCR_CD as CSCR_CD       /*  CaseCart코드 */
			 , a.CSCR_NM as CSCR_NM       /*  CaseCart명 */
			 , a.CLNC_OPRT_CD as CLNC_OPRT_CD  /*  임상수술코드 */
			 , a.CLNC_OPRT_NM as CLNC_OPRT_NM  /*  임상수술명 */
			 , nvl(a.CNCL_YN,'N') as CNCL_YN       /*  취소여부 */
			 , a.OPRT_STTS_CD as OPRT_STTS_CD  /*  수술상태코드 */
			 ,  ( select F_A.DETL_CD_NM
			 	   from CCCMCDDMT F_A
			 	  where F_A.COMN_GRP_CD  = 'MM126'
			 		and F_A.COMN_DTLS_CD = a.OPRT_STTS_CD) as CD_NM                 /*  수술상태명   */
			 , a.ORDP_CD as ORDP_CD               /*  집도과코드 */
			 ,  decode(a.SBDP_CD, null
			 				   , ( select
			 							F_A.ABRV_DPRT_CD
			 					   from
			 							HZDEPTMMT F_A
			 					  where
			 							F_A.DPRT_CD = a.ORDP_CD
			 					  group by
			 							F_A.ABRV_DPRT_CD )
			 				   ,
			 				   ( select
			 							F_A.ABRV_DPRT_CD
			 					   from
			 							HZDEPTMMT F_A
			 					  where
			 							F_A.DPRT_CD = a.SBDP_CD
			 					  group by
			 							F_A.ABRV_DPRT_CD )
			 				   )  as AFI_ABRV_ORDP_CD      /*  약어집도과코드 */
			 , a.OPPL_CD as OPPL_CD               /*  수술장소코드 */
			 , decode(a.OPPL_CD,'M','본원','C','암센터','D','별관','P','양성자','') as AFI_OPPL_NM          /*  수술장소명 */
			 , a.OPRM_CD as OPRM_CD               /*  수술실코드 */
			 , '' as AFI_OPRM_NM           /*  수술실명 */
			 , decode(b.PTNO,null,'N','Y') as AFI_OPRT_CARC_WRTG_YN /*  수술간호기록 작성여부 */
			 , a.CODV_CD as CODV_CD               /*  내원구분코드 */
			 , ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 ) as OPSR_NM_1             /*  집도의사명1 */
		 from MDOPSCHET a
			, MNSOPNRMT b
		where a.PTNO = #{ptno}
		  and (
				  (#{oprtYmd} is null) or (a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd'))
			  )
		  and (
			  (#{wodvCd} = '1' and (a.OPRT_STTS_CD in ('1','2', '4','5','A','B','C','D','6', '7', '8') and nvl(a.CNCL_YN,'N') = 'N'))
			  or
			  (#{wodvCd} = '2' and a.OPRT_STTS_CD in ('2','4', '5','A','B','C','D','6', '7','8', '9'))
			  or
			  (#{wodvCd} = '3' and (a.OPRT_STTS_CD not in ('1','9') and (a.DFNT_YN = 'Y')))
			  )
		  and a.CODV_CD = nvl(#{codvCd}, a.CODV_CD) /*  내원구분코드 */
		  and b.PTNO     (+)= a.PTNO
		  and b.OPRT_YMD (+)= a.OPRT_YMD
		  and b.OPRT_SNO (+)= a.OPRT_SNO
		order by a.OPRT_YMD desc
			  , a.OPRT_SNO desc
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X1-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="afiApntProrNm" column="AFI_APNT_PROR_NM"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="oprtPstnCtn" column="OPRT_PSTN_CTN"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="crtfYn2" column="CRTF_YN_2"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="oprmChotPadvCd" column="OPRM_CHOT_PADV_CD"/>
		<result property="afiChotPadvNm" column="AFI_CHOT_PADV_NM"/>
		<result property="blodCtn" column="BLOD_CTN"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="afiCscrOrdrSttsNm" column="AFI_CSCR_ORDR_STTS_NM"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="chckDvsnCd" column="CHCK_DVSN_CD"/>
		<result property="pcaYn" column="PCA_YN"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="anstRcrdItemDvsnCd" column="ANST_RCRD_ITEM_DVSN_CD"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="chkrNm" column="CHKR_NM"/>
		<result property="chkrTlno" column="CHKR_TLNO"/>
		<result property="chkrNm1" column="CHKR_NM_1"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="pwsnDvsnCd" column="PWSN_DVSN_CD"/>
		<result property="tlviYn1" column="TLVI_YN_1"/>
		<result property="tlviYn2" column="TLVI_YN_2"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiInfcSttsNm3" column="AFI_INFC_STTS_NM_3"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="afiAsnuNm1" column="AFI_ASNU_NM_1"/>
		<result property="afiAsnuNm2" column="AFI_ASNU_NM_2"/>
		<result property="afiAsnuNm3" column="AFI_ASNU_NM_3"/>
		<result property="strmDschDt" column="STRM_DSCH_DT"/>
		<result property="afiAorCarcWrtgYn" column="AFI_AOR_CARC_WRTG_YN"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiOprtWaitHhVl" column="AFI_OPRT_WAIT_HH_VL"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="strmMvmnYn" column="STRM_MVMN_YN"/>
		<result property="frrn" column="FRRN"/>
		<result property="anstStrtDt1" column="ANST_STRT_DT_1"/>
		<result property="anstFnshDt1" column="ANST_FNSH_DT_1"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="oprtSafeCeckVl" column="OPRT_SAFE_CECK_VL"/>
		<result property="eqpmCtn" column="EQPM_CTN"/>
		<result property="otptRcrdWrtgInlsYn" column="OTPT_RCRD_WRTG_INLS_YN"/>
		<result property="painMngmCntrEnrmDt" column="PAIN_MNGM_CNTR_ENRM_DT"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="oprtCareSprtYn" column="OPRT_CARE_SPRT_YN"/>
		<result property="clotDt" column="CLOT_DT"/>
		<result property="clotDvsnCd" column="CLOT_DVSN_CD"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cmtxSeqNo" column="CMTX_SEQ_NO"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="pvanTrgtYn" column="PVAN_TRGT_YN"/>
		<result property="antpRqrdMi" column="ANTP_RQRD_MI"/>
		<result property="afiAgdcRtrnDvsnNm1" column="AFI_AGDC_RTRN_DVSN_NM_1"/>
		<result property="afiAgdcRtrnDvsnNm2" column="AFI_AGDC_RTRN_DVSN_NM_2"/>
		<result property="afiAgdcRtrnDvsnNm3" column="AFI_AGDC_RTRN_DVSN_NM_3"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X1 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X1-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X1"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X1-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X1 */
		<![CDATA[
		with t as (
				   select  /*+ leading(a e) 수술환자선택-수술실 환자조회 */
						   b.PTNT_NM  as PTNT_NM  /* 환자명 */
		                , (select p.detl_cd_nm from cccmcddmt p
		                   where p.comn_grp_cd='MM133'
		                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM  /* 내원구분명 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.PTNO  as PTNO     /* 환자번호 */
						,  b.GEND_CD  as GEND_CD  /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 생년월일 */
						,  ''  as AGE_CTN  /* 연령내용(성별/나이) - null */
						,  a.ORDP_CD  as ORDP_CD  /* 집도과코드 */
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )  as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
							case when e.CODV_CD = 'D' then nvl((
														  select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															from  APRCRPTNT bb
														   where  bb.PTNO = e.PTNO
															 and  bb.CODV_CD = 'I'
															 and  bb.MDCR_DT = e.DSCH_DT
															 and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 약어간호병동코드  */
						 ,  (
							case when e.CODV_CD = 'D' then nvl((
															  select  CARE_PTRM_NO
																from  APRCRPTNT bb
															   where  bb.PTNO = e.PTNO
																 and  bb.CODV_CD = 'I'
																 and  bb.MDCR_DT = e.DSCH_DT
																 and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1  as OPSR_ID_1    /* 집도의사ID1 */
						,  a.OPSR_ID2  as OPSR_ID_2    /* 집도의사ID2 */
						,  a.OPSR_ID3  as OPSR_ID_3    /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 ) as AFI_OPRM_NM     /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT    /* 수술시작예정일시  */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1  /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD  as OPRT_STTS_CD    /* 수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN   /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																						     from MEDOCMBST xx
																					        where xx.PTNO           = a.PTNO
																					          and  xx.RCRD_DT       >= a.OPRT_YMD
																					          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																						      and  xx.BHVR_SNO       = a.OPRT_SNO
																						      and xx.RCRD_LAST_YN = 'Y'
																						      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                      and nvl( xx.dltn_yn,'N') ='N'
		                                                                                      and rownum = 1
		                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
		                                                                                 )
		                                                                              )
		                                                         )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD  as ANKI_CD           /* 마취종류코드 */
						,  a.CODV_CD  as CODV_CD           /* 내원구분코드 */
						,  a.CSCR_CD  as CSCR_CD           /* CaseCart코드  */
						,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  
						                  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
		                         and xa.ptnt_rcrd_dx_sno =  1
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM)  as CSCR_NM           /* CaseCart명  */
						,  a.CLNC_OPRT_NM  as CLNC_OPRT_NM      /* 임상수술명   */
						,  a.OPRM_CHOT_PADV_CD  as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD
												 and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM      /* AFI퇴실장소구분명 */
						,  ''  as BLOD_CTN              /* 혈액내용 */
						,  NVL( (select 'C'
		                            from   MNZCERTMT yy  /* 인증 */
			                       where
		                      	      yy.PTNO           = a.PTNO
		                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_OPRT_CARE_RCRD')
		                              	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                and rownum = 1), decode(a.PTNO,g.PTNO,'Y','N')  
		                                       )  as AFI_OPRT_CARC_WRTG_YN /* AFI수술간호기록작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* AFI_Case_Cart처방상태명 */
						,  a.ER_YN  as ER_YN                 /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM        /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT          /* 수술실입실일시  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select a1.CLNO
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select a1.CLNO
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN||(
												select
														LISTAGG(bb.TMOT_DVSN_DETL_NM,chr(13)) WITHIN group (order by aa.OPRT_PRPN_ITEM_CD)
												  from
													   MDOPPRIMT aa /* 수술스케줄준비항목 */
													 , MDEITMOCT bb /* 임플란트및장비관리 */
												 where
													   aa.PTNO                   = a.PTNO
												   and aa.OPRT_YMD               = a.OPRT_YMD
												   and aa.OPRT_SNO               = a.OPRT_SNO
												   and aa.OPRT_PRPN_ITEM_DVSN_CD = '01'
												   and bb.MCDP_CD                = a.ORDP_CD
												   and bb.TMOT_DVSN_DETL_CD      = aa.OPRT_PRPN_ITEM_CD
												 group by a.PTNO
													 , a.OPRT_YMD
													 , a.OPRT_SNO)  as IMPN_CMNT_CTN           /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM                  /* DRG명  */
						,  a.CP_CD  as CP_CD                   /* CP코드  */
						,  e.MCDP_CD  as MCDP_CD                 /* 입원환자 진료과코드  */
						,  a.SCIN_NM  as SCIN_NM                 /* 상병명 */
						,  ''  as CHCK_DVSN_CD            /* 심사구분코드 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN                 /* 취소여부 */
						,  nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                        when aa.RCRD_ID is not null then 'Y'
		                                        else 'Y' end ) 
		                                   || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                             when aa.RCRD_ID_2 is not null then 'Y'
		                                             else 'N'
		                                         end )
		                            from mdopparmt aa
		                           where aa.PTNO = a.PTNO
			                         and aa.OPRT_YMD = a.OPRT_YMD
			                         and aa.OPRT_SNO = a.OPRT_SNO
		                             and rownum =1),'NN') as ANST_RCRD_ITEM_DVSN_CD   /* 마취전방문기록 */
						,  a.OPRT_SNO  as OPRT_SNO                /* 수술일련번호 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT       /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT       /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT  /* 수술실 퇴실일시 */
						,  a.OPRM_CD  as OPRM_CD       /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN  as ETC_CNRE_CTN      /* 기타취소내용 */
						,  ''  as CHKR_NM           /* 심사자명 */
						,  ''  as CHKR_TLNO         /* 심사자전화번호 */
						,  ''  as CHKR_NM_1         /* 심사자명1 */
						,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명 */
						,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  ''  as PWSN_DVSN_CD          /* 동명이인구분코드 */
						,  ''  as TLVI_YN_1             /* 전화방문여부1 */
						,  ''  as TLVI_YN_2             /* 전화방문여부2 */
						,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN          /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						, FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1  /* AFI감염상태명1(감염COLOR) */
						, FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2  /* AFI감염상태명2(감염COUNT) */
		                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN  /* 회복실기록지 작성여부 */
						,  to_char(wait_rom_arvl_dt,'AM hh12:mi')  as CNFR_REGN_ARVL_DT      /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT           /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT           /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT                /* 수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT           /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT           /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD               /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN  as DFNT_AFTR_MDFC_YN      /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  ''  as TS_YN           /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN     /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT     /* AOR준비실입실일시 */
						,  ''  as AFI_ASNU_NM_1        /* AFI담당간호사명1 */
						,  ''  as AFI_ASNU_NM_2        /* AFI담당간호사명2 */
						,  ''  as AFI_ASNU_NM_3        /* AFI담당간호사명3 */
						,  ''  as STRM_DSCH_DT         /* 안정실퇴원일시 */
						,  ''  as AFI_AOR_CARC_WRTG_YN /* AFI_AOR간호기록작성여부 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT              /* 진료일시 */
						,  ''  as AFI_OPRT_WAIT_HH_VL  /* AFI수술대기시간값 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'
							 and  x.ORDR_CLTY_CD = 'D4'
						)  as AFI_ANST_FEE_YN      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||'/'|| count(*))
							from  MDMEDORDT z
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							 --and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN       /* 약반납건수내용 */
						, ''  as STRM_MVMN_YN           /* 안정실이동여부 */
						, b.FRRN  as FRRN                   /* 앞주민번호 */
						, to_char(i.ANST_STRT_DT,'AM hh12:mi')   as ANST_STRT_DT_1         /* 마취시작일시1 */
						, to_char(i.ANST_FNSH_DT,'AM hh12:mi')   as ANST_FNSH_DT_1         /* 마취종료일시1 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN                /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
						, (select LISTAGG('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = aa.CPDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM           /* 협진수술명 */
						, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
				                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
				                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
						, (decode(carm_En,'Y', 'C-Arm ', '') || decode(sono_En,'Y', 'SONO ', '')
		                   || decode(cusa_Yn,'Y', 'CUSA ', '')|| decode(mcrs_Yn,'Y', 'Microscope ', '')
		                   || decode(rang_Yn,'Y', 'Scope시스템 ', '')|| decode(lasr_En,'Y', 'X-RAY(P) ', '')
		                   || adtn_Mchn_Ctn) as EQPM_CTN               /* 장비내용 */
						, ''  as OTPT_RCRD_WRTG_INLS_YN /* 외래기록작성포함여부 */
						, ''  as PAIN_MNGM_CNTR_ENRM_DT /* 통증관리센터입실일시 */
						, e.MDRP_NO  as MDRP_NO                /* 진료접수번호 */
						, decode(nvl(a.PAIN_MNGM_CNTR_VIA_YN,'N'),'N','','Y') as PAIN_MNGM_CNTR_VIA_YN   /* 통증관리센터경유여부 */
						, decode(nvl(a.OPRT_CARE_SPRT_YN,'N'),'N','','Y') as OPRT_CARE_SPRT_YN       /* 수술간호지원여부 */
		                ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
						, a.COLT_DVSN_CD as CLOT_DVSN_CD
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
		                         and xa.ptnt_rcrd_dx_sno =  2
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
		                         and xa.ptnt_rcrd_dx_sno =  3
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , 0 as CMTX_SEQ_NO
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
		                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
		                         and exists (select 1
		                                       from AICTRLMMT
		                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
		                                        and trunc(sysdate) between APST_YMD and APFN_YMD
		                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
		                         and exists (select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                      union all
		                                     select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
		                       then 'Y'
		                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		                  , a.ANTP_RQRD_MI
		                  , (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'OP')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
							)) as afi_agdc_rtrn_dvsn_nm_1  --수술동의서 유무
		 				, (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'AN')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
		                   )) as afi_agdc_rtrn_dvsn_nm_2 --마취동의서 유무
		                  , (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'PCA')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
							)) as afi_agdc_rtrn_dvsn_nm_3  --PCA동의서 유무
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						  a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) )
		                   ) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					and  (#{anshId} is null
						 or
						   (
						   a.ANSH_ID1 = #{anshId} or
						   a.ANSH_ID2 = #{anshId} or
						   a.ANSH_ID3 = #{anshId}
						   )
						 ) /* 마취의 */
					and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					and  (
						   (
							  (
								  nvl(#{codvCd1},'N') != 'Y' and
								  nvl(#{codvCd2},'N') != 'Y' and
								  nvl(#{codvCd3},'N') != 'Y' and
								  nvl(#{codvCd4},'N') != 'Y'
							  )
							  and
							  (1=1)
						   )
						   or
						   (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
						   or
						   (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
						   or
						   (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
						   or
						   (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						 )
					and  (a.DFNT_YN = 'Y'  or #{dprmInrlOprtYn} ='Y' )
					and  (
						   (
							 (
							 nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							 nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							 nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							 nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							 nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							 nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							 ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
						   )
						   or
						   (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2','3') ) /*미착 -> 확정(2) */
						   or
						   (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
						   or
						   (
						   #{oprtSttsCd3} = 'Y' and /*진행 */
							 (
							   (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
							   or
							   (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
							   or
							   (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
							   or
							   (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
							   or
							   (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							 )
						   )
						  or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
						   or
						   (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						 )
		              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
		              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
					  and  b.PTNO(+)= a.PTNO			  
					  and  (a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD) or a.OPPL_CD is null )
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
		              and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
					    )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID			 
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
		]]>
		<if test='cmtxOprtYn == "Y"'>
		<![CDATA[
		union all
				   select  /*+ leading(a e) 수술환자선택-수술실 환자조회 */
						   b.PTNT_NM  as PTNT_NM  /* 환자명 */
		                , (select p.detl_cd_nm from cccmcddmt p
		                   where p.comn_grp_cd='MM133'
		                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM  /* 내원구분명 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.PTNO  as PTNO     /* 환자번호 */
						,  b.GEND_CD  as GEND_CD  /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 생년월일 */
						,  ''  as AGE_CTN  /* 연령내용(성별/나이) - null */
						,  cmtx.CPDP_CD  as ORDP_CD  /* 집도과코드 */
						,  decode(cmtx.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = cmtx.CPDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = cmtx.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )  as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
							case when e.CODV_CD = 'D' then nvl((
														  select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															from  APRCRPTNT bb
														   where  bb.PTNO = e.PTNO
															 and  bb.CODV_CD = 'I'
															 and  bb.MDCR_DT = e.DSCH_DT
															 and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 약어간호병동코드  */
						 ,  (
							case when e.CODV_CD = 'D' then nvl((
															  select  CARE_PTRM_NO
																from  APRCRPTNT bb
															   where  bb.PTNO = e.PTNO
																 and  bb.CODV_CD = 'I'
																 and  bb.MDCR_DT = e.DSCH_DT
																 and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  cmtx.CMTX_OPSR_ID1  as OPSR_ID_1    /* 집도의사ID1 */
						,  cmtx.CMTX_OPSR_ID2  as OPSR_ID_2    /* 집도의사ID2 */
						,  cmtx.CMTX_OPSR_ID3  as OPSR_ID_3    /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM     /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT    /* 수술시작예정일시  */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1  /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD  as OPRT_STTS_CD    /* 수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN   /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																						     from MEDOCMBST xx
																					        where xx.PTNO           = a.PTNO
																					          and  xx.RCRD_DT       >= a.OPRT_YMD
																					          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																						      and  xx.BHVR_SNO       = a.OPRT_SNO
																						      and xx.RCRD_LAST_YN = 'Y'
																							  and nvl( xx.dltn_yn,'N') ='N'
																						      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                      and rownum = 1
		                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
		                                                                                 )
		                                                                              )
		                                                         )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD  as ANKI_CD           /* 마취종류코드 */
						,  a.CODV_CD  as CODV_CD           /* 내원구분코드 */
		                ,  cmtx.CMTX_OPRT_CSCR_CD  as CSCR_CD           /* CaseCart코드  */
						,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  1
		                         and rownum = 1
		                         and cmtx.CPDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), cmtx.CMTX_OPRT_CSCR_NM) , cmtx.CMTX_OPRT_CSCR_NM) as CSCR_NM           /* CaseCart명  */
						,  a.CLNC_OPRT_NM  as CLNC_OPRT_NM      /* 임상수술명   */
						,  a.OPRM_CHOT_PADV_CD  as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD
												 and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM      /* AFI퇴실장소구분명 */
						,  ''  as BLOD_CTN              /* 혈액내용 */
						, NVL( (select 'C'
		                            from   MNZCERTMT yy  /* 인증 */
			                       where
		                      	      yy.PTNO           = a.PTNO
		                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_OPRT_CARE_RCRD')
		                              	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                and rownum = 1), decode(a.PTNO,g.PTNO,'Y','N')  
		                                       )   as AFI_OPRT_CARC_WRTG_YN /* AFI수술간호기록작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* AFI_Case_Cart처방상태명 */
						,  a.ER_YN  as ER_YN                 /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM        /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT          /* 수술실입실일시  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN||(
												select
														LISTAGG(bb.TMOT_DVSN_DETL_NM,chr(13)) WITHIN group (order by aa.OPRT_PRPN_ITEM_CD)
												  from
													   MDOPPRIMT aa /* 수술스케줄준비항목 */
													 , MDEITMOCT bb /* 임플란트및장비관리 */
												 where
													   aa.PTNO                   = a.PTNO
												   and aa.OPRT_YMD               = a.OPRT_YMD
												   and aa.OPRT_SNO               = a.OPRT_SNO
												   and aa.OPRT_PRPN_ITEM_DVSN_CD = '01'
												   and bb.MCDP_CD                = a.ORDP_CD
												   and bb.TMOT_DVSN_DETL_CD      = aa.OPRT_PRPN_ITEM_CD
												 group by a.PTNO
													 , a.OPRT_YMD
													 , a.OPRT_SNO)  as IMPN_CMNT_CTN           /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM                  /* DRG명  */
						,  a.CP_CD  as CP_CD                   /* CP코드  */
						,  e.MCDP_CD  as MCDP_CD                 /* 입원환자 진료과코드  */
						,  a.SCIN_NM  as SCIN_NM                 /* 상병명 */
						,  ''  as CHCK_DVSN_CD            /* 심사구분코드 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN                 /* 취소여부 */
						,  nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                        when aa.RCRD_ID is not null then 'Y'
		                                        else 'Y' end ) 
		                                   || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                             when aa.RCRD_ID_2 is not null then 'Y'
		                                             else 'N'
		                                         end )
		                            from mdopparmt aa
		                           where aa.PTNO = a.PTNO
			                         and aa.OPRT_YMD = a.OPRT_YMD
			                         and aa.OPRT_SNO = a.OPRT_SNO
		                             and rownum =1),'NN') as ANST_RCRD_ITEM_DVSN_CD   /* 마취전방문기록 */
						,  a.OPRT_SNO  as OPRT_SNO                /* 수술일련번호 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT       /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT       /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT  /* 수술실 퇴실일시 */
						,  a.OPRM_CD  as OPRM_CD       /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN  as ETC_CNRE_CTN      /* 기타취소내용 */
						,  ''  as CHKR_NM           /* 심사자명 */
						,  ''  as CHKR_TLNO         /* 심사자전화번호 */
						,  ''  as CHKR_NM_1         /* 심사자명1 */
						,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명 */
						,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  ''  as PWSN_DVSN_CD          /* 동명이인구분코드 */
						,  ''  as TLVI_YN_1             /* 전화방문여부1 */
						,  ''  as TLVI_YN_2             /* 전화방문여부2 */
						,  ''  as AFI_SLCT_CTN          /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						, FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1  /* AFI감염상태명1(감염COLOR) */
						, FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2  /* AFI감염상태명2(감염COUNT) */
		                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN  /* 회복실기록지 작성여부 */
						,  to_char(wait_rom_arvl_dt,'AM hh12:mi')  as CNFR_REGN_ARVL_DT      /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT           /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT           /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT                /* 수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT           /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT           /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD               /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN  as DFNT_AFTR_MDFC_YN      /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN           /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN     /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT     /* AOR준비실입실일시 */
						,  ''  as AFI_ASNU_NM_1        /* AFI담당간호사명1 */
						,  ''  as AFI_ASNU_NM_2        /* AFI담당간호사명2 */
						,  ''  as AFI_ASNU_NM_3        /* AFI담당간호사명3 */
						,  ''  as STRM_DSCH_DT         /* 안정실퇴원일시 */
						,  ''  as AFI_AOR_CARC_WRTG_YN /* AFI_AOR간호기록작성여부 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT              /* 진료일시 */
						,  ''  as AFI_OPRT_WAIT_HH_VL  /* AFI수술대기시간값 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'
							 and  x.ORDR_CLTY_CD = 'D4'
						)  as AFI_ANST_FEE_YN      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||'/'|| count(*))
							from  MDMEDORDT z
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							 --and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN       /* 약반납건수내용 */
						, ''  as STRM_MVMN_YN           /* 안정실이동여부 */
						, b.FRRN  as FRRN                   /* 앞주민번호 */
						, to_char(i.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT_1         /* 마취시작일시1 */
						, to_char(i.ANST_FNSH_DT,'AM hh12:mi')  as ANST_FNSH_DT_1         /* 마취종료일시1 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN                /* 외국인여부 */
						, 'Y' as CMTX_OPRT_YN           /* 협진수술여부 */
						, ('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD =  a.ORDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   (select bb.USER_NM from CCUSRDPHT bb
											   where bb.USER_ID = a.OPSR_ID1 ) ||'('||
											   a.OPSR_ID1||') '||
											   a.CSCR_NM)  as CMTX_OPRT_NM           /* 협진수술명 */
						, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
				                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
				                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
						, (decode(carm_En,'Y', 'C-Arm ', '') || decode(sono_En,'Y', 'SONO ', '')
		                   || decode(cusa_Yn,'Y', 'CUSA ', '')|| decode(mcrs_Yn,'Y', 'Microscope ', '')
		                   || decode(rang_Yn,'Y', 'Scope시스템 ', '')|| decode(lasr_En,'Y', 'X-RAY(P) ', '')
		                   || adtn_Mchn_Ctn)  as EQPM_CTN               /* 장비내용 */
						, ''  as OTPT_RCRD_WRTG_INLS_YN /* 외래기록작성포함여부 */
						, ''  as PAIN_MNGM_CNTR_ENRM_DT /* 통증관리센터입실일시 */
						, e.MDRP_NO  as MDRP_NO                /* 진료접수번호 */
						, decode(nvl(a.PAIN_MNGM_CNTR_VIA_YN,'N'),'N','','Y') as PAIN_MNGM_CNTR_VIA_YN   /* 통증관리센터경유여부 */
						, decode(nvl(a.OPRT_CARE_SPRT_YN,'N'),'N','','Y') as OPRT_CARE_SPRT_YN       /* 수술간호지원여부 */
		                ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
						, a.COLT_DVSN_CD as CLOT_DVSN_CD
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , '' as SUB_OPRT_CD_1
		                , '' as SUB_OPRT_CD_NM_1
		                , '' as SUB_OPRT_CD_2
		                , '' as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , 1 as CMTX_SEQ_NO
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
		                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
		                         and exists (select 1
		                                       from AICTRLMMT
		                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
		                                        and trunc(sysdate) between APST_YMD and APFN_YMD
		                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
		                         and exists (select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                      union all
		                                     select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
		                       then 'Y'
		                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		                  , a.ANTP_RQRD_MI 
		                  , (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'OP')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
							)) as afi_agdc_rtrn_dvsn_nm_1  --수술동의서 유무
		 				, (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'AN')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
		                  --and b.WRTR_ATHR_CD not in ('C','U')
		                   )) as afi_agdc_rtrn_dvsn_nm_2 --마취동의서 유무
		                  , (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'PCA')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
							)) as afi_agdc_rtrn_dvsn_nm_3  --PCA동의서 유무
						, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = cmtx.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between cmtx.OPRT_YMD and cmtx.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = cmtx.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = cmtx.CPDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = cmtx.CPDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
		                ,  MDOPSCCOT cmtx
					where
						  a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		                  and a.PTNO = cmtx.PTNO
		                  and a.OPRT_YMD = cmtx.OPRT_YMD
		                  and a.OPRT_SNO = cmtx.OPRT_SNO
		                  and  #{cmtxOprtYn} = #{cmtxOprtYn}
		                   and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} or cmtx.CPDP_CD  = #{ordpCd}
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( cmtx.CPDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                   ) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd} or cmtx.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId} or cmtx.CMTX_OPSR_ID1 = #{opsrId} ) /* 집도의 */
					and  (#{anshId} is null
						 or
						   (
						   a.ANSH_ID1 = #{anshId} or
						   a.ANSH_ID2 = #{anshId} or
						   a.ANSH_ID3 = #{anshId}
						   )
						 ) /* 마취의 */
					and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					and  (
						   (
							  (
								  nvl(#{codvCd1},'N') != 'Y' and
								  nvl(#{codvCd2},'N') != 'Y' and
								  nvl(#{codvCd3},'N') != 'Y' and
								  nvl(#{codvCd4},'N') != 'Y'
							  )
							  and
							  (1=1)
						   )
						   or
						   (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
						   or
						   (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
						   or
						   (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
						   or
						   (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						 )
					and ( a.DFNT_YN = 'Y' or #{dprmInrlOprtYn} ='Y' )
					and  (
						   (
							 (
							 nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							 nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							 nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							 nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							 nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							 nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							 ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
						   )
						   or
						   (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD  in ('2','3') ) /*미착 -> 확정(2) */
						   or
						   (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
						   or
						   (
						   #{oprtSttsCd3} = 'Y' and /*진행 */
							 (
							   (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
							   or
							   (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
							   or
							   (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
							   or
							   (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
							   or
							   (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							 )
						   )
						  or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
						   or
						   (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						 )
		              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
		              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
					  and  b.PTNO(+)= a.PTNO					  
					  and  (a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD) or a.OPPL_CD is null )
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
		              and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
					    )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
		]]>
		</if>
		<![CDATA[
		union all
		select
						   b.PTNT_NM  as PTNT_NM  /* 환자명 */
		                , (select p.detl_cd_nm from cccmcddmt p
		                   where p.comn_grp_cd='MM133'
		                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM  /* 내원구분명 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.PTNO  as PTNO     /* 환자번호 */
						,  b.GEND_CD  as GEND_CD  /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 생년월일 */
						,  ''  as AGE_CTN  /* 연령내용(성별/나이) - null */
						,  a.ORDP_CD  as ORDP_CD  /* 집도과코드 */
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
							case when e.CODV_CD = 'D' then nvl((
														  select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															from  APRCRPTNT bb
														   where  bb.PTNO = e.PTNO
															 and  bb.CODV_CD = 'I'
															 and  bb.MDCR_DT = e.DSCH_DT
															 and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 약어간호병동코드  */
						 ,  (
							case when e.CODV_CD = 'D' then nvl((
															  select  CARE_PTRM_NO
																from  APRCRPTNT bb
															   where  bb.PTNO = e.PTNO
																 and  bb.CODV_CD = 'I'
																 and  bb.MDCR_DT = e.DSCH_DT
																 and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1  as OPSR_ID_1    /* 집도의사ID1 */
						,  a.OPSR_ID2  as OPSR_ID_2    /* 집도의사ID2 */
						,  a.OPSR_ID3  as OPSR_ID_3    /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM     /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT    /* 수술시작예정일시  */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1  /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD  as OPRT_STTS_CD    /* 수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN   /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																						     from MEDOCMBST xx
																					        where xx.PTNO           = a.PTNO
																					          and  xx.RCRD_DT       >= a.OPRT_YMD
																					          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																						      and  xx.BHVR_SNO       = a.OPRT_SNO
																						      and xx.RCRD_LAST_YN = 'Y'
																							  and nvl( xx.dltn_yn,'N') ='N'
																						      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                      and rownum = 1
		                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
		                                                                                 )
		                                                                              )
		                                                         )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD  as ANKI_CD           /* 마취종류코드 */
						,  a.CODV_CD  as CODV_CD           /* 내원구분코드 */
						,  a.CSCR_CD  as CSCR_CD           /* CaseCart코드  */
						,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */   xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  1
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM)  as CSCR_NM           /* CaseCart명  */
						,  a.CLNC_OPRT_NM  as CLNC_OPRT_NM      /* 임상수술명   */
						,  a.OPRM_CHOT_PADV_CD  as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD
												 and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM      /* AFI퇴실장소구분명 */
						,  ''  as BLOD_CTN              /* 혈액내용 */
						,  NVL( (select 'C'
		                            from   MNZCERTMT yy  /* 인증 */
			                       where
		                      	      yy.PTNO           = a.PTNO
		                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_OPRT_CARE_RCRD')
		                              	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                and rownum = 1), decode(a.PTNO,g.PTNO,'Y','N')  
		                                       )    as AFI_OPRT_CARC_WRTG_YN /* AFI수술간호기록작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* AFI_Case_Cart처방상태명 */
						,  a.ER_YN  as ER_YN                 /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM        /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT          /* 수술실입실일시  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN||(
												select
														LISTAGG(bb.TMOT_DVSN_DETL_NM,chr(13)) WITHIN group (order by aa.OPRT_PRPN_ITEM_CD)
												  from
													   MDOPPRIMT aa /* 수술스케줄준비항목 */
													 , MDEITMOCT bb /* 임플란트및장비관리 */
												 where
													   aa.PTNO                   = a.PTNO
												   and aa.OPRT_YMD               = a.OPRT_YMD
												   and aa.OPRT_SNO               = a.OPRT_SNO
												   and aa.OPRT_PRPN_ITEM_DVSN_CD = '01'
												   and bb.MCDP_CD                = a.ORDP_CD
												   and bb.TMOT_DVSN_DETL_CD      = aa.OPRT_PRPN_ITEM_CD
												 group by a.PTNO
													 , a.OPRT_YMD
													 , a.OPRT_SNO)  as IMPN_CMNT_CTN           /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM                  /* DRG명  */
						,  a.CP_CD  as CP_CD                   /* CP코드  */
						,  e.MCDP_CD  as MCDP_CD                 /* 입원환자 진료과코드  */
						,  a.SCIN_NM  as SCIN_NM                 /* 상병명 */
						,  ''  as CHCK_DVSN_CD            /* 심사구분코드 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN                 /* 취소여부 */
						,  nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                        when aa.RCRD_ID is not null then 'Y'
		                                        else 'Y' end ) 
		                                   || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                             when aa.RCRD_ID_2 is not null then 'Y'
		                                             else 'N'
		                                         end )
		                            from mdopparmt aa
		                           where aa.PTNO = a.PTNO
			                         and aa.OPRT_YMD = a.OPRT_YMD
			                         and aa.OPRT_SNO = a.OPRT_SNO
		                             and rownum =1),'NN') as ANST_RCRD_ITEM_DVSN_CD   /* 마취전방문기록 */
						,  a.OPRT_SNO  as OPRT_SNO                /* 수술일련번호 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT       /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT       /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT  /* 수술실 퇴실일시 */
						,  a.OPRM_CD  as OPRM_CD       /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN  as ETC_CNRE_CTN      /* 기타취소내용 */
						,  ''  as CHKR_NM           /* 심사자명 */
						,  ''  as CHKR_TLNO         /* 심사자전화번호 */
						,  ''  as CHKR_NM_1         /* 심사자명1 */
						,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명 */
						,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  ''  as PWSN_DVSN_CD          /* 동명이인구분코드 */
						,  ''  as TLVI_YN_1             /* 전화방문여부1 */
						,  ''  as TLVI_YN_2             /* 전화방문여부2 */
						,  ''  as AFI_SLCT_CTN          /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						, FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1  /* AFI감염상태명1(감염COLOR) */
						, FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2  /* AFI감염상태명2(감염COUNT) */
		                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN  /* 회복실기록지 작성여부 */
						,  to_char(wait_rom_arvl_dt,'AM hh12:mi')  as CNFR_REGN_ARVL_DT      /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT           /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT           /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT                /* 수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT           /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT           /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD               /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN  as DFNT_AFTR_MDFC_YN      /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN           /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN     /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT     /* AOR준비실입실일시 */
						,  ''  as AFI_ASNU_NM_1        /* AFI담당간호사명1 */
						,  ''  as AFI_ASNU_NM_2        /* AFI담당간호사명2 */
						,  ''  as AFI_ASNU_NM_3        /* AFI담당간호사명3 */
						,  ''  as STRM_DSCH_DT         /* 안정실퇴원일시 */
						,  ''  as AFI_AOR_CARC_WRTG_YN /* AFI_AOR간호기록작성여부 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT              /* 진료일시 */
						,  ''  as AFI_OPRT_WAIT_HH_VL  /* AFI수술대기시간값 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'
							 and  x.ORDR_CLTY_CD = 'D4'
						)  as AFI_ANST_FEE_YN      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||'/'|| count(*))
							from  MDMEDORDT z
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							 --and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN       /* 약반납건수내용 */
						, ''  as STRM_MVMN_YN           /* 안정실이동여부 */
						, b.FRRN  as FRRN                   /* 앞주민번호 */
						, to_char(i.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT_1         /* 마취시작일시1 */
						, to_char(i.ANST_FNSH_DT,'AM hh12:mi')  as ANST_FNSH_DT_1         /* 마취종료일시1 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN                /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
						, (select LISTAGG('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = aa.CPDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM           /* 협진수술명 */
						, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
				                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
				                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
						, (decode(carm_En,'Y', 'C-Arm ', '') || decode(sono_En,'Y', 'SONO ', '')
		                   || decode(cusa_Yn,'Y', 'CUSA ', '')|| decode(mcrs_Yn,'Y', 'Microscope ', '')
		                   || decode(rang_Yn,'Y', 'Scope시스템 ', '')|| decode(lasr_En,'Y', 'X-RAY(P) ', '')
		                   || adtn_Mchn_Ctn)  as EQPM_CTN               /* 장비내용 */
						, ''  as OTPT_RCRD_WRTG_INLS_YN /* 외래기록작성포함여부 */
						, ''  as PAIN_MNGM_CNTR_ENRM_DT /* 통증관리센터입실일시 */
						, e.MDRP_NO  as MDRP_NO                /* 진료접수번호 */
						, decode(nvl(a.PAIN_MNGM_CNTR_VIA_YN,'N'),'N','','Y') as PAIN_MNGM_CNTR_VIA_YN   /* 통증관리센터경유여부 */
						, decode(nvl(a.OPRT_CARE_SPRT_YN,'N'),'N','','Y') as OPRT_CARE_SPRT_YN       /* 수술간호지원여부 */
		                ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
						, a.COLT_DVSN_CD as CLOT_DVSN_CD
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  2
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  3
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                ,  0 as CMTX_SEQ_NO
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
		                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
		                         and exists (select 1
		                                       from AICTRLMMT
		                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
		                                        and trunc(sysdate) between APST_YMD and APFN_YMD
		                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
		                         and exists (select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                      union all
		                                     select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
		                       then 'Y'
		                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		                 , a.ANTP_RQRD_MI
		                 , (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'OP')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
							)) as afi_agdc_rtrn_dvsn_nm_1  --수술동의서 유무
		 				, (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'AN')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
		                  --and b.WRTR_ATHR_CD not in ('C','U')
		                   )) as afi_agdc_rtrn_dvsn_nm_2 --마취동의서 유무
		                  , (select wrtg_stts_nm from mrocrprnv b
		                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
		                                                where oprt_grp_cd ='AGDC'
		                                                 and RFRN_CD = 'PCA')
		                       and a.ptno = b.ptno
		                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                       and rownum = 1
		                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
		                  where b.ptno = x.ptno
		                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
		                  and b.form_no = x.form_no
							)) as afi_agdc_rtrn_dvsn_nm_3  --PCA동의서 유무
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						  a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )                      
		                   ) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					and  (#{anshId} is null
						 or
						   (
						   a.ANSH_ID1 = #{anshId} or
						   a.ANSH_ID2 = #{anshId} or
						   a.ANSH_ID3 = #{anshId}
						   )
						 ) /* 마취의 */
					and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					and  (
						   (
							  (
								  nvl(#{codvCd1},'N') != 'Y' and
								  nvl(#{codvCd2},'N') != 'Y' and
								  nvl(#{codvCd3},'N') != 'Y' and
								  nvl(#{codvCd4},'N') != 'Y'
							  )
							  and
							  (1=1)
						   )
						   or
						   (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
						   or
						   (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
						   or
						   (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
						   or
						   (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						 )
					and  ( a.DFNT_YN = 'Y'  or #{dprmInrlOprtYn} ='Y' )
					and  (
						   (
							 (
							 nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							 nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							 nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							 nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							 nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							 nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							 ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
						   )
						   or
						   (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2','3')) /*미착 -> 확정(2) */
						   or
						   (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
						   or
						   (
						   #{oprtSttsCd3} = 'Y' and /*진행 */
							 (
							   (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
							   or
							   (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
							   or
							   (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
							   or
							   (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
							   or
							   (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							 )
						   )
						   or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
						   or
						   (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						 )
		              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
		              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
					  and  b.PTNO(+)= a.PTNO					  
					  and  (a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD) or a.OPPL_CD is null )
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD ='O'
		              and (   e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')    
		                        and a.ordp_cd = e.mcdp_cd (+)  and nvl(a.mdrp_no,0) = e.mdrp_no(+) )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
		)
		select t.oprm_cd || '-'|| lpad(rank() over(partition by t.oprm_cd  order by t.opst_prrn_dt),2,'0') as AFI_APNT_PROR_NM
		       ,t.*
		from t
					order  by
						   t.OPRM_CD
						,  t.OPST_PRRN_DT
		                ,  t.PTNO
		                ,  t.CMTX_SEQ_NO
						,  t.ORDP_CD
						,  t.OPSR_ID_1
						,  t.OPRT_STTS_CD
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X2-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="afiApntProrNm" column="AFI_APNT_PROR_NM"/>
		<result property="oprtPstnCtn" column="OPRT_PSTN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="frrn" column="FRRN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="crtfYn2" column="CRTF_YN_2"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="pcaYn" column="PCA_YN"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="anstRcrdItemDvsnCd" column="ANST_RCRD_ITEM_DVSN_CD"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiInfcSttsNm3" column="AFI_INFC_STTS_NM_3"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiAsnuNm1" column="AFI_ASNU_NM_1"/>
		<result property="afiAsnuNm2" column="AFI_ASNU_NM_2"/>
		<result property="afiAsnuNm3" column="AFI_ASNU_NM_3"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="ordrYn" column="ORDR_YN"/>
		<result property="clotDt" column="CLOT_DT"/>
		<result property="clotDvsnCd" column="CLOT_DVSN_CD"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cmtxSeqNo" column="CMTX_SEQ_NO"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="pvanTrgtYn" column="PVAN_TRGT_YN"/>
		<result property="antpRqrdMi" column="ANTP_RQRD_MI"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X2 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X2-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X2"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X2-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X2 */
		<![CDATA[
				   select  /*+ NO_EXPAND LEADING(A, F, Y, X, G) USE_NL(A, B, E, F, G, Z, H, X, Y, I) 수술환자선택-회복실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
		                , a.oprm_cd|| '-'|| lpad(rank() over(partition by a.oprm_cd  order by to_char(a.opst_prrn_dt,'yyyymmddhh24miss')),2,'0') as AFI_APNT_PROR_NM
		                , (select p.detl_cd_nm from cccmcddmt p
		                   where p.comn_grp_cd='MM133'
		                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,    decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT = e.DSCH_DT
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT   /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1             /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
						,  (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )  as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																						     from MEDOCMBST xx
																					        where xx.PTNO           = a.PTNO
																					          and  xx.RCRD_DT       >= a.OPRT_YMD
																					          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																						      and  xx.BHVR_SNO       = a.OPRT_SNO
																						      and xx.RCRD_LAST_YN = 'Y'
																							  and nvl( xx.dltn_yn,'N') ='N'
																						      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                      and rownum = 1
		                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
		                                                                                 )
		                                                                              )
		                                                         )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCar코드   */
						,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  1
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM) as CSCR_NM             /* CaseCar명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                        when aa.RCRD_ID is not null then 'Y'
		                                        else 'Y' end ) 
		                                   || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                             when aa.RCRD_ID_2 is not null then 'Y'
		                                             else 'N'
		                                         end )
		                            from mdopparmt aa
		                           where aa.PTNO = a.PTNO
			                         and aa.OPRT_YMD = a.OPRT_YMD
			                         and aa.OPRT_SNO = a.OPRT_SNO
		                             and rownum =1),'NN') as ANST_RCRD_ITEM_DVSN_CD   /* 마취전방문기록 */
						,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  to_char(a.RCVY_ROM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시) */
						,  to_char(a.RCVY_ROM_CHOT_DT,'yyyymmddhh24mi') as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드      */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  RCVY_ROM_CHOT_PLAC_CD  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.RCVY_ROM_CHOT_PLAC_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  to_char(RCVY_ROM_CHOT_DT,'yyyymmddhh24mi')   as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  ''  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  '' as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                  /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
		                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
						,  decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)   as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							 --and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN                          /* 약반납건수내용 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN      /* 협진수술여부 */
						, (select LISTAGG('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = aa.CPDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM      /* 협진수술명 */
						, e.MDRP_NO  as MDRP_NO           /* 진료접수번호 */
		               , NVL((select 'Y' from MDTRTORDT o
							where o.oprt_ymd = a.oprt_ymd
		                    and o.ptno = a.ptno
		                    and o.oprt_sno = a.oprt_sno
							and o.orcl_cd like 'AN%'
		                    and rownum =1 ), 'N') as ORDR_YN
		                ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
						, a.COLT_DVSN_CD as CLOT_DVSN_CD
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  2
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  3
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , 0 as CMTX_SEQ_NO
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
		                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
		                         and exists (select 1
		                                       from AICTRLMMT
		                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
		                                        and trunc(sysdate) between APST_YMD and APFN_YMD
		                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
		                         and exists (select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                      union all
		                                     select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
		                       then 'Y'
		                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		                , a.ANTP_RQRD_MI
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} 
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                   ) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							  or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
		              and  (
						   (
							 (
							 nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							 nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							 nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							 nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							 nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							 nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							 ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
						   )
						   or
						   (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2','3') ) /*미착 -> 확정(2) */
						   or
						   (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
						   or
						   (
						   #{oprtSttsCd3} = 'Y' and /*진행 */
							 (
							   (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
							   or
							   (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
							   or
							   (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
							   or
							   (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
							   or
							   (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							 )
						   )
						  or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
						   or
						   (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						 )
		              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
		              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
					  and  b.PTNO(+)= a.PTNO					  
					  and  (
							   (a.PTNO in (select PTNO
											 from MNSOPMOVT xx
											where xx.PTNO         = a.PTNO
											  and xx.OPRT_YMD     = a.OPRT_YMD
											  and xx.OPRT_SNO     = a.OPRT_SNO
											  and xx.OPPL_DVSN_CD = nvl(#{opplCd},'M')
											  and xx.MVMN_PLAC_CD = 'E'))
							   or
							   ((a.OPRM_CHOT_DT is not null and
								 a.OPRM_CHOT_DT <= sysdate and
								 a.OPRM_CHOT_PADV_CD = '1' )
							   )
		                       or ( a.OPRT_STTS_CD in ('6','7','8') and
								 a.OPRM_CHOT_PADV_CD = '1' )
						   )
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
					 and  ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd') )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  (
							  #{nursId} is null or
							  (
								  y.MAIN_ASNU_ID = #{nursId}
								  or
								  y.SUB_ASNU_ID = #{nursId}
								  or
								  y.ASST_ASNU_ID = #{nursId}
							  )
						   )
		]]>
		<if test='cmtxOprtYn == "Y"'>
		<![CDATA[
		union all
		select  /*+ NO_EXPAND LEADING(A, F, Y, X, G) USE_NL(A, B, E, F, G, Z, H, X, Y, I) 수술환자선택-회복실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
		                 , a.oprm_cd|| '-'|| lpad(rank() over(partition by a.oprm_cd  order by to_char(a.opst_prrn_dt,'yyyymmddhh24miss')),2,'0') as AFI_APNT_PROR_NM
		                 , (select p.detl_cd_nm from cccmcddmt p
		                   where p.comn_grp_cd='MM133'
		                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  cmtx.CPDP_CD as ORDP_CD
						,    decode(cmtx.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = cmtx.CPDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = cmtx.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT = e.DSCH_DT
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  cmtx.CMTX_OPSR_ID1  as OPSR_ID_1    /* 집도의사ID1 */
						,  cmtx.CMTX_OPSR_ID2  as OPSR_ID_2    /* 집도의사ID2 */
						,  cmtx.CMTX_OPSR_ID3  as OPSR_ID_3    /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT   /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1             /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
						,  (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )  as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																						     from MEDOCMBST xx
																					        where xx.PTNO           = a.PTNO
																					          and  xx.RCRD_DT       >= a.OPRT_YMD
																					          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																						      and  xx.BHVR_SNO       = a.OPRT_SNO
																						      and xx.RCRD_LAST_YN = 'Y'
																							  and nvl( xx.dltn_yn,'N') ='N'
																						      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                      and rownum = 1
		                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
		                                                                                 )
		                                                                              )
		                                                         )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  cmtx.CMTX_OPRT_CSCR_CD  as CSCR_CD           /* CaseCart코드  */
						,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  1
		                         and rownum = 1
		                         and cmtx.CPDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), cmtx.CMTX_OPRT_CSCR_NM) , cmtx.CMTX_OPRT_CSCR_NM)  as CSCR_NM           /* CaseCart명  */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                        when aa.RCRD_ID is not null then 'Y'
		                                        else 'Y' end ) 
		                                   || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                             when aa.RCRD_ID_2 is not null then 'Y'
		                                             else 'N'
		                                         end )
		                            from mdopparmt aa
		                           where aa.PTNO = a.PTNO
			                         and aa.OPRT_YMD = a.OPRT_YMD
			                         and aa.OPRT_SNO = a.OPRT_SNO
		                             and rownum =1),'NN') as ANST_RCRD_ITEM_DVSN_CD   /* 마취전방문기록 */
						,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  to_char(a.RCVY_ROM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시) */
						,  to_char(a.RCVY_ROM_CHOT_DT,'yyyymmddhh24mi') as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드      */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  RCVY_ROM_CHOT_PLAC_CD  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.RCVY_ROM_CHOT_PLAC_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  to_char(RCVY_ROM_CHOT_DT,'yyyymmddhh24mi')   as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  ''  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  '' as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                  /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
		                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
						,  decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)   as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							 --and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN                          /* 약반납건수내용 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, 'Y' as CMTX_OPRT_YN           /* 협진수술여부 */
						, ('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD =  a.ORDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   (select bb.USER_NM from CCUSRDPHT bb
											   where bb.USER_ID = a.OPSR_ID1 ) ||'('||
											   a.OPSR_ID1||') '||
											   a.CSCR_NM)  as CMTX_OPRT_NM           /* 협진수술명 */
						, e.MDRP_NO  as MDRP_NO           /* 진료접수번호 */
		               , NVL((select 'Y' from MDTRTORDT o
							where o.oprt_ymd = a.oprt_ymd
		                    and o.ptno = a.ptno
		                    and o.oprt_sno = a.oprt_sno
							and o.orcl_cd like 'AN%'
		                    and rownum =1 ), 'N') as ORDR_YN
		                ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
						, a.COLT_DVSN_CD as CLOT_DVSN_CD
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , '' as SUB_OPRT_CD_1
		                , '' as SUB_OPRT_CD_NM_1
		                , '' as SUB_OPRT_CD_2
		                , '' as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , 1 as CMTX_SEQ_NO
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
		                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
		                         and exists (select 1
		                                       from AICTRLMMT
		                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
		                                        and trunc(sysdate) between APST_YMD and APFN_YMD
		                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
		                         and exists (select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                      union all
		                                     select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
		                       then 'Y'
		                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		                , a.ANTP_RQRD_MI
						, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = cmtx.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between cmtx.OPRT_YMD and cmtx.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = cmtx.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = cmtx.CPDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = cmtx.CPDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
		                ,  MDOPSCCOT cmtx
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		                    and a.PTNO = cmtx.PTNO
		                  and a.OPRT_YMD = cmtx.OPRT_YMD
		                  and a.OPRT_SNO = cmtx.OPRT_SNO
		                  and  #{cmtxOprtYn} = #{cmtxOprtYn}
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} or cmtx.CPDP_CD  = #{ordpCd}
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( cmtx.CPDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                   ) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd} or cmtx.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId} or cmtx.CMTX_OPSR_ID1 = #{opsrId} ) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							  or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
						   (
							 (
							 nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							 nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							 nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							 nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							 nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							 nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							 ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
						   )
						   or
						   (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2','3') ) /*미착 -> 확정(2) */
						   or
						   (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
						   or
						   (
						   #{oprtSttsCd3} = 'Y' and /*진행 */
							 (
							   (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
							   or
							   (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
							   or
							   (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
							   or
							   (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
							   or
							   (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							 )
						   )
						  or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
						   or
						   (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						 )
		              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
		              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
					  and  b.PTNO(+)= a.PTNO					  
					  and  (
							   (a.PTNO in (select PTNO
											 from MNSOPMOVT xx
											where xx.PTNO         = a.PTNO
											  and xx.OPRT_YMD     = a.OPRT_YMD
											  and xx.OPRT_SNO     = a.OPRT_SNO
											  and xx.OPPL_DVSN_CD = nvl(#{opplCd},'M')
											  and xx.MVMN_PLAC_CD = 'E'))
							   or
							   ((a.OPRM_CHOT_DT is not null and
								 a.OPRM_CHOT_DT <= sysdate and
								 a.OPRM_CHOT_PADV_CD = '1' )
							   )
		                       or ( a.OPRT_STTS_CD in ('6','7','8') and
								 a.OPRM_CHOT_PADV_CD = '1' )
						   )
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
					 and  ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  (
							  #{nursId} is null or
							  (
								  y.MAIN_ASNU_ID = #{nursId}
								  or
								  y.SUB_ASNU_ID = #{nursId}
								  or
								  y.ASST_ASNU_ID = #{nursId}
							  )
						   )
		]]>
		</if>
		<![CDATA[
		union all
		select  /*+ NO_EXPAND LEADING(A, F, Y, X, G) USE_NL(A, B, E, F, G, Z, H, X, Y, I) 수술환자선택-회복실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
		                , a.oprm_cd|| '-'|| lpad(rank() over(partition by a.oprm_cd  order by to_char(a.opst_prrn_dt,'yyyymmddhh24miss')),2,'0') as AFI_APNT_PROR_NM
		                , (select p.detl_cd_nm from cccmcddmt p
		                   where p.comn_grp_cd='MM133'
		                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )  as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT = e.DSCH_DT
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT   /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1             /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
						,  (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )  as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																						     from MEDOCMBST xx
																					        where xx.PTNO           = a.PTNO
																					          and  xx.RCRD_DT       >= a.OPRT_YMD
																					          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																						      and  xx.BHVR_SNO       = a.OPRT_SNO
																						      and xx.RCRD_LAST_YN = 'Y'
																							  and nvl( xx.dltn_yn,'N') ='N'
																						      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                      and rownum = 1
		                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
		                                                                                 )
		                                                                              )
		                                                         )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCar코드   */
						,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  1
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM) as CSCR_NM             /* CaseCar명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                        when aa.RCRD_ID is not null then 'Y'
		                                        else 'Y' end ) 
		                                   || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                             when aa.RCRD_ID_2 is not null then 'Y'
		                                             else 'N'
		                                         end )
		                            from mdopparmt aa
		                           where aa.PTNO = a.PTNO
			                         and aa.OPRT_YMD = a.OPRT_YMD
			                         and aa.OPRT_SNO = a.OPRT_SNO
		                             and rownum =1),'NN') as ANST_RCRD_ITEM_DVSN_CD   /* 마취전방문기록 */
						,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  to_char(a.RCVY_ROM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시) */
						,  to_char(a.RCVY_ROM_CHOT_DT,'yyyymmddhh24mi') as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드      */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  RCVY_ROM_CHOT_PLAC_CD  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.RCVY_ROM_CHOT_PLAC_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  to_char(RCVY_ROM_CHOT_DT,'yyyymmddhh24mi')   as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  '' as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                  /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
		                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
						,  decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)   as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
						, ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							 --and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN                          /* 약반납건수내용 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN      /* 협진수술여부 */
						, (select LISTAGG('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = aa.CPDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM      /* 협진수술명 */
						, e.MDRP_NO  as MDRP_NO           /* 진료접수번호 */
		               , NVL((select 'Y' from MDTRTORDT o
							where o.oprt_ymd = a.oprt_ymd
		                    and o.ptno = a.ptno
		                    and o.oprt_sno = a.oprt_sno
							and o.orcl_cd like 'AN%'
		                    and rownum =1 ), 'N') as ORDR_YN
		                 ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
						, a.COLT_DVSN_CD as CLOT_DVSN_CD
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  2
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
		                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
		                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
		                                 , MEDOCMBST xc  /* 진료기록 */
		                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
		                         and xa.FORM_DVSN_CD = 'O'
		                         and xa.MDRP_NO = xb.MDRP_NO
		                         and xa.RCKI_CD = xb.RCKI_CD
		                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
		                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
		                         and xa.PTNO = xb.PTNO
		                         and xa.MDDR_ID = xb.MDDR_ID
		                         and xc.RCRD_NO = xa.RCRD_NO
		                         and xc.RCRD_SAVE_DVSN_CD = '1'
								 and nvl( xc.dltn_yn,'N') ='N'
		                         and xa.ptnt_rcrd_dx_sno =  3
		                         and rownum = 1
		                         and a.ORDP_CD = xa.MCDP_CD
		                         and a.PTNO     = xc.PTNO
		                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
		                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , 0 as CMTX_SEQ_NO
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
		                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
		                         and exists (select 1
		                                       from AICTRLMMT
		                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
		                                        and trunc(sysdate) between APST_YMD and APFN_YMD
		                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
		                         and exists (select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                      union all
		                                     select 1
		                                       from MZCTRLMMT
		                                      where MDCR_CTRL_CD = 'MNW_501'
		                                        and MDCR_DTLS_CTRL_CD = 'TERM'
		                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
		                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
		                       then 'Y'
		                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		                , a.ANTP_RQRD_MI
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} 
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                   ) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							  or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
						   (
							 (
							 nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							 nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							 nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							 nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							 nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							 nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							 ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
						   )
						   or
						   (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2','3') ) /*미착 -> 확정(2) */
						   or
						   (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
						   or
						   (
						   #{oprtSttsCd3} = 'Y' and /*진행 */
							 (
							   (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
							   or
							   (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
							   or
							   (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
							   or
							   (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
							   or
							   (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							 )
						   )
						  or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
						   or
						   (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						 )
		              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
		              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
					  and  b.PTNO(+)= a.PTNO					  
					  and  (
							   (a.PTNO in (select PTNO
											 from MNSOPMOVT xx
											where xx.PTNO         = a.PTNO
											  and xx.OPRT_YMD     = a.OPRT_YMD
											  and xx.OPRT_SNO     = a.OPRT_SNO
											  and xx.OPPL_DVSN_CD = nvl(#{opplCd},'M')
											  and xx.MVMN_PLAC_CD = 'E'))
							   or
							   ((a.OPRM_CHOT_DT is not null and
								 a.OPRM_CHOT_DT <= sysdate and
								 a.OPRM_CHOT_PADV_CD = '1' )
							   )
						   )
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD ='O'
					  and  (   e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd') and a.ordp_cd = e.mcdp_cd (+) )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  (
							  #{nursId} is null or
							  (
								  y.MAIN_ASNU_ID = #{nursId}
								  or
								  y.SUB_ASNU_ID = #{nursId}
								  or
								  y.ASST_ASNU_ID = #{nursId}
							  )
						   )
					order  by
						   OPRM_CHOT_DT desc
		                ,  PTNO
		                ,  CMTX_SEQ_NO
						,  ORDP_CD
						,  OPSR_ID_1
						,  OPRT_STTS_CD
						,  OPST_DT
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X3-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="frrn" column="FRRN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="crtfYn2" column="CRTF_YN_2"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="pcaYn" column="PCA_YN"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="afiAsnuNm1" column="AFI_ASNU_NM_1"/>
		<result property="afiAsnuNm2" column="AFI_ASNU_NM_2"/>
		<result property="afiAsnuNm3" column="AFI_ASNU_NM_3"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cmtxSeqNo" column="CMTX_SEQ_NO"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="pvanTrgtYn" column="PVAN_TRGT_YN"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X3 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X3-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X3"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X3-result" useCache="true" flushCache="false">
			/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X3 */
			<![CDATA[
					   select  /*+ MCP - PCA 환자조회 */
							   b.PTNT_NM as PTNT_NM                              /* 환자명 */
							,  a.PTNO as PTNO                                 /* 환자번호 */
							,  b.GEND_CD as GEND_CD                              /* 성별 */
							,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
							,  b.FRRN  as FRRN     /* 앞주민번호 */
							,  a.ORDP_CD as ORDP_CD
							,  decode(a.SBDP_CD, null
											   , ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.ORDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   ,
											   ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.SBDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
															 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
																 select  CARE_PTRM_NO
																   from  APRCRPTNT bb
																  where  bb.PTNO = e.PTNO
																	and  bb.CODV_CD = 'I'
																	and  bb.MDCR_DT = e.DSCH_DT
																	and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
							,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
							,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
							,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
							,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
							,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
							,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
							,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
							,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT     /* 수술시작예정일시 */
							,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1        /* 수술시작예정일시1 */
							,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
							,   (select cd.cd_nm from mnsopcdmt cd
											where cd.oprt_grp_cd = 'MSS_002'
											and cd.cd = a.OPRT_STTS_CD
			                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
							,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(xx.CRTF_YN, 'Y','C','N')
																							from MEDOCMBST xx
																						   where xx.PTNO         = a.PTNO
																							 and xx.RCRD_DT      = a.OPRT_YMD
																							 and xx.BHVR_SNO     = a.OPRT_SNO
																							 and xx.RCRD_LAST_YN = 'Y'
																							 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
			                                                                                 and rownum = 1
																							  )
			                                                               )
			                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
			               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
			                                                                                  from   MNZCERTMT yy  /* 인증 */
				                                                                             where
			                                                                         		  yy.PTNO           = a.PTNO
			                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
			                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
			                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
			                                                                                  and rownum = 1), decode(a.PTNO,y.PTNO,'S','N') ) )
			                                                               )
			                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
							,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM081'
									and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명 */
							,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
							,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
							,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
							,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
			                         and xa.ptnt_rcrd_dx_sno =  1
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM) as CSCR_NM             /* CaseCart명   */
							,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
							,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
							,  a.ER_YN as ER_YN /* 응급여부 */
							,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
							, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
									else
									  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																						 from CCUSERAMT a1
																						where a1.LGIN_ID = e.GNDR_ID)
											when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = a.OPSR_ID1) end)
									end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
							,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM441'
									and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
									and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
							,  a.CP_CD as CP_CD    /* CP코드  */
							,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
							,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
							,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
							,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시:수술실 퇴실일시) */
							,  ''  as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시      */
							,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드           */
							,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													   from CCCMCDDMT F_A
														  , CCCMCDDLT F_B
													  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
														and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
														and F_A.COMN_GRP_CD = 'MN909'
														and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
														and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
							,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
							,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
							,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
							,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
							,  '' as AFI_SLCT_CTN /* 선택내용(선택) */
							,  decode(a.ANSH_ID2,null,null,
									( select nvl(( select F_A.SMCR_YN
													 from APDSDRDPT F_A
													where F_A.MDDR_ID = a.ANSH_ID2
													  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
							, '' as SMCR_YN /* 선택진료여부 */
							,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
							,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
							,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
							,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
							, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
							, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
							,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
							,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
							,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
							,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
							,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
							,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
							,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
							,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
							,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
							,  (select  aa.PTNT_TLNO
								  from  APPTCNPNV aa
								 where  aa.PTNO = a.PTNO
								   and  aa.CNPN_DVSN_CD = '2'
								   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
																from APPTCNPNV bb
															   where bb.PTNO = a.PTNO
																 and bb.CNPN_DVSN_CD = '2'
																 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
							,  (select TS_YN
								  from MDCAOPCDT aa
								 where aa.MCDP_CD = a.ORDP_CD
								   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
							,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
							,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
							,  (case when exists (select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
							, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
							,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
							,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시  */
							, (
							  select  nvl(max('Y'), 'N')
								from  MDTRTORDT x         /* 처방료처방TABLE  */
							   where
									  x.PTNO     = a.PTNO
								 and  x.OPRT_YMD = a.OPRT_YMD
								 and  x.OPRT_SNO = a.OPRT_SNO
								 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
								 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
				   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
							)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
							,
							(
							  select  decode(count(*), 0, null
												   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
								from  MDMEDORDT z        /* 약처방TABLE */
							   where
									  z.PTNO = a.PTNO
								 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
								 and  z.OPRT_YMD = a.OPRT_YMD
								 and  z.OPRT_SNO = a.OPRT_SNO
								 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
								 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
								-- and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
							)  as AFI_DRRT_CCT_CTN
							, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
									when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN        /* 외국인여부 */
							, (select decode(count(a.PTNO),0,'','Y')
								 from MDOPSCCOT aa
								where aa.PTNO     = a.PTNO
								  and aa.OPRT_YMD = a.OPRT_YMD
								  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN   /* 협진수술여부 */
							, (select LISTAGG('['||( select
														 F_A.ABRV_DPRT_CD
													from
														 HZDEPTMMT F_A
												   where
														 F_A.DPRT_CD = aa.CPDP_CD
												   group by
														 F_A.ABRV_DPRT_CD )||'] '||
												   bb.USER_NM||'('||
												   aa.CMTX_OPSR_ID1||') '||
												   aa.CMTX_OPRT_CSCR_NM, chr(13))
									  WITHIN group (order by CPDP_CD)
								 from MDOPSCCOT aa
									, CCUSRDPHT bb
							   where aa.PTNO     = a.PTNO
								 and aa.OPRT_YMD = a.OPRT_YMD
								 and aa.OPRT_SNO = a.OPRT_SNO
								 and bb.USER_ID  = aa.CMTX_OPSR_ID1
							   group by
									 aa.PTNO
								   , aa.OPRT_YMD
								   , aa.OPRT_SNO)  as CMTX_OPRT_NM   /* 협진수술명 */
							, e.MDRP_NO  as MDRP_NO        /* 진료접수번호 */
			                , a.SBDP_CD as SBDP_CD
			                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
			                , a.ONCA_YN as ONCA_YN
			                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
			                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
			                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
			                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
			                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
			                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
			                         and xa.ptnt_rcrd_dx_sno =  2
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
			                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
			                         and xa.ptnt_rcrd_dx_sno =  3
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
			                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
			                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
			                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
			                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
			                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
			                , 0 as CMTX_SEQ_NO
			                , a.CSCR_CD_1 as CSCR_CD_1
			                , a.CSCR_NM_1 as CSCR_NM_1
			                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
			                ,'N ' as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		 			 		, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 			 		        from (
		 			 		      		 select 'Y' as OPRT_RCRD_YN
		 			 		      		      , CRTF_YN
		 			 		      		   from MEDOCMBST
		 			 		      		  where 1=1
		 			 		      		    and PTNO = a.PTNO
		 			 		      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 			 		      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 			 		      		    and BHVR_SNO = a.OPRT_SNO
		 			 		      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 			 		      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 			 		      		    and DLTN_YN = 'N'
		 			 		      		    and rownum = 1
		 			 		      		) f
		 			 		  ), 'N') as OPRT_RCRD_YN
		                    , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                    , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                    , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
						 from
							   MDCONSRCT z  /* 협진기록 */
							,  MDOPSCHET a  /* 수술스케줄 */
							,  APPTPTNTV b  /* 환자 */
							,  APRCRPTNT e  /* 진료접수 */
							,  MNSOPNRMT g  /* 수술간호기록 */
							,  CCUSERAMT z  /* OCS로그인정보 */
							,  CCUSRDPHT h  /* OCS사용자정보 */
							,  MNSAONRMT x  /* AOR 간호기록 */
							,  MNSREREMT y  /* 회복실기록 */
							,  MEANDOCMT i /* 마취기록 */
						where
							  z.ORDR_YMD between to_date(#{gPcaDateLocal},'yyyymmdd') and to_date(#{oprtYmd},'yyyymmdd')
						  and z.WNTD_DR_MCDP_CD = decode(#{opplCd},'M',FN_CC_GET_DPRT_CD('DPRT_APS')) /* 200429:APS(급성통증관리실), 200432:CAPS((암병원)급성통증관리실)  */
						  and z.CMTX_STTS_CD = '1'     /* 1:의뢰 */
						  and nvl(z.CNCL_YN,'N') = 'N'
						  and a.PTNO = z.PTNO
						  and z.ORDR_YMD between a.OPRT_YMD - 7 and a.OPRT_YMD + 1
						  and a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
			              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
			              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
						  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
						  and  ((#{anshId} is null)
							   or
								 (
								 a.ANSH_ID1 = #{anshId} or
								 a.ANSH_ID2 = #{anshId} or
								 a.ANSH_ID3 = #{anshId}
								 )
							   ) /* 마취의 */
						  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
						  and  (
								 (
									(
										nvl(#{codvCd1},'N') != 'Y' and
										nvl(#{codvCd2},'N') != 'Y' and
										nvl(#{codvCd3},'N') != 'Y' and
										nvl(#{codvCd4},'N') != 'Y'
									)
									and
									(1=1)
								 )
								 or
								 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
								 or
								 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
								 or
								 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
								 or
								 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
							   )
						  and  a.DFNT_YN = 'Y'
						  and  (
								 (
								   (
								   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
								   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
								   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
								   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
								   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
								   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
								   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
								 )
								 or
								 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ( '2', '3') ) /*미착 -> 확정(2) */
								 or
								 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
								 or
								 (
								 #{oprtSttsCd3} = 'Y' and /*진행 */
								   (
									 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
									 or
									 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
									 or
									 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
									 or
									 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
									 or
									 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
								   )
								 )
								 or
								 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
								 or
								 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
								 or
								 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
							   )
						  and ( a.OPPL_CD like nvl(#{opplCd},'M')||'%%' or a.OPPL_CD is null )
						  and  b.PTNO(+)= a.PTNO
			              and (
			                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
			              or
			                     (#{ankiCd1} = 'Y' and a.ANKI_CD = '01')
			              or
			                     (#{ankiCd2} = 'Y' and a.ANKI_CD not in ('01','02'))
			              or
			                     (#{ankiCd3} = 'Y' and a.ANKI_CD = '02')
			              )
			              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
						  and  e.PTNO(+)     = a.PTNO
						  and  e.CODV_CD(+)  = a.CODV_CD
			              and a.CODV_CD !='O'
						and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
			                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
						       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
						    )
						  and  e.CNCL_DT(+) is null
						  and  g.PTNO(+) = a.PTNO
						  and  g.OPRT_YMD(+)= a.OPRT_YMD
						  and  g.OPRT_SNO(+)= a.OPRT_SNO
						  and  h.USER_ID (+)= a.OPSR_ID1
						  and  z.LGIN_ID (+)= h.LGIN_ID
						  and  x.PTNO(+) = a.PTNO
						  and  x.OPRT_YMD(+)= a.OPRT_YMD
						  and  x.OPRT_SNO(+)= a.OPRT_SNO
						  and  y.PTNO(+) = a.PTNO
						  and  y.OPRT_YMD(+)= a.OPRT_YMD
						  and  y.OPRT_SNO(+)= a.OPRT_SNO
						  and  i.PTNO(+) = a.PTNO
						  and  i.OPRT_YMD(+)= a.OPRT_YMD
						  and  i.OPRT_SNO(+)= a.OPRT_SNO
			]]>
			<if test='cmtxOprtYn == "Y"'>
			<![CDATA[
			union all
			select  /*+ MCP - PCA 환자조회 */
							   b.PTNT_NM as PTNT_NM                              /* 환자명 */
							,  a.PTNO as PTNO                                 /* 환자번호 */
							,  b.GEND_CD as GEND_CD                              /* 성별 */
							,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
							,  b.FRRN  as FRRN     /* 앞주민번호 */
							,  cmtx.CPDP_CD as ORDP_CD
							,  decode(cmtx.SBDP_CD, null
											   , ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = cmtx.CPDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   ,
											   ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = cmtx.SBDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
															 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
																 select  CARE_PTRM_NO
																   from  APRCRPTNT bb
																  where  bb.PTNO = e.PTNO
																	and  bb.CODV_CD = 'I'
																	and  bb.MDCR_DT = e.DSCH_DT
																	and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
							,  cmtx.CMTX_OPSR_ID1  as OPSR_ID_1    /* 집도의사ID1 */
							,  cmtx.CMTX_OPSR_ID2  as OPSR_ID_2    /* 집도의사ID2 */
							,  cmtx.CMTX_OPSR_ID3  as OPSR_ID_3    /* 집도의사ID3 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
							,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
							,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
							,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
							,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
			                      where  f.MDCR_CTRL_CD      = 'MM130'
						          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
			                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
							,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT     /* 수술시작예정일시 */
							,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1        /* 수술시작예정일시1 */
							,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
							,   (select cd.cd_nm from mnsopcdmt cd
											where cd.oprt_grp_cd = 'MSS_002'
											and cd.cd = a.OPRT_STTS_CD
			                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
							,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(xx.CRTF_YN, 'Y','C','N')
																							from MEDOCMBST xx
																						   where xx.PTNO         = a.PTNO
																							 and xx.RCRD_DT      = a.OPRT_YMD
																							 and xx.BHVR_SNO     = a.OPRT_SNO
																							 and xx.RCRD_LAST_YN = 'Y'
																							 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
			                                                                                 and rownum = 1
																						     )
			                                                               )
			                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
			               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
			                                                                                  from   MNZCERTMT yy  /* 인증 */
				                                                                             where
			                                                                         		  yy.PTNO           = a.PTNO
			                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
			                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
			                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
			                                                                                  and rownum = 1), decode(a.PTNO,y.PTNO,'S','N') ) )
			                                                               )
			                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
							,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM081'
									and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명 */
							,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
							,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
							,  cmtx.CMTX_OPRT_CSCR_CD  as CSCR_CD           /* CaseCart코드  */
							,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
			                         and xa.ptnt_rcrd_dx_sno =  1
			                         and rownum = 1
			                         and cmtx.CPDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), cmtx.CMTX_OPRT_CSCR_NM) , cmtx.CMTX_OPRT_CSCR_NM)  as CSCR_NM           /* CaseCart명  */
							,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
							,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
							,  a.ER_YN as ER_YN /* 응급여부 */
							,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
							, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
									else
									  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																						 from CCUSERAMT a1
																						where a1.LGIN_ID = e.GNDR_ID)
											when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = a.OPSR_ID1) end)
									end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
							,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM441'
									and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
									and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
							,  a.CP_CD as CP_CD    /* CP코드  */
							,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
							,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
							,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
							,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시:수술실 퇴실일시) */
							,  ''  as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시      */
							,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드           */
							,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													   from CCCMCDDMT F_A
														  , CCCMCDDLT F_B
													  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
														and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
														and F_A.COMN_GRP_CD = 'MN909'
														and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
														and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
							,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
							,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
							,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
							,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
							,  ''  as AFI_SLCT_CTN /* 선택내용(선택) */
							,  decode(a.ANSH_ID2,null,null,
									( select nvl(( select F_A.SMCR_YN
													 from APDSDRDPT F_A
													where F_A.MDDR_ID = a.ANSH_ID2
													  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
							, '' as SMCR_YN /* 선택진료여부 */
							,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
							,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
							,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
							,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
							, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
							, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
							,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
							,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
							,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
							,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
							,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
							,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
							,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
							,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
							,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
							,  (select  aa.PTNT_TLNO
								  from  APPTCNPNV aa
								 where  aa.PTNO = a.PTNO
								   and  aa.CNPN_DVSN_CD = '2'
								   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
																from APPTCNPNV bb
															   where bb.PTNO = a.PTNO
																 and bb.CNPN_DVSN_CD = '2'
																 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
							,  (select TS_YN
								  from MDCAOPCDT aa
								 where aa.MCDP_CD = a.ORDP_CD
								   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
							,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
							,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
							,  (case when exists (select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
							, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
							,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
							,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시  */
							, (
							  select  nvl(max('Y'), 'N')
								from  MDTRTORDT x         /* 처방료처방TABLE  */
							   where
									  x.PTNO     = a.PTNO
								 and  x.OPRT_YMD = a.OPRT_YMD
								 and  x.OPRT_SNO = a.OPRT_SNO
								 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
								 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
				   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
							)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
							,
							(
							  select  decode(count(*), 0, null
												   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
								from  MDMEDORDT z        /* 약처방TABLE */
							   where
									  z.PTNO = a.PTNO
								 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
								 and  z.OPRT_YMD = a.OPRT_YMD
								 and  z.OPRT_SNO = a.OPRT_SNO
								 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
								 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
								-- and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
							)  as AFI_DRRT_CCT_CTN
							, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
									when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN        /* 외국인여부 */
							, 'Y' as CMTX_OPRT_YN           /* 협진수술여부 */
							, ('['||( select
														 F_A.ABRV_DPRT_CD
													from
														 HZDEPTMMT F_A
												   where
														 F_A.DPRT_CD =  a.ORDP_CD
												   group by
														 F_A.ABRV_DPRT_CD )||'] '||
												   (select bb.USER_NM from CCUSRDPHT bb
												   where bb.USER_ID = a.OPSR_ID1 ) ||'('||
												   a.OPSR_ID1||') '||
												   a.CSCR_NM)  as CMTX_OPRT_NM           /* 협진수술명 */
							, e.MDRP_NO  as MDRP_NO        /* 진료접수번호 */
			                , a.SBDP_CD as SBDP_CD
			                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
			                , a.ONCA_YN as ONCA_YN
			                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
			                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
			                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
			                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
			                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
			                , '' as SUB_OPRT_CD_1
			                , '' as SUB_OPRT_CD_NM_1
			                , '' as SUB_OPRT_CD_2
			                , '' as SUB_OPRT_CD_NM_2
			                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
			                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
			                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
			                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
			                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
			                , 1 as CMTX_SEQ_NO
			                , a.CSCR_CD_1 as CSCR_CD_1
			                , a.CSCR_NM_1 as CSCR_NM_1
			                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
			                ,'N ' as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
							, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 			 		        from (
		 			 		      		 select 'Y' as OPRT_RCRD_YN
		 			 		      		      , CRTF_YN
		 			 		      		   from MEDOCMBST
		 			 		      		  where 1=1
		 			 		      		    and PTNO = cmtx.PTNO
		 			 		      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 			 		      		    and RCRD_DT between cmtx.OPRT_YMD and cmtx.OPRT_YMD + 0.99999
		 			 		      		    and BHVR_SNO = cmtx.OPRT_SNO
		 			 		      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = cmtx.CPDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = cmtx.CPDP_CD
		                                                                and rownum = 1)))
		 			 		      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 			 		      		    and DLTN_YN = 'N'
		 			 		      		    and rownum = 1
		 			 		      		) f
		 			 		  ), 'N') as OPRT_RCRD_YN
		                    , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                    , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                    , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
						 from
							   MDCONSRCT z  /* 협진기록 */
							,  MDOPSCHET a  /* 수술스케줄 */
							,  APPTPTNTV b  /* 환자 */
							,  APRCRPTNT e  /* 진료접수 */
							,  MNSOPNRMT g  /* 수술간호기록 */
							,  CCUSERAMT z  /* OCS로그인정보 */
							,  CCUSRDPHT h  /* OCS사용자정보 */
							,  MNSAONRMT x  /* AOR 간호기록 */
							,  MNSREREMT y  /* 회복실기록 */
							,  MEANDOCMT i /* 마취기록 */
			                ,  MDOPSCCOT cmtx
						where
							  z.ORDR_YMD between to_date(#{gPcaDateLocal},'yyyymmdd') and to_date(#{oprtYmd},'yyyymmdd')
			               and a.PTNO = cmtx.PTNO
			                  and a.OPRT_YMD = cmtx.OPRT_YMD
			                  and a.OPRT_SNO = cmtx.OPRT_SNO
			                  and  #{cmtxOprtYn} = #{cmtxOprtYn}
						  and z.WNTD_DR_MCDP_CD = decode(#{opplCd},'M',FN_CC_GET_DPRT_CD('DPRT_APS')) /* 200429:APS(급성통증관리실), 200432:CAPS((암병원)급성통증관리실)  */
						  and z.CMTX_STTS_CD = '1'     /* 1:의뢰 */
						  and nvl(z.CNCL_YN,'N') = 'N'
						  and a.PTNO = z.PTNO
						  and z.ORDR_YMD between a.OPRT_YMD - 7 and a.OPRT_YMD + 1
						  and a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
			              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} or cmtx.CPDP_CD  = #{ordpCd}) /* 집도과 */
			              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd} or cmtx.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
						  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId} or cmtx.CMTX_OPSR_ID1 = #{opsrId} ) /* 집도의 */
						  and  ((#{anshId} is null)
							   or
								 (
								 a.ANSH_ID1 = #{anshId} or
								 a.ANSH_ID2 = #{anshId} or
								 a.ANSH_ID3 = #{anshId}
								 )
							   ) /* 마취의 */
						  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
						  and  (
								 (
									(
										nvl(#{codvCd1},'N') != 'Y' and
										nvl(#{codvCd2},'N') != 'Y' and
										nvl(#{codvCd3},'N') != 'Y' and
										nvl(#{codvCd4},'N') != 'Y'
									)
									and
									(1=1)
								 )
								 or
								 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
								 or
								 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
								 or
								 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
								 or
								 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
							   )
						  and  a.DFNT_YN = 'Y'
						  and  (
								 (
								   (
								   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
								   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
								   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
								   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
								   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
								   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
								   ) and a.OPRT_STTS_CD in ('2','3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
								 )
								 or
								 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2','3')) /*미착 -> 확정(2) */
								 or
								 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
								 or
								 (
								 #{oprtSttsCd3} = 'Y' and /*진행 */
								   (
									 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
									 or
									 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
									 or
									 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
									 or
									 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
									 or
									 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
								   )
								 )
								 or
								 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
								 or
								 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
								 or
								 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
							   )
						  and ( a.OPPL_CD like nvl(#{opplCd},'M')||'%%' or a.OPPL_CD is null )
						  and  b.PTNO(+)= a.PTNO					  
			              and (
			                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
			              or
			                     (#{ankiCd1} = 'Y' and a.ANKI_CD = '01')
			              or
			                     (#{ankiCd2} = 'Y' and a.ANKI_CD not in ('01','02'))
			              or
			                     (#{ankiCd3} = 'Y' and a.ANKI_CD = '02')
			              )
			              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
						  and  e.PTNO(+)     = a.PTNO
						  and  e.CODV_CD(+)  = a.CODV_CD
			              and a.CODV_CD !='O'
						and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
			                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
						       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
						    )
						  and  e.CNCL_DT(+) is null
						  and  g.PTNO(+) = a.PTNO
						  and  g.OPRT_YMD(+)= a.OPRT_YMD
						  and  g.OPRT_SNO(+)= a.OPRT_SNO
						  and  h.USER_ID (+)= a.OPSR_ID1
						  and  z.LGIN_ID (+)= h.LGIN_ID
						  and  x.PTNO(+) = a.PTNO
						  and  x.OPRT_YMD(+)= a.OPRT_YMD
						  and  x.OPRT_SNO(+)= a.OPRT_SNO
						  and  y.PTNO(+) = a.PTNO
						  and  y.OPRT_YMD(+)= a.OPRT_YMD
						  and  y.OPRT_SNO(+)= a.OPRT_SNO
						  and  i.PTNO(+) = a.PTNO
						  and  i.OPRT_YMD(+)= a.OPRT_YMD
						  and  i.OPRT_SNO(+)= a.OPRT_SNO
			]]>
			</if>
			<![CDATA[
			union all
			select  /*+ MCP - PCA 환자조회 */
							   b.PTNT_NM as PTNT_NM                              /* 환자명 */
							,  a.PTNO as PTNO                                 /* 환자번호 */
							,  b.GEND_CD as GEND_CD                              /* 성별 */
							,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
							,  b.FRRN  as FRRN     /* 앞주민번호 */
							,  a.ORDP_CD as ORDP_CD
							,  decode(a.SBDP_CD, null
											   , ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.ORDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   ,
											   ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.SBDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
															 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
																 select  CARE_PTRM_NO
																   from  APRCRPTNT bb
																  where  bb.PTNO = e.PTNO
																	and  bb.CODV_CD = 'I'
																	and  bb.MDCR_DT = e.DSCH_DT
																	and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
							,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
							,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
							,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
							,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
							,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
							,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
							,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
			                      where  f.MDCR_CTRL_CD      = 'MM130'
						          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
			                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
							,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT     /* 수술시작예정일시 */
							,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1        /* 수술시작예정일시1 */
							,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
							,   (select cd.cd_nm from mnsopcdmt cd
											where cd.oprt_grp_cd = 'MSS_002'
											and cd.cd = a.OPRT_STTS_CD
			                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
							,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(xx.CRTF_YN, 'Y','C','N')
																							from MEDOCMBST xx
																						   where xx.PTNO         = a.PTNO
																							 and xx.RCRD_DT      = a.OPRT_YMD
																							 and xx.BHVR_SNO     = a.OPRT_SNO
																							 and xx.RCRD_LAST_YN = 'Y'
																							 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
			                                                                                 and rownum = 1
																						       )
			                                                               )
			                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
			               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
			                                                                                  from   MNZCERTMT yy  /* 인증 */
				                                                                             where
			                                                                         		  yy.PTNO           = a.PTNO
			                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
			                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
			                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
			                                                                                  and rownum = 1), decode(a.PTNO,y.PTNO,'S','N') ) )
			                                                               )
			                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
							,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM081'
									and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명 */
							,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
							,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
							,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
							,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
			                         and xa.ptnt_rcrd_dx_sno =  1
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM) as CSCR_NM             /* CaseCart명   */
							,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
							,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
							,  a.ER_YN as ER_YN /* 응급여부 */
							,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
							, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
									else
									  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																						 from CCUSERAMT a1
																						where a1.LGIN_ID = e.GNDR_ID)
											when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = a.OPSR_ID1) end)
									end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
							,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM441'
									and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
									and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
							,  a.CP_CD as CP_CD    /* CP코드  */
							,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
							,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
							,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
							,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시:수술실 퇴실일시) */
							,  ''  as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시      */
							,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드           */
							,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													   from CCCMCDDMT F_A
														  , CCCMCDDLT F_B
													  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
														and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
														and F_A.COMN_GRP_CD = 'MN909'
														and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
														and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
							,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
							,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
							,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
							,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
							,  ''  as AFI_SLCT_CTN /* 선택내용(선택) */
							,  decode(a.ANSH_ID2,null,null,
									( select nvl(( select F_A.SMCR_YN
													 from APDSDRDPT F_A
													where F_A.MDDR_ID = a.ANSH_ID2
													  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
							,  '' as SMCR_YN /* 선택진료여부 */
							,  '' as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
							,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
							,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
							,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
							, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
							, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
							,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
							,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
							,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
							,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
							,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
							,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
							,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
							,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
							,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
							,  (select  aa.PTNT_TLNO
								  from  APPTCNPNV aa
								 where  aa.PTNO = a.PTNO
								   and  aa.CNPN_DVSN_CD = '2'
								   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
																from APPTCNPNV bb
															   where bb.PTNO = a.PTNO
																 and bb.CNPN_DVSN_CD = '2'
																 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
							,  (select TS_YN
								  from MDCAOPCDT aa
								 where aa.MCDP_CD = a.ORDP_CD
								   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
							,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
							,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
							,  (case when exists (select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
							, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
							,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
							,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시  */
							, (
							  select  nvl(max('Y'), 'N')
								from  MDTRTORDT x         /* 처방료처방TABLE  */
							   where
									  x.PTNO     = a.PTNO
								 and  x.OPRT_YMD = a.OPRT_YMD
								 and  x.OPRT_SNO = a.OPRT_SNO
								 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
								 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
				   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
							)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
							,
							(
							  select  decode(count(*), 0, null
												   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
								from  MDMEDORDT z        /* 약처방TABLE */
							   where
									  z.PTNO = a.PTNO
								 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
								 and  z.OPRT_YMD = a.OPRT_YMD
								 and  z.OPRT_SNO = a.OPRT_SNO
								 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
								 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
								-- and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
							)  as AFI_DRRT_CCT_CTN
							, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
									when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN        /* 외국인여부 */
							, (select decode(count(a.PTNO),0,'','Y')
								 from MDOPSCCOT aa
								where aa.PTNO     = a.PTNO
								  and aa.OPRT_YMD = a.OPRT_YMD
								  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN   /* 협진수술여부 */
							, (select LISTAGG('['||( select
														 F_A.ABRV_DPRT_CD
													from
														 HZDEPTMMT F_A
												   where
														 F_A.DPRT_CD = aa.CPDP_CD
												   group by
														 F_A.ABRV_DPRT_CD )||'] '||
												   bb.USER_NM||'('||
												   aa.CMTX_OPSR_ID1||') '||
												   aa.CMTX_OPRT_CSCR_NM, chr(13))
									  WITHIN group (order by CPDP_CD)
								 from MDOPSCCOT aa
									, CCUSRDPHT bb
							   where aa.PTNO     = a.PTNO
								 and aa.OPRT_YMD = a.OPRT_YMD
								 and aa.OPRT_SNO = a.OPRT_SNO
								 and bb.USER_ID  = aa.CMTX_OPSR_ID1
							   group by
									 aa.PTNO
								   , aa.OPRT_YMD
								   , aa.OPRT_SNO)  as CMTX_OPRT_NM   /* 협진수술명 */
							, e.MDRP_NO  as MDRP_NO        /* 진료접수번호 */
			                , a.SBDP_CD as SBDP_CD
			                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
			                , a.ONCA_YN as ONCA_YN
			                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
			                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
			                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
			                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
			                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
			                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
			                         and xa.ptnt_rcrd_dx_sno =  2
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
			                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
			                         and xa.ptnt_rcrd_dx_sno =  3
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
			                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
			                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
			                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
			                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
			                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
			                , 0 as CMTX_SEQ_NO
			                , a.CSCR_CD_1 as CSCR_CD_1
			                , a.CSCR_NM_1 as CSCR_NM_1
			                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
			                ,'N ' as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
		 			 		, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 			 		        from (
		 			 		      		 select 'Y' as OPRT_RCRD_YN
		 			 		      		      , CRTF_YN
		 			 		      		   from MEDOCMBST
		 			 		      		  where 1=1
		 			 		      		    and PTNO = a.PTNO
		 			 		      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 			 		      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 			 		      		    and BHVR_SNO = a.OPRT_SNO
		 			 		      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 			 		      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 			 		      		    and DLTN_YN = 'N'
		 			 		      		    and rownum = 1
		 			 		      		) f
		 			 		  ), 'N') as OPRT_RCRD_YN
		                    , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                    , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                    , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
						 from
							   MDCONSRCT z  /* 협진기록 */
							,  MDOPSCHET a  /* 수술스케줄 */
							,  APPTPTNTV b  /* 환자 */
							,  APRCRPTNT e  /* 진료접수 */
							,  MNSOPNRMT g  /* 수술간호기록 */
							,  CCUSERAMT z  /* OCS로그인정보 */
							,  CCUSRDPHT h  /* OCS사용자정보 */
							,  MNSAONRMT x  /* AOR 간호기록 */
							,  MNSREREMT y  /* 회복실기록 */
							,  MEANDOCMT i /* 마취기록 */
						where
							  z.ORDR_YMD between to_date(#{gPcaDateLocal},'yyyymmdd') and to_date(#{oprtYmd},'yyyymmdd')
						  and z.WNTD_DR_MCDP_CD = decode(#{opplCd},'M',FN_CC_GET_DPRT_CD('DPRT_APS')) /* 200429:APS(급성통증관리실), 200432:CAPS((암병원)급성통증관리실)  */
						  and z.CMTX_STTS_CD = '1'     /* 1:의뢰 */
						  and nvl(z.CNCL_YN,'N') = 'N'
						  and a.PTNO = z.PTNO
						  and z.ORDR_YMD between a.OPRT_YMD - 7 and a.OPRT_YMD + 1
						  and a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
			              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
			              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
						  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
						  and  ((#{anshId} is null)
							   or
								 (
								 a.ANSH_ID1 = #{anshId} or
								 a.ANSH_ID2 = #{anshId} or
								 a.ANSH_ID3 = #{anshId}
								 )
							   ) /* 마취의 */
						  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
						  and  (
								 (
									(
										nvl(#{codvCd1},'N') != 'Y' and
										nvl(#{codvCd2},'N') != 'Y' and
										nvl(#{codvCd3},'N') != 'Y' and
										nvl(#{codvCd4},'N') != 'Y'
									)
									and
									(1=1)
								 )
								 or
								 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
								 or
								 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
								 or
								 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
								 or
								 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
							   )
						  and  a.DFNT_YN = 'Y'
						  and  (
								 (
								   (
								   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
								   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
								   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
								   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
								   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
								   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
								   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
								 )
								 or
								 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ( '2', '3' ) ) /*미착 -> 확정(2) */
								 or
								 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
								 or
								 (
								 #{oprtSttsCd3} = 'Y' and /*진행 */
								   (
									 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
									 or
									 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
									 or
									 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
									 or
									 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
									 or
									 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
								   )
								 )
								 or
								 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
								 or
								 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
								 or
								 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
							   )
			              and (
			                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
			              or
			                     (#{ankiCd1} = 'Y' and a.ANKI_CD = '01')
			              or
			                     (#{ankiCd2} = 'Y' and a.ANKI_CD not in ('01','02'))
			              or
			                     (#{ankiCd3} = 'Y' and a.ANKI_CD = '02')
			              )
			              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
						  and ( a.OPPL_CD like nvl(#{opplCd},'M')||'%%' or a.OPPL_CD is null )
						  and  b.PTNO(+)= a.PTNO					  
						  and  e.PTNO(+)     = a.PTNO
						  and  e.CODV_CD(+)  = a.CODV_CD
			              and a.CODV_CD ='O'
						and (   e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')  and a.ordp_cd = e.mcdp_cd (+) )
						  and  e.CNCL_DT(+) is null
						  and  g.PTNO(+) = a.PTNO
						  and  g.OPRT_YMD(+)= a.OPRT_YMD
						  and  g.OPRT_SNO(+)= a.OPRT_SNO
						  and  h.USER_ID (+)= a.OPSR_ID1
						  and  z.LGIN_ID (+)= h.LGIN_ID
						  and  x.PTNO(+) = a.PTNO
						  and  x.OPRT_YMD(+)= a.OPRT_YMD
						  and  x.OPRT_SNO(+)= a.OPRT_SNO
						  and  y.PTNO(+) = a.PTNO
						  and  y.OPRT_YMD(+)= a.OPRT_YMD
						  and  y.OPRT_SNO(+)= a.OPRT_SNO
						  and  i.PTNO(+) = a.PTNO
						  and  i.OPRT_YMD(+)= a.OPRT_YMD
						  and  i.OPRT_SNO(+)= a.OPRT_SNO
						order  by
							   OPRM_CD
							,  OPST_PRRN_DT
			                ,  PTNO
			                ,  CMTX_SEQ_NO
							,  ORDP_CD
							,  OPSR_ID_1
							,  OPRT_STTS_CD
						]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X4-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="afiApntProrNm" column="AFI_APNT_PROR_NM"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="oprtPstnCtn" column="OPRT_PSTN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="frrn" column="FRRN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="crtfYn2" column="CRTF_YN_2"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="oprmChotPadvCd" column="OPRM_CHOT_PADV_CD"/>
		<result property="afiChotPadvNm" column="AFI_CHOT_PADV_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="afiCscrOrdrSttsNm" column="AFI_CSCR_ORDR_STTS_NM"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="pcaYn" column="PCA_YN"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="anstRcrdItemDvsnCd" column="ANST_RCRD_ITEM_DVSN_CD"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiInfcSttsNm3" column="AFI_INFC_STTS_NM_3"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="anstStrtDt1" column="ANST_STRT_DT_1"/>
		<result property="anstFnshDt1" column="ANST_FNSH_DT_1"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="oprtSafeCeckVl" column="OPRT_SAFE_CECK_VL"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="ordrYn" column="ORDR_YN"/>
		<result property="afiAgdcRtrnDvsnNm1" column="AFI_AGDC_RTRN_DVSN_NM_1"/>
		<result property="afiAgdcRtrnDvsnNm2" column="AFI_AGDC_RTRN_DVSN_NM_2"/>
		<result property="afiAgdcRtrnDvsnNm3" column="AFI_AGDC_RTRN_DVSN_NM_3"/>
		<result property="clotDt" column="CLOT_DT"/>
		<result property="clotDvsnCd" column="CLOT_DVSN_CD"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cmtxSeqNo" column="CMTX_SEQ_NO"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="pvanTrgtYn" column="PVAN_TRGT_YN"/>
		<result property="antpRqrdMi" column="ANTP_RQRD_MI"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X4 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X4-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X4"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X4-result" useCache="true" flushCache="false">
			/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X4 */
			<![CDATA[
			with t as (
					   select  /*+ 수술환자선택-마취실 환자조회 */
							   b.PTNT_NM as PTNT_NM                               /* 환자명 */
			                , (select p.detl_cd_nm from cccmcddmt p
			                   where p.comn_grp_cd='MM133'
			                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
							,  a.PTNO as PTNO                                 /* 환자번호 */
							,  b.GEND_CD as GEND_CD                              /* 성별 */
							,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
							,  b.FRRN  as FRRN     /* 앞주민번호 */
							,  a.ORDP_CD as ORDP_CD
							,  decode(a.SBDP_CD, null
											   , ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.ORDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   ,
											   ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.SBDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						   ,  (
							   case when e.CODV_CD = 'D' then nvl((
															 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
																 select  CARE_PTRM_NO
																   from  APRCRPTNT bb
																  where  bb.PTNO = e.PTNO
																	and  bb.CODV_CD = 'I'
																	and  bb.MDCR_DT = e.DSCH_DT
																	and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
							,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
							,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
							,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
							,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
							,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
							,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
							,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
							,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
							,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
							,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
							,   (select cd.cd_nm from mnsopcdmt cd
											where cd.oprt_grp_cd = 'MSS_002'
											and cd.cd = a.OPRT_STTS_CD
			                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
							,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																							     from MEDOCMBST xx
																						        where xx.PTNO           = a.PTNO
																						          and  xx.RCRD_DT       >= a.OPRT_YMD
																						          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																							      and  xx.BHVR_SNO       = a.OPRT_SNO
																							      and xx.RCRD_LAST_YN = 'Y'
																								  and nvl( xx.dltn_yn,'N') ='N'
																							      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
			                                                                                      and rownum = 1
			                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
			                                                                                 )
			                                                                              )
			                                                         )
			                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
			               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
			                                                                                  from   MNZCERTMT yy  /* 인증 */
				                                                                             where
			                                                                         		  yy.PTNO           = a.PTNO
			                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
			                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
			                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
			                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
			                                                               )
			                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
							,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM081'
									and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
							,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
							,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
							,  CSCR_CD as CSCR_CD             /* CaseCart코드 */
							,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
									 and nvl( xc.dltn_yn,'N') ='N'
			                         and xa.ptnt_rcrd_dx_sno =  1
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM) as CSCR_NM             /* CaseCart명  */
							,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
							,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
							, (case when a.OPRT_STTS_CD in ('2','9') then ''
									when a.OPRT_STTS_CD = '4' then '대기실'
									when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
									else 	( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN488'
													 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
							,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
							,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
							,  a.ER_YN as ER_YN /* 응급여부 */
							,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
							, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
									else
									  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																						 from CCUSERAMT a1
																						where a1.LGIN_ID = e.GNDR_ID)
											when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = a.OPSR_ID1) end)
									end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
							,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM441'
									and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
									and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
							,  a.CP_CD as CP_CD    /* CP코드  */
							,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
							,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
							,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
							, nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                 when aa.RCRD_ID is not null then 'Y'
		                                   else 'Y' end ) || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                   when aa.RCRD_ID_2 is not null then 'Y'
		                                 else 'N' end ) from mdopparmt aa
		                               where
				                         aa.PTNO           = a.PTNO
			                             and  aa.OPRT_YMD        = a.OPRT_YMD
			                             and  aa.OPRT_SNO       = a.OPRT_SNO
		                                 and rownum =1),'NN')  as ANST_RCRD_ITEM_DVSN_CD  /* 마취전방문기록 */
				   /*         ,  decode(a.OPRT_STTS_CD,'9','Y',decode(ENTPV_YN,'Y','Y',decode(a.ANKI_CD,'02','Y',( */
				   /*                                                                                                      select */
				   /*                                                                                                              decode(count(*),0,'N','Y') */
				   /*                                                                                                        from  MEDOCMBST aa */
				   /*                                                                                                       where */
				   /*                                                                                                              aa.PTNO           = a.PTNO */
				   /*                                                                                                         and  aa.RCRD_DT       >= a.OPRT_YMD */
				   /*                                                                                                         and  aa.RCRD_DT       <  a.OPRT_YMD + 1 */
				   /*                                                                                                         and  aa.BHVR_SNO       = a.OPRT_SNO */
				   /*                                                                                                         and  aa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_ANST_BEF_RCRD') --마취전 환자방문기록 */
				   /*                                                                                                         and  aa.RCRD_SAVE_DVSN_CD = '1'))))|| */
				   /*                                                                                                         decode(a.OPRT_STTS_CD,'9','Y',decode(ENTPV_YN,'Y','Y',decode(a.ANKI_CD,'02','Y',( */
				   /*                                                                                                      select */
				   /*                                                                                                              decode(count(*),0,'N','Y') */
				   /*                                                                                                        from  MEDOCMBST aa */
				   /*                                                                                                       where */
				   /*                                                                                                              aa.PTNO           = a.PTNO */
				   /*                                                                                                         and  aa.RCRD_DT       >= a.OPRT_YMD */
				   /*                                                                                                         and  aa.RCRD_DT       <  a.OPRT_YMD + 1 */
				   /*                                                                                                         and  aa.BHVR_SNO       = a.OPRT_SNO */
				   /*                                                                                                         and  aa.RCKI_CD = '082' --마취유도전평가기록 */
				   /*                                                                                                         and  aa.RCRD_SAVE_DVSN_CD = '1')))) as ANST_RCRD_ITEM_DVSN_CD  마취기록구분항목코드 */
							,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
							,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
							,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
														from CCCMCDDMT F_A
														   , CCCMCDDLT F_B
													   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
														 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
														 and F_A.COMN_GRP_CD = 'MN909'
														 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
														 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
							,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
			                ,  RCVY_ROM_CHOT_PLAC_CD  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
							, ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN488'
													 and F_A.COMN_DTLS_CD =  a.RCVY_ROM_CHOT_PLAC_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
							,  to_char(RCVY_ROM_CHOT_DT,'yyyymmddhh24mi')   as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
							,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
							,  decode(a.ANSH_ID2,null,null,
									( select nvl(( select F_A.SMCR_YN
													 from APDSDRDPT F_A
													where F_A.MDDR_ID = a.ANSH_ID2
													  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
							,  ''  as SMCR_YN /* 선택진료여부 */
							,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
							,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
							,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
							,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
			                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
							, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
							, (case when i.ANST_FNSH_DT is not null then 'Y' end)  as AFI_ANST_RCRD_FNSH_YN      /* 마취기록종료여부 */
							,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /* 회복실기록지 작성여부 */
							,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
							,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT              /* 마취시작일시 */
							,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT              /* 마취유도종료시간 */
							,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
							,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
							,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
							,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
							,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
							,  (select  aa.PTNT_TLNO
								  from  APPTCNPNV aa
								 where  aa.PTNO = a.PTNO
								   and  aa.CNPN_DVSN_CD = '2'
								   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
																from APPTCNPNV bb
															   where bb.PTNO = a.PTNO
																 and bb.CNPN_DVSN_CD = '2'
																 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
							,  (select TS_YN
								  from MDCAOPCDT aa
								 where aa.MCDP_CD = a.ORDP_CD
								   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* TS */
							,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
							,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
							,  (case when exists (select
														'X'
												  from
														MDOPSCHHT
												 where  PTNO     = a.PTNO
												   and  OPRT_YMD = a.OPRT_YMD
												   and  OPRT_SNO = a.OPRT_SNO
												   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
							, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
							,  ''  as AOR_PRRM_ENRM_DT                         /* 준비실 입실일시 */
							,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
							, (
							  select  nvl(max('Y'), 'N')
								from  MDTRTORDT x         /* 처방료처방TABLE  */
							   where
									  x.PTNO     = a.PTNO
								 and  x.OPRT_YMD = a.OPRT_YMD
								 and  x.OPRT_SNO = a.OPRT_SNO
								 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
								 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
				   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
							)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
							,
							(
							  select  decode(count(*), 0, null
												   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||'/'|| count(*))
								from  MDMEDORDT z        /* 약처방TABLE */
							   where
									  z.PTNO = a.PTNO
								 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
								 and  z.OPRT_YMD = a.OPRT_YMD
								 and  z.OPRT_SNO = a.OPRT_SNO
								 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
								 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							--	 and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
							)  as AFI_DRRT_CCT_CTN
							, to_char(i.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT_1 /* 마취시작일시 */
							, to_char(i.ANST_FNSH_DT,'AM hh12:mi')  as ANST_FNSH_DT_1 /* 마취종료일시 */
							, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
									when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
							, (select decode(count(a.PTNO),0,'','Y')
								 from MDOPSCCOT aa
								where aa.PTNO     = a.PTNO
								  and aa.OPRT_YMD = a.OPRT_YMD
								  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
							, (select LISTAGG('['|| (select
														 F_A.ABRV_DPRT_CD
													from
														 HZDEPTMMT F_A
												   where
														 F_A.DPRT_CD = aa.CPDP_CD
												   group by
														 F_A.ABRV_DPRT_CD) ||'] '||
												   bb.USER_NM||'('||
												   aa.CMTX_OPSR_ID1||') '||
												   aa.CMTX_OPRT_CSCR_NM, chr(13))
									  WITHIN group (order by CPDP_CD)
								 from MDOPSCCOT aa
									, CCUSRDPHT bb
							   where aa.PTNO     = a.PTNO
								 and aa.OPRT_YMD = a.OPRT_YMD
								 and aa.OPRT_SNO = a.OPRT_SNO
								 and bb.USER_ID  = aa.CMTX_OPSR_ID1
							   group by
									 aa.PTNO
								   , aa.OPRT_YMD
								   , aa.OPRT_SNO)  as CMTX_OPRT_NM           /* 협진수술명 */
							, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
					                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
					                 and rownum=1) ,null,'N','Y')||
							  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
							                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
							                 and rownum=1) ,null,'N','Y')||
							  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
							                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
							                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
							, e.MDRP_NO  as MDRP_NO   /* 진료접수번호 */
			                , NVL((select 'Y' from MDTRTORDT o
								where o.oprt_ymd = a.oprt_ymd
			                    and o.ptno = a.ptno
			                    and o.oprt_sno = a.oprt_sno
								and o.orcl_cd like 'AN%'
			                    and rownum =1 ), 'N') as ORDR_YN
			             , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'OP')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum = 1
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
								)) as afi_agdc_rtrn_dvsn_nm_1  --수술동의서 유무
			             , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'AN')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum = 1
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
			                   )) as afi_agdc_rtrn_dvsn_nm_2 --마취동의서 유무
			             , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'PCA')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum = 1
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
			                   )) as afi_agdc_rtrn_dvsn_nm_3 --PCA동의서 유무
			                ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
							, a.COLT_DVSN_CD as CLOT_DVSN_CD
			                , a.SBDP_CD as SBDP_CD
			                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
			                , a.ONCA_YN as ONCA_YN
			                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
			                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
			                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
			                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
			                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
			                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
									 and nvl( xc.dltn_yn,'N') ='N'
			                         and xa.ptnt_rcrd_dx_sno =  2
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
			                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
									 and nvl( xc.dltn_yn,'N') ='N'
			                         and xa.ptnt_rcrd_dx_sno =  3
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
			                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
			                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
			                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
			                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
			                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
			                , 0 as CMTX_SEQ_NO
			                , a.CSCR_CD_1 as CSCR_CD_1
			                , a.CSCR_NM_1 as CSCR_NM_1
			                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
			                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
			                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
			                         and exists (select 1
			                                       from AICTRLMMT
			                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
			                                        and trunc(sysdate) between APST_YMD and APFN_YMD
			                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
			                         and exists (select 1
			                                       from MZCTRLMMT
			                                      where MDCR_CTRL_CD = 'MNW_501'
			                                        and MDCR_DTLS_CTRL_CD = 'TERM'
			                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
			                                      union all
			                                     select 1
			                                       from MZCTRLMMT
			                                      where MDCR_CTRL_CD = 'MNW_501'
			                                        and MDCR_DTLS_CTRL_CD = 'TERM'
			                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
			                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
			                       then 'Y'
			                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
			                   , a.ANTP_RQRD_MI
		 				    , nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				            from (
		 				          		 select 'Y' as OPRT_RCRD_YN
		 				      	    	      , CRTF_YN
		 				      		       from MEDOCMBST
		 				      		      where 1=1
		 				      		        and PTNO = a.PTNO
		 				      		        and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		        and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		        and BHVR_SNO = a.OPRT_SNO
		 				      		        and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		        and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		        and DLTN_YN = 'N'
		 				      		        and rownum = 1
		 				      		    ) f
		 				      ), 'N') as OPRT_RCRD_YN
		                    , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                    , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                    , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
						 from
							   MDOPSCHET a /* 수술스케줄 */
							,  APPTPTNTV b /* 환자 */
							,  APRCRPTNT e /* 진료접수 */
							,  MNSOPNRMT g /* 수술간호기록 */
							,  CCUSERAMT z /* OCS로그인정보 */
							,  CCUSRDPHT h /* OCS사용자정보 */
							,  MNSAONRMT x /* AOR 간호기록 */
							,  MNSREREMT y /* 회복실기록 */
							,  MEANDOCMT i /* 마취기록지 */
						where
							   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
			              and a.CODV_CD = decode(#{opplCd},'D','D', a.CODV_CD)
			              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} 
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                   ) /* 집도과 */
			              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
						  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
						  and  ((#{anshId} is null)
							   or
								 (
								 a.ANSH_ID1 = #{anshId} or
								 a.ANSH_ID2 = #{anshId} or
								 a.ANSH_ID3 = #{anshId}
								 )
							   ) /* 마취의 */
						  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
						  and  (
								  (
									 (
										 nvl(#{codvCd1},'N') != 'Y' and
										 nvl(#{codvCd2},'N') != 'Y' and
										 nvl(#{codvCd3},'N') != 'Y' and
										 nvl(#{codvCd4},'N') != 'Y'
									 )
									 and
									 (1=1)
								  )
								  or
								 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
								 or
								 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
								 or
								 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
								 or
								 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
							   )
						  and  ( a.DFNT_YN = 'Y' or #{dprmInrlOprtYn} ='Y' )
						  and  (
								 (
								   (
								   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
								   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
								   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
								   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
								   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
								   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
								   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
								 )
								 or
								 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in  ('2','3') ) /*미착 -> 확정(2) */
								 or
								 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
								 or
								 (
								 #{oprtSttsCd3} = 'Y' and /*진행 */
								   (
									 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
									 or
									 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
									 or
									 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
									 or
									 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
									 or
									 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
								   )
								 )
								 or
								 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
								 or
								 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
								 or
								 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
							   )
			              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
			              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
						  and  b.PTNO(+)= a.PTNO					  
						  and  (a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD) or a.OPPL_CD is null )
						  and  e.PTNO(+)     = a.PTNO
						  and  e.CODV_CD(+)  = a.CODV_CD
			              and a.CODV_CD !='O'
						and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
			                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
						       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd') )
						    )
						  and  e.CNCL_DT(+) is null
						  and  g.PTNO(+) = a.PTNO
						  and  g.OPRT_YMD(+)= a.OPRT_YMD
						  and  g.OPRT_SNO(+)= a.OPRT_SNO
						  and  h.USER_ID (+)= a.OPSR_ID1
						  and  z.LGIN_ID (+)= h.LGIN_ID
						  and  x.PTNO(+) = a.PTNO
						  and  x.OPRT_YMD(+)= a.OPRT_YMD
						  and  x.OPRT_SNO(+)= a.OPRT_SNO
						  and  y.PTNO(+) = a.PTNO
						  and  y.OPRT_YMD(+)= a.OPRT_YMD
						  and  y.OPRT_SNO(+)= a.OPRT_SNO
						  and  i.PTNO(+) = a.PTNO
						  and  i.OPRT_YMD(+)= a.OPRT_YMD
						  and  i.OPRT_SNO(+)= a.OPRT_SNO
			]]>
			<if test='cmtxOprtYn == "Y"'>
			<![CDATA[
			union all
			select  /*+ 수술환자선택-수술실 환자조회 */
							   b.PTNT_NM as PTNT_NM                              /* 환자명 */
			                , (select p.detl_cd_nm from cccmcddmt p
			                   where p.comn_grp_cd='MM133'
			                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
							,  a.PTNO as PTNO                                 /* 환자번호 */
							,  b.GEND_CD as GEND_CD                              /* 성별 */
							,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
							,  b.FRRN  as FRRN     /* 앞주민번호 */
							,  cmtx.CPDP_CD as ORDP_CD
							,  decode(cmtx.SBDP_CD, null
											   , ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = cmtx.CPDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   ,
											   ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = cmtx.SBDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						   ,  (
							   case when e.CODV_CD = 'D' then nvl((
															 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
																 select  CARE_PTRM_NO
																   from  APRCRPTNT bb
																  where  bb.PTNO = e.PTNO
																	and  bb.CODV_CD = 'I'
																	and  bb.MDCR_DT = e.DSCH_DT
																	and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
							,  cmtx.CMTX_OPSR_ID1  as OPSR_ID_1    /* 집도의사ID1 */
							,  cmtx.CMTX_OPSR_ID2  as OPSR_ID_2    /* 집도의사ID2 */
							,  cmtx.CMTX_OPSR_ID3  as OPSR_ID_3    /* 집도의사ID3 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = cmtx.CMTX_OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
							,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
							,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
							,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
							,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
							,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
							,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
							,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
							,   (select cd.cd_nm from mnsopcdmt cd
											where cd.oprt_grp_cd = 'MSS_002'
											and cd.cd = a.OPRT_STTS_CD
			                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
							,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																							     from MEDOCMBST xx
																						        where xx.PTNO           = a.PTNO
																						          and  xx.RCRD_DT       >= a.OPRT_YMD
																						          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																							      and  xx.BHVR_SNO       = a.OPRT_SNO
																							      and xx.RCRD_LAST_YN = 'Y'
																								  and nvl( xx.dltn_yn,'N') ='N'
																							      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
			                                                                                      and rownum = 1
			                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
			                                                                                 )
			                                                                              )
			                                                         )
			                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
			               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
			                                                                                  from   MNZCERTMT yy  /* 인증 */
				                                                                             where
			                                                                         		  yy.PTNO           = a.PTNO
			                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
			                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
			                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
			                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
			                                                               )
			                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
							,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM081'
									and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
							,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
							,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
							,  cmtx.CMTX_OPRT_CSCR_CD  as CSCR_CD           /* CaseCart코드  */
							,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
									 and nvl( xc.dltn_yn,'N') ='N'
			                         and xa.ptnt_rcrd_dx_sno =  1
			                         and rownum = 1
			                         and cmtx.CPDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), cmtx.CMTX_OPRT_CSCR_NM) , cmtx.CMTX_OPRT_CSCR_NM)  as CSCR_NM           /* CaseCart명  */
							,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
							,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
							, (case when a.OPRT_STTS_CD in ('2','9') then ''
									when a.OPRT_STTS_CD = '4' then '대기실'
									when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
									else 	( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN488'
													 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
							,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
							,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
							,  a.ER_YN as ER_YN /* 응급여부 */
							,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
							, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
									else
									  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																						 from CCUSERAMT a1
																						where a1.LGIN_ID = e.GNDR_ID)
											when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = a.OPSR_ID1) end)
									end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
							,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM441'
									and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
									and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
							,  a.CP_CD as CP_CD    /* CP코드  */
							,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
							,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
							,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
			                , nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                 when aa.RCRD_ID is not null then 'Y'
		                                   else 'Y' end ) || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                   when aa.RCRD_ID_2 is not null then 'Y'
		                                 else 'N' end ) from mdopparmt aa
		                               where
				                         aa.PTNO           = a.PTNO
			                             and  aa.OPRT_YMD        = a.OPRT_YMD
			                             and  aa.OPRT_SNO       = a.OPRT_SNO
		                                 and rownum =1),'NN')  as ANST_RCRD_ITEM_DVSN_CD  /* 마취전방문기록 */
								   /*         ,  decode(a.OPRT_STTS_CD,'9','Y',decode(ENTPV_YN,'Y','Y',decode(a.ANKI_CD,'02','Y',( */
				   /*                                                                                                      select */
				   /*                                                                                                              decode(count(*),0,'N','Y') */
				   /*                                                                                                        from  MEDOCMBST aa */
				   /*                                                                                                       where */
				   /*                                                                                                              aa.PTNO           = a.PTNO */
				   /*                                                                                                         and  aa.RCRD_DT       >= a.OPRT_YMD */
				   /*                                                                                                         and  aa.RCRD_DT       <  a.OPRT_YMD + 1 */
				   /*                                                                                                         and  aa.BHVR_SNO       = a.OPRT_SNO */
				   /*                                                                                                         and  aa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_ANST_BEF_RCRD') --마취전 환자방문기록 */
				   /*                                                                                                         and  aa.RCRD_SAVE_DVSN_CD = '1'))))|| */
				   /*                                                                                                         decode(a.OPRT_STTS_CD,'9','Y',decode(ENTPV_YN,'Y','Y',decode(a.ANKI_CD,'02','Y',( */
				   /*                                                                                                      select */
				   /*                                                                                                              decode(count(*),0,'N','Y') */
				   /*                                                                                                        from  MEDOCMBST aa */
				   /*                                                                                                       where */
				   /*                                                                                                              aa.PTNO           = a.PTNO */
				   /*                                                                                                         and  aa.RCRD_DT       >= a.OPRT_YMD */
				   /*                                                                                                         and  aa.RCRD_DT       <  a.OPRT_YMD + 1 */
				   /*                                                                                                         and  aa.BHVR_SNO       = a.OPRT_SNO */
				   /*                                                                                                         and  aa.RCKI_CD = '082' --마취유도전평가기록 */
				   /*                                                                                                         and  aa.RCRD_SAVE_DVSN_CD = '1')))) as ANST_RCRD_ITEM_DVSN_CD  마취기록구분항목코드 */
							,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
							,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
							,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
														from CCCMCDDMT F_A
														   , CCCMCDDLT F_B
													   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
														 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
														 and F_A.COMN_GRP_CD = 'MN909'
														 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
														 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
							,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
			                ,  RCVY_ROM_CHOT_PLAC_CD  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
							, ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN488'
													 and F_A.COMN_DTLS_CD =  a.RCVY_ROM_CHOT_PLAC_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
							,  to_char(RCVY_ROM_CHOT_DT,'yyyymmddhh24mi')   as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
							,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
							,  decode(a.ANSH_ID2,null,null,
									( select nvl(( select F_A.SMCR_YN
													 from APDSDRDPT F_A
													where F_A.MDDR_ID = a.ANSH_ID2
													  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
							,  ''  as SMCR_YN /* 선택진료여부 */
							,  '' as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
							,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
							,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
							,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
			                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
							, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
							, (case when i.ANST_FNSH_DT is not null then 'Y' end)  as AFI_ANST_RCRD_FNSH_YN      /* 마취기록종료여부 */
							,  decode(a.PTNO,y.PTNO,'Y',(case when exists (select 'X'
																			 from MNANBENTT xx
																			where xx.PTNO     = a.PTNO
																			  and xx.OPRT_YMD = a.OPRT_YMD
																			  and xx.OPRT_SNO = a.OPRT_SNO) then 'Y' else 'N' end))  as AFI_PACU_RCRD_WRTG_YN            /* 회복실기록지 작성여부 */
							,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
							,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT              /* 마취시작일시 */
							,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT              /* 마취유도종료시간 */
							,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
							,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
							,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
							,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
							,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
							,  (select  aa.PTNT_TLNO
								  from  APPTCNPNV aa
								 where  aa.PTNO = a.PTNO
								   and  aa.CNPN_DVSN_CD = '2'
								   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
																from APPTCNPNV bb
															   where bb.PTNO = a.PTNO
																 and bb.CNPN_DVSN_CD = '2'
																 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
							,  (select TS_YN
								  from MDCAOPCDT aa
								 where aa.MCDP_CD = a.ORDP_CD
								   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* TS */
							,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
							,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
							,  (case when exists (select
														'X'
												  from
														MDOPSCHHT
												 where  PTNO     = a.PTNO
												   and  OPRT_YMD = a.OPRT_YMD
												   and  OPRT_SNO = a.OPRT_SNO
												   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
							, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
							,  ''  as AOR_PRRM_ENRM_DT                         /* 준비실 입실일시 */
							,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
							, (
							  select  nvl(max('Y'), 'N')
								from  MDTRTORDT x         /* 처방료처방TABLE  */
							   where
									  x.PTNO     = a.PTNO
								 and  x.OPRT_YMD = a.OPRT_YMD
								 and  x.OPRT_SNO = a.OPRT_SNO
								 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
								 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
				   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
							)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
							,
							(
							  select  decode(count(*), 0, null
												   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||'/'|| count(*))
								from  MDMEDORDT z        /* 약처방TABLE */
							   where
									  z.PTNO = a.PTNO
								 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
								 and  z.OPRT_YMD = a.OPRT_YMD
								 and  z.OPRT_SNO = a.OPRT_SNO
								 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
								 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							)  as AFI_DRRT_CCT_CTN
							, to_char(i.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT_1 /* 마취시작일시 */
							, to_char(i.ANST_FNSH_DT,'AM hh12:mi')  as ANST_FNSH_DT_1 /* 마취종료일시 */
							, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
									when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
							, 'Y' as CMTX_OPRT_YN           /* 협진수술여부 */
							, ('['||( select
														 F_A.ABRV_DPRT_CD
													from
														 HZDEPTMMT F_A
												   where
														 F_A.DPRT_CD =  a.ORDP_CD
												   group by
														 F_A.ABRV_DPRT_CD )||'] '||
												   (select bb.USER_NM from CCUSRDPHT bb
												   where bb.USER_ID = a.OPSR_ID1 ) ||'('||
												   a.OPSR_ID1||') '||
												   a.CSCR_NM)  as CMTX_OPRT_NM           /* 협진수술명 */
							, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
					                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
					                 and rownum=1) ,null,'N','Y')||
							  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
							                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
							                 and rownum=1) ,null,'N','Y')||
							  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
							                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
							                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
							, e.MDRP_NO  as MDRP_NO   /* 진료접수번호 */
			                , NVL((select 'Y' from MDTRTORDT o
								where o.oprt_ymd = a.oprt_ymd
			                    and o.ptno = a.ptno
			                    and o.oprt_sno = a.oprt_sno
								and o.orcl_cd like 'AN%'
			                    and rownum =1 ), 'N') as ORDR_YN
			             , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'OP')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum = 1
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no)) as afi_agdc_rtrn_dvsn_nm_1  --수술동의서 유무
			             , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'AN')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum =1 
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
								)) as afi_agdc_rtrn_dvsn_nm_2 --마취동의서 유무
			             , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'PCA')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum = 1
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
			                   )) as afi_agdc_rtrn_dvsn_nm_3 --PCA동의서 유무
			                ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
							, a.COLT_DVSN_CD as CLOT_DVSN_CD
			                , a.SBDP_CD as SBDP_CD
			                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
			                , a.ONCA_YN as ONCA_YN
			                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
			                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
			                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
			                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
			                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
			                , '' as SUB_OPRT_CD_1
			                , '' as SUB_OPRT_CD_NM_1
			                , '' as SUB_OPRT_CD_2
			                , '' as SUB_OPRT_CD_NM_2
			                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
			                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
			                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
			                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
			                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
			                , 1 as CMTX_SEQ_NO
			                , a.CSCR_CD_1 as CSCR_CD_1
			                , a.CSCR_NM_1 as CSCR_NM_1
			                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
			                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
			                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
			                         and exists (select 1
			                                       from AICTRLMMT
			                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
			                                        and trunc(sysdate) between APST_YMD and APFN_YMD
			                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
			                         and exists (select 1
			                                       from MZCTRLMMT
			                                      where MDCR_CTRL_CD = 'MNW_501'
			                                        and MDCR_DTLS_CTRL_CD = 'TERM'
			                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
			                                      union all
			                                     select 1
			                                       from MZCTRLMMT
			                                      where MDCR_CTRL_CD = 'MNW_501'
			                                        and MDCR_DTLS_CTRL_CD = 'TERM'
			                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
			                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
			                       then 'Y'
			                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
			                , a.ANTP_RQRD_MI
						    , nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				            from (
		 				          		 select 'Y' as OPRT_RCRD_YN
		 				      	    	      , CRTF_YN
		 				      		       from MEDOCMBST
		 				      		      where 1=1
		 				      		        and PTNO = cmtx.PTNO
		 				      		        and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		        and RCRD_DT between cmtx.OPRT_YMD and cmtx.OPRT_YMD + 0.99999
		 				      		        and BHVR_SNO = cmtx.OPRT_SNO
		 				      		        and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = cmtx.CPDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = cmtx.CPDP_CD
		                                                                and rownum = 1)))
		 				      		        and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		        and DLTN_YN = 'N'
		 				      		        and rownum = 1
		 				      		    ) f
		 				      ), 'N') as OPRT_RCRD_YN
		                    , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                    , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                    , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
						 from
							   MDOPSCHET a /* 수술스케줄 */
							,  APPTPTNTV b /* 환자 */
							,  APRCRPTNT e /* 진료접수 */
							,  MNSOPNRMT g /* 수술간호기록 */
							,  CCUSERAMT z /* OCS로그인정보 */
							,  CCUSRDPHT h /* OCS사용자정보 */
							,  MNSAONRMT x /* AOR 간호기록 */
							,  MNSREREMT y /* 회복실기록 */
							,  MEANDOCMT i /* 마취기록지 */
			                ,  MDOPSCCOT cmtx
						where
							   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
			              and a.CODV_CD = decode(#{opplCd},'D','D', a.CODV_CD)
			              and a.PTNO = cmtx.PTNO
			                  and a.OPRT_YMD = cmtx.OPRT_YMD
			                  and a.OPRT_SNO = cmtx.OPRT_SNO
			                  and  #{cmtxOprtYn} = #{cmtxOprtYn}
			              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} or cmtx.CPDP_CD  = #{ordpCd}
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( cmtx.CPDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                   ) /* 집도과 */
			              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd} or cmtx.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
						  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId} or cmtx.CMTX_OPSR_ID1 = #{opsrId} ) /* 집도의 */
						  and  ((#{anshId} is null)
							   or
								 (
								 a.ANSH_ID1 = #{anshId} or
								 a.ANSH_ID2 = #{anshId} or
								 a.ANSH_ID3 = #{anshId}
								 )
							   ) /* 마취의 */
						  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
						  and  (
								  (
									 (
										 nvl(#{codvCd1},'N') != 'Y' and
										 nvl(#{codvCd2},'N') != 'Y' and
										 nvl(#{codvCd3},'N') != 'Y' and
										 nvl(#{codvCd4},'N') != 'Y'
									 )
									 and
									 (1=1)
								  )
								  or
								 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
								 or
								 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
								 or
								 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
								 or
								 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
							   )
						  and  ( a.DFNT_YN = 'Y'  or #{dprmInrlOprtYn} ='Y' )
						  and  (
								 (
								   (
								   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
								   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
								   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
								   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
								   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
								   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
								   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
								 )
								 or
								 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in  ('2', '3') ) /*미착 -> 확정(2) */
								 or
								 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
								 or
								 (
								 #{oprtSttsCd3} = 'Y' and /*진행 */
								   (
									 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
									 or
									 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
									 or
									 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
									 or
									 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
									 or
									 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
								   )
								 )
								 or
								 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
								 or
								 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
								 or
								 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
							   )
			              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
			              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
						  and  b.PTNO(+)= a.PTNO					  
						  and  (a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD) or a.OPPL_CD is null )
						  and  e.PTNO(+)     = a.PTNO
						  and  e.CODV_CD(+)  = a.CODV_CD
			              and a.CODV_CD !='O'
						and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
			                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
						       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd') )
						    )
						  and  e.CNCL_DT(+) is null
						  and  g.PTNO(+) = a.PTNO
						  and  g.OPRT_YMD(+)= a.OPRT_YMD
						  and  g.OPRT_SNO(+)= a.OPRT_SNO
						  and  h.USER_ID (+)= a.OPSR_ID1
						  and  z.LGIN_ID (+)= h.LGIN_ID
						  and  x.PTNO(+) = a.PTNO
						  and  x.OPRT_YMD(+)= a.OPRT_YMD
						  and  x.OPRT_SNO(+)= a.OPRT_SNO
						  and  y.PTNO(+) = a.PTNO
						  and  y.OPRT_YMD(+)= a.OPRT_YMD
						  and  y.OPRT_SNO(+)= a.OPRT_SNO
						  and  i.PTNO(+) = a.PTNO
						  and  i.OPRT_YMD(+)= a.OPRT_YMD
						  and  i.OPRT_SNO(+)= a.OPRT_SNO
			]]>
			</if>
			<![CDATA[
			union all
			select  /*+ 수술환자선택-수술실 환자조회 */
							   b.PTNT_NM as PTNT_NM                              /* 환자명 */
			                , (select p.detl_cd_nm from cccmcddmt p
			                   where p.comn_grp_cd='MM133'
			                    and p.comn_dtls_cd = a.OPRT_PSTN_CD ) OPRT_PSTN_CTN
							,  a.PTNO as PTNO                                 /* 환자번호 */
							,  b.GEND_CD as GEND_CD                              /* 성별 */
							,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
							,  b.FRRN  as FRRN     /* 앞주민번호 */
							,  a.ORDP_CD as ORDP_CD
							,  decode(a.SBDP_CD, null
											   , ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.ORDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   ,
											   ( select
														F_A.ABRV_DPRT_CD
												   from
														HZDEPTMMT F_A
												  where
														F_A.DPRT_CD = a.SBDP_CD
												  group by
														F_A.ABRV_DPRT_CD )
											   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						   ,  (
							   case when e.CODV_CD = 'D' then nvl((
															 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																								  from HZDEPTMMT F_A
																								 where F_A.DPRT_CD = e.CARE_WARD_CD
																								 group by
																									   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
							,  (
							   case when e.CODV_CD = 'D' then nvl((
																 select  CARE_PTRM_NO
																   from  APRCRPTNT bb
																  where  bb.PTNO = e.PTNO
																	and  bb.CODV_CD = 'I'
																	and  bb.MDCR_DT = e.DSCH_DT
																	and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
							,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
							,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
							,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
							,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
							,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
							,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
							,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
							,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
			                      where  f.MDCR_CTRL_CD      = 'MM130'
						          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
			                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
							,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
							,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
							,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
							,   (select cd.cd_nm from mnsopcdmt cd
											where cd.oprt_grp_cd = 'MSS_002'
											and cd.cd = a.OPRT_STTS_CD
			                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
							,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(NVL( (select decode(xx.CRTF_YN, 'Y','C','Y')
																							     from MEDOCMBST xx
																						        where xx.PTNO           = a.PTNO
																						          and  xx.RCRD_DT       >= a.OPRT_YMD
																						          and  xx.RCRD_DT       <  a.OPRT_YMD + 1
																							      and  xx.BHVR_SNO       = a.OPRT_SNO
																							      and xx.RCRD_LAST_YN = 'Y'
																								  and nvl( xx.dltn_yn,'N') ='N'
																							      and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
			                                                                                      and rownum = 1
			                                                                                  ), decode( i.ptno, null, 'N', 'Y' )  
			                                                                                 )
			                                                                              )
			                                                         )
			                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
			               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
			                                                                                  from   MNZCERTMT yy  /* 인증 */
				                                                                             where
			                                                                         		  yy.PTNO           = a.PTNO
			                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
			                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
			                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
			                                                                                  and rownum = 1), decode(y.PTNO, null ,'N','Y') ) )
			                                                               )
			                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
							,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM081'
									and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
							,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
							,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
							,  CSCR_CD as CSCR_CD             /* CaseCart코드 */
							,  DECODE( a.OPRT_STTS_CD, '7', nvl((select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
									 and nvl( xc.dltn_yn,'N') ='N'
			                         and xa.ptnt_rcrd_dx_sno =  1
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)), a.CSCR_NM) , a.CSCR_NM) as CSCR_NM             /* CaseCart명  */
							,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
							,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
							, (case when a.OPRT_STTS_CD in ('2','9') then ''
									when a.OPRT_STTS_CD = '4' then '대기실'
									when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
									else 	( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN488'
													 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
							,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
							,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
							,  a.ER_YN as ER_YN /* 응급여부 */
							,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
							, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
									else
									  (case when e.MDRP_NO is not null then '주:'||(select a1.CLNO
																						 from CCUSERAMT a1
																						where a1.LGIN_ID = e.GNDR_ID)
											when e.MDRP_NO is null then '집:'||(select a1.CLNO
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = a.OPSR_ID1) end)
									end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
							,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
							,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								   from CCCMCDDMT F_A
									  , CCCMCDDLT F_B
								  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
									and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
									and F_A.COMN_GRP_CD = 'MM441'
									and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
									and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
							,  a.CP_CD as CP_CD    /* CP코드  */
							,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
							,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
							,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
							, nvl( ( select ( case when aa.CNFM_ID is not null then 'C' 
		                                 when aa.RCRD_ID is not null then 'Y'
		                                   else 'Y' end ) || ( case when aa.CNFM_ID_2 is not null then 'C' 
		                                   when aa.RCRD_ID_2 is not null then 'Y'
		                                 else 'N' end ) from mdopparmt aa
		                               where
				                         aa.PTNO           = a.PTNO
			                             and  aa.OPRT_YMD        = a.OPRT_YMD
			                             and  aa.OPRT_SNO       = a.OPRT_SNO
		                                 and rownum =1),'NN')  as ANST_RCRD_ITEM_DVSN_CD  /* 마취전방문기록 */
				   /*         ,  decode(a.OPRT_STTS_CD,'9','Y',decode(ENTPV_YN,'Y','Y',decode(a.ANKI_CD,'02','Y',( */
				   /*                                                                                                      select */
				   /*                                                                                                              decode(count(*),0,'N','Y') */
				   /*                                                                                                        from  MEDOCMBST aa */
				   /*                                                                                                       where */
				   /*                                                                                                              aa.PTNO           = a.PTNO */
				   /*                                                                                                         and  aa.RCRD_DT       >= a.OPRT_YMD */
				   /*                                                                                                         and  aa.RCRD_DT       <  a.OPRT_YMD + 1 */
				   /*                                                                                                         and  aa.BHVR_SNO       = a.OPRT_SNO */
				   /*                                                                                                         and  aa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_ANST_BEF_RCRD') --마취전 환자방문기록 */
				   /*                                                                                                         and  aa.RCRD_SAVE_DVSN_CD = '1'))))|| */
				   /*                                                                                                         decode(a.OPRT_STTS_CD,'9','Y',decode(ENTPV_YN,'Y','Y',decode(a.ANKI_CD,'02','Y',( */
				   /*                                                                                                      select */
				   /*                                                                                                              decode(count(*),0,'N','Y') */
				   /*                                                                                                        from  MEDOCMBST aa */
				   /*                                                                                                       where */
				   /*                                                                                                              aa.PTNO           = a.PTNO */
				   /*                                                                                                         and  aa.RCRD_DT       >= a.OPRT_YMD */
				   /*                                                                                                         and  aa.RCRD_DT       <  a.OPRT_YMD + 1 */
				   /*                                                                                                         and  aa.BHVR_SNO       = a.OPRT_SNO */
				   /*                                                                                                         and  aa.RCKI_CD = '082' --마취유도전평가기록 */
				   /*                                                                                                         and  aa.RCRD_SAVE_DVSN_CD = '1')))) as ANST_RCRD_ITEM_DVSN_CD  마취기록구분항목코드 */
							,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
							,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
							,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
							,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
							,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
														from CCCMCDDMT F_A
														   , CCCMCDDLT F_B
													   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
														 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
														 and F_A.COMN_GRP_CD = 'MN909'
														 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
														 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
							,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
			                ,  RCVY_ROM_CHOT_PLAC_CD  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
							, ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN488'
													 and F_A.COMN_DTLS_CD =  a.RCVY_ROM_CHOT_PLAC_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
							,  to_char(RCVY_ROM_CHOT_DT,'yyyymmddhh24mi')   as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
							,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
							,  decode(a.ANSH_ID2,null,null,
									( select nvl(( select F_A.SMCR_YN
													 from APDSDRDPT F_A
													where F_A.MDDR_ID = a.ANSH_ID2
													  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
							,  ''  as SMCR_YN /* 선택진료여부 */
							,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
							,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
							,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
							,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
			                , FN_QD_CAUTION_ABBREVIATION(a.PTNO) as AFI_INFC_STTS_NM_3
							, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
							, (case when i.ANST_FNSH_DT is not null then 'Y' end)  as AFI_ANST_RCRD_FNSH_YN      /* 마취기록종료여부 */
							,  decode(a.PTNO,y.PTNO,'Y',(case when exists (select 'X'
																			 from MNANBENTT xx
																			where xx.PTNO     = a.PTNO
																			  and xx.OPRT_YMD = a.OPRT_YMD
																			  and xx.OPRT_SNO = a.OPRT_SNO) then 'Y' else 'N' end))  as AFI_PACU_RCRD_WRTG_YN            /* 회복실기록지 작성여부 */
							,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
							,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT              /* 마취시작일시 */
							,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT              /* 마취유도종료시간 */
							,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
							,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
							,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
							,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
							,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
							,  (select  aa.PTNT_TLNO
								  from  APPTCNPNV aa
								 where  aa.PTNO = a.PTNO
								   and  aa.CNPN_DVSN_CD = '2'
								   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
																from APPTCNPNV bb
															   where bb.PTNO = a.PTNO
																 and bb.CNPN_DVSN_CD = '2'
																 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
							,  (select TS_YN
								  from MDCAOPCDT aa
								 where aa.MCDP_CD = a.ORDP_CD
								   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* TS */
							,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
							,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
							,  (case when exists (select
														'X'
												  from
														MDOPSCHHT
												 where  PTNO     = a.PTNO
												   and  OPRT_YMD = a.OPRT_YMD
												   and  OPRT_SNO = a.OPRT_SNO
												   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
							, (case when exists(select
									'X'
							  from
									MDOPSCHHT
							 where  PTNO     = a.PTNO
							   and  OPRT_YMD = a.OPRT_YMD
							   and  OPRT_SNO = a.OPRT_SNO
							   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
							,  ''  as AOR_PRRM_ENRM_DT                         /* 준비실 입실일시 */
							,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
							, (
							  select  nvl(max('Y'), 'N')
								from  MDTRTORDT x         /* 처방료처방TABLE  */
							   where
									  x.PTNO     = a.PTNO
								 and  x.OPRT_YMD = a.OPRT_YMD
								 and  x.OPRT_SNO = a.OPRT_SNO
								 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
								 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
				   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
							)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
							,
							(
							  select  decode(count(*), 0, null
												   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||'/'|| count(*))
								from  MDMEDORDT z        /* 약처방TABLE */
							   where
									  z.PTNO = a.PTNO
								 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
								 and  z.OPRT_YMD = a.OPRT_YMD
								 and  z.OPRT_SNO = a.OPRT_SNO
								 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
								 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							--	 and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
							)  as AFI_DRRT_CCT_CTN
							, to_char(i.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT_1 /* 마취시작일시 */
							, to_char(i.ANST_FNSH_DT,'AM hh12:mi')  as ANST_FNSH_DT_1 /* 마취종료일시 */
							, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
									when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
							, (select decode(count(a.PTNO),0,'','Y')
								 from MDOPSCCOT aa
								where aa.PTNO     = a.PTNO
								  and aa.OPRT_YMD = a.OPRT_YMD
								  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
							, (select LISTAGG('['|| (select
														 F_A.ABRV_DPRT_CD
													from
														 HZDEPTMMT F_A
												   where
														 F_A.DPRT_CD = aa.CPDP_CD
												   group by
														 F_A.ABRV_DPRT_CD) ||'] '||
												   bb.USER_NM||'('||
												   aa.CMTX_OPSR_ID1||') '||
												   aa.CMTX_OPRT_CSCR_NM, chr(13))
									  WITHIN group (order by CPDP_CD)
								 from MDOPSCCOT aa
									, CCUSRDPHT bb
							   where aa.PTNO     = a.PTNO
								 and aa.OPRT_YMD = a.OPRT_YMD
								 and aa.OPRT_SNO = a.OPRT_SNO
								 and bb.USER_ID  = aa.CMTX_OPSR_ID1
							   group by
									 aa.PTNO
								   , aa.OPRT_YMD
								   , aa.OPRT_SNO)  as CMTX_OPRT_NM           /* 협진수술명 */
							, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
					                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
					                 and rownum=1) ,null,'N','Y')||
							  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
							                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
							                 and rownum=1) ,null,'N','Y')||
							  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
							                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
							                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
							, e.MDRP_NO  as MDRP_NO   /* 진료접수번호 */
			                , NVL((select 'Y' from MDTRTORDT o
								where o.oprt_ymd = a.oprt_ymd
			                    and o.ptno = a.ptno
			                    and o.oprt_sno = a.oprt_sno
								and o.orcl_cd like 'AN%'
			                    and rownum =1 ), 'N') as ORDR_YN
			                , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'OP')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum =1
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
								 )) as afi_agdc_rtrn_dvsn_nm_1 --수술동의서 유무
			                , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'AN')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum =1 
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
								)) as afi_agdc_rtrn_dvsn_nm_2  --마취동의서 유무
			                , (select wrtg_stts_nm from mrocrprnv b
			                      where form_no in ( select ADTN_RFRN_CD from mnsopcdmt
			                                                where oprt_grp_cd ='AGDC'
			                                                 and RFRN_CD = 'PCA')
			                       and a.ptno = b.ptno
			                       and (a.mdrp_no = b.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                       and rownum =1 
			                        and b.rcrd_no = ( select max(rcrd_no) from mrocrprnv x
			                  where b.ptno = x.ptno
			                  and (b.mdrp_no = x.mdrp_no or ( b.rcrd_dt >= a.oprt_ymd -3 and b.rcrd_dt <= a.oprt_ymd +1 ) )
			                  and b.form_no = x.form_no
								)) as afi_agdc_rtrn_dvsn_nm_3  --PCA동의서 유무
			               ,  to_char(a.CLOT_DT,'AM hh12:mi')  as CLOT_DT
							, a.COLT_DVSN_CD as CLOT_DVSN_CD
			                , a.SBDP_CD as SBDP_CD
			                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
			                , a.ONCA_YN as ONCA_YN
			                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
			                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
			                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
			                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
			                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
			                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
									 and nvl( xc.dltn_yn,'N') ='N'
			                         and xa.ptnt_rcrd_dx_sno =  2
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_1)  as SUB_OPRT_CD_NM_1
			                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
			                , DECODE( a.OPRT_STTS_CD, '7', (select /*+ INDEX (XC MEDOCMBST_I01 ) */  xa.CLNC_DX_NM
			                            from MEDOCSCMT xa  /* 환자별기록진단내용 */
			                                 , MEDOCSCDT xb  /* 환자별기록진단상병수술 */
			                                 , MEDOCMBST xc  /* 진료기록 */
			                      where xa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')
			                         and xa.FORM_DVSN_CD = 'O'
			                         and xa.MDRP_NO = xb.MDRP_NO
			                         and xa.RCKI_CD = xb.RCKI_CD
			                         and xa.FORM_DVSN_CD = xb.FORM_DVSN_CD
			                         and xa.PTNT_RCRD_DX_SNO = xb.PTNT_RCRD_DX_SNO
			                         and xa.PTNO = xb.PTNO
			                         and xa.MDDR_ID = xb.MDDR_ID
			                         and xc.RCRD_NO = xa.RCRD_NO
			                         and xc.RCRD_SAVE_DVSN_CD = '1'
									 and nvl( xc.dltn_yn,'N') ='N'
			                         and xa.ptnt_rcrd_dx_sno =  3
			                         and rownum = 1
			                         and a.ORDP_CD = xa.MCDP_CD
			                         and a.PTNO     = xc.PTNO
			                         and a.OPRT_YMD = trunc(xc.RCRD_DT)
			                         and a.OPRT_SNO = to_number(xc.BHVR_SNO)) , a.SUB_OPRT_CD_NM_2)  as SUB_OPRT_CD_NM_2
			                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
			                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
			                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
			                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
			                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
			                , 0 as CMTX_SEQ_NO
			                , a.CSCR_CD_1 as CSCR_CD_1
			                , a.CSCR_NM_1 as CSCR_NM_1
			                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
			                , (case when e.ISTY_CD not in ('30','31','32','33','50','51','52','53') /* 산재,자보  제외 */
			                         and FN_AP_AGE_S(a.PTNO, sysdate) >= 18      /* 18세 이상 */
			                         and exists (select 1
			                                       from AICTRLMMT
			                                      where INSR_CTRL_CD like 'AI913'  /* 수술의 예방적 항생제 수술 스케쥴 코드 */
			                                        and trunc(sysdate) between APST_YMD and APFN_YMD
			                                        and INSR_DTLS_CTRL_CD = a.CSCR_CD)    /* 수술항생제평가대상 수술인지 판단 */
			                         and exists (select 1
			                                       from MZCTRLMMT
			                                      where MDCR_CTRL_CD = 'MNW_501'
			                                        and MDCR_DTLS_CTRL_CD = 'TERM'
			                                        and to_char(e.MDCR_YMD,'yyyymmdd') between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
			                                      union all
			                                     select 1
			                                       from MZCTRLMMT
			                                      where MDCR_CTRL_CD = 'MNW_501'
			                                        and MDCR_DTLS_CTRL_CD = 'TERM'
			                                        and case when to_char(e.DSCH_DT,'yyyymmdd') = '29991231' then to_char(sysdate,'yyyymmdd') else to_char(e.DSCH_DT) end between MDCR_CTRL_CHRC_VL1 and MDCR_CTRL_CHRC_VL2
			                                    ) /* 입원일자가 평가기간에 포함되거나 퇴원일자가 평가기간에 포함되는 경우 */
			                       then 'Y'
			                   end) as PVAN_TRGT_YN  /* 수술예방적항생제대상여부 */
			                  , a.ANTP_RQRD_MI
		 				    , nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				            from (
		 				          		 select 'Y' as OPRT_RCRD_YN
		 				      	    	      , CRTF_YN
		 				      		       from MEDOCMBST
		 				      		      where 1=1
		 				      		        and PTNO = a.PTNO
		 				      		        and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		        and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		        and BHVR_SNO = a.OPRT_SNO
		 				      		        and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		        and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		        and DLTN_YN = 'N'
		 				      		        and rownum = 1
		 				      		    ) f
		 				      ), 'N') as OPRT_RCRD_YN
		                    , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                    , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                    , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
						 from
							   MDOPSCHET a /* 수술스케줄 */
							,  APPTPTNTV b /* 환자 */
							,  APRCRPTNT e /* 진료접수 */
							,  MNSOPNRMT g /* 수술간호기록 */
							,  CCUSERAMT z /* OCS로그인정보 */
							,  CCUSRDPHT h /* OCS사용자정보 */
							,  MNSAONRMT x /* AOR 간호기록 */
							,  MNSREREMT y /* 회복실기록 */
							,  MEANDOCMT i /* 마취기록지 */
						where
							   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
			              and a.CODV_CD = decode(#{opplCd},'D','D', a.CODV_CD)
			              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd} 
		                      or (#{ordpCd} = FN_CC_GET_DPRT_CD('DPRT_GS') 
		                           and ( a.ORDP_CD in (select dprt_cd from hzdeptmmt
		                                               where HRAF_HGRN_DPRT_CD=#{ordpCd})) 
		                      )
		                   ) /* 집도과 */
			              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
						  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
						  and  ((#{anshId} is null)
							   or
								 (
								 a.ANSH_ID1 = #{anshId} or
								 a.ANSH_ID2 = #{anshId} or
								 a.ANSH_ID3 = #{anshId}
								 )
							   ) /* 마취의 */
						  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
						  and  (
								  (
									 (
										 nvl(#{codvCd1},'N') != 'Y' and
										 nvl(#{codvCd2},'N') != 'Y' and
										 nvl(#{codvCd3},'N') != 'Y' and
										 nvl(#{codvCd4},'N') != 'Y'
									 )
									 and
									 (1=1)
								  )
								  or
								 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
								 or
								 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
								 or
								 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
								 or
								 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
							   )
						  and  a.DFNT_YN = 'Y'
						  and  (
								 (
								   (
								   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
								   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
								   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
								   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
								   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
								   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
								   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
								 )
								 or
								 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2', '3') ) /*미착 -> 확정(2) */
								 or
								 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
								 or
								 (
								 #{oprtSttsCd3} = 'Y' and /*진행 */
								   (
									 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
									 or
									 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
									 or
									 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
									 or
									 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
									 or
									 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
								   )
								 )
								 or
								 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
								 or
								 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
								 or
								 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
							   )
			              and (
				                     (#{ankiCd1} is null and #{ankiCd2} is null and #{ankiCd3} is null)
				              or
				                     (#{ankiCd1} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='G'))
				              or
				                     (#{ankiCd2} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='R'))
				              or
				                     (#{ankiCd3} = 'Y' and a.ANKI_CD in (select p.CD from mnsopcdmt p
		                                                                                 where p.OPRT_GRP_CD='MEA_004'
		                                                                                   and p.MNGM_DVSN_CD='L'))
				              )
			              and NVL( a.DPRM_INRL_OPRT_YN, 'N' ) = NVL(#{dprmInrlOprtYn},'N')
						  and  b.PTNO(+)= a.PTNO					  
						  and  (a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD) or a.OPPL_CD is null )
						  and  e.PTNO(+)     = a.PTNO
						  and  e.CODV_CD(+)  = a.CODV_CD
			              and a.CODV_CD ='O'
						and (   e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd') 
			                        and a.ordp_cd = e.mcdp_cd (+) and nvl(a.mdrp_no,0) = e.mdrp_no(+) )
						  and  e.CNCL_DT(+) is null
						  and  g.PTNO(+) = a.PTNO
						  and  g.OPRT_YMD(+)= a.OPRT_YMD
						  and  g.OPRT_SNO(+)= a.OPRT_SNO
						  and  h.USER_ID (+)= a.OPSR_ID1
						  and  z.LGIN_ID (+)= h.LGIN_ID
						  and  x.PTNO(+) = a.PTNO
						  and  x.OPRT_YMD(+)= a.OPRT_YMD
						  and  x.OPRT_SNO(+)= a.OPRT_SNO
						  and  y.PTNO(+) = a.PTNO
						  and  y.OPRT_YMD(+)= a.OPRT_YMD
						  and  y.OPRT_SNO(+)= a.OPRT_SNO
						  and  i.PTNO(+) = a.PTNO
						  and  i.OPRT_YMD(+)= a.OPRT_YMD
						  and  i.OPRT_SNO(+)= a.OPRT_SNO
			)
			select t.oprm_cd || '-'|| lpad(rank() over(partition by t.oprm_cd  order by t.opst_prrn_dt),2,'0') as AFI_APNT_PROR_NM
			       ,t.*
			from t
						order  by
							   OPRM_CD
							,  OPST_PRRN_DT
			                ,  PTNO
			                ,  CMTX_SEQ_NO
							,  ORDP_CD
							,  OPSR_ID_1
							,  OPRT_STTS_CD
						]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X5-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="frrn" column="FRRN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="crtfYn2" column="CRTF_YN_2"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="oprmChotPadvCd" column="OPRM_CHOT_PADV_CD"/>
		<result property="afiChotPadvNm" column="AFI_CHOT_PADV_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="afiCscrOrdrSttsNm" column="AFI_CSCR_ORDR_STTS_NM"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="chkrNm" column="CHKR_NM"/>
		<result property="chkrTlno" column="CHKR_TLNO"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="tlviYn1" column="TLVI_YN_1"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="strmMvmnYn" column="STRM_MVMN_YN"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="otptRcrdWrtgInlsYn" column="OTPT_RCRD_WRTG_INLS_YN"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X5 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X5-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X5"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X5-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X5 */
		<![CDATA[
				   select  /*+ AOR-준비실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
					   ,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														 from  APRCRPTNT bb
														where  bb.PTNO = e.PTNO
														  and  bb.CODV_CD = 'I'
														  and  bb.MDCR_DT between to_date(#{oprtYmd},'yyyymmdd') and
																				  to_date(#{oprtYmd},'yyyymmdd') + .99999
														  and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO    = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1    /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(xx.CRTF_YN, 'Y','C','N')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                 and rownum = 1
																						  )
		                                                               )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(a.PTNO,y.PTNO,'S','N') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                                 /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM  /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
						,  CSCR_NM as CSCR_NM             /* CaseCart명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else 	( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN||(
										select
												LISTAGG(bb.TMOT_DVSN_DETL_NM,chr(13)) WITHIN group (order by aa.OPRT_PRPN_ITEM_CD)
										  from
											   MDOPPRIMT aa /* 수술스케줄준비항목 */
											 , MDEITMOCT bb /* 임플란트및장비관리 */
										 where
											   aa.PTNO                   = a.PTNO
										   and aa.OPRT_YMD               = a.OPRT_YMD
										   and aa.OPRT_SNO               = a.OPRT_SNO
										   and aa.OPRT_PRPN_ITEM_DVSN_CD = '01'
										   and bb.MCDP_CD                = a.ORDP_CD
										   and bb.TMOT_DVSN_DETL_CD      = aa.OPRT_PRPN_ITEM_CD
										 group by a.PTNO
											 , a.OPRT_YMD
											 , a.OPRT_SNO)  as IMPN_CMNT_CTN           /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  k.USER_ID  as CHKR_NM        /* 원무-심사자명 */
						,  h.EXTS_TLNO  as CHKR_TLNO    /* 원무-심사자내선번 */
						,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  (case when exists (select  'X'
												from
													  MNSOPTEHT xx
												   ,  MNSOPTELT xy
											   where
													  xx.PTNO              = a.PTNO
												 and  xx.OPRT_YMD          = a.OPRT_YMD
												 and  xx.OPRT_SNO          = a.OPRT_SNO
												 and  xx.PTNO              = xy.PTNO
												 and  xx.OPRT_YMD          = xy.OPRT_YMD
												 and  xx.OPRT_SNO          = xy.OPRT_SNO
												 and  xx.OPBE_AFTR_DVSN_CD = 'B'
												 and  xy.OPBE_WRTR_ID is not null
												 and  (nvl(xx.TLRC_DVSN_CD,'X') <> '9' and nvl(xx.TLRC_DVSN_CD,'X') <> 'X')
												 ) then 'Y' else 'N' end)  as TLVI_YN_1 /* 수술이전방문여부 */
			   /*         ,  nvl((select  (case when (xy.OPBE_WRTR_ID is not null) and xx.TLRC_DVSN_CD <> '9' then 'Y' */
			   /*                           else 'N' */
			   /*                         end) */
			   /*               from */
			   /*                     SMCMGR.MNSOPTEHT xx */
			   /*                  ,  SMCMGR.MNSOPTELT xy */
			   /*              where */
			   /*                     xx.PTNO     = a.PTNO */
			   /*                and  xx.OPRT_YMD = a.OPRT_YMD */
			   /*                and  xx.OPRT_SNO = a.OPRT_SNO */
			   /*                and  xx.PTNO     = xy.PTNO (+) */
			   /*                and  xx.OPRT_YMD = xy.OPRT_YMD (+) */
			   /*                and  xx.OPRT_SNO = xy.OPRT_SNO (+) */
			   /*                and  xx.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                and  xx.TLVI_FNSH_DT = (select max(TLVI_FNSH_DT) */
			   /*                                          from SMCMGR.MNSOPTEHT yy */
			   /*                                         where yy.PTNO     = xx.PTNO */
			   /*                                           and yy.OPRT_YMD = xx.OPRT_YMD */
			   /*                                           and yy.OPRT_SNO = xx.OPRT_SNO */
			   /*                                           and yy.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                                           and rownum = 1)), 'N') as TLVI_YN_1  수술이전방문여부 */
						,  '' as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						,
						(case when exists(select
											 'X'
									   from
											 MDOPSCHHT
									  where  PTNO     = a.PTNO
										and  OPRT_YMD = a.OPRT_YMD
										and  OPRT_SNO = a.OPRT_SNO
										and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT           /* 준비실 입실일시 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							-- and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN
						, a.STRM_MVMN_YN as STRM_MVMN_YN                           /* 안정실이동여부 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
						, (select LISTAGG('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = aa.CPDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM /* 협진수술명 */
						, (select decode(MCDP_TLVI_CTN,null,'N','Y')
							 from MNSOPTELT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as OTPT_RCRD_WRTG_INLS_YN /* 수술전-진료과 전화방문 입력여부 */
						, e.MDRP_NO  as MDRP_NO                /* 진료접수번호 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT j /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  CCUSERAMT h /* OCS로그인정보(원무-심사자정보용) */
						,  CCUSRDPHT k /* OCS사용자(원무-심사자정보용) */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  ( (a.OPPL_CD like nvl(#{opplCd},'D')||'%%' or a.OPPL_CD is null)  or  a.CODV_CD = 'D' )
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A', 'B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ( '2', '3') ) /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (
								   (
								   nvl(#{oprtSttsCd7},'N')  != 'Y' and
								   nvl(#{oprtSttsCd8},'N')  != 'Y' and
								   nvl(#{oprtSttsCd9},'N')  != 'Y' and
								   nvl(#{oprtSttsCd10},'N') != 'Y' and
								   nvl(#{oprtSttsCd11},'N') != 'Y'
								   ) and a.OPRT_STTS_CD in ('5', 'A', 'B', 'C', 'D')
								 )
								 or
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is not null and a.OPRM_CHOT_DT is null)) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRM_CHOT_DT is not null) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
					and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  ))
					  and  e.CNCL_DT(+) is null
					  and  k.USER_ID(+) = e.MAIN_CHKR_ID
					  and  h.LGIN_ID(+) = k.LGIN_ID
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  j.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= j.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
		union all
		select  /*+ AOR-준비실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
					   ,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														 from  APRCRPTNT bb
														where  bb.PTNO = e.PTNO
														  and  bb.CODV_CD = 'I'
														  and  bb.MDCR_DT between to_date(#{oprtYmd},'yyyymmdd') and
																				  to_date(#{oprtYmd},'yyyymmdd') + .99999
														  and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO    = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1    /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(xx.CRTF_YN, 'Y','C','N')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                 and rownum = 1
																						  )
		                                                               )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(a.PTNO,y.PTNO,'S','N') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                                 /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM  /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
						,  CSCR_NM as CSCR_NM             /* CaseCart명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else 	( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN||(
										select
												LISTAGG(bb.TMOT_DVSN_DETL_NM,chr(13)) WITHIN group (order by aa.OPRT_PRPN_ITEM_CD)
										  from
											   MDOPPRIMT aa /* 수술스케줄준비항목 */
											 , MDEITMOCT bb /* 임플란트및장비관리 */
										 where
											   aa.PTNO                   = a.PTNO
										   and aa.OPRT_YMD               = a.OPRT_YMD
										   and aa.OPRT_SNO               = a.OPRT_SNO
										   and aa.OPRT_PRPN_ITEM_DVSN_CD = '01'
										   and bb.MCDP_CD                = a.ORDP_CD
										   and bb.TMOT_DVSN_DETL_CD      = aa.OPRT_PRPN_ITEM_CD
										 group by a.PTNO
											 , a.OPRT_YMD
											 , a.OPRT_SNO)  as IMPN_CMNT_CTN           /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  k.USER_ID  as CHKR_NM        /* 원무-심사자명 */
						,  h.EXTS_TLNO  as CHKR_TLNO    /* 원무-심사자내선번 */
						,  ''  as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						,  (case when exists (select  'X'
												from
													  MNSOPTEHT xx
												   ,  MNSOPTELT xy
											   where
													  xx.PTNO              = a.PTNO
												 and  xx.OPRT_YMD          = a.OPRT_YMD
												 and  xx.OPRT_SNO          = a.OPRT_SNO
												 and  xx.PTNO              = xy.PTNO
												 and  xx.OPRT_YMD          = xy.OPRT_YMD
												 and  xx.OPRT_SNO          = xy.OPRT_SNO
												 and  xx.OPBE_AFTR_DVSN_CD = 'B'
												 and  xy.OPBE_WRTR_ID is not null
												 and  (nvl(xx.TLRC_DVSN_CD,'X') <> '9' and nvl(xx.TLRC_DVSN_CD,'X') <> 'X')
												 ) then 'Y' else 'N' end)  as TLVI_YN_1 /* 수술이전방문여부 */
			   /*         ,  nvl((select  (case when (xy.OPBE_WRTR_ID is not null) and xx.TLRC_DVSN_CD <> '9' then 'Y' */
			   /*                           else 'N' */
			   /*                         end) */
			   /*               from */
			   /*                     SMCMGR.MNSOPTEHT xx */
			   /*                  ,  SMCMGR.MNSOPTELT xy */
			   /*              where */
			   /*                     xx.PTNO     = a.PTNO */
			   /*                and  xx.OPRT_YMD = a.OPRT_YMD */
			   /*                and  xx.OPRT_SNO = a.OPRT_SNO */
			   /*                and  xx.PTNO     = xy.PTNO (+) */
			   /*                and  xx.OPRT_YMD = xy.OPRT_YMD (+) */
			   /*                and  xx.OPRT_SNO = xy.OPRT_SNO (+) */
			   /*                and  xx.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                and  xx.TLVI_FNSH_DT = (select max(TLVI_FNSH_DT) */
			   /*                                          from SMCMGR.MNSOPTEHT yy */
			   /*                                         where yy.PTNO     = xx.PTNO */
			   /*                                           and yy.OPRT_YMD = xx.OPRT_YMD */
			   /*                                           and yy.OPRT_SNO = xx.OPRT_SNO */
			   /*                                           and yy.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                                           and rownum = 1)), 'N') as TLVI_YN_1  수술이전방문여부 */
						,  ''  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  '' as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						,
						(case when exists(select
											 'X'
									   from
											 MDOPSCHHT
									  where  PTNO     = a.PTNO
										and  OPRT_YMD = a.OPRT_YMD
										and  OPRT_SNO = a.OPRT_SNO
										and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT           /* 준비실 입실일시 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							-- and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN
						, a.STRM_MVMN_YN as STRM_MVMN_YN                           /* 안정실이동여부 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
						, (select LISTAGG('['||( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = aa.CPDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM /* 협진수술명 */
						, (select decode(MCDP_TLVI_CTN,null,'N','Y')
							 from MNSOPTELT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as OTPT_RCRD_WRTG_INLS_YN /* 수술전-진료과 전화방문 입력여부 */
						, e.MDRP_NO  as MDRP_NO                /* 진료접수번호 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT j /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  CCUSERAMT h /* OCS로그인정보(원무-심사자정보용) */
						,  CCUSRDPHT k /* OCS사용자(원무-심사자정보용) */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  ( (a.OPPL_CD like nvl(#{opplCd},'D')||'%%' or a.OPPL_CD is null)  or  a.CODV_CD = 'D' )
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A', 'B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2', '3') ) /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (
								   (
								   nvl(#{oprtSttsCd7},'N')  != 'Y' and
								   nvl(#{oprtSttsCd8},'N')  != 'Y' and
								   nvl(#{oprtSttsCd9},'N')  != 'Y' and
								   nvl(#{oprtSttsCd10},'N') != 'Y' and
								   nvl(#{oprtSttsCd11},'N') != 'Y'
								   ) and a.OPRT_STTS_CD in ('5', 'A', 'B', 'C', 'D')
								 )
								 or
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is not null and a.OPRM_CHOT_DT is null)) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRM_CHOT_DT is not null) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD ='O'
					and (   e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')   and a.ordp_cd = e.mcdp_cd (+) )
					  and  e.CNCL_DT(+) is null
					  and  k.USER_ID(+) = e.MAIN_CHKR_ID
					  and  h.LGIN_ID(+) = k.LGIN_ID
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  j.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= j.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					order  by
						   OPRM_CD
						,  OPST_PRRN_DT
						,  ORDP_CD
						,  OPSR_ID_1
						,  OPRT_STTS_CD
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X6-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="crtfYn2" column="CRTF_YN_2"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="oprmChotPadvCd" column="OPRM_CHOT_PADV_CD"/>
		<result property="afiChotPadvNm" column="AFI_CHOT_PADV_NM"/>
		<result property="blodCtn" column="BLOD_CTN"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="afiCscrOrdrSttsNm" column="AFI_CSCR_ORDR_STTS_NM"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="chckDvsnCd" column="CHCK_DVSN_CD"/>
		<result property="pcaYn" column="PCA_YN"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="anstRcrdItemDvsnCd" column="ANST_RCRD_ITEM_DVSN_CD"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="chkrNm" column="CHKR_NM"/>
		<result property="chkrTlno" column="CHKR_TLNO"/>
		<result property="chkrNm1" column="CHKR_NM_1"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="pwsnDvsnCd" column="PWSN_DVSN_CD"/>
		<result property="tlviYn1" column="TLVI_YN_1"/>
		<result property="tlviYn2" column="TLVI_YN_2"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="afiAsnuNm1" column="AFI_ASNU_NM_1"/>
		<result property="afiAsnuNm2" column="AFI_ASNU_NM_2"/>
		<result property="afiAsnuNm3" column="AFI_ASNU_NM_3"/>
		<result property="strmDschDt" column="STRM_DSCH_DT"/>
		<result property="afiAorCarcWrtgYn" column="AFI_AOR_CARC_WRTG_YN"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiOprtWaitHhVl" column="AFI_OPRT_WAIT_HH_VL"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="strmMvmnYn" column="STRM_MVMN_YN"/>
		<result property="frrn" column="FRRN"/>
		<result property="anstStrtDt1" column="ANST_STRT_DT_1"/>
		<result property="anstFnshDt1" column="ANST_FNSH_DT_1"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="oprtSafeCeckVl" column="OPRT_SAFE_CECK_VL"/>
		<result property="eqpmCtn" column="EQPM_CTN"/>
		<result property="otptRcrdWrtgInlsYn" column="OTPT_RCRD_WRTG_INLS_YN"/>
		<result property="painMngmCntrEnrmDt" column="PAIN_MNGM_CNTR_ENRM_DT"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="oprtCareSprtYn" column="OPRT_CARE_SPRT_YN"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X6 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X6-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X6"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X6-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X6 */
		<![CDATA[
				   select  /*+ leading(a e) AOR-수술실 환자조회 */
						   b.PTNT_NM  as PTNT_NM /* 환자명 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명 */
						,  a.PTNO  as PTNO     /* 환자번호 */
						,  b.GEND_CD  as GEND_CD  /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  ''  as AGE_CTN  /* 연령내용(성별/나이) - null */
						,  a.ORDP_CD  as ORDP_CD  /* 집도과코드 */
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
					   ,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select ( select F_A.ABRV_DPRT_CD
																	from HZDEPTMMT F_A
																   where F_A.DPRT_CD = bb.CARE_WARD_CD
																   group by
																		 F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT between to_date(#{oprtYmd},'yyyymmdd') and to_date(#{oprtYmd},'yyyymmdd') + .99999
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																						from HZDEPTMMT F_A
																					   where F_A.DPRT_CD = e.CARE_WARD_CD
																					   group by
																							 F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																														 from HZDEPTMMT F_A
																														where F_A.DPRT_CD = e.CARE_WARD_CD
																														group by
																															  F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1  as OPSR_ID_1                       /* 집도의사ID1 */
						,  a.OPSR_ID2  as OPSR_ID_2                       /* 집도의사ID2 */
						,  a.OPSR_ID3  as OPSR_ID_3                       /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT   /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1 /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD  as OPRT_STTS_CD  /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(xx.CRTF_YN, 'Y','C','N')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                 and rownum = 1
																						 )
		                                                               )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(a.PTNO,y.PTNO,'S','N') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD  as ANKI_CD /* 마취종류코드 */
						,  a.CODV_CD  as CODV_CD /* 내원구분코드 */
						,  a.CSCR_CD  as CSCR_CD             /* CaseCart코드   */
						,  a.CSCR_NM  as CSCR_NM             /* CaseCart명   */
						,  a.CLNC_OPRT_NM  as CLNC_OPRT_NM        /* 임상수술명  */
						,  a.OPRM_CHOT_PADV_CD  as OPRM_CHOT_PADV_CD   /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM          /* 퇴실장소명 */
						,  ''  as BLOD_CTN
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN     /* 수술간호기록 작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM     /* AFI_Case_Cart처방상태명 */
						,  a.ER_YN  as ER_YN                     /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM            /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT              /* 수술실입실일시  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					   from CCUSERAMT a1
																					  where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				   from CCUSERAMT a1
																				  where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN        /* 집도의사연락처내용  */
						, a.IMPN_CMNT_CTN||(
										select
												LISTAGG(bb.TMOT_DVSN_DETL_NM,chr(13)) WITHIN group (order by aa.OPRT_PRPN_ITEM_CD)
										  from
											   MDOPPRIMT aa /* 수술스케줄준비항목 */
											 , MDEITMOCT bb /* 임플란트및장비관리 */
										 where
											   aa.PTNO                   = a.PTNO
										   and aa.OPRT_YMD               = a.OPRT_YMD
										   and aa.OPRT_SNO               = a.OPRT_SNO
										   and aa.OPRT_PRPN_ITEM_DVSN_CD = '01'
										   and bb.MCDP_CD                = a.ORDP_CD
										   and bb.TMOT_DVSN_DETL_CD      = aa.OPRT_PRPN_ITEM_CD
										 group by a.PTNO
											 , a.OPRT_YMD
											 , a.OPRT_SNO)  as IMPN_CMNT_CTN           /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM  /* DRG명 */
						,  a.CP_CD  as CP_CD   /* CP코드  */
						,  e.MCDP_CD  as MCDP_CD /* 입원환자 진료과  */
						,  a.SCIN_NM  as SCIN_NM /* 상병명 */
						,  ''  as CHCK_DVSN_CD /*  심사구분코드 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  ''  as ANST_RCRD_ITEM_DVSN_CD /* 마취기록항목구분코드 */
						,  a.OPRT_SNO  as OPRT_SNO /* 수술순번 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD  as OPRM_CD      /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN  as ETC_CNRE_CTN      /* 기타취소내용 */
						,  k.USER_ID  as CHKR_NM      /* 원무-심사자명 */
						,  h.EXTS_TLNO  as CHKR_TLNO  /* 원무-심사자내선번 */
						,  ''  as CHKR_NM_1
						,  ''  as PACU_CHOT_PADV_CD      /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM  /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT       /* 회복실퇴실일시 */
						,  ''  as PWSN_DVSN_CD           /* 동명이인구분코드 */
						,  (case when exists (select  'X'
												from
													  MNSOPTEHT xx
												   ,  MNSOPTELT xy
											   where
													  xx.PTNO              = a.PTNO
												 and  xx.OPRT_YMD          = a.OPRT_YMD
												 and  xx.OPRT_SNO          = a.OPRT_SNO
												 and  xx.PTNO              = xy.PTNO
												 and  xx.OPRT_YMD          = xy.OPRT_YMD
												 and  xx.OPRT_SNO          = xy.OPRT_SNO
												 and  xx.OPBE_AFTR_DVSN_CD = 'B'
												 and  xy.OPBE_WRTR_ID is not null
												 and  (nvl(xx.TLRC_DVSN_CD,'X') <> '9' and nvl(xx.TLRC_DVSN_CD,'X') <> 'X')
												 ) then 'Y' else 'N' end)  as TLVI_YN_1 /* 수술이전방문여부 */
			   /*         ,  nvl((select    (case when (xy.OPBE_WRTR_ID is not null) and xx.TLRC_DVSN_CD <> '9' then 'Y' */
			   /*                               else 'N' */
			   /*                            end) */
			   /*                     from */
			   /*                          SMCMGR.MNSOPTEHT xx */
			   /*                        , SMCMGR.MNSOPTELT xy */
			   /*                    where */
			   /*                          xx.PTNO     = a.PTNO */
			   /*                      and xx.OPRT_YMD = a.OPRT_YMD */
			   /*                      and xx.OPRT_SNO = a.OPRT_SNO */
			   /*                      and xx.PTNO     = xy.PTNO (+) */
			   /*                      and xx.OPRT_YMD = xy.OPRT_YMD (+) */
			   /*                      and xx.OPRT_SNO = xy.OPRT_SNO (+) */
			   /*                      and xx.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                      and xx.TLVI_FNSH_DT = (select max(TLVI_FNSH_DT) */
			   /*                                            from SMCMGR.MNSOPTEHT yy */
			   /*                                           where yy.PTNO     = xx.PTNO */
			   /*                                             and yy.OPRT_YMD = xx.OPRT_YMD */
			   /*                                             and yy.OPRT_SNO = xx.OPRT_SNO */
			   /*                                             and yy.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                                             and rownum = 1)), 'N') as TLVI_YN_1  수술이전방문여부 */
						 ,  ''  as TLVI_YN_2 /* 수술이후방문여부 */
						,  ''  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1 /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2 /* AFI감염상태명2(감염COUNT) */
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN  /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT      /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN  as DFNT_AFTR_MDFC_YN /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN
						,  ''  as STRM_LCTN_VL  /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						,
						(case when exists(select
											 'X'
									   from
											 MDOPSCHHT
									  where  PTNO     = a.PTNO
										and  OPRT_YMD = a.OPRT_YMD
										and  OPRT_SNO = a.OPRT_SNO
										and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN      /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT      /* 준비실 입실일시 */
						,  ''  as AFI_ASNU_NM_1         /* AFI담당간호사명1 */
						,  ''  as AFI_ASNU_NM_2         /* AFI담당간호사명2 */
						,  ''  as AFI_ASNU_NM_3         /* AFI담당간호사명3 */
						,  ''  as STRM_DSCH_DT          /* 안정실퇴원일시 */
						,  ''  as AFI_AOR_CARC_WRTG_YN  /* AFI_AOR간호기록작성여부 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT               /* 진료일시 */
						,  ''  as AFI_OPRT_WAIT_HH_VL   /* AFI수술대기시간값 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN  /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							-- and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN /* AFI약반납건수내용  */
						, a.STRM_MVMN_YN  as STRM_MVMN_YN     /* 안정실이동여부 */
						, b.FRRN  as FRRN             /* 앞주민번호 */
						, ''  as ANST_STRT_DT_1   /* 마취시작일시 */
						, ''  as ANST_FNSH_DT_1    /* 마취종료일시 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN  /* 협진수술여부 */
						, (select LISTAGG('['||aa.CPDP_CD||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM      /* 협진수술명 */
						, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
				                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
				                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
						, ''  as EQPM_CTN           /* 장비내용 */
						, (select decode(MCDP_TLVI_CTN,null,'N','Y')
							 from MNSOPTELT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO)  as OTPT_RCRD_WRTG_INLS_YN /* 수술전-진료과 전화방문 입력여부 */
						, ''  as PAIN_MNGM_CNTR_ENRM_DT /* 통증관리센터입실일시 */
						, e.MDRP_NO  as MDRP_NO                /* 진료접수번호 */
						, decode(nvl(a.PAIN_MNGM_CNTR_VIA_YN,'N'),'N','','Y') as PAIN_MNGM_CNTR_VIA_YN   /* 통증관리센터경유여부 */
						, decode(nvl(a.OPRT_CARE_SPRT_YN,'N'),'N','','Y') as OPRT_CARE_SPRT_YN       /* 수술간호지원여부 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT j /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  CCUSERAMT h /* OCS로그인(원무-심사자정보용) */
						,  CCUSRDPHT k /* OCS사용자(원무-심사자정보용) */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							 (
								 (
									 nvl(#{codvCd1},'N') != 'Y' and
									 nvl(#{codvCd2},'N') != 'Y' and
									 nvl(#{codvCd3},'N') != 'Y' and
									 nvl(#{codvCd4},'N') != 'Y'
								 )
								 and
								 (1=1)
							 )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A', 'B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2', '3') ) /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is not null and a.OPRM_CHOT_DT is null)) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRM_CHOT_DT is not null) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO					  
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
					and (  e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
					  and  e.CNCL_DT(+) is null
					  and  k.USER_ID(+)  = e.MAIN_CHKR_ID
					  and  h.LGIN_ID(+)  = k.LGIN_ID
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  j.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= j.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
		union all
		select  /*+ leading(a e) AOR-수술실 환자조회 */
						   b.PTNT_NM  as PTNT_NM /* 환자명 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명 */
						,  a.PTNO  as PTNO     /* 환자번호 */
						,  b.GEND_CD  as GEND_CD  /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  ''  as AGE_CTN  /* 연령내용(성별/나이) - null */
						,  a.ORDP_CD  as ORDP_CD  /* 집도과코드 */
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
					   ,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select ( select F_A.ABRV_DPRT_CD
																	from HZDEPTMMT F_A
																   where F_A.DPRT_CD = bb.CARE_WARD_CD
																   group by
																		 F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT between to_date(#{oprtYmd},'yyyymmdd') and to_date(#{oprtYmd},'yyyymmdd') + .99999
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																						from HZDEPTMMT F_A
																					   where F_A.DPRT_CD = e.CARE_WARD_CD
																					   group by
																							 F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																														 from HZDEPTMMT F_A
																														where F_A.DPRT_CD = e.CARE_WARD_CD
																														group by
																															  F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1  as OPSR_ID_1                       /* 집도의사ID1 */
						,  a.OPSR_ID2  as OPSR_ID_2                       /* 집도의사ID2 */
						,  a.OPSR_ID3  as OPSR_ID_3                       /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT   /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1 /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD  as OPRT_STTS_CD  /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(xx.CRTF_YN, 'Y','C','N')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
		                                                                                 and rownum = 1
																						  )
		                                                               )
		                 )  as CRTF_YN           /* 인증여부(마취기록확정여부)  */
		               ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,( NVL( (select 'C'
		                                                                                  from   MNZCERTMT yy  /* 인증 */
			                                                                             where
		                                                                         		  yy.PTNO           = a.PTNO
		                                                                            	  and yy.CARE_CRTF_VL   = FN_CC_GET_CNST_VL('MED_002', 'F_PACU_RCRD')
		                                                                            	  and yy.PRRY_CTN1      = to_char(a.OPRT_YMD,'yyyymmdd')
		                                                                            	  and yy.PRRY_CTN2      = to_char(a.OPRT_SNO)
		                                                                                  and rownum = 1), decode(a.PTNO,y.PTNO,'S','N') ) )
		                                                               )
		                 )  as CRTF_YN_2           /* 인증여부(회복실기록확정여부)  */
						,  a.ANKI_CD  as ANKI_CD /* 마취종류코드 */
						,  a.CODV_CD  as CODV_CD /* 내원구분코드 */
						,  a.CSCR_CD  as CSCR_CD             /* CaseCart코드   */
						,  a.CSCR_NM  as CSCR_NM             /* CaseCart명   */
						,  a.CLNC_OPRT_NM  as CLNC_OPRT_NM        /* 임상수술명  */
						,  a.OPRM_CHOT_PADV_CD  as OPRM_CHOT_PADV_CD   /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM          /* 퇴실장소명 */
						,  ''  as BLOD_CTN
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN     /* 수술간호기록 작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM     /* AFI_Case_Cart처방상태명 */
						,  a.ER_YN  as ER_YN                     /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM            /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT              /* 수술실입실일시  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					   from CCUSERAMT a1
																					  where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				   from CCUSERAMT a1
																				  where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN        /* 집도의사연락처내용  */
						, a.IMPN_CMNT_CTN||(
										select
												LISTAGG(bb.TMOT_DVSN_DETL_NM,chr(13)) WITHIN group (order by aa.OPRT_PRPN_ITEM_CD)
										  from
											   MDOPPRIMT aa /* 수술스케줄준비항목 */
											 , MDEITMOCT bb /* 임플란트및장비관리 */
										 where
											   aa.PTNO                   = a.PTNO
										   and aa.OPRT_YMD               = a.OPRT_YMD
										   and aa.OPRT_SNO               = a.OPRT_SNO
										   and aa.OPRT_PRPN_ITEM_DVSN_CD = '01'
										   and bb.MCDP_CD                = a.ORDP_CD
										   and bb.TMOT_DVSN_DETL_CD      = aa.OPRT_PRPN_ITEM_CD
										 group by a.PTNO
											 , a.OPRT_YMD
											 , a.OPRT_SNO)  as IMPN_CMNT_CTN           /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM  /* DRG명 */
						,  a.CP_CD  as CP_CD   /* CP코드  */
						,  e.MCDP_CD  as MCDP_CD /* 입원환자 진료과  */
						,  a.SCIN_NM  as SCIN_NM /* 상병명 */
						,  ''  as CHCK_DVSN_CD /*  심사구분코드 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  ''  as ANST_RCRD_ITEM_DVSN_CD /* 마취기록항목구분코드 */
						,  a.OPRT_SNO  as OPRT_SNO /* 수술순번 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD  as OPRM_CD      /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN  as ETC_CNRE_CTN      /* 기타취소내용 */
						,  k.USER_ID  as CHKR_NM      /* 원무-심사자명 */
						,  h.EXTS_TLNO  as CHKR_TLNO  /* 원무-심사자내선번 */
						,  ''  as CHKR_NM_1
						,  ''  as PACU_CHOT_PADV_CD      /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM  /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT       /* 회복실퇴실일시 */
						,  ''  as PWSN_DVSN_CD           /* 동명이인구분코드 */
						,  (case when exists (select  'X'
												from
													  MNSOPTEHT xx
												   ,  MNSOPTELT xy
											   where
													  xx.PTNO              = a.PTNO
												 and  xx.OPRT_YMD          = a.OPRT_YMD
												 and  xx.OPRT_SNO          = a.OPRT_SNO
												 and  xx.PTNO              = xy.PTNO
												 and  xx.OPRT_YMD          = xy.OPRT_YMD
												 and  xx.OPRT_SNO          = xy.OPRT_SNO
												 and  xx.OPBE_AFTR_DVSN_CD = 'B'
												 and  xy.OPBE_WRTR_ID is not null
												 and  (nvl(xx.TLRC_DVSN_CD,'X') <> '9' and nvl(xx.TLRC_DVSN_CD,'X') <> 'X')
												 ) then 'Y' else 'N' end)  as TLVI_YN_1 /* 수술이전방문여부 */
			   /*         ,  nvl((select    (case when (xy.OPBE_WRTR_ID is not null) and xx.TLRC_DVSN_CD <> '9' then 'Y' */
			   /*                               else 'N' */
			   /*                            end) */
			   /*                     from */
			   /*                          SMCMGR.MNSOPTEHT xx */
			   /*                        , SMCMGR.MNSOPTELT xy */
			   /*                    where */
			   /*                          xx.PTNO     = a.PTNO */
			   /*                      and xx.OPRT_YMD = a.OPRT_YMD */
			   /*                      and xx.OPRT_SNO = a.OPRT_SNO */
			   /*                      and xx.PTNO     = xy.PTNO (+) */
			   /*                      and xx.OPRT_YMD = xy.OPRT_YMD (+) */
			   /*                      and xx.OPRT_SNO = xy.OPRT_SNO (+) */
			   /*                      and xx.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                      and xx.TLVI_FNSH_DT = (select max(TLVI_FNSH_DT) */
			   /*                                            from SMCMGR.MNSOPTEHT yy */
			   /*                                           where yy.PTNO     = xx.PTNO */
			   /*                                             and yy.OPRT_YMD = xx.OPRT_YMD */
			   /*                                             and yy.OPRT_SNO = xx.OPRT_SNO */
			   /*                                             and yy.OPBE_AFTR_DVSN_CD = 'B' */
			   /*                                             and rownum = 1)), 'N') as TLVI_YN_1  수술이전방문여부 */
						 ,  ''  as TLVI_YN_2 /* 수술이후방문여부 */
						,  ''  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  '' as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1 /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2 /* AFI감염상태명2(감염COUNT) */
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN  /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT      /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN  as DFNT_AFTR_MDFC_YN /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN
						,  ''  as STRM_LCTN_VL  /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						,
						(case when exists(select
											 'X'
									   from
											 MDOPSCHHT
									  where  PTNO     = a.PTNO
										and  OPRT_YMD = a.OPRT_YMD
										and  OPRT_SNO = a.OPRT_SNO
										and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN      /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT      /* 준비실 입실일시 */
						,  ''  as AFI_ASNU_NM_1         /* AFI담당간호사명1 */
						,  ''  as AFI_ASNU_NM_2         /* AFI담당간호사명2 */
						,  ''  as AFI_ASNU_NM_3         /* AFI담당간호사명3 */
						,  ''  as STRM_DSCH_DT          /* 안정실퇴원일시 */
						,  ''  as AFI_AOR_CARC_WRTG_YN  /* AFI_AOR간호기록작성여부 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT               /* 진료일시 */
						,  ''  as AFI_OPRT_WAIT_HH_VL   /* AFI수술대기시간값 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN  /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							-- and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN /* AFI약반납건수내용  */
						, a.STRM_MVMN_YN  as STRM_MVMN_YN     /* 안정실이동여부 */
						, b.FRRN  as FRRN             /* 앞주민번호 */
						, ''  as ANST_STRT_DT_1   /* 마취시작일시 */
						, ''  as ANST_FNSH_DT_1    /* 마취종료일시 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN  /* 협진수술여부 */
						, (select LISTAGG('['||aa.CPDP_CD||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM      /* 협진수술명 */
						, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
				                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
				                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
						, ''  as EQPM_CTN           /* 장비내용 */
						, (select decode(MCDP_TLVI_CTN,null,'N','Y')
							 from MNSOPTELT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO)  as OTPT_RCRD_WRTG_INLS_YN /* 수술전-진료과 전화방문 입력여부 */
						, ''  as PAIN_MNGM_CNTR_ENRM_DT /* 통증관리센터입실일시 */
						, e.MDRP_NO  as MDRP_NO                /* 진료접수번호 */
						, decode(nvl(a.PAIN_MNGM_CNTR_VIA_YN,'N'),'N','','Y') as PAIN_MNGM_CNTR_VIA_YN   /* 통증관리센터경유여부 */
						, decode(nvl(a.OPRT_CARE_SPRT_YN,'N'),'N','','Y') as OPRT_CARE_SPRT_YN       /* 수술간호지원여부 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT j /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  CCUSERAMT h /* OCS로그인(원무-심사자정보용) */
						,  CCUSRDPHT k /* OCS사용자(원무-심사자정보용) */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
		              and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
		              and  (#{wrknPartCd} is null or a.SBDP_CD= #{wrknPartCd})     /* 외과분과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							 (
								 (
									 nvl(#{codvCd1},'N') != 'Y' and
									 nvl(#{codvCd2},'N') != 'Y' and
									 nvl(#{codvCd3},'N') != 'Y' and
									 nvl(#{codvCd4},'N') != 'Y'
								 )
								 and
								 (1=1)
							 )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3',  '4', '5', 'A', 'B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2', '3')) /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is not null and a.OPRM_CHOT_DT is null)) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRM_CHOT_DT is not null) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD ='O'
					and (   e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')   and a.ordp_cd = e.mcdp_cd (+))
					  and  e.CNCL_DT(+) is null
					  and  k.USER_ID(+)  = e.MAIN_CHKR_ID
					  and  h.LGIN_ID(+)  = k.LGIN_ID
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  j.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= j.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					order  by
						   OPRM_CD
						,  OPST_PRRN_DT
						,  ORDP_CD
						,  OPSR_ID_1
						,  OPRT_STTS_CD
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X7-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="frrn" column="FRRN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="pcaYn" column="PCA_YN"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="afiAsnuNm1" column="AFI_ASNU_NM_1"/>
		<result property="afiAsnuNm2" column="AFI_ASNU_NM_2"/>
		<result property="afiAsnuNm3" column="AFI_ASNU_NM_3"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="strmMvmnYn" column="STRM_MVMN_YN"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X7 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X7-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X7"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X7-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X7 */
		<![CDATA[
				   select  /*+ NO_EXPAND LEADING(A, F, Y, X, G) USE_NL(A, B, E, F, G, Z, H, X, Y, I) mdo_opschet_l01$S05_수술환자선택-회복실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )  as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
					   ,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT = e.DSCH_DT
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT     /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1        /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(count(*),0,'N','Y')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.CRTF_YN      = 'Y'
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
																						 and  (xx.ATHN_ID is not null and xx.CRTF_DT >= nvl( xx.TMPR_SAVE_DT, to_date('18990101', 'yyyymmdd'))))))  as CRTF_YN /* 마취기록확정여부  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
						,  CSCR_NM as CSCR_NM             /* CaseCart명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					   from CCUSERAMT a1 where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				   from CCUSERAMT a1
																				  where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  (
							   select
									  to_char(xx.ENRM_DT,'yyyymmddhh24mi')
								 from
									  MNSOPMOVT xx
								where
									  xx.PTNO         = a.PTNO
								  and xx.OPRT_YMD     = a.OPRT_YMD
								  and xx.OPRT_SNO     = a.OPRT_SNO
								  and xx.OPPL_DVSN_CD = #{opplCd}
								  and xx.MVMN_PLAC_CD = 'E'
						   )  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시) */
						,  ''  as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시      */
						,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드           */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												   from CCCMCDDMT F_A
													  , CCCMCDDLT F_B
												  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													and F_A.COMN_GRP_CD = 'MN909'
													and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  ''  as PACU_CHOT_PADV_CD      /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM  /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT       /* 회복실퇴실일시 */
						,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  ''  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						, '' as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
						,  decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시  */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
						--	 and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN
						, a.STRM_MVMN_YN as STRM_MVMN_YN
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN   /* 협진수술여부 */
						, (select LISTAGG('['||aa.CPDP_CD||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM   /* 협진수술명 */
						, e.MDRP_NO  as MDRP_NO        /* 진료접수번호 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (
								 #{oprtSttsCd3} = 'Y'
								 and
								(a.PTNO in (select PTNO
											  from MNSOPMOVT xx
											 where xx.PTNO         = a.PTNO
											   and xx.OPRT_YMD     = a.OPRT_YMD
											   and xx.OPRT_SNO     = a.OPRT_SNO
											   and xx.MVMN_PLAC_CD = 'E'
											   and (xx.CHOT_DT is null or xx.CHOT_DT > sysdate))
								 )
							 ) /*(회복중) */
							 or
							 (
								 #{oprtSttsCd4} = 'Y'
								 and
								 (a.PTNO in (select PTNO
											   from MNSOPMOVT xx
											  where xx.PTNO         = a.PTNO
												and xx.OPRT_YMD     = a.OPRT_YMD
												and xx.OPRT_SNO     = a.OPRT_SNO
												and xx.MVMN_PLAC_CD = 'E'
												and (xx.CHOT_DT is not null and xx.CHOT_DT <= sysdate)))
							 )  /*(퇴실:회복실) */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  a.OPRM_CD != 'KB1'
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
					]]>
		              <if test='opplCd !="D"'>
		<![CDATA[
					  and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					  and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')
					]]>
		              </if>
		<if test='opplCd =="D"'>
		<![CDATA[
					  and  #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')
					]]>
		              </if>
		<![CDATA[
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  ((a.PTNO in (select PTNO
							  from MNSOPMOVT xx
							 where xx.PTNO         = a.PTNO
							   and xx.OPRT_YMD     = a.OPRT_YMD
							   and xx.OPRT_SNO     = a.OPRT_SNO
							   and xx.OPPL_DVSN_CD = 'D'
							   and xx.MVMN_PLAC_CD = 'E'))
							 or
							(a.OPRM_CHOT_DT is not null and /* 수술실 퇴실장소가 회복실일때 */
							 a.OPRM_CHOT_DT <= sysdate and
							 a.OPRM_CHOT_PADV_CD = '1' )
						   )
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  (
							  #{nursId} is null or
							  (
								  y.MAIN_ASNU_ID = #{nursId}
								  or
								  y.SUB_ASNU_ID  = #{nursId}
								  or
								  y.ASST_ASNU_ID = #{nursId}
							  )
						   )
					union
					select  /*+ NO_EXPAND LEADING(A, F, Y, X, G) USE_NL(A, B, E, F, G, Z, H, X, Y, I) mdo_opschet_l01$S06_수술환자선택-회복실 환자조회 */
							b.PTNT_NM                              /* 환자명 */
						 ,  a.PTNO                                 /* 환자번호 */
						 ,  b.GEND_CD                              /* 성별 */
						 ,  to_char(b.BTDT,'yyyymmdd') as BTDT     /* 나이 */
						 ,  b.FRRN                     as FRRN     /* 주민번호 */
						 ,  a.ORDP_CD
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )  as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
							case when e.CODV_CD = 'D' then nvl((
														  select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															from  APRCRPTNT bb
														   where  bb.PTNO = e.PTNO
															 and  bb.CODV_CD = 'I'
															 and  bb.MDCR_DT = e.DSCH_DT
															 and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD ) end) as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						 ,  (
							case when e.CODV_CD = 'D' then nvl((
															  select  CARE_PTRM_NO
																from  APRCRPTNT bb
															   where  bb.PTNO = e.PTNO
																 and  bb.CODV_CD = 'I'
																 and  bb.MDCR_DT = e.DSCH_DT
																 and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end) as CARE_PTRM_NO  /* 간호병실번호  */
						 ,  a.OPSR_ID1                                          /* 집도의사ID1 */
						 ,  a.OPSR_ID2                                          /* 집도의사ID2 */
						 ,  a.OPSR_ID3                                          /* 집도의사ID3 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 ) as OPSR_ID_NM1  /* 집도의사명1 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 ) as OPSR_ID_NM2  /* 집도의사명2 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 ) as OPSR_ID_NM3  /* 집도의사명3 */
						 ,  a.ANSH_ID1                                                                                                                        as ANSH_ID_1    /* 마취의사ID1 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )                                                   as ANSH_NM_1    /* 마취의사명1 */
						 ,  a.ANSH_ID2                                                                                                                        as ANSH_ID_2    /* 마취의사2ID  */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)                                                    as ANSH_NM_2    /* 마취의사명2 */
						 ,  a.ANSH_ID3                                                                                                                        as ANSH_ID_3    /* 마취의사3ID  */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )                                                   as ANSH_NM_3    /* 마취의사명3 */
						 ,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 ) as AFI_OPRM_NM                           /* AFI수술실명 */
						 ,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi') as OPST_PRRN_DT   /* 수술시작예정일시 */
						 ,  to_char(a.OPST_PRRN_DT,'AM hh12:mi') as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
						 ,  a.OPRT_STTS_CD                                               /*수술상태코드 */
						 ,  '' as OPRT_STTS_CTN /* 수술상태내용 */
						 ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(count(*),0,'N','')
																						 from MEDOCMBST xx
																						where xx.PTNO         = a.PTNO
																						  and xx.RCRD_DT      = a.OPRT_YMD
																						  and xx.BHVR_SNO     = a.OPRT_SNO
																						  and xx.CRTF_YN      = 'Y'
																						  and xx.RCRD_LAST_YN = 'Y'
																						  and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
																						  and  (xx.ATHN_ID is not null and xx.CRTF_DT >= nvl( xx.TMPR_SAVE_DT, to_date('18990101', 'yyyymmdd')))))) as CRTF_YN /* 마취기록확정여부  */
						 ,  a.ANKI_CD                                                   /* 마취종류코드 */
						 ,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								from CCCMCDDMT F_A
								   , CCCMCDDLT F_B
							   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								 and F_A.COMN_GRP_CD = 'MM081'
								 and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						 ,  a.CODV_CD                                                   /* 내원구분코드 */
						 ,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','') as CODV_NM /* 내원구분명 */
						 ,  CSCR_CD             /* CaseCart코드   */
						 ,  CSCR_NM             /* CaseCart명   */
						 ,  CLNC_OPRT_NM        /* 임상수술명  */
						 ,  decode(a.PTNO,g.PTNO,'Y','N') as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						 ,  a.ER_YN /* 응급여부 */
						 ,  decode(a.ER_YN,'Y','응급','정규') as AFI_ER_DVSN_NM /* 응급구분명 */
						 ,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi') as OPRM_ENRM_DT                       /* 수술실도착시간  */
						 , (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								 else
								   (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					  from CCUSERAMT a1
																					 where a1.LGIN_ID = e.GNDR_ID)
										 when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				  from CCUSERAMT a1
																				 where a1.LGIN_ID = a.OPSR_ID1) end)
								 end)                                                                                                            as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						 ,  a.IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						 ,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								from CCCMCDDMT F_A
								   , CCCMCDDLT F_B
							   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								 and F_A.COMN_GRP_CD = 'MM441'
								 and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								 and F_B.LNGG_CD(+) = nvl('', '*') ) as DRG_NM /* DRG명  */
						 ,  a.CP_CD    /* CP코드  */
						 ,  e.MCDP_CD  /* 입원환자 진료과  */
						 ,  a.SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						 ,  nvl(a.CNCL_YN,'N') as CNCL_YN /* 취소여부 */
						 ,  a.OPRT_SNO /* 수술순번 */
						 ,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi') as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시:수술실 퇴실일시) */
						 ,  ''                                       as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
						 ,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi') as OPRM_CHOT_DT /* 수술실 퇴실일시      */
						 ,  a.OPRM_CD                                                /* 수술실코드           */
						 ,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') ) as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						 ,  a.ETC_CNRE_CTN /* 기타취소내용 */
						 ,  '' as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						 ,  '' as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						 ,  '' as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						 ,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO) as AFI_SLCT_CTN /* 선택내용(선택) */
						 ,  '' as AFI_ENFR_CTN  /* 시행내용(시행) */
						 , '' as SMCR_YN /* 선택진료여부 */
						 ,  '' as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						 ,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3) as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						 ,  FN_QD_CAUTION_COLOR_VL(a.PTNO) as AFI_INFC_STTS_NM1                     /* AFI감염상태명1(감염COLOR) */
						 ,  FN_QD_CAUTION_COUNT(a.PTNO) as AFI_INFC_STTS_NM2                     /* AFI감염상태명2(감염COUNT) */
						 , decode(a.PTNO,i.PTNO,'Y','N')                                                  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						 , (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)                   as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						 ,  decode(a.PTNO,y.PTNO,'Y','N') as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						 ,  '' as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						 ,  to_char(a.ANST_STRT_DT,'AM hh12:mi') as ANST_STRT_DT /* 마취시작일시 */
						 ,  to_char(a.ANST_DRVT_DT,'AM hh12:mi') as ANST_DRVT_DT /* 마취유도종료시간 */
						 ,  to_char(a.OPST_DT,'AM hh12:mi') as OPST_DT /*  수술시작(절개시간) */
						 ,  to_char(a.SUTR_STRT_DT,'AM hh12:mi') as SUTR_STRT_DT /* 봉합시작 */
						 ,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi') as SUTR_FNSH_DT /* 봉합완료 */
						 ,  to_char(a.OPRT_YMD,'yyyymmdd') as OPRT_YMD /* 수술일자 */
						 ,  a.DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						 ,  (select  aa.PTNT_TLNO
							   from  APPTCNPNV aa
							  where  aa.PTNO = a.PTNO
								and  aa.CNPN_DVSN_CD = '2'
								and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															 from APPTCNPNV bb
															where bb.PTNO = a.PTNO
															  and bb.CNPN_DVSN_CD = '2'
															  and bb.PTNT_TLNO is not null )) as PTNT_TLNO /* 전화번호(휴대폰) */
						 ,  (select TS_YN
							   from MDCAOPCDT aa
							  where aa.MCDP_CD = a.ORDP_CD
								and aa.CSCR_CD = a.CSCR_CD) as TS_YN /* T&S */
						 ,  '' as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
						 ,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID) as AFI_CP_INFM_CTN /* CP정보내용 */
						 ,  (case when exists (select
								 'X'
						   from
								 MDOPSCHHT
						  where  PTNO     = a.PTNO
							and  OPRT_YMD = a.OPRT_YMD
							and  OPRT_SNO = a.OPRT_SNO
							and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end) as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						 , (case when exists(select
								 'X'
						   from
								 MDOPSCHHT
						  where  PTNO     = a.PTNO
							and  OPRT_YMD = a.OPRT_YMD
							and  OPRT_SNO = a.OPRT_SNO
							and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						 ,  '' as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID ) as AFI_ASNU_NM1 /* 회복실 담당간호사1명 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM2 /* 회복실 담당간호사2명 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID ) as AFI_ASNU_NM3 /* 회복실 담당간호사3명 */
						 ,  to_char(e.MDCR_DT,'yyyymmddhh24mi') as MDCR_DT
						 , (
						   select  nvl(max('Y'), 'N')
							 from  MDTRTORDT x         /* 처방료처방TABLE  */
							where
								   x.PTNO     = a.PTNO
							  and  x.OPRT_YMD = a.OPRT_YMD
							  and  x.OPRT_SNO = a.OPRT_SNO
							  and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							  and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
						 ) as AFI_ANST_FEE_YN                      /* 마취료여부  */
						 ,
						 (
						   select  decode(count(*), 0, null
												, sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							 from  MDMEDORDT z        /* 약처방TABLE */
							where
								   z.PTNO = a.PTNO
							  and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							  and  z.OPRT_YMD = a.OPRT_YMD
							  and  z.OPRT_SNO = a.OPRT_SNO
							  and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							  and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
					--		  and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						 ) as AFI_DRRT_CCT_CTN
						 , a.STRM_MVMN_YN
						 , (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								 when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end) as FRGN_YN /* 외국인여부 */
						 , (select decode(count(a.PTNO),0,'','Y')
							  from MDOPSCCOT aa
							 where aa.PTNO     = a.PTNO
							   and aa.OPRT_YMD = a.OPRT_YMD
							   and aa.OPRT_SNO = a.OPRT_SNO)                                          as CMTX_OPRT_YN           /* 협진수술여부 */
						 , (select LISTAGG('['||aa.CPDP_CD||'] '||
												bb.USER_NM||'('||
												aa.CMTX_OPSR_ID1||') '||
												aa.CMTX_OPRT_CSCR_NM, chr(13))
								   WITHIN group (order by CPDP_CD)
							  from MDOPSCCOT aa
								 , CCUSRDPHT bb
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO
							  and bb.USER_ID  = aa.CMTX_OPSR_ID1
							group by
								  aa.PTNO
								, aa.OPRT_YMD
								, aa.OPRT_SNO)                                                        as CMTX_OPRT_NM           /* 협진수술명 */
						 , e.MDRP_NO                                                                  as MDRP_NO /* 진료접수번호 */
		                 , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD = '2') /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is not null and a.OPRM_CHOT_DT is null)) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRM_CHOT_DT is not null) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  a.OPRM_CD = 'KB1'
					  and  (a.PTNO in (select PTNO
										 from MNSOPMOVT xx
										where xx.PTNO         = a.PTNO
										  and xx.OPRT_YMD     = a.OPRT_YMD
										  and xx.OPRT_SNO     = a.OPRT_SNO
										  and xx.OPPL_DVSN_CD = 'D'
										  and xx.MVMN_PLAC_CD = 'E'))
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
					  and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
					    )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  (
							  #{nursId} is null or
							  (
								  y.MAIN_ASNU_ID = #{nursId}
								  or
								  y.SUB_ASNU_ID  = #{nursId}
								  or
								  y.ASST_ASNU_ID = #{nursId}
							  )
						   )
		union all
		select  /*+ NO_EXPAND LEADING(A, F, Y, X, G) USE_NL(A, B, E, F, G, Z, H, X, Y, I) mdo_opschet_l01$S05_수술환자선택-회복실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,  decode(a.ORDP_CD,'111210'
										   ,( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = a.ORDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )||'-'||
											(
											  select (
													   select
															  F_A.ABRV_DPRT_CD
														 from
															  HZDEPTMMT F_A
														where
															  F_A.DPRT_CD = nvl(xx.HRAF_PRAP_DPRT_CD,xx.MDCR_DPRT_CD)
														group
															  by F_A.ABRV_DPRT_CD
													 )
												from
													  CCUSRDPHT xx
											   where
													  xx.USER_ID = a.OPSR_ID1
											)
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )  as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
					   ,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT = e.DSCH_DT
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                           /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT     /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1        /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                               /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(count(*),0,'N','Y')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.CRTF_YN      = 'Y'
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
																						 and  (xx.ATHN_ID is not null and xx.CRTF_DT >= nvl( xx.TMPR_SAVE_DT, to_date('18990101', 'yyyymmdd'))))))  as CRTF_YN /* 마취기록확정여부  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
						,  CSCR_NM as CSCR_NM             /* CaseCart명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					   from CCUSERAMT a1 where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				   from CCUSERAMT a1
																				  where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  (
							   select
									  to_char(xx.ENRM_DT,'yyyymmddhh24mi')
								 from
									  MNSOPMOVT xx
								where
									  xx.PTNO         = a.PTNO
								  and xx.OPRT_YMD     = a.OPRT_YMD
								  and xx.OPRT_SNO     = a.OPRT_SNO
								  and xx.OPPL_DVSN_CD = #{opplCd}
								  and xx.MVMN_PLAC_CD = 'E'
						   )  as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시) */
						,  ''  as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시      */
						,  a.OPRM_CD as OPRM_CD                                                /* 수술실코드           */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												   from CCCMCDDMT F_A
													  , CCCMCDDLT F_B
												  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													and F_A.COMN_GRP_CD = 'MN909'
													and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  ''  as PACU_CHOT_PADV_CD      /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM  /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT       /* 회복실퇴실일시 */
						,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
						,  decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID )  as AFI_ASNU_NM_1 /* 회복실 담당간호사1명 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM_2 /* 회복실 담당간호사2명 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID )  as AFI_ASNU_NM_3 /* 회복실 담당간호사3명 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시  */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
						--	 and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN
						, a.STRM_MVMN_YN as STRM_MVMN_YN
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN   /* 협진수술여부 */
						, (select LISTAGG('['||aa.CPDP_CD||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM   /* 협진수술명 */
						, e.MDRP_NO  as MDRP_NO        /* 진료접수번호 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (
								 #{oprtSttsCd3} = 'Y'
								 and
								(a.PTNO in (select PTNO
											  from MNSOPMOVT xx
											 where xx.PTNO         = a.PTNO
											   and xx.OPRT_YMD     = a.OPRT_YMD
											   and xx.OPRT_SNO     = a.OPRT_SNO
											   and xx.MVMN_PLAC_CD = 'E'
											   and (xx.CHOT_DT is null or xx.CHOT_DT > sysdate))
								 )
							 ) /*(회복중) */
							 or
							 (
								 #{oprtSttsCd4} = 'Y'
								 and
								 (a.PTNO in (select PTNO
											   from MNSOPMOVT xx
											  where xx.PTNO         = a.PTNO
												and xx.OPRT_YMD     = a.OPRT_YMD
												and xx.OPRT_SNO     = a.OPRT_SNO
												and xx.MVMN_PLAC_CD = 'E'
												and (xx.CHOT_DT is not null and xx.CHOT_DT <= sysdate)))
							 )  /*(퇴실:회복실) */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  a.OPRM_CD != 'KB1'
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
					]]>
		              <if test='opplCd !="D"'>
		<![CDATA[
					  and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					  and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd') 
					]]>
		              </if>
		<if test='opplCd =="D"'>
		<![CDATA[
					  and  #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')
					]]>
		              </if>
		<![CDATA[
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  ((a.PTNO in (select PTNO
							  from MNSOPMOVT xx
							 where xx.PTNO         = a.PTNO
							   and xx.OPRT_YMD     = a.OPRT_YMD
							   and xx.OPRT_SNO     = a.OPRT_SNO
							   and xx.OPPL_DVSN_CD = 'D'
							   and xx.MVMN_PLAC_CD = 'E'))
							 or
							(a.OPRM_CHOT_DT is not null and /* 수술실 퇴실장소가 회복실일때 */
							 a.OPRM_CHOT_DT <= sysdate and
							 a.OPRM_CHOT_PADV_CD = '1' )
						   )
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  (
							  #{nursId} is null or
							  (
								  y.MAIN_ASNU_ID = #{nursId}
								  or
								  y.SUB_ASNU_ID  = #{nursId}
								  or
								  y.ASST_ASNU_ID = #{nursId}
							  )
						   )
					union
					select  /*+ NO_EXPAND LEADING(A, F, Y, X, G) USE_NL(A, B, E, F, G, Z, H, X, Y, I) mdo_opschet_l01$S06_수술환자선택-회복실 환자조회 */
							b.PTNT_NM                              /* 환자명 */
						 ,  a.PTNO                                 /* 환자번호 */
						 ,  b.GEND_CD                              /* 성별 */
						 ,  to_char(b.BTDT,'yyyymmdd') as BTDT     /* 나이 */
						 ,  b.FRRN                     as FRRN     /* 주민번호 */
						 ,  a.ORDP_CD
						 ,  decode(a.ORDP_CD,'111210'
											,( select
													  F_A.ABRV_DPRT_CD
												 from
													  HZDEPTMMT F_A
												where
													  F_A.DPRT_CD = a.ORDP_CD
												group by
													  F_A.ABRV_DPRT_CD )||'-'||
											 (
											   select (
														select
															   F_A.ABRV_DPRT_CD
														  from
															   HZDEPTMMT F_A
														 where
															   F_A.DPRT_CD = nvl(xx.HRAF_PRAP_DPRT_CD,xx.MDCR_DPRT_CD)
														 group
															   by F_A.ABRV_DPRT_CD
													  )
												 from
													   CCUSRDPHT xx
												where
													   xx.USER_ID = a.OPSR_ID1
											 )
											,
											( select
													 F_A.ABRV_DPRT_CD
												from
													 HZDEPTMMT F_A
											   where
													 F_A.DPRT_CD = a.ORDP_CD
											   group by
													 F_A.ABRV_DPRT_CD )
											) as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
							case when e.CODV_CD = 'D' then nvl((
														  select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
															from  APRCRPTNT bb
														   where  bb.PTNO = e.PTNO
															 and  bb.CODV_CD = 'I'
															 and  bb.MDCR_DT = e.DSCH_DT
															 and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							   from HZDEPTMMT F_A
																							  where F_A.DPRT_CD = e.CARE_WARD_CD
																							  group by
																									F_A.ABRV_DPRT_CD ) end) as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						 ,  (
							case when e.CODV_CD = 'D' then nvl((
															  select  CARE_PTRM_NO
																from  APRCRPTNT bb
															   where  bb.PTNO = e.PTNO
																 and  bb.CODV_CD = 'I'
																 and  bb.MDCR_DT = e.DSCH_DT
																 and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end) as CARE_PTRM_NO  /* 간호병실번호  */
						 ,  a.OPSR_ID1                                          /* 집도의사ID1 */
						 ,  a.OPSR_ID2                                          /* 집도의사ID2 */
						 ,  a.OPSR_ID3                                          /* 집도의사ID3 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 ) as OPSR_ID_NM1  /* 집도의사명1 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 ) as OPSR_ID_NM2  /* 집도의사명2 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 ) as OPSR_ID_NM3  /* 집도의사명3 */
						 ,  a.ANSH_ID1                                                                                                                        as ANSH_ID_1    /* 마취의사ID1 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )                                                   as ANSH_NM_1    /* 마취의사명1 */
						 ,  a.ANSH_ID2                                                                                                                        as ANSH_ID_2    /* 마취의사2ID  */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)                                                    as ANSH_NM_2    /* 마취의사명2 */
						 ,  a.ANSH_ID3                                                                                                                        as ANSH_ID_3    /* 마취의사3ID  */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )                                                   as ANSH_NM_3    /* 마취의사명3 */
						 ,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 ) as AFI_OPRM_NM                           /* AFI수술실명 */
						 ,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi') as OPST_PRRN_DT   /* 수술시작예정일시 */
						 ,  to_char(a.OPST_PRRN_DT,'AM hh12:mi') as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
						 ,  a.OPRT_STTS_CD                                               /*수술상태코드 */
						 ,  '' as OPRT_STTS_CTN /* 수술상태내용 */
						 ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(count(*),0,'N','')
																						 from MEDOCMBST xx
																						where xx.PTNO         = a.PTNO
																						  and xx.RCRD_DT      = a.OPRT_YMD
																						  and xx.BHVR_SNO     = a.OPRT_SNO
																						  and xx.CRTF_YN      = 'Y'
																						  and xx.RCRD_LAST_YN = 'Y'
																						  and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
																						  and  (xx.ATHN_ID is not null and xx.CRTF_DT >= nvl( xx.TMPR_SAVE_DT, to_date('18990101', 'yyyymmdd')))))) as CRTF_YN /* 마취기록확정여부  */
						 ,  a.ANKI_CD                                                   /* 마취종류코드 */
						 ,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								from CCCMCDDMT F_A
								   , CCCMCDDLT F_B
							   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								 and F_A.COMN_GRP_CD = 'MM081'
								 and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						 ,  a.CODV_CD                                                   /* 내원구분코드 */
						 ,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','') as CODV_NM /* 내원구분명 */
						 ,  CSCR_CD             /* CaseCart코드   */
						 ,  CSCR_NM             /* CaseCart명   */
						 ,  CLNC_OPRT_NM        /* 임상수술명  */
						 ,  decode(a.PTNO,g.PTNO,'Y','N') as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						 ,  a.ER_YN /* 응급여부 */
						 ,  decode(a.ER_YN,'Y','응급','정규') as AFI_ER_DVSN_NM /* 응급구분명 */
						 ,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi') as OPRM_ENRM_DT                       /* 수술실도착시간  */
						 , (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								 else
								   (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					  from CCUSERAMT a1
																					 where a1.LGIN_ID = e.GNDR_ID)
										 when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				  from CCUSERAMT a1
																				 where a1.LGIN_ID = a.OPSR_ID1) end)
								 end)                                                                                                            as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						 ,  a.IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						 ,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
								from CCCMCDDMT F_A
								   , CCCMCDDLT F_B
							   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								 and F_A.COMN_GRP_CD = 'MM441'
								 and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								 and F_B.LNGG_CD(+) = nvl('', '*') ) as DRG_NM /* DRG명  */
						 ,  a.CP_CD    /* CP코드  */
						 ,  e.MCDP_CD  /* 입원환자 진료과  */
						 ,  a.SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						 ,  nvl(a.CNCL_YN,'N') as CNCL_YN /* 취소여부 */
						 ,  a.OPRT_SNO /* 수술순번 */
						 ,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi') as ENRM_DT      /* 환자 위치별 입실일시(회복실 입실일시:수술실 퇴실일시) */
						 ,  ''                                       as CHOT_DT      /* 환자 위치별 퇴실일시 -> 환지 이동정보에서 회복실 퇴실일시 Setting */
						 ,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi') as OPRM_CHOT_DT /* 수술실 퇴실일시      */
						 ,  a.OPRM_CD                                                /* 수술실코드           */
						 ,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') ) as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						 ,  a.ETC_CNRE_CTN /* 기타취소내용 */
						 ,  '' as PACU_CHOT_PADV_CD     /* 회복실퇴실장소구분코드 */
						 ,  '' as AFI_PACU_CHOT_PLAC_NM /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						 ,  '' as AFI_PACU_CHOT_DT      /* 회복실퇴실일시 */
						 ,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO) as AFI_SLCT_CTN /* 선택내용(선택) */
						 ,  decode(a.ANSH_ID2,null,null,
								 ( select nvl(( select F_A.SMCR_YN
												  from APDSDRDPT F_A
												 where F_A.MDDR_ID = a.ANSH_ID2
												   and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual )) as AFI_ENFR_CTN  /* 시행내용(시행) */
						 ,  '' as SMCR_YN /* 선택진료여부 */
						 ,  '' as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
						 ,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3) as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						 ,  FN_QD_CAUTION_COLOR_VL(a.PTNO) as AFI_INFC_STTS_NM1                     /* AFI감염상태명1(감염COLOR) */
						 ,  FN_QD_CAUTION_COUNT(a.PTNO) as AFI_INFC_STTS_NM2                     /* AFI감염상태명2(감염COUNT) */
						 , decode(a.PTNO,i.PTNO,'Y','N')                                                  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						 , (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)                   as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						 ,  decode(a.PTNO,y.PTNO,'Y','N') as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						 ,  '' as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						 ,  to_char(a.ANST_STRT_DT,'AM hh12:mi') as ANST_STRT_DT /* 마취시작일시 */
						 ,  to_char(a.ANST_DRVT_DT,'AM hh12:mi') as ANST_DRVT_DT /* 마취유도종료시간 */
						 ,  to_char(a.OPST_DT,'AM hh12:mi') as OPST_DT /*  수술시작(절개시간) */
						 ,  to_char(a.SUTR_STRT_DT,'AM hh12:mi') as SUTR_STRT_DT /* 봉합시작 */
						 ,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi') as SUTR_FNSH_DT /* 봉합완료 */
						 ,  to_char(a.OPRT_YMD,'yyyymmdd') as OPRT_YMD /* 수술일자 */
						 ,  a.DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						 ,  (select  aa.PTNT_TLNO
							   from  APPTCNPNV aa
							  where  aa.PTNO = a.PTNO
								and  aa.CNPN_DVSN_CD = '2'
								and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															 from APPTCNPNV bb
															where bb.PTNO = a.PTNO
															  and bb.CNPN_DVSN_CD = '2'
															  and bb.PTNT_TLNO is not null )) as PTNT_TLNO /* 전화번호(휴대폰) */
						 ,  (select TS_YN
							   from MDCAOPCDT aa
							  where aa.MCDP_CD = a.ORDP_CD
								and aa.CSCR_CD = a.CSCR_CD) as TS_YN /* T&S */
						 ,  '' as STRM_LCTN_VL    /* 안정실 위치값 -> 환자 이동정보에서 Setting */
						 ,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID) as AFI_CP_INFM_CTN /* CP정보내용 */
						 ,  (case when exists (select
								 'X'
						   from
								 MDOPSCHHT
						  where  PTNO     = a.PTNO
							and  OPRT_YMD = a.OPRT_YMD
							and  OPRT_SNO = a.OPRT_SNO
							and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end) as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						 , (case when exists(select
								 'X'
						   from
								 MDOPSCHHT
						  where  PTNO     = a.PTNO
							and  OPRT_YMD = a.OPRT_YMD
							and  OPRT_SNO = a.OPRT_SNO
							and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						 ,  '' as AOR_PRRM_ENRM_DT  /* 준비실 입실일시  -> 환자 이동정보에서 Setting */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.MAIN_ASNU_ID ) as AFI_ASNU_NM1 /* 회복실 담당간호사1명 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.SUB_ASNU_ID )  as AFI_ASNU_NM2 /* 회복실 담당간호사2명 */
						 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = y.ASST_ASNU_ID ) as AFI_ASNU_NM3 /* 회복실 담당간호사3명 */
						 ,  to_char(e.MDCR_DT,'yyyymmddhh24mi') as MDCR_DT
						 , (
						   select  nvl(max('Y'), 'N')
							 from  MDTRTORDT x         /* 처방료처방TABLE  */
							where
								   x.PTNO     = a.PTNO
							  and  x.OPRT_YMD = a.OPRT_YMD
							  and  x.OPRT_SNO = a.OPRT_SNO
							  and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							  and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
						 ) as AFI_ANST_FEE_YN                      /* 마취료여부  */
						 ,
						 (
						   select  decode(count(*), 0, null
												, sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							 from  MDMEDORDT z        /* 약처방TABLE */
							where
								   z.PTNO = a.PTNO
							  and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							  and  z.OPRT_YMD = a.OPRT_YMD
							  and  z.OPRT_SNO = a.OPRT_SNO
							  and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							  and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
					--		  and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						 ) as AFI_DRRT_CCT_CTN
						 , a.STRM_MVMN_YN
						 , (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								 when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end) as FRGN_YN /* 외국인여부 */
						 , (select decode(count(a.PTNO),0,'','Y')
							  from MDOPSCCOT aa
							 where aa.PTNO     = a.PTNO
							   and aa.OPRT_YMD = a.OPRT_YMD
							   and aa.OPRT_SNO = a.OPRT_SNO)                                          as CMTX_OPRT_YN           /* 협진수술여부 */
						 , (select LISTAGG('['||aa.CPDP_CD||'] '||
												bb.USER_NM||'('||
												aa.CMTX_OPSR_ID1||') '||
												aa.CMTX_OPRT_CSCR_NM, chr(13))
								   WITHIN group (order by CPDP_CD)
							  from MDOPSCCOT aa
								 , CCUSRDPHT bb
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO
							  and bb.USER_ID  = aa.CMTX_OPSR_ID1
							group by
								  aa.PTNO
								, aa.OPRT_YMD
								, aa.OPRT_SNO)                                                        as CMTX_OPRT_NM           /* 협진수술명 */
						 , e.MDRP_NO                                                                  as MDRP_NO /* 진료접수번호 */
		                 , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  ((#{anshId} is null)
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2','3') ) /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is not null and a.OPRM_CHOT_DT is null)) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRM_CHOT_DT is not null) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  a.OPRM_CD = 'KB1'
					  and  (a.PTNO in (select PTNO
										 from MNSOPMOVT xx
										where xx.PTNO         = a.PTNO
										  and xx.OPRT_YMD     = a.OPRT_YMD
										  and xx.OPRT_SNO     = a.OPRT_SNO
										  and xx.OPPL_DVSN_CD = 'D'
										  and xx.MVMN_PLAC_CD = 'E'))
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD ='O'
					  and (    e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')  and a.ordp_cd = e.mcdp_cd (+) )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  (
							  #{nursId} is null or
							  (
								  y.MAIN_ASNU_ID = #{nursId}
								  or
								  y.SUB_ASNU_ID  = #{nursId}
								  or
								  y.ASST_ASNU_ID = #{nursId}
							  )
						   )
					order  by
						   OPRM_CD
						,  OPST_PRRN_DT
						,  ORDP_CD
						,  OPSR_ID_1
						,  OPRT_STTS_CD
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X8-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="frrn" column="FRRN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="oprmChotPadvCd" column="OPRM_CHOT_PADV_CD"/>
		<result property="afiChotPadvNm" column="AFI_CHOT_PADV_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="afiCscrOrdrSttsNm" column="AFI_CSCR_ORDR_STTS_NM"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="chckDvsnCd" column="CHCK_DVSN_CD"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="chkrNm" column="CHKR_NM"/>
		<result property="chkrTlno" column="CHKR_TLNO"/>
		<result property="chkrNm1" column="CHKR_NM_1"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="tlviYn1" column="TLVI_YN_1"/>
		<result property="tlviYn2" column="TLVI_YN_2"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="afiAorCarcWrtgYn" column="AFI_AOR_CARC_WRTG_YN"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="strmMvmnYn" column="STRM_MVMN_YN"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X8 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X8-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X8"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X8-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X8 */
		<![CDATA[
				   select  /*+ DSC - 안정실 환자조회 */
						  b.PTNT_NM as PTNT_NM                              /* 환자명 */
					   ,  a.PTNO as PTNO                                 /* 환자번호 */
					   ,  b.GEND_CD as GEND_CD                              /* 성별 */
					   ,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
					   ,  b.FRRN  as FRRN     /* 앞주민번호 */
					   ,  a.ORDP_CD as ORDP_CD
					   ,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
						  case when e.CODV_CD = 'D' then nvl((
														select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														  from  APRCRPTNT bb
														 where  bb.PTNO = e.PTNO
														   and  bb.CODV_CD = 'I'
														   and  bb.MDCR_DT between to_date(#{oprtYmd},'yyyymmdd') and
																				 to_date(#{oprtYmd},'yyyymmdd') + .99999
														   and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							 from HZDEPTMMT F_A
																							where F_A.DPRT_CD = e.CARE_WARD_CD
																							group by
																								  F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							 from HZDEPTMMT F_A
																							where F_A.DPRT_CD = e.CARE_WARD_CD
																							group by
																								  F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
					   ,  (
						  case when e.CODV_CD = 'D' then nvl((
															select  CARE_PTRM_NO
															  from  APRCRPTNT bb
															 where  bb.PTNO = e.PTNO
															   and  bb.CODV_CD = 'I'
															   and  bb.MDCR_DT = e.DSCH_DT
															   and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
					   ,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
					   ,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
					   ,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
					   ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
					   ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
					   ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
					   ,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
					   ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
					   ,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
					   ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
					   ,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
					   ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
					   ,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
					   ,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
					   ,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
					   ,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
					   ,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
					   ,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(count(*),0,'N','Y')
																					   from MEDOCMBST xx
																					  where xx.PTNO         = a.PTNO
																						and xx.RCRD_DT      = a.OPRT_YMD
																						and xx.BHVR_SNO     = a.OPRT_SNO
																						and xx.CRTF_YN      = 'Y'
																						and xx.RCRD_LAST_YN = 'Y'
																						and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
																						and  (xx.ATHN_ID is not null and xx.CRTF_DT >= nvl( xx.TMPR_SAVE_DT, to_date('18990101', 'yyyymmdd'))))))  as CRTF_YN /* 마취기록확정 */
					   ,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
					   ,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							  from CCCMCDDMT F_A
								 , CCCMCDDLT F_B
							 where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
							   and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
							   and F_A.COMN_GRP_CD = 'MM081'
							   and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
					   ,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
					   ,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
					   ,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
					   ,  CSCR_NM as CSCR_NM             /* CaseCart명   */
					   ,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
					   ,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
					   , (case when a.OPRT_STTS_CD in ('2','9') then ''
							   when a.OPRT_STTS_CD = '4' then '대기실'
							   when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
							   else   ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
											   from CCCMCDDMT F_A
												  , CCCMCDDLT F_B
											  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												and F_A.COMN_GRP_CD = 'MN488'
												and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
					   ,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
					   ,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
					   ,  a.ER_YN as ER_YN /* 응급여부 */
					   ,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
					   ,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
					   , (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
							   else
								 (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					from CCUSERAMT a1
																				   where a1.LGIN_ID = e.GNDR_ID)
									   when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				from CCUSERAMT a1
																			   where a1.LGIN_ID = a.OPSR_ID1) end)
							   end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
					   ,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
					   ,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							  from CCCMCDDMT F_A
								 , CCCMCDDLT F_B
							 where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
							   and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
							   and F_A.COMN_GRP_CD = 'MM441'
							   and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
							   and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
					   ,  a.CP_CD as CP_CD    /* CP코드  */
					   ,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
					   ,  a.SCIN_NM as SCIN_NM  /* 상병명 */
					   , decode(to_char(e.ERRM_ARVL_DT,'yyyymmdd'),'',
																   decode(e.CHCK_STTS_CD,'', decode(to_char(e.DSCH_PRRN_DT, 'yyyymmdd'), '', 'B', 'N'),
																						'N', decode(to_char(e.DSCH_PRRN_DT, 'YYYYMMDD'), '', 'B', 'N'),
																						'P', decode(nvl(e.MCRC_YN, 'N'), 'N', 'P', 'Z'),
																						e.CHCK_STTS_CD),
																   'T')  as CHCK_DVSN_CD /* 심사구분코드 */
					   ,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
					   ,  a.OPRT_SNO  as OPRT_SNO/* 수술순번 */
					   ,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
					   ,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
					   ,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
					   ,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
					   ,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												   from CCCMCDDMT F_A
													  , CCCMCDDLT F_B
												  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													and F_A.COMN_GRP_CD = 'MN909'
													and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
					   ,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
					   ,  n.USER_ID  as CHKR_NM      /* 원무-심사자ID */
					   ,  h.EXTS_TLNO  as CHKR_TLNO  /* 원무-심사자내선번 */
					   ,  decode(h.EXTS_TLNO,null,h.USER_NM,h.USER_NM||'('||h.EXTS_TLNO||')')  as CHKR_NM_1
					   ,  ''  as PACU_CHOT_PADV_CD      /* 회복실퇴실장소구분코드 */
					   ,  ''  as AFI_PACU_CHOT_PLAC_NM  /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
					   ,  ''  as AFI_PACU_CHOT_DT       /* 회복실퇴실일시 */
					   ,  (case when exists (select  'X'
											   from
													 MNSOPTEHT xx
												  ,  MNSOPTELT xy
											  where
													 xx.PTNO              = a.PTNO
												and  xx.OPRT_YMD          = a.OPRT_YMD
												and  xx.OPRT_SNO          = a.OPRT_SNO
												and  xx.PTNO              = xy.PTNO
												and  xx.OPRT_YMD          = xy.OPRT_YMD
												and  xx.OPRT_SNO          = xy.OPRT_SNO
												and  xx.OPBE_AFTR_DVSN_CD = 'B'
												and  xy.OPBE_WRTR_ID is not null
												and  (nvl(xx.TLRC_DVSN_CD,'X') <> '9' and nvl(xx.TLRC_DVSN_CD,'X') <> 'X')
												) then 'Y' else 'N' end)  as TLVI_YN_1 /* 수술이전방문여부 */
						,  (case when exists (select  'X'
												from
													  MNSOPTEHT xx
												   ,  MNSOPTELT xy
											   where
													  xx.PTNO              = a.PTNO
												 and  xx.OPRT_YMD          = a.OPRT_YMD
												 and  xx.OPRT_SNO          = a.OPRT_SNO
												 and  xx.PTNO              = xy.PTNO
												 and  xx.OPRT_YMD          = xy.OPRT_YMD
												 and  xx.OPRT_SNO          = xy.OPRT_SNO
												 and  xx.OPBE_AFTR_DVSN_CD = 'A'
												 and  xy.OPAF_WRTR_ID is not null
												 and  (nvl(xx.TLRC_DVSN_CD,'X') <> '9' and nvl(xx.TLRC_DVSN_CD,'X') <> 'X')
												 ) then 'Y' else 'N' end)  as TLVI_YN_2 /* 수술이후방문여부 */
					   ,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
					   ,  decode(a.ANSH_ID2,null,null,
							   ( select nvl(( select F_A.SMCR_YN
												from APDSDRDPT F_A
											   where F_A.MDDR_ID = a.ANSH_ID2
												 and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
					   ,  ''  as SMCR_YN /* 선택진료여부 */
					   ,  ''  as AFI_AGDC_PRIN_CTN /* (동의서출력/삭제(+/-)) */
					   ,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
					   ,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
					   ,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
					   , decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
					   , (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
					   ,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
					   ,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
					   ,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
					   ,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
					   ,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
					   ,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
					   ,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
					   ,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
					   ,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
					   ,  (select  aa.PTNT_TLNO
							 from  APPTCNPNV aa
							where  aa.PTNO = a.PTNO
							  and  aa.CNPN_DVSN_CD = '2'
							  and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
														   from APPTCNPNV bb
														  where bb.PTNO = a.PTNO
															and bb.CNPN_DVSN_CD = '2'
															and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
					   ,  (select TS_YN
							 from MDCAOPCDT aa
							where aa.MCDP_CD = a.ORDP_CD
							  and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
					   ,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
					   ,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
					   ,  (case when exists (select
							   'X'
						 from
							   MDOPSCHHT
						where  PTNO     = a.PTNO
						  and  OPRT_YMD = a.OPRT_YMD
						  and  OPRT_SNO = a.OPRT_SNO
						  and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
					   ,
					   (case when exists(select
											'X'
									  from
											MDOPSCHHT
									 where  PTNO     = a.PTNO
									   and  OPRT_YMD = a.OPRT_YMD
									   and  OPRT_SNO = a.OPRT_SNO
									   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
					   ,  ''  as AOR_PRRM_ENRM_DT                                                         /* 준비실 입실일시        */
					   , (case when exists (select 'X'
											 from MNSAONRMT xx
											where xx.PTNO       = a.PTNO
											  and xx.OPRT_YMD   = a.OPRT_YMD
											  and xx.OPRT_SNO   = a.OPRT_SNO
											  and xx.AOR_STRM_CHOT_BASE_DT is not null)  then 'Y' else 'N' end)  as AFI_AOR_CARC_WRTG_YN /* AOR 간호기록 작성여부 */
					   ,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT
					   , (
						 select  nvl(max('Y'), 'N')
						   from  MDTRTORDT x         /* 처방료처방TABLE  */
						  where
								 x.PTNO     = a.PTNO
							and  x.OPRT_YMD = a.OPRT_YMD
							and  x.OPRT_SNO = a.OPRT_SNO
							and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
					   )  as AFI_ANST_FEE_YN                      /* 마취료여부  */
					   ,
					   (
						 select  decode(count(*), 0, null
											  , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
						   from  MDMEDORDT z        /* 약처방TABLE */
						  where
								 z.PTNO = a.PTNO
							and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							and  z.OPRT_YMD = a.OPRT_YMD
							and  z.OPRT_SNO = a.OPRT_SNO
							and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
							--and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
					   )  as AFI_DRRT_CCT_CTN
					   , a.STRM_MVMN_YN as STRM_MVMN_YN                           /* 안정실이동여부 */
					   , (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
							   when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
					   , (select decode(count(a.PTNO),0,'','Y')
							from MDOPSCCOT aa
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN    /* 협진수술여부 */
					   , (select LISTAGG('['||aa.CPDP_CD||'] '||
											  bb.USER_NM||'('||
											  aa.CMTX_OPSR_ID1||') '||
											  aa.CMTX_OPRT_CSCR_NM, chr(13))
								 WITHIN group (order by CPDP_CD)
							from MDOPSCCOT aa
							   , CCUSRDPHT bb
						  where aa.PTNO     = a.PTNO
							and aa.OPRT_YMD = a.OPRT_YMD
							and aa.OPRT_SNO = a.OPRT_SNO
							and bb.USER_ID  = aa.CMTX_OPSR_ID1
						  group by
								aa.PTNO
							  , aa.OPRT_YMD
							  , aa.OPRT_SNO)  as CMTX_OPRT_NM     /* 협진수술명 */
					   , e.MDRP_NO  as MDRP_NO           /* 진료접수번호 */
		               , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					from
						  MDOPSCHET a /* 수술스케줄 */
					   ,  APPTPTNTV b /* 환자 */
					   ,  APRCRPTNT e /* 진료접수 */
					   ,  MNSOPNRMT g /* 수술간호기록 */
					   ,  CCUSERAMT z /* OCS로그인정보 */
					   ,  CCUSRDPHT m /* OCS사용자정보 */
					   ,  MNSAONRMT x /* AOR 간호기록 */
					   ,  MNSREREMT y /* 회복실기록 */
					   ,  CCUSERAMT h /* OCS로그인정보(원무-심사자정보용) */
					   ,  CCUSRDPHT n /* OCS사용자정보(원무-심사자정보용) */
					 --  ,  MNSOPMOVT j /* 환자이동정보 */
					   /*,  MNSAONRET l  안정실 - 교육 */
					   ,  MEANDOCMT i /* 마취기록 */               
				   where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					-- and  ( (a.OPPL_CD like nvl({opplCd},'D')||'%%') or a.OPPL_CD is null )
		             and a.CODV_CD = decode( #{opplCd}, 'D', 'D', a.CODV_CD )
					 and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
					 and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					 and  ((#{anshId} is null)
						  or
							(
							a.ANSH_ID1 = #{anshId} or
							a.ANSH_ID2 = #{anshId} or
							a.ANSH_ID3 = #{anshId}
							)
						  ) /* 마취의 */
					 and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					 and  (
							 (
								 (
									 nvl(#{codvCd1},'N') != 'Y' and
									 nvl(#{codvCd2},'N') != 'Y' and
									 nvl(#{codvCd3},'N') != 'Y' and
									 nvl(#{codvCd4},'N') != 'Y'
								 )
								 and
								 (1=1)
							 )
							or
							(#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							or
							(#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							or
							(#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							or
							(#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						  )
					 and  a.DFNT_YN = 'Y'
					 and  b.PTNO(+)= a.PTNO
					 and  e.PTNO(+)     = a.PTNO
					 and  e.CODV_CD(+)  = a.CODV_CD
					and ( ( e.CODV_CD(+) != 'D'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
					    or (   e.CODV_CD(+) = 'D' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd') ))
					 and  e.CNCL_DT(+) is null
					 and  (
							(
							  (
							  nvl(#{oprtSttsCd1},'N') != 'Y' and
							  nvl(#{oprtSttsCd2},'N') != 'Y' and
							  nvl(#{oprtSttsCd3},'N') != 'Y' and
							  nvl(#{oprtSttsCd4},'N') != 'Y' and
							  nvl(#{oprtSttsCd5},'N') != 'Y' and
							  nvl(#{oprtSttsCd6},'N') != 'Y'
							  ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A', 'B', 'C', 'D', '6', '7', '8', '9')
							)
							or
							(
								#{oprtSttsCd3} = 'Y'
								and
								(
								  (
									  (a.OPRT_STTS_CD = '6')
									  and
									  (a.PTNO in (select PTNO
													from MNSOPMOVT xx
												   where xx.PTNO         = a.PTNO
													 and xx.OPRT_YMD     = a.OPRT_YMD
													 and xx.OPRT_SNO     = a.OPRT_SNO
													 and xx.MVMN_PLAC_CD = 'F'
													 and xx.CHOT_DT is null))
								  )
								  or
								  (
									  a.PTNO in (select PTNO
												   from MNSOPMOVT xx
												  where xx.PTNO         = a.PTNO
													and xx.OPRT_YMD     = a.OPRT_YMD
													and xx.OPRT_SNO     = a.OPRT_SNO
													and xx.MVMN_PLAC_CD = 'F'
													and xx.CHOT_DT is not null
													and xx.CHOT_DT >= sysdate)
								  )
								)
							)
							or
							(#{oprtSttsCd4} = 'Y' and ((a.OPRT_STTS_CD = '8') and (to_char(e.DSCH_DT,'yyyymmdd') = '29991231')))
							or
							(#{oprtSttsCd5} = 'Y' and ((a.OPRT_STTS_CD = '8') and (to_char(e.DSCH_DT,'yyyymmdd') != '29991231')))
							or
							(#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9')
						  )
					 and  (
							(#{chckSttsCd} is null and 1=1)
							or
							(
							  (#{chckSttsCd} = 'B' and  (
																			 (e.CHCK_STTS_CD is null and e.DSCH_PRRN_DT is null)
																			 or
																			 (e.CHCK_STTS_CD = 'N' and e.DSCH_PRRN_DT is null)
																		   )
							  )
							  or
							  (#{chckSttsCd} = 'N' and  (
																			 (e.CHCK_STTS_CD is null and e.DSCH_PRRN_DT is not null)
																			 or
																			 (e.CHCK_STTS_CD = 'N' and e.DSCH_PRRN_DT is not null)
																		   )
							  )
							  or
							  (#{chckSttsCd} = 'P' and (e.CHCK_STTS_CD = 'P' and nvl(e.MCRC_YN,'N') = 'N'))
							  or
							  (#{chckSttsCd} = 'Z' and (e.CHCK_STTS_CD = 'P' and nvl(e.MCRC_YN,'N') != 'N'))
							  or
							  (#{chckSttsCd} = 'T' and (e.CHCK_STTS_CD = 'T'))
							)
						  )
					 and  n.USER_ID(+)  = e.MAIN_CHKR_ID
					 and  h.LGIN_ID(+)  = n.LGIN_ID
					 and  g.PTNO(+) = a.PTNO
					 and  g.OPRT_YMD(+)= a.OPRT_YMD
					 and  g.OPRT_SNO(+)= a.OPRT_SNO
					 and  m.USER_ID (+)= a.OPSR_ID1
					 and  z.LGIN_ID (+)= m.LGIN_ID
					 and  x.PTNO(+) = a.PTNO
					 and  x.OPRT_YMD(+)= a.OPRT_YMD
					 and  x.OPRT_SNO(+)= a.OPRT_SNO
					 and  y.PTNO(+) = a.PTNO
					 and  y.OPRT_YMD(+)= a.OPRT_YMD
					 and  y.OPRT_SNO(+)= a.OPRT_SNO
					-- and  j.PTNO = a.PTNO
					-- and  j.OPRT_YMD = a.OPRT_YMD
					-- and  j.OPRT_SNO = a.OPRT_SNO
					-- and  j.OPPL_DVSN_CD = 'D' /* AOR */
					 --and  j.MVMN_PLAC_CD = 'F' /* 안정실 */
					 and  i.PTNO(+) = a.PTNO
					 and  i.OPRT_YMD(+)= a.OPRT_YMD
					 and  i.OPRT_SNO(+)= a.OPRT_SNO
				   order  by
						  nvl(to_date(to_char(y.CHOT_YMD,'yyyymmdd')||y.CHOT_HM,'yyyymmddhh24mi'),a.OPRM_CHOT_DT) desc
					   ,  a.OPRM_CD
					   ,  a.OPST_PRRN_DT
					   ,  a.ORDP_CD
					   ,  a.OPSR_ID1
					   ,  a.OPRT_STTS_CD
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X9-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="ptno" column="PTNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="frrn" column="FRRN"/>
		<result property="ordpCd" column="ORDP_CD"/>
		<result property="afiAbrvOrdpCd" column="AFI_ABRV_ORDP_CD"/>
		<result property="afiAbrvWardCd" column="AFI_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="opsrId1" column="OPSR_ID_1"/>
		<result property="opsrId2" column="OPSR_ID_2"/>
		<result property="opsrId3" column="OPSR_ID_3"/>
		<result property="opsrIdNm1" column="OPSR_ID_NM_1"/>
		<result property="opsrIdNm2" column="OPSR_ID_NM_2"/>
		<result property="opsrIdNm3" column="OPSR_ID_NM_3"/>
		<result property="anshId1" column="ANSH_ID_1"/>
		<result property="anshNm1" column="ANSH_NM_1"/>
		<result property="anshId2" column="ANSH_ID_2"/>
		<result property="anshNm2" column="ANSH_NM_2"/>
		<result property="anshId3" column="ANSH_ID_3"/>
		<result property="anshNm3" column="ANSH_NM_3"/>
		<result property="afiOprmNm" column="AFI_OPRM_NM"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="opstPrrnDt1" column="OPST_PRRN_DT_1"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="oprtSttsCtn" column="OPRT_STTS_CTN"/>
		<result property="crtfYn" column="CRTF_YN"/>
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="ankiNm" column="ANKI_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="cscrCd" column="CSCR_CD"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="clncOprtNm" column="CLNC_OPRT_NM"/>
		<result property="oprmChotPadvCd" column="OPRM_CHOT_PADV_CD"/>
		<result property="afiChotPadvNm" column="AFI_CHOT_PADV_NM"/>
		<result property="afiOprtCarcWrtgYn" column="AFI_OPRT_CARC_WRTG_YN"/>
		<result property="afiCscrOrdrSttsNm" column="AFI_CSCR_ORDR_STTS_NM"/>
		<result property="erYn" column="ER_YN"/>
		<result property="afiErDvsnNm" column="AFI_ER_DVSN_NM"/>
		<result property="oprmEnrmDt" column="OPRM_ENRM_DT"/>
		<result property="afiOpsrCnpnCtn" column="AFI_OPSR_CNPN_CTN"/>
		<result property="impnCmntCtn" column="IMPN_CMNT_CTN"/>
		<result property="drgNm" column="DRG_NM"/>
		<result property="cpCd" column="CP_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="pcaYn" column="PCA_YN"/>
		<result property="cnclYn" column="CNCL_YN"/>
		<result property="anstRcrdItemDvsnCd" column="ANST_RCRD_ITEM_DVSN_CD"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="enrmDt" column="ENRM_DT"/>
		<result property="chotDt" column="CHOT_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="oprmCd" column="OPRM_CD"/>
		<result property="afiOpscCnreNm" column="AFI_OPSC_CNRE_NM"/>
		<result property="etcCnreCtn" column="ETC_CNRE_CTN"/>
		<result property="pacuChotPadvCd" column="PACU_CHOT_PADV_CD"/>
		<result property="afiPacuChotPlacNm" column="AFI_PACU_CHOT_PLAC_NM"/>
		<result property="afiPacuChotDt" column="AFI_PACU_CHOT_DT"/>
		<result property="afiSlctCtn" column="AFI_SLCT_CTN"/>
		<result property="afiEnfrCtn" column="AFI_ENFR_CTN"/>
		<result property="smcrYn" column="SMCR_YN"/>
		<result property="afiAgdcPrinCtn" column="AFI_AGDC_PRIN_CTN"/>
		<result property="afiAnshCnpnCtn" column="AFI_ANSH_CNPN_CTN"/>
		<result property="afiInfcSttsNm1" column="AFI_INFC_STTS_NM_1"/>
		<result property="afiInfcSttsNm2" column="AFI_INFC_STTS_NM_2"/>
		<result property="afiAnstRcrdWrtgYn" column="AFI_ANST_RCRD_WRTG_YN"/>
		<result property="afiAnstRcrdFnshYn" column="AFI_ANST_RCRD_FNSH_YN"/>
		<result property="afiPacuRcrdWrtgYn" column="AFI_PACU_RCRD_WRTG_YN"/>
		<result property="cnfrRegnArvlDt" column="CNFR_REGN_ARVL_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="anstDrvtDt" column="ANST_DRVT_DT"/>
		<result property="opstDt" column="OPST_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="dfntAftrMdfcYn" column="DFNT_AFTR_MDFC_YN"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="tsYn" column="TS_YN"/>
		<result property="strmLctnVl" column="STRM_LCTN_VL"/>
		<result property="afiCpInfmCtn" column="AFI_CP_INFM_CTN"/>
		<result property="afiOprtNmMdfcYn" column="AFI_OPRT_NM_MDFC_YN"/>
		<result property="afiImlnMdfcYn" column="AFI_IMLN_MDFC_YN"/>
		<result property="aorPrrmEnrmDt" column="AOR_PRRM_ENRM_DT"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="afiAnstFeeYn" column="AFI_ANST_FEE_YN"/>
		<result property="afiDrrtCctCtn" column="AFI_DRRT_CCT_CTN"/>
		<result property="strmMvmnYn" column="STRM_MVMN_YN"/>
		<result property="anstStrtDt1" column="ANST_STRT_DT_1"/>
		<result property="anstFnshDt1" column="ANST_FNSH_DT_1"/>
		<result property="frgnYn" column="FRGN_YN"/>
		<result property="cmtxOprtYn" column="CMTX_OPRT_YN"/>
		<result property="cmtxOprtNm" column="CMTX_OPRT_NM"/>
		<result property="oprtSafeCeckVl" column="OPRT_SAFE_CECK_VL"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="sbdpCd" column="SBDP_CD"/>
		<result property="dprmInrlOprtYn" column="DPRM_INRL_OPRT_YN"/>
		<result property="oncaYn" column="ONCA_YN"/>
		<result property="obsyOprtScrgYn" column="OBSY_OPRT_SCRG_YN"/>
		<result property="opbeDxCd2" column="OPBE_DX_CD_2"/>
		<result property="opbeDxNm2" column="OPBE_DX_NM_2"/>
		<result property="opbeDxCd3" column="OPBE_DX_CD_3"/>
		<result property="opbeDxNm3" column="OPBE_DX_NM_3"/>
		<result property="subOprtCd1" column="SUB_OPRT_CD_1"/>
		<result property="subOprtCdNm1" column="SUB_OPRT_CD_NM_1"/>
		<result property="subOprtCd2" column="SUB_OPRT_CD_2"/>
		<result property="subOprtCdNm2" column="SUB_OPRT_CD_NM_2"/>
		<result property="clncDxCd2" column="CLNC_DX_CD_2"/>
		<result property="clncDxNm2" column="CLNC_DX_NM_2"/>
		<result property="clncDxCd3" column="CLNC_DX_CD_3"/>
		<result property="clncDxNm3" column="CLNC_DX_NM_3"/>
		<result property="opsiCtn" column="OPSI_CTN"/>
		<result property="cscrCd1" column="CSCR_CD_1"/>
		<result property="cscrNm1" column="CSCR_NM_1"/>
		<result property="painMngmCntrViaYn" column="PAIN_MNGM_CNTR_VIA_YN"/>
		<result property="oprtRcrdYn" column="OPRT_RCRD_YN"/>
		<result property="oprtRfrcSbjcCtn" column="OPRT_RFRC_SBJC_CTN"/>
		<result property="opscUnslCtn" column="OPSC_UNSL_CTN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X9 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X9-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X9"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X9-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listMssOpschet1X9 */
		<![CDATA[
				   select  /*+ 수술환자선택-수술실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )  as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT = e.DSCH_DT
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(count(*),0,'N','Y')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.CRTF_YN      = 'Y'
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
																						 and  (xx.ATHN_ID is not null and xx.CRTF_DT >= nvl( xx.TMPR_SAVE_DT, to_date('18990101', 'yyyymmdd'))))))  as CRTF_YN /* 마취기록확정여부  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
						,  CSCR_NM as CSCR_NM             /* CaseCart명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  decode(a.OPRT_STTS_CD,'9','Y',decode(a.ANKI_CD,'02','Y',( /*20161107 decode(ENTPV_YN,'Y','Y' 삭제 */
																					select
																							decode(count(*),0,'N','Y')
																					  from  MEDOCMBST aa
																					 where
																							aa.PTNO           = a.PTNO
																					   and  aa.RCRD_DT       >= a.OPRT_YMD
																					   and  aa.RCRD_DT       <  a.OPRT_YMD + 1
																					   and  aa.BHVR_SNO       = a.OPRT_SNO
																					   and  (aa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_ANST_BEF_RCRD') /*마취전 환자방문기록 */
																					       or aa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_BEF_RCRD'))
																					   and  aa.RCRD_SAVE_DVSN_CD = '1')))  as ANST_RCRD_ITEM_DVSN_CD /* 마취기록구분항목코드 */
			   		,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  ''  as PACU_CHOT_PADV_CD      /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM  /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT       /* 회복실퇴실일시 */
						,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						, ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* 동의서 출력내용(동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT           /* 준비실 입실일시 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
					--		 and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN                      /* 약반납건수내용 */
						, a.STRM_MVMN_YN as STRM_MVMN_YN                           /* 안정실이동여부 */
						, to_char(i.ANST_STRT_DT,'yyyymmddhh24mi')  as ANST_STRT_DT_1 /* 수술시작예정일시 */
						, to_char(i.ANST_FNSH_DT,'yyyymmddhh24mi')  as ANST_FNSH_DT_1 /* 수술시작예정일시 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
						, (select LISTAGG('['||aa.CPDP_CD||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM           /* 협진수술명 */
						, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
				                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
				                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
						, e.MDRP_NO  as MDRP_NO /* 진료접수번호 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  (#{anshId} is null
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2', '3')) /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD)
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD !='O'
					and ( ( e.CODV_CD(+) != 'O' and e.CODV_CD(+) != 'H'
		                   and  e.MDCR_DT(+) <= to_date(#{oprtYmd},'yyyymmdd') + .99999
					       and  e.DSCH_DT(+) >= to_date(#{oprtYmd},'yyyymmdd')  )
					   )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
		union all
		select  /*+ 수술환자선택-수술실 환자조회 */
						   b.PTNT_NM as PTNT_NM                              /* 환자명 */
						,  a.PTNO as PTNO                                 /* 환자번호 */
						,  b.GEND_CD as GEND_CD                              /* 성별 */
						,  to_char(b.BTDT,'yyyymmdd')  as BTDT     /* 나이 */
						,  b.FRRN  as FRRN     /* 앞주민번호 */
						,  a.ORDP_CD as ORDP_CD
						,  decode(a.SBDP_CD, null
										   , ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.ORDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   ,
										   ( select
													F_A.ABRV_DPRT_CD
											   from
													HZDEPTMMT F_A
											  where
													F_A.DPRT_CD = a.SBDP_CD
											  group by
													F_A.ABRV_DPRT_CD )
										   )   as AFI_ABRV_ORDP_CD /* 약어집도과코드 */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
														 select  ( select F_A.ABRV_DPRT_CD from HZDEPTMMT F_A where F_A.DPRT_CD = bb.CARE_WARD_CD group by F_A.ABRV_DPRT_CD )
														   from  APRCRPTNT bb
														  where  bb.PTNO = e.PTNO
															and  bb.CODV_CD = 'I'
															and  bb.MDCR_DT = e.DSCH_DT
															and  bb.CNCL_DT is null),(select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD)) else ( select F_A.ABRV_DPRT_CD
																							  from HZDEPTMMT F_A
																							 where F_A.DPRT_CD = e.CARE_WARD_CD
																							 group by
																								   F_A.ABRV_DPRT_CD ) end)  as AFI_ABRV_WARD_CD  /* 간호약어병동코드  */
						,  (
						   case when e.CODV_CD = 'D' then nvl((
															 select  CARE_PTRM_NO
															   from  APRCRPTNT bb
															  where  bb.PTNO = e.PTNO
																and  bb.CODV_CD = 'I'
																and  bb.MDCR_DT = e.DSCH_DT
																and  bb.CNCL_DT is null),e.CARE_PTRM_NO) else e.CARE_PTRM_NO end)  as CARE_PTRM_NO  /* 간호병실번호  */
						,  a.OPSR_ID1 as OPSR_ID_1                                          /* 집도의사ID1 */
						,  a.OPSR_ID2 as OPSR_ID_2                                          /* 집도의사ID2 */
						,  a.OPSR_ID3 as OPSR_ID_3                                          /* 집도의사ID3 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID1 )  as OPSR_ID_NM_1  /* 집도의사명1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID2 )  as OPSR_ID_NM_2  /* 집도의사명2 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.OPSR_ID3 )  as OPSR_ID_NM_3  /* 집도의사명3 */
						,  a.ANSH_ID1  as ANSH_ID_1    /* 마취의사ID1 */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID1 )  as ANSH_NM_1    /* 마취의사명1 */
						,  a.ANSH_ID2  as ANSH_ID_2    /* 마취의사2ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID2)  as ANSH_NM_2    /* 마취의사명2 */
						,  a.ANSH_ID3  as ANSH_ID_3    /* 마취의사3ID  */
						,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ANSH_ID3 )  as ANSH_NM_3    /* 마취의사명3 */
						,  ( select f.MDCR_DTLS_CTRL_NM  from MZCTRLMMT f
		                      where  f.MDCR_CTRL_CD      = 'MM130'
					          and  f.MDCR_DTLS_CTRL_CD = a.OPRM_CD
		                      and rownum=1 )  as AFI_OPRM_NM                       /* AFI수술실명 */
						,  to_char(a.OPST_PRRN_DT,'yyyymmddhh24mi')  as OPST_PRRN_DT /* 수술시작예정일시 */
						,  to_char(a.OPST_PRRN_DT,'AM hh12:mi')  as OPST_PRRN_DT_1           /* 수술시작예정일시1 */
						,  a.OPRT_STTS_CD as OPRT_STTS_CD                                           /*수술상태코드 */
						,   (select cd.cd_nm from mnsopcdmt cd
										where cd.oprt_grp_cd = 'MSS_002'
										and cd.cd = a.OPRT_STTS_CD
		                                and cd.use_yn='Y' )    as OPRT_STTS_CTN /* 수술상태내용 */
						,  decode(a.OPRT_STTS_CD,'9',null,decode(a.ANKI_CD,'02',null,(select decode(count(*),0,'N','Y')
																						from MEDOCMBST xx
																					   where xx.PTNO         = a.PTNO
																						 and xx.RCRD_DT      = a.OPRT_YMD
																						 and xx.BHVR_SNO     = a.OPRT_SNO
																						 and xx.CRTF_YN      = 'Y'
																						 and xx.RCRD_LAST_YN = 'Y'
																						 and xx.RCKI_CD      = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_RCRD')
																						 and  (xx.ATHN_ID is not null and xx.CRTF_DT >= nvl( xx.TMPR_SAVE_DT, to_date('18990101', 'yyyymmdd'))))))  as CRTF_YN /* 마취기록확정여부  */
						,  a.ANKI_CD as ANKI_CD                                                   /* 마취종류코드 */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM081'
								and F_A.COMN_DTLS_CD =  a.ANKI_CD and F_B.LNGG_CD(+) = nvl('', '*') )  as ANKI_NM  /* 마취종류명   */
						,  a.CODV_CD as CODV_CD                                                   /* 내원구분코드 */
						,  decode(a.CODV_CD,'I','입원','O','외래','E','ER','D','통원','')  as CODV_NM /* 내원구분명 */
						,  CSCR_CD as CSCR_CD             /* CaseCart코드   */
						,  CSCR_NM as CSCR_NM             /* CaseCart명   */
						,  CLNC_OPRT_NM as CLNC_OPRT_NM        /* 임상수술명  */
						,  a.OPRM_CHOT_PADV_CD as OPRM_CHOT_PADV_CD /*수술실퇴실장소구분코드 */
						, (case when a.OPRT_STTS_CD in ('2','9') then ''
								when a.OPRT_STTS_CD = '4' then '대기실'
								when a.OPRT_STTS_CD in ('5','A','B','C','D') then '수술실'
								else ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
												from CCCMCDDMT F_A
												   , CCCMCDDLT F_B
											   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
												 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
												 and F_A.COMN_GRP_CD = 'MN488'
												 and F_A.COMN_DTLS_CD =  a.OPRM_CHOT_PADV_CD and F_B.LNGG_CD(+) = nvl('', '*') ) end)  as AFI_CHOT_PADV_NM /* 퇴실장소명 */
						,  decode(a.PTNO,g.PTNO,'Y','N')  as AFI_OPRT_CARC_WRTG_YN    /* 수술간호기록 작성여부 */
						,  decode(a.CSCR_ORDR_STTS_CD,'C','Y','N') || decode(a.CSCR_TMPR_ORDR_PRIN_YN,'Y','*','')  as AFI_CSCR_ORDR_STTS_NM /* CCR상태코드 */
						,  a.ER_YN as ER_YN /* 응급여부 */
						,  decode(a.ER_YN,'Y','응급','정규')  as AFI_ER_DVSN_NM /* 응급구분명 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as OPRM_ENRM_DT                       /* 수술실도착시간  */
						, (case when #{ocfmCd} = 'HAB' then '병동:'||FN_MN_PATWARDTELNO_S(e.MDRP_NO)
								else
								  (case when e.MDRP_NO is not null then '주:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																					 from CCUSERAMT a1
																					where a1.LGIN_ID = e.GNDR_ID)
										when e.MDRP_NO is null then '집:'||(select decode(substr(a1.CLNO,1,8),'010-9933','8-'||substr(a1.CLNO,10,4),a1.CLNO)
																				 from CCUSERAMT a1
																				where a1.LGIN_ID = a.OPSR_ID1) end)
								end)  as AFI_OPSR_CNPN_CTN     /* 집도의사연락처내용  */
						,  a.IMPN_CMNT_CTN as IMPN_CMNT_CTN /* 임플란트코멘트내용  */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM441'
								and F_A.COMN_DTLS_CD =  nvl(e.DR_DRG_NO , a.MDCR_DRG_NO)
								and F_B.LNGG_CD(+) = nvl('', '*') )  as DRG_NM /* DRG명  */
						,  a.CP_CD as CP_CD    /* CP코드  */
						,  e.MCDP_CD as MCDP_CD  /* 입원환자 진료과  */
						,  a.SCIN_NM as SCIN_NM  /* 상병명 */
						, (select 'Y'
						    from MDTRTORDT b
						   where b.PTNO = a.PTNO
						 	 and b.ORDR_YMD between trunc(a.OPRT_YMD, 'MM') and last_day(a.OPRT_YMD)
					 		 and nvl(b.DC_DVSN_CD, 'N') not in ('Y','X')
							 and b.ORCL_CD in ('OP1','NTR','MAT')
							 and b.ORDR_CLTY_CD in ('D1', 'D2')
							 and b.ORDR_CD in (select RFRN_CD from MNSOPCDMT where OPRT_GRP_CD = 'MSS_930')
							 and rownum = 1
						  ) as PCA_YN                 /* PCA여부 */
						,  nvl(a.CNCL_YN,'N')  as CNCL_YN /* 취소여부 */
						,  decode(a.OPRT_STTS_CD,'9','Y',decode(a.ANKI_CD,'02','Y',( /*20161107 decode(ENTPV_YN,'Y','Y' 삭제 */
																					select
																							decode(count(*),0,'N','Y')
																					  from  MEDOCMBST aa
																					 where
																							aa.PTNO           = a.PTNO
																					   and  aa.RCRD_DT       >= a.OPRT_YMD
																					   and  aa.RCRD_DT       <  a.OPRT_YMD + 1
																					   and  aa.BHVR_SNO       = a.OPRT_SNO
																					   and  (aa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_ANST_BEF_RCRD') /*마취전 환자방문기록 */
																					      or aa.RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'F_ANST_BEF_RCRD'))
																					   and  aa.RCRD_SAVE_DVSN_CD = '1')))  as ANST_RCRD_ITEM_DVSN_CD /* 마취기록구분항목코드 */
			   		,  a.OPRT_SNO as OPRT_SNO /* 수술순번 */
						,  to_char(a.OPRM_ENRM_DT,'yyyymmddhh24mi')  as ENRM_DT /* 환자 위치별 입실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as CHOT_DT /* 환자 위치별 퇴실일시 */
						,  to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi')  as OPRM_CHOT_DT /* 수술실 퇴실일시 */
						,  a.OPRM_CD as OPRM_CD                                                 /* 수술실코드  */
						,  a.OPSC_CNRE_CD||' '||( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
													from CCCMCDDMT F_A
													   , CCCMCDDLT F_B
												   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
													 and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
													 and F_A.COMN_GRP_CD = 'MN909'
													 and F_A.COMN_DTLS_CD = a.OPSC_CNRE_CD
													 and F_B.LNGG_CD(+) = nvl('', '*') )  as AFI_OPSC_CNRE_NM  /* AFI수술스케줄취소명 */
						,  a.ETC_CNRE_CTN as ETC_CNRE_CTN /* 기타취소내용 */
						,  ''  as PACU_CHOT_PADV_CD      /* 회복실퇴실장소구분코드 */
						,  ''  as AFI_PACU_CHOT_PLAC_NM  /* 회복실 퇴실장소명(회복실은 회복실 퇴실장소명을 display) */
						,  ''  as AFI_PACU_CHOT_DT       /* 회복실퇴실일시 */
						,  fn_ap_get_spcfg('MMOPSCET','',a.PTNO,e.MDCR_DT,a.CODV_CD,'2','',a.ANSH_ID2,'AN',a.OPRT_YMD,e.MDRP_NO)  as AFI_SLCT_CTN /* 선택내용(선택) */
						,  decode(a.ANSH_ID2,null,null,
								( select nvl(( select F_A.SMCR_YN
												 from APDSDRDPT F_A
												where F_A.MDDR_ID = a.ANSH_ID2
												  and trunc(a.OPRT_YMD) between F_A.APST_YMD and F_A.APFN_YMD ), 'E') from dual ))  as AFI_ENFR_CTN  /* 시행내용(시행) */
						,  ''  as SMCR_YN /* 선택진료여부 */
						,  ''  as AFI_AGDC_PRIN_CTN /* 동의서 출력내용(동의서출력/삭제(+/-)) */
						,  Fn_Mm_PdaNo_S(a.ANSH_ID1,a.ANSH_ID2,a.ANSH_ID3)  as AFI_ANSH_CNPN_CTN /* 마취의사연락처내용 */
						,  FN_QD_CAUTION_COLOR_VL(a.PTNO)  as AFI_INFC_STTS_NM_1                     /* AFI감염상태명1(감염COLOR) */
						,  FN_QD_CAUTION_COUNT(a.PTNO)  as AFI_INFC_STTS_NM_2                     /* AFI감염상태명2(감염COUNT) */
						, decode(a.PTNO,i.PTNO,'Y','N')  as AFI_ANST_RCRD_WRTG_YN  /* 마취기록작성여부  */
						, (case when i.ANST_FNSH_DT is not null then 'Y' else 'N' end)  as AFI_ANST_RCRD_FNSH_YN  /* 마취기록종료여부 */
						,  decode(a.PTNO,y.PTNO,'Y','N')  as AFI_PACU_RCRD_WRTG_YN            /*회복실기록지 작성여부 */
						,  ''  as CNFR_REGN_ARVL_DT                                           /* 확인지역 도착일시 */
						,  to_char(a.ANST_STRT_DT,'AM hh12:mi')  as ANST_STRT_DT /* 마취시작일시 */
						,  to_char(a.ANST_DRVT_DT,'AM hh12:mi')  as ANST_DRVT_DT /* 마취유도종료시간 */
						,  to_char(a.OPST_DT,'AM hh12:mi')  as OPST_DT /*  수술시작(절개시간) */
						,  to_char(a.SUTR_STRT_DT,'AM hh12:mi')  as SUTR_STRT_DT /* 봉합시작 */
						,  to_char(a.SUTR_FNSH_DT,'AM hh12:mi')  as SUTR_FNSH_DT /* 봉합완료 */
						,  to_char(a.OPRT_YMD,'yyyymmdd')  as OPRT_YMD /* 수술일자 */
						,  a.DFNT_AFTR_MDFC_YN as DFNT_AFTR_MDFC_YN                        /*확정후 변경여부 */
						,  (select  aa.PTNT_TLNO
							  from  APPTCNPNV aa
							 where  aa.PTNO = a.PTNO
							   and  aa.CNPN_DVSN_CD = '2'
							   and  aa.CNPN_SNO = (select max(bb.CNPN_SNO)
															from APPTCNPNV bb
														   where bb.PTNO = a.PTNO
															 and bb.CNPN_DVSN_CD = '2'
															 and bb.PTNT_TLNO is not null ))  as PTNT_TLNO /* 전화번호(휴대폰) */
						,  (select TS_YN
							  from MDCAOPCDT aa
							 where aa.MCDP_CD = a.ORDP_CD
							   and aa.CSCR_CD = a.CSCR_CD)  as TS_YN /* T&S */
						,  ''  as STRM_LCTN_VL               /* 안정실위치값 */
						,  FN_MD_GET_CPPAT_INFO(e.PTNO,e.MDRP_NO,to_char(a.OPRT_YMD,'yyyymmdd'),e.CODV_CD,e.MCDP_CD,e.MDDR_ID)  as AFI_CP_INFM_CTN /* CP정보내용 */
						,  (case when exists (select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(OPRT_NM,'N')  <> nvl(a.CSCR_NM,'N')) then 'Y' else 'N' end)  as AFI_OPRT_NM_MDFC_YN /* 수술명변경여부  */
						, (case when exists(select
								'X'
						  from
								MDOPSCHHT
						 where  PTNO     = a.PTNO
						   and  OPRT_YMD = a.OPRT_YMD
						   and  OPRT_SNO = a.OPRT_SNO
						   and  nvl(IMPN_CMNT_CTN,'N')  <> nvl(a.IMPN_CMNT_CTN,'N'))   then 'Y' else 'N' end)  as AFI_IMLN_MDFC_YN /* 임플란트내용 변경여부  */
						,  ''  as AOR_PRRM_ENRM_DT           /* 준비실 입실일시 */
						,  to_char(e.MDCR_DT,'yyyymmddhh24mi')  as MDCR_DT /* 진료일시 */
						, (
						  select  nvl(max('Y'), 'N')
							from  MDTRTORDT x         /* 처방료처방TABLE  */
						   where
								  x.PTNO     = a.PTNO
							 and  x.OPRT_YMD = a.OPRT_YMD
							 and  x.OPRT_SNO = a.OPRT_SNO
							 and  nvl(x.DC_DVSN_CD, 'N') = 'N'/* DC여부 */
							 and  x.ORDR_CLTY_CD = 'D4'       /* 처방분류유형코드 */
			   /*              and  x.CODV_CD = a.CODV_CD        내원구분코드 */
						)  as AFI_ANST_FEE_YN                      /* 마취료여부  */
						,
						(
						  select  decode(count(*), 0, null
											   , sum(decode(nvl(z.PHRM_RTRN_QTY,0), 0, 0, 1)) ||' '|| count(*))
							from  MDMEDORDT z        /* 약처방TABLE */
						   where
								  z.PTNO = a.PTNO
							 and  z.ORDR_YMD between a.OPRT_YMD and a.OPRT_YMD + 1
							 and  z.OPRT_YMD = a.OPRT_YMD
							 and  z.OPRT_SNO = a.OPRT_SNO
							 and  nvl(z.DC_DVSN_CD, 'N') = 'Y'     /* DC여부 */
							 and  z.CODV_CD = a.CODV_CD            /* 내원구분코드 */
					--		 and  z.OROC_CD in ('V','v','A','K','i')   /* 처방발생원코드 */
						)  as AFI_DRRT_CCT_CTN                      /* 약반납건수내용 */
						, a.STRM_MVMN_YN as STRM_MVMN_YN                           /* 안정실이동여부 */
						, to_char(i.ANST_STRT_DT,'yyyymmddhh24mi')  as ANST_STRT_DT_1 /* 수술시작예정일시 */
						, to_char(i.ANST_FNSH_DT,'yyyymmddhh24mi')  as ANST_FNSH_DT_1 /* 수술시작예정일시 */
						, (case when NTNL_CD = 'KR' or substr(BRRN,1,1) != '5' then 'N'
								when nvl(NTNL_CD,'') != 'KR' or substr(BRRN,1,1) = '5' then 'Y' end)  as FRGN_YN /* 외국인여부 */
						, (select decode(count(a.PTNO),0,'','Y')
							 from MDOPSCCOT aa
							where aa.PTNO     = a.PTNO
							  and aa.OPRT_YMD = a.OPRT_YMD
							  and aa.OPRT_SNO = a.OPRT_SNO)  as CMTX_OPRT_YN           /* 협진수술여부 */
						, (select LISTAGG('['||aa.CPDP_CD||'] '||
											   bb.USER_NM||'('||
											   aa.CMTX_OPSR_ID1||') '||
											   aa.CMTX_OPRT_CSCR_NM, chr(13))
								  WITHIN group (order by CPDP_CD)
							 from MDOPSCCOT aa
								, CCUSRDPHT bb
						   where aa.PTNO     = a.PTNO
							 and aa.OPRT_YMD = a.OPRT_YMD
							 and aa.OPRT_SNO = a.OPRT_SNO
							 and bb.USER_ID  = aa.CMTX_OPSR_ID1
						   group by
								 aa.PTNO
							   , aa.OPRT_YMD
							   , aa.OPRT_SNO)  as CMTX_OPRT_NM           /* 협진수술명 */
						, decode( (select c.ANST_BEF_CNFR_DT from MDOPSFCKT c
				                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno
				                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.OPRT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1) ,null,'N','Y')||
						  decode( (select c.CHOT_BEF_CNFR_DT from MDOPSFCKT c
						                 where a.ptno = c.ptno and a.oprt_ymd = c.oprt_ymd and a.oprt_sno = c.oprt_sno 
						                 and rownum=1),null,'N','Y')  as OPRT_SAFE_CECK_VL      /* 수술안전체크값(마취전/절개전/퇴실전) */	
						, e.MDRP_NO  as MDRP_NO /* 진료접수번호 */
		                , a.SBDP_CD as SBDP_CD
		                , a.DPRM_INRL_OPRT_YN as DPRM_INRL_OPRT_YN
		                , a.ONCA_YN as ONCA_YN
		                , a.OBSY_OPRT_SCRG_YN as OBSY_OPRT_SCRG_YN
		                , a.OPBE_DX_CD_2 as OPBE_DX_CD_2
		                , a.OPBE_DX_NM_2 as OPBE_DX_NM_2
		                , a.OPBE_DX_CD_3 as OPBE_DX_CD_3
		                , a.OPBE_DX_NM_3 as OPBE_DX_NM_3
		                , a.SUB_OPRT_CD_1 as SUB_OPRT_CD_1
		                , a.SUB_OPRT_CD_NM_1 as SUB_OPRT_CD_NM_1
		                , a.SUB_OPRT_CD_2 as SUB_OPRT_CD_2
		                , a.SUB_OPRT_CD_NM_2 as SUB_OPRT_CD_NM_2
		                , a.CLNC_DX_CD_2 as CLNC_DX_CD_2
		                , a.CLNC_DX_NM_2 as CLNC_DX_NM_2
		                , a.CLNC_DX_CD_3 as CLNC_DX_CD_3
		                , a.CLNC_DX_NM_3 as CLNC_DX_NM_3
		                , a.OPSI_CTN as OPSI_CTN /* 수술부위 */
		                , a.CSCR_CD_1 as CSCR_CD_1
		                , a.CSCR_NM_1 as CSCR_NM_1
		                , a.PAIN_MNGM_CNTR_VIA_YN as PAIN_MNGM_CNTR_VIA_YN
		 				, nvl((select decode(f.CRTF_YN, 'Y', 'C', f.OPRT_RCRD_YN) as OPRT_RCRD_YN
		 				        from (
		 				      		 select 'Y' as OPRT_RCRD_YN
		 				      		      , CRTF_YN
		 				      		   from MEDOCMBST
		 				      		  where 1=1
		 				      		    and PTNO = a.PTNO
		 				      		    and RCKI_CD = FN_CC_GET_CNST_VL('MED_002', 'S_OPRT_RCRD')   
		 				      		    and RCRD_DT between a.OPRT_YMD and a.OPRT_YMD + 0.99999
		 				      		    and BHVR_SNO = a.OPRT_SNO
		 				      		    and RCRD_LAST_YN = 'Y'
		 				      		    and ((ORGL_BLNG_MCDP_CD = a.ORDP_CD)
		 				      		        OR (ORGL_BLNG_MCDP_CD = (select HRAF_HGRN_DPRT_CD
		                                                               from HZDEPTMMT
		                                                              where DPRT_CD = a.ORDP_CD
		                                                                and rownum = 1)))
		 				      		    and RCRD_SAVE_DVSN_CD in ('1', '9')
		 				      		    and DLTN_YN = 'N'
		 				      		    and rownum = 1
		 				      		) f
		 				  ), 'N') as OPRT_RCRD_YN
		                , a.OPRT_RFRC_SBJC_CTN /* 수술 참고사항 */
		                , a.OPSC_UNSL_CTN /* 특이사항 = 마취과 전달사항 */
		                , to_char(a.FRST_RGST_DT,'yyyymmddhh24miss') as FRST_RGST_DT
					 from
						   MDOPSCHET a /* 수술스케줄 */
						,  APPTPTNTV b /* 환자 */
						,  APRCRPTNT e /* 진료접수 */
						,  MNSOPNRMT g /* 수술간호기록 */
						,  CCUSERAMT z /* OCS로그인정보 */
						,  CCUSRDPHT h /* OCS사용자정보 */
						,  MNSAONRMT x /* AOR 간호기록 */
						,  MNSREREMT y /* 회복실기록 */
						,  MEANDOCMT i /* 마취기록 */
					where
						   a.OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					  and  (#{ordpCd} is null or a.ORDP_CD  = #{ordpCd}) /* 집도과 */
					  and  (#{opsrId} is null or a.OPSR_ID1 = #{opsrId}) /* 집도의 */
					  and  (#{anshId} is null
						   or
							 (
							 a.ANSH_ID1 = #{anshId} or
							 a.ANSH_ID2 = #{anshId} or
							 a.ANSH_ID3 = #{anshId}
							 )
						   ) /* 마취의 */
					  and  (#{oprmCd} is null or a.OPRM_CD  = #{oprmCd}) /* 수술실 */
					  and  (
							  (
								  (
									  nvl(#{codvCd1},'N') != 'Y' and
									  nvl(#{codvCd2},'N') != 'Y' and
									  nvl(#{codvCd3},'N') != 'Y' and
									  nvl(#{codvCd4},'N') != 'Y'
								  )
								  and
								  (1=1)
							  )
							 or
							 (#{codvCd1} = 'Y' and a.CODV_CD = 'I')
							 or
							 (#{codvCd2} = 'Y' and a.CODV_CD = 'O')
							 or
							 (#{codvCd3} = 'Y' and a.CODV_CD = 'E')
							 or
							 (#{codvCd4} = 'Y' and a.CODV_CD = 'D')
						   )
					  and  a.DFNT_YN = 'Y'
					  and  (
							 (
							   (
							   nvl(#{oprtSttsCd1},'N') != 'Y' and /*미착 */
							   nvl(#{oprtSttsCd2},'N') != 'Y' and /*대기 */
							   nvl(#{oprtSttsCd3},'N') != 'Y' and /*진행 */
							   nvl(#{oprtSttsCd4},'N') != 'Y' and /*완료 */
							   nvl(#{oprtSttsCd5},'N') != 'Y' and /*퇴실 */
							   nvl(#{oprtSttsCd6},'N') != 'Y'     /*취소 */
							   ) and a.OPRT_STTS_CD in ('2', '3', '4', '5', 'A','B', 'C', 'D', '6', '7', '8', '9')
							 )
							 or
							 (#{oprtSttsCd1} = 'Y' and a.OPRT_STTS_CD in ('2', '3')) /*미착 -> 확정(2) */
							 or
							 (#{oprtSttsCd2} = 'Y' and a.OPRT_STTS_CD = '4') /*대기 -> 대기(4) */
							 or
							 (
							 #{oprtSttsCd3} = 'Y' and /*진행 */
							   (
								 (#{oprtSttsCd7}  = 'Y' and a.OPRT_STTS_CD = '5') /*입실 */
								 or
								 (#{oprtSttsCd8}  = 'Y' and a.OPRT_STTS_CD = 'A') /*마취(마취시작) */
								 or
								 (#{oprtSttsCd9}  = 'Y' and a.OPRT_STTS_CD = 'B') /*준비(마취종료) */
								 or
								 (#{oprtSttsCd10} = 'Y' and a.OPRT_STTS_CD = 'C') /*수술(절개시작) */
								 or
								 (#{oprtSttsCd11} = 'Y' and (a.OPRT_STTS_CD = 'D' and a.SUTR_FNSH_DT is null)) /*봉합(봉합시작이면서 수술상태는 D) */
							   )
							 )
							 or
							 (#{oprtSttsCd4} = 'Y' and a.OPRT_STTS_CD = '6' ) /*완료(수술완료:퇴실전) */
							 or
							 (#{oprtSttsCd5} = 'Y' and a.OPRT_STTS_CD = '7'  ) /*퇴실 */
							 or
							 (#{oprtSttsCd6} = 'Y' and a.OPRT_STTS_CD = '9') /*취소 -> 취소 */
						   )
					  and  b.PTNO(+)= a.PTNO
					  and  a.OPPL_CD = decode(#{oprmLctnCd},'E',#{opplCd},a.OPPL_CD)
					  and  e.PTNO(+)     = a.PTNO
					  and  e.CODV_CD(+)  = a.CODV_CD
		              and a.CODV_CD ='O'
					and (    e.CODV_CD(+) = 'O' and #{oprtYmd} = to_char(e.mdcr_dt (+),'yyyymmdd')   and a.ordp_cd = e.mcdp_cd (+) )
					  and  e.CNCL_DT(+) is null
					  and  g.PTNO(+) = a.PTNO
					  and  g.OPRT_YMD(+)= a.OPRT_YMD
					  and  g.OPRT_SNO(+)= a.OPRT_SNO
					  and  h.USER_ID (+)= a.OPSR_ID1
					  and  z.LGIN_ID (+)= h.LGIN_ID
					  and  x.PTNO(+) = a.PTNO
					  and  x.OPRT_YMD(+)= a.OPRT_YMD
					  and  x.OPRT_SNO(+)= a.OPRT_SNO
					  and  y.PTNO(+) = a.PTNO
					  and  y.OPRT_YMD(+)= a.OPRT_YMD
					  and  y.OPRT_SNO(+)= a.OPRT_SNO
					  and  i.PTNO(+) = a.PTNO
					  and  i.OPRT_YMD(+)= a.OPRT_YMD
					  and  i.OPRT_SNO(+)= a.OPRT_SNO
					order  by
						   OPRM_CD
						,  OPST_PRRN_DT
						,  ORDP_CD
						,  OPSR_ID_1
						,  OPRT_STTS_CD
					]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet6 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet6"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet6 */
		<![CDATA[
				   update  /*+ mdd_opschet_u06$U01_수술스케줄 확정후 변경 확인 */
						   MDOPSCHET x                                     /*  수술스케쥴 */
					 set
						  DFNT_AFTR_MDFC_YN = #{dfntAftrMdfcYn}
					   ,  DFNT_AFTR_MDFR_ID = decode(DFNT_AFTR_MDFR_ID, 'N', DFNT_AFTR_MDFR_ID, #{dfntAftrMdfrId})
					   ,  DFNT_AFTR_MDFC_DT = decode(#{dfntAftrMdfcYn}, 'N', DFNT_AFTR_MDFC_DT, sysdate)
					   ,  LAST_UPDR_ID = #{gvUserId}
					   ,  LAST_UPDT_IP = #{gvUserIp}
					   ,  LAST_UPDT_DT = sysdate
					   ,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
					   ,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
				   where
						  OPRT_YMD  = to_date(#{oprtYmd}, 'yyyymmdd')  /*  수술일자   */
					 and  PTNO      = #{ptno}                           /*  환자번호   */
					 and  OPRT_SNO  = to_number(#{oprtSno})            /*  수술순번   */
					 and  OPRT_STTS_CD in ('1', '2', '3', '4')                           /*  수술상태   */
					]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet1 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet1"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet1 */
		<![CDATA[
				   update  /*+ mdd_opschet_u01$U01_수술스케쥴 Case_Cart처방특기내용 수정 */
							 MDOPSCHET        /*  수술스케쥴             */
					  set    CSCR_ORDR_SPAB_CTN = #{cscrOrdrSpabCtn}            /*  Case_Cart처방특기내용 */
						   , CSCR_CD            = #{cscrCd}                       /*   Case_Cart코드          */
						   , CSCR_ORDR_STTS_CD  = #{cscrOrdrSttsCd}             /*  처방상태(CaseCart)     */
						   , CSCR_ORDR_UPDR_ID  = #{afcSrcUserId}                                  /*  처방수정자(CaseCart)   */
						   , CSCR_ORDR_UPDT_DT  = sysdate                                           /*  처방수정일시(CaseCart) */
						   /*  서버 프로그램 전환시 자동 추가된 항목 */
						   ,  LAST_UPDR_ID = #{gvUserId}
						   ,  LAST_UPDT_IP = #{gvUserIp}
						   ,  LAST_UPDT_DT = sysdate
						   ,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
						   ,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
					where
						   OPRT_YMD = to_date(#{oprtYmd}, 'yyyymmdd')  /*  수술일자     */
					  and  PTNO     = #{ptno}                           /*  환자번호     */
					  and  OPRT_SNO = #{oprtSno}                       /*  수술일련번호 */
					]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet4 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet4"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet4 */
		<![CDATA[
				   update  /*+ mdd_opschet_u04$U01_수술스케쥴 마취과 확인 수정 */  MDOPSCHET      /*  수술스케쥴           */
					  set
						   ANDP_CNFM_ID    = #{gvUserId}                /*  마취과확인자ID     */
						,  ANDP_CNFR_DT    = sysdate                         /*  마취과확인일시      */
						/*  서버 프로그램 전환시 자동 추가된 항목 */
						,  LAST_UPDR_ID = #{gvUserId}
						,  LAST_UPDT_IP = #{gvUserIp}
						,  LAST_UPDT_DT = sysdate
						,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
						,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
					where  OPRT_YMD  = to_date(#{oprtYmd}, 'yyyymmdd') /*  수술일자       */
					  and  PTNO      = #{ptno}                          /*  환자번호       */
					  and  OPRT_SNO  = #{oprtSno}                      /*  수술일련번호   */
					]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet15 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet15"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet15 */
		<![CDATA[
					   update /*+ mdd_opschet_u15$U01_수술스케줄 마취의정보 수정 */
							  MDOPSCHET a
						  set a.ANSH_ID1               =  #{anshId1}
						   ,  a.ANSH_ID2               =  #{anshId2}
						   ,  a.ANSH_ID3               =  #{anshId3}
						   ,  a.LAST_UPDR_ID           =  #{gvUserId}
						   ,  a.LAST_UPDT_IP           =  #{gvUserIp}
						   ,  a.LAST_UPDT_DT           =  sysdate
						   ,  a.LAST_UPDT_CLNT_PRGM_ID      =  #{gvClntPrgmId}
						   ,  a.LAST_UPDT_SRVR_PRGM_ID      =  #{gvSrvrPrgmId}
						where  10=10
						  and  a.OPRT_YMD   = to_date(#{oprtYmd}, 'yyyymmdd')
						  and  a.OPRM_CD    = #{oprmCd}
						  and  to_char(a.OPST_PRRN_DT,'hh24:mi:ss') between '00:00:00' and '11:59:59'  /*  오전 */
						  and  nvl(a.CNCL_YN,'N') = 'N'
						  and  a.ANKI_CD         != '02'
					]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet17 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet17"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet17 */
		<![CDATA[
						   update /*+ mdd_opschet_u17$U01_수술스케줄 마취의정보 수정 */
								  MDOPSCHET a
							  set a.ANSH_ID1               =  #{anshId1}
							   ,  a.ANSH_ID2               =  #{anshId2}
							   ,  a.ANSH_ID3               =  #{anshId3}
							   ,  a.LAST_UPDR_ID           =  #{gvUserId}
							   ,  a.LAST_UPDT_IP           =  #{gvUserIp}
							   ,  a.LAST_UPDT_DT           =  sysdate
							   ,  a.LAST_UPDT_CLNT_PRGM_ID      =  #{gvClntPrgmId}
							   ,  a.LAST_UPDT_SRVR_PRGM_ID      =  #{gvSrvrPrgmId}
							where  1=1
							  and  a.OPRT_YMD   = to_date(#{oprtYmd}, 'yyyymmdd')
							  and  a.OPRM_CD    = #{oprmCd}
							  and  to_char(a.OPST_PRRN_DT,'hh24:mi:ss') between '12:00:00' and '23:59:59'  /*  오후(PM) */
							  and  nvl(a.CNCL_YN,'N') = 'N'
							  and  a.ANKI_CD         != '02'
					]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet19-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ankiCd" column="ANKI_CD"/>
		<result property="oprtSttsCd" column="OPRT_STTS_CD"/>
		<result property="rganRcrdDt" column="RGAN_RCRD_DT"/>
		<result property="anstStrtDt" column="ANST_STRT_DT"/>
		<result property="sutrStrtDt" column="SUTR_STRT_DT"/>
		<result property="sutrFnshDt" column="SUTR_FNSH_DT"/>
		<result property="oprmChotDt" column="OPRM_CHOT_DT"/>
		<result property="afiPacuEnrmDt" column="AFI_PACU_ENRM_DT"/>
		<result property="strmArvlDt" column="STRM_ARVL_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet19 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet19-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet19"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet19-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet19 */
		<![CDATA[
				   select  /*+ mdd_opschet_s19$S01_연동전 수술시간정보 조회 */
						   a.ANKI_CD as ANKI_CD
						 , a.OPRT_STTS_CD as OPRT_STTS_CD
						 , to_char(a.RGAN_RCRD_DT,'yyyymmddhh24mi') as RGAN_RCRD_DT  /*  국소마취시작 */
						 , to_char(a.ANST_STRT_DT,'yyyymmddhh24mi') as ANST_STRT_DT  /*  수술시작 */
						 , to_char(a.SUTR_STRT_DT,'yyyymmddhh24mi') as SUTR_STRT_DT  /*  봉합시작 */
						 , to_char(a.SUTR_FNSH_DT,'yyyymmddhh24mi') as SUTR_FNSH_DT  /*  봉합종료(수술종료) */
						 , to_char(a.OPRM_CHOT_DT,'yyyymmddhh24mi') as OPRM_CHOT_DT  /*  수술실퇴실일시 */
						 , to_char(a.RCVY_ROM_ENRM_DT,'yyyymmddhh24mi') as AFI_PACU_ENRM_DT       /*  회복실 입실일시 */
						 , to_char(c.ENRM_DT,'yyyymmddhh24mi') as STRM_ARVL_DT       /*  안정실 입실일시 */
					   from
							MDOPSCHET a /*  수술스케줄 */
						  , MNSOPMOVT c /*  안정실 */
					   where
							a.PTNO               = #{ptno}
					   and  a.OPRT_YMD           = to_date(#{oprtYmd},'yyyymmdd')
					   and  a.OPRT_SNO           = #{oprtSno}
					   and  c.PTNO          (+)= a.PTNO
					   and  c.OPRT_YMD      (+)= a.OPRT_YMD
					   and  c.OPRT_SNO      (+)= a.OPRT_SNO
					   and  c.OPPL_DVSN_CD  (+)= 'D'
					   and  c.MVMN_PLAC_CD  (+)= 'F'
					]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet19 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet19"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-updateOpschet19 */
		<![CDATA[
				   update  /*+ mdd_opschet_u19$I01_마취기록지 입력시간-수술스케줄로 연동 */
						   MDOPSCHET
					   set
						   ANST_STRT_DT              = to_date(#{anstStrtDt},'yyyymmddhh24mi')          /*  마취시작일시 */
						 , ANST_STRT_DT_APLY_YN      = decode(#{anstStrtDt},null,null,'Y')              /*  마취시작적용여부 */
						 , ANST_DRVT_DT              = to_date(#{anstDrvtDt},'yyyymmddhh24mi')          /*  마취유도일시 */
						 , ANST_DRVT_FNSH_DT_APLY_YN = decode(#{anstDrvtDt},null,null,'Y')              /*  마취유도종료일시적용여부 */
						 , OPST_DT                   = DECODE( (select RFRN_CD from MNSOPCDMT
																			where OPRT_GRP_CD = 'MEA_001'
																			and CD ='OPST_YN') , 'Y',  (case when (RGAN_RCRD_DT is not null and OPST_DT is not null) then OPST_DT            /*  수술시작일시 */
															 else to_date(#{opstDt},'yyyymmddhh24mi') end)
		                                                            , 'N', OPST_DT, OPST_DT)
						 , OPST_DT_APLY_YN           = (case when (RGAN_RCRD_DT is not null and OPST_DT is not null) then OPST_DT_APLY_YN    /*  수술시작일시적용여부 */
															 else decode(#{opstDt},null,null,'Y') end)
		                 , SUTR_FNSH_DT = DECODE( (select RFRN_CD from MNSOPCDMT
																			where OPRT_GRP_CD = 'MEA_001'
																			and CD ='OPFN_YN') , 'Y',  (case when (RGAN_RCRD_DT is not null and SUTR_FNSH_DT is not null) then SUTR_FNSH_DT            /*  봉합종료(수술종료)일시 */
															 else to_date(#{opfnDt},'yyyymmddhh24mi') end)
		                                                        , 'N', SUTR_FNSH_DT, SUTR_FNSH_DT)  
		                 , ANST_FNSH_DT =to_date( #{anstFnshDt},'yyyymmddhh24mi')    /*  마취종료일시 */
						 , OPRT_STTS_CD              =  #{oprtSttsCd}
						 ,  LAST_UPDR_ID             = #{gvUserId}           /*  최종수정자ID                  */
						 ,  LAST_UPDT_IP             = #{gvUserIp}                /*  최종수정IP                    */
						 ,  LAST_UPDT_DT             = sysdate                    /*  최종수정일시                     */
						 ,  LAST_UPDT_CLNT_PRGM_ID        = #{gvClntPrgmId}               /*  최종수정SMC클라이언트프로그램ID */
						 ,  LAST_UPDT_SRVR_PRGM_ID        = #{gvSrvrPrgmId}               /*  최종수정SMC서버프로그램ID */
					   where
						   PTNO     = #{ptno}
					   and  OPRT_YMD = to_date(#{oprtYmd},'yyyymmdd')
					   and  OPRT_SNO = #{oprtSno}
					]]>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet40-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="codvNm" column="CODV_NM"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ntm" column="NTM"/>
		<result property="ddcn" column="DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet40 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet40-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet40"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet40-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-selectOneOpschet40 */
		<![CDATA[
			 with t as 
				(   select  /*+ mdd_opschet_s40$S01_특정 처방내역(wafarin등) 조회 */
						   to_char(a.ORDR_YMD, 'yyyymmdd') as ORDR_YMD   /*  처방일자             */
						,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
							   from CCCMCDDMT F_A
								  , CCCMCDDLT F_B
							  where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
								and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
								and F_A.COMN_GRP_CD = 'MM262'
								and F_A.COMN_DTLS_CD =  a.CODV_CD
								and F_B.LNGG_CD(+) = nvl('', '*') ) as CODV_NM    /*  환자구분             */
						,  to_char(c.MDCR_DT, 'yyyymmddhh24mi') as MDCR_DT    /*  진료/입원/수술(DSC)/응급실도착일시 */
						,  a.MCDP_CD as MCDP_CD                                          /*  진료과               */
						,  a.WARD_CD as WARD_CD                                          /*  병동                 */
						,  a.ORDR_CD as ORDR_CD                                          /*  처방코드             */
						,  a.NTM as NTM                                              /*  횟수                 */
						,  a.DDCN as DDCN                                             /*  일수                 */
						,  a.DRUS_CD as DRUS_CD                                          /*  용법코드             */
						,  b.ORDR_NM as ORDR_NM                                        /*  처방명               */
					 from
						   MDMEDORDT a                               /*  약처방               */
						,  MDORDRCMT b                               /*  약처방마스터         */
						,  APRCRPTNT c
					where  a.PTNO = #{ptno}             /*  환자번호             */
					  and  ( a.ORDR_CD in ( select x.CD from MNSOPCDMT x
		                                             where   OPRT_GRP_CD = 'MSS_041'
		                                                   and USE_YN = 'Y' )      /*  처방코드             */
		                    or a.ORDR_CD in (  select phrm_dtls_ctrl_cd from SDMCTRLMT
		                                       where phrm_ctrl_cd in ( select x.rfrn_cd from MNSOPCDMT x
		                                             where   OPRT_GRP_CD = 'MSS_041'
		                                                   and CD = 'SD_CODE'
		                                                   and USE_YN = 'Y')
		                                     and nvl(fnsh_yn,'N')='N') )
					  and  a.ORDR_YMD >= to_date(#{oprtYmd}, 'YYYYMMDD') - 365
					  and  a.ORDR_YMD <= to_date(#{oprtYmd}, 'YYYYMMDD')              /*  처방일자 (1년간)    */
					  and  nvl(a.DC_DVSN_CD, 'N') not in ('X')                                               /*  삭제가 아닌 처방     */
					  and  nvl(a.ORFR_CD, '*') != 'P'
					  and  b.ORDR_CD = a.ORDR_CD                                                           /*  PRN이 아닌 처방      */
					  and  c.PTNO    = a.PTNO
					  and  c.MDRP_NO = a.MDRP_NO
		        order by ORDR_YMD desc )
		select * from t where rownum < 2
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listOpschet41-result" type="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="oprtYmd" column="OPRT_YMD"/>
		<result property="oprtSno" column="OPRT_SNO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntAgeVl" column="PTNT_AGE_VL"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="reOprtYn" column="RE_OPRT_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listOpschet41 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO
		resultMap : com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listOpschet41-result
    -->
	<select id="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listOpschet41"  parameterType="com.sds.healthcare.ehr.med.ms.mss.vo.MssOpschetDVO"  resultMap="com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listOpschet41-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-ms-mss-dao-MssOpschetDAO-listOpschet41 */
		<![CDATA[
		select  /*+ mdd_opschet_l41$S01_마약수불관리 수술환자목록 조회 DAM */
		            a.PTNO              /* 환자번호 */
		         ,  b.PTNT_NM           /* 환자명 */
		         ,  to_char(a.OPRT_YMD,'yyyymmdd') OPRT_YMD
		         ,  a.OPRT_SNO          /* 수술일련번호 */
		         ,  b.GEND_CD           /* 성별코드 */
		         ,  pa_cc_codmge.fn_cc_calc_age(to_char(b.BTDT,'yyyymmdd'), '00', sysdate) as PTNT_AGE_VL /* 환자연령값 */
		         ,  to_char(a.OPST_PRRN_DT,'AM HH12:MI')  as OPST_PRRN_DT   /* 수술시작예정일시 */
		         ,  a.CSCR_NM           /* Case_Cart명 */
		         ,  (select 'Y' from MDOPSCHET s1
								where s1.PTNO = a.PTNO
								  and s1.OPRT_YMD = a.OPRT_YMD
								  and s1.OPRT_SNO < a.OPRT_SNO
								  and s1.OPRT_STTS_CD not in ('1' ,'9')
								  and nvl(s1.CNCL_YN, 'N') = 'N'
								  and s1.ANKI_CD          != '02'
								  and nvl(a.ER_YN, 'N') = 'Y'    /* 대상수술이 응급인 경우만(당일 재수술을 하려면 응급이어야 함) */
								  and rownum = 1)    as RE_OPRT_YN   /* 당일재수술여부(100% 정확하지는 않음) */
		      from  MDOPSCHET a -- 수술스케줄
		         ,  APPTPTNTT b -- 환자
		     where  1=1
		       and  a.OPRT_YMD          = to_date(#{oprtYmd}, 'yyyymmdd')
		       and  a.OPRM_CD           = #{oprmCd}
		       and  a.OPRT_STTS_CD      not in ('1' ,'9')
		       and  a.PTNO              = nvl(#{ptno}, a.PTNO)
		       and  case
		              when #{oprtSno} = 0             then 'TRUE'
		              when a.OPRT_SNO = #{oprtSno}    then 'TRUE'
		              else 'FALSE'
		            end = 'TRUE'
		       and  nvl(a.CNCL_YN, 'N') = 'N'
		       and  a.ANKI_CD          != '02'
		       and  b.PTNO              = a.PTNO
		     order
		        by  a.OPST_PRRN_DT
		]]>
	</select>



</mapper>