<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : mapper_SdpCmmdDetlComnDAO_sql.xml 
    Description :                                      SdpCmmdDetlComnDAO 클래스
                  -->
<mapper namespace="SdpCmmdDetlComnDAO">




    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCmmdDetlOtptRtrnYn (처방조제상세 외래반납여부) 
        Description :                                           처방조제상세 외래반납여부
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<update id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCmmdDetlOtptRtrnYn"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		      /*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCmmdDetlOtptRtrnYn*/
				<![CDATA[
				   update  /*+ sdd_porddet_u08$I01_처방조제상세 외래반납여부 수정처리 */
			   SDPORDDET
		  set
			   OHOR_RTRN_YN = 'Y'
			,  LAST_UPDR_ID = #{gvUserId}
			,  LAST_UPDT_IP = #{gvUserIp}
			,  LAST_UPDT_DT = sysdate
			,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
			,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
		where  ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		  and  MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		  and  MDTN_NO = #{mdtnNo}
		  and  SDPF_EXRE_CD is null
		  and  MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, MDTN_LCDV_CD, 'A', MDTN_LCDV_CD, #{mdtnLcdvCd})
		]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCmmdDetlOhprRtrnIntz (처방조제상세 원외처방전반납 초기화) 
        Description :                                           처방조제상세 원외처방전반납 초기화
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<update id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCmmdDetlOhprRtrnIntz"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		      /*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCmmdDetlOhprRtrnIntz*/
				<![CDATA[
				   update  /*+ sdd_porddet_u09$I01_처방조제상세 원외처방전반납 초기화처리 */
			   SDPORDDET
		  set
			   OHOR_RTRN_YN = null
			,  LAST_UPDR_ID = #{gvUserId}
			,  LAST_UPDT_IP = #{gvUserIp}
			,  LAST_UPDT_DT = sysdate
			,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
			,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
		where  ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		  and  MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		  and  MDTN_NO = #{mdtnNo}
		  and  SDPF_EXRE_CD is null
		  and  MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, MDTN_LCDV_CD, 'A', MDTN_LCDV_CD, #{mdtnLcdvCd})
		]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateInjcPlacCd (주사장소코드) 
        Description :                                           주사장소코드
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<update id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateInjcPlacCd"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		      /*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateInjcPlacCd*/
				<![CDATA[
				   update /*+ sdd_porddet_u37$I01_주사장소코드 수정 */
			  SDPORDDET   a
		  set INJC_PLAC_CD = #{injcPlacCd}
		]]>
			<if test='oslfAdmnDrugYn != null and oslfAdmnDrugYn != ""'>
		    , OSLF_ADMN_DRUG_YN = #{oslfAdmnDrugYn}
			</if>
			<if test='inqrDvsnCd != null and inqrDvsnCd == "2"'>
			, RCPC_PNTM_CMMD_STTS_MDFC_YN = decode(RCPC_PNTM_CMMD_STTS_MDFC_YN  , 'Y' , #{oslfAdmnDrugYn} , 'N' , #{oslfAdmnDrugYn} , RCPC_PNTM_CMMD_STTS_MDFC_YN )
			</if>
		<![CDATA[
		where
			  a.ptno     = #{ptno}
		  and a.ordr_ymd = to_date(#{ordrYmd} , 'yyyymmdd' )
		  and a.ordr_sno = #{ordrSno}
		]]>
			<if test='oslfAdmnDrugYn != null and oslfAdmnDrugYn == "Y"'>
		  and a.RCPC_YN = 'N'
			</if>
		<![CDATA[
		  and a.cmmd_stts_cd <  '2'
		]]>
	</update>





   <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-executeAudtRslt () 
        Description : 
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-executeAudtRslt"  statementType="CALLABLE"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-executeAudtRslt */
		 <![CDATA[
		 { call SP_SD_SDAUDRPT_M (
					#{audtRsltCd, mode=IN, jdbcType=VARCHAR, javaType=String},
					#{audtPrgmId, mode=IN, jdbcType=VARCHAR, javaType=String},
					to_date(#{ordrYmd, mode=IN, jdbcType=VARCHAR, javaType=String}, 'YYYYMMDD'),
					to_date(#{ordrYmd1, mode=IN, jdbcType=VARCHAR, javaType=String}, 'YYYYMMDD'),
					#{mdtnLcdvCd, mode=IN, jdbcType=VARCHAR, javaType=String},
					#{wrtgLmttHh, mode=IN, jdbcType=NUMERIC, javaType=java.math.BigDecimal},
					#{nmbrVl, mode=INOUT, jdbcType=NUMERIC, javaType=java.math.BigDecimal},
					#{fnshYn, mode=INOUT, jdbcType=VARCHAR, javaType=String},
					#{erroryn, mode=INOUT, jdbcType=VARCHAR, javaType=String},
					#{sqlcode, mode=INOUT, jdbcType=VARCHAR, javaType=String},
					#{sqlerrm, mode=INOUT, jdbcType=VARCHAR, javaType=String}
														)}
		 ]]>
	</select>	

	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMdtnNoOut-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMdtnNoOut (외래라벨 출력) 
        Description :                                           외래라벨 출력
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMdtnNoOut-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMdtnNoOut"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMdtnNoOut-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMdtnNoOut */
		<![CDATA[
		  select  /*+ sdd_pordbat_l85$S01_외래라벨 출력 */
		           distinct
		            a.MDTN_NO
		         ,  a.MDTN_NO_DVSN_CD
		      from  SDPORDBAT a
		            ,  SDPORDDET c
		     where  a.ORDR_YMD      = to_date( #{ordrYmd} , 'YYYYMMDD')
		       and  a.DRUG_INJC_DVSN_CD in ('1', '2')
		       and  a.PTNO         = nvl( #{ptno} , '')
		       and  a.MDTN_NO_DVSN_CD in ('O', 'T')
		       and  a.MDTN_NO <> #{mdtnNo}
		       and  a.MDTN_LCDV_CD = decode( #{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )
		       and  a.ORDR_YMD = c.ORDR_YMD
		       and  a.MDTN_NO_DVSN_CD = c.MDTN_NO_DVSN_CD
		       and  a.MDTN_NO = c.MDTN_NO
		       and  a.MDTN_LCDV_CD= c.MDTN_LCDV_CD
		       and  c.CMMD_STTS_CD < 5
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listCmmdLblOut-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="scinClncDxNm" column="SCIN_CLNC_DX_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="pcknUnadQty1" column="PCKN_UNAD_QTY_1"/>
		<result property="invnPcunCd1" column="INVN_PCUN_CD_1"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="afiDrusCd" column="AFI_DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="afiNrdrCct" column="AFI_NRDR_CCT"/>
		<result property="cancPtntTypeCd" column="CANC_PTNT_TYPE_CD"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="nextMdcrYmd" column="NEXT_MDCR_YMD"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="tkmdCcfeYn" column="TKMD_CCFE_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="prinPageNo" column="PRIN_PAGE_NO"/>
		<result property="totlPageCnt" column="TOTL_PAGE_CNT"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mrnnTkngYn" column="MRNN_TKNG_YN"/>
		<result property="lnchTkngYn" column="LNCH_TKNG_YN"/>
		<result property="evnnTkngYn" column="EVNN_TKNG_YN"/>
		<result property="slepBefrTkngYn" column="SLEP_BEFR_TKNG_YN"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="abrvDprtCd2" column="ABRV_DPRT_CD_2"/>
		<result property="careMpngClsfNm" column="CARE_MPNG_CLSF_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="totlQtyClclYn" column="TOTL_QTY_CLCL_YN"/>
		<result property="drugDlvyDprtCd" column="DRUG_DLVY_DPRT_CD"/>
		<result property="oslfAdmnDrugYn" column="OSLF_ADMN_DRUG_YN"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listCmmdLblOut (외래라벨 출력) 
        Description :                                           외래라벨 출력
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listCmmdLblOut-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listCmmdLblOut"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listCmmdLblOut-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listCmmdLblOut */
		<![CDATA[
		select  /*+ sdd_pordbat_l84$S01_외래라벨 출력 */
		            to_char(a.ORDR_YMD, 'yyyymmdd')       ORDR_YMD                                  /* 처방일자     */
		         ,  decode(a.CMMD_PRSR_YN, 'Y', 'P', 'C', 'C', 'T', 'V', a.MDTN_NO_DVSN_CD)  MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  a.MDTN_NO                                                               /* 투약번호     */
		         ,  (
		                select  /*+ ordered use_nl(y z)      */
		                        nvl(max(z.MDTN_NO), 0)  MDTN_NO
		                  from
		                        SDPORDBAT y
		                     ,  SDPORDDET z
		                 where  y.ORDR_YMD         = a.ORDR_YMD
		                   and  y.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		                   and  y.PTNO             = a.PTNO
		                   and  y.MDTN_NO          < a.MDTN_NO
		                   and  y.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		                   and  y.MCDP_CD          = a.MCDP_CD
		                   and  y.PHDP_OROC_DPRT_CD  = a.PHDP_OROC_DPRT_CD
		                   and  y.GNDR_ID          = a.GNDR_ID
		                   and  y.CMMD_CMBN_CTN is not null
		                   and  y.MDTN_NO >   (
		                                select
		                                        nvl(max(v.MDTN_NO), 0)  MDTN_NO
		                                  from
		                                        SDPORDBAT v
		                                 where  v.ORDR_YMD        = y.ORDR_YMD
		                                   and  v.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                                   and  v.PTNO    = y.PTNO
		                                   and  v.MCDP_CD = y.MCDP_CD
		                                   and  v.PHDP_OROC_DPRT_CD = y.PHDP_OROC_DPRT_CD
		                                   and  v.GNDR_ID = y.GNDR_ID
		                                   and  v.DRUG_PRSS_CD > '0'
		                                   and  v.DRUG_INJC_DVSN_CD in ('1', '2')
		                                   and  v.MDTN_NO < a.MDTN_NO
		                                   and  v.RCPC_YN = 'Y'
		                         )
		                   and  z.ORDR_YMD        = y.ORDR_YMD
		                   and  z.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                   and  z.MDTN_NO         = y.MDTN_NO
		                   and  z.MDTN_LCDV_CD    = y.MDTN_LCDV_CD
		                   and  instr( #{afiBsisCmmdPlacNm} , z.BSIS_CMMD_PLAC_CD) > 0
		                   and  z.PRIN_DT is not null
		             )       BEMD_NO                                      /* 수정전번호   */
		         ,  a.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  to_char(d.BTDT,'yyyymmdd') as BTDT                    /* 생일         */
		         ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'-'||trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12))   AFI_AGE_VL_STR    /* 나이 */
		         ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)    as BDWG_VL      /* 몸무게 */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		         /* ,  (select nvl(ABRV_DPRT_CD,a.MCDP_CD) from HZDEPTMMT where DPRT_CD(+)=a.MCDP_CD) MCDP_CD */
		         ,  a.MCDP_CD                           as MCDP_CD        /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  a.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                           /* 처방의명     */
		         ,  (
		                select
		                        x.SCIN_CD||'('||x.SCIN_NM||')'
		                  from
		                        MDPADIAGT x
		                 where  x.MDRP_NO = b.MDRP_NO
		                   and  (
		                             (a.MDTN_NO_DVSN_CD in ('G', 'H', 'I'))           /* 응급실 재실퇴원 */
		                          or
		                             (a.MDTN_NO_DVSN_CD in ('S', 'T'))              /* 낮병동재실퇴실 */
		                          or
		                             (a.MDTN_NO_DVSN_CD in ('D', 'F', 'P', 'Q')) /* 병동 퇴원 */
		                          or
		                             (a.MDTN_NO_DVSN_CD in ('O', 'Z') and  x.MCDP_CD = a.MCDP_CD) /* 외래 */
		                        )
		                   and  x.MAIN_SCIN_YN = 'Y'
		                   and  a.GNDR_ID  = decode( sign( a.MDCR_YMD - to_date(  #{baseYmd}, 'yyyymmdd'))
		                                             , -1 , a.GNDR_ID
		                                             , decode( a.PTDV_CD, 'O', x.CHDR_ID , a.GNDR_ID)
		                                            )           /* MultiMainDiag  */
		                   and  rownum < 2
		             )      SCIN_CLNC_DX_NM                                /* 상병명       */
		         ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		         ,  (
		                select
		                        decode(count(x.MDPR_CD), 1, 'Y', 'N')
		                  from
		                        SDPORDDET x
		                 where  x.ORDR_YMD        = a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_NO         = a.MDTN_NO
		                   and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                   and  x.MDPR_CD         = b.MDPR_CD
		                   and  instr(#{afiBsisCmmdPlacNm} , x.BSIS_CMMD_PLAC_CD) > 0
		                   and  x.MDPR_CLSF_CD = '3'
		                   and  rownum < 2
		             )     NRDR_YN                                   /* 마약포함여부 */
		         ,  (
		            select
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO         = a.MDTN_NO
		               and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		               and  x.MDPR_CD         = b.MDPR_CD
		               and  instr(#{afiBsisCmmdPlacNm} , x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '2'
		               and  rownum < 2
		            )    PSDG_YN                                     /* 향정포함여부 */
		         ,  (
		            select  /*+ ordered use_nl(x y)     */
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		                 ,  SDDDGCDMT y
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO         = a.MDTN_NO
		               and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		               and  x.MDPR_CD         = b.MDPR_CD
		               and  instr(#{afiBsisCmmdPlacNm} , x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '3'
		               and  y.MDPR_CD = x.MDPR_CD
		               and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		               and  rownum < 2
		             )     CLNC_YN                                     /* 임상포함여부 */
		         ,  a.TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  b.ORDR_SNO                                         /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                          /* 약품코드     */
		         ,  f.MDPR_NM                                          /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  f.ICUN_CD                                          /* 함량단위     */
		         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		         , (case when b.SLCT_UNIT_DVSN_CD = '1' then b.PCKN_UNAD_QTY  -- 포장단위투여량
		                 else b.ICUN_ADMN_VLM  -- 함량단위투여용량
		            end) as PCKN_UNAD_QTY_1
		         , (case when b.SLCT_UNIT_DVSN_CD = '1' then b.PCUN_NM  -- 포장단위명
		                 else b.ICUN_CD  -- 함량단위코드
		            end) as INVN_PCUN_CD_1
		         ,  b.MDNT                                             /* 횟수         */
		         ,  b.MDTN_DDCN                                        /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
		         ,  b.DRUS_CD
		         ,  FN_SD_GET_DRUS_CD(b.DRUS_CD,b.BSIS_CMMD_PLAC_CD,b.ORDR_YMD,a.PTNO,b.ORDR_SNO)      AFI_DRUS_CD                                        /* 용법         */
		--               ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		--                                                                                            , '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                                            , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                                            , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                                            , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		--                                        , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		--                                                                                              , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN1    /* 용법Text1 */
		         ,  g.ENVL_MEMO_CTN1     ENVL_MEMO_CTN1    /* 용법Text1 */
		--               ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		--                                                                              , '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정' )
		--                                                                              , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		--                                        , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		--                                                                              , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		--                                                                                                , ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN2   /* 용법Text2 */
		         ,  g.ENVL_MEMO_CTN2     ENVL_MEMO_CTN2   /* 용법Text2 */
		--               ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		--                                            , '2', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		--                                            , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		--                                            , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 /* 용법Text3    */
		         ,  g.ENVL_MEMO_CTN3     ENVL_MEMO_CTN3 /* 용법Text3    */
		--               ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		--                                            , '2', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		--                                            , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		--                                            , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4 /* 용법Text4    */
		         ,  g.ENVL_MEMO_CTN4     ENVL_MEMO_CTN4 /* 용법Text4    */
		         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(fn_sd_isnumber_s(b.SPSB_CTN), chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                        /* 보관장소     */
		         ,  i.DETL_CD_NM                                          /* 보관장소명   */
		         ,  (
		                select
		                        x.PTNT_CMNT_SNO
		                  from
		                        SZPATCMMT x                        /* 환자COMMENT    */
		                 where  x.PTNO = a.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   /* and  x.PTNT_CMNT_SNO >= 20001
		                   and  x.PTNT_CMNT_SNO <= 40000 */
		                   and  x.PTNT_CMNT_DVSN_CD in ('21', 'C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  a.DRUG_INJC_DVSN_CD                                    /* 약주사구분   */
		         ,  (
		            select
		                    count(*)
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  x.MDPR_CLSF_CD = '3'
		               and  x.DRAP_DVSN_CD != '2'
		         )        AFI_NRDR_CCT                                /* 마약개수     */
		         /* SAVE 단독처방이면서 감사스크리닝 결과가 있을때에 'Y'를 넘겨서 클라이언트에서 조제지시서가 출력되게 처리한다. -> CANC_PTNT_TYPE_CD 를 안 쓰는것으로 판단해서 사용함 */
		         ,  decode(b.DRUS_CD,'SAVE',case when
		                                              1 = (select count(distinct k.MDPR_CD)
		                                                     from SDPORDDET k
		                                                    where k.ORDR_YMD = a.ORDR_YMD
		                                                      and k.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                                                      and k.MDTN_NO = a.MDTN_NO
		                                                      and k.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		                                                      and nvl(k.RCPC_YN,'N') = 'Y'  /* 수납된것만 출력한다. */
		                                                      and exists (select 1
		                                                                    from SDAAUDRPT l
		                                                                   where l.TRGT_ORDR_YMD1 = k.ORDR_YMD
		                                                                     and l.TRGT_MDTN_NO_DVSN_CD1 = k.MDTN_NO_DVSN_CD
		                                                                     and l.TRGT_MDTN_NO1 = k.MDTN_NO
		                                                                     and l.TRGT_MDTN_LCDV_CD1 = k.MDTN_LCDV_CD
		                                                                     and l.TRGT_ORDR_SNO1 = k.ORDR_SNO
		                                                                     and l.DRDR_CD1 = 'SAVE')
		                                                   ) then 'Y' else '' end)   CANC_PTNT_TYPE_CD
		         ,  b.DURV_RESN_CTN
		         ,  f.SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  (
		                select
		                        max(to_char(x.ORDR_YMD, 'yyyymmdd')||x.MDTN_NO)
		                  from
		                        SDPORDBAT x
		                 where  x.ORDR_YMD              >= sysdate - 120
		                   and  x.ORDR_YMD              < a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD       = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_LCDV_CD          = a.MDTN_LCDV_CD
		                   and  x.PTNO                  = a.PTNO
		                   and  x.MCDP_CD               = a.MCDP_CD
		                   and  x.DRUG_PRSS_CD          < '6'
		                   and  x.INJC_PRSS_CD          < '6'
		                   and  x.MIX_INJC_PRSS_CD      < '6'
		                   and  x.OTPT_MIX_INJC_PRSS_CD < '6'
		             )      AFI_MDTN_NO_STR           /* 이전 동일과 처방일 */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		         ,  (
		                select
		                        to_char(min(x1.MDCR_YMD), 'yyyymmdd')
		                  from
		                        APRCRPTNT x1
		                 where  x1.PTNO = a.PTNO
		                   and  nvl(x1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                   and  x1.MCDP_CD = a.MCDP_CD
		                   and  x1.MDCR_ANDV_CD not in ('7', '8', '9')
		                   and  x1.MDCR_YMD > a.ORDR_YMD
		             )   NEXT_MDCR_YMD
		         ,  b.DRUG_PRIN_YN
		         ,  (
		                select
		                        decode(count(*), 0, 'Y', 'N')
		                  from
		                        SDODGGUIT x2
		                      , APRCRPTNT x3
		                 where  x2.PTNO = a.PTNO
		                   and  x3.MDRP_NO = x2.MDRP_NO
		                   and  x2.PTDV_CD = 'O'
		                   and  x3.MDCR_DT < a.MDCR_YMD
		                   and  x2.TKMD_CCHN_YMD < a.ORDR_YMD
		             )     TKMD_CCFE_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  a.MDTN_LCDV_CD
		         ,  a.MCCN_CD
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=b.INJC_PLAC_CD), b.INJC_PLAC_CD) INJC_PLAC_CD
		         ,  fn_sd_getaudfglist_s9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD, #{phdpCmmdBndlNo}
		                         , #{afiBsisCmmdPlacNm}, #{drapDvsnCd}, #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  '0' PRIN_PAGE_NO
		         ,  0 TOTL_PAGE_CNT
		         ,  b.MDRP_NO
		         ,  a.PTDV_CD
		         ,  m.MRNN_TKNG_YN
		         ,  m.LNCH_TKNG_YN
		         ,  m.EVNN_TKNG_YN
		         ,  m.SLEP_BEFR_TKNG_YN
		         ,  nvl( a.PHDP_OROC_DPRT_CD,'')  PHDP_OROC_DPRT_CD
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'') ABRV_DPRT_CD_2
		         , ( select
		                   y.CARE_MPNG_CLSF_NM      as CARE_MPNG_CLSF_NM
		            from  (
		                        select  distinct c.CARE_MPNG_LRCL_CD
		                        from  SUCAMPDET c
		                       where c.CARE_MPNG_CD like 'C' || '%'
		                         and c.CARE_MPNG_LRCL_CD in (select
		                                                                 x.DIET_CLSF_CD
		                                                        from  MNWDIETMT x  /*  식사기본    */
		                                                      where  x.MDRP_NO         =  b.MDRP_NO
		                                                         and  x.DIST_YMD      <=  a.ORDR_YMD
		                                                         and  x.DIET_FNSH_YMD >=  a.ORDR_YMD
		                                                        and  x.DIDV_CD IN ('1','2','3','4')
		                                                        )
		                    ) x
		                 ,  (
		                     select  CARE_MPNG_CLSF_CD
		                             ,  CARE_MPNG_CLSF_NM
		                             ,  SORT_SQNC
		                     from  SUCAMAPMT
		                    where  CARE_MPNG_DVSN_CD = '2'
		                     ) y
		             where x.CARE_MPNG_LRCL_CD = y.CARE_MPNG_CLSF_CD
		               and rownum < 2) as CARE_MPNG_CLSF_NM
		         , (select PTRM_NO from APRCRPTNT x where x.MDRP_NO = b.MDRP_NO) as PTRM_NO
		         , nvl(f.TOTL_QTY_CLCL_YN,'N')   as TOTL_QTY_CLCL_YN
		         , g.DRUG_DLVY_DPRT_CD  as DRUG_DLVY_DPRT_CD
		         , b.OSLF_ADMN_DRUG_YN  as OSLF_ADMN_DRUG_YN
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCDP_CD),'')  ABRV_DPRT_CD
		         , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD) as ABRV_DPRT_CD_1 /* 병동코드명 */
		      from
		            SDPORDBAT a                               /* 약처방내역기본 */
		         ,  (
		            select  /*+ ordered use_nl(a b c)   */
		                    b.ORDR_YMD
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.MDRP_NO
		                 ,  b.OSLF_ADMN_DRUG_YN
		              from
		                    SDPORDBAT a
		                 ,  SDPORDDET b
		                 ,  MDMEDORDT h
		             where  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		               and  a.MDTN_NO = #{mdtnNo}
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
		               /* and  nvl(a.CMMD_INFM_TABL_NM, SDPORDDET) = SDPORDDET */
		               and  b.ORDR_YMD          = a.ORDR_YMD
		               and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		               and  b.MDTN_NO           = a.MDTN_NO
		               and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		               and  b.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} , 0, b.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
		               and  nvl(b.DRUS_CD, 'X') != 'SAVE'
		               and  (
		                          (
		                                   (instr(#{afiBsisCmmdPlacNm} , b.BSIS_CMMD_PLAC_CD) > 0  )
		                               and (   a.MDTN_NO_DVSN_CD in ('O','Z') and
		                                       (
		                                         ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6') and b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y' )  or
		                                         ( b.BSIS_CMMD_PLAC_CD  = 'A' and b.DRAP_DVSN_CD               != '2' ) or
		                                         ( b.BSIS_CMMD_PLAC_CD  = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                        )
		                                       or
		                                       a.MDTN_NO_DVSN_CD in ('G','H','I','D','F','P','Q','S','T') and
		                                       (
		                                         ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', 'A') and b.DRAP_DVSN_CD != '2') or   /* 경구외용    */
		                                         ( b.BSIS_CMMD_PLAC_CD  = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                        )
		                                   )
		                          )
		                      or (      a.MDTN_LCDV_CD = 'C'
		                           and  a.MDTN_NO_DVSN_CD = 'O'
		                           and  b.BSIS_CMMD_PLAC_CD in ('7', 'A', 'B')
		                           and  b.DRAP_DVSN_CD = '2'
		                           and  b.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')   /* 자가주사 */
		                           and  b.RCPC_YN = 'Y'
		                           and  (
		                                   (nvl(#{osiLablPrinYn},'N') = 'Y' and nvl(b.OSI_LABL_PRIN_YN,'N') = 'N')
		                                 or
		                                   (nvl(#{osiLablPrinYn},'N') <> 'Y')
		                                )
		                           and  #{afiBsisCmmdPlacNm} in ('0','123456')  /* 조제지시서와 주사제라벨 */
		                          )
		                     )
		               and  b.DRAP_DVSN_CD = nvl(#{drapDvsnCd} , b.DRAP_DVSN_CD)
		               and  h.PTNO = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = b.ORDR_SNO
		               and  b.BSIS_CMMD_PLAC_CD = #{inqrDvsnCd}
		            )  b                                             /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMV e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDDMETCDT m
		     where  a.ORDR_YMD        = to_date(#{ordrYmd} , 'YYYYMMDD')
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		       and  a.MDTN_NO         = #{mdtnNo}
		       and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
		       and  b.ORDR_YMD          = a.ORDR_YMD
		       and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		       and  b.MDTN_NO           = a.MDTN_NO
		       and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		       and  d.PTNO  = a.PTNO
		       and  e.USER_ID = a.ODDR_ID
		       and  e2.LGIN_ID   = e.LGIN_ID
		       and  f.MDPR_CD = b.MDPR_CD
		       and  g.DRUS_CD = b.DRUS_CD
		       and  h.DPRT_CD = a.MCDP_CD
		       and  i.COMN_GRP_CD = 'SD003'
		       and  i.COMN_DTLS_CD = nvl(f.KPNG_PLAC_CD, '9')
		       and  (
		                (nvl(#{inqrDvsnCd}, ' ') = 'D')
		             or
		                (
		                        nvl(#{inqrDvsnCd}, ' ') != 'D'
		                    and
		                        (
		                            (
		                                b.DRUS_CD != 'SAVE'
		                             /* SAVE 단독처방이면서 감사스크리닝 결과가 있을때도 출력한다. */
		                             or (
		                                      nvl(b.DRUS_CD, 'X') = 'SAVE'
		                                 and  #{afiBsisCmmdPlacNm} = '123456'  /* 조제지시서일때만 출력한다.(라벨 제외) */
		                                 and  1 = (
		                                           select count(distinct k.MDPR_CD)
		                                             from SDPORDDET k
		                                            where k.ORDR_YMD = a.ORDR_YMD
		                                              and k.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                                              and k.MDTN_NO = a.MDTN_NO
		                                              and k.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		                                              and nvl(k.RCPC_YN,'N') = 'Y'  /* 수납된것만 출력한다. */
		                                              and exists (select 1
		                                                            from SDAAUDRPT l
		                                                           where l.TRGT_ORDR_YMD1 = k.ORDR_YMD
		                                                             and l.TRGT_MDTN_NO_DVSN_CD1 = k.MDTN_NO_DVSN_CD
		                                                             and l.TRGT_MDTN_NO1 = k.MDTN_NO
		                                                             and l.TRGT_MDTN_LCDV_CD1 = k.MDTN_LCDV_CD
		                                                             and l.TRGT_ORDR_SNO1 = k.ORDR_SNO
		                                                             and l.DRDR_CD1 = 'SAVE')
		                                           )
		                                  )
		                               )
		                          and
		                              b.MDPR_CLSF_CD != '7'
		                        )
		                )
		            )
		       and  m.DRUS_CD = b.DRUS_CD
		     order
		        by
		            a.ORDR_YMD
		         ,  a.MDTN_NO_DVSN_CD
		         ,  a.MDTN_NO
		         ,  a.MDTN_LCDV_CD
		         ,  decode(#{inqrDvsnCd}, 'D', decode(b.BSIS_CMMD_PLAC_CD, '6', '0', b.BSIS_CMMD_PLAC_CD)
		                                    , 'B', b.BSIS_CMMD_PLAC_CD, decode(b.BSIS_CMMD_PLAC_CD, #{inqrDvsnCd}, '0', b.BSIS_CMMD_PLAC_CD))
		         ,  b.PHDP_CMMD_BNDL_NO
		         ,  b.MDPR_CD
		]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCchnPhrcId (복약지도수정) 
        Description :                                           복약지도수정
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<update id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCchnPhrcId"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-updateCchnPhrcId */
		<![CDATA[
		update  /*+ sdd_odgedut_u01$U01_복약지도수정 */
		             SDODGGUIT
		       set
		            CCHN_PHRC_ID  = fn_sd_getoutpharmadminid_s( #{mdtnLcdvCd}  )                      /* 약사                 */
		         ,  UNSB_CTN   =  case                             
		                              when #{tkmdCcfeYn} = 'C' then '암환자 특이사항없음'
		                              when #{tkmdCcfeYn} = 'I' then '이식환자 특이사항없음'
		                              when #{tkmdCcfeYn} = 'A' then '결핵환자 특이사항없음'
		                              when #{tkmdCcfeYn} = '4' then 'Warfarin환자 특이사항없음'
		                              when #{tkmdCcfeYn} = '6' then '흡입기환자 특이사항없음'
		                              else ''
		                          end
		         ,  TKMD_CCHN_DVSN_CD = case
		                                       when #{tkmdCcfeYn} = 'C' then '01'
		                                       when #{tkmdCcfeYn} = 'I' then '02'
		                                       when #{tkmdCcfeYn} = 'A' then '03'
		                                       when #{tkmdCcfeYn} = '4' then '04'
		                                       when #{tkmdCcfeYn} = '6' then '06'
		                               else ''
		                                 end
		         ,  LAST_UPDR_ID   =  fn_sd_getoutpharmadminid_s( #{mdtnLcdvCd} )                     /* 등록자               */
		         ,  LAST_UPDT_IP      = #{gvUserIp}
		         ,  LAST_UPDT_DT = sysdate
		         ,  LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
		         ,  LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
		     where  MDRP_NO       = #{mdrpNo}
		       and  TKMD_CCHN_YMD = to_date( #{ordrYmd} , 'yyyymmdd') /* 복약지도일           */
		       and PTDV_CD               = #{ptdvCd}
		]]>
	</update>




    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-insertTkmdCchn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<insert id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-insertTkmdCchn"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-insertTkmdCchn */
		<![CDATA[
		 insert  /*+ sdd_odgedut_i01$I01_복약지도입력 */
		      into   SDODGGUIT (
		                 PTNO                         /* 환자번호             */
		              ,  MDRP_NO
		              ,  PTDV_CD                    /* 환자구분             */
		              ,  TKMD_CCHN_YMD       /* 복약지도일           */
		              ,  CCHN_PHRC_ID           /* 약사                 */
		              ,  UNSB_CTN                  /* 특기사항             */
		              ,  LCDV_CD
		              ,  MCDP_CD                   /* 진료과               */
		              ,  TKMD_CCHN_DVSN_CD         /* 환자구분             */
		              ,  FRST_RGSR_ID
		              ,  FRST_RGST_IP
		              ,  FRST_RGST_DT
		              ,  FRST_RGST_CLNT_PRGM_ID
		              ,  FRST_RGST_SRVR_PRGM_ID
		              ,  LAST_UPDR_ID
		              ,  LAST_UPDT_IP
		              ,  LAST_UPDT_DT
		              ,  LAST_UPDT_CLNT_PRGM_ID
		              ,  LAST_UPDT_SRVR_PRGM_ID
		         )
		    values
		         (
		                 #{ptno}                                                                       /* 환자번호             */
		              ,  #{mdrpNo}
		              ,  #{ptdvCd}
		              ,  to_date( #{ordrYmd} , 'YYYYMMDD')                               /* 복약지도일           */
		              ,  fn_sd_getoutpharmadminid_s( #{mdtnLcdvCd} )               /* 약사                 */
		              ,  case
		                       when #{tkmdCcfeYn} = 'C' then '암환자 특이사항없음'
		                       when #{tkmdCcfeYn} = 'I' then '이식환자 특이사항없음'
		                       when #{tkmdCcfeYn} = 'A' then '결핵환자 특이사항없음'
		                       when #{tkmdCcfeYn} = '4' then 'Warfarin환자 특이사항없음'
		                       when #{tkmdCcfeYn} = '6' then '흡입기환자 특이사항없음'
		                 end
		              ,  #{mdtnLcdvCd}
		              ,  #{mcdpCd}                                                        /* 진료과 */
		              ,  case
		                       when #{tkmdCcfeYn} = 'C' then '01'
		                       when #{tkmdCcfeYn} = 'I' then '02'
		                       when #{tkmdCcfeYn} = 'A' then '03'
		                       when #{tkmdCcfeYn} = '4' then '04'
		                       when #{tkmdCcfeYn} = '6' then '06'
		                 end
		              ,   fn_sd_getoutpharmadminid_s( #{mdtnLcdvCd} )                /* 등록자               */
		              , #{gvUserIp}
		              ,  sysdate
		              , #{gvClntPrgmId}
		              , #{gvSrvrPrgmId}
		              , #{gvUserId}
		              , #{gvUserIp}
		              ,  sysdate
		              ,  #{gvClntPrgmId}
		              , #{gvSrvrPrgmId}
		         )
		]]>
	</insert>


	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMxPefrSno-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="adltChldDvsnCd" column="ADLT_CHLD_DVSN_CD"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="asndrId" column="ASNDR_ID"/>
		<result property="asndrNm" column="ASNDR_NM"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="chldScinBaYn" column="CHLD_SCIN_BA_YN"/>
		<result property="chldScinArYn" column="CHLD_SCIN_AR_YN"/>
		<result property="chldScinAcYn" column="CHLD_SCIN_AC_YN"/>
		<result property="scinEtcCtn" column="SCIN_ETC_CTN"/>
		<result property="rsptDgstUnslCtn" column="RSPT_DGST_UNSL_CTN"/>
		<result property="alrgMdhxHdmYn" column="ALRG_MDHX_HDM_YN"/>
		<result property="alrgMdhxPolnYn" column="ALRG_MDHX_POLN_YN"/>
		<result property="alrgMdhxFngsYn" column="ALRG_MDHX_FNGS_YN"/>
		<result property="alrgMdhxAnmlYn" column="ALRG_MDHX_ANML_YN"/>
		<result property="alrgMdhxNoneYn" column="ALRG_MDHX_NONE_YN"/>
		<result property="alrgMdhxNdYn" column="ALRG_MDHX_ND_YN"/>
		<result property="alrgMdhxCckrYn" column="ALRG_MDHX_CCKR_YN"/>
		<result property="alrgMdhxMldsYn" column="ALRG_MDHX_MLDS_YN"/>
		<result property="alrgMdhxFoodYn" column="ALRG_MDHX_FOOD_YN"/>
		<result property="alrgMdhxDrugYn" column="ALRG_MDHX_DRUG_YN"/>
		<result property="alrgHxEtcCtn" column="ALRG_HX_ETC_CTN"/>
		<result property="exopCd" column="EXOP_CD"/>
		<result property="exopPfmVl" column="EXOP_PFM_VL"/>
		<result property="itchCd" column="ITCH_CD"/>
		<result property="snznCd" column="SNZN_CD"/>
		<result property="rhnrCd" column="RHNR_CD"/>
		<result property="obscCd" column="OBSC_CD"/>
		<result property="spcrPrnYn" column="SPCR_PRN_YN"/>
		<result property="inhlPrnYn1" column="INHL_PRN_YN1"/>
		<result property="inhlPrnYn2" column="INHL_PRN_YN2"/>
		<result property="inhlPrnYn3" column="INHL_PRN_YN3"/>
		<result property="inhlPrnYn4" column="INHL_PRN_YN4"/>
		<result property="inhlMdprCd1" column="INHL_MDPR_CD1"/>
		<result property="inhlMdprCd2" column="INHL_MDPR_CD2"/>
		<result property="inhlMdprCd3" column="INHL_MDPR_CD3"/>
		<result property="inhlMdprCd4" column="INHL_MDPR_CD4"/>
		<result property="inhlTims1Qty1" column="INHL_TIMS1_QTY1"/>
		<result property="inhlTims1Qty2" column="INHL_TIMS1_QTY2"/>
		<result property="inhlTims1Qty3" column="INHL_TIMS1_QTY3"/>
		<result property="inhlTims1Qty4" column="INHL_TIMS1_QTY4"/>
		<result property="inhlDys1Ntm1" column="INHL_DYS1_NTM1"/>
		<result property="inhlDys1Ntm2" column="INHL_DYS1_NTM2"/>
		<result property="inhlDys1Ntm3" column="INHL_DYS1_NTM3"/>
		<result property="inhlDys1Ntm4" column="INHL_DYS1_NTM4"/>
		<result property="nblzPrnYn1" column="NBLZ_PRN_YN1"/>
		<result property="nblzPrnYn2" column="NBLZ_PRN_YN2"/>
		<result property="nblzPrnYn3" column="NBLZ_PRN_YN3"/>
		<result property="nblzPrnYn4" column="NBLZ_PRN_YN4"/>
		<result property="nblzMdprCd1" column="NBLZ_MDPR_CD1"/>
		<result property="nblzMdprCd2" column="NBLZ_MDPR_CD2"/>
		<result property="nblzMdprCd3" column="NBLZ_MDPR_CD3"/>
		<result property="nblzMdprCd4" column="NBLZ_MDPR_CD4"/>
		<result property="nblzTims1Qty1" column="NBLZ_TIMS1_QTY1"/>
		<result property="nblzTims1Qty2" column="NBLZ_TIMS1_QTY2"/>
		<result property="nblzTims1Qty3" column="NBLZ_TIMS1_QTY3"/>
		<result property="nblzTims1Qty4" column="NBLZ_TIMS1_QTY4"/>
		<result property="nblzNrslTims1Qty1" column="NBLZ_NRSL_TIMS1_QTY1"/>
		<result property="nblzNrslTims1Qty2" column="NBLZ_NRSL_TIMS1_QTY2"/>
		<result property="nblzNrslTims1Qty3" column="NBLZ_NRSL_TIMS1_QTY3"/>
		<result property="nblzNrslTims1Qty4" column="NBLZ_NRSL_TIMS1_QTY4"/>
		<result property="nblzDys1Ntm1" column="NBLZ_DYS1_NTM1"/>
		<result property="nblzDys1Ntm2" column="NBLZ_DYS1_NTM2"/>
		<result property="nblzDys1Ntm3" column="NBLZ_DYS1_NTM3"/>
		<result property="nblzDys1Ntm4" column="NBLZ_DYS1_NTM4"/>
		<result property="naslPrnYn1" column="NASL_PRN_YN1"/>
		<result property="naslPrnYn2" column="NASL_PRN_YN2"/>
		<result property="naslPrnYn3" column="NASL_PRN_YN3"/>
		<result property="naslPrnYn4" column="NASL_PRN_YN4"/>
		<result property="naslMdprCd1" column="NASL_MDPR_CD1"/>
		<result property="naslMdprCd2" column="NASL_MDPR_CD2"/>
		<result property="naslMdprCd3" column="NASL_MDPR_CD3"/>
		<result property="naslMdprCd4" column="NASL_MDPR_CD4"/>
		<result property="naslTims1Qty1" column="NASL_TIMS1_QTY1"/>
		<result property="naslTims1Qty2" column="NASL_TIMS1_QTY2"/>
		<result property="naslTims1Qty3" column="NASL_TIMS1_QTY3"/>
		<result property="naslTims1Qty4" column="NASL_TIMS1_QTY4"/>
		<result property="naslDys1Ntm1" column="NASL_DYS1_NTM1"/>
		<result property="naslDys1Ntm2" column="NASL_DYS1_NTM2"/>
		<result property="naslDys1Ntm3" column="NASL_DYS1_NTM3"/>
		<result property="naslDys1Ntm4" column="NASL_DYS1_NTM4"/>
		<result property="pefrMnsrEdctYn" column="PEFR_MNSR_EDCT_YN"/>
		<result property="inmnMdteYn1" column="INMN_MDTE_YN1"/>
		<result property="inmnMdteYn2" column="INMN_MDTE_YN2"/>
		<result property="cmntEtcCtn" column="CMNT_ETC_CTN"/>
		<result property="inhtTxYn" column="INHT_TX_YN"/>
		<result property="inhtTxCtn" column="INHT_TX_CTN"/>
		<result property="dtctYn" column="DTCT_YN"/>
		<result property="schxCmbnCtn" column="SCHX_CMBN_CTN"/>
		<result property="schxPackVl" column="SCHX_PACK_VL"/>
		<result property="schxDayVl" column="SCHX_DAY_VL"/>
		<result property="fhxCtn" column="FHX_CTN"/>
		<result property="sandsVl" column="SANDS_VL"/>
		<result property="sandsEtcCtn" column="SANDS_ETC_CTN"/>
		<result property="pefrQty" column="PEFR_QTY"/>
		<result property="fnshYmd" column="FNSH_YMD"/>
		<result property="fnreCd" column="FNRE_CD"/>
		<result property="fnreNm" column="FNRE_NM"/>
		<result property="phrmRptnYn" column="PHRM_RPTN_YN"/>
		<result property="etreCtn" column="ETRE_CTN"/>
		<result property="etreSbjcCtn" column="ETRE_SBJC_CTN"/>
		<result property="hghtVl" column="HGHT_VL"/>
		<result property="frstRgsrId" column="FRST_RGSR_ID"/>
		<result property="frstRgstIp" column="FRST_RGST_IP"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
		<result property="frstRgstClntPrgmId" column="FRST_RGST_CLNT_PRGM_ID"/>
		<result property="frstRgstSrvrPrgmId" column="FRST_RGST_SRVR_PRGM_ID"/>
		<result property="lastUpdrId" column="LAST_UPDR_ID"/>
		<result property="lastUpdtIp" column="LAST_UPDT_IP"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="lastUpdtClntPrgmId" column="LAST_UPDT_CLNT_PRGM_ID"/>
		<result property="lastUpdtSrvrPrgmId" column="LAST_UPDT_SRVR_PRGM_ID"/>
		<result property="btdt" column="BTDT"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno2" column="PTNT_TLNO2"/>
		<result property="ptntTlno3" column="PTNT_TLNO3"/>
		<result property="pefrQty1" column="PEFR_QTY1"/>
		<result property="prflCrtnYmd1" column="PRFL_CRTN_YMD1"/>
		<result property="pefrQty2" column="PEFR_QTY2"/>
		<result property="prflCrtnYmd2" column="PRFL_CRTN_YMD2"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMxPefrSno (호흡기약물협진의뢰 조회) 
        Description :                                           호흡기약물협진의뢰 조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMxPefrSno-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMxPefrSno"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMxPefrSno-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listMxPefrSno */
		<![CDATA[
		with x as (
		    select   /*+ sdd_mdrspco_l06$S01_호흡기약물협진의뢰 조회 */
		                c.PTNO
		             ,  c.RS_REFR_SNO
		             ,  max(c.PEFR_QTY1)             PEFR_QTY1           /* INIPEFR */
		             ,  max(c.PRFL_CRTN_YMD1)        PRFL_CRTN_YMD1      /* INIORDDATEprofile 생성일자 */
		             ,  max(c.PEFR_QTY2)             PEFR_QTY2           /* MAXPEFR */
		             ,  max(c.PRFL_CRTN_YMD2)        PRFL_CRTN_YMD2      /* MAXORDDATE */
		          from
		                (
		                select k.* from (
		                        select
		                                a.PTNO
		                             ,  a.RS_REFR_SNO
		                             ,  a.PEFR_QTY                           PEFR_QTY1           /* INIPEFR */
		                             ,  to_char(a.PRFL_CRTN_YMD,'yyyymmdd')  PRFL_CRTN_YMD1      /* INIORDDATEprofile 생성일자 */
		                             ,  null                                 PEFR_QTY2           /* MAXPEFR */
		                             ,  ''                                   PRFL_CRTN_YMD2      /* MAXORDDATE */
		                          from
		                                SDCRSPROT a /* RS환자프로필 */
		                         where
		                                a.PTNO = #{ptno}
		                           and  a.RS_REFR_SNO = decode(#{ordrSno},0,null,#{ordrSno} ) /* RS의뢰일련번호 */
		                           and  a.MDPR_CD like '%'
		                           and  a.PEFR_QTY is not null
		                           order by a.MDPR_CD, a.PRFL_CRTN_YMD
		                        ) k
		                   where  rownum < 2
		                 union  all
		                select j.* from (
		                        select
		                                b.PTNO
		                             ,  b.RS_REFR_SNO
		                             ,  null                                  PEFR_QTY1           /* INIPEFR */
		                             ,  ''                                    PRFL_CRTN_YMD1      /* INIORDDATEprofile 생성일자 */
		                             ,  b.PEFR_QTY                            PEFR_QTY2           /* MAXPEFR */
		                             ,  to_char(b.PRFL_CRTN_YMD,'yyyymmdd')   PRFL_CRTN_YMD2      /* MAXORDDATE */
		                          from
		                                SDCRSPROT b /* RS환자프로필 */
		                         where
		                                b.PTNO = #{ptno}
		                           and  b.RS_REFR_SNO = decode(#{ordrSno},0,null,#{ordrSno} ) /* RS의뢰일련번호 */
		                           and  b.MDPR_CD like '%'
		                           and  b.PEFR_QTY is not null
		                           order by b.MDPR_CD desc, b.PRFL_CRTN_YMD desc
		                       ) j
		                   where  rownum < 2
		                ) c
		       group by c.PTNO,c.RS_REFR_SNO
		    )
		    select  /*+ sdd_mdrspco_l04$S01_호흡기약물협진의뢰 조회 */
		                a.PTNO                                  /* 환자번호 */
		             ,  to_char(a.ORDR_YMD,'yyyyMMdd')      ORDR_YMD/* 처방일자 */
		             ,  a.ORDR_SNO                              /* 처방일련번호 */
		             ,  a.ADLT_CHLD_DVSN_CD                     /* 성인소아구분코드 */
		             ,  a.CODV_CD                               /* 내원구분코드 */
		             ,  a.MCDP_CD                               /* 진료과코드 */
		             ,  (select ABRV_DPRT_CD from HZDEPTMMT o where o.DPRT_CD = a.MCDP_CD and rownum = 1) ABRV_DPRT_CD
		             ,  a.WARD_CD                               /* 병동코드 */
		             ,  a.ASNDR_ID                              /* 담당의사ID */
		             ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ASNDR_ID ) ASNDR_NM  /* 담당의사명 */
		             ,  a.SCIN_CD                               /* 상병코드 */
		             ,  a.SCIN_NM                               /* 상병명 */
		             ,  a.CHLD_SCIN_BA_YN                       /* 소아상병BA여부 */
		             ,  a.CHLD_SCIN_AR_YN                       /* 소아상병AR여부 */
		             ,  a.CHLD_SCIN_AC_YN                       /* 소아상병AC여부 */
		             ,  a.SCIN_ETC_CTN                          /* 상병기타내용 */
		             ,  a.RSPT_DGST_UNSL_CTN                    /* 호흡기약물특이내용 */
		             ,  a.ALRG_MDHX_HDM_YN                      /* 알러지병력HDM여부 */
		             ,  a.ALRG_MDHX_POLN_YN                     /* 알러지병력Pollen여부 */
		             ,  a.ALRG_MDHX_FNGS_YN                     /* 알러지병력곰팡이여부 */
		             ,  a.ALRG_MDHX_ANML_YN                     /* 알러지병력Animal여부 */
		             ,  a.ALRG_MDHX_NONE_YN                     /* 알러지병력None여부 */
		             ,  a.ALRG_MDHX_ND_YN                       /* 알러지병력ND여부 */
		             ,  a.ALRG_MDHX_CCKR_YN                     /* 알러지병력바퀴벌레여부 */
		             ,  a.ALRG_MDHX_MLDS_YN                     /* 알러지병력Molds여부 */
		             ,  a.ALRG_MDHX_FOOD_YN                     /* 알러지병력음식여부 */
		             ,  a.ALRG_MDHX_DRUG_YN                     /* 알러지병력약여부 */
		             ,  a.ALRG_HX_ETC_CTN                       /* 알러지이력기타내용 */
		             ,  a.EXOP_CD                               /* 검사소견코드 */
		             ,  a.EXOP_PFM_VL                           /* 검사소견PFM값 */
		             ,  a.ITCH_CD                               /* 가려움코드 */
		             ,  a.SNZN_CD                               /* Sneezing코드 */
		             ,  a.RHNR_CD                               /* Rhinorrhea코드 */
		             ,  a.OBSC_CD                               /* Obstruction코드 */
		             ,  nvl(a.SPCR_PRN_YN,'N')                  SPCR_PRN_YN /* Spacer_PRN여부 */
		             ,  nvl(a.INHL_PRN_YN1,'N')                 INHL_PRN_YN1         /* 흡입기PRN여부1 */
		             ,  nvl(a.INHL_PRN_YN2,'N')                 INHL_PRN_YN2          /* 흡입기PRN여부2 */
		             ,  nvl(a.INHL_PRN_YN3,'N')                 INHL_PRN_YN3          /* 흡입기PRN여부3 */
		             ,  nvl(a.INHL_PRN_YN4,'N')                 INHL_PRN_YN4         /* 흡입기PRN여부4 */
		             ,  a.INHL_MDPR_CD1                         /* 흡입기약품코드1 */
		             ,  a.INHL_MDPR_CD2                         /* 흡입기약품코드2 */
		             ,  a.INHL_MDPR_CD3                         /* 흡입기약품코드3 */
		             ,  a.INHL_MDPR_CD4                         /* 흡입기약품코드4 */
		             ,  a.INHL_TIMS1_QTY1                       /* 흡입기1회량1 */
		             ,  a.INHL_TIMS1_QTY2                       /* 흡입기1회량2 */
		             ,  a.INHL_TIMS1_QTY3                       /* 흡입기1회량3 */
		             ,  a.INHL_TIMS1_QTY4                       /* 흡입기1회량4 */
		             ,  a.INHL_DYS1_NTM1                        /* 흡입기1일횟수1 */
		             ,  a.INHL_DYS1_NTM2                        /* 흡입기1일횟수2 */
		             ,  a.INHL_DYS1_NTM3                        /* 흡입기1일횟수3 */
		             ,  a.INHL_DYS1_NTM4                        /* 흡입기1일횟수4 */
		             ,  nvl(a.NBLZ_PRN_YN1,'N')                 NBLZ_PRN_YN1         /* Nebulizer_PRN여부1 */
		             ,  nvl(a.NBLZ_PRN_YN2,'N')                 NBLZ_PRN_YN2         /* Nebulizer_PRN여부2 */
		             ,  nvl(a.NBLZ_PRN_YN3,'N')                 NBLZ_PRN_YN3          /* Nebulizer_PRN여부3 */
		             ,  nvl(a.NBLZ_PRN_YN4,'N')                 NBLZ_PRN_YN4         /* Nebulizer_PRN여부4 */
		             ,  a.NBLZ_MDPR_CD1                         /* Nebulizer약품코드1 */
		             ,  a.NBLZ_MDPR_CD2                         /* Nebulizer약품코드2 */
		             ,  a.NBLZ_MDPR_CD3                         /* Nebulizer약품코드3 */
		             ,  a.NBLZ_MDPR_CD4                         /* Nebulizer약품코드4 */
		             ,  a.NBLZ_TIMS1_QTY1                       /* Nebulizer1회량1 */
		             ,  a.NBLZ_TIMS1_QTY2                       /* Nebulizer1회량2 */
		             ,  a.NBLZ_TIMS1_QTY3                       /* Nebulizer1회량3 */
		             ,  a.NBLZ_TIMS1_QTY4                       /* Nebulizer1회량4 */
		             ,  a.NBLZ_NRSL_TIMS1_QTY1                  /* Nebulizer_NS1회량1 */
		             ,  a.NBLZ_NRSL_TIMS1_QTY2                  /* Nebulizer_NS1회량2 */
		             ,  a.NBLZ_NRSL_TIMS1_QTY3                  /* Nebulizer_NS1회량3 */
		             ,  a.NBLZ_NRSL_TIMS1_QTY4                  /* Nebulizer_NS1회량4 */
		             ,  a.NBLZ_DYS1_NTM1                        /* Nebulizer1일횟수1 */
		             ,  a.NBLZ_DYS1_NTM2                        /* Nebulizer1일횟수2 */
		             ,  a.NBLZ_DYS1_NTM3                        /* Nebulizer1일횟수3 */
		             ,  a.NBLZ_DYS1_NTM4                        /* Nebulizer1일횟수4 */
		             ,  nvl(a.NASL_PRN_YN1,'N')               NASL_PRN_YN1           /* Nasal_PRN여부1 */
		             ,  nvl(a.NASL_PRN_YN2,'N')               NASL_PRN_YN2           /* Nasal_PRN여부2 */
		             ,  nvl(a.NASL_PRN_YN3,'N')               NASL_PRN_YN3            /* Nasal_PRN여부3 */
		             ,  nvl(a.NASL_PRN_YN4,'N')               NASL_PRN_YN4           /* Nasal_PRN여부4 */
		             ,  a.NASL_MDPR_CD1                         /* Nasal약품코드1 */
		             ,  a.NASL_MDPR_CD2                         /* Nasal약품코드2 */
		             ,  a.NASL_MDPR_CD3                         /* Nasal약품코드3 */
		             ,  a.NASL_MDPR_CD4                         /* Nasal약품코드4 */
		             ,  a.NASL_TIMS1_QTY1                       /* Nasal1회량1 */
		             ,  a.NASL_TIMS1_QTY2                       /* Nasal1회량2 */
		             ,  a.NASL_TIMS1_QTY3                       /* Nasal1회량3 */
		             ,  a.NASL_TIMS1_QTY4                       /* Nasal1회량4 */
		             ,  a.NASL_DYS1_NTM1                        /* Nasal1일횟수1 */
		             ,  a.NASL_DYS1_NTM2                        /* Nasal1일횟수2 */
		             ,  a.NASL_DYS1_NTM3                        /* Nasal1일횟수3 */
		             ,  a.NASL_DYS1_NTM4                        /* Nasal1일횟수4 */
		             ,  nvl(a.PEFR_MNSR_EDCT_YN,'N')         PEFR_MNSR_EDCT_YN            /* PEFR측정법교육여부 */
		             ,  nvl(a.INMN_MDTE_YN1,'N')             INMN_MDTE_YN1             /* 간헐치료여부1 */
		             ,  nvl(a.INMN_MDTE_YN2,'N')             INMN_MDTE_YN2             /* 간헐치료여부2 */
		             ,  a.CMNT_ETC_CTN                          /* 커멘트기타내용 */
		             ,  nvl(a.INHT_TX_YN,'N')                INHT_TX_YN            /* 흡입처치여부 */
		             ,  a.INHT_TX_CTN                           /* 흡입처치내용 */
		             ,  nvl(a.DTCT_YN,'N')                   DTCT_YN     /* 검출여부 */
		             ,  a.SCHX_CMBN_CTN                         /* 사회력결합내용 */
		             ,  a.SCHX_PACK_VL                          /* 사회력Pack값 */
		             ,  a.SCHX_DAY_VL                           /* 사회력DAY값 */
		             ,  a.FHX_CTN                               /* 가족력내용 */
		             ,  a.SANDS_VL                              /* S_S값 */
		             ,  a.SANDS_ETC_CTN                         /* S_S기타내용 */
		             ,  a.PEFR_QTY                              /* PEFR량 */
		             ,  to_char(a.FNSH_YMD,'yyyyMMdd')       FNSH_YMD   /* 종료일자 */
		             ,  a.FNRE_CD                               /* 종료사유코드 */
		             ,  ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                    from CCCMCDDMT F_A, CCCMCDDLT F_B
		                   where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                     and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                     and F_A.COMN_GRP_CD = 'SD034'
		                     and F_A.COMN_DTLS_CD = FNRE_CD and F_B.LNGG_CD(+) = nvl('', '*') ) FNRE_NM   /* 종료사유명 */
		             ,  nvl(a.PHRM_RPTN_YN,'N')              PHRM_RPTN_YN   /* 약국접수여부 */
		             ,  a.ETRE_CTN                             /* 기타사유내용1 */
		             ,  a.ETRE_SBJC_CTN                       /* 기타사유사항내용22 */
		             ,  a.HGHT_VL                               /* 신장값 */
		             ,  a.FRST_RGSR_ID                          /* 최초등록자ID */
		             ,  a.FRST_RGST_IP                          /*  */
		             ,  to_char(a.FRST_RGST_DT,'yyyyMMdd')   FRST_RGST_DT   /*  */
		             ,  a.FRST_RGST_CLNT_PRGM_ID                     /*  */
		             ,  a.FRST_RGST_SRVR_PRGM_ID                     /*  */
		             ,  a.LAST_UPDR_ID                          /* 최종등록자ID */
		             ,  a.LAST_UPDT_IP                          /*  */
		             ,  to_char(a.LAST_UPDT_DT,'yyyyMMdd')   LAST_UPDT_DT   /*  */
		             ,  a.LAST_UPDT_CLNT_PRGM_ID                    /*  */
		             ,  a.LAST_UPDT_SRVR_PRGM_ID                    /*  */
		             ,  to_char(b.BTDT, 'yyyyMMdd')       BTDT      /* 생년월일 */
		             ,  b.GEND_CD                               /* 성별 */
		             ,  trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||trunc(mod(months_between(a.ORDR_YMD, b.BTDT), 12))||')' AFI_AGE_VL_STR  /* 나이 */
		             ,  b.PTNT_NM                               /* 환자명 */
		             ,  c.BDWG_VL                               /* 체중 */
		             ,  d.PTNT_TLNO   PTNT_TLNO  /* 집 */
		             ,  e.PTNT_TLNO   PTNT_TLNO2 /* 핸드폰 */
		             ,  f.PTNT_TLNO   PTNT_TLNO3 /* 기타 */
		             ,  x.PEFR_QTY1           /* INIPEFR */
		             ,  x.PRFL_CRTN_YMD1      /* INIORDDATEprofile 생성일자 */
		             ,  x.PEFR_QTY2           /* MAXPEFR */
		             ,  x.PRFL_CRTN_YMD2      /* MAXORDDATE */
		          from  MDRSPCONT a                      /* 호흡기약물협진의뢰 */
		             ,  APPTPTNTT b                      /* 환자 */
		             ,  APPTADIFT c                      /* 환자부가정보 */
		             ,  APPTCNPNV d                      /* 환자연락처 - 집  BH    APPTCNPNT*/
		             ,  APPTCNPNV e                      /* 환자연락처 - 핸드폰 BP */
		             ,  APPTCNPNV f                      /* 환자연락처 - 기타 EA   */
		             ,  x
		         where  a.PTNO = #{ptno}
		           and  a.ORDR_YMD = nvl(to_date(#{ordrYmd}, 'yyyyMMdd'), a.ORDR_YMD)
		           and  a.ORDR_SNO = nvl(decode(#{ordrSno},0,null,#{ordrSno} ), a.ORDR_SNO)
		           and  b.PTNO    = a.PTNO
		           and  c.PTNO(+) = a.PTNO
		           and  d.PTNO(+) = a.PTNO
		           and  e.PTNO(+) = a.PTNO
		           and  f.PTNO(+) = a.PTNO
		           and  x.PTNO(+) = a.PTNO
		           and  x.RS_REFR_SNO(+) = a.ORDR_SNO
		           and  d.CNPN_SNO(+) = 1
		           and  e.CNPN_SNO(+) = 1
		           and  f.CNPN_SNO(+) = 1
		           and  d.CNPN_DVSN_CD(+) = 'BH'
		           and  e.CNPN_DVSN_CD(+) = 'BP'
		           and  f.CNPN_DVSN_CD(+) = 'EA'
		         order
		            by  a.PTNO
		             ,  a.ORDR_YMD
		             ,  a.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrDetlByMdtnNo-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoMdprCnfrDt" column="FDNO_MDPR_CNFR_DT"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="prmrBrcdScanDt" column="PRMR_BRCD_SCAN_DT"/>
		<result property="cmmdFinsDt" column="CMMD_FINS_DT"/>
		<result property="mdtnDt" column="MDTN_DT"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="lastUpdrId" column="LAST_UPDR_ID"/>
		<result property="lastUpdtIp" column="LAST_UPDT_IP"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="userNm" column="USER_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntAgeVl" column="PTNT_AGE_VL"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="mcdpNm" column="MCDP_NM"/>
		<result property="mrnnTkngYn" column="MRNN_TKNG_YN"/>
		<result property="lnchTkngYn" column="LNCH_TKNG_YN"/>
		<result property="evnnTkngYn" column="EVNN_TKNG_YN"/>
		<result property="slepBefrTkngYn" column="SLEP_BEFR_TKNG_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrDetlByMdtnNo (처방내역상세조회) 
        Description :                                           처방내역상세조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrDetlByMdtnNo-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrDetlByMdtnNo"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrDetlByMdtnNo-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrDetlByMdtnNo */
		<![CDATA[
		select  /*+ sdd_porddet_l53$S01_처방내역상세조회 */   /* SD_ORDDE_L15 */
		            to_char(a.ORDR_YMD, 'YYYYMMDD')   ORDR_YMD         /* 처방일자             */
		         ,  a.PTDV_CD                                                               /* 환자구분             */
		         ,  a.MDTN_NO_DVSN_CD                                              /* 처방형태구분         */
		         ,  a.MDTN_NO                               /* 투약번호             */
		         ,  a.ORDR_SNO                              /* 처방번호             */
		         ,  a.MDPR_CD                                /* 약품코드             */
		         ,  a.MDPR_CLSF_CD                        /* 약분류               */
		         ,  a.DRAP_DVSN_CD                       /* 약적용구분           */
		         ,  a.CMMD_STTS_CD                       /* 조제 STATUS          */
		         ,  a.PCKN_UNAD_QTY                      /* 투여량(포장)         */
		         ,  a.PCUN_NM                                /* 단위(포장)           */
		         ,  a.ICUN_ADMN_VLM                     /* 투여량(함량)         */
		         ,  a.ICUN_CD                                 /* 단위(함량)           */
		         ,  a.SLCT_UNIT_DVSN_CD                /* 투여량TYPE           */
		         ,  a.MDTN_DDCN                           /* 일수                 */
		         ,  a.DRUS_CD                                /* 용법                 */
		         ,  a.MDNT                                     /* 횟수                 */
		         ,  a.TOTL_CLCL_QTY                        /* 총량(계산)           */
		         ,  a.INVN_TOTL_QTY                       /* 총량(재고)           */
		         ,  a.DRBN_NO                               /* 약묶음번호           */
		         ,  a.PHDP_CMMD_BNDL_NO           /* 약제부 조제묶음번호  */
		         ,  a.MIX_KIND_CD                          /* MIX종류              */
		         ,  a.BSIS_CMMD_PLAC_CD              /* 조제장소             */
		         ,  a.SPSB_CTN                               /* 특기사항             */
		         ,  to_char(a.FDNO_MDPR_CNFR_DT, 'YYYYMMDDHH24MISS')  FDNO_MDPR_CNFR_DT   /* 정수품확인시간       */
		         ,  a.ISDV_CD                                  /* 보험구분(수납시)     */
		         ,  to_char(a.DRUG_ORDR_INPT_DT, 'YYYYMMDDHH24MISS')  DRUG_ORDR_INPT_DT /* 입력일시             */
		         ,  a.SDPF_EXRE_CD                                /* 의약분업예외사유코드 */
		         ,  to_char(a.PRIN_DT, 'YYYYMMDDHH24MISS')  PRIN_DT /* 출력시간             */
		         ,  to_char(a.PRMR_BRCD_SCAN_DT, 'YYYYMMDDHH24MISS')  PRMR_BRCD_SCAN_DT  /* 1차 Barcode일시      */
		         ,  to_char(a.CMMD_FINS_DT, 'YYYYMMDDHH24MISS')  CMMD_FINS_DT  /* 조제완료일시         */
		         ,  to_char(a.MDTN_DT, 'YYYYMMDDHH24MISS') MDTN_DT   /* 투약일시             */
		         ,  to_char(a.MDTN_STRT_YMD, 'YYYYMMDD')  MDTN_STRT_YMD      /* 투약개시일자         */
		         ,  a.INJC_PLAC_CD                               /* 주사장소             */
		         ,  a.OHOR_RTRN_YN                             /* 원외처방반납여부     */
		         ,  a.BEMD_NO                                     /* 투석실 처방번호      */
		         ,  a.ATTR_NO                                      /* AUTO TRACK번호       */
		         ,  case
		                when a.DURV_RESN_CTN is not null and d.AGE_TABO_ORRE_CTN is not null then a.DURV_RESN_CTN||',(연령금기)'||d.AGE_TABO_ORRE_CTN
		                when a.DURV_RESN_CTN is not null then a.DURV_RESN_CTN
		                when d.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||d.AGE_TABO_ORRE_CTN
		            end                              DURV_RESN_CTN   /* 상호작용 comment     */
		         ,  a.RCPC_YN                                               /* 수납여부             */
		         ,  a.WARD_LABL_PRIN_YN                              /* 프린트 여부          */
		         ,  a.LAST_UPDR_ID                                        /* 수정자ID             */
		         ,  a.LAST_UPDT_IP                                         /* 수정자IP             */
		         ,  to_char(a.LAST_UPDT_DT, 'YYYYMMDDHH24MISS')  LAST_UPDT_DT  /* 수정일시             */
		         ,  b.MDPR_NM                                            /* 약품명               */
		         ,  a.MDTN_LCDV_CD                                    /* 투약위치             */
		         ,  c.PTNO                                                    /* 환자번호             */
		         ,  e.PTNT_NM                                              /* 환자명               */
		         ,  (select nvl(ABRV_DPRT_CD, c.MCDP_CD) from HZDEPTMMT where DPRT_CD(+)=c.MCDP_CD)  MCDP_CD /* 진료과               */
		         ,  (select nvl(ABRV_DPRT_CD, c.WARD_CD) from HZDEPTMMT where DPRT_CD(+)=c.WARD_CD)  WARD_CD /* 병동                 */
		         ,  f.USER_NM                                              /* 주치의명             */
		         ,  e.GEND_CD                                             /* 성별                 */
		         ,  to_char(trunc(months_between(sysdate, e.BTDT)/12))||'/'||
		            to_char(trunc(months_between(sysdate, e.BTDT) - trunc(months_between(sysdate, e.BTDT)/12)*12)) PTNT_AGE_VL  /* 나이 */
		         ,  c.TKMD_CCHN_YN                                  /* 복약지도출력여부     */
		         ,  (select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD = c.MCDP_CD)  MCDP_NM /* 진료과명               */
		         ,  m.MRNN_TKNG_YN
		         ,  m.LNCH_TKNG_YN
		         ,  m.EVNN_TKNG_YN
		         ,  m.SLEP_BEFR_TKNG_YN
		      from
		            SDPORDDET a                                /* 처방내역상세         */
		         ,  SDDDGCDMT b                                /* 처방코드마스터       */
		         ,  SDPORDBAT c
		         ,  MDMEDORDT d
		         ,  APPTPTNTT e
		         ,  CCUSRDPHT f
		         ,  (
		            select
		                    z.ORDR_YMD
		                 ,  z.MDTN_NO_DVSN_CD
		                 ,  z.MDTN_NO
		                 ,  z.MDTN_LCDV_CD                          /* 투약위치             */
		                 ,  z.ORDR_SNO
		                 ,  z.MDPR_CD
		                 ,  sum(z.RTRN_RQST_CQY)     RTRN_RQST_CQY
		              from
		                    SDJDGRTNT z
		             where  z.ORDR_YMD = to_date(#{ordrYmd} , 'YYYYMMDD')        /* 처방일자             */
		               and  z.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}                             /* 처방형태구분         */
		               and  z.MDTN_NO = #{mdtnNo}                        /* 투약번호             */
		               and  z.MDTN_LCDV_CD = decode(#{mdtnLcdvCd} , null, z.MDTN_LCDV_CD,
		                                                           'A', z.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		             group
		                by
		                    z.ORDR_YMD
		                 ,  z.MDTN_NO_DVSN_CD
		                 ,  z.MDTN_NO
		                 ,  z.MDTN_LCDV_CD                          /* 투약위치             */
		                 ,  z.ORDR_SNO
		                 ,  z.MDPR_CD
		            )  k
		         ,  SDDMETCDT m
		     where  a.ORDR_YMD = to_date(#{ordrYmd} , 'YYYYMMDD')            /* 처방일자             */
		       and  a.PTDV_CD = #{ptdvCd}                                   /* 환자구분             */
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}                     /* 처방형태구분         */
		       and  a.MDTN_NO = #{mdtnNo}                                   /* 투약번호             */
		       and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD,
		                                                   'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		       and  (( a.ORDR_SNO = #{ordrSno} ) or (#{ordrSno} = 0) )            /* 처방번호             */
		       and  b.MDPR_CD  = a.MDPR_CD
		       and  c.ORDR_YMD = a.ORDR_YMD
		       and  c.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		       and  c.MDTN_NO = a.MDTN_NO
		       and  c.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		       and  f.USER_ID    = c.GNDR_ID
		       and  d.PTNO = c.PTNO
		       and  d.ORDR_YMD = c.ORDR_YMD
		       and  d.ORDR_SNO = a.ORDR_SNO
		       and  e.PTNO = d.PTNO
		       and  k.ORDR_YMD(+) = a.ORDR_YMD
		       and  k.MDTN_NO_DVSN_CD(+) = a.MDTN_NO_DVSN_CD
		       and  k.MDTN_NO(+) = a.MDTN_NO
		       and  k.MDTN_LCDV_CD(+) = a.MDTN_LCDV_CD
		       and  k.ORDR_SNO(+) = a.ORDR_SNO
		       and  k.MDPR_CD(+) = a.MDPR_CD
		       and  a.INVN_TOTL_QTY - nvl(k.RTRN_RQST_CQY, 0) > 0
		       and  nvl(a.DRUS_CD, 'X') != 'SAVE' /* SAVE 단독처방 제외 */
		       and  m.DRUS_CD = a.DRUS_CD
		     order
		        by  decode(a.BSIS_CMMD_PLAC_CD, '3', '0', a.BSIS_CMMD_PLAC_CD)
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDiscrtInfo-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="kornMdprNm" column="KORN_MDPR_NM"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="tkmdInftDrusCtn" column="TKMD_INFT_DRUS_CTN"/>
		<result property="mrnnTkngYn" column="MRNN_TKNG_YN"/>
		<result property="lnchTkngYn" column="LNCH_TKNG_YN"/>
		<result property="evnnTkngYn" column="EVNN_TKNG_YN"/>
		<result property="slepBefrTkngYn" column="SLEP_BEFR_TKNG_YN"/>
		<result property="tkmdInftDrusCtn1" column="TKMD_INFT_DRUS_CTN_1"/>
		<result property="mrnnTkngYn1" column="MRNN_TKNG_YN_1"/>
		<result property="lnchTkngYn1" column="LNCH_TKNG_YN_1"/>
		<result property="evnnTkngYn1" column="EVNN_TKNG_YN_1"/>
		<result property="slepBefrTkngYn1" column="SLEP_BEFR_TKNG_YN_1"/>
		<result property="idntChrcNm1" column="IDNT_CHRC_NM_1"/>
		<result property="idntChrcNm2" column="IDNT_CHRC_NM_2"/>
		<result property="dtlsCtn" column="DTLS_CTN"/>
		<result property="dtlsCtn1" column="DTLS_CTN_1"/>
		<result property="dtlsCtn2" column="DTLS_CTN_2"/>
		<result property="mdprImagBdByte" column="MDPR_IMAG_BD_BYTE"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDiscrtInfo (약상세정보조회_홈페이지용) 
        Description :                                           약상세정보조회_홈페이지용
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDiscrtInfo-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDiscrtInfo"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDiscrtInfo-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDiscrtInfo */
		<![CDATA[
				   select  /*+ sdd_mdiscrt_s99$S01_약상세정보조회_홈페이지용 */
						   nvl(w.TKMD_INFT_KORN_PDCT_NM, a.KORN_PDCT_NM ) as KORN_MDPR_NM /*  4. 한글약품명 */
						,  a.MDPR_NM as MDPR_NM /*  5. 약품명 */
						,  (
					   			select
					   					TKMD_INFT_DRUS_CTN
					   			  from  SDDMETCDT
					   			 where  SB_DRUS_CD = #{sbDrusCd}
					   			   and  SB_DRUS_CD != 'NNNNNNNNNNNNNNNNNNNNNNNNN' and rownum = 1
						   )  as TKMD_INFT_DRUS_CTN /*  6. 계산된용법 */
						,  (
					   			select
					   					MRNN_TKNG_YN
					   			  from  SDDMETCDT
					   			 where  SB_DRUS_CD = #{sbDrusCd}
					   			   and  SB_DRUS_CD != 'NNNNNNNNNNNNNNNNNNNNNNNNN' and rownum = 1
						   )  as MRNN_TKNG_YN /*  7. 아침(계산된용법) */
						,  (
					   			select
					   					LNCH_TKNG_YN
					   			  from  SDDMETCDT
					   			 where  SB_DRUS_CD = #{sbDrusCd}
					   			   and  SB_DRUS_CD != 'NNNNNNNNNNNNNNNNNNNNNNNNN' and rownum = 1
						   )  as LNCH_TKNG_YN /*  8. 점심(계산된용법) */
						,  (
					   			select
					   					EVNN_TKNG_YN
					   			  from  SDDMETCDT
					   			 where  SB_DRUS_CD = #{sbDrusCd}
					   			   and  SB_DRUS_CD != 'NNNNNNNNNNNNNNNNNNNNNNNNN' and rownum = 1
						   )  as EVNN_TKNG_YN /*  9. 저녁(계산된용법) */
						,  (
					   			select
					   					SLEP_BEFR_TKNG_YN
					   			  from  SDDMETCDT
					   			 where  SB_DRUS_CD = #{sbDrusCd}
					   			   and  SB_DRUS_CD != 'NNNNNNNNNNNNNNNNNNNNNNNNN' and rownum = 1
						   )  as SLEP_BEFR_TKNG_YN /*  10. 취침전(계산된용법) */
						,  (
					   			select
					   					m.TKMD_INFT_DRUS_CTN
					   			  from  SDDMETCDT m
					   			 where  m.DRUS_CD = #{drusCd} and rownum = 1
						   )  as TKMD_INFT_DRUS_CTN_1 /*  11. 기본용법 */
						,  (
					   			select
					   					m.MRNN_TKNG_YN
					   			  from  SDDMETCDT m
					   			 where  m.DRUS_CD = #{drusCd} and rownum = 1
						   )  as MRNN_TKNG_YN_1 /*  12. 아침(기본용법) */
						,  (
					   			select
					   					m.LNCH_TKNG_YN
					   			  from  SDDMETCDT m
					   			 where  m.DRUS_CD = #{drusCd} and rownum = 1
						   )  as LNCH_TKNG_YN_1 /*  13. 점심(기본용법) */
						,  (
					   			select
					   					m.EVNN_TKNG_YN
					   			  from  SDDMETCDT m
					   			 where  m.DRUS_CD = #{drusCd} and rownum = 1
						   )  as EVNN_TKNG_YN_1 /*  14. 저녁(기본용법) */
						,  (
					   			select
					   					m.SLEP_BEFR_TKNG_YN
					   			  from  SDDMETCDT m
					   			 where  m.DRUS_CD = #{drusCd} and rownum = 1
						   )  as SLEP_BEFR_TKNG_YN_1 /*  15. 취침전(기본용법) */
						,  w.IDNT_CHRC_NM1 as IDNT_CHRC_NM_1 /*  16. 성상1 */
						,  w.IDNT_CHRC_NM2 as IDNT_CHRC_NM_2 /*  17. 성상2 */
						,  x.DTLS_CTN as DTLS_CTN  /*  18. 효능 */
						,  y.DTLS_CTN as DTLS_CTN_1 /*  19. 부작용 */
						,  z.DTLS_CTN as DTLS_CTN_2 /*  20. 복약지도 */
						,  w.MDPR_IMAG_BD as MDPR_IMAG_BD_BYTE  /*  21. 약이미지 */
					 from  SDDDGCDMT a
						,  SDMDISCRT w
						,  SDMDGDTLT x
						,  SDMDGDTLT y
						,  SDMDGDTLT z
					where  a.MDPR_CD = #{mdprCd}
					  and  nvl(a.DGMT_RGST_TYPE_CD, '1') <> '2' /*  임상시험약제외 로직(코드값에 따라 변경가능) */
					  and  w.MDPR_CD(+) = a.MDPR_CD
					  and  x.INGR_ID(+) = w.INGR_ID
					  and  y.INGR_ID(+) = w.INGR_ID
					  and  z.INGR_ID(+) = w.INGR_ID
					  and  x.ITEM_DVSN_CD(+) = '71'
					  and  y.ITEM_DVSN_CD(+) = '84'
					  and  z.ITEM_DVSN_CD(+) = '85'
					  and  rownum = 1
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneSubDrusCd-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="sbDrusCd" column="SB_DRUS_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneSubDrusCd (sub용법코드조회) 
        Description :                                           sub용법코드조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneSubDrusCd-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneSubDrusCd"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneSubDrusCd-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneSubDrusCd */
		<![CDATA[
				   select  /*+ sdd_mergeme_s01$S01_sub용법코드조회 */
					   			fn_sd_get_mergemethod(#{ptno}
					   										,#{ordrYmd}
					   										,#{mdprCd}
					   										,#{mdtnNoDvsnCd}
					   										,#{mdtnNo}
					   										)  as SB_DRUS_CD
					   	  from
					   			DUAL
					   	where  rownum = 1
					]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtno-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="rsrn" column="RSRN"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ageVl" column="AGE_VL"/>
		<result property="strtDt" column="STRT_DT"/>
		<result property="acsFnshYmd" column="ACS_FNSH_YMD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="mddrNm" column="MDDR_NM"/>
		<result property="refrPtdvCd" column="REFR_PTDV_CD"/>
		<result property="acsSno" column="ACS_SNO"/>
		<result property="btdt" column="BTDT"/>
		<result property="avsnYn" column="AVSN_YN"/>
		<result property="adrsDetlNm" column="ADRS_DETL_NM"/>
		<result property="hslcDvsnCd" column="HSLC_DVSN_CD"/>
		<result property="mddrId" column="MDDR_ID"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="orocCd" column="OROC_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtno () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtno-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtno"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtno-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtno */
		<![CDATA[
		          select  /*+ sdd_aprcrpt_l06$S01_ACS환자조회 환자번호 */
					      PTNO as PTNO
					   ,  PTNT_NM as PTNT_NM
					   ,  RSRN as RSRN
					   ,  GEND_CD as GEND_CD
					   ,  AGE_VL as AGE_VL
					   ,  STRT_DT as STRT_DT
					   ,  ACS_FNSH_YMD as ACS_FNSH_YMD
					   ,  MCDP_CD as MCDP_CD
					   ,  ABRV_DPRT_CD as ABRV_DPRT_CD
					   ,  MDDR_NM as MDDR_NM
					   ,  REFR_PTDV_CD as REFR_PTDV_CD
					   ,  ACS_SNO as ACS_SNO
					   ,  BTDT as BTDT
					   ,  AVSN_YN as AVSN_YN
					   ,  ZPAD_NM    as ADRS_DETL_NM
					   ,  HSLC_DVSN_CD as HSLC_DVSN_CD
					   ,  MDDR_ID as MDDR_ID
					   ,  CODV_CD as CODV_CD
					   ,  MDRP_NO as MDRP_NO
		         ,  ''                                                              as OROC_CD /* OROC_CD 작업완료 */
		         ,  ''                                                              as OROC_DPRT_CD
		         ,  PHDP_OROC_DPRT_CD as PHDP_OROC_DPRT_CD /* OROC_CD 작업완료 */
				  from (  /*  ACS_SNO 최대값 가져오기 위해서 */
					   select
								  b.PTNO
							   ,  a.PTNT_NM
							   ,  a.FRRN||a.BRRN       RSRN
							   ,  a.GEND_CD
							   ,  fn_ap_age_s(b.PTNO,sysdate) AGE_VL
							   ,  to_char(b.STRT_DT, 'YYYYMMDD')                         STRT_DT
							   ,  decode(to_char(b.ACS_FNSH_YMD, 'YYYYMMDD'), '29991231', null,to_char(b.ACS_FNSH_YMD, 'YYYYMMDD'))    ACS_FNSH_YMD
							   ,  nvl((
									   select
											  r.MCDP_CD
										 from
											  APRCRPTNT r
										where  r.PTNO   = a.PTNO
										  and  r.MDCR_YMD = trunc(sysdate)
										  and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
											   or (r.MDDR_ID = b.GNDR_ID   and  r.MCDP_CD = b.MCDP_CD2)
											   )
										  and  r.CNCL_DT is null
										  and  rownum < 2
									   ) ,  b.MCDP_CD1)  MCDP_CD
								,  (select ABRV_DPRT_CD
									  from HZDEPTMMT o
									 where o.DPRT_CD = (nvl((
															 select
																	r.MCDP_CD
															   from
																	APRCRPTNT r
															  where  r.PTNO   = a.PTNO
																and  r.MDCR_YMD = trunc(sysdate)
																and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
																	 or (r.MDDR_ID = b.GNDR_ID   and  r.MCDP_CD = b.MCDP_CD2)
																	 )
																and  r.CNCL_DT is null
																and  rownum < 2
															 ) ,  b.MCDP_CD1)
														)
									   and rownum = 1) ABRV_DPRT_CD
								,  nvl((select
												( select F_A.USER_NM
													from CCUSRDPHT F_A
												   where F_A.USER_ID = r.MDDR_ID
												)
										  from
												APRCRPTNT r
										 where  r.PTNO   = a.PTNO
										   and  r.MDCR_YMD = trunc(sysdate)
										   and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
												  or (r.MDDR_ID = b.GNDR_ID and  r.MCDP_CD = b.MCDP_CD2)
												 )
										   and  r.CNCL_DT is null
										   and  rownum < 2
										) ,  ( select USER_NM
												 from CCUSRDPHT
												where USER_ID = b.ACS_RFDR_ID )
									   )  MDDR_NM
								,  b.REFR_PTDV_CD                 REFR_PTDV_CD
								,  b.ACS_SNO                      ACS_SNO
								,  to_char(a.BTDT, 'YYYYMMDD')    BTDT
								,  (select  'O'
									  from
											APRCRPTNT r
									 where  r.PTNO   = a.PTNO
									   and  r.MDCR_YMD = trunc(sysdate)
									   and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
											or (r.MDDR_ID = b.GNDR_ID   and  r.MCDP_CD = b.MCDP_CD2)
											)
									   and  r.CNCL_DT is null
									   and  rownum < 2
									) AVSN_YN
								 , (select  ZPAD_NM
									  from  APPTADRSV z
									 where  z.PTNO = a.PTNO
									   and  z.ADRS_USGE_CD = 'A'
									   and  z.ADRS_SNO = 1
									   and  rownum = 1
									)     ZPAD_NM
								 ,  (select  r.HSLC_DVSN_CD
									   from
											 APRCRPTNT r
									  where  r.PTNO   = a.PTNO
										and  r.MDCR_YMD = trunc(sysdate)
										and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
											 or (r.MDDR_ID = b.GNDR_ID   and  r.MCDP_CD = b.MCDP_CD2)
											 )
										and  r.CNCL_DT is null
										and  rownum < 2
									)  HSLC_DVSN_CD
								  ,  nvl((select  r.MDDR_ID
											from
												  APRCRPTNT r
										   where  r.MDCR_YMD = trunc(sysdate)          /*  진료일자             */
											 and  r.PTNO = a.PTNO                 /*  환자번호             */
											 and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
												  or (r.MDDR_ID = b.GNDR_ID   and  r.MCDP_CD = b.MCDP_CD2)
												  )
											 and  r.CNCL_DT is null
											 and  rownum < 2
										  ),  b.ACS_RFDR_ID
										 )  MDDR_ID
								  ,  fn_sd_getsysdatepatfg_s(a.PTNO) CODV_CD /*  내원구분코드 조회 */
								  ,  (select  r.MDRP_NO
										from
											  APRCRPTNT r
									   where  r.MDCR_YMD = trunc(sysdate)          /*  진료일자             */
										 and  r.PTNO = a.PTNO                 /*  환자번호             */
										 and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
											  or (r.MDDR_ID = b.GNDR_ID   and  r.MCDP_CD = b.MCDP_CD2))
										 and  r.CNCL_DT is null
										 and  rownum < 2
									  ) MDRP_NO      /*  진료접수번호 */					  
								   , (select /*+ index(c MDMEDORDT_I02) */
								             case when nvl( z1.MDCR_TISS_DVSN_CD, 'XXX') in ('M01') then 'M01' /* OROC_CD 작업완료 */
		                                          when nvl( z1.MDCR_TISS_DVSN_CD, 'XXX') in ('W01') then 'W01'
		                                                                                            else z1.PHDP_OROC_DPRT_CD
		                                     end                                                       as PHDP_OROC_DPRT_CD
		    								from  MDMEDORDT c
		    								   ,  HZDEPTMMT z1
		  							   where  c.MDRP_NO = (select  r.MDRP_NO
		              													 from
		              														   APRCRPTNT r
		              													where  r.MDCR_YMD = trunc(sysdate)
		              													  and  r.PTNO = a.PTNO
		              													  and  ((r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
		              														   or (r.MDDR_ID = b.GNDR_ID     and  r.MCDP_CD = b.MCDP_CD2))
		              													  and  r.CNCL_DT is null
		              													  and  rownum < 2
		              													)
		                                 and  z1.DPRT_CD = c.FRNS_DPRT_CD
		    						 	 and  rownum < 2
									   )   as PHDP_OROC_DPRT_CD /* OROC_CD 조건절 확인완료 - OROC_CD 작업 : 화면 확인필요 */
						   from
								  APPTPTNTV a
							 ,  SDCACSBAT b
						  where  a.PTNO = nvl(#{ptno},a.PTNO)
							and  b.PTNO = a.PTNO
		  			    	and (
						              (nvl(#{mcdpCd},'N') = 'N')
						              or
						              ( b.MCDP_CD1 = #{mcdpCd} or b.MCDP_CD2 = #{mcdpCd} )
		                           )
		  			    	and (
						              (nvl(#{acsFnshYn},'N') = 'N' and nvl(b.ACS_FNSH_YN,'N') = 'N')
						              or
						              (nvl(#{acsFnshYn},'N') = 'Y')
		                           )
							and  (
							              (nvl(#{sthsYn},'N') = 'N') 
							              or
							               (nvl(#{sthsYn},'N') =  'Y' and fn_sd_getsysdatepatfg_s(#{ptno}) = 'I')
							           )
						  order
							 by b.ACS_SNO desc
						 ) a
		--		where  rownum < 2
				]]>    
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtntNm-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="rsrn" column="RSRN"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ageVl" column="AGE_VL"/>
		<result property="strtDt" column="STRT_DT"/>
		<result property="acsFnshYmd" column="ACS_FNSH_YMD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="mddrNm" column="MDDR_NM"/>
		<result property="refrPtdvCd" column="REFR_PTDV_CD"/>
		<result property="acsSno" column="ACS_SNO"/>
		<result property="btdt" column="BTDT"/>
		<result property="avsnYn" column="AVSN_YN"/>
		<result property="adrsDetlNm" column="ADRS_DETL_NM"/>
		<result property="hslcDvsnCd" column="HSLC_DVSN_CD"/>
		<result property="mddrId" column="MDDR_ID"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="orocCd" column="OROC_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtntNm () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtntNm-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtntNm"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtntNm-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcsPtntPtntNm */
		<![CDATA[
				   select  /*+ sdd_aprcrpt_l07$S01_ACS환자조회 환자명 */   
				      b.PTNO as PTNO
				   ,  a.PTNT_NM as PTNT_NM
				   ,  a.FRRN||a.BRRN        as RSRN
				   ,  a.GEND_CD as GEND_CD
				   ,  fn_ap_age_s(b.PTNO,sysdate)  as AGE_VL
				   ,  to_char(b.STRT_DT, 'YYYYMMDD')                          as STRT_DT
				   ,  decode(to_char(b.ACS_FNSH_YMD, 'YYYYMMDD'), '29991231', null, to_char(b.ACS_FNSH_YMD, 'YYYYMMDD'))  as ACS_FNSH_YMD
			   ,  nvl(
					   (
							   select
							   r.MCDP_CD
							   from
							   APRCRPTNT r
							   where  r.PTNO   = a.PTNO
							   and  r.MDCR_YMD = trunc(sysdate)
							   and  (
									   (r.MDDR_ID = b.ACS_RFDR_ID and  r.MCDP_CD = b.MCDP_CD1)
									   or (r.MDDR_ID = b.GNDR_ID  and  r.MCDP_CD = b.MCDP_CD2)
							   )
							   and  rownum < 2
					   )
					   ,  b.MCDP_CD1
			   )   as MCDP_CD
			   , (select ABRV_DPRT_CD from HZDEPTMMT o where o.DPRT_CD = (nvl(
					   (
							   select
							   r.MCDP_CD
							   from
							   APRCRPTNT r
							   where  r.PTNO   = a.PTNO
							   and  r.MDCR_YMD = trunc(sysdate)
							   and  (
									   (r.MDDR_ID = b.ACS_RFDR_ID
											   and  r.MCDP_CD = b.MCDP_CD1)
											   or (r.MDDR_ID = b.GNDR_ID
													   and  r.MCDP_CD = b.MCDP_CD2)
							   )
							   and  rownum < 2
					   )
					   ,  b.MCDP_CD1
			   )) and rownum = 1)  as ABRV_DPRT_CD
			   ,  nvl(
					   (
							   select
							   ( select USER_NM from CCUSRDPHT where USER_ID = r.MDDR_ID )
							   from
							   APRCRPTNT r
							   where  r.PTNO   = a.PTNO
							   and  r.MDCR_YMD = trunc(sysdate)
							   and  (
									   (r.MDDR_ID = b.ACS_RFDR_ID
											   and  r.MCDP_CD = b.MCDP_CD1)
											   or (r.MDDR_ID = b.GNDR_ID
													   and  r.MCDP_CD = b.MCDP_CD2)
							   )
							   and  rownum < 2
					   )
					   ,  ( select USER_NM from CCUSRDPHT where USER_ID = b.ACS_RFDR_ID )
			   )   as MDDR_NM
			   ,  b.REFR_PTDV_CD        as REFR_PTDV_CD
			   ,  b.ACS_SNO             as ACS_SNO
			   ,  to_char(a.BTDT, 'YYYYMMDD')     as BTDT
			   ,  (
					   select  'O'
					   from
					   APRCRPTNT r
					   where  r.PTNO   = a.PTNO
					   and  r.MDCR_YMD = trunc(sysdate)
					   and  (
							   (r.MDDR_ID = b.ACS_RFDR_ID
									   and  r.MCDP_CD = b.MCDP_CD1)
									   or (r.MDDR_ID = b.GNDR_ID
											   and  r.MCDP_CD = b.MCDP_CD2)
					   )
					   and  rownum < 2
			   )  as AVSN_YN
			   , (select  ZPAD_NM
					   from  APPTADRSV z
					   where  z.PTNO = a.PTNO
					   and  z.ADRS_USGE_CD = 'A'
							   and  z.ADRS_SNO = 1
							   and  rownum = 1)      as ADRS_DETL_NM
							   ,  (
									   select  r.HSLC_DVSN_CD
									   from
									   APRCRPTNT r
									   where  r.PTNO   = a.PTNO
									   and  r.MDCR_YMD = trunc(sysdate)
									   and  (
											   (r.MDDR_ID = b.ACS_RFDR_ID
													   and  r.MCDP_CD = b.MCDP_CD1)
													   or (r.MDDR_ID = b.GNDR_ID
															   and  r.MCDP_CD = b.MCDP_CD2)
									   )
									   and  rownum < 2
							   )   as HSLC_DVSN_CD
							   ,  nvl((
									   select  r.MDDR_ID
									   from
									   APRCRPTNT r
									   where  r.MDCR_YMD = trunc(sysdate)          /*  진료일자             */
									   and  r.PTNO = a.PTNO                 /*  환자번호             */
									   and  ((r.MDDR_ID = b.ACS_RFDR_ID
											   and  r.MCDP_CD = b.MCDP_CD1) or
											   (r.MDDR_ID = b.GNDR_ID
													   and  r.MCDP_CD = b.MCDP_CD2))
				   and  rownum < 2
							   )
							   ,  b.ACS_RFDR_ID
							   )   as MDDR_ID
							   ,  fn_sd_getsysdatepatfg_s(a.PTNO) as CODV_CD /*  내원구분코드 조회 */
							   ,
							   (
									   select  r.MDRP_NO
									   from
									   APRCRPTNT r
									   where  r.MDCR_YMD = trunc(sysdate)          /*  진료일자             */
									   and  r.PTNO = a.PTNO                 /*  환자번호             */
									   and  ((r.MDDR_ID = b.ACS_RFDR_ID
											   and  r.MCDP_CD = b.MCDP_CD1) or
											   (r.MDDR_ID = b.GNDR_ID
													   and  r.MCDP_CD = b.MCDP_CD2))
				   and  rownum < 2
							   ) as MDRP_NO      /*  진료접수번호 */
		             ,  ''                       as OROC_CD /* OROC_CD 작업완료 */
		             ,  ''                       as OROC_DPRT_CD
		   				     ,  (
		   						   select  case when nvl( r.MDCR_TISS_DVSN_CD, 'XXX')  in ('M01') then 'M01'
		                                              when nvl( r.MDCR_TISS_DVSN_CD, 'XXX')  in ('W01') then 'W01'
		                                                                                    else r.PHDP_OROC_DPRT_CD
		                           end   PHDP_OROC_DPRT_CD 
		   						   from  MDMEDORDT c
		                                    ,  HZDEPTMMT  r
		   						   where  c.MDRP_NO =       (
		   								   select  r.MDRP_NO
		   								     from  APRCRPTNT r
		   								   where  r.MDCR_YMD = trunc(sysdate)    
		   								      and  r.PTNO = a.PTNO                 
		   								      and  (    (r.MDDR_ID = b.ACS_RFDR_ID  and  r.MCDP_CD = b.MCDP_CD1) 
		                                                    or (r.MDDR_ID = b.GNDR_ID	   and  r.MCDP_CD = b.MCDP_CD2)
		                                                    )
		   	                                  and  rownum < 2
		   						             )
		                                    and  r.DPRT_CD = c.FRNS_DPRT_CD /* OROC_CD 조건절 확인완료 - OROC_CD 작업 : 화면 확인필요 */
		   						      and  rownum < 2
		   				         )                       as PHDP_OROC_DPRT_CD  /*  처방발생원코드 */
			   from
			   APPTPTNTV a
			   ,  SDCACSBAT b
			   where  a.PTNT_NM like upper(#{ptntNm}) || '%'
			   and  b.PTNO = a.PTNO
		    	and (
		             (nvl(#{mcdpCd},'N') = 'N')
		             or
		             ( b.MCDP_CD1 = #{mcdpCd} or b.MCDP_CD2 = #{mcdpCd} )
		            )
		    	and (
		             (nvl(#{acsFnshYn},'N') = 'N' and nvl(b.ACS_FNSH_YN,'N') = 'N')
		             or
		             (nvl(#{acsFnshYn},'N') = 'Y')
		            )
		       and  (
		             (nvl(#{sthsYn},'N') = 'N') 
		             or
		             (nvl(#{sthsYn},'N') =  'Y' and fn_sd_getsysdatepatfg_s(b.PTNO) = 'I')
				    )
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtntCmntComn-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="excfCd" column="EXCF_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="extlPublYn" column="EXTL_PUBL_YN"/>
		<result property="lastUpdrId" column="LAST_UPDR_ID"/>
		<result property="lastUpdtIp" column="LAST_UPDT_IP"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="userNm" column="USER_NM"/>
		<result property="ptntCmntDvsnCd" column="PTNT_CMNT_DVSN_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtntCmntComn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtntCmntComn-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtntCmntComn"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtntCmntComn-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtntCmntComn */
		<![CDATA[
						   select  /*+ sdd_szpatcm_l01$S01_환자 COMMENT 조회 */
					   a.PTNO as PTNO              /*  환자번호 */
					,  a.PTNT_CMNT_SNO as PTNT_CMNT_SNO     /*  순번 */
					,  a.EXCF_CD as EXCF_CD            /*  검사분류 */
					,  a.SPSB_CTN as SPSB_CTN             /*  환자특기사항 */
					,  a.EXTL_PUBL_YN as EXTL_PUBL_YN           /*  외부공개여부 */
					,  a.LAST_UPDR_ID as LAST_UPDR_ID             /*  수정자 */
					,  a.LAST_UPDT_IP as LAST_UPDT_IP             /*  수정IP */
					,  to_char(a.LAST_UPDT_DT, 'yyyymmddhh24miss')  as LAST_UPDT_DT         /*  수정일시 */
					,  b.USER_NM as USER_NM
		            ,  a.PTNT_CMNT_DVSN_CD  as PTNT_CMNT_DVSN_CD  /* 환자커멘트구분코드 */
				 from
					   SZPATCMMT a
					,  CCUSRDPHT b
				where  a.PTNO        = #{ptno}           /*  환자번호 */
				  and  a.EXCF_CD      = 'SD'
				  and  (
							   (#{afiLcdvNm} = '00'
								  and  a.PTNT_CMNT_DVSN_CD = '00')
							   or
							   (#{afiLcdvNm} in ('21', 'C2')
								  and  a.PTNT_CMNT_DVSN_CD in ('21', 'C2'))
							   or
							   (#{afiLcdvNm} in ('03', 'C3')
								  and  a.PTNT_CMNT_DVSN_CD in ('03', 'C3'))
							   or
							   (#{afiLcdvNm} in ('05', 'C5')
								  and  a.PTNT_CMNT_DVSN_CD in ('05', 'C5'))
							   or
							   (#{afiLcdvNm} in ('06', 'C6')
								  and  a.PTNT_CMNT_DVSN_CD in ('06', 'C6'))
							   or
							   (#{afiLcdvNm} = 'ACS'
								  and  a.PTNT_CMNT_DVSN_CD in ('06', 'C6'))
							   or
							   (#{afiLcdvNm} = '103'
								  and  a.PTNT_CMNT_DVSN_CD = '103')		  
						   )   
				  and  b.USER_ID(+)    = a.LAST_UPDR_ID
				order
				   by
					   a.PTNO
					,  a.LAST_UPDT_DT desc
				]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugOrdrBkdcDetl-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoMdprCnfrDt" column="FDNO_MDPR_CNFR_DT"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="prmrBrcdScanDt" column="PRMR_BRCD_SCAN_DT"/>
		<result property="cmmdFinsDt" column="CMMD_FINS_DT"/>
		<result property="mdtnDt" column="MDTN_DT"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="lastUpdrId" column="LAST_UPDR_ID"/>
		<result property="lastUpdtIp" column="LAST_UPDT_IP"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="userNm" column="USER_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntAgeVl" column="PTNT_AGE_VL"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="mcdpNm" column="MCDP_NM"/>
		<result property="mrnnTkngYn" column="MRNN_TKNG_YN"/>
		<result property="lnchTkngYn" column="LNCH_TKNG_YN"/>
		<result property="evnnTkngYn" column="EVNN_TKNG_YN"/>
		<result property="slepBefrTkngYn" column="SLEP_BEFR_TKNG_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugOrdrBkdcDetl () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugOrdrBkdcDetl-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugOrdrBkdcDetl"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugOrdrBkdcDetl-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugOrdrBkdcDetl */
		<![CDATA[
						   select  /*+ sdd_porddet_l53$S01_처방내역상세조회 */   /*  SD_ORDDE_L15 */
					   to_char(a.ORDR_YMD, 'YYYYMMDD') as ORDR_YMD            /*  처방일자             */
					,  a.PTDV_CD as PTDV_CD                                   /*  환자구분             */
					,  a.MDTN_NO_DVSN_CD as MDTN_NO_DVSN_CD                                /*  처방형태구분         */
					,  a.MDTN_NO as MDTN_NO                          /*  투약번호             */
					,  a.ORDR_SNO as ORDR_SNO                       /*  처방번호             */
					,  a.MDPR_CD as MDPR_CD                                /*  약품코드             */
					,  a.MDPR_CLSF_CD as MDPR_CLSF_CD                                 /*  약분류               */
					,  a.DRAP_DVSN_CD as DRAP_DVSN_CD                                 /*  약적용구분           */
					,  a.CMMD_STTS_CD as CMMD_STTS_CD                              /*  조제 STATUS          */
					,  a.PCKN_UNAD_QTY as PCKN_UNAD_QTY                        /*  투여량(포장)         */
					,  a.PCUN_NM as PCUN_NM                                /*  단위(포장)           */
					,  a.ICUN_ADMN_VLM as ICUN_ADMN_VLM                        /*  투여량(함량)         */
					,  a.ICUN_CD as ICUN_CD                                /*  단위(함량)           */
					,  a.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD                                /*  투여량TYPE           */
					,  a.MDTN_DDCN as MDTN_DDCN                            /*  일수                 */
					,  a.DRUS_CD as DRUS_CD                                /*  용법                 */
					,  a.MDNT as MDNT                            /*  횟수                 */
					,  a.TOTL_CLCL_QTY as TOTL_CLCL_QTY                         /*  총량(계산)           */
					,  a.INVN_TOTL_QTY as INVN_TOTL_QTY                       /*  총량(재고)           */
					,  a.DRBN_NO as DRBN_NO                       /*  약묶음번호           */
					,  a.PHDP_CMMD_BNDL_NO as PHDP_CMMD_BNDL_NO                        /*  약제부 조제묶음번호  */
					,  a.MIX_KIND_CD as MIX_KIND_CD                                 /*  MIX종류              */
					,  a.BSIS_CMMD_PLAC_CD as BSIS_CMMD_PLAC_CD                                 /*  조제장소             */
					,  a.SPSB_CTN as SPSB_CTN                                  /*  특기사항             */
					,  to_char(a.FDNO_MDPR_CNFR_DT, 'YYYYMMDDHH24MISS')  as FDNO_MDPR_CNFR_DT   /*  정수품확인시간       */
					,  a.ISDV_CD as ISDV_CD                                  /*  보험구분(수납시)     */
					,  to_char(a.DRUG_ORDR_INPT_DT, 'YYYYMMDDHH24MISS')  as DRUG_ORDR_INPT_DT /*  입력일시             */
					,  a.SDPF_EXRE_CD as SDPF_EXRE_CD                                /*  의약분업예외사유코드 */
					,  to_char(a.PRIN_DT, 'YYYYMMDDHH24MISS')  as PRIN_DT /*  출력시간             */
					,  to_char(a.PRMR_BRCD_SCAN_DT, 'YYYYMMDDHH24MISS')  as PRMR_BRCD_SCAN_DT  /*  1차 Barcode일시      */
					,  to_char(a.CMMD_FINS_DT, 'YYYYMMDDHH24MISS')  as CMMD_FINS_DT  /*  조제완료일시         */
					,  to_char(a.MDTN_DT, 'YYYYMMDDHH24MISS') as MDTN_DT   /*  투약일시             */
					,  to_char(a.MDTN_STRT_YMD, 'YYYYMMDD')  as MDTN_STRT_YMD      /*  투약개시일자         */
					,  a.INJC_PLAC_CD as INJC_PLAC_CD                                 /*  주사장소             */
					,  a.OHOR_RTRN_YN as OHOR_RTRN_YN                             /*  원외처방반납여부     */
					,  a.BEMD_NO as BEMD_NO                         /*  투석실 처방번호      */
					,  a.ATTR_NO as ATTR_NO                                /*  AUTO TRACK번호       */
					,  case
						   when a.DURV_RESN_CTN is not null and d.AGE_TABO_ORRE_CTN is not null then a.DURV_RESN_CTN||',(연령금기)'||d.AGE_TABO_ORRE_CTN
						   when a.DURV_RESN_CTN is not null then a.DURV_RESN_CTN
						   when d.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||d.AGE_TABO_ORRE_CTN
					   end                              as DURV_RESN_CTN   /*  상호작용 comment     */
					,  a.RCPC_YN as RCPC_YN                                   /*  수납여부             */
					,  a.WARD_LABL_PRIN_YN as WARD_LABL_PRIN_YN                                   /*  프린트 여부          */
					,  a.LAST_UPDR_ID as LAST_UPDR_ID                                  /*  수정자ID             */
					,  a.LAST_UPDT_IP as LAST_UPDT_IP                                  /*  수정자IP             */
					,  to_char(a.LAST_UPDT_DT, 'YYYYMMDDHH24MISS')  as LAST_UPDT_DT  /*  수정일시             */
					,  b.MDPR_NM as MDPR_NM                                /*  약품명               */
					,  a.MDTN_LCDV_CD as MDTN_LCDV_CD                               /*  투약위치             */
					,  c.PTNO as PTNO                                   /*  환자번호             */
					,  e.PTNT_NM as PTNT_NM                                 /*  환자명               */
					,  (select nvl(ABRV_DPRT_CD, c.MCDP_CD) from HZDEPTMMT where DPRT_CD(+)=c.MCDP_CD)  as MCDP_CD /*  진료과               */
					,  (select nvl(ABRV_DPRT_CD, c.WARD_CD) from HZDEPTMMT where DPRT_CD(+)=c.WARD_CD)  as WARD_CD /*  병동                 */
					,  f.USER_NM as USER_NM                                /*  주치의명             */
					,  e.GEND_CD as GEND_CD                                                       /*  성별                 */
					,  to_char(trunc(months_between(sysdate, e.BTDT)/12))||'/'||
					   to_char(trunc(months_between(sysdate, e.BTDT) - trunc(months_between(sysdate, e.BTDT)/12)*12)) as PTNT_AGE_VL  /*  나이 */
					,  c.TKMD_CCHN_YN as TKMD_CCHN_YN                                  /*  복약지도출력여부     */
					,  (select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD = c.MCDP_CD)  as MCDP_NM /*  진료과명               */
					,  m.MRNN_TKNG_YN as MRNN_TKNG_YN
					,  m.LNCH_TKNG_YN as LNCH_TKNG_YN
					,  m.EVNN_TKNG_YN as EVNN_TKNG_YN
					,  m.SLEP_BEFR_TKNG_YN as SLEP_BEFR_TKNG_YN
				 from
					   SDPORDDET a                                /*  처방내역상세         */
					,  SDDDGCDMT b                                /*  처방코드마스터       */
					,  SDPORDBAT c
					,  MDMEDORDT d
					,  APPTPTNTT e
					,  CCUSRDPHT f
					,  (
					   select
							   z.ORDR_YMD
							,  z.MDTN_NO_DVSN_CD
							,  z.MDTN_NO
							,  z.MDTN_LCDV_CD                          /*  투약위치             */
							,  z.ORDR_SNO
							,  z.MDPR_CD
							,  sum(z.RTRN_RQST_CQY) RTRN_RQST_CQY
						 from
							   SDJDGRTNT z
						where  z.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')        /*  처방일자             */
						  and  z.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}                             /*  처방형태구분         */
						  and  z.MDTN_NO = #{mdtnNo}                        /*  투약번호             */
						  and  z.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, z.MDTN_LCDV_CD,
																	  'A', z.MDTN_LCDV_CD, #{mdtnLcdvCd}) /*  투약위치 */
						group
						   by
							   z.ORDR_YMD
							,  z.MDTN_NO_DVSN_CD
							,  z.MDTN_NO
							,  z.MDTN_LCDV_CD                          /*  투약위치             */
							,  z.ORDR_SNO
							,  z.MDPR_CD
					   )  k
					,  SDDMETCDT m
				where  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')        /*  처방일자             */
				  and  a.PTDV_CD = #{ptdvCd}                                   /*  환자구분             */
				  and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}                             /*  처방형태구분         */
				  and  a.MDTN_NO = #{mdtnNo}                        /*  투약번호             */
				  and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD,
															  'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd}) /*  투약위치 */
				  and  (( a.ORDR_SNO = #{ordrSno}) or (#{ordrSno} = 0) )            /*  처방번호             */
				  and  b.MDPR_CD  = a.MDPR_CD
				  and  c.ORDR_YMD = a.ORDR_YMD
				  and  c.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				  and  c.MDTN_NO = a.MDTN_NO
				  and  c.MDTN_LCDV_CD = a.MDTN_LCDV_CD
				  and  f.USER_ID    = c.GNDR_ID
				  and  d.PTNO = c.PTNO
				  and  d.ORDR_YMD = c.ORDR_YMD
				  and  d.ORDR_SNO = a.ORDR_SNO
				  and  e.PTNO = d.PTNO
				  and  k.ORDR_YMD(+) = a.ORDR_YMD
				  and  k.MDTN_NO_DVSN_CD(+) = a.MDTN_NO_DVSN_CD
				  and  k.MDTN_NO(+) = a.MDTN_NO
				  and  k.MDTN_LCDV_CD(+) = a.MDTN_LCDV_CD
				  and  k.ORDR_SNO(+) = a.ORDR_SNO
				  and  k.MDPR_CD(+) = a.MDPR_CD
				  and  a.INVN_TOTL_QTY - nvl(k.RTRN_RQST_CQY, 0) > 0
				  and  a.DRUS_CD <> 'SAVE'
				  and  m.DRUS_CD = a.DRUS_CD
				order
				   by  decode(a.BSIS_CMMD_PLAC_CD, '3', '0', a.BSIS_CMMD_PLAC_CD)
				]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listEnvLblPrt-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoMdprCnfrDt" column="FDNO_MDPR_CNFR_DT"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="orocCd" column="OROC_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO1"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="istyNm" column="ISTY_NM"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="valdHh" column="VALD_HH"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="istyAsstCd" column="ISTY_ASST_CD"/>
		<result property="afiVlmVl" column="AFI_VLM_VL"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="mdtnNo3" column="MDTN_NO_3"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="acknEdiCd" column="ACKN_EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="cancMdteAntcYn" column="CANC_MDTE_ANTC_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="atmtClamYn" column="ATMT_CLAM_YN"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="pcunInlsQty" column="PCUN_INLS_QTY"/>
		<result property="afiMdprOrlmAgeDdcnStr" column="AFI_MDPR_ORLM_AGE_DDCN_STR"/>
		<result property="errmLctnCd" column="ERRM_LCTN_CD"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="shdnYn" column="SHDN_YN"/>
		<result property="afiCmmdAftrKpngPlacNm" column="AFI_CMMD_AFTR_KPNG_PLAC_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listEnvLblPrt () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listEnvLblPrt-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listEnvLblPrt"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listEnvLblPrt-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listEnvLblPrt */
		<![CDATA[
		select  /*+ sdd_porddev_l10$S01_봉투라벨 출력 */    /*  sd_print_l7 */
		            to_char(a.ORDR_YMD, 'YYYYMMDD')  ORDR_YMD  /* 처방일자             */
		         ,  a.MDTN_NO_DVSN_CD                          /* 처방형태구분         */
		         ,  lpad(to_char(a.MDTN_NO), 4, '0')  MDTN_NO  /* 투약번호             */
		         ,  0     ORDR_SNO                             /* 처방순번             */
		         ,  ''    MDPR_CD                              /* 약품코드             */
		         ,  ''    PTDV_CD                              /* 환자구분             */
		         ,  ''    MDPR_CLSF_CD                         /* 약품분류             */
		         ,  d.DRAP_DVSN_CD                             /* 적용구분             */
		         ,  ''                           CMMD_STTS_CD               /* 조제 STATUS          */
		         ,  0                            PCKN_UNAD_QTY              /* 투여량(포장)         */
		         ,  ''                           PCUN_NM                    /* 단위(포장)           */
		         ,  ''                           ICUN_ADMN_VLM              /* 투여량(함량)         */
		         ,  ''                           ICUN_CD                    /* 단위(함량)           */
		         ,  ''                           SLCT_UNIT_DVSN_CD          /* 투여량TYPE           */
		         ,  d.MDTN_DDCN                  MDTN_DDCN                  /* 일수                 */
		         ,  d.DRUS_CD                    DRUS_CD                    /* 용법                 */
		         ,  d.MDNT                       MDNT                       /* 횟수                 */
		         ,  0                            TOTL_CLCL_QTY              /* 총량(계산)           */
		         ,  0                            INVN_TOTL_QTY              /* 총량(재고)           */
		         ,  d.PHDP_CMMD_BNDL_NO                                     /* 약제부 묶음번호      */
		         ,  0                            DRBN_NO                    /* 약묶음번호           */
		         ,  ''                           MIX_KIND_CD                /* MIX종류              */
		         ,  d.BSIS_CMMD_PLAC_CD                                     /* 조제장소             */
		         ,  ''                           SPSB_CTN                   /* 특기사항             */
		         ,  ''                           FDNO_MDPR_CNFR_DT          /* 정수품유무           */
		         ,  ''                           ISDV_CD                    /* 보험구분(수납시)     */
		         ,  ''                           DRUG_ORDR_INPT_DT          /* 입력일시             */
		         ,  ''                           SDPF_EXRE_CD               /* 의약분업예외사유코드 */
		         ,  ''                           INJC_PLAC_CD               /* 주사장소             */
		         ,  ''                           OHOR_RTRN_YN               /* 원외처방반납여부     */
		         ,  ''                           BEMD_NO                    /* 투석실 처방번호      */
		         ,  ''                           ATTR_NO                    /* AUTO TRACK번호       */
		         ,  ''                           DURV_RESN_CTN              /* 상호작용 comment     */
		         ,  a.PTNO                       PTNO                       /* 환자번호             */
		         ,  ''                           RPTN_DT                    /* 접수일시             */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.MCDP_CD),a.MCDP_CD) MCDP_CD /* 진료과               */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.WARD_CD),a.WARD_CD) WARD_CD /* 병동                 */
		         ,  a.ODDR_ID                                               /* 처방의(외래,병동)    */
		         ,  ''                           GNDR_ID                    /* 주치의(병동)         */
		         ,  ''                           RCPC_YN                    /* 수납구분             */
		         ,  0                            UPDT_BEMD_NO               /* 수정전 투약번호      */
		         ,  ''                           DRUG_INJC_DVSN_CD          /* 약주사구분           */
		         ,  ''                       as OROC_CD /* OROC_CD 작업완료 */
		         ,  ''                       as OROC_DPRT_CD
		         ,  ''                       as PHDP_OROC_DPRT_CD
		         ,  ''                           TKMD_CCHN_YN               /* 복약지도여부         */
		         ,  ''                           IHOH_DVSN_CD               /* 원내외구분           */
		         ,  ''                           NRDR_YN                    /* 마약여부             */
		         ,  ''                           PSDG_YN                    /* 향정여부             */
		         ,  ''                           CLNC_YN                    /* 임상여부             */
		         ,  to_char(a.MDCR_YMD, 'YYYYMMDD')     MDCR_YMD            /* 입원일자(내원일시)   */
		         ,  ''                           MDPR_NM                    /* 약품명               */
		         ,  decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN1, f.ENVL_MEMO_CTN3)      ENVL_MEMO_CTN1 /* 봉투1                */
		         ,  decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN2, f.ENVL_MEMO_CTN4)      ENVL_MEMO_CTN2 /* 봉투2                */
		         ,  ''  CLMN_NM_1
		         ,  ''  CLMN_NM_2
		         ,  b.PTNT_NM                                               /* 환자명               */
		         ,  ''                           FRRN                       /* 주민번호1            */
		         ,  ''                           BRRN                       /* 주민번호2            */
		         ,  ''                           AGE_CTN                    /* 생년월일             */
		         ,  ''                           GEND_CD                    /* 성별                 */
		         ,  ''                           PTNT_TLNO                  /* 전화번호(집)         */
		         ,  ''                           PTNT_TLNO1                 /* 전화번호(핸드폰)     */
		         ,  ''                           ISTY_CD                    /* 급여종별코드         */
		         ,  ''                           ISTY_NM                    /* 급여종별이름         */
		         ,   ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ODDR_ID )  AFI_ODDR_NM       /* 처방의(외래,병동)    */
		         ,  ''                           GNDR_NM                    /* 주치의(병동)         */
		         ,  ''                           SBSN_MDPR_ABSL_DSLW_YN     /* 대체약품절대불가     */
		         ,  ''                           USER_LCNS_NO               /* 면허번호             */
		         ,  ''                           KPNG_PLAC_NM               /* 보관장소             */
		         ,  h.PTRM_NO                                               /* 병실번호             */
		         ,  ''                           VALD_HH                    /* 유효시간             */
		         ,  ''                           FDNO_YN                    /* 청구여부             */
		         ,  ''                           WARD_LABL_PRIN_YN          /* 출력여부             */
		         ,  ''                           EDI_CD                     /* EDI 코드             */
		         ,  ''                           ISTY_ASST_CD               /* 유형보조             */
		         ,  ''                           AFI_VLM_VL                 /* 조제ML               */
		         ,  ''                           SCIN_CD                    /* 상병코드             */
		         ,  ''                           MDTN_STRT_YMD              /* 투약일시             */
		         ,  ''                           SCIN_NM                    /* 상병명               */
		         ,  a.MDTN_NO                    MDTN_NO_3                           /* 투약번호             */
		         ,  ''                          AFI_IPDV_NM                 /* 계산내역급여구분     */
		         ,  ''                          ACKN_EDI_CD                 /* 계산내역EDI코드      */
		         ,  ''                          PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		         ,  ''                          AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		         ,  ''                          CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		         ,  ''                          STST_DVSN_CD                /* 통계구분             */
		         ,  ''                          ATMT_CLAM_YN                /* 자동출력여부         */
		         ,  ''                          WSCN_SNGN_YN                /* 수제단독             */
		         ,  nvl(b.NTNL_CD, 'KR')    NTNL_CD                          /* 외국인코드           */
		         ,  0                           PCUN_INLS_QTY               /* 함량(마스터)         */
		         ,  ''                          AFI_MDPR_ORLM_AGE_DDCN_STR  /* 연령별처방제한문구   */
		         ,  ''                          ERRM_LCTN_CD                /* 응급실내 환자위치    */
		         ,  ''                          KORN_PDCT_NM                /* 한글 상품명          */
		         ,  ''                          SMRY_MDPR_NM                /* 지시서 출력용 요약약품명 */
		         ,  ''                          SHDN_YN                     /* 차광약물여부          */
		         ,  ''                          AFI_CMMD_AFTR_KPNG_PLAC_NM  /* 조제 후 보관장소      */
		         ,  d.MDTN_LCDV_CD              MDTN_LCDV_CD                /* 투약위치             */
		      from
		         (
		            select
		                    a.ORDR_YMD
		                 ,  a.MDTN_NO_DVSN_CD
		                 ,  a.MDTN_NO
		                 ,  a.MDTN_LCDV_CD                                                  /* 투약위치             */
		                 ,  a.PHDP_CMMD_BNDL_NO
		                 ,  a.BSIS_CMMD_PLAC_CD
		                 ,  a.DRAP_DVSN_CD
		                 ,  a.DRUS_CD
		                 ,  a.MDNT
		                 ,  a.MDTN_DDCN
		              from
		                    SDPORDDEV a
		             where  a.ORDR_YMD >= to_date(#{ordrYmd1} , 'YYYYMMDD')                  /* 처방일자             */
		               and  a.ORDR_YMD <= to_date(#{ordrYmd2} , 'YYYYMMDD')                  /* 처방일자             */
		               and  a.MDTN_NO_DVSN_CD = nvl(#{mdtnNoDvsnCd} , a.MDTN_NO_DVSN_CD)    /* 처방형태구분         */
		               and  a.MDTN_NO between  #{mdtnNo1}                                   /* 투약번호             */
		                                  and  #{mdtnNo2}                                   /* 투약번호             */
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd} , null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		               and  a.BSIS_CMMD_PLAC_CD in ('3')                                    /* 조제장소             */
		               and  nvl(a.INJC_PLAC_CD, '*') = nvl(#{injcPlacCd}, nvl(a.INJC_PLAC_CD, '*'))
		             group
		                by
		                    a.ORDR_YMD
		                 ,  a.MDTN_NO_DVSN_CD
		                 ,  a.MDTN_NO
		                 ,  a.MDTN_LCDV_CD                                                  /* 투약위치             */
		                 ,  a.PHDP_CMMD_BNDL_NO
		                 ,  a.BSIS_CMMD_PLAC_CD
		                 ,  decode(a.MDPR_CLSF_CD||a.BSIS_CMMD_PLAC_CD, '25', a.ORDR_YMD||a.MDTN_NO_DVSN_CD||a.MDTN_NO||a.ORDR_SNO, '')
		                 ,  a.DRAP_DVSN_CD
		                 ,  a.DRUS_CD
		                 ,  a.MDNT
		                 ,  a.MDTN_DDCN
		             union  all
		            select
		                    a.ORDR_YMD
		                 ,  a.MDTN_NO_DVSN_CD
		                 ,  a.MDTN_NO
		                 ,  a.MDTN_LCDV_CD                                                  /* 투약위치             */
		                 ,  a.PHDP_CMMD_BNDL_NO
		                 ,  a.BSIS_CMMD_PLAC_CD
		                 ,  a.DRAP_DVSN_CD
		                 ,  a.DRUS_CD
		                 ,  a.MDNT
		                 ,  a.MDTN_DDCN
		              from
		                    SDPORDDEV a
		             where  a.ORDR_YMD >= to_date(#{ordrYmd1} , 'YYYYMMDD')                  /* 처방일자             */
		               and  a.ORDR_YMD <= to_date(#{ordrYmd2} , 'YYYYMMDD')                  /* 처방일자             */
		               and  a.MDTN_NO_DVSN_CD = nvl(#{mdtnNoDvsnCd} , a.MDTN_NO_DVSN_CD)    /* 처방형태구분         */
		               and  a.MDTN_NO between  #{mdtnNo1}                                   /* 투약번호             */
		                                  and  to_number(#{mdtnNo2} )                        /* 투약번호             */
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		               and  a.BSIS_CMMD_PLAC_CD in ('5')                                    /* 조제장소             */
		               and  nvl(a.INJC_PLAC_CD, '*') = nvl(#{injcPlacCd}, nvl(a.INJC_PLAC_CD, '*') )
		         )  d
		         ,  SDPORDBAT a
		         ,  APPTPTNTV b
		         ,  SDDMETCDT f
		         ,  CCUSRDPHT g
		         ,  CCUSERAMT g2
		         ,  APRCRPTNT h
		         ,  HZDEPTMMT i
		     where  a.ORDR_YMD         = d.ORDR_YMD                                         /* 처방일자             */
		       and  a.MDTN_NO_DVSN_CD  = d.MDTN_NO_DVSN_CD                                  /* 투약번호구분         */
		       and  a.MDTN_NO          = d.MDTN_NO                                          /* 투약번호             */
		       and  a.MDTN_LCDV_CD     = d.MDTN_LCDV_CD                                     /* 투약위치             */
		       and  b.PTNO         = a.PTNO                                                 /* 환자번호             */
		       and  f.DRUS_CD(+) = d.DRUS_CD                                                /* 용법                 */
		       and  g.USER_ID   = a.ODDR_ID                                                 /* 처방의(외래,병동)    */
		       and  g2.LGIN_ID   = g.LGIN_ID
		       and  h.PTNO    (+)= a.PTNO                                                   /* 환자번호             */
		       and  h.MDCR_DT (+)= a.MDCR_YMD                                               /* 입원일시             */
		       and  h.CODV_CD (+)= a.PTDV_CD                                                /* 환자구분             */
		       and  i.DPRT_CD(+) = a.WARD_CD                                                /* 병동                 */
		     order
		        by
		            i.PHDP_CMMD_SQNC_VL
		         ,  a.WARD_CD
		         ,  h.PTRM_NO
		         ,  a.PTNO
		         ,  a.ORDR_YMD
		         ,  a.MDTN_NO_DVSN_CD
		         ,  a.MDTN_NO
		         ,  d.BSIS_CMMD_PLAC_CD
		         ,  d.PHDP_CMMD_BNDL_NO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtnoIdLablPrin-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="phdpCmmdSqncVl" column="PHDP_CMMD_SQNC_VL"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="ntnlCd" column="NTNL_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtnoIdLablPrin () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtnoIdLablPrin-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtnoIdLablPrin"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtnoIdLablPrin-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listPtnoIdLablPrin */
		<![CDATA[
		select  /*+ sdd_pordbat_l37$S01_환자ID라벨 */  /* SD_PRINT_L8 */
		            distinct
		            d.PHDP_CMMD_SQNC_VL
		         ,  to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD         /* 처방일자             */
		         ,  a.MDTN_NO_DVSN_CD                                   /* 처방형태구분         */
		         ,  lpad(to_char(a.MDTN_NO), 4, '0')  AFI_MDTN_NO_STR   /* 투약번호             */
		         ,  a.PTDV_CD                                           /* 환자구분             */
		         ,  a.PTNO                                              /* 환자번호             */
		         ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT      /* 접수일시             */
		         ,  (select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD=a.MCDP_CD)  MCDP_CD /* 진료과               */
		         ,  (select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD=a.WARD_CD)  WARD_CD /* 병동                 */
		         ,  a.ODDR_ID                                           /* 처방의(외래,병동)    */
		         ,  a.GNDR_ID                                           /* 주치의(병동)         */
		         ,  a.RCPC_YN                                           /* 수납구분             */
		         ,  a.UPDT_BEMD_NO                                      /* 수정전 투약번호      */
		         ,  a.DRUG_INJC_DVSN_CD                                 /* 약주사구분           */
		         ,  a.PHDP_OROC_DPRT_CD                                 /* 처방발생원           */
		         ,  a.TKMD_CCHN_YN                                      /* 복약지도여부         */
		         ,  a.IHOH_DVSN_CD                                      /* 원내외구분           */
		         ,  a.NRDR_YN                                           /* 마약여부             */
		         ,  a.PSDG_YN                                           /* 향정여부             */
		         ,  a.CLNC_YN                                           /* 임상여부             */
		         ,  to_char(a.MDCR_YMD, 'YYYYMMDD')    MDCR_YMD         /* 입원일자(내원일시)   */
		         ,  substr(b.PTNT_NM, 1, 18)   PTNT_NM                  /* 환자명               */
		         ,  c.PTRM_NO                                           /*ROOMNO:병실번호       */
		         ,  a.MDTN_NO                                           /*                      */
		         ,  a.MDTN_LCDV_CD                                      /* 투약위치             */
		         ,  nvl(b.NTNL_CD, 'KR')    NTNL_CD                    /* 외국인 코드          */
		      from
		            SDPORDBAT a 
		         ,  APPTPTNTV b
		         ,  APRCRPTNT c
		         ,  HZDEPTMMT d
		         ,  SDPORDDET e
		         ,  SDDDGCDMT g
		     where  a.ORDR_YMD between to_date(#{ordrYmd1} , 'YYYYMMDD')
		                           and to_date(#{ordrYmd2} , 'YYYYMMDD')
		       and  (
		                          (nvl(#{allCtn} , 'N') = 'Y'
		                       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd} ) /* 처방형태구분         */
		                       or (nvl(#{allCtn}, 'N') = 'N'
		                       and  a.MDTN_NO_DVSN_CD = 'A')                                 /* 처방형태구분         */
		                  )
		       and  a.MDTN_NO between  #{mdtnNo1}                         /* 투약번호             */
		                          and  #{mdtnNo2}                         /* 투약번호             */
		       and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		       and  a.WARD_CD = nvl(#{wardCd}, a.WARD_CD)           /* 병동                 */
		       and  b.PTNO = a.PTNO                                /* 환자번호             */
		       and  c.PTNO(+) = a.PTNO
		       and  c.MDCR_DT(+) = a.MDCR_YMD
		       and  c.CODV_CD(+) = a.PTDV_CD
		       and  ((c.CNCL_DT(+) is null) or (c.CNCL_DT(+) = to_date('29991231','yyyymmdd')))
		       and  (
		                          (nvl(#{allCtn}, 'N') = 'Y')
		                       or (
		                                  nvl(#{allCtn}, 'N') = 'N'
		                       and  not exists  (
		                            select
		                                    'X'
		                              from
		                                    SDPORDBAT f1
		                             where  f1.PTNO = a.PTNO
		                               and  f1.ORDR_YMD = a.ORDR_YMD - 1
		                               and  f1.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                               and  f1.WARD_CD = a.WARD_CD
		                               and  f1.WARD_CD not in (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD in ('A2E', 'A5E', 'A5S', 'A6E', 'A6W', 'A7E', 'A7W'))
		                                                )
		                            )
		                  )
		       and  d.DPRT_CD(+) = a.WARD_CD
		       and  e.ORDR_YMD = a.ORDR_YMD
		       and  e.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		       and  e.MDTN_NO = a.MDTN_NO
		       and  e.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		       and  e.BSIS_CMMD_PLAC_CD in ('1','2','3','4','5','7')
		       and  (e.CMMD_STTS_CD = '5'
		             or
		             e.INVN_TOTL_QTY > (
		                                select
		                                        nvl(sum(decode(r.MDPR_RTRN_NTM, null, r.PTAD_RTRN_QTY, r.RTRN_RQST_CQY)), 0) RTNQTY
		                                  from
		                                        SDJDGRTNT r
		                                 where
		                                        r.ORDR_YMD = e.ORDR_YMD
		                                   and  r.MDTN_NO_DVSN_CD = e.MDTN_NO_DVSN_CD
		                                   and  r.MDTN_NO = e.MDTN_NO
		                                   and  r.MDTN_LCDV_CD = e.MDTN_LCDV_CD
		                                   and  r.ORDR_SNO = e.ORDR_SNO
		                               )
		            )
		       and  g.MDPR_CD = e.MDPR_CD
		       and  nvl(g.RELS_YN,'N') = 'Y'
		     order
		        by
		            d.PHDP_CMMD_SQNC_VL,
		            WARD_CD,
		            c.PTRM_NO,
		            a.PTNO,
		            ORDR_YMD,
		            a.MDTN_NO_DVSN_CD,
		            AFI_MDTN_NO_STR
		]]>	
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-insertInjtCmmdLablScan2 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<insert id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-insertInjtCmmdLablScan2"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-insertInjtCmmdLablScan2 */
		<![CDATA[
				   insert  /*+ sdd_plabelt_i02$I01_주사제실조제라벨스캔 입력 */
					 into  SDPLABELT
						(
					   			   ORDR_YMD
					   			,  MDTN_NO_DVSN_CD
					   			,  MDTN_NO
					   			,  MDTN_LCDV_CD
					   			,  PHDP_CMMD_BNDL_NO
					   			,  ORDR_SNO
					   			,  CMMD_LABL_NO
					   			,  MDPR_CD
					   			,  SCAN_YN
						,  FRST_RGSR_ID
						,  FRST_RGST_IP
						,  FRST_RGST_DT
						,  FRST_RGST_CLNT_PRGM_ID
						,  FRST_RGST_SRVR_PRGM_ID
						,  LAST_UPDR_ID
						,  LAST_UPDT_IP
						,  LAST_UPDT_DT
						,  LAST_UPDT_CLNT_PRGM_ID
						,  LAST_UPDT_SRVR_PRGM_ID
						)
				   values
						(
					   			   to_date(#{ordrYmd}, 'YYYYMMDD')
					   			,  #{mdtnNoDvsnCd}
					   			,  #{mdtnNo}
					   			,  #{mdtnLcdvCd}
					   			,  #{phdpCmmdBndlNo}
					   			,  #{ordrSno}
					   			,  #{cmmdLablNo}
					   			,  #{mdprCd}
					   			,  'N'
						,  #{gvUserId}
						,  #{gvUserIp}
						,  sysdate
						,  #{gvClntPrgmId}
						,  #{gvSrvrPrgmId}
						,  #{gvUserId}
						,  #{gvUserIp}
						,  sysdate
						,  #{gvClntPrgmId}
						,  #{gvSrvrPrgmId}
					   )
					]]>
	</insert>


	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugInjcSheet-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN_1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO_1"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="afiIstyNm" column="AFI_ISTY_NM"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="valdHh" column="VALD_HH"/>
		<result property="relsYn" column="RELS_YN"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="istyAsstCd" column="ISTY_ASST_CD"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="mdtnNo3" column="MDTN_NO_3"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="acknEdiCd" column="ACKN_EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="cancMdteAntcYn" column="CANC_MDTE_ANTC_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="atmtClamYn" column="ATMT_CLAM_YN"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="pcunInlsQty" column="PCUN_INLS_QTY"/>
		<result property="afiMdprOrlmAgeDdcnStr" column="AFI_MDPR_ORLM_AGE_DDCN_STR"/>
		<result property="afiErrmLctnNm" column="AFI_ERRM_LCTN_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="shdnYn" column="SHDN_YN"/>
		<result property="afiCmmdAftrKpngPlacNm" column="AFI_CMMD_AFTR_KPNG_PLAC_NM"/>
		<result property="selfMdtnYn" column="SELF_MDTN_YN"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="audtYn" column="AUDT_YN"/>
		<result property="afiOrdrAudtDvsnNm" column="AFI_ORDR_AUDT_DVSN_NM"/>
		<result property="trgtMdprCd" column="TRGT_MDPR_CD"/>
		<result property="afiAudtRsltDvsnNm" column="AFI_AUDT_RSLT_DVSN_NM"/>
		<result property="audtRsltRmrkCtn" column="AUDT_RSLT_RMRK_CTN"/>
		<result property="cfdrPdaNo" column="CFDR_PDA_NO"/>
		<result property="cmmdVlm" column="CMMD_VLM"/>
		<result property="afiMdtnNoDvsnNm" column="AFI_MDTN_NO_DVSN_NM"/>
		<result property="afiInrnTbstSycdNm" column="AFI_INRN_TBST_SYCD_NM"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="injcPlacCd1" column="INJC_PLAC_CD_1"/>
		<result property="ntmRflcYn" column="NTM_RFLC_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugInjcSheet () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugInjcSheet-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugInjcSheet"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugInjcSheet-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listDrugInjcSheet */
		<![CDATA[
		select  /*+ sdd_pordbat_l79$S01_약주사처방전조회 */
		            a.ORDR_YMD         ,          /* 처방일자             */
		            a.MDTN_NO_DVSN_CD  ,          /* 투약번호구분         */
		            a.AFI_MDTN_NO_STR  ,          /* 투약번호             */
		            a.ORDR_SNO         ,          /* 처방번호             */
		            a.MDPR_CD          ,          /* 약품코드             */
		            a.PTDV_CD          ,          /* 환자구분             */
		            a.MDPR_CLSF_CD     ,          /* 약분류               */
		            a.DRAP_DVSN_CD     ,          /* 약적용구분           */
		            a.CMMD_STTS_CD     ,          /* 조제 STATUS          */
		            a.PCKN_UNAD_QTY    ,          /* 투여량(포장)         */
		            a.PCUN_CD          ,          /* 단위(포장)           */
		            a.ICUN_ADMN_VLM    ,          /* 투여량(함량)         */
		            a.ICUN_CD          ,          /* 단위(함량)           */
		            a.SLCT_UNIT_DVSN_CD,          /* 투여량TYPE           */
		            a.MDTN_DDCN        ,          /* 일수                 */
		            a.DRUS_CD          ,          /* 용법                 */
		            a.MDNT              ,          /* 횟수                 */
		            decode(a.FRNS_CTRL_DVSN_CD, null, a.TOTL_CLCL_QTY, a.INVN_TOTL_QTY) TOTL_CLCL_QTY,   /* 총량(계산)           */
		            a.INVN_TOTL_QTY    ,          /* 총량(재고)           */
		            a.PHDP_CMMD_BNDL_NO,          /* 약제부 묶음번호      */
		            a.DRBN_NO          ,          /* 약묶음번호           */
		            a.MIX_KIND_CD      ,          /* MIX여부              */
		            a.BSIS_CMMD_PLAC_CD,          /* 조제장소             */
		            a.SPSB_CTN           ,          /* 특기사항             */
		            a.FDNO_YN          ,          /* 정수품유무           */
		            a.ISDV_CD          ,          /* 보험구분(수납시)     */
		            a.DRUG_ORDR_INPT_DT,          /* 입력일시             */
		            a.SDPF_EXRE_CD     ,          /* 의약분업예외사유코드 */
		            nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.INJC_PLAC_CD), a.INJC_PLAC_CD) INJC_PLAC_CD  ,          /* 주사장소             */
		            a.OHOR_RTRN_YN     ,          /* 원외처방반납여부     */
		            a.BEMD_NO          ,          /* 투석실 처방번호      */
		            a.ATTR_NO          ,          /* AUTO TRACK번호       */
		            a.DURV_RESN_CTN    ,          /* 상호작용 COMMENT     */
		            a.PTNO             ,          /* 환자번호             */
		            a.RPTN_DT          ,          /* 접수일시             */
		            nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+) = a.MCDP_CD), a.MCDP_CD) MCDP_CD  , /* 진료과               */
		            nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+) = a.WARD_CD), a.WARD_CD) WARD_CD  , /* 병동                 */
		            a.ODDR_ID         ,           /* 처방의(외래)         */
		            a.GNDR_ID         ,           /* 주치의(병동)         */
		            a.RCPC_YN         ,           /* 수납구분             */
		            a.UPDT_BEMD_NO      ,         /* 수정전 투약번호      */
		            a.DRUG_INJC_DVSN_CD ,         /* 약주사구분           */
		            a.PHDP_OROC_DPRT_CD      ,              /* 처방발생원           */
		            a.TKMD_CCHN_YN   ,            /* 복약지도여부         */
		            a.IHOH_DVSN_CD   ,            /* 원내외구분           */
		            a.NRDR_YN        ,            /* 마약여부             */
		            a.PSDG_YN       ,             /* 향정여부             */
		            a.CLNC_YN      ,              /* 임상여부             */
		            a.MDCR_YMD       ,            /* 입원일자(내원일시)   */
		            a.MDPR_NM      ,              /* 약품명               */
		            a.ENVL_MEMO_CTN1  ENVL_MEMO_CTN_1,           /* 봉투  TEXT1          */
		            a.ENVL_MEMO_CTN2  ENVL_MEMO_CTN_2,           /* 봉투  TEXT2          */
		            a.PTNT_NM       ,             /* 환자명               */
		            a.FRRN        ,               /* 주민번호1            */
		            a.BRRN        ,               /* 주민번호2            */
		            a.AFI_AGE_VL_STR ,            /* 생년월일             */
		            a.GEND_CD,                    /* 성별                  */
		            (select z.PTNT_TLNO
		               from APPTCNPNV z
		              where z.PTNO = a.PTNO
		                and CNPN_DVSN_CD = 'BH'
		                and CNPN_SNO = 1
		                and rownum = 1)   PTNT_TLNO      ,            /* 전화번호(집)         */
		            (select z.PTNT_TLNO
		               from APPTCNPNV z
		              where z.PTNO = a.PTNO
		                and CNPN_DVSN_CD = 'BP'
		                and CNPN_SNO = 1
		                and rownum = 1)   PTNT_TLNO_1      ,           /* 전화번호(핸드폰)     */
		            a.ISTY_CD        ,            /* 급여종별코드         */
		            a.ISTY_CDNM  AFI_ISTY_NM    ,            /* 급여종별이름         */
		            a.ODDR_IDNM  AFI_ODDR_NM    ,           /* 사용자명             */
		            a.GNDR_IDNM  GNDR_NM        ,           /* 사용자명             */
		            a.SBSN_MDPR_ABSL_DSLW_YN,     /* 대체약품절대불가여부 */
		            a.USER_LCNS_NO        ,             /* 면허번호             */
		            a.KPNG_PLAC_NM       ,        /* 보관장소             */
		            a.PTRM_NO        ,            /* 병실번호             */
		            a.VALD_HH       ,             /* 유효시간             */
		            a.RELS_YN       ,             /* 청구약품여부         */
		            a.WARD_LABL_PRIN_YN,          /* 출력부               */
		            a.EDI_CD       ,              /* EDI 코드             */
		            a.ISTY_ASST_CD        ,       /* 유형보조             */
		            a.SCIN_CD      ,               /* 상병코드             */
		            a.MDTN_STRT_YMD   ,            /* 투약일시             */
		            (
		               select
		                       t.SCIN_NM
		                 from MDPADIAGT t
		                where  t.MDRP_NO       = a.MDRP_NO
		                  and  t.MAIN_SCIN_YN  = 'Y'
		                  and  a.GNDR_ID       = decode( A.PTDV_CD, 'O', t.CHDR_ID , a.GNDR_ID )
		                  and rownum < 2
		            )  SCIN_NM      ,               /* 상병명               */
		            a.MDTN_NO_3        ,              /* 투약번호             */
		            a.AFI_IPDV_NM   ,              /* 계산내역급여구분     */
		            a.ACKN_EDI_CD   ,              /* 계산내역EDI코드      */
		            a.PTNT_TYPE_NM_2    ,          /* 계산내역환자유형     */
		            a.AFI_ISTY_ASST_NM_2 ,         /* 계산내역유형보조     */
		            a.CANC_MDTE_ANTC_YN  ,         /* 소아항암여부         */
		            a.STST_DVSN_CD       ,         /* 통계구분             */
		            a.ATMT_CLAM_YN        ,        /* 자동출력여부         */
		            a.WSCN_SNGN_YN      ,          /* 수제단독             */
		            a.NTNL_CD       ,              /* 외국인코드           */
		            a.PCUN_INLS_QTY   ,          /* 함량(마스터)         */
		            a.AFI_MDPR_ORLM_AGE_DDCN_STR,  /* 연령별처방제한문구   */
		            a.ERRM_LCTN_CD   AFI_ERRM_LCTN_NM ,              /*응급실내 환자세부위치 */
		            a.KORN_PDCT_NM      ,          /* 한글상품명           */
		            a.SMRY_MDPR_NM  ,              /* 라벨출력용 요약상품명*/
		            ''      SHDN_YN ,              /* 차광약물여부         */
		            ''      AFI_CMMD_AFTR_KPNG_PLAC_NM        ,              /* 조제 후 보관장소     */
		            a.SELF_MDTN_YN    ,            /* Self Medication 여부 */
		            a.MDTN_LCDV_CD     ,           /* 투약위치             */
		            a.CLNC_EXAM_DRUG_YN    ,       /* 임상시험약 여부      */
		            a.AUDT_YN         ,            /* 처방감사여부         */
		            a.AFI_ORDR_AUDT_DVSN_NM ,      /* 처방감사구분명       */
		            a.TRGT_MDPR_CD   ,             /* 약품코드(감사)       */
		            a.AUDT_RSLT_DVSN_CD      AFI_AUDT_RSLT_DVSN_NM,           /* 처방감사값           */
		            a.AUDT_RSLT_RMRK_CTN ,         /* 처방감사비고         */
		            a.CFDR_PDA_NO  ,               /* 주치의PDA            */
		            (select b1.LAST_USE_VLM
		               from SDIJSTMAT a1
		                  , SDIJSTPST b1
		                  , SDMDISCRT c1
		              where c1.MDPR_CD = a.MDPR_CD
		                and b1.MDPR_CD = a.MDPR_CD
		                and c1.RPMD_ID = a1.RPMD_ID
		                and b1.RPMD_ID = a1.RPMD_ID
		                and a.INJT_STER_CMMD_YN = 'Y'
		                and rownum < 2)               CMMD_VLM,            /* 조제ml               */
		            (select DETL_CD_NM from SDCMCDDMV where COMN_GRP_CD = 'SD023' and COMN_DTLS_CD = a.MDTN_NO_DVSN_CD) AFI_MDTN_NO_DVSN_NM,
		            ' ' AFI_INRN_TBST_SYCD_NM,
		            a.HGRS_HGCC_MDPR_YN,
		            a.ODDR_NM,
		            a.INJC_PLAC_CD   INJC_PLAC_CD_1,
		            a.NTM_RFLC_YN
		      from
		            (
		            select  /*+ NO_EXPAND LEADING(A, D, H) USE_NL(A, B , D, H, C, E, F, G, G2, I, J) INDEX_SS(A, SDPORDBAT_PK) OPT_PARAM('_OPTIMIZER_COST_BASED_TRANSFORMATION','OFF') */
		                    to_char(a.ORDR_YMD, 'YYYYMMDD') ORDR_YMD,                   /* 처방일자             */
		                    a.MDTN_NO_DVSN_CD ,                                         /* 처방형태구분         */
		                    lpad(to_char(a.MDTN_NO), 4, '0') AFI_MDTN_NO_STR,           /* 투약번호             */
		                    d.ORDR_SNO ,                                                /* 처방번호             */
		                    d.MDPR_CD ,                                                 /* 약품코드             */
		                    a.PTDV_CD ,                                                 /* 환자구분             */
		                    d.MDPR_CLSF_CD ,                                            /* 약분류               */
		                    d.DRAP_DVSN_CD ,                                            /* 약적용구분           */
		                    d.CMMD_STTS_CD           ,                                  /* 조제 STATUS          */
		                    decode(d.DRAP_DVSN_CD,'2',d.PCKN_UNAD_QTY,round(d.PCKN_UNAD_QTY,2))  PCKN_UNAD_QTY,   /* 투여량(포장)         */
		                    d.PCUN_NM   PCUN_CD,                                        /* 단위(포장)           */
		                    decode(d.DRAP_DVSN_CD,'2',d.ICUN_ADMN_VLM,round(d.ICUN_ADMN_VLM,2))  ICUN_ADMN_VLM,   /* 투여량(함량)         */
		                    d.ICUN_CD ,                                                /* 단위(함량)           */
		                    d.SLCT_UNIT_DVSN_CD ,                                       /* 투여량TYPE           */
		                    d.MDTN_DDCN ,                                               /* 일수                 */
		                    d.DRUS_CD ,                                                 /* 용법                 */
		                    d.MDNT ,                                                    /* 횟수                 */
		                    decode(d.DRAP_DVSN_CD,'2',d.TOTL_CLCL_QTY,round(d.TOTL_CLCL_QTY,2)) TOTL_CLCL_QTY,     /* 총량(계산)           */
		                    decode(d.DRAP_DVSN_CD,'2',d.INVN_TOTL_QTY,round(d.INVN_TOTL_QTY,2)) INVN_TOTL_QTY,     /* 총량(계산)           */
		                    d.PHDP_CMMD_BNDL_NO ,                                       /* 약제부 묶음번호       */
		                    d.DRBN_NO ,                                                 /* 약묶음번호           */
		                    d.MIX_KIND_CD ,                                             /* MIX종류              */
		                    d.BSIS_CMMD_PLAC_CD ,                                       /* 조제장소             */
		                    replace(replace(d.SPSB_CTN,chr(13)||chr(10),''),chr(10),'')  SPSB_CTN,  /* 특기사항 */  -- PHH  DHL  PHN  HHC  CPHN  CHHC
		                    null                        as FDNO_YN, /* 정수품유무 */
		                    d.ISDV_CD ,                                                 /* 보험구분(수납시)     */
		                    to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT,   /* 입력일시             */
		                    d.SDPF_EXRE_CD ,                                            /* 의약분업예외사유코드 */
		                    d.INJC_PLAC_CD ,                                            /* 주사장소             */
		                    d.OHOR_RTRN_YN ,                                            /* 원외처방반납여부     */
		                    d.BEMD_NO ,                                                 /* 투석실 처방번호      */
		                    d.ATTR_NO ,                                                 /* AUTO TRACK번호       */
		                    case
		                        when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                        when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                        when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                    end     DURV_RESN_CTN,                                      /* 상호작용 comment     */
		                    a.PTNO ,                                                    /* 환자번호             */
		                    to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT,             /* 접수일시             */
		                    a.MCDP_CD ,                                                 /* 진료과               */
		                    a.WARD_CD ,                                                 /* 병동                 */
		                    a.ODDR_ID ,                                                 /* 처방의(외래,병동)    */
		                    a.GNDR_ID ,                                                 /* 주치의(병동)         */
		                    a.RCPC_YN ,                                                 /* 수납구분             */
		                    a.UPDT_BEMD_NO ,                                            /* 수정전 투약번호      */
		                    a.DRUG_INJC_DVSN_CD ,                                       /* 약주사구분           */
		                    a.PHDP_OROC_DPRT_CD ,                                                 /* 처방발생원           */
		                    a.TKMD_CCHN_YN ,                                            /* 복약지도여부         */
		                    a.IHOH_DVSN_CD ,                                            /* 원내외구분           */
		                    a.NRDR_YN ,                                                 /* 마약여부             */
		                    a.PSDG_YN ,                                                 /* 향정여부             */
		                    a.CLNC_YN ,                                                 /* 임상여부             */
		                    to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS')   MDCR_YMD,         /* 입원일자(내원일시)   */
		                    e.MDPR_NM                  ,                                /* 약품명               */
		                    decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN1
		                                                       , f.ENVL_MEMO_CTN1) ENVL_MEMO_CTN1, /* 봉투1                */
		                    decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN2
		                                                       , f.ENVL_MEMO_CTN2) ENVL_MEMO_CTN2, /* 봉투2                */
		                    b.PTNT_NM ,                                                 /* 환자명               */
		                    b.FRRN ,                                                    /* 주민번호1            */
		                    b.BRRN ,                                                    /* 주민번호2            */
		                    trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||trunc(mod(months_between(a.ORDR_YMD, b.BTDT),12))||')'  AFI_AGE_VL_STR ,
		                    b.GEND_CD ,                                                 /* 성별                 */
		                    h.ISTY_CD ,                                                 /* 급여종별코드         */
		                    ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                        from CCCMCDDMT F_A, CCCMCDDLT F_B
		                       where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                         and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                         and F_A.COMN_GRP_CD = 'AI003'
		                         and F_A.COMN_DTLS_CD =  h.ISTY_CD
		                         and F_B.LNGG_CD(+) = nvl( '', '*') ) ISTY_CDNM,       /* 급여종별이름         */
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ODDR_ID ) ODDR_IDNM,                    /* 처방의(외래,병동)    */
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.GNDR_ID ) GNDR_IDNM,                    /* 주치의(병동)         */
		                    'N' SBSN_MDPR_ABSL_DSLW_YN,                    /* 대체약품절대불가     */
		                    g2.USER_LCNS_NO ,                                                             /* 면허번호             */
		                    ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                        from CCCMCDDMT F_A, CCCMCDDLT F_B
		                       where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                         and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                         and F_A.COMN_GRP_CD = 'SD003'
		                         and F_A.COMN_DTLS_CD =  e.KPNG_PLAC_CD
		                         and F_B.LNGG_CD(+) = nvl( '', '*') ) KPNG_PLAC_NM,       /* 보관장소             */
		                    c.PTRM_NO ,                                                 /* 병실번호             */
		                    '' VALD_HH ,                                                 /* 유효시간             */
		                    nvl(e.RELS_YN, 'N') RELS_YN,                                /* 청구약품여부         */
		                    d.WARD_LABL_PRIN_YN ,                                       /* 출력여부             */
		                    '' EDI_CD,                                                  /* EDI코드              */
		                    '' ISTY_ASST_CD,                                            /* 유형보조             */
		                    '' SCIN_CD,                                                 /* 상병코드             */
		                    to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') MDTN_STRT_YMD, /* 실시일자    */
		                    '' SCIN_NM,                                                 /* 상병명               */
		                    a.MDTN_NO         MDTN_NO_3,                                   /* 투약번호             */
		                    '' AFI_IPDV_NM,                                             /* 계산내역급여구분     */
		                    '' ACKN_EDI_CD,                                             /* 계산내역EDI코드      */
		                    '' PTNT_TYPE_NM_2,                                          /* 계산내역환자유형     */
		                    '' AFI_ISTY_ASST_NM_2,                                      /* 계산내역유형보조     */
		                    '' CANC_MDTE_ANTC_YN,                                       /* 소아항암여부         */
		                    e.STST_DVSN_CD ,                                            /* 통계구분             */
		                    'Y' ATMT_CLAM_YN,                                           /* 자동출력여부         */
		                    e.WSCN_SNGN_YN ,                                            /* 수제단독             */
		                    b.NTNL_CD,                                                  /* 외국인코드           */
		                    e.PCUN_INLS_QTY ,                                           /* 함량(마스터)         */
		                    '' AFI_MDPR_ORLM_AGE_DDCN_STR,
		                    (select ERRM_ZONE_NM||'('||substr(fn_mn_patwardtelno_s(c.MDRP_NO),-4)||')' from MNEERRMZT where ERRM_LCTN_CD=j.ERRM_LCTN_CD) ERRM_LCTN_CD, /*응급실내 환자세부위치 */
		                    e.KORN_PDCT_NM   ,                                          /* 한글상품명              */
		                    e.SMRY_MDPR_NM   ,                                          /* 라벨 출력용 요약상품명  */
		                    'N'          SELF_MDTN_YN,                                  /* Self Medication 여부    */
		                    1            SELFSEQ,                                       /* Self Medication 용 순서 */
		                    a.MDTN_LCDV_CD  ,                                           /* 투약위치                */
		                    decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN ,                                       /* 임상시험약 여부         */
		                    h.FRNS_CTRL_DVSN_CD  ,
		                    'N'          AUDT_YN,
		                    fn_sd_getaudfglist_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO, 1)    AFI_ORDR_AUDT_DVSN_NM,
		                    0            AUDSORTSEQ,
		                    ''           TRGT_MDPR_CD,
		                    ''           AUDT_RSLT_DVSN_CD,
		                    ''           AUDT_RSLT_RMRK_CTN,
		                    decode(g2.PDA_NO,'','','(8-'||g2.PDA_NO||')')  CFDR_PDA_NO,
		                    e.HGRS_HGCC_MDPR_YN,
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM,
		                    c.MDRP_NO,
		                    e.INJT_STER_CMMD_YN,
		                    e.NTM_RFLC_YN
		              from
		                    SDPORDBAT a,
		                    APPTPTNTT b,
		                    SDPORDDEV d,
		                    MDMEDORDT h,
		                    APRCRPTNT c,
		                    SDDDGCDMT e,
		                    SDDMETCDT f,
		                    CCUSRDPHT g,
		                    CCUSERAMV g2,
		                    SDJFIXQTT i,
		                    MNEERRPAT j
		             where
		                    a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')        /* 처방일자             */
		               and  instr(#{mdtnNoDvsnCd}, a.MDTN_NO_DVSN_CD) > 0     /* 처방형태구분         */
		               and  a.MDTN_NO     >= #{mdtnNo1}                        /* 투약번호             */
		               and  a.MDTN_NO     <= #{mdtnNo2}                        /* 투약번호             */
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		               and  a.WARD_CD      = nvl(#{wardCd}, a.WARD_CD)                 /* 병동                 */
		               and  b.PTNO = a.PTNO                                           /* 환자번호             */
		               and  d.ORDR_YMD            = a.ORDR_YMD                        /* 처방일자             */
		               and  d.MDTN_NO_DVSN_CD     = a.MDTN_NO_DVSN_CD                 /* 투약번호구분         */
		               and  d.MDTN_NO             = a.MDTN_NO                         /* 투약번호             */
		               and  d.MDTN_LCDV_CD        = a.MDTN_LCDV_CD                    /* 투약위치             */
		               and  nvl(d.INJC_PLAC_CD,'*')        = nvl(#{injcPlacCd},nvl(d.INJC_PLAC_CD,'*')) /* 주사장소             */
		               and  (
		                        ((instr(#{afiOdkiNm}, 'D') > 0) and (   d.BSIS_CMMD_PLAC_CD in ('1','2','3','4','5','6')
		                                                                                or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD != '2'))
		                                                                           and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                                                                INDEX (B1, SDJDGRTNT_I06)  */
		                                                                                         'Y'
		                                                                                   from
		                                                                                        MDMEDORDT a1,
		                                                                                        SDJDGRTNT b1
		                                                                                  where
		                                                                                        a1.PTNO = h.PTNO
		                                                                                    and a1.ORDR_YMD = h.ORDR_YMD
		                                                                                    and a1.ORDR_SNO = h.ORDR_SNO
		                                                                                    and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                                                                    and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                                                                         or
		                                                                                           nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                                                                    and a1.ORDR_YMD = b1.ORDR_YMD
		                                                                                    and a1.PTNO = b1.PTNO
		                                                                                    and a1.ORDR_SNO = b1.ORDR_SNO
		                                                                                    and b1.DRUG_RTRE_CD = '7'
		                                                                                    and rownum = 1
		                                                                                ),'N') <> 'Y'
		                                                                              )
		                        or
		                        ((instr(#{afiOdkiNm}, 'I') > 0) and (
		                                      (
		                                        (d.BSIS_CMMD_PLAC_CD = '7') /* 외래주사(6개부서)의 경우 실시일자가 당일,익일이고 수납된 것만 출력 */
		                                        and
		                                        (
		                                            (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                (d.INJC_PLAC_CD in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                                and
		                                                (
		                                                    ( /* 당일수납 + 당일,익일 실시예정 */
		                                                        (d.PHRM_IMPL_YMD between trunc(sysdate) and trunc(sysdate) + 1)
		                                                        and
		                                                        (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                    )
		                                                    or
		                                                    ( /* 간호에서 실시예정 바꾼경우(이전수납,당일실시예정) */
		                                                        (d.PHRM_IMPL_YMD = trunc(sysdate))
		                                                        and
		                                                        (d.RCPC_DT < trunc(sysdate))
		                                                    )
		                                                    or
		                                                    ( /* 실시예정일 지나서 수납한건 */
		                                                        (d.PHRM_IMPL_YMD < trunc(sysdate))
		                                                        and
		                                                        (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                    )
		                                                )
		                                            )
		                                            or
		                                            (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                (d.INJC_PLAC_CD not in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                            )
		                                        )
		                                    )
		                                  or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD = '2')
		                                or (d.BSIS_CMMD_PLAC_CD = 'B' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')) /* 2006.08.14 자가주사 항암제 추가. */
		                               )
		                           and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                INDEX (B1, SDJDGRTNT_I06)  */
		                                         'Y'
		                                   from
		                                        MDMEDORDT a1,
		                                        SDJDGRTNT b1
		                                  where
		                                        a1.PTNO = h.PTNO
		                                    and a1.ORDR_YMD = h.ORDR_YMD
		                                    and a1.ORDR_SNO = h.ORDR_SNO
		                                    and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                    and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                         or
		                                           nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                    and a1.ORDR_YMD = b1.ORDR_YMD
		                                    and a1.PTNO = b1.PTNO
		                                    and a1.ORDR_SNO = b1.ORDR_SNO
		                                    and b1.DRUG_RTRE_CD = '7'
		                                    and rownum = 1
		                                ),'N') <> 'Y'
		                        )
		                        or
		                        ((instr(#{afiOdkiNm}, 'C') > 0)
		                            and (((d.BSIS_CMMD_PLAC_CD in ('8','B'))
		                                 and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H') and d.PHRM_IMPL_YMD = trunc(sysdate))
		                                   or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))
		                                 or
		                                (d.BSIS_CMMD_PLAC_CD = '7' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')
		                                 and exists (
		                                        select 'X'
		                                          from  SDPORDDEV z
		                                         where z.ORDR_YMD          = d.ORDR_YMD
		                                           and z.MDTN_NO_DVSN_CD   = d.MDTN_NO_DVSN_CD
		                                           and z.MDTN_NO           = d.MDTN_NO
		                                           and z.MDTN_LCDV_CD      = d.MDTN_LCDV_CD
		                                           and z.PHDP_CMMD_BNDL_NO = d.PHDP_CMMD_BNDL_NO
		                                           and z.BSIS_CMMD_PLAC_CD = 'B')
		                                    )
		                                 )
		                            and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                 INDEX (B1, SDJDGRTNT_I06) */
		                                          'Y'
		                                    from
		                                         MDMEDORDT a1,
		                                         SDJDGRTNT b1
		                                   where
		                                         a1.PTNO = h.PTNO
		                                     and a1.ORDR_YMD = h.ORDR_YMD
		                                     and a1.ORDR_SNO = h.ORDR_SNO
		                                     and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                     and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                          or
		                                            nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                     and a1.ORDR_YMD = b1.ORDR_YMD
		                                     and a1.PTNO = b1.PTNO
		                                     and a1.ORDR_SNO = b1.ORDR_SNO
		                                     and b1.DRUG_RTRE_CD = '7'
		                                     and rownum = 1
		                                 ),'N') <> 'Y'
		                        )    /* 주사제실 처방전     */
		                        or
		                        ((instr(#{afiOdkiNm}, 'S') > 0) and (d.BSIS_CMMD_PLAC_CD = '9') and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H') and d.PHRM_IMPL_YMD
		                                                = trunc(sysdate)) or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))    /* 주사제실 처방전     */
		                        or
		                        ((instr(#{afiOdkiNm}, 'T') > 0) and (d.BSIS_CMMD_PLAC_CD = 'T'))           /* 임상시험약 약처방전 */
		                        or
		                        ((instr(#{afiOdkiNm}, 'U') > 0) and (d.BSIS_CMMD_PLAC_CD in ('U','V')))    /* 임상시험약 주사처방전 */
		                    )
		               and  h.PTNO     = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = d.ORDR_SNO
		               and  c.MDRP_NO  = h.MDRP_NO
		               and  e.MDPR_CD  = d.MDPR_CD                      /* 약품코드            */
		               and  (
		                        (nvl(e.OTPT_PHRM_RQST_YN, 'N') != 'Y')
		                      or
		                        (
		                            (nvl(e.OTPT_PHRM_RQST_YN, 'N') = 'Y')
		                            and
		                              (d.MDTN_NO_DVSN_CD in ('B', 'E', 'F', 'Q', 'H', 'I', 'S', 'G'))
		                        )
		                    )
		               and  f.DRUS_CD(+) = d.DRUS_CD                  /* 용법                */
		               and  g.USER_ID(+) = a.ODDR_ID                  /* 처방의(외래,병동)   */
		               and  g2.LGIN_ID   = g.LGIN_ID
		               and  i.DPRT_CD(+) = d.INJC_PLAC_CD
		               and  i.MDPR_CD(+) = d.MDPR_CD
		               and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		               and  j.PTNO(+)    = a.PTNO                     /* 응급간호환자번호     */
		               and  j.COHS_DT(+) = a.MDCR_YMD                 /* 응급간호환자번호     */
		               and  (
		                            (d.MDTN_NO_DVSN_CD = 'O' and d.BSIS_CMMD_PLAC_CD = 'B' and d.INVN_TOTL_QTY
		                                           > fn_sd_getrtnqty_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO))
		                         or (d.MDTN_NO_DVSN_CD != 'O' or d.BSIS_CMMD_PLAC_CD != 'B')
		                    )
		          union all
		            select  /*+ NO_EXPAND LEADING(A, B) USE_NL(A, B, C, D, E, G, G2) INDEX_SS(A, SDPORDBAT_PK) */
		                    to_char(a.ORDR_YMD, 'YYYYMMDD')     ,           /* 처방일자             */
		                    a.MDTN_NO_DVSN_CD                           ,           /* 처방형태구분         */
		                    lpad(to_char(a.MDTN_NO), 4, '0')    AFI_MDTN_NO_STR,    /* 투약번호             */
		                    b.ORDR_SNO                          ,           /* 처방번호             */
		                    b.ORDR_CD                           ,           /* 약품코드             */
		                    b.CODV_CD                           PTDV_CD,              /* 환자구분             */
		                    b.MDPR_CLSF_CD,            /* 약분류               */
		                    b.DRAP_DVSN_CD,            /* 약적용구분           */
		                    b.DRUG_ORDR_PRSS_CD                 CMMD_STTS_CD,         /* 조제 STATUS          */
		                    decode(b.DRAP_DVSN_CD,'2',b.PCKN_UNAD_QTY,round(b.PCKN_UNAD_QTY,2))  PCKN_UNAD_QTY,   /* 투여량(포장)         */
		                    b.PCUN_CD,           /* 단위(포장)           */
		                    decode(b.DRAP_DVSN_CD,'2',b.ICUN_ADMN_VLM,round(b.ICUN_ADMN_VLM,2))  ICUN_ADMN_VLM,   /* 투여량(함량)         */
		                    b.ICUN_CD,           /* 단위(함량)           */
		                    b.SLCT_UNIT_DVSN_CD,           /* 투여량TYPE           */
		                    b.DDCN                              MDTN_DDCN,               /* 일수                 */
		                    b.DRUS_CD,           /* 용법                 */
		                    b.NTM       MDNT,                /* 횟수                 */
		                    null                                TOTL_CLCL_QTY,             /* 총량(계산)           */
		                    null                                INVN_TOTL_QTY,           /* 총량(계산)           */
		                    null                                PHDP_CMMD_BNDL_NO,            /* 약제부 묶음번호       */
		                    b.DRBN_NO,           /* 약묶음번호           */
		                    b.MIX_KIND_CD                       ,            /* MIX종류              */
		                    null                                BSIS_CMMD_PLAC_CD,            /* 조제장소             */
		                    replace(replace(b.DRUG_ORDR_UNSL_CTN,chr(13)||chr(10),''),chr(10),'')  SPSB_CTN,          /* 특기사항             */
		                    null                                FDNO_YN,              /* 정수품유무 */
		                    null                                ISDV_CD,             /* 보험구분(수납시)     */
		                    null                                DRUG_ORDR_INPT_DT,          /* 입력일시             */
		                    b.SDPF_EXRE_CD,           /* 의약분업예외사유코드 */
		                    null                                INJC_PLAC_CD,            /* 주사장소             */
		                    null                                OHOR_RTRN_YN,        /* 원외처방반납여부     */
		                    null                                BEMD_NO,             /* 투석실 처방번호      */
		                    null                                ATTR_NO,           /* AUTO TRACK번호       */
		                    null                                DURV_RESN_CTN,             /* 상호작용 comment     */
		                    a.PTNO                              ,              /* 환자번호             */
		                    null                                RPTN_DT,           /* 접수일시             */
		                    b.MCDP_CD                           ,            /* 진료과               */
		                    b.WARD_CD                           ,             /* 병동                 */
		                    b.ODDR_ID                           ,              /* 처방의(외래,병동)    */
		                    b.CHDR_ID  GNDR_ID                  ,              /* 주치의(병동)         */
		                    b.RCST_CD                           RCPC_YN,              /* 수납구분             */
		                    null                                UPDT_BEMD_NO,           /* 수정전 투약번호      */
		                    null                                DRUG_INJC_DVSN_CD,               /* 약주사구분           */
		                    a.PHDP_OROC_DPRT_CD                           ,           /* 처방발생원           */
		                    null                                TKMD_CCHN_YN,            /* 복약지도여부         */
		                    null                                IHOH_DVSN_CD,            /* 원내외구분           */
		                    null                                NRDR_YN,             /* 마약여부             */
		                    null                                PSDG_YN,            /* 향정여부             */
		                    null                                CLNC_YN,           /* 임상여부             */
		                    to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD,    /* 입원일자(내원일시)   */
		                    '[지참약]'||e.MDPR_NM               MDPR_NM,           /* 약품명               */
		                    null                                ENVL_MEMO_CTN1,            /* 봉투1                */
		                    null                                ENVL_MEMO_CTN2,            /* 봉투2                */
		                    d.PTNT_NM                           ,            /* 환자명               */
		                    d.FRRN                              ,             /* 주민번호1            */
		                    d.BRRN                              ,             /* 주민번호2            */
		                    trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'('||
		                        trunc(mod(months_between(a.ORDR_YMD, d.BTDT),12))||')' AFI_AGE_VL_STR,  /* 나이                 */
		                    d.GEND_CD                           ,                /* 성별                 */
		                    b.ISTY_CD                           ,             /* 급여종별코드         */
		                    ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                        from CCCMCDDMT F_A, CCCMCDDLT F_B
		                       where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                         and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                         and F_A.COMN_GRP_CD = 'AI003'
		                         and F_A.COMN_DTLS_CD =  b.ISTY_CD
		                         and F_B.LNGG_CD(+) = nvl( '', '*') ) ISTY_CDNM,           /* 급여종별이름         */
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.ODDR_ID )           ODDR_IDNM,            /* 처방의(외래,병동)    */
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.GNDR_ID )           GNDR_IDNM,            /* 주치의(병동)         */
		                    'N'                       SBSN_MDPR_ABSL_DSLW_YN,            /* 대체약품절대불가     */
		                    g2.USER_LCNS_NO                     ,             /* 면허번호             */
		                    ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                        from CCCMCDDMT F_A, CCCMCDDLT F_B
		                       where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                         and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                         and F_A.COMN_GRP_CD = 'SD003'
		                         and F_A.COMN_DTLS_CD =  e.KPNG_PLAC_CD
		                         and F_B.LNGG_CD(+) = nvl( '', '*') ) KPNG_PLAC_NM,           /* 보관장소             */
		                    c.PTRM_NO                            ,             /* 병실번호             */
		                    '' VALD_HH                           ,            /* 유효시간             */
		                    nvl(e.RELS_YN, 'N')                   RELS_YN,              /* 청구약품여부         */
		                    null                                WARD_LABL_PRIN_YN,              /* 출력여부             */
		                    ''                                  EDI_CD,            /* EDI코드              */
		                    ''                                  ISTY_ASST_CD,             /* 유형보조             */
		                    ''                                  SCIN_CD,           /* 상병코드             */
		                    null                                MDTN_STRT_YMD,        /* 실시일자    */
		                    ''                                  SCIN_NM,           /* 상병명               */
		                    a.MDTN_NO                           MDTN_NO_3,             /* 투약번호             */
		                    ''                                  AFI_IPDV_NM,            /* 계산내역급여구분     */
		                    ''                                  ACKN_EDI_CD,           /* 계산내역EDI코드      */
		                    ''                                  PTNT_TYPE_NM_2,            /* 계산내역환자유형     */
		                    ''                                  AFI_ISTY_ASST_NM_2,            /* 계산내역유형보조     */
		                    ''                                  CANC_MDTE_ANTC_YN,           /* 소아항암여부         */
		                    e.STST_DVSN_CD                           ,            /* 통계구분             */
		                    'Y'                                 ATMT_CLAM_YN,             /* 자동출력여부         */
		                    e.WSCN_SNGN_YN                      ,           /* 수제단독             */
		                    d.NTNL_CD                           ,            /* 외국인코드           */
		                    e.PCUN_INLS_QTY                     ,           /* 함량(마스터)         */
		                    ''                                  AFI_MDPR_ORLM_AGE_DDCN_STR,  /* 연령별처방제한문구   */
		                    null                                ERRM_LCTN_CD,         /*응급실내 환자세부위치 */
		                    e.KORN_PDCT_NM                      ,           /* 한글상품명            */
		                    '[지참약]'||e.SMRY_MDPR_NM          SMRY_MDPR_NM,          /* 라벨 출력용 요약상품명 */
		                    'Y'                                 SELF_MDTN_YN,         /* Self Medication 여부  */
		                    2                                   SELFSEQ,            /* Self Medication 용 순서 */
		                    a.MDTN_LCDV_CD                      ,          /* 투약위치               */
		                    decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN,         /* 임상시험약 여부     */
		                    b.FRNS_CTRL_DVSN_CD          ,
		                    'N'                                 AUDT_YN,
		                    ''                                  AFI_ORDR_AUDT_DVSN_NM,
		                    0                                   AUDSORTSEQ,
		                    ''                                  TRGT_MDPR_CD,
		                    ''                                  AUDT_RSLT_DVSN_CD,
		                    ''                                  AUDT_RSLT_RMRK_CTN,
		                    decode(g2.PDA_NO,'','','(8-'||g2.PDA_NO||')')  CFDR_PDA_NO,
		                    e.HGRS_HGCC_MDPR_YN,
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.ODDR_ID ) ODDR_NM,
		                    c.MDRP_NO,
		                    e.INJT_STER_CMMD_YN,
		                    e.NTM_RFLC_YN
		              from
		                    SDPORDBAT a,
		                    MDMEDORDT b,
		                    APRCRPTNT c,
		                    APPTPTNTT d,
		                    SDDDGCDMT e,
		                    CCUSRDPHT g,
		                    CCUSERAMV g2
		             where
		                    a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD') /* 처방일자             */
		               and  instr(#{mdtnNoDvsnCd}, a.MDTN_NO_DVSN_CD) > 0          /* 처방형태구분         */
		               and  (
		                            (instr(#{mdtnNoDvsnCd}, 'A') > 0)
		                         or (instr(#{mdtnNoDvsnCd}, 'B') > 0)
		                         or (instr(#{mdtnNoDvsnCd}, 'C') > 0)
		                         or (instr(#{mdtnNoDvsnCd}, 'E') > 0)
		                    )
		               and  a.MDTN_NO >= #{mdtnNo1}           /* 투약번호             */
		               and  a.MDTN_NO <= #{mdtnNo2}           /* 투약번호             */
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		               and  b.PTNO = a.PTNO                              /* 환자번호             */
		               and  b.ORDR_YMD = a.ORDR_YMD                      /* 처방일자             */
		               and  b.ORFR_CD = 'S'                               /* Self Medication 조건 */
		               and  b.TMPR_ORDR_YN = 'Y'                          /* Self Medication 조건 */
		               and  nvl(b.DC_DVSN_CD,'N') in ('Y', 'N')                  /* 삭제처방             */
		               and  c.MDRP_NO  = b.MDRP_NO
		               and  d.PTNO = a.PTNO                                /* 환자번호             */
		               and  e.MDPR_CD  = b.ORDR_CD                         /* 약품코드            */
		               and  g.USER_ID(+) = a.ODDR_ID                     /* 처방의(외래,병동)    */
		               and  g2.LGIN_ID   = g.LGIN_ID
		          union all
		            select  /*+ NO_EXPAND LEADING(X, A, D, H) USE_NL(A, B, D, E, F, G, G2, H, C, I, J, Y) INDEX_SS(A, SDPORDBAT_PK) OPT_PARAM('_OPTIMIZER_COST_BASED_TRANSFORMATION','OFF') */
		                    to_char(a.ORDR_YMD, 'YYYYMMDD') ORDR_YMD,           /* 처방일자             */
		                    a.MDTN_NO_DVSN_CD,                                /* 처방형태구분         */
		                    lpad(to_char(a.MDTN_NO), 4, '0') AFI_MDTN_NO_STR,               /* 투약번호             */
		                    d.ORDR_SNO ,                                /* 처방번호             */
		                    d.MDPR_CD ,                                /* 약품코드             */
		                    a.PTDV_CD ,                                      /* 환자구분             */
		                    d.MDPR_CLSF_CD,                                  /* 약분류               */
		                    d.DRAP_DVSN_CD,                                  /* 약적용구분           */
		                    d.CMMD_STTS_CD,                            /* 조제 STATUS          */
		                    decode(d.DRAP_DVSN_CD,'2',d.PCKN_UNAD_QTY,round(d.PCKN_UNAD_QTY,2)) PCKN_UNAD_QTY,   /* 투여량(포장)         */
		                    d.PCUN_NM   PCUN_CD,                                /* 단위(포장)           */
		                    decode(d.DRAP_DVSN_CD,'2',d.ICUN_ADMN_VLM,round(d.ICUN_ADMN_VLM,2)) ICUN_ADMN_VLM,   /* 투여량(함량)         */
		                    d.ICUN_CD ,                                /* 단위(함량)           */
		                    d.SLCT_UNIT_DVSN_CD ,                                /* 투여량TYPE           */
		                    d.MDTN_DDCN ,                                         /* 일수                 */
		                    d.DRUS_CD ,                                /* 용법                 */
		                    d.MDNT  ,                                          /* 횟수                 */
		                    decode(d.DRAP_DVSN_CD,'2',d.TOTL_CLCL_QTY,round(d.TOTL_CLCL_QTY,2)) TOTL_CLCL_QTY,     /* 총량(계산)           */
		                    decode(d.DRAP_DVSN_CD,'2',d.INVN_TOTL_QTY,round(d.INVN_TOTL_QTY,2)) INVN_TOTL_QTY,     /* 총량(계산)           */
		                    d.PHDP_CMMD_BNDL_NO ,                                  /* 약제부 묶음번호       */
		                    d.DRBN_NO ,                                /* 약묶음번호           */
		                    d.MIX_KIND_CD ,                                  /* MIX종류              */
		                    d.BSIS_CMMD_PLAC_CD ,                                  /* 조제장소             */
		                    replace(replace(d.SPSB_CTN,chr(13)||chr(10),''),chr(10),'')   SPSB_CTN,                                    /* 특기사항             */
		                    null            as FDNO_YN, /* 정수품유무 */
		                    d.ISDV_CD ,                                          /* 보험구분(수납시)     */
		                    to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT,          /* 입력일시             */
		                    d.SDPF_EXRE_CD ,                                   /* 의약분업예외사유코드 */
		                    d.INJC_PLAC_CD ,                                    /* 주사장소             */
		                    d.OHOR_RTRN_YN ,                                /* 원외처방반납여부     */
		                    d.BEMD_NO  ,                                         /* 투석실 처방번호      */
		                    d.ATTR_NO ,                                        /* AUTO TRACK번호       */
		                    case
		                        when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                        when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                        when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                    end     DURV_RESN_CTN,                                            /* 상호작용 comment     */
		                    a.PTNO ,                                              /* 환자번호             */
		                    to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT,      /* 접수일시             */
		                    a.MCDP_CD ,                                         /* 진료과               */
		                    a.WARD_CD ,                                          /* 병동                 */
		                    a.ODDR_ID ,                                           /* 처방의(외래,병동)    */
		                    a.GNDR_ID ,                                           /* 주치의(병동)         */
		                    a.RCPC_YN ,                                           /* 수납구분             */
		                    a.UPDT_BEMD_NO ,                                   /* 수정전 투약번호      */
		                    a.DRUG_INJC_DVSN_CD ,                                  /* 약주사구분           */
		                    a.PHDP_OROC_DPRT_CD ,                                        /* 처방발생원           */
		                    a.TKMD_CCHN_YN ,                                    /* 복약지도여부         */
		                    a.IHOH_DVSN_CD ,                                    /* 원내외구분           */
		                    a.NRDR_YN ,                                          /* 마약여부             */
		                    a.PSDG_YN ,                                         /* 향정여부             */
		                    a.CLNC_YN ,                                        /* 임상여부             */
		                    to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD,      /* 입원일자(내원일시)   */
		                    e.MDPR_NM ,                                        /* 약품명               */
		                    decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN1
		                                                       , f.ENVL_MEMO_CTN1) ENVL_MEMO_CTN1, /* 봉투1                */
		                    decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN2
		                                                       , f.ENVL_MEMO_CTN2) ENVL_MEMO_CTN2, /* 봉투2                */
		                    b.PTNT_NM ,                                         /* 환자명               */
		                    b.FRRN ,                                             /* 주민번호1            */
		                    b.BRRN ,                                             /* 주민번호2            */
		                    trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||trunc(mod(months_between(a.ORDR_YMD, b.BTDT),12))||')' AFI_AGE_VL_STR,
		                    b.GEND_CD ,                                             /* 성별                 */
		                    h.ISTY_CD ,                                          /* 급여종별코드         */
		                    ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                        from CCCMCDDMT F_A, CCCMCDDLT F_B
		                       where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                         and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                         and F_A.COMN_GRP_CD = 'AI003'
		                         and F_A.COMN_DTLS_CD =  h.ISTY_CD
		                         and F_B.LNGG_CD(+) = nvl( '', '*') ) ISTY_CDNM,       /* 급여종별이름         */
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ODDR_ID ) ODDR_IDNM,   /* 처방의(외래,병동)    */
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.GNDR_ID ) GNDR_IDNM,   /* 주치의(병동)         */
		                    'N' SBSN_MDPR_ABSL_DSLW_YN,                /* 대체약품절대불가     */
		                    g2.USER_LCNS_NO  USER_LCNS_NO,                                   /* 면허번호             */
		                    ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                        from CCCMCDDMT F_A, CCCMCDDLT F_B
		                       where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                         and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                         and F_A.COMN_GRP_CD = 'SD003'
		                         and F_A.COMN_DTLS_CD =  e.KPNG_PLAC_CD
		                         and F_B.LNGG_CD(+) = nvl( '', '*') ) KPNG_PLAC_NM,       /* 보관장소             */
		                    c.PTRM_NO ,                                          /* 병실번호             */
		                    '' VALD_HH ,                                         /* 유효시간             */
		                    nvl(e.RELS_YN, 'N')    RELS_YN,                              /* 청구약품여부         */
		                    d.WARD_LABL_PRIN_YN    ,                              /* 출력여부             */
		                    '' EDI_CD,                                                /* EDI코드              */
		                    '' ISTY_ASST_CD,                                                 /* 유형보조             */
		                    '' SCIN_CD,                                                /* 상병코드             */
		                    to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') MDTN_STRT_YMD,  /* 실시일자    */
		                    '' SCIN_NM,                                                /* 상병명               */
		                    a.MDTN_NO MDTN_NO_3,                                          /* 투약번호             */
		                    '' AFI_IPDV_NM,                                             /* 계산내역급여구분     */
		                    '' ACKN_EDI_CD,                                             /* 계산내역EDI코드      */
		                    '' PTNT_TYPE_NM_2,                                          /* 계산내역환자유형     */
		                    '' AFI_ISTY_ASST_NM_2,                                      /* 계산내역유형보조     */
		                    '' CANC_MDTE_ANTC_YN,                                       /* 소아항암여부         */
		                    e.STST_DVSN_CD ,                                    /* 통계구분             */
		                    'Y' ATMT_CLAM_YN,                                                /* 자동출력여부         */
		                    e.WSCN_SNGN_YN ,                                   /* 수제단독             */
		                    b.NTNL_CD      ,                                    /* 외국인코드           */
		                    e.PCUN_INLS_QTY  ,                                 /* 함량(마스터)         */
		                    '' AFI_MDPR_ORLM_AGE_DDCN_STR,
		                    (select ERRM_ZONE_NM||'('||substr(fn_mn_patwardtelno_s(c.MDRP_NO),-4)||')' from MNEERRMZT where ERRM_LCTN_CD=j.ERRM_LCTN_CD) ERRM_LCTN_CD, /*응급실내 환자세부위치 */
		                    e.KORN_PDCT_NM   ,                                  /* 한글상품명            */
		                    e.SMRY_MDPR_NM  ,                                           /* 라벨 출력용 요약상품명 */
		                    'N'                  SELF_MDTN_YN,                            /* Self Medication 여부  */
		                    1                    SELFSEQ,                               /* Self Medication 용 순서 */
		                    a.MDTN_LCDV_CD       ,                             /* 투약위치               */
		                    decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN  ,                            /* 임상시험약 여부     */
		                    h.FRNS_CTRL_DVSN_CD  ,
		                    'Y'                                                                 AUDT_YN,
		                    y.DETL_CD_NM                                                        AFI_ORDR_AUDT_DVSN_NM,
		                    y.SCRN_DSPL_SQNC                                                    AUDSORTSEQ,
		                    x.TRGT_MDPR_CD1||decode(x.TRGT_MDPR_CD2, null, null, '-'||x.TRGT_MDPR_CD2)  TRGT_MDPR_CD,
		                    x.TRGT_AUDT_VL1||decode(x.TRGT_AUDT_VL2, null, null, '-'||x.TRGT_AUDT_VL2)  AUDT_RSLT_DVSN_CD,
		                    x.AUDT_RMRK_CTN                                                AUDT_RSLT_RMRK_CTN,
		                    decode(g2.PDA_NO,'','','(8-'||g2.PDA_NO||')')  CFDR_PDA_NO,
		                    e.HGRS_HGCC_MDPR_YN,
		                    ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM,
		                    c.MDRP_NO,
		                    e.INJT_STER_CMMD_YN,
		                    e.NTM_RFLC_YN
		              from
		                    SDAAUDRPT x,
		                    SDPORDBAT a,
		                    APPTPTNTT b,
		                    SDPORDDEV d,
		                    SDDDGCDMT e,
		                    SDDMETCDT f,
		                    CCUSRDPHT g,
		                    CCUSERAMV g2,
		                    MDMEDORDT h,
		                    APRCRPTNT c,
		                    SDJFIXQTT i,
		                    MNEERRPAT j,
		                    CCCMCDDMT y
		             where
		                    #{audtYn} is not null
		               and  x.TRGT_ORDR_YMD1 = to_date(#{ordrYmd} , 'YYYYMMDD')             /* 처방일자             */
		               and  instr(#{mdtnNoDvsnCd} , x.TRGT_MDTN_NO_DVSN_CD1) > 0          /* 처방형태구분         */
		               and  x.TRGT_MDTN_NO1 >= #{mdtnNo1}                                 /* 투약번호             */
		               and  x.TRGT_MDTN_NO1 <= #{mdtnNo2}                                 /* 투약번호             */
		               and  x.TRGT_MDTN_LCDV_CD1 = decode(#{mdtnLcdvCd} , null, x.TRGT_MDTN_LCDV_CD1
		                             , 'A', x.TRGT_MDTN_LCDV_CD1, #{mdtnLcdvCd} ) /* 투약위치 */
		               and  x.AUDT_TYPE_CD not in ('011', '201243', '991')
		               and  exists  (
		                            select  /*+ NO_UNNEST PUSH_SUBQ */
		                                    'Z'
		                              from
		                                    SDAAUDRPT z
		                             where
		                                    z.TRGT_ORDR_YMD1        = x.TRGT_ORDR_YMD1
		                               and  z.TRGT_MDTN_NO_DVSN_CD1 = x.TRGT_MDTN_NO_DVSN_CD1
		                               and  z.TRGT_MDTN_NO1         = x.TRGT_MDTN_NO1
		                               and  z.TRGT_MDTN_LCDV_CD1    = x.TRGT_MDTN_LCDV_CD1
		                               and  substr(z.AUDT_TYPE_CD, 1, 2) not in ('01', '02', '99')
		                            )
		               and  a.ORDR_YMD = x.TRGT_ORDR_YMD1
		               and  a.MDTN_NO_DVSN_CD = x.TRGT_MDTN_NO_DVSN_CD1
		               and  a.MDTN_NO = x.TRGT_MDTN_NO1
		               and  a.MDTN_LCDV_CD = x.TRGT_MDTN_LCDV_CD1
		               and  a.WARD_CD = nvl(#{wardCd}, a.WARD_CD)             /* 병동                 */
		               and  b.PTNO = a.PTNO                                  /* 환자번호             */
		               and  d.ORDR_YMD = a.ORDR_YMD                          /* 처방일자             */
		               and  d.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD            /* 투약번호구분         */
		               and  d.MDTN_NO = a.MDTN_NO                            /* 투약번호             */
		               and  d.MDTN_LCDV_CD = a.MDTN_LCDV_CD                  /* 투약위치             */
		               and  d.ORDR_SNO = x.TRGT_ORDR_SNO1
		               and  nvl(d.INJC_PLAC_CD,'*') = nvl(#{injcPlacCd} , nvl(d.INJC_PLAC_CD,'*'))       /* 주사장소             */
		               and  (
		                        ((instr(#{afiOdkiNm}, 'D') > 0) and (    d.BSIS_CMMD_PLAC_CD in ('1','2','3','4','5','6')
		                                                                                or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD != '2'))
		                                                                           and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                                                                INDEX (B1, SDJDGRTNT_I06)*/
		                                                                                         'Y'
		                                                                                   from
		                                                                                        MDMEDORDT a1,
		                                                                                        SDJDGRTNT b1
		                                                                                  where
		                                                                                        a1.PTNO = h.PTNO
		                                                                                    and a1.ORDR_YMD = h.ORDR_YMD
		                                                                                    and a1.ORDR_SNO = h.ORDR_SNO
		                                                                                    and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                                                                    and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                                                                         or
		                                                                                           nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                                                                    and a1.ORDR_YMD = b1.ORDR_YMD
		                                                                                    and a1.PTNO = b1.PTNO
		                                                                                    and a1.ORDR_SNO = b1.ORDR_SNO
		                                                                                    and b1.DRUG_RTRE_CD = '7'
		                                                                                    and rownum = 1
		                                                                                ),'N') <> 'Y'
		                                                                                )
		                        or
		                        ((instr(#{afiOdkiNm} , 'I') > 0) and (
		                                                              (
		                                                                (d.BSIS_CMMD_PLAC_CD = '7') /* 외래주사(6개부서)의 경우 실시일자가 당일,익일이고 수납된 것만 출력 */
		                                                                and
		                                                                (
		                                                                    (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                                        (d.INJC_PLAC_CD in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                                                        and
		                                                                        (
		                                                                            ( /* 당일수납 + 당일,익일 실시예정 */
		                                                                                (d.PHRM_IMPL_YMD between trunc(sysdate) and trunc(sysdate) + 1)
		                                                                                and
		                                                                                (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                                            )
		                                                                            or
		                                                                            ( /* 간호에서 실시예정 바꾼경우(이전수납,당일실시예정) */
		                                                                                (d.PHRM_IMPL_YMD = trunc(sysdate))
		                                                                                and
		                                                                                (d.RCPC_DT < trunc(sysdate))
		                                                                            )
		                                                                            or
		                                                                            ( /* 실시예정일 지나서 수납한건 */
		                                                                                (d.PHRM_IMPL_YMD < trunc(sysdate))
		                                                                                and
		                                                                                (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                                            )
		                                                                        )
		                                                                    )
		                                                                    or
		                                                                    (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                                        (d.INJC_PLAC_CD not in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                                                    )
		                                                                )
		                                                            )
		                                                          or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD = '2')
		                                                        or (d.BSIS_CMMD_PLAC_CD = 'B' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')) /* 2006.08.14 자가주사 항암제 추가. */
		                                                       )
		                                               and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                                    INDEX (B1, SDJDGRTNT_I06) */
		                                                            'Y'
		                                                      from
		                                                           MDMEDORDT a1,
		                                                           SDJDGRTNT b1
		                                                     where
		                                                           a1.PTNO = h.PTNO
		                                                       and a1.ORDR_YMD = h.ORDR_YMD
		                                                       and a1.ORDR_SNO = h.ORDR_SNO
		                                                       and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                                       and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                                            or
		                                                              nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                                       and a1.ORDR_YMD = b1.ORDR_YMD
		                                                       and a1.PTNO = b1.PTNO
		                                                       and a1.ORDR_SNO = b1.ORDR_SNO
		                                                       and b1.DRUG_RTRE_CD = '7'
		                                                       and rownum = 1
		                                                   ),'N') <> 'Y'
		                        )
		                        or
		                        ((instr(#{afiOdkiNm}, 'C') > 0)
		                            and (((d.BSIS_CMMD_PLAC_CD in ('8','B'))
		                                 and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H') and d.PHRM_IMPL_YMD = trunc(sysdate))
		                                   or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))
		                                 or
		                                (d.BSIS_CMMD_PLAC_CD = '7' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')
		                                 and exists (
		                                    select 'X'
		                                      from SDPORDDEV z
		                                     where z.ORDR_YMD = d.ORDR_YMD
		                                       and z.MDTN_NO_DVSN_CD = d.MDTN_NO_DVSN_CD
		                                       and z.MDTN_NO = d.MDTN_NO
		                                       and z.MDTN_LCDV_CD = d.MDTN_LCDV_CD
		                                       and z.PHDP_CMMD_BNDL_NO = d.PHDP_CMMD_BNDL_NO
		                                       and z.BSIS_CMMD_PLAC_CD = 'B')
		                                ))
		                           and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                INDEX (B1, SDJDGRTNT_I06) */
		                                         'Y'
		                                   from
		                                        MDMEDORDT a1,
		                                        SDJDGRTNT b1
		                                  where
		                                        a1.PTNO = h.PTNO
		                                    and a1.ORDR_YMD = h.ORDR_YMD
		                                    and a1.ORDR_SNO = h.ORDR_SNO
		                                    and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                    and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                         or
		                                           nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                    and a1.ORDR_YMD = b1.ORDR_YMD
		                                    and a1.PTNO = b1.PTNO
		                                    and a1.ORDR_SNO = b1.ORDR_SNO
		                                    and b1.DRUG_RTRE_CD = '7'
		                                    and rownum = 1
		                                ),'N') <> 'Y'
		                        )   /* 주사제실 처방전     */
		                        or
		                        ((instr(#{afiOdkiNm}, 'S') > 0) and (d.BSIS_CMMD_PLAC_CD = '9') and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H')
		                                          and d.PHRM_IMPL_YMD = trunc(sysdate)) or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))    /* 주사제실 처방전     */
		                        or
		                        ((instr(#{afiOdkiNm}, 'T') > 0) and (d.BSIS_CMMD_PLAC_CD = 'T'))    /* 임상시험약 약처방전 */
		                        or
		                        ((instr(#{afiOdkiNm}, 'U') > 0) and (d.BSIS_CMMD_PLAC_CD in ('U','V')))    /* 임상시험약 주사처방전 */
		                    )
		               and  e.MDPR_CD = d.MDPR_CD                      /* 약품코드            */
		               and  (
		                        (nvl(e.OTPT_PHRM_RQST_YN, 'N') != 'Y')
		                        or
		                        (
		                            (nvl(e.OTPT_PHRM_RQST_YN, 'N') = 'Y')
		                            and
		                              (d.MDTN_NO_DVSN_CD in ('B', 'E', 'F', 'Q', 'H', 'I', 'S', 'G'))
		                        )
		                    )
		               and  f.DRUS_CD(+) = d.DRUS_CD                     /* 용법                */
		               and  g.USER_ID(+) = a.ODDR_ID                     /* 처방의(외래,병동)    */
		               and  g2.LGIN_ID   = g.LGIN_ID
		               and  h.PTNO     = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = d.ORDR_SNO
		               and  c.MDRP_NO  = h.MDRP_NO
		               and  i.DPRT_CD(+)           = d.INJC_PLAC_CD
		               and  i.MDPR_CD(+)           = d.MDPR_CD
		               and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		               and  j.PTNO(+) = a.PTNO                          /* 응급간호환자번호     */
		               and  j.COHS_DT(+) = a.MDCR_YMD                     /* 응급간호환자번호     */
		               and  (
		                            (d.MDTN_NO_DVSN_CD = 'O' and d.BSIS_CMMD_PLAC_CD = 'B' and d.INVN_TOTL_QTY
		                                          > fn_sd_getrtnqty_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO))
		                         or (d.MDTN_NO_DVSN_CD != 'O' or d.BSIS_CMMD_PLAC_CD != 'B')
		                    )
		               and  y.COMN_GRP_CD = 'SD600'
		               and  y.COMN_DTLS_CD = x.AUDT_TYPE_CD
		              union all
		               select  /*+ NO_EXPAND LEADING(A, D, H) USE_NL(A, B , D, H, C, E, F, G, G2, I, J) INDEX_SS(A, SDPORDBAT_PK) OPT_PARAM('_OPTIMIZER_COST_BASED_TRANSFORMATION','OFF') */
		                       to_char(a.ORDR_YMD, 'YYYYMMDD') ORDR_YMD,                   /* 처방일자             */
		                       a.MDTN_NO_DVSN_CD ,                                         /* 처방형태구분         */
		                       lpad(to_char(a.MDTN_NO), 4, '0') AFI_MDTN_NO_STR,           /* 투약번호             */
		                       d.ORDR_SNO ,                                                /* 처방번호             */
		                       d.MDPR_CD ,                                                 /* 약품코드             */
		                       a.PTDV_CD ,                                                 /* 환자구분             */
		                       d.MDPR_CLSF_CD ,                                            /* 약분류               */
		                       d.DRAP_DVSN_CD ,                                            /* 약적용구분           */
		                       d.CMMD_STTS_CD           ,                                  /* 조제 STATUS          */
		                       decode(d.DRAP_DVSN_CD,'2',d.PCKN_UNAD_QTY,round(d.PCKN_UNAD_QTY,2))  PCKN_UNAD_QTY,   /* 투여량(포장)         */
		                       d.PCUN_NM   PCUN_CD,                                        /* 단위(포장)           */
		                       decode(d.DRAP_DVSN_CD,'2',d.ICUN_ADMN_VLM,round(d.ICUN_ADMN_VLM,2))  ICUN_ADMN_VLM,   /* 투여량(함량)         */
		                       d.ICUN_CD ,                                                /* 단위(함량)           */
		                       d.SLCT_UNIT_DVSN_CD ,                                       /* 투여량TYPE           */
		                       d.MDTN_DDCN ,                                               /* 일수                 */
		                       d.DRUS_CD ,                                                 /* 용법                 */
		                       d.MDNT ,                                                    /* 횟수                 */
		                       decode(d.DRAP_DVSN_CD,'2',d.TOTL_CLCL_QTY,round(d.TOTL_CLCL_QTY,2)) TOTL_CLCL_QTY,     /* 총량(계산)           */
		                       decode(d.DRAP_DVSN_CD,'2',d.INVN_TOTL_QTY,round(d.INVN_TOTL_QTY,2)) INVN_TOTL_QTY,     /* 총량(계산)           */
		                       d.PHDP_CMMD_BNDL_NO ,                                       /* 약제부 묶음번호       */
		                       d.DRBN_NO ,                                                 /* 약묶음번호           */
		                       d.MIX_KIND_CD ,                                             /* MIX종류              */
		                       d.BSIS_CMMD_PLAC_CD ,                                       /* 조제장소             */
		                       replace(replace(d.SPSB_CTN,chr(13)||chr(10),''),chr(10),'')  SPSB_CTN,  /* 특기사항 */  -- PHH  DHL  PHN  HHC  CPHN  CHHC
		                       null                             as FDNO_YN, /* 정수품유무 */
		                       d.ISDV_CD ,                                                 /* 보험구분(수납시)     */
		                       to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT,   /* 입력일시             */
		                       d.SDPF_EXRE_CD ,                                            /* 의약분업예외사유코드 */
		                       d.INJC_PLAC_CD ,                                            /* 주사장소             */
		                       d.OHOR_RTRN_YN ,                                            /* 원외처방반납여부     */
		                       d.BEMD_NO ,                                                 /* 투석실 처방번호      */
		                       d.ATTR_NO ,                                                 /* AUTO TRACK번호       */
		                       case
		                           when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                           when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                           when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                       end     DURV_RESN_CTN,                                      /* 상호작용 comment     */
		                       a.PTNO ,                                                    /* 환자번호             */
		                       to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT,             /* 접수일시             */
		                       a.MCDP_CD ,                                                 /* 진료과               */
		                       a.WARD_CD ,                                                 /* 병동                 */
		                       a.ODDR_ID ,                                                 /* 처방의(외래,병동)    */
		                       a.GNDR_ID ,                                                 /* 주치의(병동)         */
		                       a.RCPC_YN ,                                                 /* 수납구분             */
		                       a.UPDT_BEMD_NO ,                                            /* 수정전 투약번호      */
		                       a.DRUG_INJC_DVSN_CD ,                                       /* 약주사구분           */
		                       a.PHDP_OROC_DPRT_CD ,                                                 /* 처방발생원           */
		                       a.TKMD_CCHN_YN ,                                            /* 복약지도여부         */
		                       a.IHOH_DVSN_CD ,                                            /* 원내외구분           */
		                       a.NRDR_YN ,                                                 /* 마약여부             */
		                       a.PSDG_YN ,                                                 /* 향정여부             */
		                       a.CLNC_YN ,                                                 /* 임상여부             */
		                       to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS')   MDCR_YMD,         /* 입원일자(내원일시)   */
		                       e.MDPR_NM                  ,                                /* 약품명               */
		                       decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN1
		                                                          , f.ENVL_MEMO_CTN1) ENVL_MEMO_CTN1, /* 봉투1                */
		                       decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN2
		                                                          , f.ENVL_MEMO_CTN2) ENVL_MEMO_CTN2, /* 봉투2                */
		                       b.PTNT_NM ,                                                 /* 환자명               */
		                       b.FRRN ,                                                    /* 주민번호1            */
		                       b.BRRN ,                                                    /* 주민번호2            */
		                       trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||trunc(mod(months_between(a.ORDR_YMD, b.BTDT),12))||')'  AFI_AGE_VL_STR ,
		                       b.GEND_CD ,                                                 /* 성별                 */
		                       h.ISTY_CD ,                                                 /* 급여종별코드         */
		                       ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                           from CCCMCDDMT F_A, CCCMCDDLT F_B
		                          where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                            and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                            and F_A.COMN_GRP_CD = 'AI003'
		                            and F_A.COMN_DTLS_CD =  h.ISTY_CD
		                            and F_B.LNGG_CD(+) = nvl( '', '*') ) ISTY_CDNM,       /* 급여종별이름         */
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ODDR_ID ) ODDR_IDNM,                    /* 처방의(외래,병동)    */
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.GNDR_ID ) GNDR_IDNM,                    /* 주치의(병동)         */
		                       'N' SBSN_MDPR_ABSL_DSLW_YN,                    /* 대체약품절대불가     */
		                       g2.USER_LCNS_NO ,                                                             /* 면허번호             */
		                       ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                           from CCCMCDDMT F_A, CCCMCDDLT F_B
		                          where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                            and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                            and F_A.COMN_GRP_CD = 'SD003'
		                            and F_A.COMN_DTLS_CD =  e.KPNG_PLAC_CD
		                            and F_B.LNGG_CD(+) = nvl( '', '*') ) KPNG_PLAC_NM,       /* 보관장소             */
		                       c.PTRM_NO ,                                                 /* 병실번호             */
		                       '' VALD_HH ,                                                 /* 유효시간             */
		                       nvl(e.RELS_YN, 'N') RELS_YN,                                /* 청구약품여부         */
		                       d.WARD_LABL_PRIN_YN ,                                       /* 출력여부             */
		                       '' EDI_CD,                                                  /* EDI코드              */
		                       '' ISTY_ASST_CD,                                            /* 유형보조             */
		                       '' SCIN_CD,                                                 /* 상병코드             */
		                       to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') MDTN_STRT_YMD, /* 실시일자    */
		                       '' SCIN_NM,                                                 /* 상병명               */
		                       a.MDTN_NO         MDTN_NO_3,                                   /* 투약번호             */
		                       '' AFI_IPDV_NM,                                             /* 계산내역급여구분     */
		                       '' ACKN_EDI_CD,                                             /* 계산내역EDI코드      */
		                       '' PTNT_TYPE_NM_2,                                          /* 계산내역환자유형     */
		                       '' AFI_ISTY_ASST_NM_2,                                      /* 계산내역유형보조     */
		                       '' CANC_MDTE_ANTC_YN,                                       /* 소아항암여부         */
		                       e.STST_DVSN_CD ,                                            /* 통계구분             */
		                       'Y' ATMT_CLAM_YN,                                           /* 자동출력여부         */
		                       e.WSCN_SNGN_YN ,                                            /* 수제단독             */
		                       b.NTNL_CD,                                                  /* 외국인코드           */
		                       e.PCUN_INLS_QTY ,                                           /* 함량(마스터)         */
		                       '' AFI_MDPR_ORLM_AGE_DDCN_STR,
		                       (select ERRM_ZONE_NM||'('||substr(fn_mn_patwardtelno_s(c.MDRP_NO),-4)||')' from MNEERRMZT where ERRM_LCTN_CD=j.ERRM_LCTN_CD) ERRM_LCTN_CD, /*응급실내 환자세부위치 */
		                       e.KORN_PDCT_NM   ,                                          /* 한글상품명              */
		                       e.SMRY_MDPR_NM   ,                                          /* 라벨 출력용 요약상품명  */
		                       'N'          SELF_MDTN_YN,                                  /* Self Medication 여부    */
		                       1            SELFSEQ,                                       /* Self Medication 용 순서 */
		                       a.MDTN_LCDV_CD  ,                                           /* 투약위치                */
		                       decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN ,                                       /* 임상시험약 여부         */
		                       h.FRNS_CTRL_DVSN_CD  ,
		                       'N'          AUDT_YN,
		                       fn_sd_getaudfglist_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO, 1)    AFI_ORDR_AUDT_DVSN_NM,
		                       0            AUDSORTSEQ,
		                       ''           TRGT_MDPR_CD,
		                       ''           AUDT_RSLT_DVSN_CD,
		                       ''           AUDT_RSLT_RMRK_CTN,
		                       decode(g2.PDA_NO,'','','(8-'||g2.PDA_NO||')')  CFDR_PDA_NO,
		                       e.HGRS_HGCC_MDPR_YN,
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM,
		                       c.MDRP_NO,
		                       e.INJT_STER_CMMD_YN,
		                       e.NTM_RFLC_YN
		                 from
		                       SDPORDBAT a,
		                       APPTPTNTT b,
		                       SDPORDDEV d,
		                       MDMEDORDT h,
		                       APRCRPTNT c,
		                       SDDDGCDMT e,
		                       SDDMETCDT f,
		                       CCUSRDPHT g,
		                       CCUSERAMV g2,
		                       SDJFIXQTT i,
		                       MNEERRPAT j
		                where
		                       a.ORDR_YMD = to_date(#{ordrYmd2}, 'YYYYMMDD')        /* 처방일자             */
		                  and  instr(#{mdtnNoDvsnCd2}, a.MDTN_NO_DVSN_CD) > 0     /* 처방형태구분         */
		                  and  a.MDTN_NO     >= #{mdtnNo3}                        /* 투약번호             */
		                  and  a.MDTN_NO     <= #{mdtnNo4}                        /* 투약번호             */
		                  and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd2}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd2}) /* 투약위치 */
		                  and  a.WARD_CD      = nvl(#{wardCd2}, a.WARD_CD)                 /* 병동                 */
		                  and  b.PTNO = a.PTNO                                           /* 환자번호             */
		                  and  d.ORDR_YMD            = a.ORDR_YMD                        /* 처방일자             */
		                  and  d.MDTN_NO_DVSN_CD     = a.MDTN_NO_DVSN_CD                 /* 투약번호구분         */
		                  and  d.MDTN_NO             = a.MDTN_NO                         /* 투약번호             */
		                  and  d.MDTN_LCDV_CD        = a.MDTN_LCDV_CD                    /* 투약위치             */
		                  and  nvl(d.INJC_PLAC_CD,'*')        = nvl(#{injcPlacCd2} ,nvl(d.INJC_PLAC_CD,'*')) /* 주사장소             */
		                  and  (
		                           ((instr(#{afiOdkiNm2} , 'D') > 0) and (   d.BSIS_CMMD_PLAC_CD in ('1','2','3','4','5','6')
		                                                                                     or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD != '2'))
		                                                                                and  nvl((select /*+ index ( a1 mdmedordt_pk )
		                                                                                                     INDEX (B1, SDJDGRTNT_I06) */
		                                                                                              'Y'
		                                                                                        from
		                                                                                             MDMEDORDT a1,
		                                                                                             SDJDGRTNT b1
		                                                                                       where
		                                                                                             a1.PTNO = h.PTNO
		                                                                                         and a1.ORDR_YMD = h.ORDR_YMD
		                                                                                         and a1.ORDR_SNO = h.ORDR_SNO
		                                                                                         and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                                                                         and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                                                                              or
		                                                                                                nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                                                                         and a1.ORDR_YMD = b1.ORDR_YMD
		                                                                                         and a1.PTNO = b1.PTNO
		                                                                                         and a1.ORDR_SNO = b1.ORDR_SNO
		                                                                                         and b1.DRUG_RTRE_CD = '7'
		                                                                                         and rownum = 1
		                                                                                     ),'N') <> 'Y'
		                                                                                     )
		                           or
		                           ((instr(#{afiOdkiNm2} , 'I') > 0) and (
		                                         (
		                                           (d.BSIS_CMMD_PLAC_CD = '7') /* 외래주사(6개부서)의 경우 실시일자가 당일,익일이고 수납된 것만 출력 */
		                                           and
		                                           (
		                                               (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                   (d.INJC_PLAC_CD in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                                   and
		                                                   (
		                                                       ( /* 당일수납 + 당일,익일 실시예정 */
		                                                           (d.PHRM_IMPL_YMD between trunc(sysdate) and trunc(sysdate) + 1)
		                                                           and
		                                                           (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                       )
		                                                       or
		                                                       ( /* 간호에서 실시예정 바꾼경우(이전수납,당일실시예정) */
		                                                           (d.PHRM_IMPL_YMD = trunc(sysdate))
		                                                           and
		                                                           (d.RCPC_DT < trunc(sysdate))
		                                                       )
		                                                       or
		                                                       ( /* 실시예정일 지나서 수납한건 */
		                                                           (d.PHRM_IMPL_YMD < trunc(sysdate))
		                                                           and
		                                                           (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                       )
		                                                   )
		                                               )
		                                               or
		                                               (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                   (d.INJC_PLAC_CD not in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                               )
		                                           )
		                                       )
		                                     or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD = '2')
		                                   or (d.BSIS_CMMD_PLAC_CD = 'B' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')) /* 2006.08.14 자가주사 항암제 추가. */
		                                  )
		                               and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                    INDEX (B1, SDJDGRTNT_I06) */
		                                             'Y'
		                                       from
		                                            MDMEDORDT a1,
		                                            SDJDGRTNT b1
		                                      where
		                                            a1.PTNO = h.PTNO
		                                        and a1.ORDR_YMD = h.ORDR_YMD
		                                        and a1.ORDR_SNO = h.ORDR_SNO
		                                        and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                        and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                             or
		                                               nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                        and a1.ORDR_YMD = b1.ORDR_YMD
		                                        and a1.PTNO = b1.PTNO
		                                        and a1.ORDR_SNO = b1.ORDR_SNO
		                                        and b1.DRUG_RTRE_CD = '7'
		                                        and rownum = 1
		                                    ),'N') <> 'Y'
		                           )
		                           or
		                           ((instr(#{afiOdkiNm2} , 'C') > 0)
		                               and (((d.BSIS_CMMD_PLAC_CD in ('8','B'))
		                                    and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H') and d.PHRM_IMPL_YMD = trunc(sysdate))
		                                      or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))
		                                    or
		                                   (d.BSIS_CMMD_PLAC_CD = '7' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')
		                                    and exists (
		                                           select 'X'
		                                             from  SDPORDDEV z
		                                            where z.ORDR_YMD          = d.ORDR_YMD
		                                              and z.MDTN_NO_DVSN_CD   = d.MDTN_NO_DVSN_CD
		                                              and z.MDTN_NO           = d.MDTN_NO
		                                              and z.MDTN_LCDV_CD      = d.MDTN_LCDV_CD
		                                              and z.PHDP_CMMD_BNDL_NO = d.PHDP_CMMD_BNDL_NO
		                                              and z.BSIS_CMMD_PLAC_CD = 'B')
		                                       )
		                                    )
		                               and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                    INDEX (B1, SDJDGRTNT_I06) */
		                                             'Y'
		                                       from
		                                            MDMEDORDT a1,
		                                            SDJDGRTNT b1
		                                      where
		                                            a1.PTNO = h.PTNO
		                                        and a1.ORDR_YMD = h.ORDR_YMD
		                                        and a1.ORDR_SNO = h.ORDR_SNO
		                                        and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                        and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                             or
		                                               nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                        and a1.ORDR_YMD = b1.ORDR_YMD
		                                        and a1.PTNO = b1.PTNO
		                                        and a1.ORDR_SNO = b1.ORDR_SNO
		                                        and b1.DRUG_RTRE_CD = '7'
		                                        and rownum = 1
		                                    ),'N') <> 'Y'
		                           )    /* 주사제실 처방전     */
		                           or
		                           ((instr(#{afiOdkiNm2}, 'S') > 0) and (d.BSIS_CMMD_PLAC_CD = '9') and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H') and d.PHRM_IMPL_YMD
		                                                   = trunc(sysdate)) or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))    /* 주사제실 처방전     */
		                           or
		                           ((instr(#{afiOdkiNm2}, 'T') > 0) and (d.BSIS_CMMD_PLAC_CD = 'T'))           /* 임상시험약 약처방전 */
		                           or
		                           ((instr(#{afiOdkiNm2}, 'U') > 0) and (d.BSIS_CMMD_PLAC_CD in ('U','V')))    /* 임상시험약 주사처방전 */
		                       )
		                  and  h.PTNO     = a.PTNO
		                  and  h.ORDR_YMD = a.ORDR_YMD
		                  and  h.ORDR_SNO = d.ORDR_SNO
		                  and  c.MDRP_NO  = h.MDRP_NO
		                  and  e.MDPR_CD  = d.MDPR_CD                      /* 약품코드            */
		                  and  (
		                           (nvl(e.OTPT_PHRM_RQST_YN, 'N') != 'Y')
		                         or
		                           (
		                               (nvl(e.OTPT_PHRM_RQST_YN, 'N') = 'Y')
		                               and
		                                 (d.MDTN_NO_DVSN_CD in ('B', 'E', 'F', 'Q', 'H', 'I', 'S', 'G'))
		                           )
		                       )
		                  and  f.DRUS_CD(+) = d.DRUS_CD                  /* 용법                */
		                  and  g.USER_ID(+) = a.ODDR_ID                  /* 처방의(외래,병동)   */
		                  and  g2.LGIN_ID   = g.LGIN_ID
		                  and  i.DPRT_CD(+) = d.INJC_PLAC_CD
		                  and  i.MDPR_CD(+) = d.MDPR_CD
		                  and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		                  and  j.PTNO(+)    = a.PTNO                     /* 응급간호환자번호     */
		                  and  j.COHS_DT(+) = a.MDCR_YMD                 /* 응급간호환자번호     */
		                  and  (
		                               (d.MDTN_NO_DVSN_CD = 'O' and d.BSIS_CMMD_PLAC_CD = 'B' and d.INVN_TOTL_QTY
		                                              > fn_sd_getrtnqty_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO))
		                            or (d.MDTN_NO_DVSN_CD != 'O' or d.BSIS_CMMD_PLAC_CD != 'B')
		                       )
		             union all
		               select  /*+ NO_EXPAND LEADING(A, B) USE_NL(A, B, C, D, E, G, G2) INDEX_SS(A, SDPORDBAT_PK) */
		                       to_char(a.ORDR_YMD, 'YYYYMMDD')     ORDR_YMD,            /* 처방일자             */
		                       a.MDTN_NO_DVSN_CD                   ,           /* 처방형태구분         */
		                       lpad(to_char(a.MDTN_NO), 4, '0')    AFI_MDTN_NO_STR,              /* 투약번호             */
		                       b.ORDR_SNO                          ,           /* 처방번호             */
		                       b.ORDR_CD                           MDPR_CD,           /* 약품코드             */
		                       b.CODV_CD                           PTDV_CD,              /* 환자구분             */
		                       b.MDPR_CLSF_CD                      ,            /* 약분류               */
		                       b.DRAP_DVSN_CD                      ,            /* 약적용구분           */
		                       b.DRUG_ORDR_PRSS_CD                 CMMD_STTS_CD,         /* 조제 STATUS          */
		                       decode(b.DRAP_DVSN_CD,'2',b.PCKN_UNAD_QTY,round(b.PCKN_UNAD_QTY,2))  PCKN_UNAD_QTY,   /* 투여량(포장)         */
		                       b.PCUN_CD                          ,           /* 단위(포장)           */
		                       decode(b.DRAP_DVSN_CD,'2',b.ICUN_ADMN_VLM,round(b.ICUN_ADMN_VLM,2))  ICUN_ADMN_VLM,   /* 투여량(함량)         */
		                       b.ICUN_CD                           ,           /* 단위(함량)           */
		                       b.SLCT_UNIT_DVSN_CD                 ,           /* 투여량TYPE           */
		                       b.DDCN                              MDTN_DDCN,               /* 일수                 */
		                       b.DRUS_CD                           ,           /* 용법                 */
		                       b.NTM                               MDNT,                /* 횟수                 */
		                       null                                TOTL_CLCL_QTY,             /* 총량(계산)           */
		                       null                                INVN_TOTL_QTY,           /* 총량(계산)           */
		                       null                                PHDP_CMMD_BNDL_NO,            /* 약제부 묶음번호       */
		                       b.DRBN_NO                           ,           /* 약묶음번호           */
		                       b.MIX_KIND_CD                       ,            /* MIX종류              */
		                       null                                BSIS_CMMD_PLAC_CD,            /* 조제장소             */
		                       replace(replace(b.DRUG_ORDR_UNSL_CTN,chr(13)||chr(10),''),chr(10),'')  SPSB_CTN,          /* 특기사항             */
		                       null                                FDNO_YN,              /* 정수품유무 */
		                       null                                ISDV_CD,             /* 보험구분(수납시)     */
		                       null                                DRUG_ORDR_INPT_DT,          /* 입력일시             */
		                       b.SDPF_EXRE_CD                      SDPF_EXRE_CD,           /* 의약분업예외사유코드 */
		                       null                                INJC_PLAC_CD,            /* 주사장소             */
		                       null                                OHOR_RTRN_YN,        /* 원외처방반납여부     */
		                       null                                BEMD_NO,             /* 투석실 처방번호      */
		                       null                                ATTR_NO,           /* AUTO TRACK번호       */
		                       null                                DURV_RESN_CTN,             /* 상호작용 comment     */
		                       a.PTNO                              ,              /* 환자번호             */
		                       null                                RPTN_DT,           /* 접수일시             */
		                       b.MCDP_CD                           ,            /* 진료과               */
		                       b.WARD_CD                           ,             /* 병동                 */
		                       b.ODDR_ID                           ,              /* 처방의(외래,병동)    */
		                       b.GNDR_ID                           ,              /* 주치의(병동)         */
		                       b.RCST_CD                           RCPC_YN,              /* 수납구분             */
		                       null                                UPDT_BEMD_NO,           /* 수정전 투약번호      */
		                       null                                DRUG_INJC_DVSN_CD,               /* 약주사구분           */
		                       a.PHDP_OROC_DPRT_CD                           ,           /* 처방발생원           */
		                       null                                TKMD_CCHN_YN,            /* 복약지도여부         */
		                       null                                IHOH_DVSN_CD,            /* 원내외구분           */
		                       null                                NRDR_YN,             /* 마약여부             */
		                       null                                PSDG_YN,            /* 향정여부             */
		                       null                                CLNC_YN,           /* 임상여부             */
		                       to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD,    /* 입원일자(내원일시)   */
		                       '[지참약]'||e.MDPR_NM               MDPR_NM,           /* 약품명               */
		                       null                                ENVL_MEMO_CTN1,            /* 봉투1                */
		                       null                                ENVL_MEMO_CTN2,            /* 봉투2                */
		                       d.PTNT_NM                           PTNT_NM,            /* 환자명               */
		                       d.FRRN                              ,             /* 주민번호1            */
		                       d.BRRN                              ,             /* 주민번호2            */
		                       trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'('||
		                           trunc(mod(months_between(a.ORDR_YMD, d.BTDT),12))||')' AFI_AGE_VL_STR,  /* 나이                 */
		                       d.GEND_CD                           ,                /* 성별                 */
		                       b.ISTY_CD                           ,             /* 급여종별코드         */
		                       ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                           from CCCMCDDMT F_A, CCCMCDDLT F_B
		                          where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                            and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                            and F_A.COMN_GRP_CD = 'AI003'
		                            and F_A.COMN_DTLS_CD =  b.ISTY_CD
		                            and F_B.LNGG_CD(+) = nvl( '', '*') ) ISTY_CDNM,           /* 급여종별이름         */
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.ODDR_ID )           ODDR_IDNM,            /* 처방의(외래,병동)    */
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.GNDR_ID )           GNDR_IDNM,            /* 주치의(병동)         */
		                       'N'                       SBSN_MDPR_ABSL_DSLW_YN,            /* 대체약품절대불가     */
		                       g2.USER_LCNS_NO                    ,             /* 면허번호             */
		                       ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                           from CCCMCDDMT F_A, CCCMCDDLT F_B
		                          where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                            and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                            and F_A.COMN_GRP_CD = 'SD003'
		                            and F_A.COMN_DTLS_CD =  e.KPNG_PLAC_CD
		                            and F_B.LNGG_CD(+) = nvl( '', '*') ) KPNG_PLAC_NM,           /* 보관장소             */
		                       c.PTRM_NO                            ,             /* 병실번호             */
		                       '' VALD_HH                           ,            /* 유효시간             */
		                       nvl(e.RELS_YN, 'N')                   RELS_YN,              /* 청구약품여부         */
		                       null                                WARD_LABL_PRIN_YN,              /* 출력여부             */
		                       ''                                  EDI_CD,            /* EDI코드              */
		                       ''                                  ISTY_ASST_CD,             /* 유형보조             */
		                       ''                                  SCIN_CD,           /* 상병코드             */
		                       null                                MDTN_STRT_YMD,        /* 실시일자    */
		                       ''                                  SCIN_NM,           /* 상병명               */
		                       a.MDTN_NO                           MDTN_NO_3,             /* 투약번호             */
		                       ''                                  AFI_IPDV_NM,            /* 계산내역급여구분     */
		                       ''                                  ACKN_EDI_CD,           /* 계산내역EDI코드      */
		                       ''                                  PTNT_TYPE_NM_2,            /* 계산내역환자유형     */
		                       ''                                  AFI_ISTY_ASST_NM_2,            /* 계산내역유형보조     */
		                       ''                                  CANC_MDTE_ANTC_YN,           /* 소아항암여부         */
		                       e.STST_DVSN_CD                      ,            /* 통계구분             */
		                       'Y'                                 ATMT_CLAM_YN,             /* 자동출력여부         */
		                       e.WSCN_SNGN_YN                      ,           /* 수제단독             */
		                       d.NTNL_CD                           ,            /* 외국인코드           */
		                       e.PCUN_INLS_QTY                     ,           /* 함량(마스터)         */
		                       ''                                  AFI_MDPR_ORLM_AGE_DDCN_STR,
		                       null                                ERRM_LCTN_CD,         /*응급실내 환자세부위치 */
		                       e.KORN_PDCT_NM                      ,           /* 한글상품명            */
		                       '[지참약]'||e.SMRY_MDPR_NM           SMRY_MDPR_NM,          /* 라벨 출력용 요약상품명 */
		                       'Y'                                 SELF_MDTN_YN,         /* Self Medication 여부  */
		                       2                                   SELFSEQ,            /* Self Medication 용 순서 */
		                       a.MDTN_LCDV_CD                      ,          /* 투약위치               */
		                       decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN                 ,         /* 임상시험약 여부     */
		                       b.FRNS_CTRL_DVSN_CD                 ,
		                       'N'                                 AUDT_YN,
		                       ''                                  AFI_ORDR_AUDT_DVSN_NM,
		                       0                                   AUDSORTSEQ,
		                       ''                                  TRGT_MDPR_CD,
		                       ''                                  AUDT_RSLT_DVSN_CD,
		                       ''                                  AUDT_RSLT_RMRK_CTN,
		                       decode(g2.PDA_NO,'','','(8-'||g2.PDA_NO||')')  CFDR_PDA_NO,
		                       e.HGRS_HGCC_MDPR_YN,
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.ODDR_ID ) ODDR_NM,
		                       c.MDRP_NO,
		                       e.INJT_STER_CMMD_YN,
		                       e.NTM_RFLC_YN
		                 from
		                       SDPORDBAT a,
		                       MDMEDORDT b,
		                       APRCRPTNT c,
		                       APPTPTNTT d,
		                       SDDDGCDMT e,
		                       CCUSRDPHT g,
		                       CCUSERAMV g2
		                where
		                       a.ORDR_YMD = to_date(#{ordrYmd2}, 'YYYYMMDD') /* 처방일자             */
		                  and  instr(#{mdtnNoDvsnCd2} , a.MDTN_NO_DVSN_CD) > 0          /* 처방형태구분         */
		                  and  (
		                               (instr(#{mdtnNoDvsnCd2} , 'A') > 0)
		                            or (instr(#{mdtnNoDvsnCd2} , 'B') > 0)
		                            or (instr(#{mdtnNoDvsnCd2} , 'C') > 0)
		                            or (instr(#{mdtnNoDvsnCd2} , 'E') > 0)
		                       )
		                  and  a.MDTN_NO >= #{mdtnNo3}           /* 투약번호             */
		                  and  a.MDTN_NO <= #{mdtnNo4}           /* 투약번호             */
		                  and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd2}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd2} ) /* 투약위치 */
		                  and  b.PTNO = a.PTNO                              /* 환자번호             */
		                  and  b.ORDR_YMD = a.ORDR_YMD                      /* 처방일자             */
		                  and  b.ORFR_CD = 'S'                               /* Self Medication 조건 */
		                  and  b.TMPR_ORDR_YN = 'Y'                          /* Self Medication 조건 */
		                  and  nvl(b.DC_DVSN_CD,'N') in ('Y','N')                   /* 삭제처방             */
		                  and  c.MDRP_NO  = b.MDRP_NO
		                  and  d.PTNO = a.PTNO                                /* 환자번호             */
		                  and  e.MDPR_CD  = b.ORDR_CD                         /* 약품코드            */
		                  and  g.USER_ID(+) = a.ODDR_ID                     /* 처방의(외래,병동)    */
		                  and  g2.LGIN_ID   = g.LGIN_ID
		             union all
		               select  /*+ NO_EXPAND LEADING(X, A, D, H) USE_NL(A, B, D, E, F, G, G2, H, C, I, J, Y) INDEX_SS(A, SDPORDBAT_PK) OPT_PARAM('_OPTIMIZER_COST_BASED_TRANSFORMATION','OFF') */
		                       to_char(a.ORDR_YMD, 'YYYYMMDD') ORDR_YMD,           /* 처방일자             */
		                       a.MDTN_NO_DVSN_CD,                                /* 처방형태구분         */
		                       lpad(to_char(a.MDTN_NO), 4, '0') AFI_MDTN_NO_STR,               /* 투약번호             */
		                       d.ORDR_SNO ,                                /* 처방번호             */
		                       d.MDPR_CD ,                                /* 약품코드             */
		                       a.PTDV_CD ,                                      /* 환자구분             */
		                       d.MDPR_CLSF_CD ,                                  /* 약분류               */
		                       d.DRAP_DVSN_CD ,                                  /* 약적용구분           */
		                       d.CMMD_STTS_CD ,                            /* 조제 STATUS          */
		                       decode(d.DRAP_DVSN_CD,'2',d.PCKN_UNAD_QTY,round(d.PCKN_UNAD_QTY,2)) PCKN_UNAD_QTY,   /* 투여량(포장)         */
		                       d.PCUN_NM   PCUN_CD,                                /* 단위(포장)           */
		                       decode(d.DRAP_DVSN_CD,'2',d.ICUN_ADMN_VLM,round(d.ICUN_ADMN_VLM,2)) ICUN_ADMN_VLM,   /* 투여량(함량)         */
		                       d.ICUN_CD ,                                /* 단위(함량)           */
		                       d.SLCT_UNIT_DVSN_CD ,                                /* 투여량TYPE           */
		                       d.MDTN_DDCN ,                                         /* 일수                 */
		                       d.DRUS_CD ,                                /* 용법                 */
		                       d.MDNT  ,                                          /* 횟수                 */
		                       decode(d.DRAP_DVSN_CD,'2',d.TOTL_CLCL_QTY,round(d.TOTL_CLCL_QTY,2)) TOTL_CLCL_QTY,     /* 총량(계산)           */
		                       decode(d.DRAP_DVSN_CD,'2',d.INVN_TOTL_QTY,round(d.INVN_TOTL_QTY,2)) INVN_TOTL_QTY,     /* 총량(계산)           */
		                       d.PHDP_CMMD_BNDL_NO ,                                  /* 약제부 묶음번호       */
		                       d.DRBN_NO ,                                /* 약묶음번호           */
		                       d.MIX_KIND_CD ,                                  /* MIX종류              */
		                       d.BSIS_CMMD_PLAC_CD ,                                  /* 조제장소             */
		                       replace(replace(d.SPSB_CTN,chr(13)||chr(10),''),chr(10),'')   SPSB_CTN,                                    /* 특기사항             */
		                       null                         as FDNO_YN, /* 정수품유무 */
		                       d.ISDV_CD ,                                          /* 보험구분(수납시)     */
		                       to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT,          /* 입력일시             */
		                       d.SDPF_EXRE_CD ,                                   /* 의약분업예외사유코드 */
		                       d.INJC_PLAC_CD ,                                    /* 주사장소             */
		                       d.OHOR_RTRN_YN ,                                /* 원외처방반납여부     */
		                       d.BEMD_NO  ,                                         /* 투석실 처방번호      */
		                       d.ATTR_NO ,                                        /* AUTO TRACK번호       */
		                       case
		                           when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                           when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                           when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                       end     DURV_RESN_CTN,                                            /* 상호작용 comment     */
		                       a.PTNO ,                                              /* 환자번호             */
		                       to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT,      /* 접수일시             */
		                       a.MCDP_CD ,                                         /* 진료과               */
		                       a.WARD_CD ,                                          /* 병동                 */
		                       a.ODDR_ID ,                                           /* 처방의(외래,병동)    */
		                       a.GNDR_ID ,                                           /* 주치의(병동)         */
		                       a.RCPC_YN ,                                           /* 수납구분             */
		                       a.UPDT_BEMD_NO ,                                   /* 수정전 투약번호      */
		                       a.DRUG_INJC_DVSN_CD ,                                  /* 약주사구분           */
		                       a.PHDP_OROC_DPRT_CD ,                                        /* 처방발생원           */
		                       a.TKMD_CCHN_YN ,                                    /* 복약지도여부         */
		                       a.IHOH_DVSN_CD ,                                    /* 원내외구분           */
		                       a.NRDR_YN ,                                          /* 마약여부             */
		                       a.PSDG_YN ,                                         /* 향정여부             */
		                       a.CLNC_YN ,                                        /* 임상여부             */
		                       to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD,      /* 입원일자(내원일시)   */
		                       e.MDPR_NM ,                                        /* 약품명               */
		                       decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN1
		                                                          , f.ENVL_MEMO_CTN1) ENVL_MEMO_CTN1, /* 봉투1                */
		                       decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN2
		                                                          , f.ENVL_MEMO_CTN2) ENVL_MEMO_CTN2, /* 봉투2                */
		                       b.PTNT_NM ,                                         /* 환자명               */
		                       b.FRRN ,                                             /* 주민번호1            */
		                       b.BRRN ,                                             /* 주민번호2            */
		                       trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||trunc(mod(months_between(a.ORDR_YMD, b.BTDT),12))||')' AFI_AGE_VL_STR,
		                       b.GEND_CD,                                             /* 성별                 */
		                       h.ISTY_CD,                                          /* 급여종별코드         */
		                       ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                           from CCCMCDDMT F_A, CCCMCDDLT F_B
		                          where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                            and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                            and F_A.COMN_GRP_CD = 'AI003'
		                            and F_A.COMN_DTLS_CD =  h.ISTY_CD
		                            and F_B.LNGG_CD(+) = nvl( '', '*') ) ISTY_CDNM,       /* 급여종별이름         */
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.ODDR_ID ) ODDR_IDNM,   /* 처방의(외래,병동)    */
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = a.GNDR_ID ) GNDR_IDNM,   /* 주치의(병동)         */
		                       'N' SBSN_MDPR_ABSL_DSLW_YN,                /* 대체약품절대불가     */
		                       g2.USER_LCNS_NO  ,                                   /* 면허번호             */
		                       ( select nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM)
		                           from CCCMCDDMT F_A, CCCMCDDLT F_B
		                          where F_A.COMN_GRP_CD = F_B.COMN_GRP_CD(+)
		                            and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
		                            and F_A.COMN_GRP_CD = 'SD003'
		                            and F_A.COMN_DTLS_CD =  e.KPNG_PLAC_CD
		                            and F_B.LNGG_CD(+) = nvl( '', '*') ) KPNG_PLAC_NM,       /* 보관장소             */
		                       c.PTRM_NO ,                                          /* 병실번호             */
		                       '' VALD_HH ,                                         /* 유효시간             */
		                       nvl(e.RELS_YN, 'N')    RELS_YN,                              /* 청구약품여부         */
		                       d.WARD_LABL_PRIN_YN    ,                              /* 출력여부             */
		                       '' EDI_CD,                                                /* EDI코드              */
		                       '' ISTY_ASST_CD,                                                 /* 유형보조             */
		                       '' SCIN_CD,                                                /* 상병코드             */
		                       to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') MDTN_STRT_YMD,  /* 실시일자    */
		                       '' SCIN_NM,                                                /* 상병명               */
		                       a.MDTN_NO MDTN_NO_3,                                          /* 투약번호             */
		                       '' AFI_IPDV_NM,                                                /* 계산내역급여구분     */
		                       '' ACKN_EDI_CD,                                               /* 계산내역EDI코드      */
		                       '' PTNT_TYPE_NM_2,                                                /* 계산내역환자유형     */
		                       '' AFI_ISTY_ASST_NM_2,                                                /* 계산내역유형보조     */
		                       '' CANC_MDTE_ANTC_YN,                                               /* 소아항암여부         */
		                       e.STST_DVSN_CD ,                                    /* 통계구분             */
		                       'Y' ATMT_CLAM_YN,                                                /* 자동출력여부         */
		                       e.WSCN_SNGN_YN ,                                   /* 수제단독             */
		                       b.NTNL_CD      ,                                    /* 외국인코드           */
		                       e.PCUN_INLS_QTY  ,                                 /* 함량(마스터)         */
		                       '' AFI_MDPR_ORLM_AGE_DDCN_STR,
		                       (select ERRM_ZONE_NM||'('||substr(fn_mn_patwardtelno_s(c.MDRP_NO),-4)||')' from MNEERRMZT where ERRM_LCTN_CD=j.ERRM_LCTN_CD) ERRM_LCTN_CD, /*응급실내 환자세부위치 */
		                       e.KORN_PDCT_NM  ,                                  /* 한글상품명            */
		                       e.SMRY_MDPR_NM  ,                                           /* 라벨 출력용 요약상품명 */
		                       'N'                  SELF_MDTN_YN,                            /* Self Medication 여부  */
		                       1                    SELFSEQ,                               /* Self Medication 용 순서 */
		                       a.MDTN_LCDV_CD       ,                             /* 투약위치               */
		                       decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN  ,                            /* 임상시험약 여부     */
		                       h.FRNS_CTRL_DVSN_CD  ,
		                       'Y'                                                                 AUDT_YN,
		                       y.DETL_CD_NM                                                        AFI_ORDR_AUDT_DVSN_NM,
		                       y.SCRN_DSPL_SQNC                                                    AUDSORTSEQ,
		                       x.TRGT_MDPR_CD1||decode(x.TRGT_MDPR_CD2, null, null, '-'||x.TRGT_MDPR_CD2)  TRGT_MDPR_CD,
		                       x.TRGT_AUDT_VL1||decode(x.TRGT_AUDT_VL2, null, null, '-'||x.TRGT_AUDT_VL2)  AUDT_RSLT_DVSN_CD,
		                       x.AUDT_RMRK_CTN                                                AUDT_RSLT_RMRK_CTN,
		                       decode(g2.PDA_NO,'','','(8-'||g2.PDA_NO||')')  CFDR_PDA_NO,
		                       e.HGRS_HGCC_MDPR_YN,
		                       ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM,
		                       c.MDRP_NO,
		                       e.INJT_STER_CMMD_YN,
		                       e.NTM_RFLC_YN
		                 from
		                       SDAAUDRPT x,
		                       SDPORDBAT a,
		                       APPTPTNTT b,
		                       SDPORDDEV d,
		                       SDDDGCDMT e,
		                       SDDMETCDT f,
		                       CCUSRDPHT g,
		                       CCUSERAMV g2,
		                       MDMEDORDT h,
		                       APRCRPTNT c,
		                       SDJFIXQTT i,
		                       MNEERRPAT j,
		                       CCCMCDDMT y
		                where
		                       #{audtYn} is not null
		                  and  x.TRGT_ORDR_YMD1 = to_date(#{ordrYmd2} , 'YYYYMMDD')             /* 처방일자             */
		                  and  instr(#{mdtnNoDvsnCd2} , x.TRGT_MDTN_NO_DVSN_CD1) > 0          /* 처방형태구분         */
		                  and  x.TRGT_MDTN_NO1 >= #{mdtnNo3}                                 /* 투약번호             */
		                  and  x.TRGT_MDTN_NO1 <= #{mdtnNo4}                                 /* 투약번호             */
		                  and  x.TRGT_MDTN_LCDV_CD1 = decode(#{mdtnLcdvCd2} , null, x.TRGT_MDTN_LCDV_CD1
		                                , 'A', x.TRGT_MDTN_LCDV_CD1, #{mdtnLcdvCd2} ) /* 투약위치 */
		                  and  x.AUDT_TYPE_CD not in ('011', '201243', '991')
		                  and  exists  (
		                               select  /*+ NO_UNNEST PUSH_SUBQ */
		                                       'Z'
		                                 from
		                                       SDAAUDRPT z
		                                where
		                                       z.TRGT_ORDR_YMD1        = x.TRGT_ORDR_YMD1
		                                  and  z.TRGT_MDTN_NO_DVSN_CD1 = x.TRGT_MDTN_NO_DVSN_CD1
		                                  and  z.TRGT_MDTN_NO1         = x.TRGT_MDTN_NO1
		                                  and  z.TRGT_MDTN_LCDV_CD1    = x.TRGT_MDTN_LCDV_CD1
		                                  and  substr(z.AUDT_TYPE_CD, 1, 2) not in ('01', '02', '99')
		                               )
		                  and  a.ORDR_YMD = x.TRGT_ORDR_YMD1
		                  and  a.MDTN_NO_DVSN_CD = x.TRGT_MDTN_NO_DVSN_CD1
		                  and  a.MDTN_NO = x.TRGT_MDTN_NO1
		                  and  a.MDTN_LCDV_CD = x.TRGT_MDTN_LCDV_CD1
		                  and  a.WARD_CD = nvl(#{wardCd2} , a.WARD_CD)          /* 병동                 */
		                  and  b.PTNO = a.PTNO                                  /* 환자번호             */
		                  and  d.ORDR_YMD = a.ORDR_YMD                          /* 처방일자             */
		                  and  d.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD            /* 투약번호구분         */
		                  and  d.MDTN_NO = a.MDTN_NO                            /* 투약번호             */
		                  and  d.MDTN_LCDV_CD = a.MDTN_LCDV_CD                  /* 투약위치             */
		                  and  d.ORDR_SNO = x.TRGT_ORDR_SNO1
		                  and  nvl(d.INJC_PLAC_CD,'*') = nvl(#{injcPlacCd2} , nvl(d.INJC_PLAC_CD,'*'))       /* 주사장소             */
		                  and  (
		                           ((instr(#{afiOdkiNm2}, 'D') > 0) and (    d.BSIS_CMMD_PLAC_CD in ('1','2','3','4','5','6')
		                                                                                     or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD != '2'))
		                                                                                and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                                                                     INDEX (B1, SDJDGRTNT_I06) */
		                                                                                              'Y'
		                                                                                        from
		                                                                                             MDMEDORDT a1,
		                                                                                             SDJDGRTNT b1
		                                                                                       where
		                                                                                             a1.PTNO = h.PTNO
		                                                                                         and a1.ORDR_YMD = h.ORDR_YMD
		                                                                                         and a1.ORDR_SNO = h.ORDR_SNO
		                                                                                         and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                                                                         and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                                                                              or
		                                                                                                nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                                                                         and a1.ORDR_YMD = b1.ORDR_YMD
		                                                                                         and a1.PTNO = b1.PTNO
		                                                                                         and a1.ORDR_SNO = b1.ORDR_SNO
		                                                                                         and b1.DRUG_RTRE_CD = '7'
		                                                                                         and rownum = 1
		                                                                                     ),'N') <> 'Y'
		                                                                                  )
		                           or
		                           ((instr(#{afiOdkiNm2}, 'I') > 0) and (
		                                                                 (
		                                                                   (d.BSIS_CMMD_PLAC_CD = '7') /* 외래주사(6개부서)의 경우 실시일자가 당일,익일이고 수납된 것만 출력 */
		                                                                   and
		                                                                   (
		                                                                       (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                                           (d.INJC_PLAC_CD in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                                                           and
		                                                                           (
		                                                                               ( /* 당일수납 + 당일,익일 실시예정 */
		                                                                                   (d.PHRM_IMPL_YMD between trunc(sysdate) and trunc(sysdate) + 1)
		                                                                                   and
		                                                                                   (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                                               )
		                                                                               or
		                                                                               ( /* 간호에서 실시예정 바꾼경우(이전수납,당일실시예정) */
		                                                                                   (d.PHRM_IMPL_YMD = trunc(sysdate))
		                                                                                   and
		                                                                                   (d.RCPC_DT < trunc(sysdate))
		                                                                               )
		                                                                               or
		                                                                               ( /* 실시예정일 지나서 수납한건 */
		                                                                                   (d.PHRM_IMPL_YMD < trunc(sysdate))
		                                                                                   and
		                                                                                   (d.RCPC_DT between trunc(sysdate) and trunc(sysdate) + 1)
		                                                                               )
		                                                                           )
		                                                                       )
		                                                                       or
		                                                                       (   /* 6개 부서 한정 + 영상간호 추가 */
		                                                                           (d.INJC_PLAC_CD not in (select t.PHRM_DTLS_CTRL_CD from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD320'))
		                                                                       )
		                                                                   )
		                                                               )
		                                                             or (d.BSIS_CMMD_PLAC_CD = 'A' and d.DRAP_DVSN_CD = '2')
		                                                           or (d.BSIS_CMMD_PLAC_CD = 'B' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')) /* 2006.08.14 자가주사 항암제 추가. */
		                                                          )
		                                                 and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                                      INDEX (B1, SDJDGRTNT_I06) */
		                                                               'Y'
		                                                         from
		                                                              MDMEDORDT a1,
		                                                              SDJDGRTNT b1
		                                                        where
		                                                              a1.PTNO = h.PTNO
		                                                          and a1.ORDR_YMD = h.ORDR_YMD
		                                                          and a1.ORDR_SNO = h.ORDR_SNO
		                                                          and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                                          and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                                               or
		                                                                 nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                                          and a1.ORDR_YMD = b1.ORDR_YMD
		                                                          and a1.PTNO = b1.PTNO
		                                                          and a1.ORDR_SNO = b1.ORDR_SNO
		                                                          and b1.DRUG_RTRE_CD = '7'
		                                                          and rownum = 1
		                                                      ),'N') <> 'Y'
		                           )
		                           or
		                           ((instr(#{afiOdkiNm2}, 'C') > 0)
		                               and ( ((d.BSIS_CMMD_PLAC_CD in ('8','B'))
		                                    and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H') and d.PHRM_IMPL_YMD = trunc(sysdate))
		                                      or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))
		                                    or
		                                   (d.BSIS_CMMD_PLAC_CD = '7' and d.INJC_PLAC_CD = fn_cc_get_cnst_vl('CCD_001', 'DPRT_OSI')
		                                    and exists (
		                                       select 'X'
		                                         from SDPORDDEV z
		                                        where z.ORDR_YMD = d.ORDR_YMD
		                                          and z.MDTN_NO_DVSN_CD = d.MDTN_NO_DVSN_CD
		                                          and z.MDTN_NO = d.MDTN_NO
		                                          and z.MDTN_LCDV_CD = d.MDTN_LCDV_CD
		                                          and z.PHDP_CMMD_BNDL_NO = d.PHDP_CMMD_BNDL_NO
		                                          and z.BSIS_CMMD_PLAC_CD = 'B')
		                                   ) )
		                              and  nvl((select /*+ index (a1 mdmedordt_pk )
		                                                   INDEX (B1, SDJDGRTNT_I06) */
		                                            'Y'
		                                      from
		                                           MDMEDORDT a1,
		                                           SDJDGRTNT b1
		                                     where
		                                           a1.PTNO = h.PTNO
		                                       and a1.ORDR_YMD = h.ORDR_YMD
		                                       and a1.ORDR_SNO = h.ORDR_SNO
		                                       and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                       and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                            or
		                                              nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                       and a1.ORDR_YMD = b1.ORDR_YMD
		                                       and a1.PTNO = b1.PTNO
		                                       and a1.ORDR_SNO = b1.ORDR_SNO
		                                       and b1.DRUG_RTRE_CD = '7'
		                                       and rownum = 1
		                                   ),'N') <> 'Y'
		                           )   /* 주사제실 처방전     */
		                           or
		                           ((instr(#{afiOdkiNm2}, 'S') > 0) and (d.BSIS_CMMD_PLAC_CD = '9') and ((a.MDTN_NO_DVSN_CD in ('O','Z','T','G','H')
		                                             and d.PHRM_IMPL_YMD = trunc(sysdate)) or (a.MDTN_NO_DVSN_CD not in ('O','Z','T','G','H'))))    /* 주사제실 처방전     */
		                           or
		                           ((instr(#{afiOdkiNm2}, 'T') > 0) and (d.BSIS_CMMD_PLAC_CD = 'T'))    /* 임상시험약 약처방전 */
		                           or
		                           ((instr(#{afiOdkiNm2}, 'U') > 0) and (d.BSIS_CMMD_PLAC_CD in ('U','V')))    /* 임상시험약 주사처방전 */
		                       )
		                  and  e.MDPR_CD = d.MDPR_CD                      /* 약품코드            */
		                  and  (
		                           (nvl(e.OTPT_PHRM_RQST_YN, 'N') != 'Y')
		                           or
		                           (
		                               (nvl(e.OTPT_PHRM_RQST_YN, 'N') = 'Y')
		                               and
		                                 (d.MDTN_NO_DVSN_CD in ('B', 'E', 'F', 'Q', 'H', 'I', 'S', 'G'))
		                           )
		                       )
		                  and  f.DRUS_CD(+) = d.DRUS_CD                     /* 용법                */
		                  and  g.USER_ID(+) = a.ODDR_ID                     /* 처방의(외래,병동)    */
		                  and  g2.LGIN_ID   = g.LGIN_ID
		                  and  h.PTNO     = a.PTNO
		                  and  h.ORDR_YMD = a.ORDR_YMD
		                  and  h.ORDR_SNO = d.ORDR_SNO
		                  and  c.MDRP_NO  = h.MDRP_NO
		                  and  i.DPRT_CD(+)           = d.INJC_PLAC_CD
		                  and  i.MDPR_CD(+)           = d.MDPR_CD
		                  and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		                  and  j.PTNO(+) = a.PTNO                          /* 응급간호환자번호     */
		                  and  j.COHS_DT(+) = a.MDCR_YMD                     /* 응급간호환자번호     */
		                  and  (
		                               (d.MDTN_NO_DVSN_CD = 'O' and d.BSIS_CMMD_PLAC_CD = 'B' and d.INVN_TOTL_QTY
		                                             > fn_sd_getrtnqty_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO))
		                            or (d.MDTN_NO_DVSN_CD != 'O' or d.BSIS_CMMD_PLAC_CD != 'B')
		                       )
		                  and  y.COMN_GRP_CD = 'SD600'
		                  and  y.COMN_DTLS_CD = x.AUDT_TYPE_CD
		            ) a
		     order by
		            a.ORDR_YMD,
		            a.MDTN_NO_DVSN_CD,
		            a.AFI_MDTN_NO_STR,
		            a.MDTN_LCDV_CD,
		            a.SELF_MDTN_YN,
		            a.AUDT_YN,
		            a.AUDSORTSEQ,
		            a.SELFSEQ,
		            a.INJC_PLAC_CD,
		            decode(#{afiOdkiNm},'D',decode(a.BSIS_CMMD_PLAC_CD, '6', '1', a.BSIS_CMMD_PLAC_CD)
		                          ,'I',decode(nvl(a.RCPC_YN,'N'),'Y',decode(nvl(a.WARD_LABL_PRIN_YN ,'N'),'N',1
		                                                                                  ,'Y',2,3)
		                                                          , 4)
		                          ,'1'),
		            decode(#{afiOdkiNm},'I', decode(a.BSIS_CMMD_PLAC_CD,'7',1,'A',1,'B',2)),  /* 2006.08.14 자가주사 항암제 추가. */
		            a.PHDP_CMMD_BNDL_NO,
		            a.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listSheetFrcPrin-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="frnsCqy" column="FRNS_CQY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN_1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO_1"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="afiIstyNm" column="AFI_ISTY_NM"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="valdHh" column="VALD_HH"/>
		<result property="relsYn" column="RELS_YN"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="istyAsstCd" column="ISTY_ASST_CD"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="mdtnNo3" column="MDTN_NO_3"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="acknEdiCd" column="ACKN_EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="cancMdteAntcYn" column="CANC_MDTE_ANTC_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="atmtClamYn" column="ATMT_CLAM_YN"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="pcunInlsQty" column="PCUN_INLS_QTY"/>
		<result property="afiMdprOrlmAgeDdcnStr" column="AFI_MDPR_ORLM_AGE_DDCN_STR"/>
		<result property="afiErrmLctnNm" column="AFI_ERRM_LCTN_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="shdnYn" column="SHDN_YN"/>
		<result property="cmmdAftrKpngPlacCd" column="CMMD_AFTR_KPNG_PLAC_CD"/>
		<result property="selfMdtnYn" column="SELF_MDTN_YN"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="audtYn" column="AUDT_YN"/>
		<result property="afiOrdrAudtDvsnNm" column="AFI_ORDR_AUDT_DVSN_NM"/>
		<result property="trgtMdprCd" column="TRGT_MDPR_CD"/>
		<result property="rmrkCtn" column="RMRK_CTN"/>
		<result property="audtRsltDvsnCd" column="AUDT_RSLT_DVSN_CD"/>
		<result property="audtRsltRmrkCtn" column="AUDT_RSLT_RMRK_CTN"/>
		<result property="cfdrPdaNo" column="CFDR_PDA_NO"/>
		<result property="cmmdVlm" column="CMMD_VLM"/>
		<result property="afiMdtnNoDvsnNm" column="AFI_MDTN_NO_DVSN_NM"/>
		<result property="afiInrnTbstSycdNm" column="AFI_INRN_TBST_SYCD_NM"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="injcPlacCd1" column="INJC_PLAC_CD_1"/>
		<result property="ntmRflcYn" column="NTM_RFLC_YN"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="hghtVl" column="HGHT_VL"/>
		<result property="bsaVl" column="BSA_VL"/>
		<result property="cmmdUnsbCtn" column="CMMD_UNSB_CTN"/>
		<result property="drugOrdrUnslCtn" column="DRUG_ORDR_UNSL_CTN"/>
		<result property="subjIdntNo" column="SUBJ_IDNT_NO"/>
		<result property="subjIntiVl" column="SUBJ_INTI_VL"/>
		<result property="subjVistNm" column="SUBJ_VIST_NM"/>
		<result property="subjAdmnVl" column="SUBJ_ADMN_VL"/>
		<result property="clncExamMdprCtn" column="CLNC_EXAM_MDPR_CTN"/>
		<result property="othsCmmdUnsbCtn" column="OTHS_CMMD_UNSB_CTN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listSheetFrcPrin () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listSheetFrcPrin-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listSheetFrcPrin"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listSheetFrcPrin-result" useCache="true" flushCache="false">
		<![CDATA[
		    select /*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listSheetFrcPrin */ 
		           /*+ sdd_ordbatt_l01$S01_처방전강제출력 */   /* sd_print_l5 */
		            x.ORDR_YMD                     /* 처방일자             */
		         ,  x.ORDR_DT                      /* 처방일시             */ /* 2020.08.21 추가 */
		         ,  x.MDTN_NO_DVSN_CD              /* 처방형태구분         */
		         ,  x.AFI_MDTN_NO_STR              /* 투약번호             */
		         ,  x.ORDR_SNO                     /* 처방번호             */
		         ,  x.MDPR_CD                        /* 약품코드             */
		         ,  x.PTDV_CD                        /* 환자구분             */
		         ,  x.MDPR_CLSF_CD                   /* 약분류               */
		         ,  x.DRAP_DVSN_CD                   /* 약적용구분           */
		         ,  x.CMMD_STTS_CD                 /* 조제 STATUS          */
		         ,  x.PCKN_UNAD_QTY                  /* 투여량(포장)         */
		         ,  x.PCUN_CD                        /* 단위(포장)           */
		         ,  x.ICUN_ADMN_VLM                  /* 투여량(함량)         */
		         ,  x.ICUN_CD                        /* 단위(함량)           */
		         ,  x.SLCT_UNIT_DVSN_CD              /* 투여량TYPE           */
		         ,  x.MDTN_DDCN                    /* 일수                 */
		         ,  x.DRUS_CD                        /* 용법                 */
		         ,  x.MDNT                           /* 횟수                 */
		         ,  x.TOTL_CLCL_QTY         /* 총량(계산)           */
		         ,  x.FRNS_CQY    /* 총량(계산)           */
		         ,  x.PHDP_CMMD_BNDL_NO            /* 약제부 묶음번호       */
		         ,  x.DRBN_NO                        /* 약묶음번호           */
		         ,  x.MIX_KIND_CD                    /* MIX종류              */
		         ,  x.BSIS_CMMD_PLAC_CD            /* 조제장소             */
		         ,  x.SPSB_CTN                       /* 특기사항             */
		         ,  x.FDNO_YN                      /* 정수품유무 */
		         ,  x.ISDV_CD                      /* 보험구분(수납시)     */
		         ,  x.DRUG_ORDR_INPT_DT              /* 입력일시             */
		         ,  x.SDPF_EXRE_CD                   /* 의약분업예외사유코드 */
		         ,  x.INJC_PLAC_CD                   /* 주사장소             */
		         ,  x.OHOR_RTRN_YN                 /* 원외처방반납여부     */
		         ,  x.BEMD_NO                   /* 투석실 처방번호      */
		         ,  x.ATTR_NO                      /* AUTO TRACK번호       */
		         ,  x.DURV_RESN_CTN                  /* 상호작용 comment     */
		         ,  x.PTNO                           /* 환자번호             */
		         ,  x.RPTN_DT                        /* 접수일시             */
		         ,  x.MCDP_CD /* 진료과               */
		         ,  x.WARD_CD                        /* 병동                 */
		         ,  x.ODDR_ID                        /* 처방의(외래,병동)    */
		         ,  x.GNDR_ID    /* 주치의(병동)         */
		         ,  x.RCST_CD                        /* 수납구분             */
		         ,  x.UPDT_BEMD_NO                   /* 수정전 투약번호      */
		         ,  x.DRUG_INJC_DVSN_CD              /* 약주사구분           */
		         ,  x.PHDP_OROC_DPRT_CD                        /* 처방발생원           */
		         ,  x.TKMD_CCHN_YN                   /* 복약지도여부         */
		         ,  x.IHOH_DVSN_CD                   /* 원내외구분           */
		         ,  x.NRDR_YN                        /* 마약여부             */
		         ,  x.PSDG_YN                        /* 향정여부             */
		         ,  x.CLNC_YN                        /* 임상여부             */
		         ,  x.MDCR_YMD                       /* 입원일자(내원일시)   */
		         ,  x.MDPR_NM                        /* 약품명               */
		         ,  x.ENVL_MEMO_CTN_1             /* 봉투1                */
		         ,  x.ENVL_MEMO_CTN_2             /* 봉투2                */
		         ,  x.PTNT_NM                        /* 환자명               */
		         ,  x.FRRN                           /* 주민번호1            */
		         ,  x.BRRN                           /* 주민번호2            */
		         ,  x.AFI_AGE_VL_STR               /* 나이                 */
		         ,  x.GEND_CD                        /* 성별                 */
		         ,  x.PTNT_TLNO                  /* 전화번호(집)         */
		         ,  x.PTNT_TLNO_1                 /* 전화번호(핸드폰)     */
		         ,  x.ISTY_CD                       /* 급여종별코드         */
		         ,  x.AFI_ISTY_NM                   /* 급여종별이름         */
		         ,  x.AFI_ODDR_NM               /* 처방의(외래,병동)    */
		         ,  x.GNDR_NM               /* 주치의(병동)         */
		         ,  x.SBSN_MDPR_ABSL_DSLW_YN        /* 대체약품절대불가     */
		         ,  x.USER_LCNS_NO                /* 면허번호             */
		         ,  x.KPNG_PLAC_NM                /* 보관장소             */
		         ,  x.PTRM_NO                       /* 병실번호             */
		         ,  x.VALD_HH                       /* 유효시간             */
		         ,  x.RELS_YN                       /* 청구약품여부         */
		         ,  x.WARD_LABL_PRIN_YN           /* 출력여부             */
		         ,  x.EDI_CD                     /* EDI코드              */
		         ,  x.ISTY_ASST_CD                  /* 유형보조             */
		         ,  x.SCIN_CD                       /* 상병코드             */
		         ,  x.MDTN_STRT_YMD                 /* 실시일자             */
		         ,  x.SCIN_NM                    /* 상병명               */
		         ,  x.MDTN_NO_3                   /* 투약번호             */
		         ,  x.AFI_IPDV_NM                 /* 계산내역급여구분     */
		         ,  x.ACKN_EDI_CD                 /* 계산내역EDI코드      */
		         ,  x.PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		         ,  x.AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		         ,  x.CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		         ,  x.STST_DVSN_CD                  /* 통계구분             */
		         ,  x.ATMT_CLAM_YN                /* 자동출력여부         */
		         ,  x.WSCN_SNGN_YN                  /* 수제단독             */
		         ,  x.NTNL_CD                       /* 외국인코드           */
		         ,  x.PCUN_INLS_QTY               /* 함량(마스터)         */
		         ,  x.AFI_MDPR_ORLM_AGE_DDCN_STR  /* 연령별 제한          */
		         ,  x.AFI_ERRM_LCTN_NM             /*응급실내 환자세부위치 */
		         ,  x.KORN_PDCT_NM                  /* 한글상품명            */
		         ,  x.SMRY_MDPR_NM                  /* 라벨 출력용 요약상품명 */
		         ,  x.SHDN_YN                     /* 차광약물여부          */
		         ,  x.CMMD_AFTR_KPNG_PLAC_CD        /* 조제 후 보관장소      */
		         ,  x.SELF_MDTN_YN                /* Self Medication 여부 */
		         ,  x.MDTN_LCDV_CD                /* 투약위치             */
		         ,  x.CLNC_EXAM_DRUG_YN             /* 임상시험약 여부      */
		         ,  x.AUDT_YN                     /* 처방감사여부         */
		         ,  x.AFI_ORDR_AUDT_DVSN_NM       /* 처방감사구분명       */
		         ,  x.TRGT_MDPR_CD                /* 약품코드             */
		         ,  x.RMRK_CTN                    /* AUDT_RSLT_DVSN_CD */           /* 처방감사값           */
		         ,  ''                           as AUDT_RSLT_DVSN_CD
		         ,  x.AUDT_RSLT_RMRK_CTN            /* 처방감사비고         */
		         ,  x.CFDR_PDA_NO                 /* 주치의PDA            */
		         ,  x.CMMD_VLM            /* 조제ml               */
		         ,  x.AFI_MDTN_NO_DVSN_NM
		         ,  x.AFI_INRN_TBST_SYCD_NM
		         ,  x.HGRS_HGCC_MDPR_YN
		         ,  x.ODDR_NM
		         ,  x.INJC_PLAC_CD_1
		         ,  x.NTM_RFLC_YN
		         ,  x.BDWG_VL                       /* 체중                 */ /* 2020.08.21 추가 */
		         ,  x.HGHT_VL                       /* 신장                 */ /* 2020.08.21 추가 */
		         ,  round(( power(x.HGHT_VL, 0.725)
		                  * power(x.BDWG_VL, 0.425)
		                  * 100))
		                 /100           as BSA_VL   /* BSA                  */ /* 2020.08.21 추가 */
		         ,  x.CMMD_UNSB_CTN                                                 /* 조제특이사항내용     */ /* 2020.08.26 추가 */
		         ,  x.DRUG_ORDR_UNSL_CTN AS DRUG_ORDR_UNSL_CTN  -- 의사 특기사항
		         ,  x.SUBJ_IDNT_NO  AS SUBJ_IDNT_NO -- Subject No.
		         ,  x.SUBJ_INTI_VL  AS SUBJ_INTI_VL -- Initial
		         ,  x.SUBJ_VIST_NM  AS SUBJ_VIST_NM -- VISIT No.
		         ,  x.SUBJ_ADMN_VL  AS SUBJ_ADMN_VL -- Cycle No.
		         ,  x.CLNC_EXAM_MDPR_CTN  AS CLNC_EXAM_MDPR_CTN -- Med No.
		         ,  x.OTHS_CMMD_UNSB_CTN 
		      from (
		            select  /*+ sdd_ordbatt_l01$S01_처방전강제출력 */   /* sd_print_l5 */
		                    x.ORDR_YMD                     /* 처방일자             */
		                 ,  x.ORDR_DT                      /* 처방일시             */ /* 2020.08.21 추가 */
		                 ,  x.MDTN_NO_DVSN_CD              /* 처방형태구분         */
		                 ,  x.AFI_MDTN_NO_STR              /* 투약번호             */
		                 ,  x.ORDR_SNO                     /* 처방번호             */
		                 ,  MDPR_CD                        /* 약품코드             */
		                 ,  PTDV_CD                        /* 환자구분             */
		                 ,  MDPR_CLSF_CD                   /* 약분류               */
		                 ,  DRAP_DVSN_CD                   /* 약적용구분           */
		                 ,  x.CMMD_STTS_CD                 /* 조제 STATUS          */
		                 ,  PCKN_UNAD_QTY                  /* 투여량(포장)         */
		                 ,  PCUN_CD                        /* 단위(포장)           */
		                 ,  ICUN_ADMN_VLM                  /* 투여량(함량)         */
		                 ,  ICUN_CD                        /* 단위(함량)           */
		                 ,  SLCT_UNIT_DVSN_CD              /* 투여량TYPE           */
		                 ,  x.MDTN_DDCN                    /* 일수                 */
		                 ,  DRUS_CD                        /* 용법                 */
		                 ,  MDNT                           /* 횟수                 */
		                 ,  decode(FRNS_CTRL_DVSN_CD, null, TOTL_VLM, FRNS_VLM)    TOTL_CLCL_QTY         /* 총량(계산)           */
		                 ,  FRNS_VLM                   frns_cqy    /* 총량(계산)           */
		                 ,  x.PHDP_CMMD_BNDL_NO            /* 약제부 묶음번호       */
		                 ,  DRBN_NO                        /* 약묶음번호           */
		                 ,  MIX_KIND_CD                    /* MIX종류              */
		                 ,  x.BSIS_CMMD_PLAC_CD            /* 조제장소             */
		                 ,  SPSB_CTN                       /* 특기사항             */
		                 ,  x.FDNO_YN                      /* 정수품유무 */
		                 ,  x.ISDV_CD                      /* 보험구분(수납시)     */
		                 ,  DRUG_ORDR_INPT_DT              /* 입력일시             */
		                 ,  SDPF_EXRE_CD                   /* 의약분업예외사유코드 */
		                 ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=INJC_PLAC_CD),INJC_PLAC_CD) INJC_PLAC_CD                   /* 주사장소             */
		                 ,  x.OHOR_RTRN_YN                 /* 원외처방반납여부     */
		                 ,  TRGT_BEMD_NO  BEMD_NO                   /* 투석실 처방번호      */
		                 ,  x.ATTR_NO                      /* AUTO TRACK번호       */
		                 ,  DURV_RESN_CTN                  /* 상호작용 comment     */
		                 ,  PTNO                           /* 환자번호             */
		                 ,  RPTN_DT                        /* 접수일시             */
		                 ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=MCDP_CD),MCDP_CD) MCDP_CD /* 진료과               */
		                 ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=WARD_CD),WARD_CD) WARD_CD                        /* 병동                 */
		                 ,  ODDR_ID                        /* 처방의(외래,병동)    */
		                 ,  CHDR_ID                    gndr_id    /* 주치의(병동)         */
		                 ,  RCST_CD                        /* 수납구분             */
		                 ,  UPDT_BEMD_NO                   /* 수정전 투약번호      */
		                 ,  DRUG_INJC_DVSN_CD              /* 약주사구분           */
		                 ,  PHDP_OROC_DPRT_CD                        /* 처방발생원           */
		                 ,  TKMD_CCHN_YN                   /* 복약지도여부         */
		                 ,  IHOH_DVSN_CD                   /* 원내외구분           */
		                 ,  NRDR_YN                        /* 마약여부             */
		                 ,  PSDG_YN                        /* 향정여부             */
		                 ,  CLNC_YN                        /* 임상여부             */
		                 ,  MDCR_YMD                       /* 입원일자(내원일시)   */
		                 ,  MDPR_NM                        /* 약품명               */
		                 ,  ENVL_MEMO_CTN1    envl_memo_ctn_1             /* 봉투1                */
		                 ,  ENVL_MEMO_CTN2    envl_memo_ctn_2             /* 봉투2                */
		                 ,  PTNT_NM                        /* 환자명               */
		                 ,  FRRN                           /* 주민번호1            */
		                 ,  BRRN                           /* 주민번호2            */
		                 ,  x.AFI_AGE_VL_STR               /* 나이                 */
		                 ,  GEND_CD                        /* 성별                 */
		                 , (   select z.PTNT_TLNO
		                         from APPTCNPNV z
		                        where z.PTNO       = x.PTNO
		                          and CNPN_DVSN_CD = 'BH'
		                          and CNPN_SNO     = 1
		                          and rownum       = 1)   PTNT_TLNO                  /* 전화번호(집)         */
		                 ,  ( select z.PTNT_TLNO
		                        from APPTCNPNV z
		                       where z.PTNO       = x.PTNO
		                         and CNPN_DVSN_CD = 'BP'
		                         and CNPN_SNO     = 1
		                         and rownum       = 1)   ptnt_tlno_1                 /* 전화번호(핸드폰)     */
		                 ,  ISTY_CD                       /* 급여종별코드         */
		                 ,  x.ISTY_CDNM    AFI_ISTY_NM                   /* 급여종별이름         */
		                 ,  x.ODDR_NM      AFI_ODDR_NM               /* 처방의(외래,병동)    */
		                 ,  x.CHDR_NM      gndr_nm               /* 주치의(병동)         */
		                 ,  SBSN_MDPR_ABSL_DSLW_YN        /* 대체약품절대불가     */
		                 ,  x.USER_LCNS_NO                /* 면허번호             */
		                 ,  x.KPNG_PLAC_NM                /* 보관장소             */
		                 ,  PTRM_NO                       /* 병실번호             */
		                 ,  VALD_HH                       /* 유효시간             */
		                 ,  RELS_YN                       /* 청구약품여부         */
		                 ,  x.WARD_LABL_PRIN_YN           /* 출력여부             */
		                 ,  x.EDI_CD                     /* EDI코드              */
		                 ,  ISTY_ASST_CD                  /* 유형보조             */
		                 ,  SCIN_CD                       /* 상병코드             */
		                 ,  MDTN_STRT_YMD                 /* 실시일자             */
		                 , (
		                    select
		                            t.SCIN_NM
		                      from  MDPADIAGT t
		                     where  t.MDRP_NO       = x.MDRP_NO
		                       and  t.MAIN_SCIN_YN  = 'Y'
		                       and  x.CHDR_ID       = decode( x.PTDV_CD, 'O', t.CHDR_ID , x.CHDR_ID )
		                       and rownum < 2
		                    )  SCIN_NM                    /* 상병명               */
		                 ,  x.MDTN_NO_3                   /* 투약번호             */
		                 ,  x.AFI_IPDV_NM                 /* 계산내역급여구분     */
		                 ,  x.ACKN_EDI_CD                 /* 계산내역EDI코드      */
		                 ,  x.PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		                 ,  x.AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		                 ,  x.CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		                 ,  STST_DVSN_CD                  /* 통계구분             */
		                 ,  x.ATMT_CLAM_YN                /* 자동출력여부         */
		                 ,  WSCN_SNGN_YN                  /* 수제단독             */
		                 ,  NTNL_CD                       /* 외국인코드           */
		                 ,  x.PCUN_INLS_QTY               /* 함량(마스터)         */
		                 ,  x.AFI_MDPR_ORLM_AGE_DDCN_STR  /* 연령별 제한          */
		                 ,  x.ERRM_LCTN_CD   afi_errm_lctn_nm             /*응급실내 환자세부위치 */
		                 ,  KORN_PDCT_NM                  /* 한글상품명            */
		                 ,  SMRY_MDPR_NM                  /* 라벨 출력용 요약상품명 */
		                 ,  x.SHDN_YN                     /* 차광약물여부          */
		                 ,  CMMD_AFTR_KPNG_PLAC_CD        /* 조제 후 보관장소      */
		                 ,  x.SELF_MDTN_YN                /* Self Medication 여부 */
		                 ,  x.MDTN_LCDV_CD                /* 투약위치             */
		                 ,  CLNC_EXAM_DRUG_YN             /* 임상시험약 여부      */
		                 ,  x.AUDT_YN                     /* 처방감사여부         */
		                 ,  x.AFI_ORDR_AUDT_DVSN_NM       /* 처방감사구분명       */
		                 ,  x.TRGT_MDPR_CD                /* 약품코드             */
		                 ,  x.RMRK_CTN /* AUDT_RSLT_DVSN_CD */           /* 처방감사값           */
		                 ,  AUDT_RSLT_RMRK_CTN            /* 처방감사비고         */
		                 ,  x.CFDR_PDA_NO                 /* 주치의PDA            */
		                 ,  (select b1.LAST_USE_VLM
		                      from SDIJSTMAT a1
		                         , SDIJSTPST b1
		                         , SDMDISCRT c1
		                     where c1.MDPR_CD = x.MDPR_CD
		                       and b1.MDPR_CD = x.MDPR_CD
		                       and c1.RPMD_ID = a1.RPMD_ID
		                       and b1.RPMD_ID = a1.RPMD_ID
		                       and x.INJT_STER_CMMD_YN = 'Y'
		                       and rownum < 2) CMMD_VLM            /* 조제ml               */
		                 , (select DETL_CD_NM from SDCMCDDMV where COMN_GRP_CD = 'SD023' and COMN_DTLS_CD = x.MDTN_NO_DVSN_CD) AFI_MDTN_NO_DVSN_NM
		                 , ' ' AFI_INRN_TBST_SYCD_NM
		                 , x.HGRS_HGCC_MDPR_YN
		                 , x.ODDR_NM2      oddr_nm
		                 , x.INJC_PLAC_CD  injc_plac_cd_1
		                 ,  decode(#{odkiCd}, 'D', decode(x.BSIS_CMMD_PLAC_CD, '6', '1', x.BSIS_CMMD_PLAC_CD)
		                                     ,'I', decode(nvl(RCST_CD, 'N'), 'Y', decode(nvl(x.WARD_LABL_PRIN_YN, 'N'), 'N', 1 ,'Y', 2, 3)  , 4)
		                                     ,'1')  oderkey
		                 , SCRN_DSPL_SQNC
		                 , x.NTM_RFLC_YN
		                 ,  fn_sd_getweight_s(x.PTNO, x.ORDR_YMD) as BDWG_VL /* 체중                */  /* 2020.08.21 추가 */
		                 ,  fn_sd_getheight_s(x.PTNO, x.ORDR_YMD) as HGHT_VL /* 신장                */  /* 2020.08.21 추가 */
		                 ,  x.CMMD_UNSB_CTN    /* 조제특이사항내용     */ /* 2020.08.26 추가 */
		                 ,  x.DRUG_ORDR_UNSL_CTN AS DRUG_ORDR_UNSL_CTN  -- 의사 특기사항
		                 ,  x.SUBJ_IDNT_NO  AS SUBJ_IDNT_NO -- Subject No.
		                 ,  x.SUBJ_INTI_VL  AS SUBJ_INTI_VL -- Initial
		                 ,  x.SUBJ_VIST_NM  AS SUBJ_VIST_NM -- VISIT No.
		                 ,  x.SUBJ_ADMN_VL  AS SUBJ_ADMN_VL -- Cycle No.
		                 ,  x.CLNC_EXAM_MDPR_CTN  AS CLNC_EXAM_MDPR_CTN -- Med No.
		                 ,  x.OTHS_CMMD_UNSB_CTN 
		              from
		                   (
		                    select  /*+ ordered use_nl(d a b c e f g h i j)  */
		                            to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD                     /* 처방일자             */
		                         ,  to_char(a.ORDR_DT
		                                   , 'YYYYMMDDHH24MISS')       ORDR_DT                      /* 처방일시             */ /* 2020.08.21 추가 */
		                         ,  a.MDTN_NO_DVSN_CD                                               /* 처방형태구분         */
		                         ,  lpad(to_char(a.MDTN_NO), 4, '0')      AFI_MDTN_NO_STR           /* 투약번호             */
		                         ,  d.ORDR_SNO                                                      /* 처방번호             */
		                         ,  d.MDPR_CD                                                       /* 약품코드             */
		                         ,  a.PTDV_CD                                                       /* 환자구분             */
		                         ,  d.MDPR_CLSF_CD                                                  /* 약분류               */
		                         ,  d.DRAP_DVSN_CD                                                  /* 약적용구분           */
		                         ,  d.CMMD_STTS_CD                                                  /* 조제 STATUS          */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.PCKN_UNAD_QTY, round(d.PCKN_UNAD_QTY, 2))    PCKN_UNAD_QTY   /* 투여량(포장)         */
		                         ,  d.PCUN_NM                          PCUN_CD                      /* 단위(포장)           */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.ICUN_ADMN_VLM, round(d.ICUN_ADMN_VLM, 2))   ICUN_ADMN_VLM   /* 투여량(함량)         */
		                         ,  d.ICUN_CD                                                       /* 단위(함량)           */
		                         ,  d.SLCT_UNIT_DVSN_CD                                             /* 투여량TYPE           */
		                         ,  d.MDTN_DDCN                                                     /* 일수                 */
		                         ,  d.DRUS_CD                                                       /* 용법                 */
		                         ,  d.MDNT                                                          /* 횟수                 */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.TOTL_CLCL_QTY, round(d.TOTL_CLCL_QTY, 2)) TOTL_VLM     /* 총량(계산)           */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.INVN_TOTL_QTY, round(d.INVN_TOTL_QTY, 2)) FRNS_VLM     /* 총량(계산)           */
		                         ,  d.PHDP_CMMD_BNDL_NO                                             /* 약제부 묶음번호       */
		                         ,  d.DRBN_NO                          DRBN_NO                      /* 약묶음번호           */
		                         ,  d.MIX_KIND_CD                           MIX_KIND_CD             /* MIX종류              */
		                         ,  d.BSIS_CMMD_PLAC_CD                           BSIS_CMMD_PLAC_CD /* 조제장소             */
		                         ,  replace(d.SPSB_CTN, chr(13)||chr(10), '')   SPSB_CTN /* 특기사항             */
		                         ,  null                                        as FDNO_YN /* 정수품유무 */
		                         ,  d.ISDV_CD                                                       /* 보험구분(수납시)     */
		                         ,  to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT        /* 입력일시             */
		                         ,  d.SDPF_EXRE_CD                                                  /* 의약분업예외사유코드 */
		                         ,  d.INJC_PLAC_CD                                                  /* 주사장소             */
		                         ,  d.OHOR_RTRN_YN                                                  /* 원외처방반납여부     */
		                         ,  d.BEMD_NO                            TRGT_BEMD_NO               /* 투석실 처방번호      */
		                         ,  d.ATTR_NO                                                       /* AUTO TRACK번호       */
		                         ,  case
		                                    when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                                    when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                                    when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                                end                                 DURV_RESN_CTN           /* 상호작용 comment     */
		                         ,  a.PTNO                                                          /* 환자번호             */
		                         ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT                  /* 접수일시             */
		                         ,  a.MCDP_CD                                                       /* 진료과               */
		                         ,  a.WARD_CD                                                       /* 병동                 */
		                         ,  a.ODDR_ID                                                       /* 처방의(외래,병동)    */
		                         ,  a.GNDR_ID CHDR_ID                                               /* 주치의(병동)         */
		                         ,  a.RCPC_YN                             RCST_CD                   /* 수납구분             */
		                         ,  a.UPDT_BEMD_NO                                                  /* 수정전 투약번호      */
		                         ,  a.DRUG_INJC_DVSN_CD                                             /* 약주사구분           */
		                         ,  a.PHDP_OROC_DPRT_CD                                                       /* 처방발생원           */
		                         ,  a.TKMD_CCHN_YN                                                  /* 복약지도여부         */
		                         ,  a.IHOH_DVSN_CD                                                  /* 원내외구분           */
		                         ,  a.NRDR_YN                                                       /* 마약여부             */
		                         ,  a.PSDG_YN                                                       /* 향정여부             */
		                         ,  a.CLNC_YN                                                       /* 임상여부             */
		                         ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD                /* 입원일자(내원일시)   */
		                         ,  e.MDPR_NM                                                       /* 약품명               */
		                         ,  decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN1
		                                                                   , f.ENVL_MEMO_CTN1) ENVL_MEMO_CTN1 /* 봉투1                */
		                         ,  decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN2
		                                                                   , f.ENVL_MEMO_CTN2) ENVL_MEMO_CTN2 /* 봉투2                */
		                         ,  b.PTNT_NM                                                       /* 환자명               */
		                         ,  b.FRRN                                                          /* 주민번호1            */
		                         ,  b.BRRN                                                          /* 주민번호2            */
		                         ,  trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'-'||
		                            trunc(mod(months_between(a.ORDR_YMD, b.BTDT), 12))   AFI_AGE_VL_STR
		                         ,  b.GEND_CD                                                       /* 성별                 */
		                         ,  h.ISTY_CD                                                       /* 급여종별코드         */
		                         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                                from CCCMCDDMT A, CCCMCDDLT B
		                               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                                 and A.COMN_GRP_CD   = 'AI003'
		                                 and A.COMN_DTLS_CD  = h.ISTY_CD
		                                 and B.LNGG_CD(+) = nvl( '', '*') )    ISTY_CDNM   /* 급여종별이름         */
		                         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = a.ODDR_ID)           ODDR_NM    /* 처방의(외래,병동)    */
		                         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = a.GNDR_ID)           CHDR_NM    /* 주치의(병동)         */
		                         ,  'N'                                                                            SBSN_MDPR_ABSL_DSLW_YN    /* 대체약품절대불가     */
		                         ,  g2.USER_LCNS_NO                                                 /* 면허번호             */
		                         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                                from CCCMCDDMT A, CCCMCDDLT B
		                               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                                 and A.COMN_GRP_CD   = 'SD003'
		                                 and A.COMN_DTLS_CD  = e.KPNG_PLAC_CD
		                                 and B.LNGG_CD(+)    = nvl( '', '*') )   KPNG_PLAC_NM       /* 보관장소             */
		                         ,  c.PTRM_NO                                                       /* 병실번호             */
		                         ,  ''      VALD_HH                                                 /* 유효시간             */
		                         ,  e.RELS_YN                                                       /* 청구약품여부         */
		                         ,  ''                                  WARD_LABL_PRIN_YN           /* 출력여부             */
		                         ,  ''                                  EDI_CD                      /* EDI 코드             */
		                         ,  ''                                  ISTY_ASST_CD                /* 유형보조             */
		                         ,  ''                                  SCIN_CD                     /* 상병코드             */
		                         ,  to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') MDTN_STRT_YMD      /* 실시일자        */
		                         ,  ''                                  SCIN_NM                     /* 상병명               */
		                         ,  a.MDTN_NO                             MDTN_NO_3                 /* 투약번호             */
		                         ,  ''                                  AFI_IPDV_NM                 /* 계산내역급여구분     */
		                         ,  ''                                  ACKN_EDI_CD                 /* 계산내역EDI코드      */
		                         ,  ''                                  PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		                         ,  ''                                  AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		                         ,  ''                                  CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		                         ,  e.STST_DVSN_CD                                                  /* 통계구분             */
		                         ,  'N'                                 ATMT_CLAM_YN                /* 자동출력여부         */
		                         ,  e.WSCN_SNGN_YN                                                  /* 수제단독             */
		                         ,  b.NTNL_CD                                                       /* 외국인코드           */
		                         ,  e.PCUN_INLS_QTY                                                 /* 함량(마스터)         */
		                         ,  '' AFI_MDPR_ORLM_AGE_DDCN_STR
		                         ,  (select ERRM_ZONE_NM||'('||substr(fn_mn_patwardtelno_s(c.MDRP_NO),-4)||')' from MNEERRMZT where ERRM_LCTN_CD=j.ERRM_LCTN_CD) ERRM_LCTN_CD /*응급실내 환자세부위치 */
		                         ,  e.KORN_PDCT_NM                                                  /* 한글상품명            */
		                         ,  e.SMRY_MDPR_NM                                                  /* 라벨출력용 요약상품명 */
		                         ,  ''                                  SHDN_YN                     /* 차광약물여부          */
		                         ,  ''                                  CMMD_AFTR_KPNG_PLAC_CD      /* 조제 후 보관장소      */
		                         ,  'N'                                 SELF_MDTN_YN                /* Self Medication 여부  */
		                         ,  1                                   SELFSEQ                     /* Self Medication 용 순서 */
		                         ,  d.MDTN_LCDV_CD                                                  /* 투약위치              */
		                         ,  decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN        /* 임상시험약 여부       */
		                         ,  h.FRNS_CTRL_DVSN_CD
		                         ,  'N'                                 AUDT_YN
		                         ,  fn_sd_getaudfglist_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO, 1)    AFI_ORDR_AUDT_DVSN_NM
		                         ,  0                                   SCRN_DSPL_SQNC
		                         ,  ''                                  TRGT_MDPR_CD
		                         ,  ''                                  RMRK_CTN /* AUDT_RSLT_DVSN_CD */
		                         ,  ''                                  AUDT_RSLT_RMRK_CTN
		                         ,  decode(g2.PDA_NO, '', '', '(8-'||g2.PDA_NO||')')  CFDR_PDA_NO
		                         ,  e.HGRS_HGCC_MDPR_YN
		                         ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM2
		                         ,  c.MDRP_NO
		                         ,  e.INJT_STER_CMMD_YN
		                         ,  e.NTM_RFLC_YN                                                   /* 횟수반영여부         */
		                         ,  e.CMMD_UNSB_CTN                                                 /* 조제특이사항내용     */ /* 2020.08.26 추가 */
		                         ,  h.DRUG_ORDR_UNSL_CTN AS DRUG_ORDR_UNSL_CTN  -- 의사 특기사항
		                         ,  h.SUBJ_IDNT_NO  AS SUBJ_IDNT_NO -- Subject No.
		                         ,  h.SUBJ_INTI_VL  AS SUBJ_INTI_VL -- Initial
		                         ,  h.SUBJ_VIST_NM  AS SUBJ_VIST_NM -- VISIT No.
		                         ,  h.SUBJ_ADMN_VL  AS SUBJ_ADMN_VL -- Cycle No.
		                         ,  h.CLNC_EXAM_MDPR_CTN  AS CLNC_EXAM_MDPR_CTN -- Med No.
		                         ,  e.OTHS_CMMD_UNSB_CTN 
		                      from
		                            SDPORDDET d
		                         ,  SDPORDBAT a
		                         ,  APPTPTNTV b
		                         ,  MDMEDORDT h
		                         ,  APRCRPTNT c
		                         ,  SDDDGCDMT e
		                         ,  SDDMETCDT f
		                         ,  CCUSRDPHT g
		                         ,  CCUSERAMV g2
		                         ,  SDJFIXQTT i
		                         ,  MNEERRPAT j
		                     where
		                            d.ORDR_YMD >= to_date(#{ordrYmd}, 'YYYYMMDD')                    /* 처방일자             */
		                       and  d.ORDR_YMD <= to_date(#{ordrYmd2}, 'YYYYMMDD')                  /* 처방일자             */
		                       and  instr(#{mdtnNoDvsnCd}, d.MDTN_NO_DVSN_CD) > 0                  /* 처방형태구분         */
		                       and  d.MDTN_NO >= #{mdtnNo1}                                         /* 투약번호             */
		                       and  d.MDTN_NO <= #{mdtnNo2}                                         /* 투약번호             */
		                       and  d.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, d.MDTN_LCDV_CD, 'A', d.MDTN_LCDV_CD, #{mdtnLcdvCd}) /* 투약위치 */
		                       and  nvl(d.INJC_PLAC_CD,'*') = nvl(#{injcPlacCd}, nvl(d.INJC_PLAC_CD,'*'))             /* 주사장소             */
		                       and  (
		                                (
		                                    (#{odkiCd} = 'D')
		                                   and  (d.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6') or (d.BSIS_CMMD_PLAC_CD = 'A'   and  d.DRAP_DVSN_CD != '2'))
		                                )
		                                or
		                                (
		                                    (#{odkiCd} = 'I')
		                                   and  (d.BSIS_CMMD_PLAC_CD in ('7', '8', '9', 'B') or (d.BSIS_CMMD_PLAC_CD = 'A'  and  d.DRAP_DVSN_CD = '2'))
		                                )
		                                 or
		                                (
		                                    ( (instr(#{odkiCd} , 'T') > 0) or (instr(#{odkiCd} , 'U') > 0) ) and  d.BSIS_CMMD_PLAC_CD in ('T', 'U', 'V')
		                                )
		                            )
		                       and  a.ORDR_YMD         = d.ORDR_YMD                                 /* 처방일자             */
		                       and  a.MDTN_NO_DVSN_CD  = d.MDTN_NO_DVSN_CD                          /* 투약번호구분         */
		                       and  a.MDTN_NO          = d.MDTN_NO                                  /* 투약번호             */
		                       and  a.MDTN_LCDV_CD     = d.MDTN_LCDV_CD                             /* 투약번호             */
		                       and  a.WARD_CD          = nvl(#{wardCd}, a.WARD_CD)                   /* 병동                 */
		                       and  b.PTNO = a.PTNO                                                 /* 환자번호             */
		                       and  h.PTNO      = a.PTNO
		                       and  h.ORDR_YMD  = a.ORDR_YMD
		                       and  h.ORDR_SNO  = d.ORDR_SNO
		                       and  c.MDRP_NO  = h.MDRP_NO
		                       and  e.MDPR_CD = d.MDPR_CD                                           /* 약품코드             */
		                       and  f.DRUS_CD(+) = d.DRUS_CD                                        /* 용법                 */
		                       and  g.USER_ID(+) = a.ODDR_ID                                        /* 처방의(외래,병동)   */
		                       and  g2.LGIN_ID   = g.LGIN_ID
		                       and  i.DPRT_CD          (+) = d.INJC_PLAC_CD
		                       and  i.MDPR_CD          (+) = d.MDPR_CD
		                       and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		                       and  j.PTNO   (+) = a.PTNO                                           /* 응급간호환자번호     */
		                       and  j.COHS_DT(+) = a.MDCR_YMD
		                       and  nvl((select /*+ index ( a1 mdmedordt_pk )
		                                            INDEX (B1, SDJDGRTNT_I06)  */
		                                     'Y'
		                               from
		                                    MDMEDORDT a1,
		                                    SDJDGRTNT b1
		                              where
		                                    a1.PTNO = h.PTNO
		                                and a1.ORDR_YMD = h.ORDR_YMD
		                                and a1.ORDR_SNO = h.ORDR_SNO
		                                and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                     or
		                                       nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                and a1.ORDR_YMD = b1.ORDR_YMD
		                                and a1.PTNO = b1.PTNO
		                                and a1.ORDR_SNO = b1.ORDR_SNO
		                                and b1.DRUG_RTRE_CD = '7'
		                                and rownum = 1
		                            ),'N') <> 'Y'
		                     union  all
		                    select  /*+ ordered use_nl(a b c d e f)         */
		                            to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD                     /* 처방일자             */
		                         ,  to_char(a.ORDR_DT
		                                   , 'YYYYMMDDHH24MISS')       ORDR_DT                      /* 처방일시             */ /* 2020.08.21 추가 */
		                         ,  a.MDTN_NO_DVSN_CD                                               /* 처방형태구분         */
		                         ,  lpad(to_char(a.MDTN_NO), 4, '0')      MDTN_NO                   /* 투약번호             */
		                         ,  b.ORDR_SNO                                                      /* 처방번호             */
		                         ,  b.ORDR_CD                           MDPR_CD                     /* 약품코드             */
		                         ,  b.CODV_CD                             PTDV_CD                   /* 환자구분             */
		                         ,  b.MDPR_CLSF_CD                                                  /* 약분류               */
		                         ,  b.DRAP_DVSN_CD                                                  /* 약적용구분           */
		                         ,  b.DRUG_ORDR_PRSS_CD                          CMMD_STTS_CD       /* 조제 STATUS          */
		                         ,  decode(b.DRAP_DVSN_CD, '2', b.PCKN_UNAD_QTY, round(b.PCKN_UNAD_QTY, 2)) PCKN_UNAD_QTY   /* 투여량(포장)         */
		                         ,  b.PCUN_CD                            PCUN_CD                    /* 단위(포장)           */
		                         ,  decode(b.DRAP_DVSN_CD, '2', b.ICUN_ADMN_VLM, round(b.ICUN_ADMN_VLM, 2)) ICUN_ADMN_VLM   /* 투여량(함량)         */
		                         ,  b.ICUN_CD                                                       /* 단위(함량)           */
		                         ,  b.SLCT_UNIT_DVSN_CD                                             /* 투여량TYPE           */
		                         ,  b.DDCN                               MDTN_DDCN                  /* 일수                 */
		                         ,  b.DRUS_CD                                                       /* 용법                 */
		                         ,  b.NTM                                MDNT                       /* 횟수                 */
		                         ,  null                                TOTL_VLM                    /* 총량(계산)           */
		                         ,  null                                FRNS_VLM                    /* 총량(계산)           */
		                         ,  null                                PHDP_CMMD_BNDL_NO           /* 약제부 묶음번호       */
		                         ,  b.DRBN_NO                                                       /* 약묶음번호           */
		                         ,  b.MIX_KIND_CD                                                   /* MIX종류              */
		                         ,  null                                BSIS_CMMD_PLAC_CD            /* 조제장소             */
		                         ,  replace(replace(b.DRUG_ORDR_UNSL_CTN, chr(13)||chr(10), ''), chr(10), '')  SPSB_CTN          /* 특기사항             */
		                         ,  null                                FDNO_YN                     /* 정수품유무 */
		                         ,  null                                ISDV_CD                     /* 보험구분(수납시)     */
		                         ,  null                                DRUG_ORDR_INPT_DT           /* 입력일시             */
		                         ,  b.SDPF_EXRE_CD                                                  /* 의약분업예외사유코드 */
		                         ,  null                                PHRM_PTGO_CD                /* 주사장소             */
		                         ,  null                                OHOR_RTRN_YN                /* 원외처방반납여부     */
		                         ,  null                                TRGT_BEMD_NO                /* 투석실 처방번호      */
		                         ,  null                                ATTR_NO                     /* AUTO TRACK번호       */
		                         ,  null                                DURV_RESN_CTN               /* 상호작용 comment     */
		                         ,  a.PTNO                                                          /* 환자번호             */
		                         ,  null                                RPTN_DT                     /* 접수일시             */
		                         ,  b.MCDP_CD                                                       /* 진료과               */
		                         ,  b.WARD_CD                                                       /* 병동                 */
		                         ,  b.ODDR_ID                                                       /* 처방의(외래,병동)    */
		                         ,  b.CHDR_ID                                                       /* 주치의(병동)         */
		                         ,  b.RCST_CD                             RCST_CD                   /* 수납구분             */
		                         ,  null                                UPDT_BEMD_NO                /* 수정전 투약번호      */
		                         ,  null                                DRUG_INJC_DVSN_CD           /* 약주사구분           */
		                         ,  a.PHDP_OROC_DPRT_CD                                                       /* 처방발생원           */
		                         ,  null                                TKMD_CCHN_YN                /* 복약지도여부         */
		                         ,  null                                IHOH_DVSN_CD                /* 원내외구분           */
		                         ,  null                                NRDR_YN                     /* 마약여부             */
		                         ,  null                                PSDG_YN                     /* 향정여부             */
		                         ,  null                                CLNC_YN                     /* 임상여부             */
		                         ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD                /* 입원일자(내원일시)   */
		                         ,  '[지참약]'||c.MDPR_NM              MDPR_NM                      /* 약품명               */
		                         ,  null                                ENVL_MEMO_CTN1              /* 봉투1                */
		                         ,  null                                ENVL_MEMO_CTN2              /* 봉투2                */
		                         ,  d.PTNT_NM                           PTNT_NM                     /* 환자명               */
		                         ,  d.FRRN                                                          /* 주민번호1            */
		                         ,  d.BRRN                                                          /* 주민번호2            */
		                         ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'-'||
		                            trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12)) AFI_AGE_VL_STR  /* 나이                 */
		                         ,  d.GEND_CD                                                       /* 성별                 */
		                         ,  b.ISTY_CD                                                       /* 급여종별코드         */
		                         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                                from CCCMCDDMT A, CCCMCDDLT B
		                               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                                 and A.COMN_GRP_CD  = 'AI003'
		                                 and A.COMN_DTLS_CD = b.ISTY_CD
		                                 and B.LNGG_CD(+) = nvl( '', '*') )      PATTYPNM           /* 급여종별이름         */
		                         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = b.ODDR_ID)           ODDR_NM            /* 처방의(외래,병동)    */
		                         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = b.CHDR_ID)           CHDR_NM            /* 주치의(병동)         */
		                         ,  'N'                           SBSN_MDPR_ABSL_DSLW_YN            /* 대체약품절대불가     */
		                         ,  g2.USER_LCNS_NO                                                 /* 면허번호             */
		                         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                                from CCCMCDDMT A, CCCMCDDLT B
		                               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                                 and A.COMN_GRP_CD    = 'SD003'
		                                 and A.COMN_DTLS_CD   = c.KPNG_PLAC_CD
		                                 and B.LNGG_CD(+)     = nvl( '', '*') )  KPNG_PLAC_NM       /* 보관장소             */
		                         ,  f.PTRM_NO                                                       /* 병실번호             */
		                         ,  ''     VALD_HH                                                  /* 유효시간             */
		                         ,  null                                FDNO_YN                   /* 청구약품여부         */
		                         ,  null                                WARD_LABL_PRIN_YN           /* 출력여부             */
		                         ,  ''                                  EDICODE                     /* EDI코드              */
		                         ,  ''                                  ISTY_ASST_CD                /* 유형보조             */
		                         ,  ''                                  SCIN_CD                     /* 상병코드             */
		                         ,  null                                INJC_PRRN_YMD               /* 실시일자    */
		                         ,  ''                                  MAIN_SCIN_NM                /* 상병명               */
		                         ,  a.MDTN_NO                             MDTN_NO_3                 /* 투약번호             */
		                         ,  ''                                  AFI_IPDV_NM                 /* 계산내역급여구분     */
		                         ,  ''                                  ACKN_EDI_CD                 /* 계산내역EDI코드      */
		                         ,  ''                                  PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		                         ,  ''                                  AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		                         ,  ''                                  CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		                         ,  c.STST_DVSN_CD                                                  /* 통계구분             */
		                         ,  'Y'                                 ATMT_CLAM_YN                /* 자동출력여부         */
		                         ,  c.WSCN_SNGN_YN                                                  /* 수제단독             */
		                         ,  d.NTNL_CD                                                       /* 외국인코드           */
		                         ,  c.PCUN_INLS_QTY                                                 /* 함량(마스터)         */
		                         ,  '' AFI_MDPR_ORLM_AGE_DDCN_STR
		                         ,  null                                ERRM_LCTN_CD                /*응급실내 환자세부위치 */
		                         ,  c.KORN_PDCT_NM                                                  /* 한글상품명            */
		                         ,  '[지참약]'||c.SMRY_MDPR_NM             SMRY_MDPR_NM             /* 라벨 출력용 요약상품명 */
		                         ,  ''                                  SHDN_YN                     /* 차광약물여부          */
		                         ,  ''                                  CMMD_AFTR_KPNG_PLAC_CD      /* 조제 후 보관장소      */
		                         ,  'Y'                                 SELF_MDTN_YN                /* Self Medication 여부  */
		                         ,  2                                   SELFSEQ_ASIS                /* Self Medication 용 순서 */
		                         ,  a.MDTN_LCDV_CD                                                  /* 투약위치             */
		                         ,  decode(c.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN        /* 임상시험약 여부       */
		                         ,  b.FRNS_CTRL_DVSN_CD
		                         ,  'N'                                 AUDT_YN
		                         ,  ''                                  AFI_ORDR_AUDT_DVSN_NM
		                         ,  0                                   AUDSORTSEQ
		                         ,  ''                                  TRGT_MDPR_CD
		                         ,  ''                                  RMRK_CTN /* AUDT_RSLT_DVSN_CD */
		                         ,  ''                                  AUDT_RSLT_RMRK_CTN
		                         ,  decode(g2.PDA_NO, '', '', '(8-'||g2.PDA_NO||')')  CFDR_PDA_NO
		                         ,  c.HGRS_HGCC_MDPR_YN
		                         ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.ODDR_ID ) ODDR_NM2
		                         ,  f.MDRP_NO
		                         ,  c.INJT_STER_CMMD_YN
		                         ,  c.NTM_RFLC_YN
		                         ,  c.CMMD_UNSB_CTN                                                 /* 조제특이사항내용     */ /* 2020.08.26 추가 */
		                         ,  b.DRUG_ORDR_UNSL_CTN AS DRUG_ORDR_UNSL_CTN  -- 의사 특기사항
		                         ,  b.SUBJ_IDNT_NO  AS SUBJ_IDNT_NO -- Subject No.
		                         ,  b.SUBJ_INTI_VL  AS SUBJ_INTI_VL -- Initial
		                         ,  b.SUBJ_VIST_NM  AS SUBJ_VIST_NM -- VISIT No.
		                         ,  b.SUBJ_ADMN_VL  AS SUBJ_ADMN_VL -- Cycle No.
		                         ,  b.CLNC_EXAM_MDPR_CTN  AS CLNC_EXAM_MDPR_CTN -- Med No.
		                         ,  c.OTHS_CMMD_UNSB_CTN                          
		                      from
		                            SDPORDBAT a -- 처방조제기본
		                         ,  MDMEDORDT b -- 약처방
		                         ,  SDDDGCDMT c
		                         ,  APPTPTNTV d
		                         ,  CCUSRDPHT g
		                         ,  CCUSERAMV g2
		                         ,  APRCRPTNT f
		                     where  a.ORDR_YMD >= to_date(#{ordrYmd}, 'YYYYMMDD')  /* 처방일자             */
		                       and  a.ORDR_YMD <= to_date(#{ordrYmd2}, 'YYYYMMDD') /* 처방일자             */
		                       and  instr(#{mdtnNoDvsnCd}, a.MDTN_NO_DVSN_CD) > 0            /* 처방형태구분         */
		                       and  (
		                                        (instr(#{mdtnNoDvsnCd}, 'A') > 0)
		                                     or (instr(#{mdtnNoDvsnCd}, 'B') > 0)
		                                     or (instr(#{mdtnNoDvsnCd}, 'C') > 0)
		                                     or (instr(#{mdtnNoDvsnCd}, 'E') > 0)
		                                )
		                       and  a.MDTN_NO >= #{mdtnNo1}          /* 투약번호             */
		                       and  a.MDTN_NO <= #{mdtnNo2}            /* 투약번호             */
		                       and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd}) /* 투약위치 */
		                       and  b.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                       and  b.MDTN_NO      = a.MDTN_NO
		                       and  b.PTNO         = a.PTNO
		                       and  b.ORDR_YMD     = a.ORDR_YMD
		                       and  b.ORFR_CD      = 'S'                              /* Self Medication 조건 */
		                       and  nvl(b.DC_DVSN_CD, 'N') in ('N', 'Y')                      /* 삭제처방             */
		                       and  c.MDPR_CD = b.ORDR_CD
		                       and  d.PTNO     = a.PTNO
		                       and  g.USER_ID(+) = a.ODDR_ID
		                       and  g2.LGIN_ID   = g.LGIN_ID
		                       and  f.MDRP_NO  = b.MDRP_NO
		                     union  all
		                    select  /*+ ordered use_nl(x d a b c e f g h i j y)      */
		                            to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD                     /* 처방일자             */
		                         ,  to_char(a.ORDR_DT
		                                   , 'YYYYMMDDHH24MISS')       ORDR_DT                      /* 처방일시             */ /* 2020.08.21 추가 */
		                         ,  a.MDTN_NO_DVSN_CD                                               /* 처방형태구분         */
		                         ,  lpad(to_char(a.MDTN_NO), 4, '0')      MDTN_NO                   /* 투약번호             */
		                         ,  d.ORDR_SNO                                                      /* 처방번호             */
		                         ,  d.MDPR_CD                                                       /* 약품코드             */
		                         ,  a.PTDV_CD                                                       /* 환자구분             */
		                         ,  d.MDPR_CLSF_CD                                                  /* 약분류               */
		                         ,  d.DRAP_DVSN_CD                                                  /* 약적용구분           */
		                         ,  d.CMMD_STTS_CD                                                  /* 조제 STATUS          */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.PCKN_UNAD_QTY, round(d.PCKN_UNAD_QTY, 2)) PCKN_UNAD_QTY   /* 투여량(포장)         */
		                         ,  d.PCUN_NM                          PCUN_CD                      /* 단위(포장)           */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.ICUN_ADMN_VLM, round(d.ICUN_ADMN_VLM, 2)) ICUN_ADMN_VLM   /* 투여량(함량)         */
		                         ,  d.ICUN_CD                                                       /* 단위(함량)           */
		                         ,  d.SLCT_UNIT_DVSN_CD                                             /* 투여량TYPE           */
		                         ,  d.MDTN_DDCN                                                     /* 일수                 */
		                         ,  d.DRUS_CD                                                       /* 용법                 */
		                         ,  d.MDNT                                                          /* 횟수                 */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.TOTL_CLCL_QTY, round(d.TOTL_CLCL_QTY, 2)) TOTL_VLM     /* 총량(계산)           */
		                         ,  decode(d.DRAP_DVSN_CD, '2', d.INVN_TOTL_QTY, round(d.INVN_TOTL_QTY, 2)) FRNS_VLM     /* 총량(계산)           */
		                         ,  d.PHDP_CMMD_BNDL_NO                                             /* 약제부 묶음번호       */
		                         ,  d.DRBN_NO                                                       /* 약묶음번호           */
		                         ,  d.MIX_KIND_CD                                                   /* MIX종류              */
		                         ,  d.BSIS_CMMD_PLAC_CD                                             /* 조제장소             */
		                         ,  replace(d.SPSB_CTN, chr(13)||chr(10), '')   SPSB_CTN            /* 특기사항             */
		                         ,  null                                        as FDNO_YN /* 정수품유무 */
		                         ,  d.ISDV_CD                                                       /* 보험구분(수납시)     */
		                         ,  to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT     /* 입력일시             */
		                         ,  d.SDPF_EXRE_CD                          SDPF_EXRE_CD            /* 의약분업예외사유코드 */
		                         ,  d.INJC_PLAC_CD                           PHRM_PTGO_CD           /* 주사장소             */
		                         ,  d.OHOR_RTRN_YN                       OHOR_RTRN_YN               /* 원외처방반납여부     */
		                         ,  d.BEMD_NO                            TRGT_BEMD_NO               /* 투석실 처방번호      */
		                         ,  d.ATTR_NO                          ATTR_NO                      /* AUTO TRACK번호       */
		                         ,  case
		                                    when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                                    when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                                    when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                                end                                 DURV_RESN_CTN           /* 상호작용 comment     */
		                         ,  a.PTNO                                                          /* 환자번호             */
		                         ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT               /* 접수일시             */
		                         ,  a.MCDP_CD                                                       /* 진료과               */
		                         ,  a.WARD_CD                                                       /* 병동                 */
		                         ,  a.ODDR_ID                                                       /* 처방의(외래,병동)    */
		                         ,  a.GNDR_ID CHDR_ID                                               /* 주치의(병동)         */
		                         ,  a.RCPC_YN                             RCST_CD                   /* 수납구분             */
		                         ,  a.UPDT_BEMD_NO                                                  /* 수정전 투약번호      */
		                         ,  a.DRUG_INJC_DVSN_CD                                             /* 약주사구분           */
		                         ,  a.PHDP_OROC_DPRT_CD                                                       /* 처방발생원           */
		                         ,  a.TKMD_CCHN_YN                                                  /* 복약지도여부         */
		                         ,  a.IHOH_DVSN_CD                                                  /* 원내외구분           */
		                         ,  a.NRDR_YN                                                       /* 마약여부             */
		                         ,  a.PSDG_YN                                                       /* 향정여부             */
		                         ,  a.CLNC_YN                                                       /* 임상여부             */
		                         ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD             /* 입원일자(내원일시)   */
		                         ,  e.MDPR_NM                                                       /* 약품명               */
		                         ,  decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN1
		                                                                   , f.ENVL_MEMO_CTN1) ENVL_MEMO_CTN1 /* 봉투1                */
		                         ,  decode(nvl(b.NTNL_CD, 'KR'), 'KR', f.ENVL_MEMO_CTN2
		                                                                   , f.ENVL_MEMO_CTN2) ENVL_MEMO_CTN2 /* 봉투2                */
		                         ,  b.PTNT_NM                                                       /* 환자명               */
		                         ,  b.FRRN                                                          /* 주민번호1            */
		                         ,  b.BRRN                                                          /* 주민번호2            */
		                         ,  trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'-'||
		                            trunc(mod(months_between(a.ORDR_YMD, b.BTDT), 12)) AFI_AGE_VL_STR
		                         ,  b.GEND_CD                                                       /* 성별                 */
		                         ,  h.ISTY_CD                                                       /* 급여종별코드         */
		                         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                                from CCCMCDDMT A, CCCMCDDLT B
		                               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                                 and A.COMN_GRP_CD   = 'AI003'
		                                 and A.COMN_DTLS_CD  = h.ISTY_CD
		                                 and B.LNGG_CD(+)    = nvl( '', '*') )           PATTYPNM   /* 급여종별이름         */
		                         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = a.ODDR_ID)           ODDR_NM    /* 처방의(외래,병동)    */
		                         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = a.GNDR_ID)           CHDR_NM    /* 주치의(병동)         */
		                         ,  'N'                                                                            SBSN_MDPR_ABSL_DSLW_YN    /* 대체약품절대불가     */
		                         ,  g2.USER_LCNS_NO                                                  /* 면허번호             */
		                         , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                               from CCCMCDDMT A, CCCMCDDLT B
		                              where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                                and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                                and A.COMN_GRP_CD   = 'SD003'
		                                and A.COMN_DTLS_CD  = e.KPNG_PLAC_CD
		                                and B.LNGG_CD(+) = nvl( '', '*') )       KPNG_PLAC_NM       /* 보관장소             */
		                         ,  c.PTRM_NO                            PTRM_NO                    /* 병실번호             */
		                         ,  ''                                   VALD_HH                    /* 유효시간             */
		                         ,  e.RELS_YN                                                       /* 청구약품여부         */
		                         ,  ''                                  WARD_LABL_PRIN_YN           /* 출력여부             */
		                         ,  ''                                  EDICODE                     /* EDI 코드             */
		                         ,  ''                                  ISTY_ASST_CD                /* 유형보조             */
		                         ,  ''                                  SCIN_CD                     /* 상병코드             */
		                         ,  to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') INJC_PRRN_YMD   /* 실시일자        */
		                         ,  ''                                  MAIN_SCIN_NM                /* 상병명               */
		                         ,  a.MDTN_NO                             MDTN_NO_3                 /* 투약번호             */
		                         ,  ''                                  AFI_IPDV_NM                 /* 계산내역급여구분     */
		                         ,  ''                                  ACKN_EDI_CD                 /* 계산내역EDI코드      */
		                         ,  ''                                  PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		                         ,  ''                                  AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		                         ,  ''                                  CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		                         ,  e.STST_DVSN_CD                                                  /* 통계구분             */
		                         ,  'N'                                 ATMT_CLAM_YN                /* 자동출력여부         */
		                         ,  e.WSCN_SNGN_YN                                                  /* 수제단독             */
		                         ,  b.NTNL_CD                                                       /* 외국인코드           */
		                         ,  e.PCUN_INLS_QTY                                                 /* 함량(마스터)         */
		                         ,  '' AFI_MDPR_ORLM_AGE_DDCN_STR
		                         ,  (select ERRM_ZONE_NM||'('||substr(fn_mn_patwardtelno_s(c.MDRP_NO),-4)||')' from MNEERRMZT where ERRM_LCTN_CD=j.ERRM_LCTN_CD) ERRM_LCTN_CD /*응급실내 환자세부위치 */
		                         ,  e.KORN_PDCT_NM                                                  /* 한글상품명            */
		                         ,  e.SMRY_MDPR_NM                                                  /* 라벨출력용 요약상품명 */
		                         ,  ''                                  SHDN_YN                     /* 차광약물여부          */
		                         ,  ''                                  CMMD_AFTR_KPNG_PLAC_CD      /* 조제 후 보관장소      */
		                         ,  'N'                                 SELF_MDTN_YN                /* Self Medication 여부  */
		                         ,  1                                   SELFSEQ_ASIS                /* Self Medication 용 순서 */
		                         ,  d.MDTN_LCDV_CD                                                  /* 투약위치              */
		                         ,  decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN        /* 임상시험약 여부       */
		                         ,  h.FRNS_CTRL_DVSN_CD
		                         ,  'Y'                                    AUDT_YN
		                         ,  y.DETL_CD_NM                           AFI_ORDR_AUDT_DVSN_NM
		                         ,  y.SCRN_DSPL_SQNC                           AUDSORTSEQ
		                         ,  x.TRGT_MDPR_CD1||decode(x.TRGT_MDPR_CD2, null, null, '-'||x.TRGT_MDPR_CD2)  TRGT_MDPR_CD
		                         ,  x.TRGT_AUDT_VL1||decode(x.TRGT_AUDT_VL2, null, null, '-'||x.TRGT_AUDT_VL2)  RMRK_CTN /* AUDT_RSLT_DVSN_CD */
		                         ,  x.AUDT_RMRK_CTN                       AUDT_RSLT_RMRK_CTN
		                         ,  decode(g2.PDA_NO, '', '', '(8-'||g2.PDA_NO||')')  CFDR_PDA_NO
		                         ,  e.HGRS_HGCC_MDPR_YN
		                         ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM2
		                         ,  c.MDRP_NO
		                         ,  e.INJT_STER_CMMD_YN
		                         ,  e.NTM_RFLC_YN
		                         ,  e.CMMD_UNSB_CTN                                                 /* 조제특이사항내용     */ /* 2020.08.26 추가 */
		                         ,  h.DRUG_ORDR_UNSL_CTN AS DRUG_ORDR_UNSL_CTN  -- 의사 특기사항
		                         ,  h.SUBJ_IDNT_NO  AS SUBJ_IDNT_NO -- Subject No.
		                         ,  h.SUBJ_INTI_VL  AS SUBJ_INTI_VL -- Initial
		                         ,  h.SUBJ_VIST_NM  AS SUBJ_VIST_NM -- VISIT No.
		                         ,  h.SUBJ_ADMN_VL  AS SUBJ_ADMN_VL -- Cycle No.
		                         ,  h.CLNC_EXAM_MDPR_CTN  AS CLNC_EXAM_MDPR_CTN -- Med No.
		                         ,  e.OTHS_CMMD_UNSB_CTN 
		                      from
		                            SDAAUDRPT x -- 처방감사결과
		                         ,  SDPORDDET d -- 처방조제상세
		                         ,  SDPORDBAT a -- 처방조제기본
		                         ,  APPTPTNTV b
		                         ,  MDMEDORDT h
		                         ,  APRCRPTNT c
		                         ,  SDDDGCDMT e
		                         ,  SDDMETCDT f
		                         ,  CCUSRDPHT g
		                         ,  CCUSERAMV g2
		                         ,  SDJFIXQTT i
		                         ,  MNEERRPAT j
		                         ,  CCCMCDDMT y
		                     where  #{audtYn} is not null
		                       and  x.TRGT_ORDR_YMD1 >= to_date(#{ordrYmd}, 'YYYYMMDD')  /* 처방일자             */
		                       and  x.TRGT_ORDR_YMD1 <= to_date(#{ordrYmd2}, 'YYYYMMDD') /* 처방일자             */
		                       and  instr(#{mdtnNoDvsnCd}, x.TRGT_MDTN_NO_DVSN_CD1) > 0            /* 처방형태구분         */
		                       and  x.TRGT_MDTN_NO1 >= #{mdtnNo1}            /* 투약번호             */
		                       and  x.TRGT_MDTN_NO1 <= #{mdtnNo2}              /* 투약번호             */
		                       and  x.TRGT_MDTN_LCDV_CD1 = decode(#{mdtnLcdvCd}, null, x.TRGT_MDTN_LCDV_CD1
		                               , 'A', x.TRGT_MDTN_LCDV_CD1, #{mdtnLcdvCd}) /* 투약위치 */
		                       and  x.AUDT_TYPE_CD not in ('011', '012', '991')
		                       and  exists  (
		                                    select  /*+ no_unnest */
		                                            'Z'
		                                      from
		                                            SDAAUDRPT z
		                                     where  z.TRGT_ORDR_YMD1        = x.TRGT_ORDR_YMD1
		                                       and  z.TRGT_MDTN_NO_DVSN_CD1 = x.TRGT_MDTN_NO_DVSN_CD1
		                                       and  z.TRGT_MDTN_NO1         = x.TRGT_MDTN_NO1
		                                       and  z.TRGT_MDTN_LCDV_CD1    = x.TRGT_MDTN_LCDV_CD1
		                                       and  substr(z.AUDT_TYPE_CD, 1, 2) not in ('01', '02', '99'  )
		                             )
		                       and  d.ORDR_YMD        = x.TRGT_ORDR_YMD1
		                       and  d.MDTN_NO_DVSN_CD = x.TRGT_MDTN_NO_DVSN_CD1
		                       and  d.MDTN_NO         = x.TRGT_MDTN_NO1
		                       and  d.MDTN_LCDV_CD    = x.TRGT_MDTN_LCDV_CD1
		                       and  d.ORDR_SNO        = x.TRGT_ORDR_SNO1
		                       and  nvl(d.INJC_PLAC_CD,'*')    = nvl(#{injcPlacCd}, nvl(d.INJC_PLAC_CD,'*'))             /* 주사장소             */
		                       and  a.ORDR_YMD          = d.ORDR_YMD                         /* 처방일자             */
		                       and  a.MDTN_NO_DVSN_CD   = d.MDTN_NO_DVSN_CD                       /* 투약번호구분         */
		                       and  a.MDTN_NO           = d.MDTN_NO                             /* 투약번호             */
		                       and  a.MDTN_LCDV_CD      = d.MDTN_LCDV_CD                     /* 투약번호             */
		                       and  a.WARD_CD           = nvl(#{wardCd}, a.WARD_CD)           /* 병동                 */
		                       and  b.PTNO = a.PTNO                             /* 환자번호             */
		                       and  h.PTNO = a.PTNO
		                       and  h.ORDR_YMD = a.ORDR_YMD
		                       and  h.ORDR_SNO = d.ORDR_SNO
		                       and  c.MDRP_NO  = h.MDRP_NO
		                       and  e.MDPR_CD = d.MDPR_CD                      /* 약품코드             */
		                       and  f.DRUS_CD(+) = d.DRUS_CD                  /* 용법                 */
		                       and  g.USER_ID(+) = a.ODDR_ID                     /* 처방의(외래,병동)    */
		                       and  g2.LGIN_ID   = g.LGIN_ID
		                       and  i.DPRT_CD(+) = d.INJC_PLAC_CD
		                       and  i.MDPR_CD(+) = d.MDPR_CD
		                       and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		                       and  j.PTNO(+) = a.PTNO                          /* 응급간호환자번호     */
		                       and  j.COHS_DT(+) = a.MDCR_YMD                     /* 응급간호환자번호     */
		                       and  (
		                                (
		                                    (#{odkiCd} = 'D')
		                                   and  (d.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6') or (d.BSIS_CMMD_PLAC_CD = 'A'   and  d.DRAP_DVSN_CD != '2'))
		                                )
		                                or
		                                (
		                                    (#{odkiCd} = 'I')
		                                   and  (d.BSIS_CMMD_PLAC_CD in ('7', '8', '9', 'B') or (d.BSIS_CMMD_PLAC_CD = 'A'  and  d.DRAP_DVSN_CD = '2'))
		                                )
		                                 or
		                                (
		                                    (( instr(#{odkiCd} , 'T') > 0) or (instr(#{odkiCd} , 'U') > 0)) and  d.BSIS_CMMD_PLAC_CD in ('T', 'U', 'V')
		                                )
		                            )
		                       and  y.COMN_GRP_CD = 'SD600'
		                       and  y.COMN_DTLS_CD = x.AUDT_TYPE_CD
		                       and  nvl((select /*+ index ( a1 mdmedordt_pk )
		                                            INDEX (B1, SDJDGRTNT_I06)  */
		                                     'Y'
		                               from
		                                    MDMEDORDT a1,
		                                    SDJDGRTNT b1
		                              where
		                                    a1.PTNO = h.PTNO
		                                and a1.ORDR_YMD = h.ORDR_YMD
		                                and a1.ORDR_SNO = h.ORDR_SNO
		                                and a1.DRUG_ORDR_PRSS_CD <> '0'
		                                and  ( nvl(a1.DC_DVSN_CD, 'N') = 'Y'
		                                     or
		                                       nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                                and a1.ORDR_YMD = b1.ORDR_YMD
		                                and a1.PTNO = b1.PTNO
		                                and a1.ORDR_SNO = b1.ORDR_SNO
		                                and b1.DRUG_RTRE_CD = '7'
		                                and rownum = 1
		                            ),'N') <> 'Y'
		                   ) x
		           ) x
		     order
		        by
		            x.ORDR_YMD
		         ,  x.MDTN_LCDV_CD
		         ,  x.MDTN_NO_DVSN_CD
		         ,  x.AFI_MDTN_NO_STR
		         ,  x.SELF_MDTN_YN
		         ,  x.AUDT_YN
		         ,  x.SCRN_DSPL_SQNC
		         ,  x.oderkey
		         ,  x.PHDP_CMMD_BNDL_NO
		         ,  x.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAudtSheet-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoMdprCnfrDt" column="FDNO_MDPR_CNFR_DT"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN_1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO_1"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="istyNm" column="ISTY_NM"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="valdHh" column="VALD_HH"/>
		<result property="insrEdiCd" column="INSR_EDI_CD"/>
		<result property="spsdId" column="SPSD_ID"/>
		<result property="scinCdCtn" column="SCIN_CD_CTN"/>
		<result property="scinCdCtn2" column="SCIN_CD_CTN_2"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="scinClncDxNm" column="SCIN_CLNC_DX_NM"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="nxtrApntYmd" column="NXTR_APNT_YMD"/>
		<result property="valdYmd" column="VALD_YMD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="hgcnKeepEtreCtn" column="HGCN_KEEP_ETRE_CTN"/>
		<result property="afiOnbrDvsnNm" column="AFI_ONBR_DVSN_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="afiPtqlCnfrNm" column="AFI_PTQL_CNFR_NM"/>
		<result property="afiOrdrAudtDvsnNm" column="AFI_ORDR_AUDT_DVSN_NM"/>
		<result property="scinCd2" column="SCIN_CD_2"/>
		<result property="scinNm2" column="SCIN_NM_2"/>
		<result property="adrsDetlNm" column="ADRS_DETL_NM"/>
		<result property="hicrNo" column="HICR_NO"/>
		<result property="bssyId" column="BSSY_ID"/>
		<result property="afiHimcNm" column="AFI_HIMC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="ptntTypeCd" column="PTNT_TYPE_CD"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="imagPathNm" column="IMAG_PATH_NM"/>
		<result property="afiPtdvNm" column="AFI_PTDV_NM"/>
		<result property="afiOtdpNm" column="AFI_OTDP_NM"/>
		<result property="clamMdprCd" column="CLAM_MDPR_CD"/>
		<result property="ohprPrinNtm" column="OHPR_PRIN_NTM"/>
		<result property="ptntEnsnNm" column="PTNT_ENSN_NM"/>
		<result property="ptntEnsnLsnm" column="PTNT_ENSN_LSNM"/>
		<result property="usrEnNm" column="USR_EN_NM"/>
		<result property="ensnMdprNm" column="ENSN_MDPR_NM"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN_3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN_4"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAudtSheet () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAudtSheet-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAudtSheet"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAudtSheet-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAudtSheet */
		<![CDATA[
		select    /*+ sdd_porddet_l93$S01_감사용처방전을 조회 */
		                    to_char(a.ORDR_YMD, 'YYYYMMDD')  ORDR_YMD      /* 처방일자             */
		                 ,  a.MDTN_NO_DVSN_CD                              /* 처방형태구분         */
		                 ,  a.MDTN_NO                                      /* 투약번호             */
		                 ,  d.ORDR_SNO                                     /* 처방번호             */
		                 ,  d.MDPR_CD                                      /* 약품코드             */
		                 ,  a.PTDV_CD                                      /* 환자구분             */
		                 ,  d.MDPR_CLSF_CD                                 /* 약분류               */
		                 ,  d.DRAP_DVSN_CD                                 /* 약적용구분           */
		                 ,  d.CMMD_STTS_CD                                 /* 조제 STATUS          */
		                 ,  d.PCKN_UNAD_QTY                                /* 투여량(포장)         */
		                 ,  d.PCUN_NM                                      /* 단위(포장)           */
		                 ,  d.ICUN_ADMN_VLM                                /* 투여량(함량)         */
		                 ,  d.ICUN_CD                                      /* 단위(함량)           */
		                 ,  d.SLCT_UNIT_DVSN_CD                            /* 투여량TYPE           */
		                 ,  d.MDTN_DDCN                                    /* 일수                 */
		                 ,  d.DRUS_CD                                      /* 용법                 */
		                 ,  d.MDNT                                         /* 횟수                 */
		                 ,  d.TOTL_CLCL_QTY                                /* 총량(계산)           */
		                 ,  d.INVN_TOTL_QTY                                /* 총량(재고)           */
		                 ,  d.PHDP_CMMD_BNDL_NO
		                 ,  d.DRBN_NO                                      /* 약묶음번호           */
		                 ,  d.MIX_KIND_CD                                  /* MIX종류              */
		                 ,  d.BSIS_CMMD_PLAC_CD                            /* 조제장소             */
		                 ,  replace(replace(d.SPSB_CTN, chr(13)||chr(10), ' '), chr(10), ' ') SPSB_CTN /* 특기사항 */
		                 ,  d.FDNO_MDPR_CNFR_DT                            /* 정수품유무           */
		                 ,  d.ISDV_CD                                      /* 보험구분(수납시)     */
		                 ,  to_char(d.DRUG_ORDR_INPT_DT, 'YYYYMMDDHH24MISS')  DRUG_ORDR_INPT_DT /* 입력일시             */
		                 ,  d.SDPF_EXRE_CD                                 /* 의약분업예외사유코드 */
		                 ,  d.INJC_PLAC_CD                                 /* 주사장소             */
		                 ,  d.OHOR_RTRN_YN                                 /* 원외처방반납여부     */
		                 ,  d.BEMD_NO                                      /* 투석실 처방번호      */
		                 ,  d.ATTR_NO                                      /* AUTO TRACK번호       */
		                 ,  case
		                        when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                        when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                        when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                    end     DURV_RESN_CTN                          /* 상호작용 comment     */
		                 ,  a.PTNO                                         /* 환자번호             */
		                 ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS')    RPTN_DT     /* 접수일시             */
		                 ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.MCDP_CD),a.MCDP_CD) MCDP_CD /* 진료과               */
		                 ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.WARD_CD), '*')   WARD_CD    /* 병동                 */
		                 ,  h.ODDR_ID                                      /* 처방의(외래,병동)    */
		                 ,  decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, h.GNDR_ID), h.GNDR_ID) GNDR_ID /* 주치의(병동)         */
		                 ,  a.RCPC_YN                                      /* 수납구분             */
		                 ,  a.UPDT_BEMD_NO                                 /* 수정전 투약번호      */
		                 ,  a.DRUG_INJC_DVSN_CD                            /* 약주사구분           */
		                 ,  a.PHDP_OROC_DPRT_CD                            /* 처방발생원           */
		                 ,  a.TKMD_CCHN_YN                                 /* 복약지도여부         */
		                 ,  a.IHOH_DVSN_CD                                 /* 원내외구분           */
		                 ,  a.NRDR_YN                                      /* 마약여부             */
		                 ,  a.PSDG_YN                                      /* 향정여부             */
		                 ,  a.CLNC_YN                                      /* 임상여부             */
		                 ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS')  MDCR_YMD  /* 입원일자(내원일시)   */
		                 ,  e.MDPR_NM                 /* 약품명               */
		                 ,  f.ENVL_MEMO_CTN1      envl_memo_ctn_1     /* 봉투1                */
		                 ,  f.ENVL_MEMO_CTN2      envl_memo_ctn_2     /* 봉투2                */
		                 ,  b.PTNT_NM                                      /* 환자명               */
		                 ,  b.FRRN                                         /* 주민번호1            */
		                 ,  b.BRRN                                         /* 주민번호2            */
		                 ,  lpad(trunc(months_between(a.ORDR_YMD, b.BTDT)/12), 3, '0')||'-'||lpad(trunc(mod(months_between(a.ORDR_YMD, b.BTDT), 12)), 2, '0')  AGE_CTN
		                 ,  b.GEND_CD                                      /* 성별                 */
		                 ,  fn_sd_gethidetelno_s((select z.PTNT_TLNO
		                                                   from APPTCNPNV z
		                                                  where z.PTNO = b.PTNO
		                                                    and CNPN_DVSN_CD = 'BH'
		                                                      and CNPN_SNO = 1
		                                                      and rownum = 1))  PTNT_TLNO        /* 전화번호(집)         */
		                 ,  fn_sd_gethidetelno_s((select z.PTNT_TLNO
		                                                   from APPTCNPNV z
		                                                  where z.PTNO = b.PTNO
		                                                    and CNPN_DVSN_CD = 'BP'
		                                                    and CNPN_SNO = 1
		                                                    and rownum = 1))   ptnt_tlno_1       /* 전화번호(핸드폰)     */
		                 ,  case when ( (#{mcclWorkPrkyVl} is not null)
		                                and (h.CODV_CD not in ('D','I')) ) then
		                                                                        (
		                                                                         select ac1.ISTY_CD
		                                                                           from ACCLMCCTT ac1
		                                                                          where ac1.PTNO = h.PTNO
		                                                                            and ac1.ORDR_YMD = h.ORDR_YMD
		                                                                            and ac1.ORDR_SNO = h.ORDR_SNO
		                                                                            and ac1.MCCL_WORK_PRKY_VL = #{mcclWorkPrkyVl}  /*수납 전 계산상태 데이터*/
		                                                                            and ac1.CODV_CD in ('O', 'H', 'E')
		                                                                            and ac1.ORTA_NM = 'MDMEDORDT'
		                                                                            and nvl(ac1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                                                                            and rownum = 1
		                                                                        )
		                         else h.ISTY_CD
		                    end                 ISTY_CD   /* 급여종별코드         */
		                 ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD = 'AI003'
		                         and A.COMN_DTLS_CD = h.ISTY_CD
		                         and B.LNGG_CD(+) = nvl('', '*') )                         ISTY_NM                                  /* 급여종별이름         */
		                 ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = a.ODDR_ID )                 AFI_ODDR_NM                              /* 처방의(외래,병동)    */
		                 ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) )  GNDR_NM /* 주치의(병동)         */
		                 ,  '' SBSN_MDPR_ABSL_DSLW_YN                                                    /* 대체약품절대불가     */
		                 ,  g2.USER_LCNS_NO    USER_LCNS_NO                                        /* 면허번호             */
		                 ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD  = 'SD003'
		                         and A.COMN_DTLS_CD = e.KPNG_PLAC_CD
		                         and B.LNGG_CD(+) = nvl('', '*') )  KPNG_PLAC_NM                   /* 보관장소             */
		                 ,  0 VALD_HH                                                              /* 유효시간             */
		                 ,  i.INSR_EDI_CD                                                          /* EDI 코드             */
		                 ,  fn_sd_getvcode_s(h.ISTY_ASST_CD, a.ORDR_YMD)  SPSD_ID           /* 특정기호             */
		                 ,  ''     scin_cd_ctn                                                     /* 상병코드             */
		                 ,  ''     scin_cd_ctn_2                                                   /* QR코드용 상병        */
		                 ,  ''     clmn_nm_1                                                         /* 투약일시             */
		                 , (
		                       select
		                               t.SCIN_NM
		                         from MDPADIAGT t
		                        where  t.PTNO          = h.PTNO
		                          and  t.MDRP_NO       = h.MDRP_NO
		                          and  t.MAIN_SCIN_YN  = 'Y'
		                          and rownum < 2
		                    )  scin_clnc_dx_nm                      /* 상병명               */
		                 ,  ''   AFI_IPDV_NM            --rInstyp                                  /* 계산내역급여구분     */
		                 ,  ''   EDI_CD                --rEdicode                                  /* 계산내역EDI코드      */
		                 ,  ''   PTNT_TYPE_NM_2        --rPattyp                                   /* 계산내역환자유형     */
		                 ,  ''   AFI_ISTY_ASST_NM_2    --rTypecd                                   /* 계산내역유형보조     */
		                 ,  ''   NXTR_APNT_YMD   --        해당진료과의 다음예약일자               /* 외국인코드           */
		                 ,  ''   VALD_YMD     --  유효일 '' / FN_SD_GetNextDay_S(to_char(to_date( ordr_ymd, 'YYYYMMDD'),'yyyy-mm-dd'))||e.CALCODE
		                 ,  ''   TOTL_QTY_CLCL_CD     -- 총량계산코드  vald_ymd와 분리
		                 ,  ''   HGCN_KEEP_ETRE_CTN    --  '' / h.MULTIKIND||' '||fn_cc_codename_s('MM105', h.MULTIKIND)                                /* 고함량유지내용            */
		                 ,  ''   AFI_ONBR_DVSN_NM    -- sShortname                                 /* 본인부담코드 */
		                 ,  a.MDTN_LCDV_CD                                                         /* 투약위치              */
		                 ,  ''  AFI_PTQL_CNFR_NM        -- sPatstdfgnm
		                 ,  fn_sd_getoprtyntext_s( a.PTNO, a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_NO, a.MDTN_LCDV_CD, a.MCDP_CD ) AFI_ORDR_AUDT_DVSN_NM   --  fn.../''
		                 ,  ''  SCIN_CD_2    --  sMeddiagcode                                      /* 본인부담율인상 상병코드 */
		                 ,  ''  SCIN_NM_2    --  sMeddiagname                                      /* 본인부담율인상 상병명   */
		                 ,  ''  ADRS_DETL_NM     --  ''/ decode(a.drugyn,'Y',b.ZIPADDR||' '||b.ADDRESS,''),                                /* 주소                 */
		                 ,  ''  HICR_NO     --   sLicencno                                         /* 증번호               */
		                 ,  ''  BSSY_ID    --    sUnioncd                                          /* 조합기호             */
		                 ,  ''  AFI_HIMC_NM     --  ''/k.SPDEPT                                    /* EDI 진료과목         */
		                 ,  (select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD=a.MCCN_CD)  AFI_CNTR_NM     --   ''/l.CODENAME                                 /* 센터명               */
		                 ,  ''  PTNT_TYPE_CD
		                 ,  '' clmn_nm_2
		                 ,  '' imag_path_nm
		                 ,  decode( a.PTDV_CD  , 'O','외래', 'H', '가정간호', 'G', '건강의학', 'E', '응급실', 'D', 'DSC', 'I', '병동', a.PTDV_CD)  afi_ptdv_nm
		                 ,  (
		                         select
		                                 '중'
		                           from
		                                 SDPORDBAT  tt                           /* 처방내역기본         */
		                          where  tt.ORDR_YMD = a.ORDR_YMD                       /* 처방일자             */
		                            and  tt.MDTN_LCDV_CD = a.MDTN_LCDV_CD               /* 투약위치 */
		                            and  tt.PTNO            = a.PTNO                    /* 환자번호             */
		                            and  tt.PTDV_CD         = 'O'                       /* 환자구분             */
		                            and  tt.MDTN_NO_DVSN_CD = 'K'
		                            and  tt.MCDP_CD <> a.MCDP_CD
		                            and  rownum = 1                                     /* 진료과               */
		                     )  AFI_OTDP_NM  /* 타과진료여부 sd_ordba_l23 */
		                 ,  ''  CLAM_MDPR_CD
		                 ,  a.OHPR_PRIN_NTM
		                 ,  '' ptnt_ensn_nm
		                 ,  '' ptnt_ensn_lsnm
		                 ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) ) usr_en_nm /* 주치의(병동) - 영문        */
		                 ,  e.ENSN_PDCT_NM     ensn_mdpr_nm
		                 ,  ''                 envl_memo_ctn_3                          /* 봉투3                */
		                 ,  ''                 envl_memo_ctn_4                          /* 봉투4                */
		              from
		                    SDPORDBAT a
		                 ,  APPTPTNTV b
		                 ,  SDPORDDET d
		                 ,  SDDDGCDMT e
		                 ,  SDDMETCDT f
		                 ,  CCUSRDPHT g
		                 ,  CCUSERAMT g2
		                 ,  MDMEDORDT h
		                 ,  MNEERRPAT k
		                 ,  AIMFMDFET i
		             where  a.ORDR_YMD >= to_date(#{ordrYmd}, 'YYYYMMDD')     /* 처방일자             */
		               and  a.ORDR_YMD <= to_date(#{ordrYmd2}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = substr(#{mdtnNoDvsnCd}, 1, 1)       /* 처방형태구분         */
		               and  a.MDTN_NO between #{mdtnNo1}            /* 투약번호             */
		                                  and #{mdtnNo2}            /* 투약번호             */
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd}) /* 투약위치 */
		               and  b.PTNO = a.PTNO                                 /* 환자번호             */
		               and  d.ORDR_YMD        = a.ORDR_YMD                  /* 처방일자             */
		               and  d.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD           /* 투약번호구분         */
		               and  d.MDTN_NO         = a.MDTN_NO                   /* 투약번호             */
		               and  d.MDTN_LCDV_CD    = a.MDTN_LCDV_CD              /* 투약위치             */
		               and  e.MDPR_CD = d.MDPR_CD                           /* 약품코드             */
		               and  f.DRUS_CD(+)= d.DRUS_CD                         /* 용법                 */
		               and  g.USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID)    /* 처방의(외래,병동)    */
		               and  g2.LGIN_ID = g.LGIN_ID
		               and  h.PTNO     = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = d.ORDR_SNO
		               and  k.PTNO(+)    = a.PTNO
		               and  k.COHS_DT(+) = a.MDCR_YMD
		               and  i.MDFE_CD(+) = d.MDPR_CD
		               and  i.APST_YMD(+) <= d.ORDR_YMD
		               and  i.APFN_YMD(+) >= d.ORDR_YMD
		             order
		                by
		                    a.MDTN_NO
		                 ,  d.PHDP_CMMD_BNDL_NO
		                 ,  d.MDPR_CD
		                 ,  d.DRUS_CD
		                 ,  d.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneInOutOrdrMsg-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="clmnNm11" column="CLMN_NM_11"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneInOutOrdrMsg () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneInOutOrdrMsg-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneInOutOrdrMsg"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneInOutOrdrMsg-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneInOutOrdrMsg */
		<![CDATA[
		select  /*+ sdd_pordbat_l86$S01_원내외약처방문구조회 */
		            case
		                when #{ihohDvsnCd} = 'I' then '원내약이 있습니다'
		                when #{ihohDvsnCd} = 'O' then '원외처방이 있습니다.'
		            end   as CLMN_NM_11
		      from
		            SDPORDBAT a
		         ,  SDPORDDET b
		     where  a.PTNO         = #{ptno}
		       and  a.ORDR_YMD     = to_date(#{ordrYmd}, 'YYYYMMDD')
		       and  ( (#{ihohDvsnCd} = 'I'
		               and  a.MCDP_CD      = (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD=#{mcdpCd} and rownum=1)
		              )
		              or
		             ( #{ihohDvsnCd} <> 'I'
		               and  a.MCDP_CD      = #{mcdpCd}
		              )
		            )
		       and  b.ORDR_YMD        = a.ORDR_YMD
		       and  b.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		       and  b.MDTN_NO         = a.MDTN_NO
		       and  b.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		       and  b.DRUS_CD        <> 'SAVE'
		       and  (
		                    (
		                            #{ihohDvsnCd} = 'I'
		                   and  b.MDTN_NO_DVSN_CD in ('O')
		                   and  b.CMMD_STTS_CD < '6'
		                   and  b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y'
		                   and  not exists (
		                            select  'Y'
		                              from  SDJDGRTNT s
		                             where  s.ORDR_YMD        = a.ORDR_YMD
		                               and  s.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                               and  s.MDTN_NO         = a.MDTN_NO
		                               and  s.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                               and  s.ORDR_SNO        = b.ORDR_SNO
		                               and  s.MDPR_CD         = b.MDPR_CD
		                               and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                               and  b.INVN_TOTL_QTY = fn_sd_getrtnqty_s(s.ORDR_YMD, s.MDTN_NO_DVSN_CD, s.MDTN_NO, s.MDTN_LCDV_CD, s.ORDR_SNO   )
		                                    )
		                    )
		                or  (
		                            #{ihohDvsnCd} = 'O'
		                     and  b.MDTN_NO_DVSN_CD in ('K')
		                    and  b.CMMD_STTS_CD < '6'
		                    )
		            )
		       and  rownum = 1
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheet-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoMdprCnfrDt" column="FDNO_MDPR_CNFR_DT"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="tkmdInftDrusCtn" column="TKMD_INFT_DRUS_CTN"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN_1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO_1"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="istyNm" column="ISTY_NM"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="valdHh" column="VALD_HH"/>
		<result property="insrEdiCd" column="INSR_EDI_CD"/>
		<result property="spsdId" column="SPSD_ID"/>
		<result property="scinCdCtn" column="SCIN_CD_CTN"/>
		<result property="scinCdCtn2" column="SCIN_CD_CTN_2"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="scinClncDxNm" column="SCIN_CLNC_DX_NM"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="nxtrApntYmd" column="NXTR_APNT_YMD"/>
		<result property="valdYmd" column="VALD_YMD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="hgcnKeepEtreCtn" column="HGCN_KEEP_ETRE_CTN"/>
		<result property="onbrDvsnCd" column="ONBR_DVSN_CD"/>
		<result property="afiOnbrDvsnNm" column="AFI_ONBR_DVSN_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="afiPtqlCnfrNm" column="AFI_PTQL_CNFR_NM"/>
		<result property="afiOrdrAudtDvsnNm" column="AFI_ORDR_AUDT_DVSN_NM"/>
		<result property="scinCd2" column="SCIN_CD_2"/>
		<result property="scinNm2" column="SCIN_NM_2"/>
		<result property="adrsDetlNm" column="ADRS_DETL_NM"/>
		<result property="hicrNo" column="HICR_NO"/>
		<result property="bssyId" column="BSSY_ID"/>
		<result property="afiHimcNm" column="AFI_HIMC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="ptntTypeCd" column="PTNT_TYPE_CD"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="imagPathNm" column="IMAG_PATH_NM"/>
		<result property="afiPtdvNm" column="AFI_PTDV_NM"/>
		<result property="afiOtdpNm" column="AFI_OTDP_NM"/>
		<result property="clamMdprCd" column="CLAM_MDPR_CD"/>
		<result property="ohprPrinNtm" column="OHPR_PRIN_NTM"/>
		<result property="ptntEnsnNm" column="PTNT_ENSN_NM"/>
		<result property="ptntEnsnLsnm" column="PTNT_ENSN_LSNM"/>
		<result property="usrEnNm" column="USR_EN_NM"/>
		<result property="ensnMdprNm" column="ENSN_MDPR_NM"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN_3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN_4"/>
		<result property="extsTlno" column="EXTS_TLNO"/>
		<result property="extsTlnoCtn" column="EXTS_TLNO_CTN"/>
		<result property="spsbCtn1" column="SPSB_CTN_1"/>
		<result property="scinCd3" column="SCIN_CD_3"/>
		<result property="scinCd4" column="SCIN_CD_4"/>
		<result property="istyCd2" column="ISTY_CD_2"/>
		<result property="cdVl" column="CD_VL"/>
		<result property="insrIpdvCd" column="INSR_IPDV_CD"/>
		<result property="prtcIpdvCd" column="PRTC_IPDV_CD"/>
		<result property="incsIpdvCd" column="INCS_IPDV_CD"/>
		<result property="tainIpdvCd" column="TAIN_IPDV_CD"/>
		<result property="insrBttyCd" column="INSR_BTTY_CD"/>
		<result property="prtcBttyCd" column="PRTC_BTTY_CD"/>
		<result property="incsBttyCd" column="INCS_BTTY_CD"/>
		<result property="tainBttyCd" column="TAIN_BTTY_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="afiInsrIpdvNm" column="AFI_INSR_IPDV_NM"/>
		<result property="afiInsrIpdvNm1" column="AFI_INSR_IPDV_NM1"/>
		<result property="ohphDslwYn" column="OHPH_DSLW_YN"/>
		<result property="ohphDslwCtn" column="OHPH_DSLW_CTN"/>
		<result property="bsplNm" column="BSPL_NM"/>
		<result property="insdNm" column="INSD_NM"/>
		<result property="insdRsrn" column="INSD_RSRN"/>
		<result property="tims1TotlQtyYn" column="TIMS1_TOTL_QTY_YN"/>
		<result property="dvsnCd" column="DVSN_CD"/>
		<result property="ptntEnsnNm" column="PTNT_ENSN_NM"/>
		<result property="ensnPdctNm" column="ENSN_PDCT_NM"/>
		<result property="sclwQldvCd" column="SCLW_QLDV_CD"/>
		<result property="istyAsstCd" column="ISTY_ASST_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheet () 
        Description :                                           원외처방전 조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheet-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheet"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheet-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheet */
		<![CDATA[
		select   /*+ leading (a d ) sdd_porddet_l92$S01_원외처방전 조회 */
		             to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD         /* 처방일자             */
		         ,  a.MDTN_NO_DVSN_CD                                   /* 처방형태구분         */
		         ,  a.MDTN_NO                                           /* 투약번호             */
		         ,  d.ORDR_SNO                                          /* 처방번호             */
		         ,  d.MDPR_CD                                           /* 약품코드             */
		         ,  a.PTDV_CD                                           /* 환자구분             */
		         ,  d.MDPR_CLSF_CD                                      /* 약분류               */
		         ,  d.DRAP_DVSN_CD                                      /* 약적용구분           */
		         ,  d.CMMD_STTS_CD                                      /* 조제 STATUS          */
		         ,  d.PCKN_UNAD_QTY                                     /* 투여량(포장)         */
		         ,  d.PCUN_NM                                           /* 단위(포장)           */
		         ,  d.ICUN_ADMN_VLM                                     /* 투여량(함량)         */
		         ,  d.ICUN_CD                                           /* 단위(함량)           */
		         ,  d.SLCT_UNIT_DVSN_CD                                 /* 투여량TYPE           */
		         ,  d.MDTN_DDCN                                         /* 일수                 */
		         ,  d.DRUS_CD                                           /* 용법                 */
		         ,  d.MDNT                                              /* 횟수                 */
		         ,  d.TOTL_CLCL_QTY                                     /* 총량(계산)           */
		         ,  d.INVN_TOTL_QTY                                     /* 총량(재고)           */
		         ,  d.PHDP_CMMD_BNDL_NO                                 /* 약묶음번호           */
		         ,  d.DRBN_NO                                           /* 약묶음번호           */
		         ,  d.MIX_KIND_CD                                       /* MIX종류              */
		         ,  d.BSIS_CMMD_PLAC_CD                                 /* 조제장소             */
		         ,  (replace(replace(d.SPSB_CTN, chr(13)||chr(10), ' '), chr(10), ' ') )    as SPSB_CTN  /* 특기사항             */
		         ,  d.FDNO_MDPR_CNFR_DT                                 /* 정수품유무           */
		         ,  d.ISDV_CD                                           /* 보험구분(수납시)     */
		         ,  to_char(d.DRUG_ORDR_INPT_DT, 'YYYYMMDDHH24MISS')   DRUG_ORDR_INPT_DT /* 입력일시             */
		         ,  d.SDPF_EXRE_CD                                      /* 의약분업예외사유코드 */
		         ,  d.INJC_PLAC_CD                                      /* 주사장소             */
		         ,  d.OHOR_RTRN_YN                                      /* 원외처방반납여부     */
		         ,  d.BEMD_NO                                           /* 투석실 처방번호      */
		         ,  d.ATTR_NO                                           /* AUTO TRACK번호       */
		         ,  substrb(case
		                when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		            end  , 1, 146 )     DURV_RESN_CTN                               /* 상호작용 comment     */
		         ,  a.PTNO                                              /* 환자번호             */
		         ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT      /* 접수일시             */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.MCDP_CD),a.MCDP_CD) MCDP_CD /* 진료과               */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.WARD_CD), '*')   WARD_CD    /* 병동                 */
		         ,  h.ODDR_ID                                           /* 처방의(외래,병동)    */
		         ,  decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) GNDR_ID     /* 주치의(병동)         */
		         ,  a.RCPC_YN                                           /* 수납구분             */
		         ,  a.UPDT_BEMD_NO                                      /* 수정전 투약번호      */
		         ,  a.DRUG_INJC_DVSN_CD                                 /* 약주사구분           */
		         ,  a.PHDP_OROC_DPRT_CD                                 /* 처방발생원           */
		         ,  a.TKMD_CCHN_YN                                      /* 복약지도여부         */
		         ,  a.IHOH_DVSN_CD                                      /* 원내외구분           */
		         ,  a.NRDR_YN                                           /* 마약여부             */
		         ,  a.PSDG_YN                                           /* 향정여부             */
		         ,  a.CLNC_YN                                           /* 임상여부             */
		         ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS')  MDCR_YMD          /* 입원일자(내원일시)   */
		         ,  e.KORN_PDCT_NM        MDPR_NM                              /* 약품명               */
		         ,  f.TKMD_INFT_DRUS_CTN  TKMD_INFT_DRUS_CTN             /* 복약안내용                      */
				 ,  f.ENVL_MEMO_CTN1      ENVL_MEMO_CTN_1                /* 봉투1                */
		         ,  '' ENVL_MEMO_CTN_2                                   /* 봉투2                */
		         ,  b.PTNT_NM                                           /* 환자명               */
		         ,  b.FRRN                                              /* 주민번호1            */
		         ,  b.BRRN                                              /* 주민번호2            */
		         ,  trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||trunc(mod(months_between(a.ORDR_YMD, b.BTDT), 12))||')'  AGE_CTN
		         ,  b.GEND_CD                                            /* 성별                 */
		         ,  fn_sd_gethidetelno_s((select z.PTNT_TLNO
		                                           from APPTCNPNV z
		                                          where z.PTNO = b.PTNO
		                                            and CNPN_DVSN_CD = 'BH'
		                                               and CNPN_SNO = 1
		                                               and rownum = 1))  PTNT_TLNO                  /* 전화번호(집)         */
		         ,  fn_sd_gethidetelno_s((select z.PTNT_TLNO
		                                           from APPTCNPNV z
		                                          where z.PTNO = b.PTNO
		                                            and CNPN_DVSN_CD = 'BP'
		                                            and CNPN_SNO = 1
		                                            and rownum = 1))   PTNT_TLNO_1               /* 전화번호(핸드폰)     */
		         ,  case when ( (#{mcclWorkPrkyVl} is not null)
		                        and (h.CODV_CD not in ('D','I')) ) then
		                                                                (
		                                                                 select ac1.ISTY_CD
		                                                                   from ACCLMCCTT ac1
		                                                                  where ac1.PTNO = h.PTNO
		                                                                    and ac1.ORDR_YMD = h.ORDR_YMD
		                                                                    and ac1.ORDR_SNO = h.ORDR_SNO
		                                                                    and ac1.MCCL_WORK_PRKY_VL = #{mcclWorkPrkyVl}  /*수납 전 계산상태 데이터. */
		                                                                    and ac1.CODV_CD in ('O', 'H', 'E')
		                                                                    and ac1.ORTA_NM = 'MDMEDORDT'
		                                                                    and nvl(ac1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                                                                    and rownum = 1
		                                                                )
		                 else h.ISTY_CD
		            end   ISTY_CD   /* 급여종별코드         */
		         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                from CCCMCDDMT A, CCCMCDDLT B
		               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                 and A.COMN_GRP_CD  = 'AI003'
		                 and A.COMN_DTLS_CD = h.ISTY_CD
		                 and B.LNGG_CD(+) = nvl( '', '*') )  ISTY_NM           /* 급여종별이름         */
		         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = h.ODDR_ID ) AFI_ODDR_NM                   /* 처방의(외래,병동)    */
		         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) ) GNDR_NM /* 주치의(병동)         */
		         ,  ''                 sbsn_mdpr_absl_dslw_yn             /* 대체약품절대불가     */
		         ,  g2.USER_LCNS_NO    user_lcns_no                       /* 면허번호             */
		         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                from CCCMCDDMT A, CCCMCDDLT B
		               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                 and A.COMN_GRP_CD = 'SD003'
		                 and A.COMN_DTLS_CD = e.KPNG_PLAC_CD
		                 and B.LNGG_CD(+) = nvl( '', '*') )      KPNG_PLAC_NM  /* 보관장소             */
		         ,  0 VALD_HH -- e.VALD_HH                                             /* 유효시간             */
		         ,  i.INSR_EDI_CD                                         /* EDI 코드             */
		         ,  substr(fn_sd_getvcode_s(h.ISTY_ASST_CD, a.ORDR_YMD), 1, 4)      SPSD_ID   /* v코드 조회  */
		         ,  ''     SCIN_CD_CTN     -- 상병코드 한 줄로 표시                  /* 상병코드             */
		         ,  ''     SCIN_CD_CTN_2   -- qr코드용 상병 한 줄로 표시             /* QR코드용 상병        */
		         ,  ''     CLMN_NM_1                                                 /* 컬럼명1            */
		         ,  h.HGCN_KEEP_ETRE_CTN        SCIN_CLNC_DX_NM                      /* 상병명,  2007.07.16 여기서는 고함량유지 특기사항            */
		         ,  ''   AFI_IPDV_NM                                                 /* 계산내역급여구분     */
		         ,  ''   EDI_CD                                                      /* 계산내역EDI코드      */
		         ,  ''   PTNT_TYPE_NM_2                                              /* 계산내역환자유형     */
		         ,  ''   AFI_ISTY_ASST_NM_2                                          /* 계산내역유형보조     */
		         ,  ''   NXTR_APNT_YMD   /*        해당진료과의 다음예약일자               * 외국인코드           */
		         ,  fn_sd_getnextday_s(to_char(to_date(#{ordrYmd}, 'YYYYMMDD'), 'yyyymmdd'))  VALD_YMD
		         ,  e.TOTL_QTY_CLCL_CD   /* 총량계산코드  vald_ymd와 분리  */
		         ,  h.HGCN_KEEP_RESN_CD||' '
		                || ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                       from CCCMCDDMT A, CCCMCDDLT B
		                      where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                        and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                        and A.COMN_GRP_CD = 'MM105'
		                        and A.COMN_DTLS_CD = h.HGCN_KEEP_RESN_CD
		                        and B.LNGG_CD(+) = nvl( '', '*') )   HGCN_KEEP_ETRE_CTN
		         ,  '' ONBR_DVSN_CD
		         ,  '' AFI_ONBR_DVSN_NM                                 /* 본인부담코드 */
		         ,  a.MDTN_LCDV_CD                                      /* 투약위치              */
		         ,  ''  AFI_PTQL_CNFR_NM                                /* 환자자격구분명 */
		         ,  fn_sd_getoprtyntext_s( a.PTNO, a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_NO, a.MDTN_LCDV_CD, a.MCDP_CD ) AFI_ORDR_AUDT_DVSN_NM   
		         ,  ''  SCIN_CD_2                                       /* 본인부담율인상 상병코드 */
		         ,  ''    SCIN_NM_2                                     /* 본인부담율인상 상병명   */
		         ,  decode(a.NRDR_YN, 'Y', n.ZPAD_NM||' '||n.DEAD_NM, '') ADRS_DETL_NM      /* 주소(마약있을때만) */
		         ,  ''   HICR_NO                                        /* 증번호                  */
		         ,  ''    BSSY_ID                                       /* 조합기호                */
		         ,  m.PTAD_ASTN_MCDP_CD   AFI_HIMC_NM                   /* EDI 진료과목            */
		         ,  (select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD=a.MCCN_CD)      AFI_CNTR_NM                       /* 센터명                  */
		         ,  ''  PTNT_TYPE_CD   --sPattyp_imsi
		         ,  '' CLMN_NM_2
		         ,  '' imag_path_nm
		         ,  decode( a.PTDV_CD  , 'O','외래', 'H', '가정간호', 'G', '건강의학', 'E', '응급실', 'D', 'DSC', 'I', '병동', a.PTDV_CD)  AFI_PTDV_NM
		         ,  ''                    AFI_OTDP_NM
		         ,  ''                    CLAM_MDPR_CD
		         ,  a.OHPR_PRIN_NTM       OHPR_PRIN_NTM
		         ,  b.PTNT_ENSN_NM        PTNT_ENSN_NM
		         ,  b.PTNT_ENSN_LSNM      PTNT_ENSN_LSNM
		         ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) ) USR_EN_NM /* 주치의(병동) - 영문        */
		         ,  e.MDPR_NM             ENSN_MDPR_NM
		         ,  f.ENVL_MEMO_CTN3      ENVL_MEMO_CTN_3                              /* 봉투3                */
		         ,  f.ENVL_MEMO_CTN4      ENVL_MEMO_CTN_4                              /* 봉투4                */
		         ,  substr(m.EXTS_TLNO_CTN,-4) /*g2.EXTS_TLNO*/ as EXTS_TLNO
		         ,  m.EXTS_TLNO_CTN                             as EXTS_TLNO_CTN
		         ,  decode(e.OTHS_CMMD_UNSB_CTN, null, '','{'||e.OTHS_CMMD_UNSB_CTN||'}')                                                                         
		            || decode(instr(nvl(lower(d.SPSB_CTN),'@'), 'powder'), 0, decode(h.MIX_KIND_CD, '2', '☞ powder,', ''))                           
		            || replace(replace(replace(d.SPSB_CTN,chr(13)||chr(10), ' '),chr(13), ' '),chr(10), ' ')                                                                                         
		            || decode(substr(e.MDPR_NM,length(e.MDPR_NM),1),'*',' 대체조제불가',' ')   as SPSB_CTN_1
		         ,  (select a1.SCIN_CD from MDPADIAGT a1 where a1.MDRP_NO = h.MDRP_NO and a1.MAIN_SCIN_YN  = 'Y' and rownum < 2) as SCIN_CD_3     /* 상병 */
		         ,  (select a1.SCIN_CD from MDPADIAGT a1 where a1.MDRP_NO = h.MDRP_NO and a1.MAIN_SCIN_YN != 'Y' and rownum < 2) as SCIN_CD_4 /* 부상병 */       
		         ,  decode(h.PTAD_IPDV_CD, '7', '7', decode(h.ORDR_IPDV_CD,'3','3', FN_SD_INSTYPE(h.ORDR_CD, h.ISTY_CD, h.ORDR_YMD)))          as ISTY_CD_2
		         ,  decode(h.PTAD_IPDV_CD, '7', decode(nvl(o.SCRG_INPY_ONBR_RT, '999'), '50', 'A', '80', 'B', '30', 'D', '90', 'E', ''), '')   as CD_VL
		         ,  o.INSR_IPDV_CD as INSR_IPDV_CD
		         ,  o.PRTC_IPDV_CD as PRTC_IPDV_CD
		         ,  o.INCS_IPDV_CD as INCS_IPDV_CD
		         ,  o.TAIN_IPDV_CD as TAIN_IPDV_CD
		         ,  o.INSR_BTTY_CD as INSR_BTTY_CD
		         ,  o.PRTC_BTTY_CD as PRTC_BTTY_CD
		         ,  o.INCS_BTTY_CD as INCS_BTTY_CD
		         ,  o.TAIN_BTTY_CD as TAIN_BTTY_CD      
		         ,  m.KORN_DPRT_NM          KORN_DPRT_NM                                    /* 한글진료과명                 */
		/*
				 , ( select decode(h.ORDR_IPDV_CD, '3', nvl((select DETL_CD_NM from CCCMCDDMT where 1=1 and comn_grp_cd = 'AIA_032' and COMN_DTLS_CD = i.SCRG_INPY_ONBR_RT), decode(F_A.COMN_DTLS_CD, '1', '1:', '2', '2:', '7' ,'3:','4','4:','5','5:','A','Z:','' ) || nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM))
				                          , nvl(
				                                 (select decode(aa.COMN_DTLS_CD,'7','3','A','Z',aa.COMN_DTLS_CD) ||':' || nvl(bb.DETL_CD_NM, aa.DETL_CD_NM)
				                                    from CCCMCDDMT aa
				                                       , CCCMCDDLT bb
				                                   where 1=1
				                                     and aa.COMN_GRP_CD  = 'AI041'
		                                             and aa.COMN_DTLS_CD != '1' *급여는 제외하고 조회 *
				                                     and aa.COMN_GRP_CD  = bb.COMN_GRP_CD(+)
				                                     and aa.COMN_DTLS_CD = bb.COMN_DTLS_CD(+)
				                                     and aa.COMN_DTLS_CD  = nvl(c.IPDV_CD,h.ORDR_IPDV_CD)  -- h.ORDR_IPDV_CD * 처방상급여정보 *
				                                     and rownum = 1
				                                  )
				                             * 처방상에 보헙급여코드가 없으면 수가마스터정보상의 급여정보를 보여줌 *
				                            , decode(F_A.COMN_DTLS_CD, '1', '1:', '2', '2:', '7' ,'3:','4','4:','5','5:','A','Z:','' ) || nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM) )
				                    )
				                      from CCCMCDDMT F_A,
				                           CCCMCDDLT F_B
				                     where  F_A.COMN_GRP_CD  = F_B.COMN_GRP_CD(+)
				                       and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
				                       and F_A.COMN_GRP_CD  = 'AI041'
		                               and F_A.COMN_DTLS_CD != '1' *급여는 제외하고 조회 *
				                       and F_A.COMN_DTLS_CD =  nvl(c.IPDV_CD,h.ORDR_IPDV_CD)
				                       and F_B.LNGG_CD(+) = nvl('', '*')) as AFI_INSR_IPDV_NM  *보험,선별급여 2020-06-11 by kjh*  * 급여 바코드구분을 위해 쿼리 수정 //ocs 에선 무조건 나머지 그외는 급여로 리턴 By..lsw *
				 , ( select decode(h.ORDR_IPDV_CD, '3', nvl((select DETL_CD_NM from CCCMCDDMT where 1=1 and comn_grp_cd = 'AIA_032' and COMN_DTLS_CD = i.SCRG_INPY_ONBR_RT),  nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM))
		                                  , '4', '100/100'
				                          , nvl(
				                                 (select nvl(bb.DETL_CD_NM, aa.DETL_CD_NM)
				                                    from CCCMCDDMT aa
				                                       , CCCMCDDLT bb
				                                   where 1=1
				                                     and aa.COMN_GRP_CD  = 'AI041'
		                                             and aa.COMN_DTLS_CD != '1' *급여는 제외하고 조회 *
				                                     and aa.COMN_GRP_CD  = bb.COMN_GRP_CD(+)
				                                     and aa.COMN_DTLS_CD = bb.COMN_DTLS_CD(+)
				                                     and aa.COMN_DTLS_CD  = nvl(c.IPDV_CD,h.ORDR_IPDV_CD) --h.ORDR_IPDV_CD * 처방상급여정보 *
				                                     and rownum = 1
				                                  )
				                             * 처방상에 보헙급여코드가 없으면 수가마스터정보상의 급여정보를 보여줌 *
				                            , nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM) )
				                    )
				                      from CCCMCDDMT F_A,
				                           CCCMCDDLT F_B
				                     where  F_A.COMN_GRP_CD  = F_B.COMN_GRP_CD(+)
				                       and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
				                       and F_A.COMN_GRP_CD  = 'AI041'
		                               and F_A.COMN_DTLS_CD != '1' *급여는 제외하고 조회 *
				                       and F_A.COMN_DTLS_CD = nvl(c.IPDV_CD,h.ORDR_IPDV_CD)
				                       and F_B.LNGG_CD(+) = nvl('', '*')) as AFI_INSR_IPDV_NM1
		*/
				 , ( select decode(h.ORDR_IPDV_CD, '3', nvl((select DETL_CD_NM from CCCMCDDMT where 1=1 and comn_grp_cd = 'AIA_032' and COMN_DTLS_CD = i.SCRG_INPY_ONBR_RT), decode(F_A.COMN_DTLS_CD, '1', '1:', '2', '2:', '7' ,'3:','4','4:','5','5:','A','Z:','' ) || nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM))
				                                      , nvl((select decode(aa.COMN_DTLS_CD,'7','3','A','Z',aa.COMN_DTLS_CD) ||':' || nvl(bb.DETL_CD_NM, aa.DETL_CD_NM)
		            		                                   from CCCMCDDMT aa
		            		                                      , CCCMCDDLT bb
		            		                                  where 1=1
		            		                                    and aa.COMN_GRP_CD  = 'AI041'
		                                                        and aa.COMN_DTLS_CD != '1' /*급여는 제외하고 조회 */
		            		                                    and aa.COMN_GRP_CD  = bb.COMN_GRP_CD(+)
		            		                                    and aa.COMN_DTLS_CD = bb.COMN_DTLS_CD(+)
		            		                                    and aa.COMN_DTLS_CD  = decode((select  count(*)     /* 보훈환자의 보훈비급여청구대상약품의 경우 급여로 전환 */
		                                                                                         from  ACCNCNPLT x
		                                                                                        where  x.CNPL_RDEX_CD = c.CNPL_CD
		                                                                                          and  h.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		                                                                                          and  x.CNPL_DVSN_CD = 'B1'
		                                                                                          and  nvl(c.IPDV_CD,h.ORDR_IPDV_CD) in ('2','4')
		                                                                                          and  o.PVAF_NNPY_CLAM_YN = 'Y'), 0, nvl(c.IPDV_CD,h.ORDR_IPDV_CD), '1')
		            		                                    and rownum = 1
				                                            )
				                             /* 처방상에 보헙급여코드가 없으면 수가마스터정보상의 급여정보를 보여줌 */
				                            , decode(F_A.COMN_DTLS_CD, '1', '1:', '2', '2:', '7' ,'3:','4','4:','5','5:','A','Z:','' ) || nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM) )
				                    )
				                      from CCCMCDDMT F_A,
				                           CCCMCDDLT F_B
				                     where  F_A.COMN_GRP_CD  = F_B.COMN_GRP_CD(+)
				                       and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
				                       and F_A.COMN_GRP_CD  = 'AI041'
		                               and F_A.COMN_DTLS_CD != '1' /*급여는 제외하고 조회 */
				                       and F_A.COMN_DTLS_CD =  decode((select  count(*)     /* 보훈환자의 보훈비급여청구대상약품의 경우 급여로 전환 */
		                                                                 from  ACCNCNPLT x
		                                                                where  x.CNPL_RDEX_CD = c.CNPL_CD
		                                                                  and  h.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		                                                                  and  x.CNPL_DVSN_CD = 'B1'
		                                                                  and  nvl(c.IPDV_CD,h.ORDR_IPDV_CD) in ('2','4')
		                                                                  and  o.PVAF_NNPY_CLAM_YN = 'Y'), 0, nvl(c.IPDV_CD,h.ORDR_IPDV_CD), '1')
				                       and F_B.LNGG_CD(+) = nvl('', '*')) as AFI_INSR_IPDV_NM
				 , ( select decode(h.ORDR_IPDV_CD, '3', nvl((select DETL_CD_NM from CCCMCDDMT where 1=1 and comn_grp_cd = 'AIA_032' and COMN_DTLS_CD = i.SCRG_INPY_ONBR_RT),  nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM))
		                                  , '4', '100/100'
				                          , nvl(
				                                 (select nvl(bb.DETL_CD_NM, aa.DETL_CD_NM)
				                                    from CCCMCDDMT aa
				                                       , CCCMCDDLT bb
				                                   where 1=1
				                                     and aa.COMN_GRP_CD  = 'AI041'
		                                             and aa.COMN_DTLS_CD != '1' /*급여는 제외하고 조회 */
				                                     and aa.COMN_GRP_CD  = bb.COMN_GRP_CD(+)
				                                     and aa.COMN_DTLS_CD = bb.COMN_DTLS_CD(+)
				                                     and aa.COMN_DTLS_CD = decode((select  count(*)     /* 보훈환자의 보훈비급여청구대상약품의 경우 급여로 전환 */
		                                                                             from  ACCNCNPLT x
		                                                                            where  x.CNPL_RDEX_CD = c.CNPL_CD
		                                                                              and  h.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		                                                                              and  x.CNPL_DVSN_CD = 'B1'
		                                                                              and  nvl(c.IPDV_CD,h.ORDR_IPDV_CD) in ('2','4')
		                                                                              and  o.PVAF_NNPY_CLAM_YN = 'Y'), 0, nvl(c.IPDV_CD,h.ORDR_IPDV_CD), '1')
				                                     and rownum = 1
				                                  )
				                             /* 처방상에 보헙급여코드가 없으면 수가마스터정보상의 급여정보를 보여줌 */
				                            , nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM) )
				                    )
				                      from CCCMCDDMT F_A,
				                           CCCMCDDLT F_B
				                     where  F_A.COMN_GRP_CD  = F_B.COMN_GRP_CD(+)
				                       and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
				                       and F_A.COMN_GRP_CD  = 'AI041'
		                               and F_A.COMN_DTLS_CD != '1' /*급여는 제외하고 조회 */
				                       and F_A.COMN_DTLS_CD = decode((select  count(*)     /* 보훈환자의 보훈비급여청구대상약품의 경우 급여로 전환 */
		                                                                from  ACCNCNPLT x
		                                                               where  x.CNPL_RDEX_CD = c.CNPL_CD
		                                                                 and  h.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		                                                                 and  x.CNPL_DVSN_CD = 'B1'
		                                                                 and  nvl(c.IPDV_CD,h.ORDR_IPDV_CD) in ('2','4')
		                                                                 and  o.PVAF_NNPY_CLAM_YN = 'Y'), 0, nvl(c.IPDV_CD,h.ORDR_IPDV_CD), '1')
				                       and F_B.LNGG_CD(+) = nvl('', '*')) as AFI_INSR_IPDV_NM1
		         , decode(h.ISTY_ASST_CD, '86', 'Y', '87', 'Y', '91', 'Y', '92', 'Y', 'N') as OHPH_DSLW_YN /* 86:타병원 재원환자(임플란트 포함), 87:타병원 재원환자(틀니) ,91:타병원 재원환자(의료급여 정신과), 92 : 타병원 타과 입원(본원 정신과 진료) 은 원외약국 사용불가 */
		         , '' as OHPH_DSLW_CTN
		         , '' as        BSPL_NM
		         , '' as        INSD_NM
		         , '' as        INSD_RSRN  
		         , e.TIMS1_TOTL_QTY_YN as TIMS1_TOTL_QTY_YN
		         , (case when ( substr(b.BRRN,1,1) in ('5','6','7','8') or
				              (b.FRRN||b.BRRN is null and b.PSPT_NO is not null) ) then 'Y'
				         else 'N'
			        end)  as DVSN_CD 
			     , b.PTNT_ENSN_NM
			     , e.ENSN_PDCT_NM
		         , '' as SCLW_QLDV_CD
		         , h.ISTY_ASST_CD
		      from
		            SDPORDBAT a
		         ,  APPTPTNTV b
		         ,  SDPORDDET d
		         ,  SDDDGCDMT e
		         ,  SDDMETCDT f
		         ,  CCUSRDPHT g
		         ,  CCUSERAMV g2
		         ,  MDMEDORDT h
		         ,  AIMFMDFET i
		         ,  MNEERRPAT k
		         ,  HZDEPTMMT m
		         ,  APPTADRSV n
		         ,  AIMFMDFET o       
		         ,  ACCLMCCLT c     
		     where  a.ORDR_YMD >= to_date(#{ordrYmd}, 'YYYYMMDD') /* 처방일자             */
		       and  a.ORDR_YMD <= to_date(#{ordrYmd2}, 'YYYYMMDD') /* 처방일자             */
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}           /* 처방형태구분         */
		       and  a.MDTN_NO between #{mdtnNo1}         /* 투약번호             */
		                          and #{mdtnNo2}         /* 투약번호             */
		       and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd}) /* 투약위치 */
		       and  b.PTNO  = a.PTNO                            /* 환자번호             */
		       and  d.ORDR_YMD        = a.ORDR_YMD              /* 처방일자             */
		       and  d.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD       /* 투약번호구분         */
		       and  d.MDTN_NO         = a.MDTN_NO               /* 투약번호             */
		       and  d.MDTN_LCDV_CD    = a.MDTN_LCDV_CD          /* 투약위치             */
		       and  d.CMMD_STTS_CD not in ('7', '8')            /* 진도                 */
		       and  nvl(d.OHOR_RTRN_YN, 'N') <> 'Y'             /* 반납처방제외         */
		       and  e.MDPR_CD = d.MDPR_CD                       /* 약품코드             */
		       and  f.DRUS_CD = d.DRUS_CD                       /* 용법                 */
		       and  g.USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, h.ODDR_ID), h.ODDR_ID)    /* 처방의(외래,병동)    */
		       and  g2.LGIN_ID = g.LGIN_ID
		       and  h.PTNO     = a.PTNO
		       and  h.ORDR_YMD = a.ORDR_YMD
		       and  h.ORDR_SNO = d.ORDR_SNO
		       and  nvl(h.DC_DVSN_CD, 'N') != 'X'
		       and  i.MDFE_CD  (+)  = d.MDPR_CD
		       and  i.APST_YMD (+) <= d.ORDR_YMD
		       and  i.APFN_YMD (+) >= d.ORDR_YMD
		       and  k.PTNO   (+) = a.PTNO                       /* 환자번호             */
		       and  k.COHS_DT(+) = a.MDCR_YMD                   /* 내원일시             */
		       and  m.DPRT_CD = a.MCDP_CD
		       and  n.PTNO         (+) = a.PTNO
		       and  n.ADRS_USGE_CD (+) = 'A'
		       and  n.ADRS_SNO     (+) = 1
		       and  o.MDFE_CD = h.ORDR_CD
		       and  nvl(h.ORDR_YMD,sysdate) between o.APST_YMD
		                                        and o.APFN_YMD      
		       and  c.PTNO      (+) = h.PTNO
		       and  c.ORDR_YMD  (+) = h.ORDR_YMD
		       and  c.ORDR_SNO  (+) = h.ORDR_SNO
		       and  c.MDFE_CD   (+) = h.ORDR_CD 
		       and  c.IHOH_ORDV_CD (+) ='O'                                       
		       and  c.CNCL_DT   (+) is null     
		     order
		        by
		            a.MDTN_NO
		         ,  d.PHDP_CMMD_BNDL_NO
		         ,  d.MDPR_CD
		         ,  d.DRUS_CD
		         ,  d.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneNxtrApntYmd-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="nxtrApntYmd" column="NXTR_APNT_YMD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneNxtrApntYmd () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneNxtrApntYmd-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneNxtrApntYmd"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneNxtrApntYmd-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneNxtrApntYmd */
		<![CDATA[
		  select   /*+ sdd_rcrptnt_s02$S01_다음예약일 조회 */
		                            to_char(min(MDCR_YMD),'yyyymmdd') nxtr_apnt_ymd
		                      from
		                            APRCRPTNT a
		                     where
		                            a.PTNO   = #{ptno}
		                       and  a.MDCR_YMD > to_date(#{mdcrYmd},'yyyymmddhh24miss')
		                       and  a.MCDP_CD = (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD=#{mcdpCd} and USE_YN='Y' and rownum < 2)
		                       and  a.MDCR_ANDV_CD not in ('8','9')
		                       and  nvl(a.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtn-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="scinCdCtn" column="SCIN_CD_CTN"/>
		<result property="scinCdCtn1" column="SCIN_CD_CTN_1"/>
		<result property="scinCd3" column="SCIN_CD_3"/>
		<result property="scinCd4" column="SCIN_CD_4"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtn-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtn"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtn-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtn */
		<![CDATA[
		select  /*+ sdd_padiagt_s01$S01_상병코드 조회 */
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 2, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 3, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 4, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 5, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 6, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))
		            SCIN_CD_CTN
		         ,  max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, '|'||replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 2, '|'||replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 3, '|'||replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))
		            SCIN_CD_CTN_1
		            /* 순서맞추기 위해서 다시 조회하자. */
		         ,  max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, a.SCIN_CD, '')))  as SCIN_CD_3
		         ,  max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, a.SCIN_CD, '')))  as SCIN_CD_4
		      from
		            (
		             select
		                     a.MAIN_SCIN_YN
		                  ,  a.SCIN_CD
		                  ,  c.MDCR_DT
		               from
		                     MDPADIAGT a
		                  ,  APRCRPTNT c
		                  ,  MDMEDORDT d
		              where
		                     d.PTNO   = #{ptno}
		                and  d.ORDR_YMD = to_date( #{ordrYmd} , 'YYYYMMDD')
		                and  d.ORDR_SNO = #{ordrSno}
		                and  a.MDRP_NO = c.MDRP_NO
		                and  a.MDRP_NO = d.MDRP_NO
		                and  a.MCDP_CD = (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD= #{mcdpCd} and USE_YN='Y' and rownum < 2)
		                and  #{gndrId} = decode( #{ptdvCd}, 'O', a.CHDR_ID , #{gndrId} )      /* MultiMainDiag  */
		            )  a
		            ,  MRBSSCINT b
		     where
		            b.SCIN_CD(+) = a.SCIN_CD
		       and  a.MDCR_DT between b.APLY_YMD(+) and b.FNSH_YMD(+) + 0.99999
		     group  by
		            decode(a.MAIN_SCIN_YN,'Y',0,rownum),
		            a.SCIN_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtnByErDsc-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="scinCdCtn" column="SCIN_CD_CTN"/>
		<result property="scinCdCtn1" column="SCIN_CD_CTN_1"/>
		<result property="scinCd3" column="SCIN_CD_3"/>
		<result property="scinCd4" column="SCIN_CD_4"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtnByErDsc () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtnByErDsc-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtnByErDsc"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtnByErDsc-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetScinCdCtnByErDsc */
		<![CDATA[
		select  /*+ sdd_padiagt_s02$S01_상병코드 조회(응급,DSC) */
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 2, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 3, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 4, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 5, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 6, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))
		            scin_cd_ctn
		         ,  max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, '|'||replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 2, '|'||replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 3, '|'||replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))
		            SCIN_CD_CTN_1
		            /* 순서맞추기 위해서 다시 조회하자. */
		         ,  max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, a.SCIN_CD, '')))  as SCIN_CD_3
		         ,  max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, a.SCIN_CD, '')))  as SCIN_CD_4
		      from
		            (
		             select
		                     a.MAIN_SCIN_YN
		                  ,  a.SCIN_CD
		                  ,  c.MDCR_DT
		               from
		                     MDPADIAGT a
		                  ,  APRCRPTNT c
		                  ,  MDMEDORDT d
		              where
		                     d.PTNO   = #{ptno}
		                and  d.ORDR_YMD = to_date(#{ordrYmd} , 'YYYYMMDD')
		                and  d.ORDR_SNO = #{ordrSno}
		                and  a.MDRP_NO = d.MDRP_NO
		                and  a.MDRP_NO = c.MDRP_NO
		                and  a.MCDP_CD = (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD=#{mcdpCd} and USE_YN='Y' and rownum < 2)
		                and  #{gndrId}  = decode( #{ptdvCd} , 'O', a.CHDR_ID , #{gndrId} )      /* MultiMainDiag  */
		            )  a
		         ,  MRBSSCINT b
		     where  b.SCIN_CD(+) = a.SCIN_CD
		       and  a.MDCR_DT between b.APLY_YMD(+) and b.FNSH_YMD(+) + 0.99999
		     group
		        by
		            decode(a.MAIN_SCIN_YN, 'Y', 0, rownum)
		         ,  a.SCIN_CD
		]]>	
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNm-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="onbrDvsnCd" column="ONBR_DVSN_CD"/>
		<result property="afiOnbrDvsnNm" column="AFI_ONBR_DVSN_NM"/>
		<result property="ptntTypeCd" column="PTNT_TYPE_CD"/>
		<result property="afiPtqlCnfrNm" column="AFI_PTQL_CNFR_NM"/>
		<result property="sclwQldvCd" column="SCLW_QLDV_CD"/>
		<result property="cnplCd" column="CNPL_CD"/>
		<result property="cnplDvsnCd" column="CNPL_DVSN_CD"/>
		<result property="cnplNm" column="CNPL_NM"/>
		<result property="cnplBrdnRt" column="CNPL_BRDN_RT"/>
		<result property="pvafNoVl" column="PVAF_NO_VL"/>
		<result property="scrgInpyOnbrRt" column="SCRG_INPY_ONBR_RT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNm () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNm-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNm"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNm-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNm */
		<![CDATA[
		select  /*+ sdd_padiagt_s03$S01_급여구분 정보 */
		            fn_sd_instypnm_s(decode((select  count(*)     /* 보훈환자의 보훈비급여청구대상약품의 경우 급여로 전환 */
		                                       from  ACCNCNPLT x
		                                      where  x.CNPL_RDEX_CD = d.CNPL_CD
		                                        and  d.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		                                        and  x.CNPL_DVSN_CD = 'B1'
		                                        and  d.IPDV_CD in ('2','4')
		                                        and  e.PVAF_NNPY_CLAM_YN = 'Y'), 0, d.IPDV_CD, '1'), substr(d.ISTY_CD, 1, 1), e.INSR_BTTY_CD) afi_ipdv_nm
		         ,  decode(substr(d.ISTY_CD, 1, 1), '1', e.INSR_EDI_CD
		                                          , '2', e.PRTC_EDI_CD
		                                          , '3', e.INCS_EDI_CD
		                                          , '5', e.TAIN_EDI_CD
		                                          ,  e.INSR_EDI_CD) edi_cd
		         ,  substr(d.ISTY_CD, 1, 1) ptnt_type_nm_2
		/*         ,  fn_sd_getvcode_s(d.ISTY_ASST_CD, a.ORDR_YMD)   afi_isty_asst_nm_2    유형보조  */ /* 2022.10.24 보훈적용으로 수정 */
		         ,  fn_ac_get_spsd_id(d.ISTY_CD, d.ISTY_ASST_CD, d.CNPL_CD, b.MDRP_NO)  as afi_isty_asst_nm_2  /* 유형보조 */
		/*         ,  decode(substr( fn_sd_getvcode_s(d.ISTY_ASST_CD, a.ORDR_YMD), 1, 4)
		                    , 'V252', ''
		                    , 'V000', '결핵' 
		                    , 'V101', '결핵' 
		                    , 'V206', '결핵' 
		                    , 'V246', '결핵' 
		                    , 'V274', '결핵' 
		                    ,  fn_sd_heavycancerrareno_s(d.PTNO, to_char(a.ORDR_YMD, 'YYYYMMDD'), substr(d.ISTY_CD, 1, 1), d.ISTY_ASST_CD)) */ /* 2022.10.24 보훈적용으로 수정 */
		         ,  decode(substr( FN_AC_GET_SPSD_ID(d.ISTY_CD, d.ISTY_ASST_CD, d.CNPL_CD, b.MDRP_NO), 1, 4), 'V252', '',
		                             fn_sd_heavycancerrareno_s(d.PTNO, to_char(a.ORDR_YMD, 'YYYYMMDD'), substr(d.ISTY_CD, 1, 1), d.ISTY_ASST_CD))
		                             /* 증중환자번호, 희귀난치병번호 */ clmn_nm_1
		         ,  d.ONBR_DVSN_CD
		         ,  '('||d.ONBR_DVSN_CD||':'
		                 || ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where   A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD = 'AI177'
		                         and A.COMN_DTLS_CD = d.ONBR_DVSN_CD
		                         and B.LNGG_CD(+) = nvl( '', '*') )   ||')' afi_onbr_dvsn_nm /* 2007.06.26 본인부담여부 관련 추가 */
		         ,  d.ISTY_CD ptnt_type_cd/* 2007.07.05 추가 */
		         ,  case when d.ISTY_CD = '12' then  'C 차상위대상자'
		                 when d.ISTY_CD = '13' then  'E 차상위2종대상자'
		                 when d.ISTY_CD = '14' then  'F 차상위2종(장애인)대상자'
		                 when d.SCLW_QLDV_CD = 'H' then 'H 의료지원대상자'
		                 else  ''
		             end       afi_ptql_cnfr_nm
		         ,  d.SCLW_QLDV_CD
		         ,  d.CNPL_CD
		         , (select x.CNPL_DVSN_CD from ACCNCNPLT x where x.CNPL_RDEX_CD = d.CNPL_CD and d.ORDR_YMD between x.APST_YMD and x.APFN_YMD)  as CNPL_DVSN_CD  /* B1:보훈감면, B2:보훈위탁감면 */
		         , (select x.CNPL_NM from ACCNCNPLT x where x.CNPL_RDEX_CD = d.CNPL_CD and d.ORDR_YMD between x.APST_YMD and x.APFN_YMD)  as CNPL_NM
		         , (select y.CNPL_BRDN_RT
		              from ACCNCNPLT x
		                 , ACCNRTDTT y
		             where x.CNPL_RDEX_CD = d.CNPL_CD
		               and d.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		               and y.BRIT_MNGM_NO = x.BRIT_MNGM_NO
		               and y.OTAM_DVSN_CD = DECODE(b.PTAD_CODV_CD,'O','O','H','O','I')
		               and y.BRIT_CD = 'INPY')                                                as CNPL_BRDN_RT
		         , (select x.PVAF_NO from APPVAFPTT x where x.PTNO = a.PTNO)                  as PVAF_NO_VL
		         , e.SCRG_INPY_ONBR_RT
		      from
		            SDPORDDET a
		         ,  (
		             select PTNO, ISTY_CD, ISTY_ASST_CD, ORDR_YMD, ORDR_SNO, IPDV_CD, ORTA_NM, ONBR_DVSN_CD, SCLW_QLDV_CD, MCDP_CD, MFDV_CD, MDFE_CD, IHOH_ORDV_CD, MTER_TCDV_CD
		                  , CNPL_CD
		               from ACCLMCCLT
		              where PTNO = #{ptno}
		                and (#{mcclWorkPrkyVl} is null or CODV_CD in ('D', 'I'))
		                and nvl(CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		              union all
		             select PTNO, ISTY_CD, ISTY_ASST_CD, ORDR_YMD, ORDR_SNO, IPDV_CD, ORTA_NM, ONBR_DVSN_CD, SCLW_QLDV_CD, MCDP_CD, MFDV_CD, MDFE_CD, IHOH_ORDV_CD, MTER_TCDV_CD
		                  , CNPL_CD
		               from ACCLMCCTT
		              where PTNO = #{ptno}
		                and MCCL_WORK_PRKY_VL = #{mcclWorkPrkyVl}     /*수납 전 계산상태 데이터. */
		                and CODV_CD in ('O', 'H', 'E')
		                and nvl(CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		            ) d
		         ,  MDMEDORDT b
		         ,  AIMFMDFET e
		     where
		            a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		       and  a.MDTN_NO = #{mdtnNo}
		       and  a.MDTN_LCDV_CD = #{mdtnLcdvCd} /* 투약위치 */
		       and  a.ORDR_SNO = #{ordrSno}
		       and  a.SDPF_EXRE_CD is null
		       and  d.ORDR_YMD = a.ORDR_YMD
		       and  d.MCDP_CD = (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD=#{mcdpCd} and USE_YN='Y' and rownum < 2)
		       and  d.ORDR_SNO = a.ORDR_SNO
		       and  d.MFDV_CD = 'S'
		       and  nvl(d.IHOH_ORDV_CD, 'I') = 'O'
		       and  ( d.ORTA_NM = 'MDMEDORDT'  or  d.ORTA_NM = 'MMMEDORT' )
		       and  d.MTER_TCDV_CD = '1'
		       and  b.PTNO = d.PTNO
		       and  b.ORDR_YMD = d.ORDR_YMD
		       and  b.ORDR_SNO = d.ORDR_SNO
		       and  (
		                  (nvl(b.INSR_YR3_INOU_DVSN_CD, '1') not in ('2', '3'))
		               or
		                  (b.INSR_YR3_INOU_DVSN_CD in ('2', '3') and  d.IPDV_CD = '1')
		             )
		       and  e.MDFE_CD(+) = d.MDFE_CD
		       and  e.APST_YMD(+) <= d.ORDR_YMD
		       and  e.APFN_YMD(+) >= d.ORDR_YMD
		       and  rownum < 2
		     order  by
		            decode(a.DRAP_DVSN_CD, '3', '1', a.DRAP_DVSN_CD)
		         ,  a.PHDP_CMMD_BNDL_NO
		         ,  a.BSIS_CMMD_PLAC_CD
		         ,  a.MIX_KIND_CD
		         ,  a.MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetV252-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="scinNm1" column="SCIN_NM_1"/>
		<result property="scinNm2" column="SCIN_NM_2"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetV252 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetV252-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetV252"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetV252-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetV252 */
		<![CDATA[
		 select  /*+ sdd_padiagt_s04$S01_상병코드 조회(V252) */
		            max(max(decode(rownum, 1, SCIN_CD, '')))||
		            max(max(decode(rownum, 2, '/'||SCIN_CD, '')))||
		            max(max(decode(rownum, 3, '/'||SCIN_CD, '')))||
		            max(max(decode(rownum, 4, '/'||SCIN_CD, '')))||
		            max(max(decode(rownum, 5, '/'||SCIN_CD, '')))||
		            max(max(decode(rownum, 6, '/'||SCIN_CD, '')))||
		            max(max(decode(rownum, 7, '/'||SCIN_CD, ''))) SCIN_NM_1
		         ,  max(max(decode(rownum, 1, SCIN_KORN_NM, '')))||
		            max(max(decode(rownum, 2, '/'||SCIN_KORN_NM, '')))||
		            max(max(decode(rownum, 3, '/'||SCIN_KORN_NM, '')))||
		            max(max(decode(rownum, 4, '/'||SCIN_KORN_NM, '')))||
		            max(max(decode(rownum, 5, '/'||SCIN_KORN_NM, '')))||
		            max(max(decode(rownum, 6, '/'||SCIN_KORN_NM, '')))||
		            max(max(decode(rownum, 7, '/'||SCIN_KORN_NM, ''))) SCIN_NM_2
		      from
		           (
		            select  /*+ ordered use_nl(a d f)  */
		                    rownum
		                 ,  decode(f.SCIN_CD, g.SCIN_STST_CD, f.SCIN_CD, g.SCIN_STST_CD) SCIN_CD
		                 ,  g.SCIN_KORN_NM
		              from
		                    SDPORDDET a
		                 ,  (select PTNO, ORDR_YMD, ORDR_SNO, ORTA_NM, MCDP_CD, MFDV_CD, IHOH_ORDV_CD, MTER_TCDV_CD, MDRP_NO, CNCL_DT
		                         from ACCLMCCLT
		                        where PTNO = #{ptno}
		                          and (#{mcclWorkPrkyVl} is null or CODV_CD in ('D', 'I'))
		                          and nvl(CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                        union all
		                       select PTNO, ORDR_YMD, ORDR_SNO, ORTA_NM, MCDP_CD, MFDV_CD, IHOH_ORDV_CD, MTER_TCDV_CD, MDRP_NO, CNCL_DT
		                         from ACCLMCCTT
		                        where PTNO = #{ptno}
		                          and MCCL_WORK_PRKY_VL = #{mcclWorkPrkyVl}     /*수납 전 계산상태 데이터. */
		                          and CODV_CD in ('O', 'H', 'E')
		                          and nvl(CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                      ) d
		                 ,  APRCRPTNT c
		                 ,  MDPADIAGT f
		                 ,  MRBSSCINT g
		                 ,  MZCTRLMMT b
		             where
		                    a.ORDR_YMD        = to_date(#{ordrYmd}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		               and  a.MDTN_NO         = #{mdtnNo}
		               and  a.MDTN_LCDV_CD    = #{mdtnLcdvCd} /* 투약위치 */
		               and  a.ORDR_SNO        = #{ordrSno}
		               and  a.SDPF_EXRE_CD is null
		               and  d.ORDR_YMD = a.ORDR_YMD
		               and  d.PTNO      = c.PTNO
		               and  d.MCDP_CD   = (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD=#{mcdpCd} and USE_YN='Y' and rownum < 2)
		               and  d.ORDR_SNO  = a.ORDR_SNO
		               and  d.MFDV_CD   = 'S'
		               and  nvl(d.IHOH_ORDV_CD, 'I') = 'O'
		               and  ( d.ORTA_NM = 'MDMEDORDT'  or  d.ORTA_NM = 'MMMEDORT' )
		               and  d.MTER_TCDV_CD = '1'
		               and  nvl(d.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		               and  f.PTNO    = d.PTNO
		               and  f.MDRP_NO = c.MDRP_NO
		               and  f.MDRP_NO = d.MDRP_NO
		               and  f.MCDP_CD = d.MCDP_CD
		               and  #{gndrId}  = decode( #{ptdvCd}, 'O', f.CHDR_ID , #{gndrId})      /* MultiMainDiag  */
		               and  b.MDCR_CTRL_CD = 'MM045'
		               and  f.SCIN_CD between b.MDCR_CTRL_CHRC_VL1 and b.MDCR_CTRL_CHRC_VL2
		               and  g.SCIN_CD = f.SCIN_CD
		               and  c.MDCR_DT between g.APLY_YMD and g.FNSH_YMD
		             order
		                by  f.MAIN_SCIN_YN desc
		             )
		     group by  rownum
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNmByErDsc-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="onbrDvsnCd" column="ONBR_DVSN_CD"/>
		<result property="afiOnbrDvsnNm" column="AFI_ONBR_DVSN_NM"/>
		<result property="ptntTypeCd" column="PTNT_TYPE_CD"/>
		<result property="afiPtqlCnfrNm" column="AFI_PTQL_CNFR_NM"/>
		<result property="cnplCd" column="CNPL_CD"/>
		<result property="cnplDvsnCd" column="CNPL_DVSN_CD"/>
		<result property="cnplNm" column="CNPL_NM"/>
		<result property="cnplBrdnRt" column="CNPL_BRDN_RT"/>
		<result property="pvafNoVl" column="PVAF_NO_VL"/>
		<result property="scrgInpyOnbrRt" column="SCRG_INPY_ONBR_RT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNmByErDsc () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNmByErDsc-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNmByErDsc"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNmByErDsc-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetIpdvNmByErDsc */
		<![CDATA[
		 select  /*+ sdd_clmcclt_s03$S01_급여구분 조회(응급실, DSC) */
		            fn_sd_instypnm_s(decode((select  count(*)     /* 보훈환자의 보훈비급여청구대상약품의 경우 급여로 전환 */
		                                       from  ACCNCNPLT x
		                                      where  x.CNPL_RDEX_CD = d.CNPL_CD
		                                        and  d.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		                                        and  x.CNPL_DVSN_CD = 'B1'
		                                        and  d.IPDV_CD in ('2','4')
		                                        and  e.PVAF_NNPY_CLAM_YN = 'Y'), 0, d.IPDV_CD, '1'), substr(d.ISTY_CD, 1, 1), e.INSR_BTTY_CD) afi_ipdv_nm
		         ,  decode(substr(d.ISTY_CD, 1, 1), '1', e.INSR_EDI_CD,
		                                              '2', e.PRTC_EDI_CD,
		                                            '3', e.INCS_EDI_CD,
		                                            '5', e.TAIN_EDI_CD,
		                                                 null) edi_cd
		         ,  substr(d.ISTY_CD, 1, 1) ptnt_type_nm_2
		/*         ,  fn_sd_getvcode_s(d.ISTY_ASST_CD, a.ORDR_YMD)  afi_isty_asst_nm_2    유형보조 */ /* 2022.10.24 보훈로직 적용으로 수정 */
		         ,  fn_ac_get_spsd_id(d.ISTY_CD, d.ISTY_ASST_CD, d.CNPL_CD, b.MDRP_NO)   afi_isty_asst_nm_2   /* 유형보조 */
		/*         ,  decode(substr( fn_sd_getvcode_s(d.ISTY_ASST_CD, a.ORDR_YMD), 1, 4), 'V252', '',
		                           fn_sd_heavycancerrareno_s(d.PTNO, to_char(a.ORDR_YMD, 'YYYY-MM-DD'),
		                           substr(d.ISTY_CD, 1, 1), d.ISTY_ASST_CD)) */ /* 2022.10.24 보훈로직 적용으로 수정 */
		         ,  decode(substr( FN_AC_GET_SPSD_ID(d.ISTY_CD, d.ISTY_ASST_CD, d.CNPL_CD, b.MDRP_NO), 1, 4), 'V252', '',
		                             fn_sd_heavycancerrareno_s(d.PTNO, to_char(a.ORDR_YMD, 'YYYYMMDD'), substr(d.ISTY_CD, 1, 1), d.ISTY_ASST_CD))
		                   /* 증중환자번호, 희귀난치병번호 */ clmn_nm_1
		         ,  d.ONBR_DVSN_CD
		         ,  '('||d.ONBR_DVSN_CD||':'
		            ||( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                  from CCCMCDDMT A, CCCMCDDLT B
		                 where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                   and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                   and A.COMN_GRP_CD   = 'AI177'
		                   and A.COMN_DTLS_CD  = d.ONBR_DVSN_CD
		                   and B.LNGG_CD(+)    = nvl( '', '*') )  ||')'  afi_onbr_dvsn_nm/* 2007.06.26 본인부담여부 관련 추가 */
		         ,  d.ISTY_CD ptnt_type_cd /* 2007.07.05 추가 */
		         ,  decode(d.SCLW_QLDV_CD, 'C', 'C 차상위대상자', 'H', 'H 의료지원대상자', 'E', 'E 차상위2종대상자', 'F', 'F 차상위2종(장애인)대상자', '') afi_ptql_cnfr_nm
		         ,  d.CNPL_CD
		         , (select x.CNPL_DVSN_CD from ACCNCNPLT x where x.CNPL_RDEX_CD = d.CNPL_CD and d.ORDR_YMD between x.APST_YMD and x.APFN_YMD)  as CNPL_DVSN_CD  /* B1:보훈감면, B2:보훈위탁감면 */
		         , (select x.CNPL_NM from ACCNCNPLT x where x.CNPL_RDEX_CD = d.CNPL_CD and d.ORDR_YMD between x.APST_YMD and x.APFN_YMD)  as CNPL_NM
		         , (select y.CNPL_BRDN_RT
		              from ACCNCNPLT x
		                 , ACCNRTDTT y
		             where x.CNPL_RDEX_CD = d.CNPL_CD
		               and d.ORDR_YMD between x.APST_YMD and x.APFN_YMD
		               and y.BRIT_MNGM_NO = x.BRIT_MNGM_NO
		               and y.OTAM_DVSN_CD = DECODE(b.PTAD_CODV_CD,'O','O','H','O','I')
		               and y.BRIT_CD = 'INPY')                                                as CNPL_BRDN_RT
		         , (select x.PVAF_NO from APPVAFPTT x where x.PTNO = a.PTNO)  as PVAF_NO_VL
		         , e.SCRG_INPY_ONBR_RT
		       from
		            SDPORDDET a
		          , (select PTNO, ORDR_YMD, MDFE_CD, IPDV_CD, ORDR_SNO, SCLW_QLDV_CD, ISTY_CD, ISTY_ASST_CD, ONBR_DVSN_CD, ORTA_NM, MCDP_CD, MFDV_CD, IHOH_ORDV_CD, MTER_TCDV_CD, MDRP_NO, CNCL_DT
		                  , CNPL_CD
		               from ACCLMCCLT
		              where PTNO = #{ptno}
		                and (#{mcclWorkPrkyVl} is null or CODV_CD in ('D', 'I'))
		                and nvl(CNCL_DT ,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		              union all
		             select PTNO, ORDR_YMD, MDFE_CD, IPDV_CD, ORDR_SNO, SCLW_QLDV_CD, ISTY_CD, ISTY_ASST_CD, ONBR_DVSN_CD, ORTA_NM, MCDP_CD, MFDV_CD, IHOH_ORDV_CD, MTER_TCDV_CD, MDRP_NO, CNCL_DT
		                  , CNPL_CD
		               from ACCLMCCTT
		              where PTNO = #{ptno}
		                and MCCL_WORK_PRKY_VL = #{mcclWorkPrkyVl}     /*수납 전 계산상태 데이터. */
		                and CODV_CD in ('O', 'H', 'E')
		                and nvl(CNCL_DT ,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		            ) d
		          , MDMEDORDT b
		          , AIMFMDFET e
		          , APRCRPTNT f
		      where  a.ORDR_YMD        = to_date(#{ordrYmd} , 'YYYYMMDD')
		        and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		        and  a.MDTN_NO         = #{mdtnNo}
		        and  a.MDTN_LCDV_CD    = #{mdtnLcdvCd} /* 투약위치 */
		        and  a.ORDR_SNO        = #{ordrSno}
		        and  a.SDPF_EXRE_CD is null
		        and  d.PTNO      = #{ptno}
		        and  d.MDRP_NO   = f.MDRP_NO
		        and  d.ORDR_YMD = a.ORDR_YMD
		        and  d.ORDR_SNO = a.ORDR_SNO
		        and  d.MFDV_CD = 'S'
		        and  nvl(d.IHOH_ORDV_CD, 'I') = 'O'
		        and  ( d.ORTA_NM = 'MDMEDORDT'  or  d.ORTA_NM = 'MMMEDORT' )
		        and  d.MTER_TCDV_CD = '1'                                  /* 재료대 */
		        and  nvl(d.CNCL_DT ,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		        and  b.PTNO = d.PTNO
		        and  b.ORDR_YMD = d.ORDR_YMD
		        and  b.ORDR_SNO = b.ORDR_SNO
		        and  (
		                (nvl(b.INSR_YR3_INOU_DVSN_CD, '1') not in ('2', '3'))
		              or
		                (b.INSR_YR3_INOU_DVSN_CD in ('2', '3') and  d.IPDV_CD = '1')
		              )
		        and  e.MDFE_CD(+) = d.MDFE_CD
		        and  e.APST_YMD(+) <= d.ORDR_YMD
		        and  e.APFN_YMD(+) >= d.ORDR_YMD
		        and  rownum < 2
		      order  by
		            decode(a.DRAP_DVSN_CD, '3', '1', a.DRAP_DVSN_CD)
		         ,  a.PHDP_CMMD_BNDL_NO
		         ,  a.BSIS_CMMD_PLAC_CD
		         ,  a.MIX_KIND_CD
		         ,  a.MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetHicrNoCtn-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="hicrNoCtn" column="HICR_NO_CTN"/>
		<result property="bssyId" column="BSSY_ID"/>
		<result property="bsplNm" column="BSPL_NM"/>
		<result property="insdNm" column="INSD_NM"/>
		<result property="insdRsrn" column="INSD_RSRN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetHicrNoCtn () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetHicrNoCtn-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetHicrNoCtn"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetHicrNoCtn-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneOutSheetHicrNoCtn */
		<![CDATA[
		select  /*+ sdd_qlqlfct_s01$S01_증번호 조회 */
		            a.CRPP_NO_CTN   hicr_no_ctn
		         ,  a.BSSY_ID       bssy_id
		         ,  b.BSPL_NM       BSPL_NM
		         ,  a.INSD_NM       INSD_NM
		         ,  a.INSD_RSRN      INSD_RSRN   
		      from
		            APQLQLFCT a
		         ,  APETBSSYT b
		     where  a.PTNO     = #{ptno}
		       and  a.ISTY_CD  = #{ptntTypeCd}
		       and  a.ISTY_STRT_YMD =
		                             (
		                                select
		                                        max(ISTY_STRT_YMD)
		                                  from
		                                        APQLQLFCT x
		                                 where  x.PTNO = a.PTNO
		                                   and  x.ISTY_CD = a.ISTY_CD
		                                   and  x.ISTY_STRT_YMD <= trunc(sysdate)
		                                   and  x.QLFC_LOSE_YMD is null
		                                   and  nvl(x.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                             )
		       and  nvl(a.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		       and  b.BSSY_ID(+) = a.BSSY_ID
		       and  rownum  = 1
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdSheetForEng-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="frnsVlm" column="FRNS_VLM"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="ptntEnsnNm" column="PTNT_ENSN_NM"/>
		<result property="ptntEnsnLsnm" column="PTNT_ENSN_LSNM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO1"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="afiIstyNm" column="AFI_ISTY_NM"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="valdHh" column="VALD_HH"/>
		<result property="relsYn" column="RELS_YN"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="istyAsstCd" column="ISTY_ASST_CD"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="mdtnNo3" column="MDTN_NO_3"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="acknEdiCd" column="ACKN_EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="cancMdteAntcYn" column="CANC_MDTE_ANTC_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="atmtClamYn" column="ATMT_CLAM_YN"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="pcunInlsQty" column="PCUN_INLS_QTY"/>
		<result property="afiMdprOrlmAgeDdcnStr" column="AFI_MDPR_ORLM_AGE_DDCN_STR"/>
		<result property="errmLctnCd" column="ERRM_LCTN_CD"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="shdnYn" column="SHDN_YN"/>
		<result property="cmmdAftrKpngPlacCd" column="CMMD_AFTR_KPNG_PLAC_CD"/>
		<result property="selfMdtnYn" column="SELF_MDTN_YN"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="clncExamDrugYn" column="CLNC_EXAM_DRUG_YN"/>
		<result property="audtYn" column="AUDT_YN"/>
		<result property="afiOrdrAudtDvsnNm" column="AFI_ORDR_AUDT_DVSN_NM"/>
		<result property="trgtMdprCd" column="TRGT_MDPR_CD"/>
		<result property="audtRsltDvsnCd" column="AUDT_RSLT_DVSN_CD"/>
		<result property="audtRsltRmrkCtn" column="AUDT_RSLT_RMRK_CTN"/>
		<result property="cfdrPdaNo" column="CFDR_PDA_NO"/>
		<result property="cmmdVlm" column="CMMD_VLM"/>
		<result property="afiMdtnNoDvsnNm" column="AFI_MDTN_NO_DVSN_NM"/>
		<result property="afiInrnTbstSycdNm" column="AFI_INRN_TBST_SYCD_NM"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="oddrNm2" column="ODDR_NM2"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdSheetForEng () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdSheetForEng-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdSheetForEng"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdSheetForEng-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdSheetForEng */
		<![CDATA[
		select  /*+ sdd_ordbatt_l02$S01_영문처방전강제출력 */ 
		            x.ORDR_YMD                     /* 처방일자             */
		         ,  x.MDTN_NO_DVSN_CD              /* 처방형태구분         */
		         ,  x.AFI_MDTN_NO_STR              /* 투약번호             */
		         ,  x.ORDR_SNO                     /* 처방번호             */
		         ,  MDPR_CD                        /* 약품코드             */
		         ,  PTDV_CD                        /* 환자구분             */
		         ,  MDPR_CLSF_CD                   /* 약분류               */
		         ,  DRAP_DVSN_CD                   /* 약적용구분           */
		         ,  x.CMMD_STTS_CD                 /* 조제 STATUS          */
		         ,  PCKN_UNAD_QTY                  /* 투여량(포장)         */
		         ,  PCUN_CD                        /* 단위(포장)           */
		         ,  ICUN_ADMN_VLM                  /* 투여량(함량)         */
		         ,  ICUN_CD                        /* 단위(함량)           */
		         ,  SLCT_UNIT_DVSN_CD              /* 투여량TYPE           */
		         ,  x.MDTN_DDCN                    /* 일수                 */
		         ,  DRUS_CD                        /* 용법                 */
		         ,  MDNT                           /* 횟수                 */
		         ,  decode(FRNS_CTRL_DVSN_CD, null, TOTL_VLM, FRNS_VLM)    TOTL_CLCL_QTY         /* 총량(계산)           */
		         ,  FRNS_VLM                       /* 총량(계산)           */
		         ,  x.PHDP_CMMD_BNDL_NO            /* 약제부 묶음번호       */
		         ,  DRBN_NO                        /* 약묶음번호           */
		         ,  MIX_KIND_CD                    /* MIX종류              */
		         ,  x.BSIS_CMMD_PLAC_CD            /* 조제장소             */
		         ,  SPSB_CTN                       /* 특기사항             */
		         ,  x.FDNO_YN                      /* 정수품유무 */
		         ,  x.ISDV_CD                      /* 보험구분(수납시)     */
		         ,  DRUG_ORDR_INPT_DT              /* 입력일시             */
		         ,  SDPF_EXRE_CD                   /* 의약분업예외사유코드 */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=INJC_PLAC_CD),INJC_PLAC_CD) INJC_PLAC_CD                   /* 주사장소             */
		         ,  x.OHOR_RTRN_YN                 /* 원외처방반납여부     */
		         ,  TRGT_BEMD_NO  BEMD_NO                   /* 투석실 처방번호      */
		         ,  x.ATTR_NO                      /* AUTO TRACK번호       */
		         ,  DURV_RESN_CTN                  /* 상호작용 comment     */
		         ,  PTNO                           /* 환자번호             */
		         ,  RPTN_DT                        /* 접수일시             */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=MCDP_CD),MCDP_CD) MCDP_CD /* 진료과               */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=WARD_CD),WARD_CD) WARD_CD                        /* 병동                 */
		         ,  ODDR_ID                        /* 처방의(외래,병동)    */
		         ,  GNDR_ID                        /* 주치의(병동)         */
		         ,  RCST_CD                        /* 수납구분             */
		         ,  UPDT_BEMD_NO                   /* 수정전 투약번호      */
		         ,  DRUG_INJC_DVSN_CD              /* 약주사구분           */
		         ,  PHDP_OROC_DPRT_CD                        /* 처방발생원           */
		         ,  TKMD_CCHN_YN                   /* 복약지도여부         */
		         ,  IHOH_DVSN_CD                   /* 원내외구분           */
		         ,  NRDR_YN                        /* 마약여부             */
		         ,  PSDG_YN                        /* 향정여부             */
		         ,  CLNC_YN                        /* 임상여부             */
		         ,  MDCR_YMD                       /* 입원일자(내원일시)  */
		         ,  MDPR_NM                        /* 약품명               */
		         ,  ENVL_MEMO_CTN3  ENVL_MEMO_CTN1 /* 봉투1              */
		         ,  ENVL_MEMO_CTN4  ENVL_MEMO_CTN2 /* 봉투2              */
		         ,  PTNT_NM                        /* 환자명               */
		         ,  PTNT_ENSN_NM                   /* 환자영문명           */
		         ,  PTNT_ENSN_LSNM                 /* 환자영문성           */
		         ,  FRRN                           /* 주민번호1          */
		         ,  BRRN                           /* 주민번호2          */
		         ,  x.AFI_AGE_VL_STR               /* 나이                 */
		         ,  GEND_CD                        /* 성별                 */
		         , (   select z.PTNT_TLNO
		                 from APPTCNPNV z
		                where z.PTNO       = x.PTNO
		                  and CNPN_DVSN_CD = 'BH'
		                  and CNPN_SNO     = 1
		                  and rownum       = 1)   PTNT_TLNO                  /* 전화번호(집)         */
		         ,  ( select z.PTNT_TLNO
		                from APPTCNPNV z
		               where z.PTNO       = x.PTNO
		                 and CNPN_DVSN_CD = 'BP'
		                 and CNPN_SNO     = 1
		                 and rownum       = 1)   PTNT_TLNO1                 /* 전화번호(핸드폰)     */
		         ,  x.ISTY_CD                       /* 급여종별코드         */
		         ,  x.ISTY_CDNM    AFI_ISTY_NM                   /* 급여종별이름         */
		         ,  x.ODDR_NM      AFI_ODDR_NM               /* 처방의(외래,병동)    */
		         ,  x.GNDR_NM                     /* 주치의(병동)         */
		         ,  SBSN_MDPR_ABSL_DSLW_YN        /* 대체약품절대불가     */
		         ,  x.USER_LCNS_NO                /* 면허번호             */
		         ,  x.KPNG_PLAC_NM                /* 보관장소             */
		         ,  PTRM_NO                       /* 병실번호             */
		         ,  VALD_HH                       /* 유효시간             */
		         ,  RELS_YN                       /* 청구약품여부         */
		         ,  x.WARD_LABL_PRIN_YN           /* 출력여부             */
		         ,  x.EDI_CD                     /* EDI코드              */
		         ,  ISTY_ASST_CD                  /* 유형보조             */
		         ,  SCIN_CD                       /* 상병코드             */
		         ,  MDTN_STRT_YMD                 /* 실시일자             */
		         , (
		            select
		                    t.SCIN_NM
		              from  MDPADIAGT t
		                 ,  APRCRPTNT ap
		             where  t.PTNO          = x.PTNO
		               and  t.MDRP_NO       = ap.MDRP_NO
		               and  ap.MDCR_DT      = to_date(x.MDCR_YMD , 'YYYYMMDDHH24MISS' )
		               and  t.MCDP_CD       = decode(x.PTDV_CD, 'O', x.MCDP_CD, t.MCDP_CD )
		               and  t.MAIN_SCIN_YN  = 'Y'
		               and  t.GNDR_ID         = decode(x.PTDV_CD, 'O', t.GNDR_ID, x.GNDR_ID )
		               and rownum < 2
		            )  SCIN_NM                    /* 상병명               */
		         ,  x.MDTN_NO_3                   /* 투약번호             */
		         ,  x.AFI_IPDV_NM                 /* 계산내역급여구분     */
		         ,  x.ACKN_EDI_CD                 /* 계산내역EDI코드      */
		         ,  x.PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		         ,  x.AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		         ,  x.CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		         ,  STST_DVSN_CD                  /* 통계구분             */
		         ,  x.ATMT_CLAM_YN                /* 자동출력여부         */
		         ,  WSCN_SNGN_YN                  /* 수제단독             */
		         ,  NTNL_CD                       /* 외국인코드           */
		         ,  x.PCUN_INLS_QTY               /* 함량(마스터)         */
		         ,  x.AFI_MDPR_ORLM_AGE_DDCN_STR  /* 연령별 제한          */
		         ,  x.ERRM_LCTN_CD                /*응급실내 환자세부위치 */
		         ,  KORN_PDCT_NM                  /* 한글상품명            */
		         ,  SMRY_MDPR_NM                  /* 라벨 출력용 요약상품명 */
		         ,  x.SHDN_YN                     /* 차광약물여부          */
		         ,  CMMD_AFTR_KPNG_PLAC_CD        /* 조제 후 보관장소      */
		         ,  x.SELF_MDTN_YN                /* Self Medication 여부 */
		         ,  x.MDTN_LCDV_CD                /* 투약위치             */
		         ,  CLNC_EXAM_DRUG_YN             /* 임상시험약 여부      */
		         ,  x.AUDT_YN                     /* 처방감사여부         */
		         ,  x.AFI_ORDR_AUDT_DVSN_NM       /* 처방감사구분명       */
		         ,  x.TRGT_MDPR_CD                /* 약품코드             */
		         ,  x.AUDT_RSLT_DVSN_CD           /* 처방감사값           */
		         ,  AUDT_RSLT_RMRK_CTN            /* 처방감사비고         */
		         ,  x.CFDR_PDA_NO                 /* 주치의PDA            */
		         ,  (select b1.LAST_USE_VLM
		              from SDIJSTMAT a1
		                 , SDIJSTPST b1
		                 , SDMDISCRT c1
		             where c1.MDPR_CD = x.MDPR_CD
		               and b1.MDPR_CD = x.MDPR_CD
		               and c1.RPMD_ID = a1.RPMD_ID
		               and b1.RPMD_ID = a1.RPMD_ID
		               and x.INJT_STER_CMMD_YN = 'Y'
		               and rownum < 2) CMMD_VLM            /* 조제ml               */
		         ,   (select DETL_CD_NM from CCCMCDDMT where COMN_GRP_CD = 'SD023' and COMN_DTLS_CD = x.MDTN_NO_DVSN_CD) AFI_MDTN_NO_DVSN_NM
		         ,  ' ' AFI_INRN_TBST_SYCD_NM
		         ,  x.HGRS_HGCC_MDPR_YN
		         ,  x.ODDR_NM2
		      from
		         (
		            select  /*+ ordered use_nl(d a b c e f g h i j)  */
		                    to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD                     /* 처방일자             */
		                 ,  a.MDTN_NO_DVSN_CD                                               /* 처방형태구분         */
		                 ,  lpad(to_char(a.MDTN_NO), 4, '0')      AFI_MDTN_NO_STR           /* 투약번호             */
		                 ,  d.ORDR_SNO                                                      /* 처방번호             */
		                 ,  d.MDPR_CD                                                       /* 약품코드             */
		                 ,  a.PTDV_CD                                                       /* 환자구분             */
		                 ,  d.MDPR_CLSF_CD                                                  /* 약분류               */
		                 ,  d.DRAP_DVSN_CD                                                  /* 약적용구분           */
		                 ,  d.CMMD_STTS_CD                                                  /* 조제 STATUS          */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.PCKN_UNAD_QTY, round(d.PCKN_UNAD_QTY, 2))    PCKN_UNAD_QTY   /* 투여량(포장)         */
		                 ,  d.PCUN_NM                          PCUN_CD                      /* 단위(포장)           */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.ICUN_ADMN_VLM, round(d.ICUN_ADMN_VLM, 2))   ICUN_ADMN_VLM   /* 투여량(함량)         */
		                 ,  d.ICUN_CD                                                       /* 단위(함량)           */
		                 ,  d.SLCT_UNIT_DVSN_CD                                             /* 투여량TYPE           */
		                 ,  d.MDTN_DDCN                                                     /* 일수                 */
		                 ,  d.DRUS_CD                                                       /* 용법                 */
		                 ,  d.MDNT                                                          /* 횟수                 */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.TOTL_CLCL_QTY, round(d.TOTL_CLCL_QTY, 2)) TOTL_VLM     /* 총량(계산)           */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.INVN_TOTL_QTY, round(d.INVN_TOTL_QTY, 2)) FRNS_VLM     /* 총량(계산)           */
		                 ,  d.PHDP_CMMD_BNDL_NO                                             /* 약제부 묶음번호       */
		                 ,  d.DRBN_NO                          DRBN_NO                      /* 약묶음번호           */
		                 ,  d.MIX_KIND_CD                           MIX_KIND_CD             /* MIX종류              */
		                 ,  d.BSIS_CMMD_PLAC_CD                           BSIS_CMMD_PLAC_CD /* 조제장소             */
		                 ,  replace(d.SPSB_CTN, chr(13)||chr(10), '')   SPSB_CTN /* 특기사항             */
		                 ,  null                                        as FDNO_YN /* 정수품유무 */
		                 ,  d.ISDV_CD                                                       /* 보험구분(수납시)     */
		                 ,  to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT        /* 입력일시             */
		                 ,  d.SDPF_EXRE_CD                                                  /* 의약분업예외사유코드 */
		                 ,  d.INJC_PLAC_CD                                                  /* 주사장소             */
		                 ,  d.OHOR_RTRN_YN                                                  /* 원외처방반납여부     */
		                 ,  d.BEMD_NO                            TRGT_BEMD_NO               /* 투석실 처방번호      */
		                 ,  d.ATTR_NO                                                       /* AUTO TRACK번호       */
		                 ,  case
		                            when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                            when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                            when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                        end                                 DURV_RESN_CTN           /* 상호작용 comment     */
		                 ,  a.PTNO                                                          /* 환자번호             */
		                 ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT                  /* 접수일시             */
		                 ,  a.MCDP_CD                                                       /* 진료과               */
		                 ,  a.WARD_CD                                                       /* 병동                 */
		                 ,  a.ODDR_ID                                                       /* 처방의(외래,병동)    */
		                 ,  a.GNDR_ID                                                       /* 주치의(병동)         */
		                 ,  a.RCPC_YN                             RCST_CD                   /* 수납구분             */
		                 ,  a.UPDT_BEMD_NO                                                  /* 수정전 투약번호      */
		                 ,  a.DRUG_INJC_DVSN_CD                                             /* 약주사구분           */
		                 ,  a.PHDP_OROC_DPRT_CD                                                      /* 처방발생원           */
		                 ,  a.TKMD_CCHN_YN                                                  /* 복약지도여부         */
		                 ,  a.IHOH_DVSN_CD                                                  /* 원내외구분           */
		                 ,  a.NRDR_YN                                                       /* 마약여부             */
		                 ,  a.PSDG_YN                                                       /* 향정여부             */
		                 ,  a.CLNC_YN                                                       /* 임상여부             */
		                 ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD                /* 입원일자(내원일시)   */
		                 ,  e.MDPR_NM                                                       /* 약품명               */
		                 ,  f.ENVL_MEMO_CTN3                                                /* 봉투1                */
		                 ,  f.ENVL_MEMO_CTN4                                                /* 봉투2                */
		                 ,  b.PTNT_NM                                                       /* 환자명               */
		                 ,  b.PTNT_ENSN_NM                                                  /* 환자영문명               */
		                 ,  b.PTNT_ENSN_LSNM
		                 ,  b.FRRN                                                          /* 주민번호1            */
		                 ,  b.BRRN                                                          /* 주민번호2            */
		                 ,  trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||
		                    trunc(mod(months_between(a.ORDR_YMD, b.BTDT), 12))||')' AFI_AGE_VL_STR
		                 ,  b.GEND_CD                                                       /* 성별                 */
		                 ,  h.ISTY_CD                                                       /* 급여종별코드         */
		                 ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD   = 'AI003'
		                         and A.COMN_DTLS_CD  = h.ISTY_CD
		                         and B.LNGG_CD(+) = nvl( '', '*') )    ISTY_CDNM   /* 급여종별이름         */
		                 ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = a.ODDR_ID)           ODDR_NM    /* 처방의(외래,병동)    */
		                 ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = a.GNDR_ID)           GNDR_NM    /* 주치의(병동)         */
		                 ,  'N'                 SBSN_MDPR_ABSL_DSLW_YN    /* 대체약품절대불가     */
		                 ,  g2.USER_LCNS_NO                                                 /* 면허번호             */
		                 ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD   = 'SD003'
		                         and A.COMN_DTLS_CD  = e.KPNG_PLAC_CD
		                         and B.LNGG_CD(+)    = nvl( '', '*') )   KPNG_PLAC_NM       /* 보관장소             */
		                 ,  c.PTRM_NO                                                       /* 병실번호             */
		                 ,  ''  VALD_HH                                                       /* 유효시간             */
		                 ,  e.RELS_YN                                                       /* 청구약품여부         */
		                 ,  ''                                  WARD_LABL_PRIN_YN           /* 출력여부             */
		                 ,  ''                                  EDI_CD                      /* EDI 코드             */
		                 ,  ''                                  ISTY_ASST_CD                /* 유형보조             */
		                 ,  ''                                  SCIN_CD                     /* 상병코드             */
		                 ,  to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') MDTN_STRT_YMD      /* 실시일자        */
		                 ,  ''                                  SCIN_NM                     /* 상병명               */
		                 ,  a.MDTN_NO                             MDTN_NO_3                 /* 투약번호             */
		                 ,  ''                                  AFI_IPDV_NM                 /* 계산내역급여구분     */
		                 ,  ''                                  ACKN_EDI_CD                 /* 계산내역EDI코드      */
		                 ,  ''                                  PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		                 ,  ''                                  AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		                 ,  ''                                  CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		                 ,  e.STST_DVSN_CD                                                  /* 통계구분             */
		                 ,  'N'                                 ATMT_CLAM_YN                /* 자동출력여부         */
		                 ,  e.WSCN_SNGN_YN                                                  /* 수제단독             */
		                 ,  b.NTNL_CD                                                       /* 외국인코드           */
		                 ,  e.PCUN_INLS_QTY                                                 /* 함량(마스터)         */
		                 ,  '' AFI_MDPR_ORLM_AGE_DDCN_STR
		                 ,  fn_sd_getertelno_s(j.ERRM_LCTN_CD, j.ASNU_TIUS_PTNT_SUB_LCTN_CD) ERRM_LCTN_CD /*응급실내 환자세부위치 */
		                 ,  e.KORN_PDCT_NM                                                  /* 한글상품명            */
		                 ,  e.SMRY_MDPR_NM                                                  /* 라벨출력용 요약상품명 */
		                 ,  ''                                  SHDN_YN                     /* 차광약물여부          */
		                 ,  ''                                  CMMD_AFTR_KPNG_PLAC_CD      /* 조제 후 보관장소      */
		                 ,  'N'                                 SELF_MDTN_YN                /* Self Medication 여부  */
		                 ,  1                                   SELFSEQ                     /* Self Medication 용 순서 */
		                 ,  d.MDTN_LCDV_CD                                                  /* 투약위치              */
		                 ,  decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN                                             /* 임상시험약 여부       */
		                 ,  h.FRNS_CTRL_DVSN_CD
		                 ,  'N'                                 AUDT_YN
		                 ,  fn_sd_getaudfglist_s(d.ORDR_YMD, d.MDTN_NO_DVSN_CD, d.MDTN_NO, d.MDTN_LCDV_CD, d.ORDR_SNO, 1)    AFI_ORDR_AUDT_DVSN_NM
		                 ,  0                                   SCRN_DSPL_SQNC
		                 ,  ''                                  TRGT_MDPR_CD
		                 ,  ''                                  AUDT_RSLT_DVSN_CD
		                 ,  ''                                  AUDT_RSLT_RMRK_CTN
		                 ,  decode(g2.PDA_NO, '', '', '(8-'||g2.PDA_NO||')')  CFDR_PDA_NO
		                 ,  e.HGRS_HGCC_MDPR_YN
		                 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM2
		                 ,  e.INJT_STER_CMMD_YN
		              from
		                    SDPORDDEV d
		                 ,  SDPORDBAT a
		                 ,  APPTPTNTV b
		                 ,  MDMEDORDT h
		                 ,  APRCRPTNT c
		                 ,  SDDDGCDMT e
		                 ,  SDDMETCDT f
		                 ,  CCUSRDPHT g
		                 ,  CCUSERAMT g2
		                 ,  SDJFIXQTT i
		                 ,  MNEERRPAT j
		             where
		                    d.ORDR_YMD >= to_date(#{ordrYmd}, 'YYYYMMDD')                    /* 처방일자             */
		               and  d.ORDR_YMD <= to_date(#{ordrYmd2}, 'YYYYMMDD')                  /* 처방일자             */
		               and  instr(#{mdtnNoDvsnCd}, d.MDTN_NO_DVSN_CD) > 0                  /* 처방형태구분         */
		               and  d.CMMD_STTS_CD not in ('7', '8')            /* 진도                 */
		               and  d.MDTN_NO >= #{mdtnNo1}                                         /* 투약번호             */
		               and  d.MDTN_NO <= #{mdtnNo2}                                         /* 투약번호             */
		               and  d.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, d.MDTN_LCDV_CD, 'A', d.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		               and  d.INJC_PLAC_CD = nvl(#{injcPlacCd}, d.INJC_PLAC_CD)             /* 주사장소             */
		               and  a.PTNO             = nvl(#{ptno}, a.PTNO)      /* 환자번호             */
		               and  a.ORDR_YMD         = d.ORDR_YMD                                 /* 처방일자             */
		               and  a.MDTN_NO_DVSN_CD  = d.MDTN_NO_DVSN_CD                          /* 투약번호구분         */
		               and  a.MDTN_NO          = d.MDTN_NO                                  /* 투약번호             */
		               and  a.MDTN_LCDV_CD     = d.MDTN_LCDV_CD                             /* 투약번호             */
		               and  a.WARD_CD          = nvl(#{wardCd}, a.WARD_CD)                   /* 병동                 */
		               and  b.PTNO = a.PTNO                                                 /* 환자번호             */
		               and  h.PTNO      = a.PTNO
		               and  h.ORDR_YMD  = a.ORDR_YMD
		               and  h.ORDR_SNO  = d.ORDR_SNO
		               and  c.MDRP_NO  = h.MDRP_NO
		               and  e.MDPR_CD = d.MDPR_CD                                           /* 약품코드             */
		               and  f.DRUS_CD(+) = d.DRUS_CD                                        /* 용법                 */
		               and  g.USER_ID(+) = a.ODDR_ID                                        /* 처방의(외래,병동)   */
		               and  g2.LGIN_ID   = g.LGIN_ID
		               and  i.DPRT_CD          (+) = d.INJC_PLAC_CD
		               and  i.MDPR_CD          (+) = d.MDPR_CD
		               and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		               and  j.PTNO   (+) = a.PTNO                                           /* 응급간호환자번호     */
		               and  j.COHS_DT(+) = a.MDCR_YMD
		          union  all
		            select  /*+ ordered use_nl(a b c d e f)         */
		                    to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD                     /* 처방일자             */
		                 ,  a.MDTN_NO_DVSN_CD                                               /* 처방형태구분         */
		                 ,  lpad(to_char(a.MDTN_NO), 4, '0')      MDTN_NO                   /* 투약번호             */
		                 ,  b.ORDR_SNO                                                      /* 처방번호             */
		                 ,  b.ORDR_CD                           MDPR_CD                     /* 약품코드             */
		                 ,  b.CODV_CD                             PTDV_CD                   /* 환자구분             */
		                 ,  b.MDPR_CLSF_CD                                                  /* 약분류               */
		                 ,  b.DRAP_DVSN_CD                                                  /* 약적용구분           */
		                 ,  b.DRUG_ORDR_PRSS_CD                          CMMD_STTS_CD       /* 조제 STATUS          */
		                 ,  decode(b.DRAP_DVSN_CD, '2', b.PCKN_UNAD_QTY, round(b.PCKN_UNAD_QTY, 2)) PCKN_UNAD_QTY   /* 투여량(포장)         */
		                 ,  b.PCUN_CD                            PCUN_CD                    /* 단위(포장)           */
		                 ,  decode(b.DRAP_DVSN_CD, '2', b.ICUN_ADMN_VLM, round(b.ICUN_ADMN_VLM, 2)) ICUN_ADMN_VLM   /* 투여량(함량)         */
		                 ,  b.ICUN_CD                                                       /* 단위(함량)           */
		                 ,  b.SLCT_UNIT_DVSN_CD                                             /* 투여량TYPE           */
		                 ,  b.DDCN                               MDTN_DDCN                  /* 일수                 */
		                 ,  b.DRUS_CD                                                       /* 용법                 */
		                 ,  b.NTM                                MDNT                       /* 횟수                 */
		                 ,  null                                TOTL_VLM                    /* 총량(계산)           */
		                 ,  null                                FRNS_VLM                    /* 총량(계산)           */
		                 ,  null                                PHDP_CMMD_BNDL_NO           /* 약제부 묶음번호       */
		                 ,  b.DRBN_NO                                                       /* 약묶음번호           */
		                 ,  b.MIX_KIND_CD                                                   /* MIX종류              */
		                 ,  null                                BSIS_CMMD_PLAC_CD            /* 조제장소             */
		                 ,  replace(replace(b.DRUG_ORDR_UNSL_CTN, chr(13)||chr(10), ''), chr(10), '')  SPSB_CTN          /* 특기사항             */
		                 ,  null                                FDNO_YN                     /* 정수품유무 */
		                 ,  null                                ISDV_CD                     /* 보험구분(수납시)     */
		                 ,  null                                DRUG_ORDR_INPT_DT           /* 입력일시             */
		                 ,  b.SDPF_EXRE_CD                                                  /* 의약분업예외사유코드 */
		                 ,  null                                PHRM_PTGO_CD                /* 주사장소             */
		                 ,  null                                OHOR_RTRN_YN                /* 원외처방반납여부     */
		                 ,  null                                TRGT_BEMD_NO                /* 투석실 처방번호      */
		                 ,  null                                ATTR_NO                     /* AUTO TRACK번호       */
		                 ,  null                                DURV_RESN_CTN               /* 상호작용 comment     */
		                 ,  a.PTNO                                                          /* 환자번호             */
		                 ,  null                                RPTN_DT                     /* 접수일시             */
		                 ,  b.MCDP_CD                                                       /* 진료과               */
		                 ,  b.WARD_CD                                                       /* 병동                 */
		                 ,  b.ODDR_ID                                                       /* 처방의(외래,병동)    */
		                 ,  b.CHDR_ID                                                       /* 주치의(병동)         */
		                 ,  b.RCST_CD                             RCST_CD                   /* 수납구분             */
		                 ,  null                                UPDT_BEMD_NO                /* 수정전 투약번호      */
		                 ,  null                                DRUG_INJC_DVSN_CD           /* 약주사구분           */
		                 ,  a.PHDP_OROC_DPRT_CD                                                       /* 처방발생원           */
		                 ,  null                                TKMD_CCHN_YN                /* 복약지도여부         */
		                 ,  null                                IHOH_DVSN_CD                /* 원내외구분           */
		                 ,  null                                NRDR_YN                     /* 마약여부             */
		                 ,  null                                PSDG_YN                     /* 향정여부             */
		                 ,  null                                CLNC_YN                     /* 임상여부             */
		                 ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD                /* 입원일자(내원일시)   */
		                 ,  '[SELF]'||c.MDPR_NM                 MDPR_NM                      /* 약품명               */
		                 ,  null                                ENVL_MEMO_CTN3              /* 봉투1                */
		                 ,  null                                ENVL_MEMO_CTN4              /* 봉투2                */
		                 ,  d.PTNT_NM
		                 ,  d.PTNT_ENSN_NM                                                 /* 환자명               */
		                 ,  d.PTNT_ENSN_LSNM
		                 ,  d.FRRN                                                          /* 주민번호1            */
		                 ,  d.BRRN                                                          /* 주민번호2            */
		                 ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'('||
		                    trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12))||')' AFI_AGE_VL_STR  /* 나이                 */
		                 ,  d.GEND_CD                                                       /* 성별                 */
		                 ,  b.ISTY_CD                                                       /* 급여종별코드         */
		                 ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD  = 'AI003'
		                         and A.COMN_DTLS_CD = b.ISTY_CD
		                         and B.LNGG_CD(+) = nvl( '', '*') )      PATTYPNM           /* 급여종별이름         */
		                 ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = b.ODDR_ID)           ODDR_NM            /* 처방의(외래,병동)    */
		                 ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = b.CHDR_ID)           GNDR_NM            /* 주치의(병동)         */
		                 ,  'N'                 SBSN_MDPR_ABSL_DSLW_YN            /* 대체약품절대불가     */
		                 ,  g2.USER_LCNS_NO                                                 /* 면허번호             */
		                 ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD    = 'SD003'
		                         and A.COMN_DTLS_CD   = c.KPNG_PLAC_CD
		                         and B.LNGG_CD(+)     = nvl( '', '*') )  KPNG_PLAC_NM       /* 보관장소             */
		                 ,  f.PTRM_NO                                                       /* 병실번호             */
		                 ,  ''  VALD_HH                                                       /* 유효시간             */
		                 ,  null                                FDNO_YN                   /* 청구약품여부         */
		                 ,  null                                WARD_LABL_PRIN_YN           /* 출력여부             */
		                 ,  ''                                  EDICODE                     /* EDI코드              */
		                 ,  ''                                  ISTY_ASST_CD                /* 유형보조             */
		                 ,  ''                                  SCIN_CD                     /* 상병코드             */
		                 ,  null                                INJC_PRRN_YMD               /* 실시일자    */
		                 ,  ''                                  MAIN_SCIN_NM                /* 상병명               */
		                 ,  a.MDTN_NO                             MDTN_NO_3                 /* 투약번호             */
		                 ,  ''                                  AFI_IPDV_NM                 /* 계산내역급여구분     */
		                 ,  ''                                  ACKN_EDI_CD                 /* 계산내역EDI코드      */
		                 ,  ''                                  PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		                 ,  ''                                  AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		                 ,  ''                                  CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		                 ,  c.STST_DVSN_CD                                                  /* 통계구분             */
		                 ,  'Y'                                 ATMT_CLAM_YN                /* 자동출력여부         */
		                 ,  c.WSCN_SNGN_YN                                                  /* 수제단독             */
		                 ,  d.NTNL_CD                                                       /* 외국인코드           */
		                 ,  c.PCUN_INLS_QTY                                                 /* 함량(마스터)         */
		                 ,  '' AFI_MDPR_ORLM_AGE_DDCN_STR
		                 ,  null                                ERRM_LCTN_CD                /*응급실내 환자세부위치 */
		                 ,  c.KORN_PDCT_NM                                                  /* 한글상품명            */
		                 ,  '[SELF]'||c.SMRY_MDPR_NM             SMRY_MDPR_NM             /* 라벨 출력용 요약상품명 */
		                 ,  ''                                  SHDN_YN                     /* 차광약물여부          */
		                 ,  ''                                  CMMD_AFTR_KPNG_PLAC_CD      /* 조제 후 보관장소      */
		                 ,  'Y'                                 SELF_MDTN_YN                /* Self Medication 여부  */
		                 ,  2                                   SELFSEQ_ASIS                /* Self Medication 용 순서 */
		                 ,  a.MDTN_LCDV_CD                                                  /* 투약위치             */
		                 ,  decode(c.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN                                             /* 임상시험약 여부       */
		                 ,  b.FRNS_CTRL_DVSN_CD
		                 ,  'N'                                 AUDYN
		                 ,  ''                                  AFI_ORDR_AUDT_DVSN_NM
		                 ,  0                                   AUDSORTSEQ
		                 ,  ''                                  TRGT_MDPR_CD
		                 ,  ''                                  AUDT_RSLT_DVSN_CD
		                 ,  ''                                  AUDT_RSLT_RMRK_CTN
		                 ,  decode(g2.PDA_NO, '', '', '(8-'||g2.PDA_NO||')')  CFDR_PDA_NO
		                 ,  c.HGRS_HGCC_MDPR_YN
		                 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = b.ODDR_ID ) ODDR_NM2
		                 ,  c.INJT_STER_CMMD_YN
		              from
		                    SDPORDBAT a
		                 ,  MDMEDORDT b
		                 ,  SDDDGCDMT c
		                 ,  APPTPTNTV d
		                 ,  CCUSRDPHT g
		                 ,  CCUSERAMT g2
		                 ,  APRCRPTNT f
		             where  a.ORDR_YMD >= to_date(#{ordrYmd}, 'YYYYMMDD')  /* 처방일자             */
		               and  a.ORDR_YMD <= to_date(#{ordrYmd2}, 'YYYYMMDD') /* 처방일자             */
		               and  instr(#{mdtnNoDvsnCd}, a.MDTN_NO_DVSN_CD) > 0            /* 처방형태구분         */
		               and  b.DRUG_ORDR_PRSS_CD not in ('7','8')
		               and  (
		                                (instr(#{mdtnNoDvsnCd}, 'A') > 0)
		                             or (instr(#{mdtnNoDvsnCd}, 'B') > 0)
		                             or (instr(#{mdtnNoDvsnCd}, 'C') > 0)
		                             or (instr(#{mdtnNoDvsnCd}, 'E') > 0)
		                        )
		               and  a.MDTN_NO >= #{mdtnNo1}          /* 투약번호             */
		               and  a.MDTN_NO <= #{mdtnNo2}            /* 투약번호             */
		               and  a.PTNO         = nvl(#{ptno}, a.PTNO)      /* 환자번호             */
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} ) /* 투약위치 */
		               and  b.PTNO         = a.PTNO
		               and  b.ORDR_YMD     = a.ORDR_YMD
		               and  b.ORFR_CD      = 'S'                              /* Self Medication 조건 */
		               and  nvl(b.DC_DVSN_CD, 'N') in ('N', 'Y')                      /* 삭제처방             */
		               and  c.MDPR_CD = b.ORDR_CD
		               and  d.PTNO     = a.PTNO
		               and  g.USER_ID(+) = a.ODDR_ID
		               and  g2.LGIN_ID   = g.LGIN_ID
		               and  f.MDRP_NO  = b.MDRP_NO
		         union  all
		            select  /*+ ordered use_nl(x d a b c e f g h i j y)      */
		                    to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD                     /* 처방일자             */
		                 ,  a.MDTN_NO_DVSN_CD                                               /* 처방형태구분         */
		                 ,  lpad(to_char(a.MDTN_NO), 4, '0')      MDTN_NO                   /* 투약번호             */
		                 ,  d.ORDR_SNO                                                      /* 처방번호             */
		                 ,  d.MDPR_CD                                                       /* 약품코드             */
		                 ,  a.PTDV_CD                                                       /* 환자구분             */
		                 ,  d.MDPR_CLSF_CD                                                  /* 약분류               */
		                 ,  d.DRAP_DVSN_CD                                                  /* 약적용구분           */
		                 ,  d.CMMD_STTS_CD                                                  /* 조제 STATUS          */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.PCKN_UNAD_QTY, round(d.PCKN_UNAD_QTY, 2)) PCKN_UNAD_QTY   /* 투여량(포장)         */
		                 ,  d.PCUN_NM                          PCUN_CD                      /* 단위(포장)           */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.ICUN_ADMN_VLM, round(d.ICUN_ADMN_VLM, 2)) ICUN_ADMN_VLM   /* 투여량(함량)         */
		                 ,  d.ICUN_CD                                                       /* 단위(함량)           */
		                 ,  d.SLCT_UNIT_DVSN_CD                                             /* 투여량TYPE           */
		                 ,  d.MDTN_DDCN                                                     /* 일수                 */
		                 ,  d.DRUS_CD                                                       /* 용법                 */
		                 ,  d.MDNT                                                          /* 횟수                 */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.TOTL_CLCL_QTY, round(d.TOTL_CLCL_QTY, 2)) TOTL_VLM     /* 총량(계산)           */
		                 ,  decode(d.DRAP_DVSN_CD, '2', d.INVN_TOTL_QTY, round(d.INVN_TOTL_QTY, 2)) FRNS_VLM     /* 총량(계산)           */
		                 ,  d.PHDP_CMMD_BNDL_NO                                             /* 약제부 묶음번호       */
		                 ,  d.DRBN_NO                                                       /* 약묶음번호           */
		                 ,  d.MIX_KIND_CD                                                   /* MIX종류              */
		                 ,  d.BSIS_CMMD_PLAC_CD                                             /* 조제장소             */
		                 ,  replace(d.SPSB_CTN, chr(13)||chr(10), '')   SPSB_CTN            /* 특기사항             */
		                 ,  null                                        as FDNO_YN /* 정수품유무 */
		                 ,  d.ISDV_CD                                                       /* 보험구분(수납시)     */
		                 ,  to_char(a.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT     /* 입력일시             */
		                 ,  d.SDPF_EXRE_CD                          SDPF_EXRE_CD            /* 의약분업예외사유코드 */
		                 ,  d.INJC_PLAC_CD                           PHRM_PTGO_CD           /* 주사장소             */
		                 ,  d.OHOR_RTRN_YN                       OHOR_RTRN_YN               /* 원외처방반납여부     */
		                 ,  d.BEMD_NO                            TRGT_BEMD_NO               /* 투석실 처방번호      */
		                 ,  d.ATTR_NO                          ATTR_NO                      /* AUTO TRACK번호       */
		                 ,  case
		                            when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                            when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                            when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                        end                                 DURV_RESN_CTN           /* 상호작용 comment     */
		                 ,  a.PTNO                                                          /* 환자번호             */
		                 ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT               /* 접수일시             */
		                 ,  a.MCDP_CD                                                       /* 진료과               */
		                 ,  a.WARD_CD                                                       /* 병동                 */
		                 ,  a.ODDR_ID                                                       /* 처방의(외래,병동)    */
		                 ,  a.GNDR_ID                                                       /* 주치의(병동)         */
		                 ,  a.RCPC_YN                             RCST_CD                   /* 수납구분             */
		                 ,  a.UPDT_BEMD_NO                                                  /* 수정전 투약번호      */
		                 ,  a.DRUG_INJC_DVSN_CD                                             /* 약주사구분           */
		                 ,  a.PHDP_OROC_DPRT_CD                                                       /* 처방발생원           */
		                 ,  a.TKMD_CCHN_YN                                                  /* 복약지도여부         */
		                 ,  a.IHOH_DVSN_CD                                                  /* 원내외구분           */
		                 ,  a.NRDR_YN                                                       /* 마약여부             */
		                 ,  a.PSDG_YN                                                       /* 향정여부             */
		                 ,  a.CLNC_YN                                                       /* 임상여부             */
		                 ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS') MDCR_YMD             /* 입원일자(내원일시)   */
		                 ,  e.MDPR_NM                                                       /* 약품명               */
		                 ,  f.ENVL_MEMO_CTN3                                                /* 봉투1                */
		                 ,  f.ENVL_MEMO_CTN4                                                /* 봉투2                */
		                 ,  b.PTNT_NM
		                 ,  b.PTNT_ENSN_NM                                                  /* 환자명               */
		                 ,  b.PTNT_ENSN_LSNM
		                 ,  b.FRRN                                                          /* 주민번호1            */
		                 ,  b.BRRN                                                          /* 주민번호2            */
		                 ,  trunc(months_between(a.ORDR_YMD, b.BTDT)/12)||'('||
		                    trunc(mod(months_between(a.ORDR_YMD, b.BTDT), 12))||')' AFI_AGE_VL_STR
		                 ,  b.GEND_CD                                                       /* 성별                 */
		                 ,  h.ISTY_CD                                                       /* 급여종별코드         */
		                 ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                        from CCCMCDDMT A, CCCMCDDLT B
		                       where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                         and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                         and A.COMN_GRP_CD   = 'AI003'
		                         and A.COMN_DTLS_CD  = h.ISTY_CD
		                         and B.LNGG_CD(+)    = nvl( '', '*') )           PATTYPNM   /* 급여종별이름         */
		                 ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = a.ODDR_ID)           ODDR_NM    /* 처방의(외래,병동)    */
		                 ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = a.GNDR_ID)           GNDR_NM    /* 주치의(병동)         */
		                 ,  'N'                 SBSN_MDPR_ABSL_DSLW_YN    /* 대체약품절대불가     */
		                 ,  g2.USER_LCNS_NO                                                  /* 면허번호             */
		                 , ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                       from CCCMCDDMT A, CCCMCDDLT B
		                      where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                        and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                        and A.COMN_GRP_CD   = 'SD003'
		                        and A.COMN_DTLS_CD  = e.KPNG_PLAC_CD
		                        and B.LNGG_CD(+) = nvl( '', '*') )       KPNG_PLAC_NM       /* 보관장소             */
		                 ,  c.PTRM_NO                            PTRM_NO                    /* 병실번호             */
		                 ,  ''                                   VALD_HH                     /* 유효시간             */
		                 ,  e.RELS_YN                                                       /* 청구약품여부         */
		                 ,  ''                                  WARD_LABL_PRIN_YN           /* 출력여부             */
		                 ,  ''                                  EDICODE                     /* EDI 코드             */
		                 ,  ''                                  ISTY_ASST_CD                /* 유형보조             */
		                 ,  ''                                  SCIN_CD                     /* 상병코드             */
		                 ,  to_char(d.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS') INJC_PRRN_YMD   /* 실시일자        */
		                 ,  ''                                  MAIN_SCIN_NM                /* 상병명               */
		                 ,  a.MDTN_NO                             MDTN_NO_3                 /* 투약번호             */
		                 ,  ''                                  AFI_IPDV_NM                 /* 계산내역급여구분     */
		                 ,  ''                                  ACKN_EDI_CD                 /* 계산내역EDI코드      */
		                 ,  ''                                  PTNT_TYPE_NM_2              /* 계산내역환자유형     */
		                 ,  ''                                  AFI_ISTY_ASST_NM_2          /* 계산내역유형보조     */
		                 ,  ''                                  CANC_MDTE_ANTC_YN           /* 소아항암여부         */
		                 ,  e.STST_DVSN_CD                                                  /* 통계구분             */
		                 ,  'N'                                 ATMT_CLAM_YN                /* 자동출력여부         */
		                 ,  e.WSCN_SNGN_YN                                                  /* 수제단독             */
		                 ,  b.NTNL_CD                                                       /* 외국인코드           */
		                 ,  e.PCUN_INLS_QTY                                                 /* 함량(마스터)         */
		                 ,  '' AFI_MDPR_ORLM_AGE_DDCN_STR
		                 ,  fn_sd_getertelno_s(j.ERRM_LCTN_CD, j.ASNU_TIUS_PTNT_SUB_LCTN_CD) ERRM_LCTN_CD /*응급실내 환자세부위치 */
		                 ,  e.KORN_PDCT_NM                                                  /* 한글상품명            */
		                 ,  e.SMRY_MDPR_NM                                                  /* 라벨출력용 요약상품명 */
		                 ,  ''                                  SHDN_YN                     /* 차광약물여부          */
		                 ,  ''                                  CMMD_AFTR_KPNG_PLAC_CD      /* 조제 후 보관장소      */
		                 ,  'N'                                 SELF_MDTN_YN                /* Self Medication 여부  */
		                 ,  1                                   SELFSEQ_ASIS                /* Self Medication 용 순서 */
		                 ,  d.MDTN_LCDV_CD                                                  /* 투약위치              */
		                 ,  decode(e.DGMT_RGST_TYPE_CD,'2','Y','') CLNC_EXAM_DRUG_YN                                             /* 임상시험약 여부       */
		                 ,  h.FRNS_CTRL_DVSN_CD
		                 ,  'Y'                                    AUDYN
		                 ,  y.DETL_CD_NM                           AFI_ORDR_AUDT_DVSN_NM
		                 ,  y.SCRN_DSPL_SQNC                           AUDSORTSEQ
		                 ,  x.TRGT_MDPR_CD1||decode(x.TRGT_MDPR_CD2, null, null, '-'||x.TRGT_MDPR_CD2)  TRGT_MDPR_CD
		                 ,  x.TRGT_AUDT_VL1||decode(x.TRGT_AUDT_VL2, null, null, '-'||x.TRGT_AUDT_VL2)  AUDT_RSLT_DVSN_CD
		                 ,  x.AUDT_RMRK_CTN                       AUDT_RSLT_RMRK_CTN
		                 ,  decode(g2.PDA_NO, '', '', '(8-'||g2.PDA_NO||')')  CFDR_PDA_NO
		                 ,  e.HGRS_HGCC_MDPR_YN
		                 ,  ( select F_A.USER_NM from CCUSRDPHT F_A where F_A.USER_ID = h.ODDR_ID ) ODDR_NM2
		                 ,  e.INJT_STER_CMMD_YN
		              from
		                    SDAAUDRPT x
		                 ,  SDPORDDEV d
		                 ,  SDPORDBAT a
		                 ,  APPTPTNTV b
		                 ,  MDMEDORDT h
		                 ,  APRCRPTNT c
		                 ,  SDDDGCDMT e
		                 ,  SDDMETCDT f
		                 ,  CCUSRDPHT g
		                 ,  CCUSERAMT g2
		                 ,  SDJFIXQTT i
		                 ,  MNEERRPAT j
		                 ,  CCCMCDDMT y
		             where  #{audtYn} is not null
		               and  x.TRGT_ORDR_YMD1 >= to_date(#{ordrYmd}, 'YYYYMMDD')  /* 처방일자             */
		               and  x.TRGT_ORDR_YMD1 <= to_date(#{ordrYmd2}, 'YYYYMMDD') /* 처방일자             */
		               and  instr(#{mdtnNoDvsnCd} , x.TRGT_MDTN_NO_DVSN_CD1) > 0            /* 처방형태구분         */
		               and  x.TRGT_MDTN_NO1 >= #{mdtnNo1}            /* 투약번호             */
		               and  x.TRGT_MDTN_NO1 <= #{mdtnNo2}              /* 투약번호             */
		               and  x.TRGT_MDTN_LCDV_CD1 = decode(#{mdtnLcdvCd}, null, x.TRGT_MDTN_LCDV_CD1
		                       , 'A', x.TRGT_MDTN_LCDV_CD1, #{mdtnLcdvCd}) /* 투약위치 */
		               and  x.AUDT_TYPE_CD not in ('011', '012', '991')
		               and  exists  (
		                            select
		                                    'Z'
		                              from
		                                    SDAAUDRPT z
		                             where  z.TRGT_ORDR_YMD1        = x.TRGT_ORDR_YMD1
		                               and  z.TRGT_MDTN_NO_DVSN_CD1 = x.TRGT_MDTN_NO_DVSN_CD1
		                               and  z.TRGT_MDTN_NO1         = x.TRGT_MDTN_NO1
		                               and  z.TRGT_MDTN_LCDV_CD1    = x.TRGT_MDTN_LCDV_CD1
		                               and  substr(z.AUDT_TYPE_CD, 1, 2) not in ('01', '02', '99'  )
		                     )
		               and  d.ORDR_YMD        = x.TRGT_ORDR_YMD1
		               and  d.MDTN_NO_DVSN_CD = x.TRGT_MDTN_NO_DVSN_CD1
		               and  d.MDTN_NO         = x.TRGT_MDTN_NO1
		               and  d.MDTN_LCDV_CD    = x.TRGT_MDTN_LCDV_CD1
		               and  d.ORDR_SNO        = x.TRGT_ORDR_SNO1
		               and  d.CMMD_STTS_CD not in ('7','8')
		               and  d.INJC_PLAC_CD    = nvl(#{injcPlacCd}, d.INJC_PLAC_CD)             /* 주사장소             */
		               and  a.ORDR_YMD          = d.ORDR_YMD                         /* 처방일자             */
		               and  a.MDTN_NO_DVSN_CD   = d.MDTN_NO_DVSN_CD                       /* 투약번호구분         */
		               and  a.MDTN_NO           = d.MDTN_NO                             /* 투약번호             */
		               and  a.MDTN_LCDV_CD      = d.MDTN_LCDV_CD                     /* 투약번호             */
		               and  a.WARD_CD           = nvl(#{wardCd}, a.WARD_CD)           /* 병동                 */
		               and  a.PTNO              = nvl(#{ptno}, a.PTNO)      /* 환자번호             */
		               and  b.PTNO = a.PTNO                             /* 환자번호             */
		               and  h.PTNO = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = d.ORDR_SNO
		               and  c.MDRP_NO  = h.MDRP_NO
		               and  e.MDPR_CD  = d.MDPR_CD                      /* 약품코드             */
		               and  f.DRUS_CD(+) = d.DRUS_CD                  /* 용법                 */
		               and  g.USER_ID(+) = a.ODDR_ID                     /* 처방의(외래,병동)    */
		               and  g2.LGIN_ID   = g.LGIN_ID
		               and  i.DPRT_CD(+) = d.INJC_PLAC_CD
		               and  i.MDPR_CD(+) = d.MDPR_CD
		               and  i.EQPT_FDNO_DVSN_CD(+) = '2'
		               and  j.PTNO(+) = a.PTNO                          /* 응급간호환자번호     */
		               and  j.COHS_DT(+) = a.MDCR_YMD                     /* 응급간호환자번호     */
		               and  y.COMN_GRP_CD = 'SD600'
		               and  y.COMN_DTLS_CD = x.AUDT_TYPE_CD
		         )  x
		     order
		        by
		              x.ORDR_YMD
		           ,  x.MDTN_LCDV_CD
		           ,  x.MDTN_NO_DVSN_CD
		           ,  x.AFI_MDTN_NO_STR
		           ,  x.SELF_MDTN_YN
		           ,  x.AUDT_YN
		           ,  x.SCRN_DSPL_SQNC
		           ,  decode(#{odkiCd}, 'D', decode(x.BSIS_CMMD_PLAC_CD, '6', '1', x.BSIS_CMMD_PLAC_CD)
		                                ,'I', decode(nvl(RCST_CD, 'N'), 'Y', decode(nvl(x.WARD_LABL_PRIN_YN, 'N'), 'N', 1 ,'Y', 2, 3)  , 4)
		                                ,'1')
		           ,  x.PHDP_CMMD_BNDL_NO
		           ,  x.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOnePreOrdrScin-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="scinCdCtn" column="SCIN_CD_CTN"/>
		<result property="scinCdCtn2" column="SCIN_CD_CTN_2"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOnePreOrdrScin () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOnePreOrdrScin-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOnePreOrdrScin"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOnePreOrdrScin-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOnePreOrdrScin */
		<![CDATA[
		select  /*+ sdd_bsscint_s01$S01_처방전상병코드 조회 */
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 2, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 3, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 4, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 5, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 6, '_'||decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '')))   scin_cd_ctn
		         ,  max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 0, replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||'|'||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 1, replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||'|'||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 2, replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||'|'||
		            max(max(decode(decode(a.MAIN_SCIN_YN, 'Y', 0, rownum), 3, replace(decode(a.SCIN_CD, b.SCIN_STST_CD, a.SCIN_CD, b.SCIN_STST_CD), '.', ''), '')))||'|'  scin_cd_ctn_2
		      from
		            (
		             select
		                     a.MAIN_SCIN_YN
		                  ,  a.SCIN_CD
		                  ,  c.MDCR_DT
		               from
		                     MDPADIAGT a
		                  ,  APRCRPTNT c
		                  ,  MDMEDORDT d
		              where
		                     d.PTNO   = #{ptno}
		                and  d.ORDR_YMD = to_date(#{ordrYmd},'yyyymmdd')
		                and  (
		                      ( (#{ptdvCd} = 'E') or (#{ptdvCd} = 'D') )
		                      or
		                      (
		                        ( (#{ptdvCd} = 'O') or (#{ptdvCd} = 'H') or (#{ptdvCd} = 'G') )
		                        and
		                        (
		                          a.MCDP_CD = (select DPRT_CD from HZDEPTMMT where ABRV_DPRT_CD=#{mcdpCd} and USE_YN='Y' and rownum < 2)
		                          and  #{gndrId}  = decode( #{ptdvCd}, 'O', a.CHDR_ID , #{gndrId} )      /* MultiMainDiag  */
		                        )
		                      )
		                    )
		               and  a.MDRP_NO = d.MDRP_NO
		               and  a.MDRP_NO = c.MDRP_NO
		            )  a
		         ,  MRBSSCINT b
		     where
		            b.SCIN_CD(+) = a.SCIN_CD
		       and  a.MDCR_DT between b.APLY_YMD(+) and b.FNSH_YMD(+) + 0.99999
		     group
		        by
		            decode(a.MAIN_SCIN_YN, 'Y', 0, rownum)
		         ,  a.SCIN_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutSheetOtherMdtnNo-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="dvsnNm" column="DVSN_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutSheetOtherMdtnNo () 
        Description :                                           외래처방전 타 투약번호 조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutSheetOtherMdtnNo-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutSheetOtherMdtnNo"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutSheetOtherMdtnNo-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutSheetOtherMdtnNo */
		<![CDATA[
		  select  x.MDTN_NO_DVSN_CD
		       ,  x.MDTN_NO		 
		       ,  max(x.DVSN_NM)  as DVSN_NM
		    from (   
				   select  /*+ sdd_pordbat_l87$S01_외래처방전 타 투약번호 조회 */  
				            a.MDTN_NO
				         ,  a.MDTN_NO_DVSN_CD
				         ,  decode(c.DC_DVSN_CD, 'Y', '[DC]', '') as DVSN_NM
				      from   SDPORDBAT a
				         ,   SDPORDDET b
				         ,   MDMEDORDT c
				     where
		                     (( a.MDTN_NO_DVSN_CD in ('O','S','T','I','D','F','P','Q') and
		            		    a.ORDR_YMD         = to_date( #{ordrYmd}, 'YYYYMMDD') )
		                      or  
				              ( a.MDTN_NO_DVSN_CD = 'G' and
				                a.ORDR_YMD between to_date(#{ordrYmd}, 'YYYYMMDD') - 1 and to_date(#{ordrYmd}, 'YYYYMMDD') )
				             )  
		       			and  a.DRUG_INJC_DVSN_CD in ('1', '2')
		       			and  a.PTNO             = nvl( #{ptno}, '')
		       			and  a.MDTN_NO_DVSN_CD in ('O','Z','S','T','G','H','I','D','F','P','Q')
		       			and  a.MDTN_NO          <>  #{mdtnNo}
		       			and  a.MDTN_LCDV_CD     =  decode( #{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )
		       			and  b.ORDR_YMD       = a.ORDR_YMD
		       			and  b.MDTN_NO_DVSN_CD= a.MDTN_NO_DVSN_CD
		     		  and  b.MDTN_NO        = a.MDTN_NO
		    		   and  b.MDTN_LCDV_CD   = a.MDTN_LCDV_CD
		    		   and  b.ORDR_YMD       = c.ORDR_YMD
		    		   and  b.ORDR_SNO       = c.ORDR_SNO
		    		   and  b.PTNO           = c.PTNO
		    		   and  b.CMMD_STTS_CD <= 5
		    		   and  a.MDPR_MDTN_DT is null
		  			   and  nvl(b.DRUS_CD, 'X') != 'SAVE'
		  			   and  (   b.MDTN_NO_DVSN_CD in ('O','Z') and 
		        				(
		        		     		( b.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6') AND b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y' )  OR
		       		   		  		( b.BSIS_CMMD_PLAC_CD  = 'A' AND b.DRAP_DVSN_CD               != '2' ) OR
		      		      			( b.BSIS_CMMD_PLAC_CD  = '7' AND NVL(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		    		       		 )
		           				OR
		           				b.MDTN_NO_DVSN_CD IN ('G','H','I','D','F','P','Q','S','T') AND 
		           				(
		             				( b.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6', 'A') AND b.DRAP_DVSN_CD != '2') OR   /* 경구외용    */   
		             				( b.BSIS_CMMD_PLAC_CD  = '7' AND NVL(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		            			)	                                       
		       				)
				 ) x      	
		  group by x.MDTN_NO		 
		        ,  x.MDTN_NO_DVSN_CD	
		  order by x.MDTN_NO_DVSN_CD
		        ,  x.MDTN_NO        	 	
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDetl-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="orocCd" column="OROC_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="orclCd" column="ORCL_CD"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="ordrCltyCd" column="ORDR_CLTY_CD"/>
		<result property="orfrCd" column="ORFR_CD"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="chdrId" column="CHDR_ID"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="ntm" column="NTM"/>
		<result property="ddcn" column="DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="injcPrrnYmd" column="INJC_PRRN_YMD"/>
		<result property="phrmImplYmd" column="PHRM_IMPL_YMD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="trgtMdtnNo" column="TRGT_MDTN_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="drugOrdrPrssCd" column="DRUG_ORDR_PRSS_CD"/>
		<result property="drugOrdrUnslCtn" column="DRUG_ORDR_UNSL_CTN"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="adtnOrdvCd" column="ADTN_ORDV_CD"/>
		<result property="ordrCrtnDvsnCd" column="ORDR_CRTN_DVSN_CD"/>
		<result property="sbsnUpdtCmmdYn" column="SBSN_UPDT_CMMD_YN"/>
		<result property="cmmdPrsrYn" column="CMMD_PRSR_YN"/>
		<result property="ordrIpdvCd" column="ORDR_IPDV_CD"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="phdpPrinYn" column="PHDP_PRIN_YN"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="cmmdPlacCd" column="CMMD_PLAC_CD"/>
		<result property="tims1TotlQtyYn" column="TIMS1_TOTL_QTY_YN"/>
		<result property="dvdnDvsnCd" column="DVDN_DVSN_CD"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ptpMdprYn" column="PTP_MDPR_YN"/>
		<result property="pwdrDslwYn" column="PWDR_DSLW_YN"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="ageVl" column="AGE_VL"/>
		<result property="totlVlm" column="TOTL_VLM"/>
		<result property="frnsCqy" column="FRNS_CQY"/>
		<result property="tkmdCcppPrinYn" column="TKMD_CCPP_PRIN_YN"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="dgfrCd" column="DGFR_CD"/>
		<result property="sngnBndlYn" column="SNGN_BNDL_YN"/>
		<result property="comnDtlsCd" column="COMN_DTLS_CD"/>
		<result property="apdvCd" column="APDV_CD"/>
		<result property="sbDrusCd" column="SB_DRUS_CD"/>
		<result property="phrmCtrlChrcVl1" column="PHRM_CTRL_CHRC_VL_1"/>
		<result property="phrmCtrlChrcVl2" column="PHRM_CTRL_CHRC_VL_2"/>
		<result property="phrmCtrlChrcVl3" column="PHRM_CTRL_CHRC_VL_3"/>
		<result property="phrmCtrlChrcVl4" column="PHRM_CTRL_CHRC_VL_4"/>
		<result property="phrmCtrlChrcVl5" column="PHRM_CTRL_CHRC_VL_5"/>
		<result property="phrmCtrlChrcVl6" column="PHRM_CTRL_CHRC_VL_6"/>
		<result property="phrmCtrlChrcVl7" column="PHRM_CTRL_CHRC_VL_7"/>
		<result property="phrmCtrlChrcVl10" column="PHRM_CTRL_CHRC_VL_10"/>
		<result property="afiTrgtCot" column="AFI_TRGT_COT"/>
		<result property="mngmDvsnCd" column="MNGM_DVSN_CD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="frnsCtrlDvsnCd" column="FRNS_CTRL_DVSN_CD"/>
		<result property="admnNtm" column="ADMN_NTM"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="bemdNoDvsnCd" column="BEMD_NO_DVSN_CD"/>
		<result property="injtMixCmmdDvsnCd" column="INJT_MIX_CMMD_DVSN_CD"/>
		<result property="sterCmmdImplYn" column="STER_CMMD_IMPL_YN"/>
		<result property="rcpcDt" column="RCPC_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDetl (단기입원처방 접수 상세조회) 
        Description :                                           단기입원처방 접수 상세조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDetl-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDetl"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDetl-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDetl */
		<![CDATA[
				   select  /*+ sdd_mdmedor_l23$S01_02C 항암제 처방 상세 조회 */
					   A.PTNO as PTNO
					,  to_char(A.ORDR_YMD, 'YYYYMMDD') as ORDR_YMD
					,  a.ORDR_SNO as ORDR_SNO
					,  a.CODV_CD as CODV_CD
					,  to_char(i.MDCR_DT, 'YYYYMMDDHH24MISS') as MDCR_DT
		    	,  ''                                                      as OROC_CD /* OROC_CD 작업완료 */
		    	,  ''                                                      as OROC_DPRT_CD
		                ,  case when nvl( r.MDCR_TISS_DVSN_CD, 'XXX') in ('M01') then 'M01'
		                        when nvl( r.MDCR_TISS_DVSN_CD, 'XXX') in ('W01') then 'W01'
		                                                                         else r.PHDP_OROC_DPRT_CD
		                   end                                                     as PHDP_OROC_DPRT_CD	
					,  a.MCDP_CD as MCDP_CD
					,  a.WARD_CD as WARD_CD
					,  a.ORCL_CD as ORCL_CD
					,  decode(a.ODKI_CD, 'D', 'D', 'H', 'D', 'G') as ODKI_CD
					,  a.ORDR_CLTY_CD as ORDR_CLTY_CD
					,  a.ORFR_CD as ORFR_CD
					,  a.ORDR_CD as ORDR_CD
					,  a.ODDR_ID as ODDR_ID
					,  a.CHDR_ID as CHDR_ID
					,  a.MDPR_CLSF_CD as MDPR_CLSF_CD
					,  decode(b.OTPT_PHRM_INJT_YN,'Y','3',a.DRAP_DVSN_CD) as DRAP_DVSN_CD
					,  #{mdtnNoDvsnCd} as MDTN_NO_DVSN_CD
					,  #{mdtnNo} as MDTN_NO
					,  nvl(a.IHOH_DVSN_CD, 'I') as IHOH_DVSN_CD
					,  a.SDPF_EXRE_CD as SDPF_EXRE_CD
					,  a.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD
					,  a.PCKN_UNAD_QTY as PCKN_UNAD_QTY
					,  a.PCUN_CD as PCUN_CD
					,  a.ICUN_ADMN_VLM as ICUN_ADMN_VLM
					,  a.ICUN_CD as ICUN_CD
					,  decode(nvl(a.NTM, 0), 0, 1, nvl(a.NTM, 0)) as NTM
					,  decode(nvl(a.DDCN, 0), 0, 1, nvl(a.DDCN, 0)) as DDCN
					,  a.DRUS_CD as DRUS_CD
					,  to_char( decode(b.DRAP_DVSN_CD,'2',a.INJC_PRRN_YMD,a.MDTN_STRT_YMD) , 'YYYYMMDD') as INJC_PRRN_YMD
					,  to_char(a.PHRM_IMPL_YMD, 'YYYYMMDD') as PHRM_IMPL_YMD
					, case when nvl(r.MDCR_TISS_DVSN_CD,'XXX') = 'M01' then a.MCDP_CD
						   when nvl(r.MDCR_TISS_DVSN_CD,'XXX') = 'W01' then a.WARD_CD
							                                           else a.OROC_DPRT_CD
		                end            as INJC_PLAC_CD
					,  a.MDTN_NO as TRGT_MDTN_NO
					,  a.DRBN_NO as DRBN_NO
					,  a.MIX_KIND_CD as MIX_KIND_CD
					,  a.DRUG_ORDR_PRSS_CD as DRUG_ORDR_PRSS_CD
					/*  임상시험약이면 Subject No,Initial,Visit No,Cycle No,Med No 를 특기사항에 포함한다. */
					,  a.DRUG_ORDR_UNSL_CTN || decode(b.DGMT_RGST_TYPE_CD,'2', ' Subject No ' || a.SUBJ_IDNT_NO || '/' ||
																			   ' Initial ' || a.SUBJ_INTI_VL || '/' ||
																			   ' Visit No ' || a.SUBJ_VIST_NM || '/' ||
																			   ' Cycle No ' || a.SUBJ_ADMN_VL || '/' ||
																			   ' Med No ' || a.CLNC_EXAM_MDPR_CTN, '')
											|| decode(a.TPRN_ORDR_YN, 'Y',' [Tapering: ' || to_char(a.MDTN_STRT_YMD,'yyyymmdd') || '~' || to_char(a.MDTN_FNSH_YMD,'yyyymmdd') || ']','')  as DRUG_ORDR_UNSL_CTN
					,  a.DURV_RESN_CTN as DURV_RESN_CTN
					,  a.ADTN_ORDV_CD as ADTN_ORDV_CD
					,  '' as ORDR_CRTN_DVSN_CD  /* a.PRNACTYN*/
					,  a.SBSN_UPDT_CMMD_YN as SBSN_UPDT_CMMD_YN
					,  a.CMMD_PRSR_YN as CMMD_PRSR_YN
					,  a.ORDR_IPDV_CD as ORDR_IPDV_CD
					,  a.RCST_CD as RCST_CD
					,  a.PHDP_PRIN_YN as PHDP_PRIN_YN
					,  to_char(nvl(a.LAST_UPDT_DT, a.FRST_RGST_DT), 'YYYYMMDDHH24MISS') as LAST_UPDT_DT
					,  b.STST_DVSN_CD as STST_DVSN_CD
					,  b.BSIS_CMMD_PLAC_CD as CMMD_PLAC_CD
					,  b.TIMS1_TOTL_QTY_YN as TIMS1_TOTL_QTY_YN
					,  nvl(b.DVDN_DVSN_CD, 'N') as DVDN_DVSN_CD
					,  b.WSCN_SNGN_YN as WSCN_SNGN_YN
					,  b.PTP_MDPR_YN as PTP_MDPR_YN
					,  b.PWDR_DSLW_YN as PWDR_DSLW_YN
					,  b.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD
					,  ceil(months_between(sysdate, c.BTDT))     as AGE_VL
					,  0                                         as TOTL_VLM
					,  0                                         as FRNS_CQY
					,  null                       as TKMD_CCPP_PRIN_YN
					,  0                        as PHDP_CMMD_BNDL_NO
					,  b.DGFR_CD                                       as DGFR_CD
					,  nvl(a.SNGN_BNDL_YN, 'N')                             as SNGN_BNDL_YN
					,  decode(e.PHRM_DTLS_CTRL_CD, null, 'N', 'Y')                      as COMN_DTLS_CD
					,  f.DRAP_DVSN_CD                    as APDV_CD
					,  'N'                                              as SB_DRUS_CD
					,  g1.DVDN_PILL_YN as PHRM_CTRL_CHRC_VL_1
					,  g1.MLTL_VL as PHRM_CTRL_CHRC_VL_2
					,  g1.NMBR_VL_1_CTN as PHRM_CTRL_CHRC_VL_3
					,  g1.NMBR_VL_2_CTN as PHRM_CTRL_CHRC_VL_4
					,  g1.NMBR_VL_3_CTN as PHRM_CTRL_CHRC_VL_5
					,  g1.NMBR_VL_4_CTN as PHRM_CTRL_CHRC_VL_6
					,  '' as PHRM_CTRL_CHRC_VL_7
					,  g1.EXCS_MLTL_VL as PHRM_CTRL_CHRC_VL_10
					,  0                                     as AFI_TRGT_COT
					,  'N'  as MNGM_DVSN_CD
					,  a.HSLC_DVSN_CD                        as MDTN_LCDV_CD
					,  a.FRNS_CTRL_DVSN_CD                   as FRNS_CTRL_DVSN_CD
					,  nvl(a.NTM, 1)                 as ADMN_NTM
					,  a.TOTL_VLM                    as TOTL_CLCL_QTY
					,  a.FRNS_VLM                    as INVN_TOTL_QTY
					,  a.MDTN_NO_DVSN_CD as BEMD_NO_DVSN_CD
					,  nvl(b.INJT_MIX_CMMD_DVSN_CD,'N')      as INJT_MIX_CMMD_DVSN_CD
					,  'N'                                   as STER_CMMD_IMPL_YN
					,  case when (a.CODV_CD = 'H' and a.RCST_CD = 'W') then to_char(a.RCPC_DT,'YYYYMMDDHH24MISS') else null end as RCPC_DT
				 from
					   MDMEDORDT a
					,  SDDDGCDMT b
					,  APPTPTNTV c
					,  SDMCTRLMT e
					,  SDDMETCDT f
					,  SDBCOUNTT g1
					,  APRCRPTNT i
		            ,  HZDEPTMMT r
				where  A.ORDR_YMD  = to_date(#{ordrYmd}, 'YYYYMMDD')
				  and  A.PTNO    = #{ptno}
				  and  a.CODV_CD    = #{codvCd}
				  and  a.PTAD_CODV_CD    = #{ptadCodvCd}
				  and  decode( nvl( r.MDCR_TISS_DVSN_CD,'XXX') , 'M01', 'M01', 'W01','W01', a.OROC_DPRT_CD )  = #{phdpOrocDprtCd} 
				  and  decode(a.ODKI_CD, 'D', 'D', 'H', 'D', 'A', 'A', 'G') = #{odkiCd}
				  and  a.ORFR_CD   = #{orfrCd}
				  and  a.WARD_CD   = #{wardCd}
				  and  a.MCDP_CD  = #{mcdpCd}
				  and  i.MDCR_DT    = to_date(#{mdcrDt}, 'YYYYMMDDHH24MISS')
				  and  nvl(a.DRUG_ORDR_PRSS_CD, '0') = '0'
				  and  a.PHDP_PRIN_YN    is null
				  and  a.PTAD_CODV_CD != 'O'  /*  퇴원처방중 외래로 전환되는 처방은 sdpstatet 발생시켜서 외래로 접수시킴 */
				  and  (
						   (#{wodvCd} = '1' and nvl(a.DC_DVSN_CD, 'N') = 'C')
						   or
						   (#{wodvCd} = '2' and nvl(a.DC_DVSN_CD, 'N') = 'N')
					   )
				  and  nvl(a.RCST_CD, 'N') in ('F', 'Y')
				  and  a.HSLC_DVSN_CD = #{mdtnLcdvCd} /*  투약위치 */
				  and  (
						   (a.FRNS_CTRL_DVSN_CD is null)
						   or
						   (a.FRNS_CTRL_DVSN_CD is not null and a.FRNS_YN = 'Y')
					   )
				  and  b.MDPR_CD    = a.ORDR_CD
				  and  (
						   (nvl(#{clniYn}, 'A') = 'A')
						   or
						   (
							   nvl(#{clniYn}, 'A') = 'Y'
									   and
									   (
										   a.DRUS_CD = 'IRB'
								   or
								   nvl(b.STST_DVSN_CD, '0') in ('6', 'A', 'C')
								   or
								   (a.PTNO,
									a.ORDR_YMD,
									a.HSLC_DVSN_CD,
									a.DRBN_NO
								   )
								   in
								   (
													   select
															   x.PTNO
															,  x.ORDR_YMD
															,  x.HSLC_DVSN_CD
															,  x.DRBN_NO
														 from
															   MDMEDORDT x
															,  SDDDGCDMT y
		                                                    ,  HZDEPTMMT  r
														where  x.ptno = #{ptno}
														  and  x.ordr_ymd = to_date(#{ordrYmd}, 'YYYYMMDD')
														  and  x.CODV_CD    = #{codvCd}
														  and  x.ORFR_CD    = #{orfrCd}
														  and  x.WARD_CD    = #{wardCd}
														  and  decode(x.ODKI_CD, 'D', 'D', 'H', 'D', 'A', 'A', 'G') = #{odkiCd}
														  and  x.ODKI_CD  != 'A'
														  and  decode( nvl( r.MDCR_TISS_DVSN_CD,'XXX') , 'M01', 'M01', 'W01','W01', x.OROC_DPRT_CD )  = #{phdpOrocDprtCd} 
														  and  nvl(x.RCST_CD, 'N') in ('F', 'Y')
														  and  nvl(x.DRUG_ORDR_PRSS_CD, '0') = '0'
														  and  nvl(x.PHDP_PRIN_YN, 'N') = 'N'
														  and  nvl(x.MIX_KIND_CD, '0') = '1'
														  and  (
																   (#{wodvCd} = '1' and nvl(x.DC_DVSN_CD, 'N') = 'C')
																   or
																   (#{wodvCd} = '2' and nvl(x.DC_DVSN_CD, 'N') = 'N')
															   )
														  and  x.HSLC_DVSN_CD = a.HSLC_DVSN_CD
														  and  y.MDPR_CD = x.ORDR_CD
														  and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		                                                  and  r.DPRT_CD = x.OROC_DPRT_CD
														group
														   by
															   x.PTNO
															,  x.ORDR_YMD
															,  x.HSLC_DVSN_CD
															,  x.DRBN_NO
								  )
							  )
						  )
						  or
						  (
							  nvl(#{clniYn}, 'A') = 'N'
									  and
									  (
										  a.DRUS_CD != 'IRB'
											  and
											  nvl(b.STST_DVSN_CD , '0') not in ('6', 'A', 'C')
											  and
											  (a.PTNO,
								   a.ORDR_YMD,
								   a.HSLC_DVSN_CD,
								   a.DRBN_NO
								  )
											  not in
								  (
													  select
															  x.PTNO
														   ,  x.ORDR_YMD
														   ,  x.HSLC_DVSN_CD
														   ,  x.DRBN_NO
														from
															  MDMEDORDT x
														   ,  SDDDGCDMT y
		                                                   ,  HZDEPTMMT r
													   where  x.ptno = #{ptno}
														 and  x.ordr_ymd = to_date(#{ordrYmd}, 'YYYYMMDD')
														 and  x.CODV_CD    = #{codvCd}
														 and  x.ORFR_CD    = #{orfrCd}
														 and  x.WARD_CD    = #{wardCd}
														 and  decode(x.ODKI_CD, 'D', 'D', 'H', 'D', 'A', 'A', 'G') = #{odkiCd}
														 and  x.ODKI_CD  != 'A'
													 	 and  decode( nvl( r.MDCR_TISS_DVSN_CD,'XXX') , 'M01', 'M01', 'W01','W01', x.OROC_DPRT_CD )  = #{phdpOrocDprtCd} 
														 and  nvl(x.RCST_CD, 'N') in ('F', 'Y')
														 and  nvl(x.DRUG_ORDR_PRSS_CD, '0') = '0'
														 and  nvl(x.PHDP_PRIN_YN, 'N') = 'N'
														 and  nvl(x.MIX_KIND_CD, '0') = '1'
														 and  (
																  (#{wodvCd} = '1' and nvl(x.DC_DVSN_CD, 'N') = 'C')
																  or
																  (#{wodvCd} = '2' and nvl(x.DC_DVSN_CD, 'N') = 'N')
															  )
														 and  x.HSLC_DVSN_CD = a.HSLC_DVSN_CD
														 and  y.MDPR_CD = x.ORDR_CD
														 and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		                                                 and  r.DPRT_CD = x.OROC_DPRT_CD
													   group
														  by
															  x.PTNO
														   ,  x.ORDR_YMD
														   ,  x.HSLC_DVSN_CD
														   ,  x.DRBN_NO
								  )
							  )
						  )
					   )
				  and  C.PTNO      = A.PTNO
				  and  e.PHRM_CTRL_CD(+) = 'SD090'
				  and  e.PHRM_DTLS_CTRL_CD(+)    = a.ORDR_CD
				  and  f.DRUS_CD(+)= a.DRUS_CD
				  and  g1.LCDV_CD(+) = #{mdtnLcdvCd}
				  and  g1.OTPT_WARD_DVSN_CD(+) = 'I'
				  and  g1.MDPR_CD(+) = a.ORDR_CD
				  and  a.MDRP_NO = i.MDRP_NO
		          and  r.DPRT_CD = a.FRNS_DPRT_CD /* OROC_CD 작업완료 */
				order
				   by
					   decode(a.ODKI_CD, 'D', 'D', 'H', 'D', 'G'),
					   a.ORFR_CD,
					   decode(a.DRBN_NO,0, 99999999,a.DRBN_NO),
					   nvl(a.SNGN_BNDL_YN, 'N') desc,
					   decode( decode(b.OTPT_PHRM_INJT_YN,'Y','3',a.DRAP_DVSN_CD) , '2', 'Z', 'A'),
					   decode(b.MDPR_CLSF_CD, '3', 'Z', 'A'),
					   decode(b.STST_DVSN_CD, '2', 'Z', 'A'),
					   decode(nvl(a.NTM, 0), 0, 1, nvl(a.NTM, 0)),
					   decode(nvl(a.DDCN, 0), 0, 1, nvl(a.DDCN, 0)),
					   decode(a.DRUS_CD, 'UD'  , 'ZZZZZ'
												   ,'PRN' , 'ZZZZZ'
												   ,'PRN2', 'ZZZZZ'
												   ,'PRN4', 'ZZZZZ'
												   ,'ACS' , 'ZZZZZ', a.DRUS_CD),
					   decode(nvl(a.MIX_KIND_CD, '0'), '2', '9', nvl(a.MIX_KIND_CD, '0')),
					   decode(b.BSIS_CMMD_PLAC_CD, '4', 'Z', b.BSIS_CMMD_PLAC_CD),
					   a.ORDR_CD,
					   a.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDrusClby-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="orocCd" column="OROC_CD"/>
		<result property="orocDprtCd" column="OROC_DPRT_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="orclCd" column="ORCL_CD"/>
		<result property="odkiCd" column="ODKI_CD"/>
		<result property="ordrCltyCd" column="ORDR_CLTY_CD"/>
		<result property="orfrCd" column="ORFR_CD"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="chdrId" column="CHDR_ID"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunCd" column="PCUN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="ntm" column="NTM"/>
		<result property="ddcn" column="DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="injcPrrnYmd" column="INJC_PRRN_YMD"/>
		<result property="phrmImplYmd" column="PHRM_IMPL_YMD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="trgtMdtnNo" column="TRGT_MDTN_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="drugOrdrPrssCd" column="DRUG_ORDR_PRSS_CD"/>
		<result property="drugOrdrUnslCtn" column="DRUG_ORDR_UNSL_CTN"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="adtnOrdvCd" column="ADTN_ORDV_CD"/>
		<result property="ordrCrtnDvsnCd" column="ORDR_CRTN_DVSN_CD"/>
		<result property="sbsnUpdtCmmdYn" column="SBSN_UPDT_CMMD_YN"/>
		<result property="cmmdPrsrYn" column="CMMD_PRSR_YN"/>
		<result property="ordrIpdvCd" column="ORDR_IPDV_CD"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="phdpPrinYn" column="PHDP_PRIN_YN"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="cmmdPlacCd" column="CMMD_PLAC_CD"/>
		<result property="tims1TotlQtyYn" column="TIMS1_TOTL_QTY_YN"/>
		<result property="dvdnDvsnCd" column="DVDN_DVSN_CD"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ptpMdprYn" column="PTP_MDPR_YN"/>
		<result property="pwdrDslwYn" column="PWDR_DSLW_YN"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="ageVl" column="AGE_VL"/>
		<result property="totlVlm" column="TOTL_VLM"/>
		<result property="frnsCqy" column="FRNS_CQY"/>
		<result property="tkmdCcppPrinYn" column="TKMD_CCPP_PRIN_YN"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="dgfrCd" column="DGFR_CD"/>
		<result property="sngnBndlYn" column="SNGN_BNDL_YN"/>
		<result property="comnDtlsCd" column="COMN_DTLS_CD"/>
		<result property="apdvCd" column="APDV_CD"/>
		<result property="sbDrusCd" column="SB_DRUS_CD"/>
		<result property="phrmCtrlChrcVl1" column="PHRM_CTRL_CHRC_VL_1"/>
		<result property="phrmCtrlChrcVl2" column="PHRM_CTRL_CHRC_VL_2"/>
		<result property="phrmCtrlChrcVl3" column="PHRM_CTRL_CHRC_VL_3"/>
		<result property="phrmCtrlChrcVl4" column="PHRM_CTRL_CHRC_VL_4"/>
		<result property="phrmCtrlChrcVl5" column="PHRM_CTRL_CHRC_VL_5"/>
		<result property="phrmCtrlChrcVl6" column="PHRM_CTRL_CHRC_VL_6"/>
		<result property="phrmCtrlChrcVl7" column="PHRM_CTRL_CHRC_VL_7"/>
		<result property="phrmCtrlChrcVl10" column="PHRM_CTRL_CHRC_VL_10"/>
		<result property="afiTrgtCot" column="AFI_TRGT_COT"/>
		<result property="mngmDvsnCd" column="MNGM_DVSN_CD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="frnsCtrlDvsnCd" column="FRNS_CTRL_DVSN_CD"/>
		<result property="admnNtm" column="ADMN_NTM"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="bemdNoDvsnCd" column="BEMD_NO_DVSN_CD"/>
		<result property="injtMixCmmdDvsnCd" column="INJT_MIX_CMMD_DVSN_CD"/>
		<result property="sterCmmdImplYn" column="STER_CMMD_IMPL_YN"/>
		<result property="rcpcDt" column="RCPC_DT"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDrusClby (단기입원 처방 접수 용법별상세 조회) 
        Description :                                           단기입원 처방 접수 용법별상세 조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDrusClby-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDrusClby"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDrusClby-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAntcTermOrdrDrusClby */
		<![CDATA[
				   select  /*+ sdd_mdmedor_l26$S01_02C 항암제 처방 용법별 조회 */
					   a.PTNO as PTNO
					,  to_char(a.ORDR_YMD, 'YYYYMMDD') as ORDR_YMD
					,  a.ORDR_SNO as ORDR_SNO
					,  a.CODV_CD as CODV_CD
					,  to_char(a.MDCR_DT, 'YYYYMMDDHH24MISS') as MDCR_DT
		      ,  ''                                   as OROC_CD /* OROC_CD 작업완료 */
		      ,  ''                                   as OROC_DPRT_CD
		      ,  a.PHDP_OROC_DPRT_CD                  as PHDP_OROC_DPRT_CD
					,  a.MCDP_CD as MCDP_CD
					,  a.WARD_CD as WARD_CD
					,  a.ORCL_CD as ORCL_CD
					,  a.ODKI_CD as ODKI_CD
					,  a.ORDR_CLTY_CD as ORDR_CLTY_CD
					,  a.ORFR_CD as ORFR_CD
					,  a.ORDR_CD as ORDR_CD
					,  a.ODDR_ID as ODDR_ID
					,  a.GNDR_ID as CHDR_ID
					,  a.MDPR_CLSF_CD as MDPR_CLSF_CD
					,  a.DRAP_DVSN_CD as DRAP_DVSN_CD
					,  #{mdtnNoDvsnCd} as MDTN_NO_DVSN_CD
					,  #{mdtnNo} as MDTN_NO
					,  nvl(a.IHOH_DVSN_CD, 'I') as IHOH_DVSN_CD
					,  a.SDPF_EXRE_CD as SDPF_EXRE_CD
					,  a.SLCT_UNIT_DVSN_CD as SLCT_UNIT_DVSN_CD
					,  a.PCKN_UNAD_QTY as PCKN_UNAD_QTY
					,  a.PCUN_CD as PCUN_CD
					,  a.ICUN_ADMN_VLM as ICUN_ADMN_VLM
					,  a.ICUN_CD as ICUN_CD
					,  decode(c.SB_DRUS_CD, null, a.nCnt, 1) as NTM
					,  a.nDAY as DDCN
					,  nvl(c.SB_DRUS_CD, a.DRUS_CD) as DRUS_CD
					,  to_char(a.INJC_PRRN_YMD, 'YYYYMMDD') as INJC_PRRN_YMD
					,  to_char(a.PHRM_IMPL_YMD, 'YYYYMMDD') as PHRM_IMPL_YMD
					,  a.FRNS_DPRT_CD as INJC_PLAC_CD
					,  a.MDTN_NO as TRGT_MDTN_NO
					,  a.DRBN_NO as DRBN_NO
					,  a.MIX_KIND_CD as MIX_KIND_CD
					,  nvl(a.DRUG_ORDR_PRSS_CD, '0') as DRUG_ORDR_PRSS_CD
					,  a.DRUG_ORDR_UNSL_CTN as DRUG_ORDR_UNSL_CTN
					,  a.DURV_RESN_CTN as DURV_RESN_CTN
					,  a.ADTN_ORDV_CD as ADTN_ORDV_CD
					,  a.ENFR_YN as ORDR_CRTN_DVSN_CD
					,  a.SBSN_UPDT_CMMD_YN as SBSN_UPDT_CMMD_YN
					,  a.CMMD_PRSR_YN as CMMD_PRSR_YN
					,  a.ORDR_IPDV_CD as ORDR_IPDV_CD
					,  a.RCST_CD as RCST_CD
					,  a.PHDP_PRIN_YN as PHDP_PRIN_YN
					,  to_char(nvl(a.LAST_UPDT_DT,a.FRST_RGST_DT),'YYYYMMDDHH24MISS') as LAST_UPDT_DT
					,  a.STST_DVSN_CD as STST_DVSN_CD
					,  a.BSIS_CMMD_PLAC_CD as CMMD_PLAC_CD
					,  a.TIMS1_TOTL_QTY_YN as TIMS1_TOTL_QTY_YN
					,  nvl(a.DVDN_DVSN_CD,'N') as DVDN_DVSN_CD
					,  a.WSCN_SNGN_YN as WSCN_SNGN_YN
					,  a.PTP_MDPR_YN as PTP_MDPR_YN
					,  a.PWDR_DSLW_YN as PWDR_DSLW_YN
					,  a.TOTL_QTY_CLCL_CD as TOTL_QTY_CLCL_CD
					,  a.AGE as AGE_VL
					,  a.TOTL_CLCL_QTY as TOTL_VLM
					,  a.INVN_TOTL_QTY as FRNS_CQY
					,  a.TKMD_CCPP_PRIN_YN as TKMD_CCPP_PRIN_YN
					,  a.PHDP_CMMD_BNDL_NO as PHDP_CMMD_BNDL_NO
					,  a.DGFR_CD as DGFR_CD
					,  a.SNGN_BNDL_YN as SNGN_BNDL_YN
					,  a.COMN_DTLS_CD as COMN_DTLS_CD
					,  b.DRAP_DVSN_CD as APDV_CD
					,  decode(c.SB_DRUS_CD,null,'N','Y') as SB_DRUS_CD
					,  a.OPTN_CTN1 as PHRM_CTRL_CHRC_VL_1
					,  a.OPTN_CTN2 as PHRM_CTRL_CHRC_VL_2
					,  a.OPTN_CTN3 as PHRM_CTRL_CHRC_VL_3
					,  a.OPTN_CTN4 as PHRM_CTRL_CHRC_VL_4
					,  a.OPTN_CTN5 as PHRM_CTRL_CHRC_VL_5
					,  a.OPTN_CTN6 as PHRM_CTRL_CHRC_VL_6
					,  a.OPTN_CTN7 as PHRM_CTRL_CHRC_VL_7
					,  a.OPTN_CTN10 as PHRM_CTRL_CHRC_VL_10
					,  a.CUNT_TRNM_MDPR_COT as AFI_TRGT_COT
					,  a.USE_YN as MNGM_DVSN_CD
					,  a.MDTN_LCDV_CD as MDTN_LCDV_CD
					,  a.FRNS_CTRL_DVSN_CD           as FRNS_CTRL_DVSN_CD
					,  a.NTM                         as ADMN_NTM
					,  a.TOTL_VLM                    as TOTL_CLCL_QTY
					,  a.FRNS_VLM                    as INVN_TOTL_QTY
					,  a.MDTN_NO_DVSN_CD as BEMD_NO_DVSN_CD
					,  a.INJT_MIX_CMMD_DVSN_CD as INJT_MIX_CMMD_DVSN_CD
					,  a.STER_CMMD_IMPL_YN as STER_CMMD_IMPL_YN
					,  a.RCPC_DT as RCPC_DT
		            ,  a.PHDP_OROC_DPRT_CD           
				 from
					  (
					   select
							  a.PTNO
						   ,  a.ORDR_YMD
						   ,  a.ORDR_SNO
						   ,  a.CODV_CD
						   ,  i.MDCR_DT
		         	 ,  ''                                                      as OROC_CD /* OROC_CD 작업완료 */
		        	 ,  ''                                                      as OROC_DPRT_CD
		                     ,  case when nvl( r.MDCR_TISS_DVSN_CD, 'XXX') in ('M01') then 'M01'
		                             when nvl( r.MDCR_TISS_DVSN_CD, 'XXX') in ('W01') then 'W01'
		                                                                              else r.PHDP_OROC_DPRT_CD
		                        end                                                     as PHDP_OROC_DPRT_CD
						   ,  a.MCDP_CD
						   ,  a.WARD_CD
						   ,  a.ORCL_CD
						   ,  a.ODKI_CD
						   ,  a.ORDR_CLTY_CD
						   ,  a.ORFR_CD
						   ,  a.ORDR_CD
						   ,  a.CHDR_ID ODDR_ID
						   ,  a.CHDR_ID GNDR_ID
						   ,  a.MDPR_CLSF_CD
						   ,  decode(b.OTPT_PHRM_INJT_YN,'Y','3',a.DRAP_DVSN_CD) DRAP_DVSN_CD
						   ,  a.IHOH_DVSN_CD
						   ,  a.SDPF_EXRE_CD
						   ,  a.SLCT_UNIT_DVSN_CD
						   ,  a.PCKN_UNAD_QTY
						   ,  a.PCUN_CD
						   ,  a.ICUN_ADMN_VLM
						   ,  a.ICUN_CD
						   ,  decode(nvl(a.NTM, 0), 0, 1, a.NTM) nCnt
						   ,  decode(nvl(a.DDCN, 0), 0, 1, a.DDCN) nDAY
						   ,  a.DRUS_CD
						   ,  decode(b.DRAP_DVSN_CD,'2',a.INJC_PRRN_YMD,a.MDTN_STRT_YMD) INJC_PRRN_YMD
						   ,  a.PHRM_IMPL_YMD
						   ,  decode(nvl( r.MDCR_TISS_DVSN_CD,'XXX'), 'M01', a.MCDP_CD, 'W01', a.WARD_CD, 	a.OROC_DPRT_CD )    FRNS_DPRT_CD
						   ,  a.MDTN_NO
						   ,  a.DRBN_NO
						   ,  a.MIX_KIND_CD
						   ,  a.DRUG_ORDR_PRSS_CD
						   /*  임상시험약이면 Subject No,Initial,Visit No,Cycle No,Med No 를 특기사항에 포함한다. */
						   ,  a.DRUG_ORDR_UNSL_CTN || decode(b.DGMT_RGST_TYPE_CD,'2', ' Subject No ' || a.SUBJ_IDNT_NO || '/' ||
																					  ' Initial ' || a.SUBJ_INTI_VL || '/' ||
																					  ' Visit No ' || a.SUBJ_VIST_NM || '/' ||
																					  ' Cycle No ' || a.SUBJ_ADMN_VL || '/' ||
																					  ' Med No ' || a.CLNC_EXAM_MDPR_CTN, '')
												   || decode(a.TPRN_ORDR_YN, 'Y',' [Tapering: ' || to_char(a.MDTN_STRT_YMD,'yyyymmdd') || '~' || to_char(a.MDTN_FNSH_YMD,'yyyymmdd') || ']','') DRUG_ORDR_UNSL_CTN
						   ,  a.DURV_RESN_CTN
						   ,  a.ADTN_ORDV_CD
						   ,  ''                                              ENFR_YN
						   ,  a.SBSN_UPDT_CMMD_YN
						   ,  a.CMMD_PRSR_YN
						   ,  a.ORDR_IPDV_CD
						   ,  a.RCST_CD
						   ,  a.PHDP_PRIN_YN
						   ,  a.FRST_RGST_DT
						   ,  a.LAST_UPDT_DT
						   ,  b.STST_DVSN_CD
						   ,  b.BSIS_CMMD_PLAC_CD
						   ,  b.TIMS1_TOTL_QTY_YN
						   ,  b.DVDN_DVSN_CD
						   ,  b.WSCN_SNGN_YN
						   ,  b.PTP_MDPR_YN
						   ,  b.PWDR_DSLW_YN
						   ,  b.TOTL_QTY_CLCL_CD
						   ,  ceil(months_between(sysdate, c.BTDT))    AGE
						   ,  0                                           TOTL_CLCL_QTY
						   ,  0                                           INVN_TOTL_QTY
						   ,  null                                        TKMD_CCPP_PRIN_YN
						   ,  0                                           PHDP_CMMD_BNDL_NO
						   ,  b.DGFR_CD                                  DGFR_CD
						   ,  decode(nvl(a.SNGN_BNDL_YN, 'N'), 'Y', nvl(a.SNGN_BNDL_YN, 'N')
															 ,decode(to_char(greatest(129, ascii(substr(c.PTNT_NM, 1, 1)))) ||
															  a.DRBN_NO                                                     ||
															  nvl(a.IHOH_DVSN_CD, 'I')                                      ||
															  greatest('5', b.BSIS_CMMD_PLAC_CD), '1290I5', 'Y', nvl(a.SNGN_BNDL_YN, 'N')))  SNGN_BNDL_YN
						   ,  decode(e.PHRM_DTLS_CTRL_CD, null, 'N', 'Y')     COMN_DTLS_CD
						   ,  g.DVDN_PILL_YN   OPTN_CTN1
						   ,  g.MLTL_VL        OPTN_CTN2
						   ,  g.NMBR_VL_1_CTN  OPTN_CTN3
						   ,  g.NMBR_VL_2_CTN  OPTN_CTN4
						   ,  g.NMBR_VL_3_CTN  OPTN_CTN5
						   ,  g.NMBR_VL_4_CTN  OPTN_CTN6
						   ,  ''                OPTN_CTN7
						   ,  g.EXCS_MLTL_VL   OPTN_CTN10
						   ,  0                                           CUNT_TRNM_MDPR_COT
						   ,  'N'                                         USE_YN
						   ,  a.HSLC_DVSN_CD                              MDTN_LCDV_CD  /*  투약위치 */
						   ,  a.FRNS_CTRL_DVSN_CD                         FRNS_CTRL_DVSN_CD
						   ,  nvl(a.NTM, 1)                               NTM
						   ,  a.TOTL_VLM                                  TOTL_VLM
						   ,  a.FRNS_VLM                                  FRNS_VLM
						   ,  a.MDTN_NO_DVSN_CD
						   ,  nvl(b.INJT_MIX_CMMD_DVSN_CD,'N')            INJT_MIX_CMMD_DVSN_CD
						   ,  'N'                                         STER_CMMD_IMPL_YN
						   ,  b.OTPT_PHRM_INJT_YN
						   ,  case when (a.CODV_CD = 'H' and a.RCST_CD = 'W') then to_char(a.RCPC_DT,'YYYYMMDDHH24MISS') else null end RCPC_DT
						from
							    MDMEDORDT a
						   ,  SDDDGCDMT b
						   ,  APPTPTNTV c
						   ,  CCCMCDDMT d
						   ,  CCCMCDIDT d1
						   ,  SDMCTRLMT e
						   ,  SDBCOUNTT g
						   ,  APRCRPTNT i
		                   ,  HZDEPTMMT r
					   where  A.ORDR_YMD  = to_date(#{ordrYmd}, 'YYYYMMDD')
						 and  A.PTNO    = #{ptno}
						 and  a.CODV_CD    = #{codvCd}
						 and  a.PTAD_CODV_CD    = #{ptadCodvCd}
					     and  decode( nvl( r.MDCR_TISS_DVSN_CD,'XXX') , 'M01','M01','W01','W01', r.PHDP_OROC_DPRT_CD )  = #{phdpOrocDprtCd} 
						 and  decode(a.ODKI_CD, 'D', 'D', 'H', 'D', 'A', 'A', 'G') = #{odkiCd}
						 and  a.ORFR_CD   = #{orfrCd}
						 and  a.WARD_CD   = #{wardCd}
						 and  a.MCDP_CD  = #{mcdpCd}
						 and  i.MDCR_DT    = to_date(#{mdcrDt}, 'YYYYMMDDHH24MISS')
						 and  nvl(a.DRUG_ORDR_PRSS_CD, '0') = '0'
						 and  a.PHDP_PRIN_YN    is null
						 and  (
								  (#{wodvCd} = '1' and nvl(a.DC_DVSN_CD, 'N') = 'C')
								  or
								  (#{wodvCd} = '2' and nvl(a.DC_DVSN_CD, 'N') = 'N')
							  )
						 and  nvl(a.RCST_CD, 'N') in ('F', 'Y')
						 and  a.HSLC_DVSN_CD = #{mdtnLcdvCd}
						 and  (
								  (a.FRNS_CTRL_DVSN_CD is null)
								  or
								  (a.FRNS_CTRL_DVSN_CD is not null and a.FRNS_YN = 'Y')
							  )
						 and  b.MDPR_CD    = a.ORDR_CD
						 and  (
								  (nvl(#{clniYn}, 'A') = 'A')
								  or
								  (
									  nvl(#{clniYn}, 'A') = 'Y'
									 and
									 (
										 a.DRUS_CD = 'IRB'
										 or
										 nvl(b.STST_DVSN_CD, '0') in ('6', 'A', 'C')
										 or
										 (a.PTNO,
										  a.ORDR_YMD,
										  a.HSLC_DVSN_CD,
										  a.DRBN_NO
										 )
										 in
										  (
											  select
													  x.PTNO
												   ,  x.ORDR_YMD
												   ,  x.HSLC_DVSN_CD
												   ,  x.DRBN_NO
												from
													  MDMEDORDT x
												   ,  SDDDGCDMT y
		                                           ,  HZDEPTMMT r
											   where  x.PTNO = #{ptno}
												 and  x.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
												 and  x.CODV_CD    = #{codvCd}
												 and  x.ORFR_CD    = #{orfrCd}
												 and  x.WARD_CD    = #{wardCd}
												 and  decode(x.ODKI_CD, 'D', 'D', 'H', 'D', 'A', 'A', 'G') = #{odkiCd}
												 and  x.ODKI_CD  != 'A'
												  and  decode( nvl( r.MDCR_TISS_DVSN_CD,'XXX') , 'M01','M01','W01','W01', x.OROC_DPRT_CD )  = #{phdpOrocDprtCd} 
												 and  nvl(x.RCST_CD, 'N') in ('F', 'Y')
												 and  nvl(x.DRUG_ORDR_PRSS_CD, '0') = '0'
												 and  nvl(x.PHDP_PRIN_YN, 'N') = 'N'
												 and  nvl(x.MIX_KIND_CD, '0') = '1'
												 and  (
														  (#{wodvCd} = '1' and nvl(x.DC_DVSN_CD, 'N') = 'C')
														  or
														  (#{wodvCd} = '2' and nvl(x.DC_DVSN_CD, 'N') = 'N')
													  )
												 and  x.HSLC_DVSN_CD = a.HSLC_DVSN_CD
												 and  y.MDPR_CD = x.ORDR_CD
												 and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		                                         and  r.DPRT_CD = x.OROC_DPRT_CD
											   group
												  by
													  x.PTNO
												   ,  x.ORDR_YMD
												   ,  x.HSLC_DVSN_CD
												   ,  x.DRBN_NO
										   )
									   )
								   )
								   or
								   (
									   nvl(#{clniYn} , 'A') = 'N'
									   and
									   (
										   a.DRUS_CD != 'IRB'
										   and
										   nvl(b.STST_DVSN_CD , '0') not in ('6', 'A', 'C')
										   and
										   (a.PTNO,
											a.ORDR_YMD,
											a.HSLC_DVSN_CD,
											a.DRBN_NO
										   )
										   not in
										   (
											   select
													   x.PTNO
													,  x.ORDR_YMD
													,  x.HSLC_DVSN_CD
													,  x.DRBN_NO
												 from
													   MDMEDORDT x
													,  SDDDGCDMT y
		                                            ,  HZDEPTMMT  r
												where  x.PTNO = #{ptno}
												  and  x.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
												  and  x.CODV_CD    = #{codvCd}
												  and  x.ORFR_CD    = #{orfrCd}
												  and  x.WARD_CD    = #{wardCd}
												  and  decode(x.ODKI_CD, 'D', 'D', 'H', 'D', 'A', 'A', 'G') = #{odkiCd}
												  and  x.ODKI_CD  != 'A'
												  and  decode( nvl( r.MDCR_TISS_DVSN_CD,'XXX') , 'M01','M01','W01','W01', x.OROC_DPRT_CD )  = #{phdpOrocDprtCd} 
												  and  nvl(x.RCST_CD, 'N') in ('F', 'Y')
												  and  nvl(x.DRUG_ORDR_PRSS_CD, '0') = '0'
												  and  nvl(x.PHDP_PRIN_YN, 'N') = 'N'
												  and  nvl(x.MIX_KIND_CD, '0') = '1'
												  and  (
														   (#{wodvCd} = '1' and nvl(x.DC_DVSN_CD, 'N') = 'C')
														   or
														   (#{wodvCd} = '2' and nvl(x.DC_DVSN_CD, 'N') = 'N')
													   )
												  and  x.HSLC_DVSN_CD = a.HSLC_DVSN_CD
												  and  y.MDPR_CD = x.ORDR_CD
												  and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		                                          and  r.DPRT_CD = x.OROC_DPRT_CD
												group
												   by
													   x.PTNO
													,  x.ORDR_YMD
													,  x.HSLC_DVSN_CD
													,  x.DRBN_NO
										   )
									   )
								   )
							   )
						  and  C.PTNO      = A.PTNO
						  and  e.PHRM_CTRL_CD(+) = 'SD090'
						  and  e.PHRM_DTLS_CTRL_CD(+)    = a.ORDR_CD
						  and  g.LCDV_CD(+) = #{mdtnLcdvCd}
						  and  g.OTPT_WARD_DVSN_CD(+) = 'I'
						  and  g.MDPR_CD(+) = a.ORDR_CD
						  and  i.MDRP_NO = a.MDRP_NO
		                  and  r.DPRT_CD = a.FRNS_DPRT_CD /* OROC_CD 작업완료 */
						) a,
						  SDDMETCDT b,
					   (
						  select
								  a.DRUS_CD
							   ,  a.DRAP_DVSN_CD
							   ,  a.DGST_ADMN_NTM
							   ,  -1 DRBN_NO
							   ,  'N' SNGN_BNDL_YN
							   ,  '3' MDPR_CLSF_CD
							   ,  '2' STST_DVSN_CD
							   ,  '1' GAESU
							   ,  '4' SUJE
							   ,  '5' SANJE
							   ,  decode(b.NORN_SNO, 1 , 'AD'
													 ,2 , 'AD1'
													 ,3 , 'AE'
													 ,4 , 'AE1'
													 ,5 , 'AM'
													 ,6 , 'AM1'
													 ,7 , 'BD'
													 ,8 , 'BE'
													 ,9 , 'BM'
													 ,10, 'D'
													 ,11, 'D1'
													 ,12, 'D2'
													 ,13, 'E'
													 ,14, 'E1'
													 ,15, 'E2'
													 ,16, 'HS'
													 ,17, 'M'
													 ,18, 'M1'
													 ,19, 'M2'
													 ,20, 'WD'
													 ,21, 'WE'
													 ,22, 'WM', null) SB_DRUS_CD
							from
								  SDDMETCDT a
							   ,  CCDUMMYMT b
						   where  b.NORN_SNO > 0
							 and  b.NORN_SNO <= 22
							 and  substr(SB_DRUS_CD, b.NORN_SNO, 1) = 'Y'
						   )  c
					   where  b.DRUS_CD(+)= A.DRUS_CD
						 and  c.DRUS_CD(+)= a.DRUS_CD
						 and  c.DGST_ADMN_NTM(+) = a.nCnt
						 and  c.DRBN_NO(+) = nvl(a.DRBN_NO,-1)
						 and  c.SNGN_BNDL_YN(+) = a.SNGN_BNDL_YN
						 and  c.MDPR_CLSF_CD(+) != a.MDPR_CLSF_CD
						 and  c.STST_DVSN_CD(+) != nvl(a.STST_DVSN_CD,'0')
						 and  c.GAESU(+) != a.BSIS_CMMD_PLAC_CD
						 and  c.SUJE(+) != a.BSIS_CMMD_PLAC_CD
						 and  c.SANJE(+) != a.BSIS_CMMD_PLAC_CD
					   order
						  by
							  decode(a.ODKI_CD, 'D', 'D', 'H', 'D', 'G')
						   ,  a.ORFR_CD
						   ,  decode(a.DRBN_NO,0, 99999999,a.DRBN_NO)
						   ,  nvl(a.SNGN_BNDL_YN, 'N') desc
						   ,  decode( decode(a.OTPT_PHRM_INJT_YN,'Y','3',a.DRAP_DVSN_CD) , '2', 'Z', 'A')
						   ,  decode(a.MDPR_CLSF_CD, '3', 'Z', 'A')
						   ,  decode(a.STST_DVSN_CD, '2', 'Z', 'A')
						   ,  decode(c.SB_DRUS_CD, null, a.nCnt, 1)
						   ,  decode(nvl(a.nDAY, 0), 0, 1, nvl(a.nDAY, 0))
						   ,  decode(nvl(c.SB_DRUS_CD, A.DRUS_CD), 'UD'  , 'ZZZZZ'
																	  ,'PRN' , 'ZZZZZ'
																	  ,'PRN2', 'ZZZZZ'
																	  ,'PRN4', 'ZZZZZ'
																	  ,'ACS' , 'ZZZZZ', nvl(c.SB_DRUS_CD, A.DRUS_CD))
						   ,  decode(nvl(a.MIX_KIND_CD, '0'), '2', '9', nvl(a.MIX_KIND_CD, '0'))
						   ,  decode(a.BSIS_CMMD_PLAC_CD, '3', '0', a.BSIS_CMMD_PLAC_CD)
						   ,  a.ORDR_CD
						   ,  a.ORDR_SNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShet-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO_1"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="detlCdNm1" column="DETL_CD_NM_1"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="scinClncDxNm" column="SCIN_CLNC_DX_NM"/>
		<result property="subScinClncDxNm" column="SUB_SCIN_CLNC_DX_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="afiDrusCd" column="AFI_DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="tkmdInftDrusCtn" column="TKMD_INFT_DRUS_CTN"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="afiNrdrCct" column="AFI_NRDR_CCT"/>
		<result property="afiDgstItrcNm" column="AFI_DGST_ITRC_NM"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="nextMdcrYmd" column="NEXT_MDCR_YMD"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="tkmdCcfeYn" column="TKMD_CCFE_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="newYn" column="NEW_YN"/>
		<result property="afiOrocNm" column="AFI_OROC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="adrItrcMemoCtn" column="ADR_ITRC_MEMO_CTN"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="dcPrinYn" column="DC_PRIN_YN"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="oddrAbrvDprtCd2" column="ODDR_ABRV_DPRT_CD2"/>
		<result property="rcpcYmd" column="RCPC_YMD"/>
		<result property="tkmdCatnLablCd" column="TKMD_CATN_LABL_CD"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="prgnYn" column="PRGN_YN"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="bdwgCatnYn" column="BDWG_CATN_YN"/>
		<result property="pwdrDslwYn" column="PWDR_DSLW_YN"/>
		<result property="prchDgprDvsnCd" column="PRCH_DGPR_DVSN_CD"/>
		<result property="oslfAdmnDrugYn" column="OSLF_ADMN_DRUG_YN"/>
		<result property="fvdvCd" column="FVDV_CD"/>
		<result property="cmmdUnsbCtn" column="CMMD_UNSB_CTN"/>
		<result property="othsCmmdUnsbCtn" column="OTHS_CMMD_UNSB_CTN"/>
		<result property="careMpngClsfNm" column="CARE_MPNG_CLSF_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="audtRmrkCtn" column="AUDT_RMRK_CTN"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="ipdvCd" column="IPDV_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="detlCdNm2" column="DETL_CD_NM2"/>
		<result property="edctEtcCtn" column="EDCT_ETC_CTN"/>
		<result property="afiDrbnNoStr" column="AFI_DRBN_NO_STR"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="prmrBrcdScanDt" column="PRMR_BRCD_SCAN_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShet () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShet-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShet"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShet-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShet */
				<![CDATA[
				select  /*+ sdd_pordbat_l88$S01_외래처방전 조회 */
				            to_char(a.ORDR_YMD, 'yyyymmdd')   as ORDR_YMD                                  /* 처방일자     */
				         ,  a.MDTN_LCDV_CD                    as MDTN_LCDV_CD
				         ,  a.MDTN_NO_DVSN_CD                 as MDTN_NO_DVSN_CD /* 투약번호구분 */
				         ,  a.MDTN_NO                         as MDTN_NO          /* 투약번호     */
				         ,  (
				                select  /*+ ordered use_nl(y z)      */
				                        nvl(max(z.MDTN_NO), 0)  MDTN_NO
				                  from
				                        SDPORDBAT y
				                     ,  SDPORDDET z
				                 where  y.ORDR_YMD         = a.ORDR_YMD
				                   and  y.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
				                   and  y.PTNO             = a.PTNO
				                   and  y.MDTN_NO          < a.MDTN_NO
				                   and  y.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
				                   and  y.MCDP_CD          = a.MCDP_CD
				                   and  y.PHDP_OROC_DPRT_CD          = a.PHDP_OROC_DPRT_CD
				                   and  y.GNDR_ID          = a.GNDR_ID
				                   and  y.CMMD_CMBN_CTN is not null
				                   and  y.MDTN_NO >   (
				                                select
				                                        nvl(max(v.MDTN_NO), 0)  MDTN_NO
				                                  from
				                                        SDPORDBAT v
				                                 where  v.ORDR_YMD        = y.ORDR_YMD
				                                   and  v.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
				                                   and  v.PTNO    = y.PTNO
				                                   and  v.MCDP_CD = y.MCDP_CD
				                                   and  v.PHDP_OROC_DPRT_CD = y.PHDP_OROC_DPRT_CD
				                                   and  v.GNDR_ID = y.GNDR_ID
				                                   and  v.DRUG_PRSS_CD > '0'
				                                   and  v.DRUG_INJC_DVSN_CD in ('1', '2')
				                                   and  v.MDTN_NO < a.MDTN_NO
				                                   and  v.RCPC_YN = 'Y'
				                         )
				                   and  z.ORDR_YMD        = y.ORDR_YMD
				                   and  z.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
				                   and  z.MDTN_NO         = y.MDTN_NO
				                   and  z.MDTN_LCDV_CD    = y.MDTN_LCDV_CD
				                   and  instr(#{afiBsisCmmdPlacNm}, z.BSIS_CMMD_PLAC_CD) > 0
				                   and  z.PRIN_DT is not null
				             )       BEMD_NO                                      /* 수정전번호   */
				         ,  a.PTNO                                                /* 환자번호     */
				         ,  d.PTNT_NM                                             /* 환자명       */
				         ,  d.GEND_CD                                             /* 성별         */
				         ,  to_char(d.BTDT,'yyyymmdd') as BTDT                    /* 생년월일        */
				         ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'세'   as AFI_AGE_VL_STR    /* 나이 */
				         ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)    as BDWG_VL      /* 몸무게 */
				         , a.WARD_CD                                                                  as WARD_CD        /* 병동코드 */
				         , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD) as ABRV_DPRT_CD_1 /* 병동코드명 */
				         ,  fn_sd_gethidetelno_s( (select fn_ap_wrap_telno(z.PTNT_TLNO,'')
				                                            from APPTCNPNV z
				                                           where z.PTNO = a.PTNO
				                                             and CNPN_DVSN_CD = 'BH'
				                                             and CNPN_SNO = 1
				                                             and rownum = 1) )   PTNT_TLNO      /* 집전화번호   */
				         ,  fn_sd_gethidetelno_s( (select fn_ap_wrap_telno(z.PTNT_TLNO,'')
				                                            from APPTCNPNV z
				                                           where z.PTNO = a.PTNO
				                                             and CNPN_DVSN_CD = 'BP'
				                                             and CNPN_SNO = 1
				                                             and rownum = 1) )   PTNT_TLNO_1   /* 휴대폰번호   */
				         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
				         ,  (case when substr(d.BRRN,1,1) in ('5','6') then 
				                      ( select decode(DETL_CD_NM,'KR','',DETL_CD_NM)
				                         from CCCMCDDMT where  COMN_GRP_CD = 'CCX_001' and COMN_DTLS_CD = d.NTNL_CD )
				                 else ''
				             end)                                as DETL_CD_NM_1  /* 국적명 */
				         ,  a.MCDP_CD                                             /* 진료과       */
				         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
				         ,  a.ODDR_ID                                             /* 처방의       */
				         ,  e.USER_NM       AFI_ODDR_NM                             /* 처방의명     */
					     , (select '['|| a1.SCIN_CD||'] '||a1.SCIN_NM from MDPADIAGT a1 where a1.MDRP_NO = b.MDRP_NO and a1.MAIN_SCIN_YN = 'Y' and rownum < 2)
					                                                            as SCIN_CLNC_DX_NM     /* 상병 */
					     , (select '['|| a1.SCIN_CD||'] '||a1.SCIN_NM from MDPADIAGT a1 where a1.MDRP_NO = b.MDRP_NO and a1.MAIN_SCIN_YN != 'Y' and rownum < 2)
					                                                            as SUB_SCIN_CLNC_DX_NM     /* 부상병 */       
				         ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
				         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
				         ,  (
				                select
				                        decode(count(x.MDPR_CD), 1, 'Y', 'N')
				                  from
				                        SDPORDDET x
				                 where  x.ORDR_YMD        = a.ORDR_YMD
				                   and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				                   and  x.MDTN_NO         = a.MDTN_NO
				                   and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
				                   and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
				                   and  x.MDPR_CLSF_CD = '3'
				                   and  rownum < 2
				             )     NRDR_YN                                   /* 마약포함여부 */
				         ,  (
				            select
				                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
				              from
				                    SDPORDDET x
				             where  x.ORDR_YMD = a.ORDR_YMD
				               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				               and  x.MDTN_NO = a.MDTN_NO
				               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
				               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
				               and  x.MDPR_CLSF_CD = '2'
				               and  rownum < 2
				            )    PSDG_YN                                     /* 향정포함여부 */
				         ,  (
				            select  /*+ ordered use_nl(x y)     */
				                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
				              from
				                    SDPORDDET x
				                 ,  SDDDGCDMT y
				             where  x.ORDR_YMD = a.ORDR_YMD
				               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				               and  x.MDTN_NO = a.MDTN_NO
				               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
				               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
				               and  x.MDPR_CLSF_CD = '3'
				               and  y.MDPR_CD = x.MDPR_CD
				               and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
				               and  rownum < 2
				             )     CLNC_YN                                     /* 임상포함여부 */
				         ,  a.TKMD_CCHN_YN                                     /* 복약지도여부 */
				         ,  b.ORDR_SNO                                         /* 처방순번     */
				         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
				         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
				         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
				                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
				         ,  b.MDPR_CD                                          /* 약품코드     */
				         ,  f.MDPR_NM                                          /* 약품명       */
				         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
				         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
				         ,  f.ICUN_CD                                          /* 함량단위     */
				         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
				         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
				         ,  b.MDNT                                             /* 횟수         */
				         ,  b.MDTN_DDCN                                        /* 일수         */
				         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
				         ,  b.DRUS_CD                                          /* 용법         */
				         ,  FN_SD_GET_DRUS_CD(b.DRUS_CD,b.BSIS_CMMD_PLAC_CD,b.ORDR_YMD,a.PTNO,b.ORDR_SNO)      AFI_DRUS_CD                                        /* 용법(산제이면 용법+#)         */
				         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN1, g.ENVL_MEMO_CTN3)  as ENVL_MEMO_CTN1
				         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN2, g.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
				         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                                  , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                                  , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                                  , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
				                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
				                                      , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN3
				         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정' )
				                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
				                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포')),
				                                     ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN4
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
				                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
				                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 /* 용법Text3    */
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
				                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
				                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4 /* 용법Text4    */
								 ,  g.TKMD_INFT_DRUS_CTN			TKMD_INFT_DRUS_CTN							/* 복약안내용법내용 */
				         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
				         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
				         ,  replace(replace(b.SPSB_CTN, chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
				         ,  f.KPNG_PLAC_CD                                /* 보관장소     */
				         ,  i.DETL_CD_NM                               /* 보관장소명   */
				         ,  (
				                select
				                       '*'
				                  from
				                        SZPATCMMT x                        /* 환자COMMENT    */
				                 where  x.PTNO = a.PTNO
				                   and  x.EXCF_CD = 'SD'
				                   /* and  x.PTNT_CMNT_SNO >= 20001
				                   and  x.PTNT_CMNT_SNO <= 40000 */
				                   and  x.PTNT_CMNT_DVSN_CD in ('21','C2')
				                   and  x.SPSB_CTN is not null
				                   and  rownum < 2
				             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
				         ,  a.DRUG_INJC_DVSN_CD                                   /* 약주사구분   */
				         ,  (
				            select
				                    count(*)
				              from
				                    SDPORDDET x
				             where  x.ORDR_YMD = a.ORDR_YMD
				               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				               and  x.MDTN_NO = a.MDTN_NO
				               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
				               and  x.MDPR_CLSF_CD = '3'
				               and  x.DRAP_DVSN_CD != '2'
				         )        AFI_NRDR_CCT                                /* 마약개수     */
				         ,  '' AFI_DGST_ITRC_NM  /*연령별 처방 제한*/
				         ,  b.DURV_RESN_CTN
				         ,  decode(b.DC_DVSN_CD, 'Y', '[DC]', 'X', '[취소]', '') 
							|| decode(		
									decode(  (select count(*)
												from (  
												       select 1
												         from MDDCREQMT x  /*간호반납신청*/
												        where x.PTNO     = a.PTNO
												          and x.ORDR_YMD = b.ORDR_YMD
												          and x.ORDR_SNO = b.ORDR_SNO
												          and b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y'
												     )                                   
											), 0 , '' , 'Y')
										,'Y', '[신청]', '')
							|| decode(		
							  	 decode(  (select nvl(sum(case when x.RTRN_DETL_DVSN_CD = 'B' then 1
						                                         else x.RTRN_RQST_CQY
						                                    end ) ,0)   /* 미수령 반납은 강제로 1을 리턴.*/
							  		     	 from SDJDGRTNT x
							  			    where  b.ORDR_YMD = x.ORDR_YMD
							  			      and  b.ORDR_SNO = x.ORDR_SNO
							                  and  b.MDTN_NO = x.MDTN_NO
							  				 /* and  ((x.RTRN_CNFR_YMD is not null) or (x.RTRN_CNFR_YMD is null and x.RTRN_DETL_DVSN_CD = 'B'))*/
							  				  and  b.MDTN_NO_DVSN_CD = x.MDTN_NO_DVSN_CD
							  				  and  b.MDTN_LCDV_CD = x.MDTN_LCDV_CD
						                        and x.RTRN_DETL_DVSN_CD != 'Z'  /* 잔량 반납 제외 */
							  				), 0 , '' , 'Y')
							  			,'Y', '[반납]', '')
							|| FN_SD_GET_RPOR_SMRY_MDPR_NM(b.MDPR_CD) as SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
				         ,  (
				                select
				                        max(to_char(x.ORDR_YMD, 'yyyymmdd')||x.MDTN_NO)
				                  from
				                        SDPORDBAT x
				                 where  x.ORDR_YMD              >= sysdate - 120
				                   and  x.ORDR_YMD              < a.ORDR_YMD
				                   and  x.MDTN_NO_DVSN_CD       = a.MDTN_NO_DVSN_CD
				                   and  x.MDTN_LCDV_CD          = a.MDTN_LCDV_CD
				                   and  x.PTNO                  = a.PTNO
				                   and  x.MCDP_CD               = a.MCDP_CD
				                   and  x.DRUG_PRSS_CD          < '6'
				                   and  x.INJC_PRSS_CD          < '6'
				                   and  x.MIX_INJC_PRSS_CD      < '6'
				                   and  x.OTPT_MIX_INJC_PRSS_CD < '6'
				             )      AFI_MDTN_NO_STR           /* 이전 동일과 처방일 */
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
				         ,  (
				                select
				                        to_char(min(x1.MDCR_YMD), 'yyyymmdd')
				                  from
				                        APRCRPTNT x1
				                 where  x1.PTNO = a.PTNO
				                   and  nvl(x1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
				                   and  x1.MCDP_CD = a.MCDP_CD
				                   and  x1.MDCR_ANDV_CD not in ('7', '8', '9')
				                   and  x1.MDCR_YMD > a.ORDR_YMD
				             )   NEXT_MDCR_YMD
				         ,  b.DRUG_PRIN_YN
				         ,  (
				                select
				                        decode(count(*), 0, 'Y', 'N')
				                  from
				                        SDODGGUIT x2
				                      , APRCRPTNT x3
				                 where  x2.PTNO = a.PTNO
				                   and  x2.PTDV_CD = 'O'
				                   and  x3.MDRP_NO = x2.MDRP_NO
				                   and  x3.MDCR_DT < a.MDCR_YMD
				                   and  x2.TKMD_CCHN_YMD < a.ORDR_YMD
				             )     TKMD_CCFE_YN
				         ,  case
				                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
				                 else f.KORN_PDCT_NM
				             end        KORN_PDCT_NM            /*   한글상품명            */
				         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
				         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
				         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
				         ,  (
				                select
				                        max(x.SUBGRPCODE)
				                  from
				                        SDCMCDDMV x
				                 where  x.COMN_GRP_CD = 'SD156'
				                   and  x.COMN_DTLS_CD = b.MDPR_CD
				             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
				         ,  a.MCCN_CD
				         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=b.INJC_PLAC_CD), b.INJC_PLAC_CD) INJC_PLAC_CD
				         ,  FN_SD_GETAUDFGLIST_S9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD
				                         , #{phdpCmmdBndlNo}, #{afiBsisCmmdPlacNm}, #{drapDvsnCd}
				                               , #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
				         ,  d.FRRN
				         ,  b.DRUS_CD1  /* 처방용법 */
				         ,  decode(b.PRTX_RLTN_RESN_VL, 'T', b.PRTX_RLTN_RESN_CTN, k.DETL_CD_NM)   CLMN_NM_1
				         ,  ''   CLMN_NM_2
				         ,  ''   NEW_YN
				         ,  nvl((select m.MDCR_DTLS_CTRL_NM from MZCTRLMMT m where MDCR_CTRL_CD = 'MM184' and m.MDCR_DTLS_CTRL_CD = a.PHDP_OROC_DPRT_CD),'') AFI_OROC_NM
				         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'')  AFI_CNTR_NM
				         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCDP_CD),'')  ABRV_DPRT_CD
				         , (select 'Y' as ADR_ITRC_MEMO_CTN from SDCADRPAT a1 where a1.PTNO = a.PTNO and rownum = 1) as ADR_ITRC_MEMO_CTN
				         ,  b.DC_DVSN_CD                                        as DC_DVSN_CD
				         ,  b.DC_PRIN_YN                                        as DC_PRIN_YN         
				         , #{inqrDvsnCd}                                        as INQR_DVSN_CD
				         , #{inptClntPrgmId}                                    as INPT_CLNT_PRGM_ID
				         , ( select b1.ABRV_DPRT_CD 
				                from HZDEPTMMT b1 
				                where b1.DPRT_CD = b.OROC_DPRT_CD 
				            )                                            as ODDR_ABRV_DPRT_CD2
				         ,  to_char(b.RCPC_DT,'yyyymmdd')                as RCPC_YMD   
				         ,  b.TKMD_CATN_LABL_CD                          as TKMD_CATN_LABL_CD 
				         ,  b.FDNO_YN                                    as FDNO_YN
				         ,  b.SDPF_EXRE_CD                               as SDPF_EXRE_CD
					     , (select case when count(1) > 0 then 'Y' else 'N' end 
					          from MEPTNTCLT z
						     where z.PTNO = a.PTNO
						       and z.PTNT_CTRL_CD = '001'
						       and z.PTNT_CTRL_CHRC_VL1 = 'Y'
		                       and (   (    z.PTNT_CTRL_CHRC_VL2 is not null    /* 분만예정일이 있으면 분만예정일까지 */
		                                and a.ORDR_YMD <= to_date(z.PTNT_CTRL_CHRC_VL2,'yyyymmdd'))
		                            or (    z.PTNT_CTRL_CHRC_VL2 is null        /* 분만예정일이 없으면 등록일에서 12개월 */
		                                and a.ORDR_YMD between trunc(z.LAST_UPDT_DT) and add_months(trunc(z.LAST_UPDT_DT),12))
		                           )
		                    )	AS PRGN_YN  /* 임신여부 */ 
						 ,  a.GNDR_ID
						 ,  e3.USER_NM   as GNDR_NM
				         ,  b.BDWG_CATN_YN                                  /* 몸무게주의여부 */
				         ,  f.PWDR_DSLW_YN                                  /* 산제불가여부 */         
						 ,  b.PRCH_DGPR_DVSN_CD    
						 ,  b.OSLF_ADMN_DRUG_YN
						 , (select FVDV_CD 
							  from  APRCRPTNT x2  -- 진료접수
							 where  x2.PTNO     = a.PTNO
							   and  x2.CODV_CD  = a.MDTN_NO_DVSN_CD
							   and  x2.MDCR_YMD = a.ORDR_YMD
							   and  x2.MDRP_NO  = b.MDRP_NO) as FVDV_CD    /*초재진구분 */
					     ,  b.CMMD_UNSB_CTN
					     ,  b.OTHS_CMMD_UNSB_CTN		   
						 , '' as CARE_MPNG_CLSF_NM   
				         , (select PTRM_NO from APRCRPTNT x where x.MDRP_NO = b.MDRP_NO) as PTRM_NO           
						 , '' as AUDT_RMRK_CTN
				          , b.CMMD_STTS_CD
				          , b.IPDV_CD
				     ,  a.PHDP_OROC_DPRT_CD      as PHDP_OROC_DPRT_CD
				     ,  (SELECT DETL_CD_NM FROM CCCMCDDMT WHERE COMN_GRP_CD = 'SD184' and COMN_DTLS_CD = a.PHDP_OROC_DPRT_CD) as DETL_CD_NM2 /* OROC_CD 작업완료 */ /* 처방발생원이름 */       
				     ,  (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD)||'-'||
						                decode(nvl(decode(a.MDTN_NO_DVSN_CD, 'I', a.ASNU_TIUS_PTNT_SUB_LCTN_CD, 'G', a.ASNU_TIUS_PTNT_SUB_LCTN_CD, a.PTRM_NO),'*')
		                                    , '*'
		                                    , decode(a.MDTN_NO_DVSN_CD, 'I', a.SCKB_NO_VL, 'G', a.SCKB_NO_VL, a.SCKB_NO)   
		                                    , decode(a.MDTN_NO_DVSN_CD, 'I', a.ASNU_TIUS_PTNT_SUB_LCTN_CD, 'G', a.ASNU_TIUS_PTNT_SUB_LCTN_CD, a.PTRM_NO)
		                                      || decode( nvl(decode(a.MDTN_NO_DVSN_CD, 'I', a.SCKB_NO_VL, 'G', a.SCKB_NO_VL, a.SCKB_NO),'*')
		                                               , '*'
		                                               , ''
		                                               , '-'||decode(a.MDTN_NO_DVSN_CD, 'I', a.SCKB_NO_VL, 'G', a.SCKB_NO_VL, a.SCKB_NO)
		                                                )
		                ) as EDCT_ETC_CTN  /* 병동-병실-병상 */           
				     ,  case when (b.DRBN_NO = null) or (b.DRBN_NO = 0)                  
				             then '' else '*' end ||b.PHDP_CMMD_BNDL_NO as AFI_DRBN_NO_STR       /*  약제부 조제묶음번호(의사가 지정하는 묶음 번호표시)  */
				     ,  to_char(b.PRIN_DT,'yyyymmddHH24MISS') as PRIN_DT
					 ,  to_char(b.PRMR_BRCD_SCAN_DT,'yyyymmddHH24MISS') as PRMR_BRCD_SCAN_DT  
				     from
				            SDPORDBAT a                               /* 약처방내역기본 */
				         ,  (
				            select
				                    b.ORDR_YMD
				                 ,  b.MDTN_NO_DVSN_CD
				                 ,  b.MDTN_NO
				                 ,  b.ORDR_SNO
				                 ,  b.PTDV_CD
				                 ,  b.MDPR_CD
				                 ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,d.MDPR_NM)      as MDPR_NM  
				                 ,  b.MDPR_CLSF_CD
				                 ,  b.DRAP_DVSN_CD
				                 ,  b.CMMD_STTS_CD
				                 ,  b.PCKN_UNAD_QTY
				                 ,  b.PCUN_NM
				                 ,  b.ICUN_ADMN_VLM
				                 ,  b.ICUN_CD
				                 ,  b.SLCT_UNIT_DVSN_CD
				                 ,  b.MDTN_DDCN
				                 ,  b.DRUS_CD
				                 ,  b.MDNT
				                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
				                 ,  b.INVN_TOTL_QTY
				                 ,  b.DRBN_NO
				                 ,  b.PHDP_CMMD_BNDL_NO
				                 ,  b.MIX_KIND_CD
				                 ,  b.BSIS_CMMD_PLAC_CD
				                 ,  b.SPSB_CTN
				                 ,  b.FDNO_MDPR_CNFR_DT
				                 ,  b.ISDV_CD
				                 ,  b.DRUG_ORDR_INPT_DT
				                 ,  b.SDPF_EXRE_CD
				                 ,  b.PRIN_DT
				                 ,  b.PRMR_BRCD_SCAN_DT
				                 ,  b.CMMD_FINS_DT
				                 ,  b.MDTN_DT
				                 ,  b.MDTN_STRT_YMD
				                 ,  b.INJC_PLAC_CD
				                 ,  b.OHOR_RTRN_YN
				                 ,  b.BEMD_NO
				                 ,  b.ATTR_NO
				                 ,  case
				                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
				                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
				                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
				                     end      DURV_RESN_CTN
				                 ,  b.RCPC_YN
				                 ,  b.RCPC_DT
				                 ,  b.WARD_LABL_PRIN_YN
				                 ,  b.LAST_UPDR_ID
				                 ,  b.LAST_UPDT_IP
				                 ,  b.LAST_UPDT_DT
				                 ,  b.PHRM_IMPL_YMD
				                 ,  b.CUNT_TRNM_MDPR_COT
				                 ,  a.DRUG_PRIN_YN
				                 ,  a.MDTN_LCDV_CD
				                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
				                 ,  h.PRTX_RLTN_RESN_VL
				                 ,  h.PRTX_RLTN_RESN_CTN
				                 ,  h.MDRP_NO
				                 ,  h.DC_DVSN_CD
				                 ,  b.DC_PRIN_YN 
				                 ,  h.OROC_DPRT_CD 		as OROC_DPRT_CD
				                 ,  d.TKMD_CATN_LABL_CD
								 , decode((select '1'
				                               from SDJFIXQTT x
				                               where x.DPRT_CD = b.INJC_PLAC_CD
				                                  and x.MDPR_CD = b.MDPR_CD
				                                  and rownum =1
				                             ), '1', 'Y', 'N') as FDNO_YN
				                 , (select  case when count(1) = 1 then 'Y' else 'N' end
										 from  SDMCTRLMT
										where  PHRM_CTRL_CD = 'SDB_037'
										  and  PHRM_DTLS_CTRL_CD = b.MDPR_CD)  as BDWG_CATN_YN          
								 ,  d.PRCH_DGPR_DVSN_CD		          
						         ,  b.OSLF_ADMN_DRUG_YN
								 ,  d.CMMD_UNSB_CTN
					             ,  d.OTHS_CMMD_UNSB_CTN	 
					             , ( select nvl((select decode(aa.COMN_DTLS_CD,'7','3','A','Z',aa.COMN_DTLS_CD) 
						                                   from CCCMCDDMT aa
						                                  where 1=1
						                                    and aa.COMN_GRP_CD  = 'AI041'
						                                    and aa.COMN_DTLS_CD  = h.ORDR_IPDV_CD /* 처방상급여정보 */
						                                    and rownum = 1)
						                                 /* 처방상에 보헙급여코드가 없으면 수가마스터정보상의 급여정보를 보여줌 */
						                                 , F_A.COMN_DTLS_CD
						                               )		                    
						                      from CCCMCDDMT F_A,
						                           CCCMCDDLT F_B
						                     where  F_A.COMN_GRP_CD  = F_B.COMN_GRP_CD(+)
						                       and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
						                       and F_A.COMN_GRP_CD  = 'AI041'
						                       and F_A.COMN_DTLS_CD =  decode(substr(h.ISTY_CD, 1, 1), '2', i.PRTC_IPDV_CD,
						                                                                               '4', i.INCS_IPDV_CD,
						                                                                               '5', i.TAIN_IPDV_CD,
						                                                                                    i.INSR_IPDV_CD)
						                       and F_B.LNGG_CD(+) = nvl('', '*'))  as IPDV_CD        
				                 ,  b.RCPC_PNTM_CMMD_STTS_MDFC_YN
		                         ,  (select min(z.COMN_ITEM_CHRC_VL)
		                               from SDPORDOST x
		                                  , CCCMCDDMT y
		                                  , CCCMCDIDT z
		                              where x.ORDR_YMD = b.ORDR_YMD
		                                and x.MDTN_LCDV_CD = b.MDTN_LCDV_CD
		                                and x.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
		                                and x.MDTN_NO = b.MDTN_NO
		                                and x.ORDR_SNO = b.ORDR_SNO
		                                and y.COMN_GRP_CD = 'SDB_015'
		                                and y.COMN_DTLS_CD = x.DRUS_CD
		                                and x.ORDR_YMD between y.APST_YMD and y.APFN_YMD
		                                and z.COMN_GRP_CD = y.COMN_GRP_CD
		                                and z.COMN_DTLS_CD = y.COMN_DTLS_CD
		                                and z.COMN_ITEM_CD = 'SUBGRPCODE')               as GRP_DRUS_CD  /* 라벨이 출력되는 용법 그룹 */
				              from
				                    SDPORDBAT a
				                 ,  SDPORDDET b
				                 ,  MDMEDORDT h
				                 ,  SDDDGCDMT d
				                 ,  AIMFMDFET i
				             where  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
				               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
				               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD
				                                             , 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd})  /* 투약위치 */
				               and  b.MDPR_CD           = d.MDPR_CD
				               and  b.ORDR_YMD          = a.ORDR_YMD
				               and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
				               and  b.MDTN_NO           = a.MDTN_NO
				               and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
				               and  instr(#{afiBsisCmmdPlacNm}, b.BSIS_CMMD_PLAC_CD) > 0
				               and  b.MDTN_NO = case when nvl(#{mdtnNo}, 0) = 0 then b.MDTN_NO else #{mdtnNo} end
				               and  b.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then b.PHDP_CMMD_BNDL_NO else #{phdpCmmdBndlNo} end
				               and  b.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */               
				               and  (  
				                      ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6')              )  or
				                      ( b.BSIS_CMMD_PLAC_CD  = 'A' and b.DRAP_DVSN_CD               != '2' )  or /* 마약은 주사 제외 */
				                      ( b.BSIS_CMMD_PLAC_CD  = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
				                    )
		                       and (
						              (b.MDTN_NO_DVSN_CD = 'O' and b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y') or
						              (b.MDTN_NO_DVSN_CD <> 'O')
						           )
				               /*--------------------------------------------------------------------------------------------------------------*/
				               and (
				                     ( nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1') or 
				                     ( nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'      and /* 주사는 자가주사만 나오도록 */
				                       ( a.DRUG_PRIN_YN = 'P' or a.OSI_PRIN_YN = 'P' )       and /* 수납여부 : 병동퇴원,외출,외박, DSC 퇴원, 응급실퇴원(업무시간내,외) 제외 모두 수납이 된 것만 */
				                       (
				                         ( b.MDTN_NO_DVSN_CD not in ('D', 'F', 'P', 'Q', 'S', 'T', 'G', 'H', 'I') and nvl(b.RCPC_YN, 'N') in ('Y', 'W') ) or
				                         ( b.MDTN_NO_DVSN_CD     in ('D', 'F', 'P', 'Q', 'S', 'T', 'G', 'H','I')                                       )
				                       )
				                     )
				                   )
				               /*--------------------------------------------------------------------------------------------------------------*/
				               /* and  nvl(b.DRUS_CD, 'X') != 'SAVE' */ /* SAVE 단독처방 제외 외래/퇴원 처방전에는 나오도록 */
				               /* 조제정보 생성 전 반납*/
				               and nvl((select /*+ index ( a1 mdmedordt_pk )
				                                   index ( b1 sdjdgrtnt_pk ) */
				                               'Y'
				                          from
				                               MDMEDORDT a1,
				                               SDJDGRTNT b1
				                         where
				                               a1.PTNO     = b.PTNO
				                           and a1.ORDR_YMD = b.ORDR_YMD
				                           and a1.ORDR_SNO = b.ORDR_SNO
				                           and a1.DRUG_ORDR_PRSS_CD <> '0'
				                           and (nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
				                           and a1.ORDR_YMD = b1.ORDR_YMD
				                           and a1.PTNO = b1.PTNO
				                           and a1.ORDR_SNO = b1.ORDR_SNO
				                           and b1.DRUG_RTRE_CD = '7'
				                           and rownum = 1
				                      ), 'N') <> 'Y'
				               /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
				               and ( ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
				                       not exists ( select  'Y'
				                                      from  SDJDGRTNT s
				                                     where  s.ORDR_YMD        = b.ORDR_YMD
				                                       and  s.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
				                                       and  s.MDTN_NO         = b.MDTN_NO
				                                       and  s.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
				                                       and  s.ORDR_SNO        = b.ORDR_SNO
				                                       and  s.MDPR_CD         = b.MDPR_CD
				                                       and  nvl(s.MDPR_RTRN_NTM, -1) != 0
				                                       and  b.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
				                                                                  from  SDJDGRTNT t
				                                                                 where  s.ORDR_YMD         = t.ORDR_YMD
				                                                                   and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
				                                                                   and  s.MDTN_NO          = t.MDTN_NO
				                                                                   and  s.ORDR_SNO         = t.ORDR_SNO
				                                                                   and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
				                                                                   and  s.MDPR_CD          = t.MDPR_CD
				                                                                   and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
				                                                                   and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
				                                  )
				                     )
				                   )
				               and  h.PTNO = a.PTNO
				               and  h.ORDR_YMD = a.ORDR_YMD
				               and  h.ORDR_SNO = b.ORDR_SNO
				               and  i.MDFE_CD  (+)  = b.MDPR_CD
								       and  i.APST_YMD (+) <= b.ORDR_YMD
								       and  i.APFN_YMD (+) >= b.ORDR_YMD
				            )  b                                             /* 약처방내역상세 */
				         ,  APPTPTNTV d                               /* 환자마스터     */
				         ,  CCUSRDPHT e                               /* 사용자마스터   */
				         ,  CCUSERAMT e2
				         ,  CCUSRDPHT e3                              /* 사용자마스터   */
				         ,  SDDDGCDMT f                               /* 처방코드마스터 */
				         ,  SDDMETCDT g                               /* 용법코드마스터 */
				         ,  HZDEPTMMT h                               /* 부서코드마스터 */
				         ,  SDCMCDDMV i                               /* 공통코드마스터 */
				         ,  SDCMCDDMV k                               /* 공통코드마스터 */
				     where  a.ORDR_YMD        = to_date(#{ordrYmd}, 'YYYYMMDD')
				       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
				       and  a.MDTN_NO         = case when nvl(#{mdtnNo}, 0) = 0 then b.MDTN_NO else #{mdtnNo} end
				       and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
				       and  b.ORDR_YMD        = a.ORDR_YMD
				       and  b.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				       and  b.MDTN_NO         = a.MDTN_NO
				       and  b.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
				       and  d.PTNO            = a.PTNO
				       and  e.USER_ID(+)      = a.ODDR_ID
				       and  e3.USER_ID(+)     = a.GNDR_ID
				       and  e2.LGIN_ID(+)     = e.LGIN_ID
				       and  f.MDPR_CD         = b.MDPR_CD
				       /* 출고여부 nvl(f.RELS_YN, 'N') = 'Y'
				       SDC703F1 전체                                출고여부체크 X
				       SDG205F1 병동MIX                             출고여부체크 X
				       SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
				       SDG101F1 MIX                                 출고여부체크 X
				       */       
				       and  g.DRUS_CD         = b.DRUS_CD
				       and  h.DPRT_CD         = a.MCDP_CD
				       and  i.COMN_GRP_CD     = 'SD003'
				       and  i.COMN_DTLS_CD    = nvl(f.KPNG_PLAC_CD, '9')
				       and  k.COMN_GRP_CD(+)  = 'MM079'
				       and  k.COMN_DTLS_CD(+) = b.PRTX_RLTN_RESN_VL
				     order
				        by
				            a.ORDR_YMD
				         ,  a.MDTN_LCDV_CD
				         ,  a.MDTN_NO_DVSN_CD
				         ,  a.MDTN_NO
				         ,  decode(b.BSIS_CMMD_PLAC_CD,'1','1','3','2','2','3','5','4','4','5','A','6','7','7')
		                 ,  b.MDTN_DDCN
				         ,  nvl(b.GRP_DRUS_CD, b.DRUS_CD)
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MDPR_CD
				]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLabl-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="afiNrdrCct" column="AFI_NRDR_CCT"/>
		<result property="afiDgstItrcNm" column="AFI_DGST_ITRC_NM"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="nextMdcrYmd" column="NEXT_MDCR_YMD"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="tkmdCcfeYn" column="TKMD_CCFE_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="newYn" column="NEW_YN"/>
		<result property="afiOrocNm" column="AFI_OROC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="dtlsPntmCd" column="DTLS_PNTM_CD"/>
		<result property="mrnnTkngYn" column="MRNN_TKNG_YN"/>
		<result property="lnchTkngYn" column="LNCH_TKNG_YN"/>
		<result property="evnnTkngYn" column="EVNN_TKNG_YN"/>
		<result property="sbDrusHs" column="SB_DRUS_HS"/>
		<result property="dietInvlCd" column="DIET_INVL_CD"/>
		<result property="dietInvlNm" column="DIET_INVL_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLabl () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLabl-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLabl"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLabl-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLabl */
		  <![CDATA[
		  select  /*+ sdd_pordbat_l88$S01_외래처방전 조회 */
		              to_char(a.ORDR_YMD, 'yyyymmdd')     as ORDR_YMD        /* 처방일자     */
		           ,  a.MDTN_LCDV_CD                      as MDTN_LCDV_CD
		           ,  a.MDTN_NO_DVSN_CD                   as MDTN_NO_DVSN_CD /* 투약번호구분 */
		           ,  a.MDTN_NO                           as MDTN_NO         /* 투약번호     */
		           ,  (
		                  select  /*+ ordered use_nl(y z)      */
		                          nvl(max(z.MDTN_NO), 0)  MDTN_NO
		                    from
		                          SDPORDBAT y
		                       ,  SDPORDDET z
		                   where  y.ORDR_YMD         = a.ORDR_YMD
		                     and  y.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		                     and  y.PTNO             = a.PTNO
		                     and  y.MDTN_NO          < a.MDTN_NO
		                     and  y.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		                     and  y.MCDP_CD          = a.MCDP_CD
		                     and  y.PHDP_OROC_DPRT_CD          = a.PHDP_OROC_DPRT_CD
		                     and  y.GNDR_ID          = a.GNDR_ID
		                     and  y.CMMD_CMBN_CTN is not null
		                     and  y.MDTN_NO >   (
		                                  select
		                                          nvl(max(v.MDTN_NO), 0)  MDTN_NO
		                                    from
		                                          SDPORDBAT v
		                                   where  v.ORDR_YMD        = y.ORDR_YMD
		                                     and  v.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                                     and  v.PTNO    = y.PTNO
		                                     and  v.MCDP_CD = y.MCDP_CD
		                                     and  v.PHDP_OROC_DPRT_CD = y.PHDP_OROC_DPRT_CD
		                                     and  v.GNDR_ID = y.GNDR_ID
		                                     and  v.DRUG_PRSS_CD > '0'
		                                     and  v.DRUG_INJC_DVSN_CD in ('1', '2')
		                                     and  v.MDTN_NO < a.MDTN_NO
		                                     and  v.RCPC_YN = 'Y'
		                           )
		                     and  z.ORDR_YMD        = y.ORDR_YMD
		                     and  z.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                     and  z.MDTN_NO         = y.MDTN_NO
		                     and  z.MDTN_LCDV_CD    = y.MDTN_LCDV_CD
		                     and  instr(#{afiBsisCmmdPlacNm}, z.BSIS_CMMD_PLAC_CD) > 0
		                     and  z.PRIN_DT is not null
		               )       BEMD_NO                                      /* 수정전번호   */
		           ,  a.PTNO                                                /* 환자번호     */
		           ,  d.PTNT_NM                                             /* 환자명       */
		           ,  d.GEND_CD                                             /* 성별         */
		           ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'-'||trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12)) as AFI_AGE_VL_STR /* 나이 */
		           ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)                                                                 as BDWG_VL        /* 몸무게 */
		           , a.WARD_CD                                                                  as WARD_CD        /* 병동코드 */
		           , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD) as ABRV_DPRT_CD_1 /* 병동코드명 */
		           ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		           ,  a.MCDP_CD                                             /* 진료과       */
		           ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		           ,  a.ODDR_ID                                             /* 처방의       */
		           ,  e.USER_NM       AFI_ODDR_NM                             /* 처방의명     */
		           ,  (
		                  select
		                          x.SCIN_CD||'('||x.SCIN_NM||')'
		                    from
		                          MDPADIAGT x
		                   where  x.MDRP_NO = b.MDRP_NO
		                     and  (
		                               (a.MDTN_NO_DVSN_CD = 'G')
		                         /*   or
		                               (a.MDTN_NO_DVSN_CD = 'T') */
		                            or
		                               (a.MDTN_NO_DVSN_CD in ('O', 'Z') and  x.MCDP_CD = a.MCDP_CD)
		                          )
		                     and  x.MAIN_SCIN_YN = 'Y'
		                     and  a.GNDR_ID  = decode( sign( a.MDCR_YMD - to_date( #{baseYmd}, 'yyyymmdd'))
		                                                              , -1 , a.GNDR_ID
		                                                                    , decode( a.PTDV_CD, 'O', x.CHDR_ID , a.GNDR_ID)
		                                              )           /* MultiMainDiag  */
		                     and  rownum < 2
		               )      SCIN_NM                                /* 상병명       */
		           ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		           ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		           ,  (
		                  select
		                          decode(count(x.MDPR_CD), 1, 'Y', 'N')
		                    from
		                          SDPORDDET x
		                   where  x.ORDR_YMD        = a.ORDR_YMD
		                     and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                     and  x.MDTN_NO         = a.MDTN_NO
		                     and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                     and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		                     and  x.MDPR_CLSF_CD = '3'
		                     and  rownum < 2
		               )     NRDR_YN                                   /* 마약포함여부 */
		           ,  (
		              select
		                      decode(count(x.MDPR_CD), 1, 'Y', 'N')
		                from
		                      SDPORDDET x
		               where  x.ORDR_YMD = a.ORDR_YMD
		                 and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                 and  x.MDTN_NO = a.MDTN_NO
		                 and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		                 and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		                 and  x.MDPR_CLSF_CD = '2'
		                 and  rownum < 2
		              )    PSDG_YN                                     /* 향정포함여부 */
		           ,  (
		              select  /*+ ordered use_nl(x y)     */
		                      decode(count(x.MDPR_CD), 1, 'Y', 'N')
		                from
		                      SDPORDDET x
		                   ,  SDDDGCDMT y
		               where  x.ORDR_YMD = a.ORDR_YMD
		                 and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                 and  x.MDTN_NO = a.MDTN_NO
		                 and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		                 and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		                 and  x.MDPR_CLSF_CD = '3'
		                 and  y.MDPR_CD = x.MDPR_CD
		                 and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		                 and  rownum < 2
		               )     CLNC_YN                                     /* 임상포함여부 */
		           ,  a.TKMD_CCHN_YN                                     /* 복약지도여부 */
		           ,  b.ORDR_SNO                                         /* 처방순번     */
		           ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		           ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		           ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		           ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                        , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		           ,  b.MDPR_CD                                          /* 약품코드     */
		           ,  f.MDPR_NM                                          /* 약품명       */
		           ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		           ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		           ,  f.ICUN_CD                                          /* 함량단위     */
		           ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		           ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		           ,  b.MDNT                                             /* 횟수         */
		           ,  b.MDTN_DDCN                                        /* 일수         */
		           ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
		           ,  b.DRUS_CD                                          /* 용법         */
		           ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN1, g.ENVL_MEMO_CTN3)  as ENVL_MEMO_CTN1
		           ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN2, g.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
		           ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		                                                , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		                                        , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN3    /* 용법Text1 */
		           ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정' )
		                                                                                      , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                                , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포')),
		                                       ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN4   /* 용법Text2 */
		           ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		                                        , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                        , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 /* 용법Text3    */
		           ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		                                        , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                        , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4 /* 용법Text4    */
		           ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		           ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		           ,  replace(replace(b.SPSB_CTN, chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		           ,  f.KPNG_PLAC_CD                                /* 보관장소     */
		           ,  i.DETL_CD_NM                               /* 보관장소명   */
		           ,  (
		                  select
		                         '*'
		                    from
		                          SZPATCMMT x                        /* 환자COMMENT    */
		                   where  x.PTNO = a.PTNO
		                     and  x.EXCF_CD = 'SD'
		                     /* and  x.PTNT_CMNT_SNO >= 20001
		                     and  x.PTNT_CMNT_SNO <= 40000 */
		                     and  x.PTNT_CMNT_DVSN_CD in ('21','C2')
		                     and  x.SPSB_CTN is not null
		                     and  rownum < 2
		               )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		           ,  a.DRUG_INJC_DVSN_CD                                   /* 약주사구분   */
		           ,  (
		              select
		                      count(*)
		                from
		                      SDPORDDET x
		               where  x.ORDR_YMD = a.ORDR_YMD
		                 and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                 and  x.MDTN_NO = a.MDTN_NO
		                 and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		                 and  x.MDPR_CLSF_CD = '3'
		                 and  x.DRAP_DVSN_CD != '2'
		           )        AFI_NRDR_CCT                                /* 마약개수     */
		           ,  '' AFI_DGST_ITRC_NM  /*연령별 처방 제한*/
		           ,  b.DURV_RESN_CTN
		           ,  f.SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		           ,  f.KORN_PDCT_NM                                       as KORN_PDCT_NM        /* 한글상품명 */
		           ,  (
		                  select
		                          max(to_char(x.ORDR_YMD, 'yyyymmdd')||x.MDTN_NO)
		                    from
		                          SDPORDBAT x
		                   where  x.ORDR_YMD              >= sysdate - 120
		                     and  x.ORDR_YMD              < a.ORDR_YMD
		                     and  x.MDTN_NO_DVSN_CD       = a.MDTN_NO_DVSN_CD
		                     and  x.MDTN_LCDV_CD          = a.MDTN_LCDV_CD
		                     and  x.PTNO                  = a.PTNO
		                     and  x.MCDP_CD               = a.MCDP_CD
		                     and  x.DRUG_PRSS_CD          < '6'
		                     and  x.INJC_PRSS_CD          < '6'
		                     and  x.MIX_INJC_PRSS_CD      < '6'
		                     and  x.OTPT_MIX_INJC_PRSS_CD < '6'
		               )      AFI_MDTN_NO_STR           /* 이전 동일과 처방일 */
		           ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		           ,  (
		                  select
		                          to_char(min(x1.MDCR_YMD), 'yyyymmdd')
		                    from
		                          APRCRPTNT x1
		                   where  x1.PTNO = a.PTNO
		                     and  nvl(x1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                     and  x1.MCDP_CD = a.MCDP_CD
		                     and  x1.MDCR_ANDV_CD not in ('7', '8', '9')
		                     and  x1.MDCR_YMD > a.ORDR_YMD
		               )   NEXT_MDCR_YMD
		           ,  b.DRUG_PRIN_YN
		           ,  (
		                  select
		                          decode(count(*), 0, 'Y', 'N')
		                    from
		                          SDODGGUIT x2
		                        , APRCRPTNT x3
		                   where  x2.PTNO = a.PTNO
		                     and  x2.PTDV_CD = 'O'
		                     and  x3.MDRP_NO = x2.MDRP_NO
		                     and  x3.MDCR_DT < a.MDCR_YMD
		                     and  x2.TKMD_CCHN_YMD < a.ORDR_YMD
		               )     TKMD_CCFE_YN
		           ,  case
		                   when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                   else f.KORN_PDCT_NM
		               end        KORN_PDCT_NM            /*   한글상품명            */
		           ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		           ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		           ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		           ,  (
		                  select
		                          max(x.SUBGRPCODE)
		                    from
		                          SDCMCDDMV x
		                   where  x.COMN_GRP_CD = 'SD156'
		                     and  x.COMN_DTLS_CD = b.MDPR_CD
		               )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		           ,  a.MCCN_CD
		           ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=b.INJC_PLAC_CD), b.INJC_PLAC_CD) INJC_PLAC_CD
		           ,  fn_sd_getaudfglist_s9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD
		                           , #{phdpCmmdBndlNo}, #{afiBsisCmmdPlacNm}, #{drapDvsnCd}
		                                 , #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		           ,  d.FRRN
		           ,  b.DRUS_CD1  /* 처방용법 */
		           ,  decode(b.PRTX_RLTN_RESN_VL, 'T', b.PRTX_RLTN_RESN_CTN, k.DETL_CD_NM)   CLMN_NM_1
		           ,  ''   CLMN_NM_2
		           ,  ''   NEW_YN
		           ,  nvl((select m.MDCR_DTLS_CTRL_NM from MZCTRLMMT m where MDCR_CTRL_CD = 'MM184' and m.MDCR_DTLS_CTRL_CD = a.PHDP_OROC_DPRT_CD),'') afi_oroc_nm
		           ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'')  afi_cntr_nm
		           ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCDP_CD),'')  abrv_dprt_cd
				   ,  g.DTLS_PNTM_CD    as DTLS_PNTM_CD /* 기타 용법 코드 */
				   ,  g.MRNN_TKNG_YN as MRNN_TKNG_YN              /* 아침 YN */ 
				   ,  g.LNCH_TKNG_YN as LNCH_TKNG_YN              /* 점심 YN */
				   ,  g.EVNN_TKNG_YN as EVNN_TKNG_YN              /* 저녁 YN */
				   ,  substr(g.SB_DRUS_CD,19,1) as SB_DRUS_HS    /* SUb용법 HS YN */
		           ,  g.DIET_INVL_CD    as DIET_INVL_CD           /* 식사간격코드 */
		 		   ,  ( select DETL_CD_NM 
		                            from CCCMCDDMT 
		                            where g.DIET_INVL_CD = COMN_DTLS_CD
		                              and COMN_GRP_CD = 'SD131' )      as DIET_INVL_NM           /* 식사간격명 */ 
		        from
		              SDPORDBAT a                               /* 약처방내역기본 */
		           ,  (
		              select
		                      b.ORDR_YMD
		                   ,  b.MDTN_NO_DVSN_CD
		                   ,  b.MDTN_NO
		                   ,  b.ORDR_SNO
		                   ,  b.PTDV_CD
		                   ,  b.MDPR_CD
		                   ,  b.MDPR_CLSF_CD
		                   ,  b.DRAP_DVSN_CD
		                   ,  b.CMMD_STTS_CD
		                   ,  b.PCKN_UNAD_QTY
		                   ,  b.PCUN_NM
		                   ,  b.ICUN_ADMN_VLM
		                   ,  b.ICUN_CD
		                   ,  b.SLCT_UNIT_DVSN_CD
		                   ,  b.MDTN_DDCN
		                   ,  b.DRUS_CD
		                   ,  b.MDNT
		                   ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                   ,  b.INVN_TOTL_QTY
		                   ,  b.DRBN_NO
		                   ,  b.PHDP_CMMD_BNDL_NO
		                   ,  b.MIX_KIND_CD
		                   ,  b.BSIS_CMMD_PLAC_CD
		                   ,  b.SPSB_CTN
		                   ,  b.FDNO_MDPR_CNFR_DT
		                   ,  b.ISDV_CD
		                   ,  b.DRUG_ORDR_INPT_DT
		                   ,  b.SDPF_EXRE_CD
		                   ,  b.PRIN_DT
		                   ,  b.PRMR_BRCD_SCAN_DT
		                   ,  b.CMMD_FINS_DT
		                   ,  b.MDTN_DT
		                   ,  b.MDTN_STRT_YMD
		                   ,  b.INJC_PLAC_CD
		                   ,  b.OHOR_RTRN_YN
		                   ,  b.BEMD_NO
		                   ,  b.ATTR_NO
		                   ,  case
		                           when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                           when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                           when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                       end      DURV_RESN_CTN
		                   ,  b.RCPC_YN
		                   ,  b.RCPC_DT
		                   ,  b.WARD_LABL_PRIN_YN
		                   ,  b.LAST_UPDR_ID
		                   ,  b.LAST_UPDT_IP
		                   ,  b.LAST_UPDT_DT
		                   ,  b.PHRM_IMPL_YMD
		                   ,  b.CUNT_TRNM_MDPR_COT
		                   ,  a.DRUG_PRIN_YN
		                   ,  a.MDTN_LCDV_CD
		                   ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                   ,  h.PRTX_RLTN_RESN_VL
		                   ,  h.PRTX_RLTN_RESN_CTN
		                   ,  h.MDRP_NO
		                from
		                      SDPORDBAT a
		                   ,  SDPORDDET b
		                   ,  MDMEDORDT h
		               where  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		                 and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		                 and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD
		                                               , 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd})  /* 투약위치 */
		                 /* and  b.BSIS_CMMD_PLAC_CD != '3' */ /* ATC 인 경우만 - 2018.11.05 신혜아선생님 요청 : ATC도 라벨 출력 되어야 함 */
		                 and  b.ORDR_YMD           = a.ORDR_YMD
		                 and  b.MDTN_NO_DVSN_CD    = a.MDTN_NO_DVSN_CD
		                 and  b.MDTN_NO            = a.MDTN_NO
		                 and  b.MDTN_LCDV_CD       = a.MDTN_LCDV_CD
		                 and  instr(#{afiBsisCmmdPlacNm}, b.BSIS_CMMD_PLAC_CD) > 0
		                 and  b.MDTN_NO = case when nvl(#{mdtnNo}, 0) = 0 then b.MDTN_NO else #{mdtnNo} end
		                 and  b.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then b.PHDP_CMMD_BNDL_NO else #{phdpCmmdBndlNo} end
		                 and  b.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
		                 and  (
		                        ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6')              )  or
		                        ( b.BSIS_CMMD_PLAC_CD  = 'A' and b.DRAP_DVSN_CD               != '2' )  or /* 마약은 주사 제외 */
		                        ( b.BSIS_CMMD_PLAC_CD  = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                      )
		                 /*--------------------------------------------------------------------------------------------------------------*/
		                 and (
		                       ( nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1') or 
		                       ( nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'      and /* 주사는 자가주사만 나오도록 */
		                         ( a.DRUG_PRIN_YN = 'P' or a.OSI_PRIN_YN = 'P' )       and /* 수납여부 : 병동퇴원,외출,외박, DSC 퇴원, 응급실퇴원(업무시간내,외) 제외 모두 수납이 된 것만 */
		                         (
		                           ( b.MDTN_NO_DVSN_CD not in ('D', 'F', 'P', 'Q', 'T', 'G', 'H') and nvl(b.RCPC_YN, 'N') in ('Y', 'W') ) or
		                           ( b.MDTN_NO_DVSN_CD     in ('D', 'F', 'P', 'Q', 'T', 'G', 'H')                                       )
		                         )
		                       )
		                     )
		                 /*--------------------------------------------------------------------------------------------------------------*/	                 
		                 and  nvl(b.DRUS_CD, 'X') != 'SAVE' /* SAVE 단독처방 제외 */
		                 /* 조제정보 생성 전 반납*/
		                 and nvl((select /*+ index ( a1 mdmedordt_pk )
		                                     index ( b1 sdjdgrtnt_pk ) */
		                                 'Y'
		                            from
		                                 MDMEDORDT a1,
		                                 SDJDGRTNT b1
		                           where
		                                 a1.PTNO     = b.PTNO
		                             and a1.ORDR_YMD = b.ORDR_YMD
		                             and a1.ORDR_SNO = b.ORDR_SNO
		                             and a1.DRUG_ORDR_PRSS_CD <> '0'
		                             and (nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                             and a1.ORDR_YMD = b1.ORDR_YMD
		                             and a1.PTNO = b1.PTNO
		                             and a1.ORDR_SNO = b1.ORDR_SNO
		                             and b1.DRUG_RTRE_CD = '7'
		                             and rownum = 1
		                        ), 'N') <> 'Y'
		                 /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
		                 and ( ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
		                         not exists ( select  'Y'
		                                        from  SDJDGRTNT s
		                                       where  s.ORDR_YMD        = b.ORDR_YMD
		                                         and  s.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
		                                         and  s.MDTN_NO         = b.MDTN_NO
		                                         and  s.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
		                                         and  s.ORDR_SNO        = b.ORDR_SNO
		                                         and  s.MDPR_CD         = b.MDPR_CD
		                                         and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                                         and  b.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
		                                                                    from  SDJDGRTNT t
		                                                                   where  s.ORDR_YMD         = t.ORDR_YMD
		                                                                     and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
		                                                                     and  s.MDTN_NO          = t.MDTN_NO
		                                                                     and  s.ORDR_SNO         = t.ORDR_SNO
		                                                                     and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
		                                                                     and  s.MDPR_CD          = t.MDPR_CD
		                                                                     and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		                                                                     and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
		                                    )
		                       )
		                     )             
		                 and  h.PTNO = a.PTNO
		                 and  h.ORDR_YMD = a.ORDR_YMD
		                 and  h.ORDR_SNO = b.ORDR_SNO
		/*
		               union  all
		              select
		                      b.ORDR_YMD
		                   ,  b.MDTN_NO_DVSN_CD
		                   ,  b.MDTN_NO
		                   ,  b.ORDR_SNO
		                   ,  b.PTDV_CD
		                   ,  b.MDPR_CD
		                   ,  b.MDPR_CLSF_CD
		                   ,  b.DRAP_DVSN_CD
		                   ,  c.CMMD_STTS_CD
		                   ,  c.PCKN_UNAD_QTY
		                   ,  c.PCUN_CD
		                   ,  b.ICUN_ADMN_VLM
		                   ,  b.ICUN_CD
		                   ,  b.SLCT_UNIT_DVSN_CD
		                   ,  c.DDCN
		                   ,  c.DRUS_CD
		                   ,  c.NTM
		                   ,  decode(h.FRNS_CTRL_DVSN_CD, null, c.TOTL_CLCL_QTY, c.INVN_TOTL_QTY) TOTL_VLM
		                   ,  c.INVN_TOTL_QTY
		                   ,  b.DRBN_NO
		                   ,  c.PHDP_CMMD_BNDL_NO
		                   ,  b.MIX_KIND_CD
		                   ,  c.BSIS_CMMD_PLAC_CD
		                   ,  b.SPSB_CTN
		                   ,  b.FDNO_MDPR_CNFR_DT
		                   ,  b.ISDV_CD
		                   ,  b.DRUG_ORDR_INPT_DT
		                   ,  b.SDPF_EXRE_CD
		                   ,  c.PRIN_DT
		                   ,  c.PRMR_BRCD_SCAN_DT
		                   ,  b.CMMD_FINS_DT
		                   ,  b.MDTN_DT
		                   ,  b.MDTN_STRT_YMD
		                   ,  b.INJC_PLAC_CD
		                   ,  b.OHOR_RTRN_YN
		                   ,  b.BEMD_NO
		                   ,  b.ATTR_NO
		                   ,  case
		                           when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                           when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                           when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                       end      DURV_RESN_CTN
		                   ,  b.RCPC_YN
		                   ,  b.RCPC_DT
		                   ,  c.PRIN_YN
		                   ,  b.LAST_UPDR_ID
		                   ,  b.LAST_UPDT_IP
		                   ,  b.LAST_UPDT_DT
		                   ,  b.PHRM_IMPL_YMD
		                   ,  c.CUNT_TRNM_MDPR_COT
		                   ,  a.DRUG_PRIN_YN
		                   ,  a.MDTN_LCDV_CD
		                   ,  h.DRUS_CD DRUS_CD1
		                   ,  h.PRTX_RLTN_RESN_VL
		                   ,  h.PRTX_RLTN_RESN_CTN
		                   ,  h.MDRP_NO
		                from
		                      SDPORDBAT a
		                   ,  SDPORDDET b
		                   ,  SDPORDOST c
		                   ,  MDMEDORDT h
		               where  a.ORDR_YMD        = to_date(ordrYmd, 'YYYYMMDD')
		                 and  a.MDTN_NO_DVSN_CD = mdtnNoDvsnCd
		                 and  a.MDTN_NO         = mdtnNo
		                 and  a.MDTN_LCDV_CD    = decode(mdtnLcdvCd, null, a.MDTN_LCDV_CD
		                                                 , 'A', a.MDTN_LCDV_CD, mdtnLcdvCd )
		                 and  b.BSIS_CMMD_PLAC_CD  = '3'
		                 and  b.ORDR_YMD           = a.ORDR_YMD
		                 and  b.MDTN_NO_DVSN_CD    = a.MDTN_NO_DVSN_CD
		                 and  b.MDTN_NO            = a.MDTN_NO
		                 and  b.MDTN_LCDV_CD       = a.MDTN_LCDV_CD
		                 and  c.ORDR_YMD        = b.ORDR_YMD
		                 and  c.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
		                 and  c.MDTN_NO         = b.MDTN_NO
		                 and  c.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
		                 and  c.ORDR_SNO        = b.ORDR_SNO
		                 and  instr(afiBsisCmmdPlacNm, b.BSIS_CMMD_PLAC_CD) > 0
		                 and  (
		                        ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6')              )  or
		                        ( b.BSIS_CMMD_PLAC_CD  = 'A' and b.DRAP_DVSN_CD               != '2' )  or
		                        ( b.BSIS_CMMD_PLAC_CD  = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )
		                      )
		                 and (
		                       (inptClntPrgmId = 'SDG101F1') or ( inptClntPrgmId != 'SDG101F1'                       and
		                                                             ( a.DRUG_PRIN_YN = 'P' or a.OSI_PRIN_YN = 'P' )       and
		                                                             (
		                                                               ( b.MDTN_NO_DVSN_CD not in ('D', 'F', 'P', 'Q', 'T', 'G', 'H') and nvl(b.RCPC_YN, 'N') in ('Y', 'W') ) or
		                                                               ( b.MDTN_NO_DVSN_CD     in ('D', 'F', 'P', 'Q', 'T', 'G', 'H')                                       )
		                                                             )
		                                                           )
		                     )
		                 and  nvl(b.DRUS_CD, 'X') != 'SAVE'
		                 and  h.PTNO = a.PTNO
		                 and  h.ORDR_YMD = a.ORDR_YMD
		                 and  h.ORDR_SNO = b.ORDR_SNO
		*/
		              )  b                                             /* 약처방내역상세 */
		           ,  APPTPTNTV d                               /* 환자마스터     */
		           ,  CCUSRDPHT e                               /* 사용자마스터   */
		           ,  CCUSERAMT e2
		           ,  SDDDGCDMT f                               /* 처방코드마스터 */
		           ,  SDDMETCDT g                               /* 용법코드마스터 */
		           ,  HZDEPTMMT h                               /* 부서코드마스터 */
		           ,  SDCMCDDMV i                               /* 공통코드마스터 */
		           ,  SDCMCDDMV k                               /* 공통코드마스터 */
		       where  a.ORDR_YMD        = to_date(#{ordrYmd}, 'YYYYMMDD')
		         and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		         and  a.MDTN_NO         = case when nvl(#{mdtnNo}, 0) = 0 then b.MDTN_NO else #{mdtnNo} end
		         and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
		         and  b.ORDR_YMD          = a.ORDR_YMD
		         and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		         and  b.MDTN_NO           = a.MDTN_NO
		         and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		         and  d.PTNO  = a.PTNO
		         and  e.USER_ID = a.ODDR_ID
		         and  e2.LGIN_ID   = e.LGIN_ID
		         and  f.MDPR_CD = b.MDPR_CD
		         /* 출고여부 nvl(f.RELS_YN, 'N') = 'Y'
		         SDC703F1 전체                                출고여부체크 X
		         SDG205F1 병동MIX                             출고여부체크 X
		         SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		         SDG101F1 MIX                                 출고여부체크 X
		         */
		         and  g.DRUS_CD = b.DRUS_CD
		         and  h.DPRT_CD = a.MCDP_CD
		         and  i.COMN_GRP_CD = 'SD003'
		         and  i.COMN_DTLS_CD = nvl(f.KPNG_PLAC_CD, '9')
		         and  k.COMN_GRP_CD(+) = 'MM079'
		         and  k.COMN_DTLS_CD(+) = b.PRTX_RLTN_RESN_VL
		       order
		          by
		              a.ORDR_YMD
		           ,  a.MDTN_NO_DVSN_CD
		           ,  a.MDTN_NO
		           ,  a.MDTN_LCDV_CD
		           ,  b.BSIS_CMMD_PLAC_CD
		           ,  b.PHDP_CMMD_BNDL_NO
		           ,  b.MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLablSbdv-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="phdpCmmdSqncVl" column="PHDP_CMMD_SQNC_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="abrvDprtCd2" column="ABRV_DPRT_CD_2"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvDprtCd3" column="ABRV_DPRT_CD_3"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="scinClncDxNm" column="SCIN_CLNC_DX_NM"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="mdnt" column="MDNT"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="abrvDprtCd4" column="ABRV_DPRT_CD_4"/>
		<result property="syrpMemo" column="SYRP_MEMO"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLablSbdv () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLablSbdv-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLablSbdv"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLablSbdv-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptPrtxShetLablSbdv */
		<![CDATA[
		select /*------------------------------------------- 환자 상단에 대한 내용 -------------------------------------------*/
		       to_char(a.ORDR_YMD, 'yyyymmdd')                      as ORDR_YMD            /* 처방일자 */
		     , a.PTNO                                               as PTNO                /* 환자번호 */
		     , a.PTNT_NM                                            as PTNT_NM             /* 환자명 */
		     , a.MDTN_LCDV_CD                                       as MDTN_LCDV_CD        /* 투약위치구분코드 */
		     , a.MDTN_NO_DVSN_CD                                    as MDTN_NO_DVSN_CD     /* 투약번호구분코드 A 병동정규, B 병동추가, E 병동응급 */
		     , a.MDTN_NO                                            as MDTN_NO             /* 투약번호 */
		     , a.MDRP_NO                                            as MDRP_NO
		     , a.PHDP_CMMD_SQNC_VL                                  as PHDP_CMMD_SQNC_VL
		     , a.WARD_CD                                            as WARD_CD
		     , a.ABRV_DPRT_CD                                       as ABRV_DPRT_CD
		     , a.BSIS_CMMD_PLAC_CD                                  as BSIS_CMMD_PLAC_CD   /* 기본조제장소코드 */
		     , a.ORDR_SNO                                           as ORDR_SNO            /* 처방일련번호 */
		     , a.ABRV_DPRT_CD_1                                     as ABRV_DPRT_CD_1      /* 약불출장소 */
		     , a.ABRV_DPRT_CD_2                                     as ABRV_DPRT_CD_2      /* 접수병동코드 */
		     , a.PTRM_NO                                            as PTRM_NO             /* 병실번호 */
		     , a.SCKB_NO                                            as SCKB_NO             /* 병상번호 */
		     , a.GEND_CD                                            as GEND_CD             /* 성별 M, F*/
		     , trunc(months_between(a.ORDR_YMD, a.BTDT) / 12)||'-'||trunc(mod(months_between(a.ORDR_YMD, a.BTDT), 12))
		                                                            as AFI_AGE_VL_STR      /* 나이 */
		     ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)               as BDWG_VL             /* 몸무게 */
		     , a.MCDP_CD                                            as MCDP_CD             /* 진료과코드 */
		     , a.ABRV_DPRT_CD_3                                     as ABRV_DPRT_CD_3      /* 진료과코드 GS */
		     , to_char(a.DRUG_ORDR_INPT_DT, 'yyyymmddhh24miss') as DRUG_ORDR_INPT_DT       /* 처방입력일시 */
		     , (select a1.SCIN_NM from MDPADIAGT a1 where a1.MDRP_NO = a.MDRP_NO and a1.MAIN_SCIN_YN = 'Y' and rownum < 2)
		                                                            as SCIN_CLNC_DX_NM /* 상병 */
		     /*------------------------------------------- 약품에 대한 내용 -------------------------------------------*/
		     , a.PHDP_CMMD_BNDL_NO                                  as PHDP_CMMD_BNDL_NO   /* 약제부조제묶음번호 */
		     , a.MDPR_CD                                            as MDPR_CD             /* 약품코드 */
		     , a.MDPR_NM                                            as MDPR_NM             /* 약품명 */
		     , a.MDPR_CLSF_CD                                       as MDPR_CLSF_CD        /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		     , a.DRAP_DVSN_CD                                       as DRAP_DVSN_CD        /* 약적용구분코드  SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		     , a.SMRY_MDPR_NM                                       as SMRY_MDPR_NM        /* 요약약품명 */
		     , a.KORN_PDCT_NM                                       as KORN_PDCT_NM        /* 한글상품명 */
		     , a.PCKN_UNAD_QTY                                      as PCKN_UNAD_QTY       /* 포장단위투여량 1회량 */
		     , a.PCUN_NM                                            as PCUN_NM             /* 포장단위명 */
		     , a.INVN_TOTL_QTY                                      as INVN_TOTL_QTY       /* 재고총량 */
		     , a.MDTN_DDCN                                          as MDTN_DDCN           /* 투약일수 */
		     , a.MDNT                                               as MDNT                /* 투약횟수 */
		     , a.DRBN_NO                                            as DRBN_NO             /* 약묶음번호 */
		     , a.DRUS_CD                                            as DRUS_CD             /* 용법코드 */
		     , a.ENVL_MEMO_CTN1                                     as ENVL_MEMO_CTN1      /* 용법1 */
		     , a.ENVL_MEMO_CTN2                                     as ENVL_MEMO_CTN2      /* 용법2 */
		     , a.MIX_KIND_CD                                        as MIX_KIND_CD         /* 혼합종류코드 1 MIX, 2 기타MIX(가루약/혼합조제), 3 알약으로 */
		     , a.KPNG_PLAC_CD                                       as KPNG_PLAC_CD        /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
		     , a.HGRS_HGCC_MDPR_YN                                  as HGRS_HGCC_MDPR_YN   /* 고위험고농도약품여부 1 고위험,  2 고농도 */
		     , a.SPSB_CTN                                           as SPSB_CTN            /* 비고란 */
		     , a.INJC_PLAC_CD                                       as INJC_PLAC_CD
		     , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.INJC_PLAC_CD)
		                                                            as ABRV_DPRT_CD_4 /* 주사실코드 */
		    , (select b1.PHRM_DTLS_CTRL_NM from SDMCTRLMT b1 where PHRM_CTRL_CD = 'SD170' and a.MDPR_CD = b1.PHRM_DTLS_CTRL_CD) as SYRP_MEMO/* 시럽 라벨 안내 멘트 */
		  from ( select a.ORDR_YMD                       as ORDR_YMD          /* 처방일자 */
		              , a.MDTN_LCDV_CD                   as MDTN_LCDV_CD      /* 투약위치구분코드 */
		              , a.MDTN_NO_DVSN_CD                as MDTN_NO_DVSN_CD   /* 투약번호구분코드 */
		              , a.MDTN_NO                        as MDTN_NO           /* 투약번호 */
		              , j.MDRP_NO                        as MDRP_NO
		              , k.PHDP_CMMD_SQNC_VL              as PHDP_CMMD_SQNC_VL
		              , k.ABRV_DPRT_CD                   as ABRV_DPRT_CD
		              , a.BSIS_CMMD_PLAC_CD              as BSIS_CMMD_PLAC_CD /* 기본조제장소코드 */
		              , a.ORDR_SNO                       as ORDR_SNO          /* 처방일련번호 */
		              , nvl(k.ABRV_DPRT_CD, e.WARD_CD)   as ABRV_DPRT_CD_1
		              , e.WARD_CD                        as WARD_CD
		              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = j.WARD_CD)
		                                                 as ABRV_DPRT_CD_2    /* 병동코드 */
		              , j.PTRM_NO                        as PTRM_NO           /* 병실번호 */
		              , j.SCKB_NO                        as SCKB_NO           /* 병상번호 */
		              , f.GEND_CD                        as GEND_CD           /* 성별 */
		              , f.BTDT
		              , e.MCDP_CD                        as MCDP_CD           /* 진료과코드 */
		              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = e.MCDP_CD)   as ABRV_DPRT_CD_3 /* 진료과코드 */
		              , a.DRUG_ORDR_INPT_DT              as DRUG_ORDR_INPT_DT /* 처방입력일시 */
		              , a.PTNO                           as PTNO              /* 환자번호 */
		              , f.PTNT_NM                        as PTNT_NM           /* 환자명 */
		              , a.PHDP_CMMD_BNDL_NO              as PHDP_CMMD_BNDL_NO /* 약제부조제묶음번호 */
		              , a.MDPR_CD                        as MDPR_CD           /* 약품코드 */
		              , b.MDPR_NM                        as MDPR_NM           /* 약품명 */
		              , a.MDPR_CLSF_CD                   as MDPR_CLSF_CD      /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		              , a.DRAP_DVSN_CD                   as DRAP_DVSN_CD      /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		              , b.SMRY_MDPR_NM                   as SMRY_MDPR_NM      /* 요약약품명 */
		              , b.KORN_PDCT_NM                   as KORN_PDCT_NM        /* 한글상품명 */
		              , a.PCKN_UNAD_QTY                  as PCKN_UNAD_QTY     /* 포장단위투여량 1회량 */
		              , a.PCUN_NM                        as PCUN_NM
		              , a.INVN_TOTL_QTY                  as INVN_TOTL_QTY     /* 재고총량 */
		              , a.MDTN_DDCN                      as MDTN_DDCN         /* 투약일수 */
		              , a.MDNT                           as MDNT              /* 투약횟수 */
		              , a.DRBN_NO                        as DRBN_NO           /* 약묶음번호 */
		              , a.DRUS_CD                        as DRUS_CD           /* 용법코드 */
		              , b.DGFR_CD                        as DGFR_CD           /* 제형코드 SD015 */
		              , decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN1, c.ENVL_MEMO_CTN3)  as ENVL_MEMO_CTN1
		              , decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN2, c.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
		              , a.MIX_KIND_CD                    as MIX_KIND_CD       /* 혼합종류코드 1 MIX, 2 기타MIX(가루약/혼합조제), 3 알약으로 */
		              , b.KPNG_PLAC_CD                   as KPNG_PLAC_CD      /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
		              , b.HGRS_HGCC_MDPR_YN              as HGRS_HGCC_MDPR_YN /* 고위험고농도약품여부 1 고위험,  2 고농도 */
		              , FN_SD_ISNUMBER_S(a.SPSB_CTN)     as SPSB_CTN
		              , a.INJC_PLAC_CD                   as INJC_PLAC_CD
		              , lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
		             || rpad(k.ABRV_DPRT_CD, 7,'0' )
		             || lpad(to_char(j.PTRM_NO) ,5, '0')
		             || f.PTNT_NM
		             || e.PTNO
		             || to_char(a.ORDR_YMD, 'yyyymmdd')
		             || a.MDTN_LCDV_CD
		             || a.MDTN_NO_DVSN_CD
		             || lpad(to_char(a.MDTN_NO), 4, '0')
		             || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		                     when a.MDPR_CLSF_CD = '3' then '3'
		                                               else '1'
		                end
		             || case when a.DRAP_DVSN_CD = '1' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		                     when a.DRAP_DVSN_CD = '3' then '2'
		                     when a.DRAP_DVSN_CD = '9' then '3'
		                                               else '4'
		                end
		             || a.BSIS_CMMD_PLAC_CD
		             || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
		             || rpad(a.MDPR_CD,10,' ')
		             || lpad(to_char(a.ORDR_SNO), 10, '0')       as orderkey
		           from SDPORDDET a
		              , SDDDGCDMT b /* 약품코드 */
		              , SDDMETCDT c /* 약품용법코드관리 */
		              , SDPORDBAT e /* 처방조제기본 */
		              , APPTPTNTV f /* 환자Master View */
		              , MDMEDORDT h /* 약처방 */
		              , APRCRPTNT j /* 진료접수 */
		              , HZDEPTMMT k /* 조직Master I/F(MDM연계) */
		          where a.ORDR_YMD  = to_date(#{ordrYmd}, 'yyyymmdd')
		            and a.MDTN_LCDV_CD    = case when (#{mdtnLcdvCd} is null) or
		                                              (#{mdtnLcdvCd} = '')    or
		                                              (#{mdtnLcdvCd} = 'A')   then a.MDTN_LCDV_CD
		                                                                      else #{mdtnLcdvCd}
		                                    end
		            and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		            and  a.MDTN_NO = case when nvl(#{mdtnNo}, 0) = 0 then a.MDTN_NO else #{mdtnNo} end
		            and  a.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then a.PHDP_CMMD_BNDL_NO else #{phdpCmmdBndlNo} end
		            and  a.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */            
		            and  a.DRAP_DVSN_CD = '1'
		            and  b.DGFR_CD in ('10', '11', '31', '32')
		            and  a.BSIS_CMMD_PLAC_CD  = '4'
		            /*--------------------------------------------------------------------------------------------------------------*/
		            and (
		                  ( nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1') or 
		                  ( nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'      and /* 주사는 자가주사만 나오도록 */
		                    ( e.DRUG_PRIN_YN = 'P' or e.OSI_PRIN_YN = 'P' )       and /* 수납여부 : 병동퇴원,외출,외박, DSC 퇴원, 응급실퇴원(업무시간내,외) 제외 모두 수납이 된 것만 */
		                    (
		                      ( a.MDTN_NO_DVSN_CD not in ('D', 'F', 'P', 'Q', 'T', 'G', 'H') and nvl(a.RCPC_YN, 'N') in ('Y', 'W') ) or
		                      ( a.MDTN_NO_DVSN_CD     in ('D', 'F', 'P', 'Q', 'T', 'G', 'H')                                       )
		                    )
		                  )
		                )
		            /*--------------------------------------------------------------------------------------------------------------*/
		            and nvl(b.DRUS_CD, 'X') != 'SAVE' /* SAVE 단독처방 제외 */
		           /* 조제정보 생성 전 반납*/
		           and nvl((select /*+ index ( a1 mdmedordt_pk )
		                               index ( b1 sdjdgrtnt_pk ) */
		                           'Y'
		                      from
		                           MDMEDORDT a1,
		                           SDJDGRTNT b1
		                     where
		                           a1.PTNO     = a.PTNO
		                       and a1.ORDR_YMD = a.ORDR_YMD
		                       and a1.ORDR_SNO = a.ORDR_SNO
		                       and a1.DRUG_ORDR_PRSS_CD <> '0'
		                       and (nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                       and a1.ORDR_YMD = b1.ORDR_YMD
		                       and a1.PTNO = b1.PTNO
		                       and a1.ORDR_SNO = b1.ORDR_SNO
		                       and b1.DRUG_RTRE_CD = '7'
		                       and rownum = 1
		                  ), 'N') <> 'Y'
		           /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
		           and ( ( a.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
		                   not exists ( select  'Y'
		                                  from  SDJDGRTNT s
		                                 where  s.ORDR_YMD        = a.ORDR_YMD
		                                   and  s.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                                   and  s.MDTN_NO         = a.MDTN_NO
		                                   and  s.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                                   and  s.ORDR_SNO        = a.ORDR_SNO
		                                   and  s.MDPR_CD         = a.MDPR_CD
		                                   and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                                   and  a.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
		                                                              from  SDJDGRTNT t
		                                                             where  s.ORDR_YMD         = t.ORDR_YMD
		                                                               and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
		                                                               and  s.MDTN_NO          = t.MDTN_NO
		                                                               and  s.ORDR_SNO         = t.ORDR_SNO
		                                                               and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
		                                                               and  s.MDPR_CD          = t.MDPR_CD
		                                                               and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		                                                               and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
		                              )
		                 )
		               )            
		            and b.MDPR_CD = a.MDPR_CD
		            /* 출고여부 nvl(b.RELS_YN, 'N') = 'Y'
		            SDC703F1 전체                                출고여부체크 X
		            SDG205F1 병동MIX                             출고여부체크 X
		            SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		            SDG101F1 MIX                                 출고여부체크 X
		            */
		            and c.DRUS_CD(+)       = a.DRUS_CD
		            and e.ORDR_YMD         = a.ORDR_YMD
		            and e.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		            and e.MDTN_NO          = a.MDTN_NO
		            and e.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		            and e.WARD_CD          = nvl(#{wardCd}, e.WARD_CD)
		            and f.PTNO             = a.PTNO
		            and h.PTNO             = a.PTNO
		            and h.ORDR_YMD         = a.ORDR_YMD
		            and h.ORDR_SNO         = a.ORDR_SNO
		            and j.MDRP_NO          = h.MDRP_NO
		            and k.DPRT_CD          (+)= e.WARD_CD
		      ) a
		 order
		    by orderkey
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrin-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="phdpCmmdSqncVl" column="PHDP_CMMD_SQNC_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="afiAbrvDprtNm1" column="AFI_ABRV_DPRT_NM_1"/>
		<result property="abrvDprtCd2" column="ABRV_DPRT_CD_2"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="abrvDprtCd4" column="ABRV_DPRT_CD_4"/>
		<result property="afiInjcPlacNm" column="AFI_INJC_PLAC_NM"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="sckbNo" column="SCKB_NO"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="btdt1" column="BTDT1"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvDprtCd3" column="ABRV_DPRT_CD_3"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="scinClncDxNm" column="SCIN_CLNC_DX_NM"/>
		<result property="subScinClncDxNm" column="SUB_SCIN_CLNC_DX_NM"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="rporSmryMdprNm" column="RPOR_SMRY_MDPR_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="ensnPdctNm" column="ENSN_PDCT_NM"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="mdnt" column="MDNT"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoMdprCnfrDt" column="FDNO_MDPR_CNFR_DT"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="rcpcDt" column="RCPC_DT"/>
		<result property="dgfrCd" column="DGFR_CD"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="rtrnCnfrCqy" column="RTRN_CNFR_CQY"/>
		<result property="tkvrPrsgDvsnCd" column="TKVR_PRSG_DVSN_CD"/>
		<result property="mdprLctnCd" column="MDPR_LCTN_CD"/>
		<result property="rtrnRqstCqy" column="RTRN_RQST_CQY"/>
		<result property="tkmdCatnLablCd" column="TKMD_CATN_LABL_CD"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="pwdrDslwYn" column="PWDR_DSLW_YN"/>
		<result property="mdprLctnNm" column="MDPR_LCTN_NM"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="dietNm" column="DIET_NM"/>
		<result property="eqptYn" column="EQPT_YN"/>
		<result property="ipdvCd" column="IPDV_CD"/>
		<result property="prgnYn" column="PRGN_YN"/>
		<result property="fvdvCd" column="FVDV_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrin () 
        Description :                                           처방 조제 봉투 출력
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrin-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrin"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrin-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrin */
		<![CDATA[
		select /*------------------------------------------- 환자 상단에 대한 내용 -------------------------------------------*/
		       to_char(a.ORDR_YMD, 'yyyymmdd')                      as ORDR_YMD            /* 처방일자 */
		     , to_char(a.ORDR_DT, 'yyyymmddhh24miss')              as ORDR_DT             /* 처방일시 */     
		     , a.PTNO                                               as PTNO                /* 환자번호 */
		     , a.PTNT_NM                                            as PTNT_NM             /* 환자명 */
		     , a.MDTN_LCDV_CD                                       as MDTN_LCDV_CD        /* 투약위치구분코드 */
		     , a.MDTN_NO_DVSN_CD                                    as MDTN_NO_DVSN_CD     /* 투약번호구분코드 A 병동정규, B 병동추가, E 병동응급 */
		     , a.MDTN_NO                                            as MDTN_NO             /* 투약번호 */
		     , a.MDRP_NO                                            as MDRP_NO
		     , a.PHDP_CMMD_SQNC_VL                                  as PHDP_CMMD_SQNC_VL
		     , a.WARD_CD                                            as WARD_CD
		     , a.ABRV_DPRT_CD                                       as ABRV_DPRT_CD
		     , a.BSIS_CMMD_PLAC_CD                                  as BSIS_CMMD_PLAC_CD   /* 기본조제장소코드 */
		     , a.ORDR_SNO                                           as ORDR_SNO            /* 처방일련번호 */
		     , a.ODDR_ID                                            as ODDR_ID             /* 처방의사 */
		     , (select a1.USER_NM from CCUSERAMT a1 where a1.LGIN_ID = a.ODDR_ID and rownum = 1)
		                                                            as ODDR_NM             /* 처방의사명 */
		     , a.GNDR_ID                                            as GNDR_ID             /* 주치의사 */    
		     , (select a1.USER_NM from CCUSERAMT a1 where a1.LGIN_ID = a.GNDR_ID and rownum = 1)
		                                                            as GNDR_NM             /* 주치의사명 */  
		     , a.ABRV_DPRT_CD_1                                     as ABRV_DPRT_CD_1      /* 약불출장소 */
		     , a.AFI_ABRV_DPRT_NM_1                                 as AFI_ABRV_DPRT_NM_1  /* 약불출장소명 */
		     , a.ABRV_DPRT_CD_2                                     as ABRV_DPRT_CD_2      /* 접수병동코드 */
		     , a.INJC_PLAC_CD                                       as INJC_PLAC_CD        /* 주사장소코드 */
		     , a.ABRV_DPRT_CD_4                                     as ABRV_DPRT_CD_4      /* 주사장소코드명 */
		     , a.AFI_INJC_PLAC_NM                                   as AFI_INJC_PLAC_NM    /* 주사장소명 */
		     , a.PTRM_NO                                            as PTRM_NO             /* 병실번호 */
		     , a.SCKB_NO                                            as SCKB_NO             /* 병상번호 */
		     , a.GEND_CD                                            as GEND_CD             /* 성별 M, F*/
		     , to_char(a.BTDT, 'yymmdd')                            as BTDT                /* 생년월일*/             
		     , to_char(a.BTDT, 'yyyymmdd')                            as BTDT1               /* 생년월일*/             
		     , trunc(months_between(a.ORDR_YMD, a.BTDT) / 12)||'-'||trunc(mod(months_between(a.ORDR_YMD, a.BTDT), 12))
		                                                            as AFI_AGE_VL_STR      /* 나이 */
		     , a.GEND_CD ||'/'|| to_char(trunc(months_between(trunc(a.ORDR_YMD), a.BTDT)/12, 0))
		                                                            as AGE_CTN             /* SEX/AEG(세) */
		     , to_char(a.MDCR_DT, 'yyyymmddhh24miss')               as MDCR_DT
		     , a.MCDP_CD                                            as MCDP_CD             /* 진료과코드 */
		     , a.ABRV_DPRT_CD_3                                     as ABRV_DPRT_CD_3      /* 진료과코드 GS */
		     , to_char(a.DRUG_ORDR_INPT_DT, 'yyyymmddhh24miss') as DRUG_ORDR_INPT_DT       /* 처방입력일시 */
		     , (select a1.SCIN_NM from MDPADIAGT a1 where a1.MDRP_NO = a.MDRP_NO and a1.MAIN_SCIN_YN = 'Y' and rownum < 2)
		                                                            as SCIN_CLNC_DX_NM     /* 상병 */
		     , (select a1.SCIN_NM from MDPADIAGT a1 where a1.MDRP_NO = a.MDRP_NO and a1.MAIN_SCIN_YN != 'Y' and rownum < 2)
		                                                            as SUB_SCIN_CLNC_DX_NM     /* 부상병 */       
		     /*------------------------------------------- 약품에 대한 내용 -------------------------------------------*/
		     , a.PHDP_CMMD_BNDL_NO                                  as PHDP_CMMD_BNDL_NO   /* 약제부조제묶음번호 */
		     , a.MDPR_CD                                            as MDPR_CD             /* 약품코드 */
		     , a.MDPR_NM                                            as MDPR_NM             /* 약품명 */
		     , a.MDPR_CLSF_CD                                       as MDPR_CLSF_CD        /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		     , a.DRAP_DVSN_CD                                       as DRAP_DVSN_CD        /* 약적용구분코드  SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		     , a.SMRY_MDPR_NM                                       as SMRY_MDPR_NM        /* 요약약품명 */
		     , FN_SD_GET_RPOR_SMRY_MDPR_NM(a.MDPR_CD )              as  RPOR_SMRY_MDPR_NM        /* 보고서 요약약품명 */
		     , a.KORN_PDCT_NM                                       as KORN_PDCT_NM        /* 한글상품명 */
		     , a.ENSN_PDCT_NM                                       as ENSN_PDCT_NM        /* 영문상품명 */
		     , a.PCKN_UNAD_QTY                                      as PCKN_UNAD_QTY       /* 포장단위투여량 1회량 */
		     , a.PCUN_NM                                            as PCUN_NM             /* 포장단위명 */
		     , a.INVN_TOTL_QTY                                      as INVN_TOTL_QTY       /* 재고총량 */
		     , a.MDTN_DDCN                                          as MDTN_DDCN           /* 투약일수 */
		     , a.MDNT                                               as MDNT                /* 투약횟수 */
		     , a.DRBN_NO                                            as DRBN_NO             /* 약묶음번호 */
		     , a.DRUS_CD                                            as DRUS_CD             /* 용법코드 */
		     , a.ENVL_MEMO_CTN1                                     as ENVL_MEMO_CTN1      /* 용법1 */
		     , a.ENVL_MEMO_CTN2                                     as ENVL_MEMO_CTN2      /* 용법2 */
		     , a.MIX_KIND_CD                                        as MIX_KIND_CD         /* 혼합종류코드 1 MIX, 2 기타MIX(가루약/혼합조제), 3 알약으로 */
		     , a.KPNG_PLAC_CD                                       as KPNG_PLAC_CD        /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
		     , (select z1.DETL_CD_NM
		          from CCCMCDDMT z1
		         where z1.COMN_GRP_CD = 'SD003'
		           and z1.COMN_DTLS_CD = a.KPNG_PLAC_CD)            as KPNG_PLAC_NM        /* 라벨출력용 보관장소코드명 */        
		     , a.HGRS_HGCC_MDPR_YN                                  as HGRS_HGCC_MDPR_YN   /* 고위험고농도약품여부 1 고위험,  2 고농도 */
		     , a.SPSB_CTN                                           as SPSB_CTN            /* 비고란 */
		     , to_char(a.FDNO_MDPR_CNFR_DT, 'yyyymmddhh24miss')     as FDNO_MDPR_CNFR_DT   /* 정수약품확인일시 */
		     , nvl(a.RCPC_YN, 'N')                                  as RCPC_YN             /* 수납여부 */
		     , to_char(a.RCPC_DT, 'yyyymmddhh24miss')               as RCPC_DT             /* 수납일시 */
		     , a.DGFR_CD                                            as DGFR_CD             /* 제형코드 SD015 */
		     , a.WARD_LABL_PRIN_YN                                  as WARD_LABL_PRIN_YN   /* 라벨출력여부 */
		     , #{inqrDvsnCd}                                        as INQR_DVSN_CD
		     , #{inptClntPrgmId}                                    as INPT_CLNT_PRGM_ID
		     , a.RTRN_CNFR_CQY                                      as RTRN_CNFR_CQY     	
		     , a.TKVR_PRSG_DVSN_CD   
		     , a.MDPR_LCTN_CD
		     , a.RTRN_RQST_CQY
		     , a.TKMD_CATN_LABL_CD   /*복약주의라벨코드 */
		     , a.SDPF_EXRE_CD    /*의약분업예외사유코드*/    
		     , a.PWDR_DSLW_YN as PWDR_DSLW_YN        
		     , (select PHRM_DTLS_CTRL_NM
		        from SDMCTRLMT z001 
		      where PHRM_CTRL_CD ='SD330'
		         and z001.PHRM_DTLS_CTRL_CD = a.MDPR_LCTN_CD
		       ) as MDPR_LCTN_NM           /* 약국내보관장소이름 */
		     , (select /*+ LEADING( DOMT ) USE_NL ( BMMT DAMT ) */ 
		               a.item_rcrd_vl
		                from(
		                    select 
		                        case
		                           when (upper(bmmt.BODY_MSRN_UNIT_CD) = 'G' and              /* 단위 컬럼 추가 g으로 측정되는 경우 kg 전환 처리 */
		                                 REGEXP_INSTR(bmmt.BODY_MSRN_RCRD_VL, '[^0-9]') = 0) then to_char(to_number(bmmt.BODY_MSRN_RCRD_VL)/1000, 'FM990.999' )
		                           else bmmt.BODY_MSRN_RCRD_VL
		                         end  as ITEM_RCRD_VL
		                    from  MECFSDOMT domt
		                      ,  MECFSBMMT bmmt
		                      ,  MECFSDAMT damt
		                    where  domt.PTNO          = a.PTNO
		                    and  bmmt.CNOS_RCRD_NO  = domt.CNOS_RCRD_NO
		                    and  bmmt.BODY_MSRN_RCRD_DT >= trunc(sysdate) - 365
		                    and  bmmt.BODY_MSRN_RCRD_DT  < trunc(sysdate) + 1
		                    and  damt.CNOS_ITEM_SNO = bmmt.BODY_MSRN_ITEM_SNO
		                    and  damt.CNOS_ITEM_NM ='WT'
		                    order by bmmt.body_msrn_rcrd_dt desc
		                    ) a
		        where rownum = 1)      as BDWG_VL /* 몸무게*/  
		       , (select z2.DIET_NM
		            from SUDIECTMT z1
		               , SUDIECDCT z2
		           where z1.PTNO = a.PTNO
		             and z1.DIET_YMD = a.ORDR_YMD
		             and z1.MEDV_CD  = case when sysdate  < to_date(to_char(a.ORDR_YMD, 'yyyymmdd')  || '073000','yyyymmddhh24miss')  then '1' /* 조식 */
		                                    when sysdate  > to_date(to_char(a.ORDR_YMD, 'yyyymmdd')  || '173000','yyyymmddhh24miss') then '3' /* 석식 */
		                                    else '2' /* 중식 */
		                               end
		             and z2.DIET_CD = z1.DIET_CD
		             and z1.DIET_YMD between z2.APST_YMD and z2.APFN_YMD
		             and rownum = 1) as DIET_NM        
		       , nvl((select 'Y' 
		               from SDJFIXQTT z1
		              where z1.MDPR_CD = a.MDPR_CD
		                and z1.DPRT_CD = a.WARD_CD
		                and rownum =1 ), 'N') as EQPT_YN  /*비치여부*/
		       , (select z1.IPDV_CD
		          from ACCLMCCLT z1
		        where z1.PTNO = a.PTNO
		           and z1.ORDR_YMD = a.ORDR_YMD
		           and z1.ORDR_SNO = a.ORDR_SNO
		           and z1.ORDR_CD   = a.MDPR_CD
		           and z1.CNCL_DT is null 
		           and rownum = 1 ) as  IPDV_CD /*급여구분코드*/          
		       , (select case when count(1) > 0 then 'Y' else 'N' end 
			      from MEPTNTCLT z
			    where z.PTNO = a.PTNO
			       and z.PTNT_CTRL_CD = '001'
			       and z.PTNT_CTRL_CHRC_VL1 = 'Y')	AS PRGN_YN  /* 임신여부 */ 
		       , (select FVDV_CD 
				   from  APRCRPTNT x2  -- 진료접수
				 where  x2.PTNO     = a.PTNO
				    and  x2.CODV_CD  = a.MDTN_NO_DVSN_CD
				    and  x2.MDCR_YMD = a.ORDR_YMD
				    and  x2.MDRP_NO  = a.MDRP_NO) as FVDV_CD    /*초재진구분 */
		  from ( select /*+ LEADING(A)   USE_NL ( a b c e f h j k l ) NO_EXPAND */
		                a.ORDR_YMD                       as ORDR_YMD          /* 처방일자 */
		              , e.ORDR_DT                        as ORDR_DT           /* 처방일시 */  
		              , a.MDTN_LCDV_CD                   as MDTN_LCDV_CD      /* 투약위치구분코드 */
		              , a.MDTN_NO_DVSN_CD                as MDTN_NO_DVSN_CD   /* 투약번호구분코드 */
		              , a.MDTN_NO                        as MDTN_NO           /* 투약번호 */
		              , j.MDRP_NO                        as MDRP_NO
		              , k.PHDP_CMMD_SQNC_VL              as PHDP_CMMD_SQNC_VL
		              , k.ABRV_DPRT_CD                   as ABRV_DPRT_CD
		              , a.BSIS_CMMD_PLAC_CD              as BSIS_CMMD_PLAC_CD /* 기본조제장소코드 */
		              , a.ORDR_SNO                       as ORDR_SNO          /* 처방일련번호 */
		              , h.ODDR_ID                        as ODDR_ID           /* 처방의사 */
		              , h.GNDR_ID                        as GNDR_ID           /* 주치의사 */
		              , nvl(k.ABRV_DPRT_CD, e.WARD_CD)   as ABRV_DPRT_CD_1
		              , nvl(k.KORN_DPRT_NM, e.WARD_CD)   as AFI_ABRV_DPRT_NM_1
		              , a.INJC_PLAC_CD                   as INJC_PLAC_CD
		              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.INJC_PLAC_CD)
		                                                 as ABRV_DPRT_CD_4
		              , (select a1.KORN_DPRT_NM from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.INJC_PLAC_CD)
		                                                 as AFI_INJC_PLAC_NM
		              , e.WARD_CD                        as WARD_CD
		              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = j.WARD_CD)
		                                                 as ABRV_DPRT_CD_2    /* 병동코드 */
		              , j.PTRM_NO                        as PTRM_NO           /* 병실번호 */
		              , j.SCKB_NO                        as SCKB_NO           /* 병상번호 */
		              , j.MDCR_DT                        as MDCR_DT
		              , f.GEND_CD                        as GEND_CD           /* 성별 */
		              , f.BTDT                           as BTDT
		              , e.MCDP_CD                        as MCDP_CD           /* 진료과코드 */
		              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = e.MCDP_CD)   as ABRV_DPRT_CD_3 /* 진료과코드 */
		              , a.DRUG_ORDR_INPT_DT              as DRUG_ORDR_INPT_DT /* 처방입력일시 */
		              , a.PTNO                           as PTNO              /* 환자번호 */
		              , f.PTNT_NM                        as PTNT_NM           /* 환자명 */
		              , a.PHDP_CMMD_BNDL_NO              as PHDP_CMMD_BNDL_NO /* 약제부조제묶음번호 */
		              , a.MDPR_CD                        as MDPR_CD           /* 약품코드 */
		              , FN_SD_GETHGCTMDPRNM_S(a.MDPR_CD,b.MDPR_NM)  as MDPR_NM           /* 약품명 */
		              , a.MDPR_CLSF_CD                   as MDPR_CLSF_CD      /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		              , a.DRAP_DVSN_CD                   as DRAP_DVSN_CD      /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		              , FN_SD_GETHGCTMDPRNM_S(a.MDPR_CD,b.SMRY_MDPR_NM) as SMRY_MDPR_NM      /* 요약약품명 */
		              , b.KORN_PDCT_NM                   as KORN_PDCT_NM      /* 한글상품명 */
		              , b.ENSN_PDCT_NM                   as ENSN_PDCT_NM      /* 영문상품명 */
		              , a.PCKN_UNAD_QTY                  as PCKN_UNAD_QTY     /* 포장단위투여량 1회량 */
		              , a.PCUN_NM                        as PCUN_NM
		              , a.INVN_TOTL_QTY                  as INVN_TOTL_QTY     /* 재고총량 */
		              , a.MDTN_DDCN                      as MDTN_DDCN         /* 투약일수 */
		              , a.MDNT                           as MDNT              /* 투약횟수 */
		              , a.DRBN_NO                        as DRBN_NO           /* 약묶음번호 */
		              , a.DRUS_CD                        as DRUS_CD           /* 용법코드 */
		              , c.TKMD_INFT_DRUS_CTN             as ENVL_MEMO_CTN1    /* 용법 복약안내문 */
		              , decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN2, c.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
		              , a.MIX_KIND_CD                    as MIX_KIND_CD       /* 혼합종류코드 1 MIX, 2 기타MIX(가루약/혼합조제), 3 알약으로 */
		              , b.KPNG_PLAC_CD                   as KPNG_PLAC_CD      /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
		              , b.HGRS_HGCC_MDPR_YN              as HGRS_HGCC_MDPR_YN /* 고위험고농도약품여부 1 고위험,  2 고농도 */
		              , FN_SD_ISNUMBER_S(a.SPSB_CTN)     as SPSB_CTN
		              , a.FDNO_MDPR_CNFR_DT              as FDNO_MDPR_CNFR_DT   /* 정수약품확인일시 */
		              , a.RCPC_YN                        as RCPC_YN             /* 수납여부 */
		              , a.RCPC_DT                        as RCPC_DT             /* 수납일시 */
		              , b.DGFR_CD                        as DGFR_CD             /* 제형코드 SD015 */
		              , a.WARD_LABL_PRIN_YN              as WARD_LABL_PRIN_YN   /* 라벨출력여부 */ 
		              , a.TKVR_PRSG_DVSN_CD as   TKVR_PRSG_DVSN_CD         
		              , b.MDPR_LCTN_CD as MDPR_LCTN_CD
		              , l.RTRN_RQST_CQY as RTRN_RQST_CQY
		              , b.TKMD_CATN_LABL_CD as TKMD_CATN_LABL_CD  /* 복약주의라벨코드*/
		              , h.SDPF_EXRE_CD as SDPF_EXRE_CD /*의약분업예외사유코드*/                   
		              , b.PWDR_DSLW_YN as PWDR_DSLW_YN    
		              /* 정렬순서
		                 정규(SDG101F1)      : 병동-환자명-환자번호-처방일자-투약번호-[내복/외용]-조제장소-묶음번호-처방순번
		                 추가/응급(SDC100F1) : 병동-환자명-환자번호-처방일자-투약번호-[일반/향정]-[내복/외용]-조제장소-묶음번호-처방순번
		              */
		              /* 봉투  */
		              , case when #{dvsnNm} = '1' then case when a.MDTN_NO_DVSN_CD = 'A' then
		                                                                                     lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
				                                                                                   || rpad(k.ABRV_DPRT_CD, 7,'0' )
				                                                                                   || lpad(to_char(j.PTRM_NO) ,5, '0')
				                                                                                   || f.PTNT_NM
				                                                                                   || e.PTNO
				                                                                                   || to_char(a.ORDR_YMD, 'yyyymmdd')
				                                                                                   || a.MDTN_LCDV_CD
				                                                                                   || a.MDTN_NO_DVSN_CD
				                                                                                   || lpad(to_char(a.MDTN_NO), 4, '0')
				                                                                                   || case when a.DRAP_DVSN_CD = '1' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
				                                                                                           when a.DRAP_DVSN_CD = '3' then '2'
				                                                                                           when a.DRAP_DVSN_CD = '9' then '3'
				                                                                                                                     else '4'
				                                                                                      end
				                                                                                   || lpad(a.BSIS_CMMD_PLAC_CD,3,' ')
		                                                                                           || rpad(a.MDNT,3,' ')
				                                                                                   || rpad(a.DRUS_CD,3,' ')
				                                                                                   || rpad(a.MDPR_CD,10,' ')
		                                                                                           || rpad( to_char(a.PHDP_CMMD_BNDL_NO ),3,' ')
				                                                                                   || lpad(to_char(a.ORDR_SNO), 10, '0')
				                                                                                 else   /* 그외 */
				                                                                                      lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
				                                                                                   || rpad(k.ABRV_DPRT_CD, 7,'0' )
				                                                                                   || lpad(to_char(j.PTRM_NO) ,5, '0')
				                                                                                   || f.PTNT_NM
				                                                                                   || e.PTNO
				                                                                                   || to_char(a.ORDR_YMD, 'yyyymmdd')
				                                                                                   || a.MDTN_LCDV_CD
				                                                                                   || a.MDTN_NO_DVSN_CD
				                                                                                   || lpad(to_char(a.MDTN_NO), 4, '0')
				                                                                                   || case when a.MDPR_CLSF_CD = '2' then ' 2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
				                                                                                           when a.MDPR_CLSF_CD = '3' then ' 3'
				                                                                                                                     else ' 1'
				                                                                                      end
				                                                                                   || case when a.DRAP_DVSN_CD = '1' then ' 1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
				                                                                                           when a.DRAP_DVSN_CD = '3' then ' 2'
				                                                                                           when a.DRAP_DVSN_CD = '9' then ' 3'
				                                                                                                                     else ' 4'
				                                                                                      end
				                                                                                   || lpad(a.BSIS_CMMD_PLAC_CD,3,' ')
		                                                                                           || rpad( to_char(a.PHDP_CMMD_BNDL_NO ),3,' ')
		                                                                                           || rpad(a.MDNT,3,' ')
				                                                                                   || rpad(a.DRUS_CD,3,' ')
				                                                                                   || rpad(a.MDPR_CD,10,' ')
				                                                                                   || lpad(to_char(a.ORDR_SNO), 10, '0')
		                                               end
		                     /* 주사라벨(일반, 향정, 마약) */
		                     when #{dvsnNm} = '2' then   lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
		                                               || rpad(k.ABRV_DPRT_CD, 7,'0' )
		                                               || lpad(to_char(j.PTRM_NO) ,5, '0')
		                                               || f.PTNT_NM
		                                               || e.PTNO
		                                               || to_char(a.ORDR_YMD, 'yyyymmdd')
		                                               || a.MDTN_LCDV_CD
		                                               || a.MDTN_NO_DVSN_CD
		                                               || lpad(to_char(a.MDTN_NO), 4, '0')
		                                               || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		                                                       when a.MDPR_CLSF_CD = '3' then '3'
		                                                                                 else '1'
		                                                  end
		                                               || case when b.KPNG_PLAC_CD = '3' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		                                                       when b.KPNG_PLAC_CD = '1' then '2'
		                                                       when b.KPNG_PLAC_CD = '7' then '3'
		                                                                                 else '4'
		                                                  end
		                                               || a.BSIS_CMMD_PLAC_CD
		                                               || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
		                                               || rpad(a.MDPR_CD,10,' ')
		                                               || lpad(to_char(a.ORDR_SNO), 10, '0')
		                     /* 시럽 */
		                     when #{dvsnNm} = '3' then   lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
		                                               || rpad(k.ABRV_DPRT_CD, 7,'0' )
		                                               || lpad(to_char(j.PTRM_NO) ,5, '0')
		                                               || f.PTNT_NM
		                                               || e.PTNO
		                                               || to_char(a.ORDR_YMD, 'yyyymmdd')
		                                               || a.MDTN_LCDV_CD
		                                               || a.MDTN_NO_DVSN_CD
		                                               || lpad(to_char(a.MDTN_NO), 4, '0')
		                                               || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		                                                       when a.MDPR_CLSF_CD = '3' then '3'
		                                                                                 else '1'
		                                                  end
		                                               || case when a.DRAP_DVSN_CD = '1' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		                                                       when a.DRAP_DVSN_CD = '3' then '2'
		                                                       when a.DRAP_DVSN_CD = '9' then '3'
		                                                                                 else '4'
		                                                  end
		                                               || a.BSIS_CMMD_PLAC_CD
		                                               || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
		                                               || rpad(a.MDPR_CD,10,' ')
		                                               || lpad(to_char(a.ORDR_SNO), 10, '0')
		                     /* 그 외 : 현재는 없음 */
		                                          else   lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
		                                               || rpad(k.ABRV_DPRT_CD, 7,'0' )
		                                               || lpad(to_char(j.PTRM_NO) ,5, '0')
		                                               || f.PTNT_NM
		                                               || e.PTNO
		                                               || to_char(a.ORDR_YMD, 'yyyymmdd')
		                                               || a.MDTN_LCDV_CD
		                                               || a.MDTN_NO_DVSN_CD
		                                               || lpad(to_char(a.MDTN_NO), 4, '0')
		                                               || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		                                                       when a.MDPR_CLSF_CD = '3' then '3'
		                                                                                 else '1'
		                                                  end
		                                               || case when a.DRAP_DVSN_CD = '1' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		                                                       when a.DRAP_DVSN_CD = '3' then '2'
		                                                       when a.DRAP_DVSN_CD = '9' then '3'
		                                                                                 else '4'
		                                                  end
		                                               || case when b.KPNG_PLAC_CD = '1' then '1' /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
		                                                       when b.KPNG_PLAC_CD = '3' then '1'
		                                                       when b.KPNG_PLAC_CD = '7' then '1'
		                                                                                 else '2'
		                                                  end
		                                               || a.BSIS_CMMD_PLAC_CD
		                                               || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
		                                               || rpad(a.MDPR_CD,10,' ')
		                                               || lpad(to_char(a.ORDR_SNO), 10, '0')
		                end as orderkey
		              , (select nvl(sum(t.RTRN_CNFR_CQY),0)
		              	   from SDJDGRTNT t
		                  where t.ORDR_YMD        = e.ORDR_YMD
		                    and t.MDTN_NO_DVSN_CD = e.MDTN_NO_DVSN_CD
		                    and t.MDTN_NO         = e.MDTN_NO
		                    and t.MDTN_LCDV_CD    = e.MDTN_LCDV_CD
		                    and t.ORDR_SNO        = a.ORDR_SNO
		                    and t.MDPR_CD         = a.MDPR_CD
		                    and nvl(t.MDPR_RTRN_NTM, -1) != 0
		                )                                                    as RTRN_CNFR_CQY                
		           from SDPORDDET a
		              , SDDDGCDMT b /* 약품코드 */
		              , SDDMETCDT c /* 약품용법코드관리 */
		              , SDPORDBAT e /* 처방조제기본 */
		              , APPTPTNTV f /* 환자Master View */
		              , MDMEDORDT h /* 약처방 */
		              , APRCRPTNT j /* 진료접수 */
		              , HZDEPTMMT k /* 조직Master I/F(MDM연계) */
		              , SDJDGRTNT l /* 처방성약품반납 */
		          where
		]]>
		            <choose>
		              <when test='inqrDvsnCd=="1"'>
		                a.ORDR_YMD between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                               and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		              </when>
		              <when test='inqrDvsnCd=="2"'>
		<![CDATA[              
		                a.ORDR_YMD = to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		            and e.ORDR_DT >= to_date(#{inqrStrtDt}, 'yyyymmddhh24miss') 
		            and e.ORDR_DT  < to_date(#{inqrFnshDt}, 'yyyymmddhh24miss')
		]]>            
		              </when>
		              <otherwise>
		                a.ORDR_YMD between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                               and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		              </otherwise>
		            </choose>
		<![CDATA[
		            and a.MDTN_LCDV_CD    = case when (#{mdtnLcdvCd} is null) or
		                                              (#{mdtnLcdvCd} = '')    or
		                                              (#{mdtnLcdvCd} = 'A')   then a.MDTN_LCDV_CD
		                                                                      else #{mdtnLcdvCd}
		                                    end
		            and instr(#{afiMdtnNoDvsnNm}, a.MDTN_NO_DVSN_CD) > 0
		            and a.MDTN_NO between #{mdtnNo1} and  #{mdtnNo2}
		            and a.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then a.PHDP_CMMD_BNDL_NO
		                                                                              else #{phdpCmmdBndlNo}     /* RP */
		                                      end
		            and a.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
		            and a.MDPR_CD = nvl(#{mdprCd}, a.MDPR_CD)
		            and (
		                    (nvl(#{rePrintYn}, 'Y') = 'N' and a.PRIN_DT is null  and a.MDPR_TKVR_DT is null) or /*중복출력방지*/
		                    (nvl(#{rePrintYn}, 'Y') = 'Y' and nvl(a.TKVR_PRSG_DVSN_CD,  '*') = nvl(#{tkvrPrsgDvsnCd}, decode(a.TKVR_PRSG_DVSN_CD,  null, '*', a.TKVR_PRSG_DVSN_CD)))     /*중복출력허용*/
		                 )
		            and (
		                  (#{dvsnNm}  = '4'   and a.ORDR_SNO = #{ordrSno}) or
		                  (#{dvsnNm} != '4'   and (
		                                            (#{mdprClsfNm} = '1'  and a.MDPR_CLSF_CD not in ('2', '3')) or /* 일반의약품 */
		                                            (#{mdprClsfNm} = '2'  and a.MDPR_CLSF_CD      =  '2'      ) or /* 향정신성의약품 */
		                                            (#{mdprClsfNm} = '3'  and a.MDPR_CLSF_CD      =  '3'      ) or /* 마약 */
		                                            (#{mdprClsfNm} = '12' and a.MDPR_CLSF_CD     !=  '3'      ) or /* 일반의약품 + 향정신성의약품 */
		                                            (#{mdprClsfNm} = '23' and a.MDPR_CLSF_CD     in ('2', '3')) or /* 향정신성의약품 + 마약 */
		                                            (#{mdprClsfNm} = '13' and a.MDPR_CLSF_CD     !=  '2'      ) or /* 일반의약품 + 마약 */
		                                            (#{mdprClsfNm} = '123')
		                                          )
		                                      /* 7 주사제, 8 무균제(기타)MIX, 9 항생제MIX, A 마약조제, B 항암제MIX */
		                                      and (
		                                            (#{dvsnNm} = '1' and a.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', 'A')  and a.DRAP_DVSN_CD in ('1', '3', '9')                        ) or /* 봉투     afiBsisCmmdPlacNm = 123456A */
		                                            (#{dvsnNm} = '2' and ( (a.BSIS_CMMD_PLAC_CD = '7') or (a.BSIS_CMMD_PLAC_CD = 'A' and a.DRAP_DVSN_CD  = '2') )                                 ) or /* 주사라벨 afiBsisCmmdPlacNm = 7, A */
		                                            (#{dvsnNm} = '3' and a.BSIS_CMMD_PLAC_CD  = '4'                                  and a.DRAP_DVSN_CD  = '1' and b.DGFR_CD in ('10', '11', '32'))   or  /* 시럽     afiBsisCmmdPlacNm = 4 */
		                                            (#{dvsnNm} = '5' and a.DRAP_DVSN_CD  = '3')      /* 외용약 */
		                                          )
		                                      /* 입원환자만 병동 주사묶음에서 수액은 전체 제거 : SDG204F1 */
		                                      and case when #{dvsnNm} = '2' and a.MDTN_NO_DVSN_CD in ('A', 'B', 'E') and (b.STST_DVSN_CD = '5' or b.MDPR_CLSF_DETL_CD = '10') then 'N'
		                                                                                                                                      else 'Y'
		                                          end = 'Y'
		                                      and instr(#{afiBsisCmmdPlacNm}, a.BSIS_CMMD_PLAC_CD) > 0
		                                      and a.INJC_PLAC_CD                = nvl(#{injcPlacCd}, a.INJC_PLAC_CD)
		                                      /*--------------------------------------------------------------------------------------------------------------*/
		                                      and (
		                                            (nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1') 
		                                         or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and
		                                             #{dvsnNm} = '2'                                      and
		                                             a.MDTN_NO_DVSN_CD in ('O', 'Z')                      and
		                                             nvl(a.RCPC_YN, 'N') in ('Y', 'W') /* W : 인공신장 */ and
		                                             nvl(a.WARD_LABL_PRIN_YN, 'N') = nvl(#{wardLablPrinYn}, nvl(a.WARD_LABL_PRIN_YN, 'N'))
		                                            )
		                                         or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and 
		                                             a.MDTN_NO_DVSN_CD not in ('O', 'Z')                  and
		                                             nvl(a.WARD_LABL_PRIN_YN, 'N') = nvl(#{wardLablPrinYn}, nvl(a.WARD_LABL_PRIN_YN, 'N'))
		                                            )
		                                          )
		                                      /*--------------------------------------------------------------------------------------------------------------*/            
		                                      /* 외래(OZ) 주사는 자가주사 제외 */
		                                      /* and (a.MDTN_NO_DVSN_CD in ('O', 'Z') and a.BSIS_CMMD_PLAC_CD = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') != 'Y') */
		                                      and  (case when a.MDTN_NO_DVSN_CD in ('O', 'Z') and a.BSIS_CMMD_PLAC_CD = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') = 'Y' then 'N'
		                                                                                                                                                            else 'Y'
		                                            end) = 'Y'
		                                      and nvl(a.DRUS_CD, 'X') != 'SAVE' /* SAVE 단독처방 제외 */
		                                      /* 출고여부 nvl(b.RELS_YN, 'N') = 'Y'
		                                      SDC703F1 전체                                출고여부체크 X
		                                      SDG205F1 병동MIX                             출고여부체크 X
		                                      SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		                                      SDG101F1 MIX                                 출고여부체크 X
		                                      */
		                                      and ( /* SDC703F1 전체                                출고여부체크 X */
		                                            ( ( a.MDTN_NO_DVSN_CD       in ('O', 'Z', 'D', 'F', 'P', 'Q', 'T', 'G', 'H'))  and
		                                              ( ( a.BSIS_CMMD_PLAC_CD   in ('1', '2', '3', '4', '5', '6')              )  or
		                                                ( a.BSIS_CMMD_PLAC_CD    = 'A' and a.DRAP_DVSN_CD               != '2' )  or /* 마약은 주사 제외 */
		                                                ( a.BSIS_CMMD_PLAC_CD    = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                              )                                                                                                  ) or
		                                            /* MIX */
		                                            (instr('89B', a.BSIS_CMMD_PLAC_CD) > 0                                                               ) or
		                                            /* 그 외는 출고여부체크 */
		                                            (nvl(b.RELS_YN, 'N') = 'Y'                                                                           )
		                                          )
		                  )         
		                )
		            /* 그 외 SDPORDDEV에 조건은 봉투라벨과 무의미 하여 삭제 */
		            and b.MDPR_CD = a.MDPR_CD            
		            and c.DRUS_CD(+)       = a.DRUS_CD
		            and e.ORDR_YMD         = a.ORDR_YMD
		            and e.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		            and e.MDTN_NO          = a.MDTN_NO
		            and e.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		            and e.WARD_CD          = nvl(#{wardCd}, e.WARD_CD)
		            and ( 
		                  (#{dvsnCd9} is null                                    ) or                   
		                  (#{dvsnCd9} = 'R' and b.KPNG_PLAC_CD in ('1', '7')/*냉장 -  SD035F2*/    ) or                   
		                  (#{dvsnCd9} = 'N' and nvl(   (select 'Y'
		                                                         from SDMCTRLMT z
		                                                        where z.PHRM_CTRL_CD = 'SD089'
		                                                          and z.PHRM_DTLS_CTRL_CD = a.MDPR_CD 
		                                                          and rownum = 1
		                                                        )
		                                                    , 'N') = 'Y'  /*영양수액 - SD035F2 */                                  
		                  ) or                   
		                  (#{dvsnCd9} is not null and trunc(e.RPTN_DT) = trunc(sysdate))
		                )                 
		            and f.PTNO             = a.PTNO
		            and h.PTNO             = a.PTNO
		            and h.ORDR_YMD         = a.ORDR_YMD
		            and h.ORDR_SNO         = a.ORDR_SNO
		            and j.MDRP_NO          = h.MDRP_NO
		            /* 조제정보 생성 전 반납*/
		            and nvl((select /*+ index ( a1 mdmedordt_pk )
		                                index ( b1 sdjdgrtnt_pk ) */
		                            'Y'
		                       from
		                            MDMEDORDT a1,
		                            SDJDGRTNT b1
		                      where
		                            a1.PTNO     = a.PTNO
		                        and a1.ORDR_YMD = a.ORDR_YMD
		                        and a1.ORDR_SNO = a.ORDR_SNO
		                        and a1.DRUG_ORDR_PRSS_CD <> '0'
		                        and (nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                        and a1.ORDR_YMD = b1.ORDR_YMD
		                        and a1.PTNO = b1.PTNO
		                        and a1.ORDR_SNO = b1.ORDR_SNO
		                        and b1.DRUG_RTRE_CD = '7'
		                        and rownum = 1
		                   ), 'N') <> 'Y'
		            /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
		            and ( ( nvl(#{afiOrdrSnoStr}, 'X') != 'R')                              or
		                  ( nvl(#{afiOrdrSnoStr}, 'X' ) = 'R'                               and
		                    a.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
		                    not exists ( select  'Y'
		                                   from  SDJDGRTNT s
		                                  where  s.ORDR_YMD        = e.ORDR_YMD
		                                    and  s.MDTN_NO_DVSN_CD = e.MDTN_NO_DVSN_CD
		                                    and  s.MDTN_NO         = e.MDTN_NO
		                                    and  s.MDTN_LCDV_CD    = e.MDTN_LCDV_CD
		                                    and  s.ORDR_SNO    = a.ORDR_SNO
		                                    and  s.MDPR_CD     = a.MDPR_CD
		                                    and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                                    and  a.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
		                                                               from  SDJDGRTNT t
		                                                              where  s.ORDR_YMD         = t.ORDR_YMD
		                                                                and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
		                                                                and  s.MDTN_NO          = t.MDTN_NO
		                                                                and  s.ORDR_SNO         = t.ORDR_SNO
		                                                                and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
		                                                                and  s.MDPR_CD          = t.MDPR_CD
		                                                                and  t.RTRN_DETL_DVSN_CD != 'Z' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		                                                                and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
		                               )
		                  )
		                )
		            /* 부서비품정수약품관리 : 정수는 정수 List 로 주기 때문에 제외 대상으로 둔다 */
		            and not exists (select 1
		                              from SDJFIXQTT l
		                             where l.DPRT_CD = a.INJC_PLAC_CD
		                               and l.MDPR_CD = a.MDPR_CD
		                               and l.EQPT_FDNO_DVSN_CD = '2')
		            and k.DPRT_CD (+)= e.WARD_CD
		            and l.ORDR_YMD(+)               = a.ORDR_YMD
		            and l.MDTN_NO_DVSN_CD(+)  = a.MDTN_NO_DVSN_CD
		            and l.MDTN_NO(+)                = a.MDTN_NO
		            and l.ORDR_SNO(+)               = a.ORDR_SNO
		            and l.MDTN_LCDV_CD(+)        = a.MDTN_LCDV_CD
		            and l.MDPR_CD(+)                = a.MDPR_CD
		            and l.RTRN_DETL_DVSN_CD(+) != 'Z' 
		/*            and l.RTRN_DETL_DVSN_CD(+) = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		      ) a
		 order
		    by a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_NO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinSum1-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="wardCd" column="WARD_CD"/>
		<result property="etcCtn" column="ETC_CTN"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="etcCtn1" column="ETC_CTN_1"/>
		<result property="etcCtn2" column="ETC_CTN_2"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mdprLctnCd" column="MDPR_LCTN_CD"/>
		<result property="mdprLctnNm" column="MDPR_LCTN_NM"/>
		<result property="mdprNtrtFlud" column="MDPR_NTRT_FLUD"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="rtrnRqstCqy" column="RTRN_RQST_CQY"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinSum1 () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinSum1-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinSum1"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinSum1-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinSum1 */
		<![CDATA[
		select 
		                a.WARD_CD                                       as WARD_CD
		              , a.ETC_CTN                                       as ETC_CTN
		              , a.MDPR_CD                                       as MDPR_CD
		              , FN_SD_GETHGCTMDPRNM_S(a.MDPR_CD,a.SMRY_MDPR_NM) as SMRY_MDPR_NM
		              , a.ETC_CTN_1                                     as ETC_CTN_1
		              , a.ETC_CTN_2                                     as ETC_CTN_2
		              , a.KPNG_PLAC_CD                                  as KPNG_PLAC_CD
		              , a.INVN_TOTL_QTY                                 as INVN_TOTL_QTY
		              , a.MDPR_LCTN_CD                                  as MDPR_LCTN_CD
		              , a.MDPR_LCTN_NM                                  as MDPR_LCTN_NM
		              , a.MDPR_NTRT_FLUD                                as MDPR_NTRT_FLUD
		              , a.INQR_DVSN_CD                                  as INQR_DVSN_CD
		              , a.INPT_CLNT_PRGM_ID                             as INPT_CLNT_PRGM_ID
		              , a.ORDR_YMD
		              , a.ABRV_DPRT_CD
		              , a.RTRN_RQST_CQY
		         from (
		       select
		               e.WARD_CD                                                       as WARD_CD
		            ,  (select DETL_CD_NM from CCCMCDDMT where COMN_GRP_CD = 'SD004' and COMN_DTLS_CD = a.BSIS_CMMD_PLAC_CD) as ETC_CTN
		            ,  a.MDPR_CD                                                       as MDPR_CD
		            /* ,  d.MDPR_NM                                                       as MDPR_NM */
		            ,  b.SMRY_MDPR_NM                     as SMRY_MDPR_NM
		            ,  b.HGRS_HGCC_MDPR_YN
		            ,  case when b.HGRS_HGCC_MDPR_YN != '' then (select DETL_CD_NM from CCCMCDDMT where COMN_GRP_CD = 'SD997' and COMN_DTLS_CD = b.HGRS_HGCC_MDPR_YN) else '' end as ETC_CTN_1
		            ,  b.KPNG_PLAC_CD
		            ,  case when b.KPNG_PLAC_CD != '' then (select DETL_CD_NM from CCCMCDDMT where COMN_GRP_CD = 'SD003' and COMN_DTLS_CD = b.KPNG_PLAC_CD) else '' end as ETC_CTN_2
		            ,  sum(a.INVN_TOTL_QTY)                                            as INVN_TOTL_QTY
					, b.MDPR_LCTN_CD                                       as MDPR_LCTN_CD        /* 약국내보관장소코드 */
		                    , (select PHRM_DTLS_CTRL_NM
		                        from SDMCTRLMT z001 
		                            where PHRM_CTRL_CD ='SD330'
		                            and z001.PHRM_DTLS_CTRL_CD = b.MDPR_LCTN_CD
		                        ) as MDPR_LCTN_NM                                                           /* 약국내보관장소이름 */
		           , case when a.MDPR_CD in ( select PHRM_DTLS_CTRL_CD form from SDMCTRLMT z001 where PHRM_CTRL_CD ='SD089')
		             then 'Z'
		             else 'A'
		             end
		             as MDPR_NTRT_FLUD    /* 영양수액 가장 마지막으로 오게 하기 위한 조회 */
		            , #{inqrDvsnCd}                                                    as INQR_DVSN_CD
		            , #{inptClntPrgmId}                                                as INPT_CLNT_PRGM_ID
		            , to_char(a.ORDR_YMD, 'yyyymmdd') as ORDR_YMD
		            , k.ABRV_DPRT_CD
		            , sum(l.RTRN_RQST_CQY) as RTRN_RQST_CQY
		           from SDPORDDET a
		              , SDDDGCDMT b /* 약품코드 */
		              , SDDMETCDT c /* 약품용법코드관리 */
		              , SDPORDBAT e /* 처방조제기본 */
		              , APPTPTNTV f /* 환자Master View */
		              , MDMEDORDT h /* 약처방 */
		              , APRCRPTNT j /* 진료접수 */
		              , HZDEPTMMT k /* 조직Master I/F(MDM연계) */
		              , SDJDGRTNT l /* 처방성약품반납 */
		          where
		]]>
		            <choose>
		              <when test='inqrDvsnCd=="1"'>
		                a.ORDR_YMD between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                               and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		              </when>
		              <when test='inqrDvsnCd=="2"'>
		<![CDATA[              
		                a.ORDR_YMD = to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		            and e.ORDR_DT >= to_date(#{inqrStrtDt}, 'yyyymmddhh24miss') 
		            and e.ORDR_DT  < to_date(#{inqrFnshDt}, 'yyyymmddhh24miss')
		]]>                
		              </when>
		              <otherwise>
		                a.ORDR_YMD between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                               and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		              </otherwise>
		            </choose>
		<![CDATA[
		            and a.MDTN_LCDV_CD    = case when (#{mdtnLcdvCd} is null) or
		                                              (#{mdtnLcdvCd} = '')    or
		                                              (#{mdtnLcdvCd} = 'A')   then a.MDTN_LCDV_CD
		                                                                      else #{mdtnLcdvCd}
		                                    end
		            and instr(#{afiMdtnNoDvsnNm}, a.MDTN_NO_DVSN_CD) > 0
		            and a.MDTN_NO between #{mdtnNo1} and  #{mdtnNo2}
		            and a.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then a.PHDP_CMMD_BNDL_NO
		                                                                              else #{phdpCmmdBndlNo}     /* RP */
		                                      end
		            and a.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
		            and a.MDPR_CD = nvl(#{mdprCd}, a.MDPR_CD)
		            and (
		                    (nvl(#{rePrintYn}, 'Y') = 'N' and a.PRIN_DT is null  and a.MDPR_TKVR_DT is null) or /*중복출력방지*/
		                    (nvl(#{rePrintYn}, 'Y') = 'Y' and nvl(a.TKVR_PRSG_DVSN_CD,  '*') = nvl(#{tkvrPrsgDvsnCd}, decode(a.TKVR_PRSG_DVSN_CD,  null, '*', a.TKVR_PRSG_DVSN_CD)))     /*중복출력허용*/
		                 )
		            and (
		                  (#{mdprClsfNm} = '1'  and a.MDPR_CLSF_CD not in ('2', '3')) or /* 일반의약품 */
		                  (#{mdprClsfNm} = '2'  and a.MDPR_CLSF_CD      =  '2'      ) or /* 향정신성의약품 */
		                  (#{mdprClsfNm} = '3'  and a.MDPR_CLSF_CD      =  '3'      ) or /* 마약 */
		                  (#{mdprClsfNm} = '12' and a.MDPR_CLSF_CD     !=  '3'      ) or /* 일반의약품 + 향정신성의약품 */
		                  (#{mdprClsfNm} = '23' and a.MDPR_CLSF_CD     in ('2', '3')) or /* 향정신성의약품 + 마약 */
		                  (#{mdprClsfNm} = '13' and a.MDPR_CLSF_CD     !=  '2'      ) or /* 일반의약품 + 마약 */
		                  (#{mdprClsfNm} = '123')
		                )
		            /* 7 주사제, 8 무균제(기타)MIX, 9 항생제MIX, A 마약조제, B 항암제MIX */
		            and (
		                  (#{dvsnNm} = '1' and a.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', 'A')  and a.DRAP_DVSN_CD in ('1', '3', '9')                        ) or /* 봉투     afiBsisCmmdPlacNm = 123456A */
		                  (#{dvsnNm} = '2' and ( (a.BSIS_CMMD_PLAC_CD = '7') or (a.BSIS_CMMD_PLAC_CD = 'A' and a.DRAP_DVSN_CD  = '2') )                                 ) or /* 주사라벨 afiBsisCmmdPlacNm = 7, A */
		                  (#{dvsnNm} = '3' and a.BSIS_CMMD_PLAC_CD  = '4'                                  and a.DRAP_DVSN_CD  = '1' and b.DGFR_CD in ('10', '11', '32')) or   /* 시럽     afiBsisCmmdPlacNm = 4 */
		                  (#{dvsnNm} = '5' and a.DRAP_DVSN_CD  = '3')      /* 외용약 */
		                )
		            /* 입원환자만 병동 주사묶음에서 수액은 전체 제거 : SDG204F1 */
		            and case when #{dvsnNm} = '2' and a.MDTN_NO_DVSN_CD in ('A', 'B', 'E') and b.STST_DVSN_CD = '5' or b.MDPR_CLSF_DETL_CD = '10' then 'N'
		                                                                                                        else 'Y'
		            end = 'Y'
		            and instr(#{afiBsisCmmdPlacNm}, a.BSIS_CMMD_PLAC_CD) > 0
		            and a.INJC_PLAC_CD                = nvl(#{injcPlacCd}, a.INJC_PLAC_CD)
		            /*--------------------------------------------------------------------------------------------------------------*/
		            and (
		                  (nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1') 
		               or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and
		                   #{dvsnNm} = '2'                                      and
		                   a.MDTN_NO_DVSN_CD in ('O', 'Z')                      and
		                   nvl(a.RCPC_YN, 'N') in ('Y', 'W') /* W : 인공신장 */ and
		                   nvl(a.WARD_LABL_PRIN_YN, 'N') = nvl(#{wardLablPrinYn}, nvl(a.WARD_LABL_PRIN_YN, 'N'))
		                  )
		               or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and
		                   a.MDTN_NO_DVSN_CD not in ('O', 'Z')                  and
		                   nvl(a.WARD_LABL_PRIN_YN, 'N') = nvl(#{wardLablPrinYn}, nvl(a.WARD_LABL_PRIN_YN, 'N'))
		                  )
		                )
		            /*--------------------------------------------------------------------------------------------------------------*/
		            and nvl(a.DRUS_CD, 'X') != 'SAVE' /* SAVE 단독처방 제외 */
		            /* 외래(OZ) 주사는 자가주사 제외 */
		            /* and (a.MDTN_NO_DVSN_CD in ('O', 'Z') and a.BSIS_CMMD_PLAC_CD = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') != 'Y') */
		            and  (case when a.MDTN_NO_DVSN_CD in ('O', 'Z') and a.BSIS_CMMD_PLAC_CD = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') = 'Y' then 'N'
		                                                                                                                                  else 'Y'
		                  end) = 'Y'
		            /* 그 외 SDPORDDEV에 조건은 봉투라벨과 무의미 하여 삭제 */
		            and b.MDPR_CD = a.MDPR_CD
		            /* 출고여부 nvl(b.RELS_YN, 'N') = 'Y'
		            SDC703F1 전체                                출고여부체크 X
		            SDG205F1 병동MIX                             출고여부체크 X
		            SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		            SDG101F1 MIX                                 출고여부체크 X
		            */
		            and nvl(b.RELS_YN, 'N') = 'Y'
		            and c.DRUS_CD(+)       = a.DRUS_CD
		            and e.ORDR_YMD         = a.ORDR_YMD
		            and e.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		            and e.MDTN_NO          = a.MDTN_NO
		            and e.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		            and e.WARD_CD          = nvl(#{wardCd}, e.WARD_CD)
		            and ( 
		                  (#{dvsnCd9} is null                                    ) or                   
		                  (#{dvsnCd9} = 'R' and b.KPNG_PLAC_CD = '1'/*냉장 -  SD035F2*/    ) or                   
		                  (#{dvsnCd9} = 'N' and nvl(   (select 'Y'
		                                                         from SDMCTRLMT z
		                                                        where z.PHRM_CTRL_CD = 'SD089'
		                                                          and z.PHRM_DTLS_CTRL_CD = a.MDPR_CD 
		                                                          and rownum = 1
		                                                        )
		                                                    , 'N') = 'Y'  /*영양수액 - SD035F2 */                                  
		                  ) or                   
		                  (#{dvsnCd9} is not null and trunc(e.RPTN_DT) = trunc(sysdate))
		                )       
		            and f.PTNO             = a.PTNO
		            and h.PTNO             = a.PTNO
		            and h.ORDR_YMD         = a.ORDR_YMD
		            and h.ORDR_SNO         = a.ORDR_SNO
		            and j.MDRP_NO          = h.MDRP_NO
		            /* 조제정보 생성 전 반납*/
		            and nvl((select /*+ index ( a1 mdmedordt_pk )
		                                index ( b1 sdjdgrtnt_pk ) */
		                            'Y'
		                       from
		                            MDMEDORDT a1,
		                            SDJDGRTNT b1
		                      where
		                            a1.PTNO     = a.PTNO
		                        and a1.ORDR_YMD = a.ORDR_YMD
		                        and a1.ORDR_SNO = a.ORDR_SNO
		                        and a1.DRUG_ORDR_PRSS_CD <> '0'
		                        and (nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                        and a1.ORDR_YMD = b1.ORDR_YMD
		                        and a1.PTNO = b1.PTNO
		                        and a1.ORDR_SNO = b1.ORDR_SNO
		                        and b1.DRUG_RTRE_CD = '7'
		                        and rownum = 1
		                   ), 'N') <> 'Y'
		            /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
		            and ( ( nvl(#{afiOrdrSnoStr}, 'X') != 'R')                              or
		                  ( nvl(#{afiOrdrSnoStr}, 'X' ) = 'R'                               and
		                    a.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
		                    not exists ( select  'Y'
		                                   from  SDJDGRTNT s
		                                  where  s.ORDR_YMD        = e.ORDR_YMD
		                                    and  s.MDTN_NO_DVSN_CD = e.MDTN_NO_DVSN_CD
		                                    and  s.MDTN_NO         = e.MDTN_NO
		                                    and  s.MDTN_LCDV_CD    = e.MDTN_LCDV_CD
		                                    and  s.ORDR_SNO    = a.ORDR_SNO
		                                    and  s.MDPR_CD     = a.MDPR_CD
		                                    and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                                    and  a.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
		                                                               from  SDJDGRTNT t
		                                                              where  s.ORDR_YMD         = t.ORDR_YMD
		                                                                and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
		                                                                and  s.MDTN_NO          = t.MDTN_NO
		                                                                and  s.ORDR_SNO         = t.ORDR_SNO
		                                                                and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
		                                                                and  s.MDPR_CD          = t.MDPR_CD
		                                                                and  t.RTRN_DETL_DVSN_CD != 'Z' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		                                                                and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
		                               ) and
		                    /* 정규처방중 반납확인된 처방은 조회하지 않는다. */
		                    not exists ( select  'Y'
		                                   from  SDJDGRTNT s
		                                  where  s.ORDR_YMD        = e.ORDR_YMD
		                                    and  s.MDTN_NO_DVSN_CD = e.MDTN_NO_DVSN_CD
		                                    and  s.MDTN_NO_DVSN_CD = 'A'
		                                    and  s.MDTN_NO         = e.MDTN_NO
		                                    and  s.MDTN_LCDV_CD    = e.MDTN_LCDV_CD
		                                    and  s.ORDR_SNO    = a.ORDR_SNO
		                                    and  s.MDPR_CD     = a.MDPR_CD
		                                    and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                                    and  nvl(s.RTRN_CNFR_CQY,0) > 0
		                               )                               
		                  )
		                )
		            /* 부서비품정수약품관리 : 정수는 정수 List 로 주기 때문에 제외 대상으로 둔다 */
		            and not exists (select 1
		                              from SDJFIXQTT l
		                             where l.DPRT_CD = a.INJC_PLAC_CD
		                               and l.MDPR_CD = a.MDPR_CD
		                               and l.EQPT_FDNO_DVSN_CD = '2')
		            and k.DPRT_CD (+)= e.WARD_CD
		            and l.ORDR_YMD(+)               = a.ORDR_YMD
		            and l.MDTN_NO_DVSN_CD(+)  = a.MDTN_NO_DVSN_CD
		            and l.MDTN_NO(+)                = a.MDTN_NO
		            and l.ORDR_SNO(+)               = a.ORDR_SNO
		            and l.MDTN_LCDV_CD(+)        = a.MDTN_LCDV_CD
		            and l.MDPR_CD(+)                = a.MDPR_CD
		            and l.RTRN_DETL_DVSN_CD(+) != 'Z' 
		/*            and l.RTRN_DETL_DVSN_CD(+) = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		     group
		        by
		           k.PHDP_CMMD_SQNC_VL
		        ,  e.WARD_CD
		        ,  e.MDTN_LCDV_CD
		        ,  a.BSIS_CMMD_PLAC_CD
		        ,  a.MDPR_CD
		        ,  SMRY_MDPR_NM
		        ,  b.HGRS_HGCC_MDPR_YN
		        ,  b.KPNG_PLAC_CD
				,  b.MDPR_LCTN_CD
		        ,  a.ORDR_YMD
		        ,  k.ABRV_DPRT_CD
		     order
		        by a.ORDR_YMD 
		        , e.WARD_CD
		        , b.MDPR_LCTN_CD
				, SMRY_MDPR_NM
				, MDPR_NTRT_FLUD
				, to_number(MDPR_LCTN_CD)
		         , decode(e.MDTN_LCDV_CD, 'M', decode(a.BSIS_CMMD_PLAC_CD, '7', '4'
		                                                                 , '8', '5'
		                                                                 , '9', '6'
		                                                                 , 'B', '7', '4')
		                                     , decode(a.BSIS_CMMD_PLAC_CD, '7', '0'
		                                                                 , '8', '1'
		                                                                 , '9', '2'
		                                                                 , 'B', '3', '0'))
				, SMRY_MDPR_NM
		       , a.MDPR_CD
		) a
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcOrdrPrtxShet-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="afiNrdrCct" column="AFI_NRDR_CCT"/>
		<result property="afiDgstItrcNm" column="AFI_DGST_ITRC_NM"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="nextMdcrYmd" column="NEXT_MDCR_YMD"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="tkmdCcfeYn" column="TKMD_CCFE_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="afiInjcPlacNm" column="AFI_INJC_PLAC_NM"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="newYn" column="NEW_YN"/>
		<result property="afiOrocNm" column="AFI_OROC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="adrItrcMemoCtn" column="ADR_ITRC_MEMO_CTN"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcOrdrPrtxShet () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcOrdrPrtxShet-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcOrdrPrtxShet"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcOrdrPrtxShet-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcOrdrPrtxShet */
		<![CDATA[
		select  /*+ sdd_pordbat_l88$S01_외래처방전 조회 */
		            to_char(a.ORDR_YMD, 'yyyymmdd')   as ORDR_YMD                                  /* 처방일자     */
		         ,  a.MDTN_LCDV_CD                    as MDTN_LCDV_CD
		         ,  a.MDTN_NO_DVSN_CD                 as MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  a.MDTN_NO                         as MDTN_NO          /* 투약번호     */
		         ,  (
		                select  /*+ ordered use_nl(y z) index_rs(z SDPORDDET_I11) */
		                        nvl(max(z.MDTN_NO), 0)  MDTN_NO
		                  from
		                        SDPORDBAT y
		                     ,  SDPORDDET z
		                 where  y.ORDR_YMD         = a.ORDR_YMD
		                   and  y.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		                   and  y.PTNO             = a.PTNO
		                   and  y.MDTN_NO          < a.MDTN_NO
		                   and  y.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		                   and  y.MCDP_CD          = a.MCDP_CD
		                   and  y.PHDP_OROC_DPRT_CD          = a.PHDP_OROC_DPRT_CD
		                   and  y.GNDR_ID          = a.GNDR_ID
		                   and  y.CMMD_CMBN_CTN is not null
		                   and  y.MDTN_NO >   (
		                                select
		                                        nvl(max(v.MDTN_NO), 0)  MDTN_NO
		                                  from
		                                        SDPORDBAT v
		                                 where  v.ORDR_YMD        = y.ORDR_YMD
		                                   and  v.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                                   and  v.PTNO    = y.PTNO
		                                   and  v.MCDP_CD = y.MCDP_CD
		                                   and  v.PHDP_OROC_DPRT_CD = y.PHDP_OROC_DPRT_CD
		                                   and  v.GNDR_ID = y.GNDR_ID
		                                   and  v.DRUG_PRSS_CD > '0'
		                                   and  v.DRUG_INJC_DVSN_CD in ('1', '2')
		                                   and  v.MDTN_NO < a.MDTN_NO
		                                   and  v.RCPC_YN = 'Y'
		                         )
		                   and  z.ORDR_YMD        = y.ORDR_YMD
		                   and  z.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                   and  z.MDTN_NO         = y.MDTN_NO
		                   and  z.MDTN_LCDV_CD    = y.MDTN_LCDV_CD
		                   and  instr(#{afiBsisCmmdPlacNm}, z.BSIS_CMMD_PLAC_CD) > 0
		                   and  z.PRIN_DT is not null
		             )       BEMD_NO                                      /* 수정전번호   */
		         ,  a.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'-'||trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12))   AFI_AGE_VL_STR    /* 나이 */
		         ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)    as BDWG_VL      /* 몸무게 */
		         , a.WARD_CD                                                                  as WARD_CD        /* 병동코드 */
		         , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD) as ABRV_DPRT_CD_1 /* 병동코드명 */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		         ,  a.MCDP_CD                                             /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  a.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                             /* 처방의명     */
		         ,  (
		                select
		                        x.SCIN_CD||'('||x.SCIN_NM||')'
		                  from
		                        MDPADIAGT x
		                 where  x.MDRP_NO = b.MDRP_NO
		                   and  (
		                             (a.MDTN_NO_DVSN_CD = 'G')
		                       /*   or
		                             (a.MDTN_NO_DVSN_CD = 'T') */
		                          or
		                             (a.MDTN_NO_DVSN_CD in ('O', 'Z') and  x.MCDP_CD = a.MCDP_CD)
		                        )
		                   and  x.MAIN_SCIN_YN = 'Y'
		                   and  a.GNDR_ID  = decode( sign( a.MDCR_YMD - to_date( #{baseYmd}, 'yyyymmdd'))
		                                                            , -1 , a.GNDR_ID
		                                                                  , decode( a.PTDV_CD, 'O', x.CHDR_ID , a.GNDR_ID)
		                                            )           /* MultiMainDiag  */
		                   and  rownum < 2
		             )      SCIN_NM                                /* 상병명       */
		         ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		         ,  (
		                select  /*+ index_rs(x SDPORDDET_I11) */
		                        decode(count(x.MDPR_CD), 1, 'Y', 'N')
		                  from
		                        SDPORDDET x
		                 where  x.ORDR_YMD        = a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_NO         = a.MDTN_NO
		                   and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                   and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		                   and  x.MDPR_CLSF_CD = '3'
		                   and  rownum < 2
		             )     NRDR_YN                                   /* 마약포함여부 */
		         ,  (
		            select  /*+ index_rs(x SDPORDDET_I11) */
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '2'
		               and  rownum < 2
		            )    PSDG_YN                                     /* 향정포함여부 */
		         ,  (
		            select  /*+ ordered use_nl(x y) index_rs(x SDPORDDET_I11) */
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		                 ,  SDDDGCDMT y
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '3'
		               and  y.MDPR_CD = x.MDPR_CD
		               and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		               and  rownum < 2
		             )     CLNC_YN                                     /* 임상포함여부 */
		         ,  a.TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  b.ORDR_SNO                                         /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                          /* 약품코드     */
		         ,  b.MDPR_NM                                          /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  f.ICUN_CD                                          /* 함량단위     */
		         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		         ,  b.MDNT                                             /* 횟수         */
		         ,  b.MDTN_DDCN                                        /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
		         ,  b.DRUS_CD                                          /* 용법         */
		         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN1, g.ENVL_MEMO_CTN3)  as ENVL_MEMO_CTN1
		         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN2, g.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		                                      , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN3
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정' )
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포')),
		                                     ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN4
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 /* 용법Text3    */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4 /* 용법Text4    */
		         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(b.SPSB_CTN, chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                /* 보관장소     */
		         ,  i.DETL_CD_NM                               /* 보관장소명   */
		         ,  (
		                select
		                       '*'
		                  from
		                        SZPATCMMT x                        /* 환자COMMENT    */
		                 where  x.PTNO = a.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   /* and  x.PTNT_CMNT_SNO >= 20001
		                   and  x.PTNT_CMNT_SNO <= 40000 */
		                   and  x.PTNT_CMNT_DVSN_CD in ('21','C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  a.DRUG_INJC_DVSN_CD                                   /* 약주사구분   */
		         ,  (
		            select  /*+ index_rs(x SDPORDDET_I11) */
		                    count(*)
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  x.MDPR_CLSF_CD = '3'
		               and  x.DRAP_DVSN_CD != '2'
		         )        AFI_NRDR_CCT                                /* 마약개수     */
		         ,  '' AFI_DGST_ITRC_NM  /*연령별 처방 제한*/
		         ,  b.DURV_RESN_CTN
		         ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.SMRY_MDPR_NM) as SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  (
		                select
		                        max(to_char(x.ORDR_YMD, 'yyyymmdd')||x.MDTN_NO)
		                  from
		                        SDPORDBAT x
		                 where  x.ORDR_YMD              >= sysdate - 120
		                   and  x.ORDR_YMD              < a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD       = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_LCDV_CD          = a.MDTN_LCDV_CD
		                   and  x.PTNO                  = a.PTNO
		                   and  x.MCDP_CD               = a.MCDP_CD
		                   and  x.DRUG_PRSS_CD          < '6'
		                   and  x.INJC_PRSS_CD          < '6'
		                   and  x.MIX_INJC_PRSS_CD      < '6'
		                   and  x.OTPT_MIX_INJC_PRSS_CD < '6'
		             )      AFI_MDTN_NO_STR           /* 이전 동일과 처방일 */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		         ,  (
		                select
		                        to_char(min(x1.MDCR_YMD), 'yyyymmdd')
		                  from
		                        APRCRPTNT x1
		                 where  x1.PTNO = a.PTNO
		                   and  nvl(x1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                   and  x1.MCDP_CD = a.MCDP_CD
		                   and  x1.MDCR_ANDV_CD not in ('7', '8', '9')
		                   and  x1.MDCR_YMD > a.ORDR_YMD
		             )   NEXT_MDCR_YMD
		         ,  b.DRUG_PRIN_YN
		         ,  (
		                select
		                        decode(count(*), 0, 'Y', 'N')
		                  from
		                        SDODGGUIT x2
		                      , APRCRPTNT x3
		                 where  x2.PTNO = a.PTNO
		                   and  x2.PTDV_CD = 'O'
		                   and  x3.MDRP_NO = x2.MDRP_NO
		                   and  x3.MDCR_DT < a.MDCR_YMD
		                   and  x2.TKMD_CCHN_YMD < a.ORDR_YMD
		             )     TKMD_CCFE_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  a.MCCN_CD
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=b.INJC_PLAC_CD), b.INJC_PLAC_CD) AFI_INJC_PLAC_NM
		         ,  FN_SD_GETAUDFGLIST_S9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD
		                         , #{phdpCmmdBndlNo}, #{afiBsisCmmdPlacNm}, #{drapDvsnCd}
		                               , #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  decode(b.PRTX_RLTN_RESN_VL, 'T', b.PRTX_RLTN_RESN_CTN, k.DETL_CD_NM)   CLMN_NM_1
		         ,  ''   CLMN_NM_2
		         ,  ''   NEW_YN
		         ,  nvl((select m.MDCR_DTLS_CTRL_NM from MZCTRLMMT m where MDCR_CTRL_CD = 'MM184' and m.MDCR_DTLS_CTRL_CD = a.PHDP_OROC_DPRT_CD),'') AFI_OROC_NM
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'')  AFI_CNTR_NM
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCDP_CD),'')  ABRV_DPRT_CD
		         , (select 'Y' as ADR_ITRC_MEMO_CTN from SDCADRPAT a1 where a1.PTNO = a.PTNO and rownum = 1) as ADR_ITRC_MEMO_CTN
		         , #{inqrDvsnCd}                                        as INQR_DVSN_CD
		         , #{inptClntPrgmId}                                    as INPT_CLNT_PRGM_ID
		      from
		            SDPORDBAT a                               /* 약처방내역기본 */
		         ,  (
		            select   /*+ index_rs(b SDPORDDET_I11) */
		                    b.ORDR_YMD
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,d.MDPR_NM)      as MDPR_NM
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.PRTX_RLTN_RESN_VL
		                 ,  h.PRTX_RLTN_RESN_CTN
		                 ,  h.MDRP_NO
		              from SDPORDDET b
		                 , SDDDGCDMT d /* 약품코드 */
		                 , SDDMETCDT c /* 약품용법코드관리 */
		                 , SDPORDBAT a /* 처방조제기본 */
		                 , APPTPTNTV f /* 환자Master View */
		                 , MDMEDORDT h /* 약처방 */
		                 , APRCRPTNT j /* 진료접수 */
		                 , HZDEPTMMT k /* 조직Master I/F(MDM연계) */
		             where
		                   b.ORDR_YMD between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                                  and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		               and b.MDTN_LCDV_CD    = case when (#{mdtnLcdvCd} is null) or
		                                                 (#{mdtnLcdvCd} = '')    or
		                                                 (#{mdtnLcdvCd} = 'A')   then b.MDTN_LCDV_CD
		                                                                         else #{mdtnLcdvCd}
		                                       end
		               and instr(#{afiMdtnNoDvsnNm}, b.MDTN_NO_DVSN_CD) > 0
		               and b.MDTN_NO between #{mdtnNo1} and  #{mdtnNo2}
		               and (
		                    (nvl(#{rePrintYn}, 'Y') = 'N' and b.PRIN_DT is null  and b.MDPR_TKVR_DT is null) or /*중복출력방지*/
		                    (nvl(#{rePrintYn}, 'Y') = 'Y' and nvl(b.TKVR_PRSG_DVSN_CD,  '*') = nvl(#{tkvrPrsgDvsnCd}, decode(b.TKVR_PRSG_DVSN_CD,  null, '*', b.TKVR_PRSG_DVSN_CD)))     /*중복출력허용*/
		                     )
		               and b.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then b.PHDP_CMMD_BNDL_NO
		                                                                                 else #{phdpCmmdBndlNo}     /* RP */
		                                         end
		               and b.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
		               and b.MDPR_CD = nvl(#{mdprCd}, b.MDPR_CD)
		               and (
		                     (#{mdprClsfNm} = '1'  and b.MDPR_CLSF_CD not in ('2', '3')) or /* 일반의약품 */
		                     (#{mdprClsfNm} = '2'  and b.MDPR_CLSF_CD      =  '2'      ) or /* 향정신성의약품 */
		                     (#{mdprClsfNm} = '3'  and b.MDPR_CLSF_CD      =  '3'      ) or /* 마약 */
		                     (#{mdprClsfNm} = '12' and b.MDPR_CLSF_CD     !=  '3'      ) or /* 일반의약품 + 향정신성의약품 */
		                     (#{mdprClsfNm} = '23' and b.MDPR_CLSF_CD     in ('2', '3')) or /* 향정신성의약품 + 마약 */
		                     (#{mdprClsfNm} = '13' and b.MDPR_CLSF_CD     !=  '2'      ) or /* 일반의약품 + 마약 */
		                     (#{mdprClsfNm} = '123')
		                   )
		               /* 7 주사제, 8 무균제(기타)MIX, 9 항생제MIX, A 마약조제, B 항암제MIX */
		               and (
		                     (#{dvsnNm} = '1' and b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', 'A')  and b.DRAP_DVSN_CD in ('1', '3', '9')                        ) or /* 봉투     afiBsisCmmdPlacNm = 123456A */
		                     (#{dvsnNm} = '2' and ( (b.BSIS_CMMD_PLAC_CD = '7') or (b.BSIS_CMMD_PLAC_CD = 'A' and b.DRAP_DVSN_CD  = '2') )                                 ) or /* 주사라벨 afiBsisCmmdPlacNm = 7, A */
		                     (#{dvsnNm} = '3' and b.BSIS_CMMD_PLAC_CD  = '4'                                  and b.DRAP_DVSN_CD  = '1' and d.DGFR_CD in ('10', '11', '32'))    /* 시럽     afiBsisCmmdPlacNm = 4 */
		                   )
		               /* 입원환자만 병동 주사묶음에서 수액은 전체 제거 : SDG204F1 */
		               and case when #{dvsnNm} = '2' and b.MDTN_NO_DVSN_CD in ('A', 'B', 'E') and d.STST_DVSN_CD = '5'  or d.MDPR_CLSF_DETL_CD = '10' then 'N'
		                                                                                                               else 'Y'
		                   end = 'Y'
		               and instr(#{afiBsisCmmdPlacNm}, b.BSIS_CMMD_PLAC_CD) > 0
		               and b.INJC_PLAC_CD                = nvl(#{injcPlacCd}, b.INJC_PLAC_CD)               
		               and nvl(b.DRUS_CD, 'X') != 'SAVE' /* SAVE 단독처방 제외 */
		               /* 외래(OZ) 주사는 자가주사 제외 */
		               /* and (b.MDTN_NO_DVSN_CD in ('O', 'Z') and b.BSIS_CMMD_PLAC_CD = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') != 'Y') */
		               and  (case when b.MDTN_NO_DVSN_CD in ('O', 'Z') and b.BSIS_CMMD_PLAC_CD = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' then 'N'
		                                                                                                                                     else 'Y'
		                     end) = 'Y'
		               /*--------------------------------------------------------------------------------------------------------------*/
		               and (
		                     (nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1') 
		                  or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and 
		                      b.MDTN_NO_DVSN_CD in ('O', 'Z')                     and
		                      nvl(b.RCPC_YN, 'N') in ('Y', 'W') /* W : 인공신장 */  and
		                      nvl(b.WARD_LABL_PRIN_YN, 'N') = 'N'
		                     )
		                  or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and 
		                      b.MDTN_NO_DVSN_CD  = 'I'                            and
		                      nvl(b.WARD_LABL_PRIN_YN, 'N') = 'N'
		                     )
		                 or (nvl('SDC100F1', '********') = 'SDC100F1'     and   /* 자동출력 화면에서 추가/응급 주사 처방전 출력 가능하도록 수정 */
				              b.MDTN_NO_DVSN_CD  in ('B', 'E')           and
				              b.PTNO = nvl(#{ptno}, b.PTNO)                                 and
				              b.ORDR_SNO = nvl(#{ordrSno}, b.ORDR_SNO)                                 and
				              b.PRIN_DT is null
				             )  
		                   )
		               /*--------------------------------------------------------------------------------------------------------------*/
		               /* 그 외 SDPORDDEV에 조건은 봉투라벨과 무의미 하여 삭제 */
		               and d.MDPR_CD = b.MDPR_CD
		               /* 출고여부 nvl(d.RELS_YN, 'N') = 'Y'
		               SDC703F1 전체                                출고여부체크 X
		               SDG205F1 병동MIX                             출고여부체크 X
		               SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		               SDG101F1 MIX                                 출고여부체크 X
		               */
		               and nvl(d.RELS_YN, 'N') = 'Y'
		               and c.DRUS_CD(+)       = b.DRUS_CD
		               and a.ORDR_YMD         = b.ORDR_YMD
		               and a.MDTN_NO_DVSN_CD  = b.MDTN_NO_DVSN_CD
		               and a.MDTN_NO          = b.MDTN_NO
		               and a.MDTN_LCDV_CD     = b.MDTN_LCDV_CD
		               and a.WARD_CD          = nvl(#{wardCd}, a.WARD_CD)
		               and f.PTNO             = b.PTNO
		               and h.PTNO             = b.PTNO
		               and h.ORDR_YMD         = b.ORDR_YMD
		               and h.ORDR_SNO         = b.ORDR_SNO
		               and j.MDRP_NO          = h.MDRP_NO
		               /* 조제정보 생성 전 반납*/
		               and nvl((select /*+ index ( a1 mdmedordt_pk )
		                                   index ( b1 sdjdgrtnt_pk ) */
		                               'Y'
		                          from
		                               MDMEDORDT a1,
		                               SDJDGRTNT b1
		                         where
		                               a1.PTNO     = b.PTNO
		                           and a1.ORDR_YMD = b.ORDR_YMD
		                           and a1.ORDR_SNO = b.ORDR_SNO
		                           and a1.DRUG_ORDR_PRSS_CD <> '0'
		                           and (nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                           and a1.ORDR_YMD = b1.ORDR_YMD
		                           and a1.PTNO = b1.PTNO
		                           and a1.ORDR_SNO = b1.ORDR_SNO
		                           and b1.DRUG_RTRE_CD = '7'
		                           and rownum = 1
		                      ), 'N') <> 'Y'
		               /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
		               and ( ( nvl(#{afiOrdrSnoStr}, 'X') != 'R')                              or
		                     ( nvl(#{afiOrdrSnoStr}, 'X' ) = 'R'                               and
		                       b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
		                       not exists ( select  'Y'
		                                      from  SDJDGRTNT s
		                                     where  s.ORDR_YMD        = a.ORDR_YMD
		                                       and  s.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                                       and  s.MDTN_NO         = a.MDTN_NO
		                                       and  s.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                                       and  s.ORDR_SNO    = b.ORDR_SNO
		                                       and  s.MDPR_CD     = b.MDPR_CD
		                                       and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                                       and  b.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
		                                                                  from  SDJDGRTNT t
		                                                                 where  s.ORDR_YMD         = t.ORDR_YMD
		                                                                   and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
		                                                                   and  s.MDTN_NO          = t.MDTN_NO
		                                                                   and  s.ORDR_SNO         = t.ORDR_SNO
		                                                                   and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
		                                                                   and  s.MDPR_CD          = t.MDPR_CD
		                                                                   and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		                                                                   and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
		                                  )
		                     )
		                   )
		               /* 부서비품정수약품관리 : 정수는 정수 List 로 주기 때문에 제외 대상으로 둔다 */
		               and not exists (select 1
		                                 from SDJFIXQTT l
		                                where l.DPRT_CD = b.INJC_PLAC_CD
		                                  and l.MDPR_CD = b.MDPR_CD
		                                  and l.EQPT_FDNO_DVSN_CD = '2')
		               and k.DPRT_CD (+)= a.WARD_CD
		            )  b                                             /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMT e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDCMCDDMV k                               /* 공통코드마스터 */
		     where  a.ORDR_YMD        between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                                  and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		       and  a.MDTN_NO         between #{mdtnNo1} and  #{mdtnNo2}
		       and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
		       and  b.ORDR_YMD          = a.ORDR_YMD
		       and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		       and  b.MDTN_NO           = a.MDTN_NO
		       and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		       and  d.PTNO  = a.PTNO
		       and  e.USER_ID(+) = a.ODDR_ID
		       and  e2.LGIN_ID(+)   = e.LGIN_ID
		       and  f.MDPR_CD = b.MDPR_CD
		       and  g.DRUS_CD = b.DRUS_CD
		       and  h.DPRT_CD(+) = a.MCDP_CD
		       and  i.COMN_GRP_CD(+) = 'SD003'
		       and  i.COMN_DTLS_CD(+) = nvl(f.KPNG_PLAC_CD, '9')
		       and  k.COMN_GRP_CD(+) = 'MM079'
		       and  k.COMN_DTLS_CD(+) = b.PRTX_RLTN_RESN_VL
		     order
		        by
		            a.ORDR_YMD
		         ,  a.MDTN_NO_DVSN_CD
		         ,  a.MDTN_NO
		         ,  a.MDTN_LCDV_CD
		         ,  b.BSIS_CMMD_PLAC_CD
		         ,  b.PHDP_CMMD_BNDL_NO
		         ,  b.MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcMixOrdrPrtxShet-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="afiNrdrCct" column="AFI_NRDR_CCT"/>
		<result property="afiDgstItrcNm" column="AFI_DGST_ITRC_NM"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="nextMdcrYmd" column="NEXT_MDCR_YMD"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="tkmdCcfeYn" column="TKMD_CCFE_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="afiInjcPlacNm" column="AFI_INJC_PLAC_NM"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="newYn" column="NEW_YN"/>
		<result property="afiOrocNm" column="AFI_OROC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="adrItrcMemoCtn" column="ADR_ITRC_MEMO_CTN"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcMixOrdrPrtxShet () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcMixOrdrPrtxShet-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcMixOrdrPrtxShet"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcMixOrdrPrtxShet-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptInjcMixOrdrPrtxShet */
		<![CDATA[
		select  /*+ sdd_pordbat_l88$S01_외래MIX처방전 조회 */
		            to_char(a.ORDR_YMD, 'yyyymmdd')   as ORDR_YMD                                  /* 처방일자     */
		         ,  a.MDTN_LCDV_CD                    as MDTN_LCDV_CD
		         ,  a.MDTN_NO_DVSN_CD                 as MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  a.MDTN_NO                         as MDTN_NO          /* 투약번호     */
		         ,  (
		                select  /*+ ordered use_nl(y z)      */
		                        nvl(max(z.MDTN_NO), 0)  MDTN_NO
		                  from
		                        SDPORDBAT y
		                     ,  SDPORDDET z
		                 where  y.ORDR_YMD         = a.ORDR_YMD
		                   and  y.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		                   and  y.PTNO             = a.PTNO
		                   and  y.MDTN_NO          < a.MDTN_NO
		                   and  y.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		                   and  y.MCDP_CD          = a.MCDP_CD
		                   and  y.PHDP_OROC_DPRT_CD          = a.PHDP_OROC_DPRT_CD
		                   and  y.GNDR_ID          = a.GNDR_ID
		                   and  y.CMMD_CMBN_CTN is not null
		                   and  y.MDTN_NO >   (
		                                select
		                                        nvl(max(v.MDTN_NO), 0)  MDTN_NO
		                                  from
		                                        SDPORDBAT v
		                                 where  v.ORDR_YMD        = y.ORDR_YMD
		                                   and  v.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                                   and  v.PTNO    = y.PTNO
		                                   and  v.MCDP_CD = y.MCDP_CD
		                                   and  v.PHDP_OROC_DPRT_CD = y.PHDP_OROC_DPRT_CD
		                                   and  v.GNDR_ID = y.GNDR_ID
		                                   and  v.DRUG_PRSS_CD > '0'
		                                   and  v.DRUG_INJC_DVSN_CD in ('1', '2')
		                                   and  v.MDTN_NO < a.MDTN_NO
		                                   and  v.RCPC_YN = 'Y'
		                         )
		                   and  z.ORDR_YMD        = y.ORDR_YMD
		                   and  z.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                   and  z.MDTN_NO         = y.MDTN_NO
		                   and  z.MDTN_LCDV_CD    = y.MDTN_LCDV_CD
		                   and  instr(#{afiBsisCmmdPlacNm}, z.BSIS_CMMD_PLAC_CD) > 0
		                   and  z.PRIN_DT is not null
		             )       BEMD_NO                                      /* 수정전번호   */
		         ,  a.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'-'||trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12))   AFI_AGE_VL_STR    /* 나이 */
		         ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)    as BDWG_VL      /* 몸무게 */
		         , a.WARD_CD                                                                  as WARD_CD        /* 병동코드 */
		         , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD) as ABRV_DPRT_CD_1 /* 병동코드명 */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		         ,  a.MCDP_CD                                             /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  a.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                             /* 처방의명     */
		         ,  (
		                select
		                        x.SCIN_CD||'('||x.SCIN_NM||')'
		                  from
		                        MDPADIAGT x
		                 where  x.MDRP_NO = b.MDRP_NO
		                   and  (
		                             (a.MDTN_NO_DVSN_CD = 'G')
		                      /*    or
		                             (a.MDTN_NO_DVSN_CD = 'T') */
		                          or
		                             (a.MDTN_NO_DVSN_CD in ('O', 'Z') and  x.MCDP_CD = a.MCDP_CD)
		                        )
		                   and  x.MAIN_SCIN_YN = 'Y'
		                   and  a.GNDR_ID  = decode( sign( a.MDCR_YMD - to_date( #{baseYmd}, 'yyyymmdd'))
		                                                            , -1 , a.GNDR_ID
		                                                                  , decode( a.PTDV_CD, 'O', x.CHDR_ID , a.GNDR_ID)
		                                            )           /* MultiMainDiag  */
		                   and  rownum < 2
		             )      SCIN_NM                                /* 상병명       */
		         ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		         ,  (
		                select
		                        decode(count(x.MDPR_CD), 1, 'Y', 'N')
		                  from
		                        SDPORDDET x
		                 where  x.ORDR_YMD        = a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_NO         = a.MDTN_NO
		                   and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                   and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		                   and  x.MDPR_CLSF_CD = '3'
		                   and  rownum < 2
		             )     NRDR_YN                                   /* 마약포함여부 */
		         ,  (
		            select
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '2'
		               and  rownum < 2
		            )    PSDG_YN                                     /* 향정포함여부 */
		         ,  (
		            select  /*+ ordered use_nl(x y)     */
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		                 ,  SDDDGCDMT y
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '3'
		               and  y.MDPR_CD = x.MDPR_CD
		               and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		               and  rownum < 2
		             )     CLNC_YN                                     /* 임상포함여부 */
		         ,  a.TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  b.ORDR_SNO                                         /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                          /* 약품코드     */
		         ,  b.MDPR_NM                                          /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  f.ICUN_CD                                          /* 함량단위     */
		         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		         ,  b.MDNT                                             /* 횟수         */
		         ,  b.MDTN_DDCN                                        /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
		         ,  b.DRUS_CD                                          /* 용법         */
		         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN1, g.ENVL_MEMO_CTN3)  as ENVL_MEMO_CTN1
		         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN2, g.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		                                      , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN3
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정' )
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포')),
		                                     ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN4
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 /* 용법Text3    */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4 /* 용법Text4    */
		         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(b.SPSB_CTN, chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                /* 보관장소     */
		         ,  i.DETL_CD_NM                               /* 보관장소명   */
		         ,  (
		                select
		                       '*'
		                  from
		                        SZPATCMMT x                        /* 환자COMMENT    */
		                 where  x.PTNO = a.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   /* and  x.PTNT_CMNT_SNO >= 20001
		                   and  x.PTNT_CMNT_SNO <= 40000 */
		                   and  x.PTNT_CMNT_DVSN_CD in ('21','C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  a.DRUG_INJC_DVSN_CD                                   /* 약주사구분   */
		         ,  (
		            select
		                    count(*)
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  x.MDPR_CLSF_CD = '3'
		               and  x.DRAP_DVSN_CD != '2'
		         )        AFI_NRDR_CCT                                /* 마약개수     */
		         ,  '' AFI_DGST_ITRC_NM  /*연령별 처방 제한*/
		         ,  b.DURV_RESN_CTN
		         ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.SMRY_MDPR_NM) as SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  (
		                select
		                        max(to_char(x.ORDR_YMD, 'yyyymmdd')||x.MDTN_NO)
		                  from
		                        SDPORDBAT x
		                 where  x.ORDR_YMD              >= sysdate - 120
		                   and  x.ORDR_YMD              < a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD       = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_LCDV_CD          = a.MDTN_LCDV_CD
		                   and  x.PTNO                  = a.PTNO
		                   and  x.MCDP_CD               = a.MCDP_CD
		                   and  x.DRUG_PRSS_CD          < '6'
		                   and  x.INJC_PRSS_CD          < '6'
		                   and  x.MIX_INJC_PRSS_CD      < '6'
		                   and  x.OTPT_MIX_INJC_PRSS_CD < '6'
		             )      AFI_MDTN_NO_STR           /* 이전 동일과 처방일 */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		         ,  (
		                select
		                        to_char(min(x1.MDCR_YMD), 'yyyymmdd')
		                  from
		                        APRCRPTNT x1
		                 where  x1.PTNO = a.PTNO
		                   and  nvl(x1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                   and  x1.MCDP_CD = a.MCDP_CD
		                   and  x1.MDCR_ANDV_CD not in ('7', '8', '9')
		                   and  x1.MDCR_YMD > a.ORDR_YMD
		             )   NEXT_MDCR_YMD
		         ,  b.DRUG_PRIN_YN
		         ,  (
		                select
		                        decode(count(*), 0, 'Y', 'N')
		                  from
		                        SDODGGUIT x2
		                      , APRCRPTNT x3
		                 where  x2.PTNO = a.PTNO
		                   and  x2.PTDV_CD = 'O'
		                   and  x3.MDRP_NO = x2.MDRP_NO
		                   and  x3.MDCR_DT < a.MDCR_YMD
		                   and  x2.TKMD_CCHN_YMD < a.ORDR_YMD
		             )     TKMD_CCFE_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  a.MCCN_CD
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=b.INJC_PLAC_CD), b.INJC_PLAC_CD) AFI_INJC_PLAC_NM
		         ,  FN_SD_GETAUDFGLIST_S9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD
		                         , #{phdpCmmdBndlNo}, #{afiBsisCmmdPlacNm}, #{drapDvsnCd}
		                               , #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  decode(b.PRTX_RLTN_RESN_VL, 'T', b.PRTX_RLTN_RESN_CTN, k.DETL_CD_NM)   CLMN_NM_1
		         ,  ''   CLMN_NM_2
		         ,  ''   NEW_YN
		         ,  nvl((select m.MDCR_DTLS_CTRL_NM from MZCTRLMMT m where MDCR_CTRL_CD = 'MM184' and m.MDCR_DTLS_CTRL_CD = a.PHDP_OROC_DPRT_CD),'') AFI_OROC_NM
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'')  AFI_CNTR_NM
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCDP_CD),'')  ABRV_DPRT_CD
		         , (select 'Y' as ADR_ITRC_MEMO_CTN from SDCADRPAT a1 where a1.PTNO = a.PTNO and rownum = 1) as ADR_ITRC_MEMO_CTN
		         , #{inqrDvsnCd}                                        as INQR_DVSN_CD
		         , #{inptClntPrgmId}                                    as INPT_CLNT_PRGM_ID         
		      from
		            SDPORDBAT a                               /* 약처방내역기본 */
		         ,  (
		            select   /*+ LEADING(b f a)  INDEX(b SDPORDDET_I11) */
		                    b.ORDR_YMD
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,d.MDPR_NM)      as MDPR_NM
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.PRTX_RLTN_RESN_VL
		                 ,  h.PRTX_RLTN_RESN_CTN
		                 ,  h.MDRP_NO
		              from
		                    SDPORDDET b,
		                    SDDDGCDMT d,
		                    SDDMETCDT c,
		                    SDPORDBAT a,
		                    APPTPTNTV f,
		                    MDMEDORDT h,
		                    APRCRPTNT j,
		                    HZDEPTMMT k,
		                    SDJFIXQTT l,
		                    SDMCTRLMT m
		                  , (
		                      select distinct
		                             b1.PTNO
		                           , b1.ORDR_YMD
		                           , b1.ORDR_SNO
		                        from MNIRECEIT a1 /* 외래치료실주사접수 */
		                           , MNIOUTACT b1 /* 외래액팅 */
		                       where a1.INJC_PRRN_YMD between to_date(#{ordrYmd3}, 'yyyymmdd' )
		                                                  and to_date(#{ordrYmd4}, 'yyyymmdd' )/* 주사예정일자 */
		                         and a1.ENRM_YN        = 'Y'  /* 입실여부 */
		                         and a1.ENRM_CNCL_DT is null /* 입실취소일시 */
		                         /* and nvl(a1.ENRM_CNCL_YN , 'N') = 'N' */
		                         and b1.PTNO          = a1.ptno
		                         and b1.IJAC_APNT_YMD = a1.INJC_PRRN_YMD
		                    ) z
		              where b.ORDR_YMD    >= to_date(#{ordrYmd1} , 'YYYYMMDD')
		                and b.ORDR_YMD    <= to_date(#{ordrYmd2} , 'YYYYMMDD')
		                and b.MDTN_LCDV_CD = #{mdtnLcdvCd}
		                /*--------------------------------------------------------------------------------------------------------------*/
		                /* MIX처방(항암/항생/MIX주사) 일괄변경 조건
		                /*--------------------------------------------------------------------------------------------------------------*/
		                and b.MDTN_NO_DVSN_CD in ('O', 'Z', 'C')
		                and instr(#{afiMdtnNoDvsnNm}, b.MDTN_NO_DVSN_CD) > 0
		                and b.BSIS_CMMD_PLAC_CD in ('8', '9', 'B')  /* BSIS_CMMD_PLAC_CD : 8 무균제(기타)MIX / 9 항생제MIX / B 항암제MIX */
		                and instr(#{afiBsisCmmdPlacNm}, b.BSIS_CMMD_PLAC_CD) > 0
		                and nvl(b.OSLF_ADMN_DRUG_YN, 'N') != 'Y'    /* 외래(OZ) DSC퇴원(T) 응급실퇴원(GH) 병동퇴원(DFPQ)은 자가주사 안 나오도록 */
		                and nvl(b.DRUS_CD, 'X')           != 'SAVE' /* SAVE 단독처방 제외 */
		                /*--------------------------------------------------------------------------------------------------------------*/
		                and (
		                      (nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1')
		                   or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and
		                       b.MDTN_NO_DVSN_CD in ('O', 'Z')                      and
		                       nvl(b.RCPC_YN, 'N') in ('Y', 'W') /* W : 인공신장 */ and
		                       nvl(b.WARD_LABL_PRIN_YN, 'N') = 'N')
		                   or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and
		                       b.MDTN_NO_DVSN_CD in ('C')                           and
		                       nvl(b.WARD_LABL_PRIN_YN, 'N') = 'N')
		                    )
		                /*--------------------------------------------------------------------------------------------------------------*/                
		                and not exists (select  /*+ NO_UNNEST */  'Y'
		                                  from SDJDGRTNT a1
		                                 where a1.PTNO            = b.PTNO
		                                   and a1.ORDR_YMD        = b.ORDR_YMD
		                                   and a1.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
		                                   and a1.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
		                                   and a1.MDTN_NO         = b.MDTN_NO
		                                   and a1.ORDR_SNO        = b.ORDR_SNO
		                                   and rownum = 1
		                                )
		                /* 간호에서 hold 처리한 처방은 제외 */
		                and not exists (select  /*+ NO_UNNEST */  1
		                                   from MDMEDORDT z
		                                  where z.PTNO     = b.PTNO
		                                    and z.ORDR_YMD = b.ORDR_YMD
		                                    and z.ORDR_SNO = b.ORDR_SNO
		                                    and nvl(z.ORDR_HOLD_DVSN_CD,' ') = 'Y')
		                /* 조제정보 생성 전 반납*/
		                and  nvl((select /*+ index ( a1 mdmedordt_pk )
		                                     index ( b1 sdjdgrtnt_pk ) */
		                                  'Y'
		                            from
		                                 MDMEDORDT a1,
		                                 SDJDGRTNT b1
		                           where
		                                 a1.PTNO     = b.PTNO
		                             and a1.ORDR_YMD = b.ORDR_YMD
		                             and a1.ORDR_SNO = b.ORDR_SNO
		                             and a1.DRUG_ORDR_PRSS_CD <> '0'
		                             and ( nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
		                             and a1.ORDR_YMD = b1.ORDR_YMD
		                             and a1.PTNO = b1.PTNO
		                             and a1.ORDR_SNO = b1.ORDR_SNO
		                             and b1.DRUG_RTRE_CD = '7'
		                             and rownum = 1
		                     ),'N') <> 'Y'
		                /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
		                and ( ( nvl(#{afiOrdrSnoStr}, 'X') != 'R')                              or
		                      ( nvl(#{afiOrdrSnoStr}, 'X' ) = 'R'                               and
		                           b.BSIS_CMMD_PLAC_CD in ('8', '9', 'B')                       and
		                           not exists (
		                                        select   /*+ NO_UNNEST */   'Y'
		                                          from SDJDGRTNT s
		                                         where s.ORDR_YMD        = b.ORDR_YMD
		                                           and s.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
		                                           and s.MDTN_NO         = b.MDTN_NO
		                                           and s.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
		                                           and s.ORDR_SNO        = b.ORDR_SNO
		                                           and s.MDPR_CD         = b.MDPR_CD
		                                           and nvl(s.MDPR_RTRN_NTM,-1) != 0
		                                           and b.INVN_TOTL_QTY <= (select sum(RTRN_RQST_CQY)
		                                                                     from SDJDGRTNT t
		                                                                    where s.ORDR_YMD        = t.ORDR_YMD
		                                                                      and s.MDTN_NO_DVSN_CD = t.MDTN_NO_DVSN_CD
		                                                                      and s.MDTN_NO         = t.MDTN_NO
		                                                                      and s.ORDR_SNO        = t.ORDR_SNO
		                                                                      and s.MDTN_LCDV_CD    = t.MDTN_LCDV_CD
		                                                                      and s.MDPR_CD         = t.MDPR_CD
		                                                                      and t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
		                                                                      and nvl(t.MDPR_RTRN_NTM,-1) != 0 )
		                                      )
		                      )
		                    )
		                /*-----------------------------------------------------------------------------*/               
		                and  b.MDTN_LCDV_CD      = decode(#{mdtnLcdvCd} , null, b.MDTN_LCDV_CD, 'A', b.MDTN_LCDV_CD, #{mdtnLcdvCd} )
		                and  b.MDTN_NO between  #{mdtnNo1}
		                                   and  #{mdtnNo2}                
		                and  b.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} ,0, b.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
		                and  b.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
		                and  b.ORDR_SNO          = decode(nvl(#{afiOrdrSnoStr} , 'X'), 'R', b.ORDR_SNO, nvl(#{afiOrdrSnoStr}, b.ORDR_SNO))
		                and  d.MDPR_CD           = b.MDPR_CD
		                /* 출고여부 nvl(d.RELS_YN, 'N') = 'Y'
		                SDC703F1 전체                                출고여부체크 X
		                SDG205F1 병동MIX                             출고여부체크 X
		                SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		                SDG101F1 MIX                                 출고여부체크 X
		                */
		                and  c.DRUS_CD(+)        = b.DRUS_CD
		                and  a.ORDR_YMD          = b.ORDR_YMD
		                and  a.MDTN_NO_DVSN_CD   = b.MDTN_NO_DVSN_CD
		                and  a.MDTN_NO           = b.MDTN_NO
		                and  a.MDTN_LCDV_CD      = b.MDTN_LCDV_CD
		                and  a.WARD_CD           = nvl(#{wardCd} , a.WARD_CD)
		                and  f.PTNO              = b.PTNO
		                and  h.PTNO              = b.PTNO
		                and  h.ORDR_YMD          = b.ORDR_YMD
		                and  h.ORDR_SNO          = b.ORDR_SNO
		                and  j.MDRP_NO           = h.MDRP_NO
		                and  l.DPRT_CD(+)        = b.INJC_PLAC_CD
		                and  l.MDPR_CD(+)        = b.MDPR_CD
		                and  l.EQPT_FDNO_DVSN_CD(+)    = '2'
		                and  k.DPRT_CD(+) = a.WARD_CD
		                and  m.PHRM_CTRL_CD     (+)  = 'SD149'
		                and  m.PHRM_DTLS_CTRL_CD(+)  = b.MDPR_CD
		          ]]>
		            <choose>
		              <when test='afiMdtnNoDvsnNm=="C"'>
		                and  z.PTNO(+)     = b.PTNO
		                and  z.ORDR_YMD(+) = b.ORDR_YMD
		                and  z.ORDR_SNO(+) = b.ORDR_SNO
		              </when>
		              <otherwise>
		                and  z.PTNO     = b.PTNO
		                and  z.ORDR_YMD = b.ORDR_YMD
		                and  z.ORDR_SNO = b.ORDR_SNO
		              </otherwise>
		            </choose>
		          <![CDATA[                
		            )  b                                      /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMT e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDCMCDDMV k                               /* 공통코드마스터 */
		     where  a.ORDR_YMD    >= to_date(#{ordrYmd1} , 'YYYYMMDD')
		       and  a.ORDR_YMD    <= to_date(#{ordrYmd2} , 'YYYYMMDD')
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		       and  a.MDTN_NO         between #{mdtnNo1} and  #{mdtnNo2}
		       and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
		       and  b.ORDR_YMD        = a.ORDR_YMD
		       and  b.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		       and  b.MDTN_NO         = a.MDTN_NO
		       and  b.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		       and  d.PTNO            = a.PTNO
		       and  e.USER_ID(+)      = a.ODDR_ID
		       and  e2.LGIN_ID(+)     = e.LGIN_ID
		       and  f.MDPR_CD         = b.MDPR_CD
		       and  g.DRUS_CD         = b.DRUS_CD
		       and  h.DPRT_CD         = a.MCDP_CD
		       and  i.COMN_GRP_CD(+)  = 'SD003'
		       and  i.COMN_DTLS_CD(+) = nvl(f.KPNG_PLAC_CD, '9')
		       and  k.COMN_GRP_CD(+)  = 'MM079'
		       and  k.COMN_DTLS_CD(+) = b.PRTX_RLTN_RESN_VL
		     order
		        by
		            a.ORDR_YMD
		         ,  a.MDTN_NO_DVSN_CD
		         ,  a.MDTN_NO
		         ,  a.MDTN_LCDV_CD
		         ,  b.BSIS_CMMD_PLAC_CD
		         ,  b.PHDP_CMMD_BNDL_NO
		         ,  b.MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneParameter-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptntCmntDvsnCd" column="PTNT_CMNT_DVSN_CD"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="inqrCndtCd" column="INQR_CNDT_CD"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="scinNm1" column="SCIN_NM_1"/>
		<result property="scinNm2" column="SCIN_NM_2"/>
		<result property="scinNm3" column="SCIN_NM_3"/>
		<result property="rePrintYn" column="RE_PRINT_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneParameter () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneParameter-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneParameter"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneParameter-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneParameter */
		select '' as PTNT_CMNT_DVSN_CD
		       , '' as PSDG_YN
		       , '' as INQR_CNDT_CD
		       , '' as INQR_DVSN_CD
		       , '' as INPT_CLNT_PRGM_ID /* 입력클라이언트프로그램 */
		       , 0 as PHDP_CMMD_BNDL_NO
		       , 0 as ORDR_SNO
		       , '' as WARD_LABL_PRIN_YN
		       , '' as SCIN_NM
		       , '' as SCIN_CD
		       , '' as SCIN_NM_1
		       , '' as SCIN_NM_2
		       , '' as SCIN_NM_3
		       , '' as RE_PRINT_YN
		  from dual
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptDcOrdrPrtxShet-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="tkmdInftDrusCtn" column="TKMD_INFT_DRUS_CTN"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="afiNrdrCct" column="AFI_NRDR_CCT"/>
		<result property="afiDgstItrcNm" column="AFI_DGST_ITRC_NM"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="nextMdcrYmd" column="NEXT_MDCR_YMD"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="tkmdCcfeYn" column="TKMD_CCFE_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="newYn" column="NEW_YN"/>
		<result property="afiOrocNm" column="AFI_OROC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="adrItrcMemoCtn" column="ADR_ITRC_MEMO_CTN"/>
		<result property="dcDvsnCd" column="DC_DVSN_CD"/>
		<result property="dcPrinYn" column="DC_PRIN_YN"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptDcOrdrPrtxShet () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptDcOrdrPrtxShet-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptDcOrdrPrtxShet"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptDcOrdrPrtxShet-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptDcOrdrPrtxShet */
		<![CDATA[
		select  /*+ DC처방전 조회 */
		            to_char(a.ORDR_YMD, 'yyyymmdd')   as ORDR_YMD                                  /* 처방일자     */
		         ,  a.MDTN_LCDV_CD                    as MDTN_LCDV_CD
		         ,  a.MDTN_NO_DVSN_CD                 as MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  a.MDTN_NO                         as MDTN_NO          /* 투약번호     */
		         ,  (
		                select  /*+ ordered use_nl(y z)      */
		                        nvl(max(z.MDTN_NO), 0)  MDTN_NO
		                  from
		                        SDPORDBAT y
		                     ,  SDPORDDET z
		                 where  y.ORDR_YMD         = a.ORDR_YMD
		                   and  y.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
		                   and  y.PTNO             = a.PTNO
		                   and  y.MDTN_NO          < a.MDTN_NO
		                   and  y.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		                   and  y.MCDP_CD          = a.MCDP_CD
		                   and  y.PHDP_OROC_DPRT_CD          = a.PHDP_OROC_DPRT_CD
		                   and  y.GNDR_ID          = a.GNDR_ID
		                   and  y.CMMD_CMBN_CTN is not null
		                   and  y.MDTN_NO >   (
		                                select
		                                        nvl(max(v.MDTN_NO), 0)  MDTN_NO
		                                  from
		                                        SDPORDBAT v
		                                 where  v.ORDR_YMD        = y.ORDR_YMD
		                                   and  v.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                                   and  v.PTNO    = y.PTNO
		                                   and  v.MCDP_CD = y.MCDP_CD
		                                   and  v.PHDP_OROC_DPRT_CD = y.PHDP_OROC_DPRT_CD
		                                   and  v.GNDR_ID = y.GNDR_ID
		                                   and  v.DRUG_PRSS_CD > '0'
		                                   and  v.DRUG_INJC_DVSN_CD in ('1', '2')
		                                   and  v.MDTN_NO < a.MDTN_NO
		                                   and  v.RCPC_YN = 'Y'
		                         )
		                   and  z.ORDR_YMD        = y.ORDR_YMD
		                   and  z.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
		                   and  z.MDTN_NO         = y.MDTN_NO
		                   and  z.MDTN_LCDV_CD    = y.MDTN_LCDV_CD
		                   and  instr(#{afiBsisCmmdPlacNm}, z.BSIS_CMMD_PLAC_CD) > 0
		                   and  z.PRIN_DT is not null
		             )       BEMD_NO                                      /* 수정전번호   */
		         ,  a.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  trunc(months_between(a.ORDR_YMD, d.BTDT)/12)||'-'||trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12))   AFI_AGE_VL_STR    /* 나이 */
		         ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)    as BDWG_VL      /* 몸무게 */
		         , a.WARD_CD                                                                  as WARD_CD        /* 병동코드 */
		         , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD) as ABRV_DPRT_CD_1 /* 병동코드명 */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		         ,  a.MCDP_CD                                             /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  a.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                             /* 처방의명     */
		         ,  (
		                select
		                        x.SCIN_CD||'('||x.SCIN_NM||')'
		                  from
		                        MDPADIAGT x
		                 where  x.MDRP_NO = b.MDRP_NO
		                   and  (
		                             (a.MDTN_NO_DVSN_CD in ('G', 'H') )           /* 응급실퇴원 */
		                      /*    or
		                             (a.MDTN_NO_DVSN_CD = 'T') */                   /* DSC퇴원 */
		                          or
		                             (a.MDTN_NO_DVSN_CD in ('D', 'F', 'P', 'Q') ) /* 병동퇴원 */
		                          or
		                             (a.MDTN_NO_DVSN_CD in ('O', 'Z') and  x.MCDP_CD = a.MCDP_CD)
		                        )
		                   and  x.MAIN_SCIN_YN = 'Y'
		                   and  a.GNDR_ID  = decode( sign( a.MDCR_YMD - to_date( #{baseYmd}, 'yyyymmdd'))
		                                                            , -1 , a.GNDR_ID
		                                                                  , decode( a.PTDV_CD, 'O', x.CHDR_ID , a.GNDR_ID)
		                                            )           /* MultiMainDiag  */
		                   and  rownum < 2
		             )      SCIN_NM                                /* 상병명       */
		         ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		         ,  (
		                select
		                        decode(count(x.MDPR_CD), 1, 'Y', 'N')
		                  from
		                        SDPORDDET x
		                 where  x.ORDR_YMD        = a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_NO         = a.MDTN_NO
		                   and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		                   and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		                   and  x.MDPR_CLSF_CD = '3'
		                   and  rownum < 2
		             )     NRDR_YN                                   /* 마약포함여부 */
		         ,  (
		            select
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '2'
		               and  rownum < 2
		            )    PSDG_YN                                     /* 향정포함여부 */
		         ,  (
		            select  /*+ ordered use_nl(x y)     */
		                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
		              from
		                    SDPORDDET x
		                 ,  SDDDGCDMT y
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
		               and  x.MDPR_CLSF_CD = '3'
		               and  y.MDPR_CD = x.MDPR_CD
		               and  nvl(y.STST_DVSN_CD, '0') in ('6', 'A', 'C')
		               and  rownum < 2
		             )     CLNC_YN                                     /* 임상포함여부 */
		         ,  a.TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  b.ORDR_SNO                                         /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                          /* 약품코드     */
		         ,  b.MDPR_NM                                          /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  f.ICUN_CD                                          /* 함량단위     */
		         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		         ,  b.MDNT                                             /* 횟수         */
		         ,  b.MDTN_DDCN                                        /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
		         ,  b.DRUS_CD                                          /* 용법         */
		         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN1, g.ENVL_MEMO_CTN3)  as ENVL_MEMO_CTN1
		         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN2, g.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                                  , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		                                      , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN3
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정' )
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포')),
		                                     ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN4
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 /* 용법Text3    */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4 /* 용법Text4    */
		         ,  g.TKMD_INFT_DRUS_CTN			TKMD_INFT_DRUS_CTN							/* 복약안내용법내용 */
				 ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(b.SPSB_CTN, chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                /* 보관장소     */
		         ,  i.DETL_CD_NM                               /* 보관장소명   */
		         ,  (
		                select
		                       '*'
		                  from
		                        SZPATCMMT x                        /* 환자COMMENT    */
		                 where  x.PTNO = a.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   /* and  x.PTNT_CMNT_SNO >= 20001
		                   and  x.PTNT_CMNT_SNO <= 40000 */
		                   and  x.PTNT_CMNT_DVSN_CD in ('21','C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  a.DRUG_INJC_DVSN_CD                                   /* 약주사구분   */
		         ,  (
		            select
		                    count(*)
		              from
		                    SDPORDDET x
		             where  x.ORDR_YMD = a.ORDR_YMD
		               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		               and  x.MDTN_NO = a.MDTN_NO
		               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
		               and  x.MDPR_CLSF_CD = '3'
		               and  x.DRAP_DVSN_CD != '2'
		         )        AFI_NRDR_CCT                                /* 마약개수     */
		         ,  '' AFI_DGST_ITRC_NM  /*연령별 처방 제한*/
		         ,  b.DURV_RESN_CTN
		         ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.SMRY_MDPR_NM) as SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  (
		                select
		                        max(to_char(x.ORDR_YMD, 'yyyymmdd')||x.MDTN_NO)
		                  from
		                        SDPORDBAT x
		                 where  x.ORDR_YMD              >= sysdate - 120
		                   and  x.ORDR_YMD              < a.ORDR_YMD
		                   and  x.MDTN_NO_DVSN_CD       = a.MDTN_NO_DVSN_CD
		                   and  x.MDTN_LCDV_CD          = a.MDTN_LCDV_CD
		                   and  x.PTNO                  = a.PTNO
		                   and  x.MCDP_CD               = a.MCDP_CD
		                   and  x.DRUG_PRSS_CD          < '6'
		                   and  x.INJC_PRSS_CD          < '6'
		                   and  x.MIX_INJC_PRSS_CD      < '6'
		                   and  x.OTPT_MIX_INJC_PRSS_CD < '6'
		             )      AFI_MDTN_NO_STR           /* 이전 동일과 처방일 */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		         ,  (
		                select
		                        to_char(min(x1.MDCR_YMD), 'yyyymmdd')
		                  from
		                        APRCRPTNT x1
		                 where  x1.PTNO = a.PTNO
		                   and  nvl(x1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                   and  x1.MCDP_CD = a.MCDP_CD
		                   and  x1.MDCR_ANDV_CD not in ('7', '8', '9')
		                   and  x1.MDCR_YMD > a.ORDR_YMD
		             )   NEXT_MDCR_YMD
		         ,  b.DRUG_PRIN_YN
		         ,  (
		                select
		                        decode(count(*), 0, 'Y', 'N')
		                  from
		                        SDODGGUIT x2
		                      , APRCRPTNT x3
		                 where  x2.PTNO = a.PTNO
		                   and  x2.PTDV_CD = 'O'
		                   and  x3.MDRP_NO = x2.MDRP_NO
		                   and  x3.MDCR_DT < a.MDCR_YMD
		                   and  x2.TKMD_CCHN_YMD < a.ORDR_YMD
		             )     TKMD_CCFE_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  a.MCCN_CD
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=b.INJC_PLAC_CD), b.INJC_PLAC_CD) INJC_PLAC_CD
		         ,  FN_SD_GETAUDFGLIST_S9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD
		                         , #{phdpCmmdBndlNo}, #{afiBsisCmmdPlacNm}, #{drapDvsnCd}
		                               , #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  decode(b.PRTX_RLTN_RESN_VL, 'T', b.PRTX_RLTN_RESN_CTN, k.DETL_CD_NM)   CLMN_NM_1
		         ,  ''   CLMN_NM_2
		         ,  ''   NEW_YN
		         ,  nvl((select m.MDCR_DTLS_CTRL_NM from MZCTRLMMT m where MDCR_CTRL_CD = 'MM184' and m.MDCR_DTLS_CTRL_CD = a.PHDP_OROC_DPRT_CD),'') AFI_OROC_NM
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'')  AFI_CNTR_NM
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCDP_CD),'')  ABRV_DPRT_CD
		         , (select 'Y' as ADR_ITRC_MEMO_CTN from SDCADRPAT a1 where a1.PTNO = a.PTNO and rownum = 1) as ADR_ITRC_MEMO_CTN
		         ,  b.DC_DVSN_CD                                        as DC_DVSN_CD
		         ,  b.DC_PRIN_YN                                        as DC_PRIN_YN         
		         , #{inqrDvsnCd}                                        as INQR_DVSN_CD
		         , #{inptClntPrgmId}                                    as INPT_CLNT_PRGM_ID
		      from
		            SDPORDBAT a                               /* 약처방내역기본 */
		         ,  (
		            select
		                    b.ORDR_YMD
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,d.MDPR_NM)      as MDPR_NM
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.PRTX_RLTN_RESN_VL
		                 ,  h.PRTX_RLTN_RESN_CTN
		                 ,  h.MDRP_NO
		                 ,  h.DC_DVSN_CD
		                 ,  b.DC_PRIN_YN                 
		              from
		                    SDPORDBAT a
		                 ,  SDPORDDET b
		                 ,  MDMEDORDT h
		                 ,  SDDDGCDMT d
		             where  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD
		                                             , 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd})  /* 투약위치 */
		               and  b.MDPR_CD           = d.MDPR_CD
		               and  b.ORDR_YMD          = a.ORDR_YMD
		               and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		               and  b.MDTN_NO           = a.MDTN_NO
		               and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		               and  instr(#{afiBsisCmmdPlacNm}, b.BSIS_CMMD_PLAC_CD) > 0
		               and  b.MDTN_NO = case when nvl(#{mdtnNo}, 0) = 0 then b.MDTN_NO else #{mdtnNo} end
		               and  b.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then b.PHDP_CMMD_BNDL_NO else #{phdpCmmdBndlNo} end
		               and  b.CMMD_STTS_CD > '1' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */               
		               and  b.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */               
		               and  (
		                      ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6')              )  or
		                      ( b.BSIS_CMMD_PLAC_CD  = 'A' and b.DRAP_DVSN_CD               != '2' )  or /* 마약은 주사 제외 */
		                      ( b.BSIS_CMMD_PLAC_CD  = '7' and nvl(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                    )
		               /*--------------------------------------------------------------------------------------------------------------*/
		               and (
		                     ( nvl(#{inptClntPrgmId}, '********' )  = 'SDG101F1'  and nvl(h.DC_DVSN_CD, 'N') = 'Y'                                 ) or                
		                     ( nvl(#{inptClntPrgmId}, '********' ) != 'SDG101F1'  and nvl(h.DC_DVSN_CD, 'N') = 'Y' and nvl(b.DC_PRIN_YN, 'N') = 'N')
		                   )
		               /*--------------------------------------------------------------------------------------------------------------*/
		               /* and  nvl(b.DRUS_CD, 'X') != 'SAVE' */ /* SAVE 단독처방 제외 외래/퇴원 처방전에는 나오도록 */
		               and  h.PTNO = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = b.ORDR_SNO
		            )  b                                             /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMT e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDCMCDDMV k                               /* 공통코드마스터 */
		     where  a.ORDR_YMD        = to_date(#{ordrYmd}, 'YYYYMMDD')
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		       and  a.MDTN_NO         = case when nvl(#{mdtnNo}, 0) = 0 then b.MDTN_NO else #{mdtnNo} end
		       and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
		       and  b.ORDR_YMD        = a.ORDR_YMD
		       and  b.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
		       and  b.MDTN_NO         = a.MDTN_NO
		       and  b.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
		       and  d.PTNO            = a.PTNO
		       and  e.USER_ID         = a.ODDR_ID
		       and  e2.LGIN_ID        = e.LGIN_ID
		       and  f.MDPR_CD         = b.MDPR_CD
		       /* 출고여부 nvl(f.RELS_YN, 'N') = 'Y'
		       SDC703F1 전체                                출고여부체크 X
		       SDG205F1 병동MIX                             출고여부체크 X
		       SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		       SDG101F1 MIX                                 출고여부체크 X
		       */       
		       and  g.DRUS_CD         = b.DRUS_CD
		       and  h.DPRT_CD         = a.MCDP_CD
		       and  i.COMN_GRP_CD     = 'SD003'
		       and  i.COMN_DTLS_CD    = nvl(f.KPNG_PLAC_CD, '9')
		       and  k.COMN_GRP_CD(+)  = 'MM079'
		       and  k.COMN_DTLS_CD(+) = b.PRTX_RLTN_RESN_VL
		     order
		        by
		            a.ORDR_YMD
		         ,  a.MDTN_NO_DVSN_CD
		         ,  a.MDTN_NO
		         ,  a.MDTN_LCDV_CD
		         ,  b.BSIS_CMMD_PLAC_CD
		         ,  b.PHDP_CMMD_BNDL_NO
		         ,  b.MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinMdprSum-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="ensnPdctNm" column="ENSN_PDCT_NM"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="mdprLctnCd" column="MDPR_LCTN_CD"/>
		<result property="mdprLctnNm" column="MDPR_LCTN_NM"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="rtrnRqstCqy" column="RTRN_RQST_CQY"/>
		<result property="pcunNm" column="PCUN_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinMdprSum () 
        Description :                                           SdpListOrdrCmmdEnvlPrinMdprSumCSID
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinMdprSum-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinMdprSum"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinMdprSum-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOrdrCmmdEnvlPrinMdprSum */
		/* SdpListOrdrCmmdEnvlPrinMdprSumCSID */
		<![CDATA[
				 select z1.MDTN_NO_DVSN_CD
		              , z1.MDPR_CD
		              , z1.MDPR_NM
		              , z1.MDPR_CLSF_CD
		              , z1.DRAP_DVSN_CD
		              , FN_SD_GETHGCTMDPRNM_S(z1.MDPR_CD,z1.SMRY_MDPR_NM)  as SMRY_MDPR_NM
		              , z1.KORN_PDCT_NM
		              , z1.ENSN_PDCT_NM
		              , z1.PCKN_UNAD_QTY
		              , z1.TOTL_CLCL_QTY
		              , z1.INVN_TOTL_QTY
		              , z1.KPNG_PLAC_CD
		              , z1.HGRS_HGCC_MDPR_YN
		              , z1.INQR_DVSN_CD
		              , z1.INPT_CLNT_PRGM_ID
		              , nvl(z1.MDPR_LCTN_CD, '*') as MDPR_LCTN_CD
		              , nvl(z1.MDPR_LCTN_NM, '*') as MDPR_LCTN_NM
		              , z1.ORDR_YMD
		              , z1.ABRV_DPRT_CD
		              , z1.RTRN_RQST_CQY              
		              , z1.PCUN_NM                 
		              from (
				select 	
		               to_char(a.ORDR_YMD, 'yyyymmdd')                      as ORDR_YMD            /* 처방일자 */
				     , a.MDTN_NO_DVSN_CD                                    as MDTN_NO_DVSN_CD     /* 투약번호구분코드 A 병동정규, B 병동추가, E 병동응급 */
				     , a.MDPR_CD                                            as MDPR_CD             /* 약품코드 */
				     , a.MDPR_NM                                            as MDPR_NM             /* 약품명 */
				     , a.MDPR_CLSF_CD                                       as MDPR_CLSF_CD        /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
				     , a.DRAP_DVSN_CD                                       as DRAP_DVSN_CD        /* 약적용구분코드  SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
				    ,  a.SMRY_MDPR_NM                                   as SMRY_MDPR_NM        /* 요약약품명 */
				     , a.KORN_PDCT_NM                                       as KORN_PDCT_NM        /* 한글상품명 */
				     , a.ENSN_PDCT_NM                                       as ENSN_PDCT_NM        /* 영문상품명 */
				     , sum(a.PCKN_UNAD_QTY)                                      as PCKN_UNAD_QTY       /* 포장단위투여량 1회량 */				     
		             , a.PCUN_NM                                            as PCUN_NM             /* 포장단위명 */
		             , sum(a.TOTL_CLCL_QTY)                                      as TOTL_CLCL_QTY     /* 총계산량 */
				     , sum(a.INVN_TOTL_QTY)                                      as INVN_TOTL_QTY       /* 재고총량 */
				     , a.KPNG_PLAC_CD                                       as KPNG_PLAC_CD        /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
				     , a.HGRS_HGCC_MDPR_YN                                  as HGRS_HGCC_MDPR_YN   /* 고위험고농도약품여부 1 고위험,  2 고농도 */
				     , #{inqrDvsnCd}                                        as INQR_DVSN_CD
				     , #{inptClntPrgmId}                                    as INPT_CLNT_PRGM_ID
		             , a.MDPR_LCTN_CD                                       as MDPR_LCTN_CD         /* 조제실 약품위치 코드 */
		             , a.ABRV_DPRT_CD
		             , sum(a.RTRN_RQST_CQY)                           as RTRN_RQST_CQY
		             , (select PHRM_DTLS_CTRL_NM
		                    from SDMCTRLMT z001 
		                        where PHRM_CTRL_CD ='SD330'
		                        and z001.PHRM_DTLS_CTRL_CD = a.MDPR_LCTN_CD
		               ) as MDPR_LCTN_NM                                                            /* 약국내보관장소이름 */
				  from ( select a.ORDR_YMD       as ORDR_YMD          /* 처방일자 */
				              , a.MDTN_LCDV_CD                   as MDTN_LCDV_CD      /* 투약위치구분코드 */
				              , a.MDTN_NO_DVSN_CD                as MDTN_NO_DVSN_CD   /* 투약번호구분코드 */
				              , a.MDTN_NO                        as MDTN_NO           /* 투약번호 */
				              , j.MDRP_NO                        as MDRP_NO
				              , k.PHDP_CMMD_SQNC_VL              as PHDP_CMMD_SQNC_VL
				              , k.ABRV_DPRT_CD                   as ABRV_DPRT_CD
				              , a.BSIS_CMMD_PLAC_CD              as BSIS_CMMD_PLAC_CD /* 기본조제장소코드 */
				              , a.ORDR_SNO                       as ORDR_SNO          /* 처방일련번호 */
				              , h.ODDR_ID                        as ODDR_ID           /* 처방의사 */
				              , nvl(k.ABRV_DPRT_CD, e.WARD_CD)   as ABRV_DPRT_CD_1
				              , nvl(k.KORN_DPRT_NM, e.WARD_CD)   as AFI_ABRV_DPRT_NM_1
				              , a.INJC_PLAC_CD                   as INJC_PLAC_CD
				              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.INJC_PLAC_CD)
				                                                 as ABRV_DPRT_CD_4
				              , (select a1.KORN_DPRT_NM from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.INJC_PLAC_CD)
				                                                 as AFI_INJC_PLAC_NM
				              , e.WARD_CD                        as WARD_CD
				              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = j.WARD_CD)
				                                                 as ABRV_DPRT_CD_2    /* 병동코드 */
				              , j.PTRM_NO                        as PTRM_NO           /* 병실번호 */
				              , j.SCKB_NO                        as SCKB_NO           /* 병상번호 */
				              , j.MDCR_DT                        as MDCR_DT
				              , f.GEND_CD                        as GEND_CD           /* 성별 */
				              , f.BTDT                           as BTDT
				              , e.MCDP_CD                        as MCDP_CD           /* 진료과코드 */
				              , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = e.MCDP_CD)   as ABRV_DPRT_CD_3 /* 진료과코드 */
				              , a.DRUG_ORDR_INPT_DT              as DRUG_ORDR_INPT_DT /* 처방입력일시 */
				              , a.PTNO                           as PTNO              /* 환자번호 */
				              , f.PTNT_NM                        as PTNT_NM           /* 환자명 */
				              , a.PHDP_CMMD_BNDL_NO              as PHDP_CMMD_BNDL_NO /* 약제부조제묶음번호 */
				              , a.MDPR_CD                        as MDPR_CD           /* 약품코드 */
				              , b.MDPR_NM                        as MDPR_NM           /* 약품명 */
				              , a.MDPR_CLSF_CD                   as MDPR_CLSF_CD      /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
				              , a.DRAP_DVSN_CD                   as DRAP_DVSN_CD      /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
				              , b.SMRY_MDPR_NM                   as SMRY_MDPR_NM      /* 요약약품명 */
				              , b.KORN_PDCT_NM                   as KORN_PDCT_NM      /* 한글상품명 */
				              , b.ENSN_PDCT_NM                   as ENSN_PDCT_NM      /* 영문상품명 */
				              , a.PCKN_UNAD_QTY                  as PCKN_UNAD_QTY     /* 포장단위투여량 1회량 */
				              , a.PCUN_NM                        as PCUN_NM
				              , a.INVN_TOTL_QTY                  as INVN_TOTL_QTY     /* 재고총량 */
		                      , a.TOTL_CLCL_QTY                  as TOTL_CLCL_QTY     /* 총계산량 */
				              , a.MDTN_DDCN                      as MDTN_DDCN         /* 투약일수 */
				              , a.MDNT                           as MDNT              /* 투약횟수 */
				              , a.DRBN_NO                        as DRBN_NO           /* 약묶음번호 */
				              , a.DRUS_CD                        as DRUS_CD           /* 용법코드 */
				              , c.TKMD_INFT_DRUS_CTN             as ENVL_MEMO_CTN1    /* 용법 복약안내문 */
				              , decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN2, c.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
				              , a.MIX_KIND_CD                    as MIX_KIND_CD       /* 혼합종류코드 1 MIX, 2 기타MIX(가루약/혼합조제), 3 알약으로 */
				              , b.KPNG_PLAC_CD                   as KPNG_PLAC_CD      /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
				              , b.HGRS_HGCC_MDPR_YN              as HGRS_HGCC_MDPR_YN /* 고위험고농도약품여부 1 고위험,  2 고농도 */
				              , FN_SD_ISNUMBER_S(a.SPSB_CTN)     as SPSB_CTN
				              , a.FDNO_MDPR_CNFR_DT              as FDNO_MDPR_CNFR_DT   /* 정수약품확인일시 */
				              , a.RCPC_YN                        as RCPC_YN             /* 수납여부 */
				              , a.RCPC_DT                        as RCPC_DT             /* 수납일시 */
				              , b.DGFR_CD                        as DGFR_CD             /* 제형코드 SD015 */
				              , a.WARD_LABL_PRIN_YN              as WARD_LABL_PRIN_YN   /* 라벨출력여부 */
		                      , b.MDPR_LCTN_CD                   as MDPR_LCTN_CD        /* 조제실 약품위치코드 */
		                      , l.RTRN_RQST_CQY             as RTRN_RQST_CQY                                                   
				              /* 정렬순서
				                 정규(SDG101F1)      : 병동-환자명-환자번호-처방일자-투약번호-[내복/외용]-조제장소-묶음번호-처방순번
				                 추가/응급(SDC100F1) : 병동-환자명-환자번호-처방일자-투약번호-[일반/향정]-[내복/외용]-조제장소-묶음번호-처방순번
				              */
				              /* 봉투  */
		             		     , case when #{dvsnNm} = '1' then case when a.MDTN_NO_DVSN_CD = 'A' then
				                                                                                     lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
						                                                                                   || rpad(k.ABRV_DPRT_CD, 7,'0' )
						                                                                                   || lpad(to_char(j.PTRM_NO) ,5, '0')
						                                                                                   || f.PTNT_NM
						                                                                                   || e.PTNO
						                                                                                   || to_char(a.ORDR_YMD, 'yyyymmdd')
						                                                                                   || a.MDTN_LCDV_CD
						                                                                                   || a.MDTN_NO_DVSN_CD
						                                                                                   || lpad(to_char(a.MDTN_NO), 4, '0')
						                                                                                   || case when a.DRAP_DVSN_CD = '1' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
						                                                                                           when a.DRAP_DVSN_CD = '3' then '2'
						                                                                                           when a.DRAP_DVSN_CD = '9' then '3'
						                                                                                                                     else '4'
						                                                                                      end
						                                                                                   || lpad(a.BSIS_CMMD_PLAC_CD,3,' ')
				                                                                                           || rpad(a.MDNT,3,' ')
						                                                                                   || rpad(a.DRUS_CD,3,' ')
						                                                                                   || rpad(a.MDPR_CD,10,' ')
				                                                                                           || rpad( to_char(a.PHDP_CMMD_BNDL_NO ),3,' ')
						                                                                                   || lpad(to_char(a.ORDR_SNO), 10, '0')
						                                                                                 else   /* 그외 */
						                                                                                      lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
						                                                                                   || rpad(k.ABRV_DPRT_CD, 7,'0' )
						                                                                                   || lpad(to_char(j.PTRM_NO) ,5, '0')
						                                                                                   || f.PTNT_NM
						                                                                                   || e.PTNO
						                                                                                   || to_char(a.ORDR_YMD, 'yyyymmdd')
						                                                                                   || a.MDTN_LCDV_CD
						                                                                                   || a.MDTN_NO_DVSN_CD
						                                                                                   || lpad(to_char(a.MDTN_NO), 4, '0')
						                                                                                   || case when a.MDPR_CLSF_CD = '2' then ' 2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
						                                                                                           when a.MDPR_CLSF_CD = '3' then ' 3'
						                                                                                                                     else ' 1'
						                                                                                      end
						                                                                                   || case when a.DRAP_DVSN_CD = '1' then ' 1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
						                                                                                           when a.DRAP_DVSN_CD = '3' then ' 2'
						                                                                                           when a.DRAP_DVSN_CD = '9' then ' 3'
						                                                                                                                     else ' 4'
						                                                                                      end
						                                                                                   || lpad(a.BSIS_CMMD_PLAC_CD,3,' ')
				                                                                                           || rpad(a.MDNT,3,' ')
						                                                                                   || rpad(a.DRUS_CD,3,' ')
						                                                                                   || rpad(a.MDPR_CD,10,' ')
				                                                                                           || rpad( to_char(a.PHDP_CMMD_BNDL_NO ),3,' ')
						                                                                                   || lpad(to_char(a.ORDR_SNO), 10, '0')
				                                               end
				                     /* 주사라벨(일반, 향정, 마약) */
		                     when #{dvsnNm} = '2' then case when a.MDTN_NO_DVSN_CD = 'A' then  rpad(k.ABRV_DPRT_CD, 7,'0' )
		                                                                                       || to_char(a.ORDR_YMD, 'yyyymmdd')                     
		                                                                                       || lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
		                                                                                       || lpad(to_char(j.PTRM_NO) ,5, '0')
		                                                                                       || f.PTNT_NM
		                                                                                       || e.PTNO
		                                                                                       || a.MDTN_LCDV_CD
		                                                                                       || a.MDTN_NO_DVSN_CD
		                                                                                       || lpad(to_char(a.MDTN_NO), 4, '0')
		                                                                                       || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		                                                                                               when a.MDPR_CLSF_CD = '3' then '3'
		                                                                                                                         else '1'
		                                                                                          end
		                                                                                       || case when b.KPNG_PLAC_CD = '3' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		                                                                                               when b.KPNG_PLAC_CD = '1' then '2'
		                                                                                               when b.KPNG_PLAC_CD = '7' then '3'
		                                                                                                                         else '4'
		                                                                                          end
		                                                                                       || a.BSIS_CMMD_PLAC_CD
		                                                                                       || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
		                                                                                       || rpad(a.MDPR_CD,10,' ')
		                                                                                       || lpad(to_char(a.ORDR_SNO), 10, '0')
		                                                    else                                lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
		                                                                                       || rpad(k.ABRV_DPRT_CD, 7,'0' )
		                                                                                       || lpad(to_char(j.PTRM_NO) ,5, '0')
		                                                                                       || f.PTNT_NM
		                                                                                       || e.PTNO
		                                                                                       || to_char(a.ORDR_YMD, 'yyyymmdd')
		                                                                                       || a.MDTN_LCDV_CD
		                                                                                       || a.MDTN_NO_DVSN_CD
		                                                                                       || lpad(to_char(a.MDTN_NO), 4, '0')
		                                                                                       || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
		                                                                                               when a.MDPR_CLSF_CD = '3' then '3'
		                                                                                                                         else '1'
		                                                                                          end
		                                                                                       || case when b.KPNG_PLAC_CD = '3' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
		                                                                                               when b.KPNG_PLAC_CD = '1' then '2'
		                                                                                               when b.KPNG_PLAC_CD = '7' then '3'
		                                                                                                                         else '4'
		                                                                                          end
		                                                                                       || a.BSIS_CMMD_PLAC_CD
		                                                                                       || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
		                                                                                       || rpad(a.MDPR_CD,10,' ')
		                                                                                       || lpad(to_char(a.ORDR_SNO), 10, '0')
		                                          end
				                     /* 시럽 */
		                     when #{dvsnNm} = '3' then   lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
				                                               || rpad(k.ABRV_DPRT_CD, 7,'0' )
				                                               || lpad(to_char(j.PTRM_NO) ,5, '0')
				                                               || f.PTNT_NM
				                                               || e.PTNO
				                                               || to_char(a.ORDR_YMD, 'yyyymmdd')
				                                               || a.MDTN_LCDV_CD
				                                               || a.MDTN_NO_DVSN_CD
				                                               || lpad(to_char(a.MDTN_NO), 4, '0')
				                                               || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
				                                                       when a.MDPR_CLSF_CD = '3' then '3'
				                                                                                 else '1'
				                                                  end
				                                               || case when a.DRAP_DVSN_CD = '1' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
				                                                       when a.DRAP_DVSN_CD = '3' then '2'
				                                                       when a.DRAP_DVSN_CD = '9' then '3'
				                                                                                 else '4'
				                                                  end
				                                               || a.BSIS_CMMD_PLAC_CD
				                                               || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
				                                               || rpad(a.MDPR_CD,10,' ')
				                                               || lpad(to_char(a.ORDR_SNO), 10, '0')
				                     /* 그 외 : 현재는 없음 */
				                                          else   lpad(to_char(k.PHDP_CMMD_SQNC_VL ), 10, '0' )
				                                               || rpad(k.ABRV_DPRT_CD, 7,'0' )
				                                               || lpad(to_char(j.PTRM_NO) ,5, '0')
				                                               || f.PTNT_NM
				                                               || e.PTNO
				                                               || to_char(a.ORDR_YMD, 'yyyymmdd')
				                                               || a.MDTN_LCDV_CD
				                                               || a.MDTN_NO_DVSN_CD
				                                               || lpad(to_char(a.MDTN_NO), 4, '0')
				                                               || case when a.MDPR_CLSF_CD = '2' then '2' /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
				                                                       when a.MDPR_CLSF_CD = '3' then '3'
				                                                                                 else '1'
				                                                  end
				                                               || case when a.DRAP_DVSN_CD = '1' then '1' /* 약적용구분코드 SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
				                                                       when a.DRAP_DVSN_CD = '3' then '2'
				                                                       when a.DRAP_DVSN_CD = '9' then '3'
				                                                                                 else '4'
				                                                  end
				                                               || case when b.KPNG_PLAC_CD = '1' then '1' /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
				                                                       when b.KPNG_PLAC_CD = '3' then '1'
				                                                       when b.KPNG_PLAC_CD = '7' then '1'
				                                                                                 else '2'
				                                                  end
				                                               || a.BSIS_CMMD_PLAC_CD
				                                               || lpad( to_char(a.PHDP_CMMD_BNDL_NO ), 4,'0')
				                                               || rpad(a.MDPR_CD,10,' ')
				                                               || lpad(to_char(a.ORDR_SNO), 10, '0')
				                end as orderkey
				           from SDPORDDET a
				              , SDDDGCDMT b /* 약품코드 */
				              , SDDMETCDT c /* 약품용법코드관리 */
				              , SDPORDBAT e /* 처방조제기본 */
				              , APPTPTNTV f /* 환자Master View */
				              , MDMEDORDT h /* 약처방 */
				              , APRCRPTNT j /* 진료접수 */
				              , HZDEPTMMT k /* 조직Master I/F(MDM연계) */
				              , SDJDGRTNT l /* 처방성약품반납 */
				          where
		]]>
		            <choose>
		              <when test='inqrDvsnCd=="1"'>
		                a.ORDR_YMD between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                               and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		              </when>
		              <when test='inqrDvsnCd=="2"'>
		<![CDATA[              
		                a.ORDR_YMD = to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		            and e.ORDR_DT >= to_date(#{inqrStrtDt}, 'yyyymmddhh24miss') 
		            and e.ORDR_DT  < to_date(#{inqrFnshDt}, 'yyyymmddhh24miss')
		]]>            
		              </when>
		              <otherwise>
		                a.ORDR_YMD between to_date(substr(#{inqrStrtDt}, 1, 8), 'yyyymmdd')
		                               and to_date(substr(#{inqrFnshDt}, 1, 8), 'yyyymmdd')
		              </otherwise>
		            </choose>
		<![CDATA[
		            and a.MDTN_LCDV_CD    = case when (#{mdtnLcdvCd} is null) or
		                                              (#{mdtnLcdvCd} = '')    or
		                                              (#{mdtnLcdvCd} = 'A')   then a.MDTN_LCDV_CD
		                                                                      else #{mdtnLcdvCd}
		                                    end
		            and instr(#{afiMdtnNoDvsnNm}, a.MDTN_NO_DVSN_CD) > 0
		            and a.MDTN_NO between #{mdtnNo1} and  #{mdtnNo2}
		            and a.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then a.PHDP_CMMD_BNDL_NO
		                                                                              else #{phdpCmmdBndlNo}     /* RP */
		                                      end
		            and a.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
		            and a.MDPR_CD = nvl(#{mdprCd}, a.MDPR_CD)
		            and (
		                    (nvl(#{rePrintYn}, 'Y') = 'N' and a.PRIN_DT is null  and a.MDPR_TKVR_DT is null) or /*중복출력방지*/
		                    (nvl(#{rePrintYn}, 'Y') = 'Y' and nvl(a.TKVR_PRSG_DVSN_CD,  '*') = nvl(#{tkvrPrsgDvsnCd}, decode(a.TKVR_PRSG_DVSN_CD,  null, '*', a.TKVR_PRSG_DVSN_CD)))     /*중복출력허용*/
		                 )
		            and (
		                  (#{dvsnNm}  = '4'   and a.ORDR_SNO = #{ordrSno}) or
		                  (#{dvsnNm} != '4'   and (
		                                            (#{mdprClsfNm} = '1'  and a.MDPR_CLSF_CD not in ('2', '3')) or /* 일반의약품 */
		                                            (#{mdprClsfNm} = '2'  and a.MDPR_CLSF_CD      =  '2'      ) or /* 향정신성의약품 */
		                                            (#{mdprClsfNm} = '3'  and a.MDPR_CLSF_CD      =  '3'      ) or /* 마약 */
		                                            (#{mdprClsfNm} = '12' and a.MDPR_CLSF_CD     !=  '3'      ) or /* 일반의약품 + 향정신성의약품 */
		                                            (#{mdprClsfNm} = '23' and a.MDPR_CLSF_CD     in ('2', '3')) or /* 향정신성의약품 + 마약 */
		                                            (#{mdprClsfNm} = '13' and a.MDPR_CLSF_CD     !=  '2'      ) or /* 일반의약품 + 마약 */
		                                            (#{mdprClsfNm} = '123')
		                                          )
		                                      /* 7 주사제, 8 무균제(기타)MIX, 9 항생제MIX, A 마약조제, B 항암제MIX */
		                                      and (
		                                            (#{dvsnNm} = '1' and a.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', 'A')  and a.DRAP_DVSN_CD in ('1', '3', '9')                        ) or /* 봉투     afiBsisCmmdPlacNm = 123456A */
		                                            (#{dvsnNm} = '2' and ( (a.BSIS_CMMD_PLAC_CD = '7') or (a.BSIS_CMMD_PLAC_CD = 'A' and a.DRAP_DVSN_CD  = '2') )                                 ) or /* 주사라벨 afiBsisCmmdPlacNm = 7, A */
		                                            (#{dvsnNm} = '3' and a.BSIS_CMMD_PLAC_CD  = '4'                                  and a.DRAP_DVSN_CD  = '1' and b.DGFR_CD in ('10', '11', '32')) or   /* 시럽     afiBsisCmmdPlacNm = 4 */
		                                            (#{dvsnNm} = '5' and a.DRAP_DVSN_CD  = '3')      /* 외용약 */
		                                          )
		                                      /* 입원환자만 병동 주사묶음에서 수액은 전체 제거 : SDG204F1 */
		                                      and case when #{dvsnNm} = '2' and a.MDTN_NO_DVSN_CD in ('A', 'B', 'E') and b.MDPR_CLSF_DETL_CD = '10' then 'N'
		                                                                                                                                      else 'Y'
		                                          end = 'Y'
		                                      and instr(#{afiBsisCmmdPlacNm}, a.BSIS_CMMD_PLAC_CD) > 0
		                                      and a.INJC_PLAC_CD                = nvl(#{injcPlacCd}, a.INJC_PLAC_CD)
		                                      /*--------------------------------------------------------------------------------------------------------------*/
		                                      and (
		                                            (nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1') 
		                                         or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and
		                                             #{dvsnNm} = '2'                                      and
		                                             a.MDTN_NO_DVSN_CD in ('O', 'Z')                      and
		                                             nvl(a.RCPC_YN, 'N') in ('Y', 'W') /* W : 인공신장 */ and
		                                             nvl(a.WARD_LABL_PRIN_YN, 'N') = nvl(#{wardLablPrinYn}, nvl(a.WARD_LABL_PRIN_YN, 'N'))
		                                            )
		                                         or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     and 
		                                             a.MDTN_NO_DVSN_CD not in ('O', 'Z')                  and
		                                             nvl(a.WARD_LABL_PRIN_YN, 'N') = nvl(#{wardLablPrinYn}, nvl(a.WARD_LABL_PRIN_YN, 'N'))
				                                            )
				                                          )
				                                      /*--------------------------------------------------------------------------------------------------------------*/            
				                                      /* 외래(OZ) 주사는 자가주사 제외 */
				                                      /* and (a.MDTN_NO_DVSN_CD in ('O', 'Z') and a.BSIS_CMMD_PLAC_CD = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') != 'Y') */
				                                      and  (case when a.MDTN_NO_DVSN_CD in ('O', 'Z') and a.BSIS_CMMD_PLAC_CD = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') = 'Y' then 'N'
				                                                                                                                                                            else 'Y'
				                                            end) = 'Y'
				                                      and nvl(a.DRUS_CD, 'X') != 'SAVE' /* SAVE 단독처방 제외 */
				                                      /* 출고여부 nvl(b.RELS_YN, 'N') = 'Y'
				                                      SDC703F1 전체                                출고여부체크 X
				                                      SDG205F1 병동MIX                             출고여부체크 X
				                                      SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
				                                      SDG101F1 MIX                                 출고여부체크 X
				                                      */
				                                      and ( /* SDC703F1 전체                                출고여부체크 X */
				                                            ( ( a.MDTN_NO_DVSN_CD       in ('O', 'Z', 'D', 'F', 'P', 'Q', 'T', 'G', 'H'))  and
				                                              ( ( a.BSIS_CMMD_PLAC_CD   in ('1', '2', '3', '4', '5', '6')              )  or
				                                                ( a.BSIS_CMMD_PLAC_CD    = 'A' and a.DRAP_DVSN_CD               != '2' )  or /* 마약은 주사 제외 */
				                                                ( a.BSIS_CMMD_PLAC_CD    = '7' and nvl(a.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
				                                              )                                                                                                  ) or
				                                            /* MIX */
				                                            (instr('89B', a.BSIS_CMMD_PLAC_CD) > 0                                                               ) or
				                                            /* 그 외는 출고여부체크 */
				                                            (nvl(b.RELS_YN, 'N') = 'Y'                                                                           )
				                                          )
				                  )         
				                )
				            /* 그 외 SDPORDDEV에 조건은 봉투라벨과 무의미 하여 삭제 */
				            and b.MDPR_CD = a.MDPR_CD            
				            and c.DRUS_CD(+)       = a.DRUS_CD
				            and e.ORDR_YMD         = a.ORDR_YMD
				            and e.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
				            and e.MDTN_NO          = a.MDTN_NO
				            and e.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
		            and e.WARD_CD          = nvl(#{wardCd}, e.WARD_CD)
		            and ( 
		                  (#{dvsnCd9} is null                                    ) or                   
		                  (#{dvsnCd9} = 'R' and b.KPNG_PLAC_CD = '1'/*냉장 -  SD035F2*/    ) or                   
		                  (#{dvsnCd9} = 'N' and nvl(   (select 'Y'
		                                                         from SDMCTRLMT z
		                                                        where z.PHRM_CTRL_CD = 'SD089'
		                                                          and z.PHRM_DTLS_CTRL_CD = a.MDPR_CD 
		                                                          and rownum = 1
		                                                        )
		                                                    , 'N') = 'Y'  /*영양수액 - SD035F2 */                                  
		                  ) or                   
		                  (#{dvsnCd9} is not null and trunc(e.RPTN_DT) = trunc(sysdate))
		                )               
				            and f.PTNO             = a.PTNO
				            and h.PTNO             = a.PTNO
				            and h.ORDR_YMD         = a.ORDR_YMD
				            and h.ORDR_SNO         = a.ORDR_SNO
				            and j.MDRP_NO          = h.MDRP_NO
				            /* 조제정보 생성 전 반납*/
				            and nvl((select /*+ index ( a1 mdmedordt_pk )
				                                index ( b1 sdjdgrtnt_pk ) */
				                            'Y'
				                       from
				                            MDMEDORDT a1,
				                            SDJDGRTNT b1
				                      where
				                            a1.PTNO     = a.PTNO
				                        and a1.ORDR_YMD = a.ORDR_YMD
				                        and a1.ORDR_SNO = a.ORDR_SNO
				                        and a1.DRUG_ORDR_PRSS_CD <> '0'
				                        and (nvl(a1.DC_DVSN_CD, 'N') = 'Y' or nvl(a1.CMMD_BEFR_RTRN_DVSN_CD,'N') = 'Y')
				                        and a1.ORDR_YMD = b1.ORDR_YMD
				                        and a1.PTNO = b1.PTNO
				                        and a1.ORDR_SNO = b1.ORDR_SNO
				                        and b1.DRUG_RTRE_CD = '7'
				                        and rownum = 1
				                   ), 'N') <> 'Y'
				            /* 미수령 반납 : 조제정보 생성 불출 처리 전 반납 */
		            and ( ( nvl(#{afiOrdrSnoStr}, 'X') != 'R')                              or
		                  ( nvl(#{afiOrdrSnoStr}, 'X' ) = 'R'                               and
				                    a.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
				                    not exists ( select  'Y'
				                                   from  SDJDGRTNT s
				                                  where  s.ORDR_YMD        = e.ORDR_YMD
				                                    and  s.MDTN_NO_DVSN_CD = e.MDTN_NO_DVSN_CD
				                                    and  s.MDTN_NO         = e.MDTN_NO
				                                    and  s.MDTN_LCDV_CD    = e.MDTN_LCDV_CD
				                                    and  s.ORDR_SNO    = a.ORDR_SNO
				                                    and  s.MDPR_CD     = a.MDPR_CD
				                                    and  nvl(s.MDPR_RTRN_NTM, -1) != 0
				                                    and  a.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
				                                                               from  SDJDGRTNT t
				                                                              where  s.ORDR_YMD         = t.ORDR_YMD
				                                                                and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
				                                                                and  s.MDTN_NO          = t.MDTN_NO
				                                                                and  s.ORDR_SNO         = t.ORDR_SNO
				                                                                and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
				                                                                and  s.MDPR_CD          = t.MDPR_CD
				                                                                and  t.RTRN_DETL_DVSN_CD != 'Z' /* A 수령반납, B 미수령반납, Z 잔량반납 */
				                                                                and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
				                               ) and
		                    /* 정규처방중 반납확인된 처방은 조회하지 않는다. */
		                    not exists ( select  'Y'
		                                   from  SDJDGRTNT s
		                                  where  s.ORDR_YMD        = e.ORDR_YMD
		                                    and  s.MDTN_NO_DVSN_CD = e.MDTN_NO_DVSN_CD
		                                    and  s.MDTN_NO_DVSN_CD = 'A'
		                                    and  s.MDTN_NO         = e.MDTN_NO
		                                    and  s.MDTN_LCDV_CD    = e.MDTN_LCDV_CD
		                                    and  s.ORDR_SNO    = a.ORDR_SNO
		                                    and  s.MDPR_CD     = a.MDPR_CD
		                                    and  nvl(s.MDPR_RTRN_NTM, -1) != 0
		                                    and  nvl(s.RTRN_CNFR_CQY,0) > 0
		                               )		                               
				                  )
				                )
				            /* 부서비품정수약품관리 : 정수는 정수 List 로 주기 때문에 제외 대상으로 둔다 */
				            and not exists (select 1
				                              from SDJFIXQTT l
				                             where l.DPRT_CD = a.INJC_PLAC_CD
				                               and l.MDPR_CD = a.MDPR_CD
				                               and l.EQPT_FDNO_DVSN_CD = '2')
				            and k.DPRT_CD (+)= e.WARD_CD
				            and l.ORDR_YMD(+)               = a.ORDR_YMD
				            and l.MDTN_NO_DVSN_CD(+)  = a.MDTN_NO_DVSN_CD
				            and l.MDTN_NO(+)                = a.MDTN_NO
				            and l.ORDR_SNO(+)               = a.ORDR_SNO
				            and l.MDTN_LCDV_CD(+)        = a.MDTN_LCDV_CD
				            and l.MDPR_CD(+)                = a.MDPR_CD
		                    and l.RTRN_DETL_DVSN_CD(+) != 'Z' 
		/*		            and l.RTRN_DETL_DVSN_CD(+) = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */                    
				      ) a
		         group by 
				              ORDR_YMD            /* 처방일자 */
				            , MDTN_NO_DVSN_CD     /* 투약번호구분코드 A 병동정규, B 병동추가, E 병동응급 */
				            , MDPR_CD             /* 약품코드 */
				            , MDPR_NM             /* 약품명 */
				            , MDPR_CLSF_CD        /* 약품분류코드 2 향정신성의약품, 3 마약 그외 일반 */
				            , DRAP_DVSN_CD        /* 약적용구분코드  SD002 1 내복약 B2 2 주사약 B1 3 외용약 B3 9 기타 B9 */
				            , SMRY_MDPR_NM        /* 요약약품명 */
				            , KORN_PDCT_NM        /* 한글상품명 */
				            , ENSN_PDCT_NM        /* 영문상품명 */
				            , PCUN_NM             /* 포장단위명 */
				            , KPNG_PLAC_CD        /* 보관장소코드 '1', '3', '7' 인 경우 냉장 */
				            , HGRS_HGCC_MDPR_YN   /* 고위험고농도약품여부 1 고위험,  2 고농도 */
				            , MDPR_LCTN_CD         /* 조제실 약품위치 코드 */
		                    , ABRV_DPRT_CD
		              order by ABRV_DPRT_CD       
				             , ORDR_YMD           
		                     , KPNG_PLAC_CD
		                     , MDPR_CD
							 , to_number(MDPR_LCTN_CD) 
							 , SMRY_MDPR_NM
					) z1
			     ]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDummy-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="phrmCtrlChrcVl1" column="PHRM_CTRL_CHRC_VL_1"/>
		<result property="phrmCtrlChrcVl2" column="PHRM_CTRL_CHRC_VL_2"/>
		<result property="phrmCtrlChrcVl3" column="PHRM_CTRL_CHRC_VL_3"/>
		<result property="phrmCtrlChrcVl4" column="PHRM_CTRL_CHRC_VL_4"/>
		<result property="phrmCtrlChrcVl5" column="PHRM_CTRL_CHRC_VL_5"/>
		<result property="phrmCtrlChrcVl6" column="PHRM_CTRL_CHRC_VL_6"/>
		<result property="phrmCtrlChrcVl7" column="PHRM_CTRL_CHRC_VL_7"/>
		<result property="phrmCtrlChrcVl10" column="PHRM_CTRL_CHRC_VL_10"/>
		<result property="oslfAdmnDrugYn" column="OSLF_ADMN_DRUG_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDummy () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDummy-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDummy"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDummy-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneDummy */
				select    '' as PHRM_CTRL_CHRC_VL_1
				        , 0  as PHRM_CTRL_CHRC_VL_2
				        , 0  as PHRM_CTRL_CHRC_VL_3
				        , 0  as PHRM_CTRL_CHRC_VL_4
				        , 0  as PHRM_CTRL_CHRC_VL_5
				        , 0  as PHRM_CTRL_CHRC_VL_6
				        , '' as PHRM_CTRL_CHRC_VL_7
				        , 0  as PHRM_CTRL_CHRC_VL_10
		                , '' as OSLF_ADMN_DRUG_YN
				  from dual 
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgOrdrLablPrin-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN_1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno2" column="PTNT_TLNO_2"/>
		<result property="ptntTlno3" column="PTNT_TLNO_3"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="afiValdHhStr" column="AFI_VALD_HH_STR"/>
		<result property="relsYn" column="RELS_YN"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="istyAsstCd" column="ISTY_ASST_CD"/>
		<result property="nmbrVl" column="NMBR_VL"/>
		<result property="acdgPhdpUnsbMemo" column="ACDG_PHDP_UNSB_MEMO"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="mdtnNo3" column="MDTN_NO_3"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="acknEdiCd" column="ACKN_EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="chcnYn" column="CHCN_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="atmtClamYn" column="ATMT_CLAM_YN"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="pcunInlsQty" column="PCUN_INLS_QTY"/>
		<result property="afiMdprOrlmAgeDdcnStr" column="AFI_MDPR_ORLM_AGE_DDCN_STR"/>
		<result property="afiErrmLctnNm" column="AFI_ERRM_LCTN_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="shdnYn" column="SHDN_YN"/>
		<result property="afiCmmdAftrKpngPlacNm" column="AFI_CMMD_AFTR_KPNG_PLAC_NM"/>
		<result property="rcpcDt" column="RCPC_DT"/>
		<result property="afiValdHhStr1" column="AFI_VALD_HH_STR_1"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="hgprDgmtCd" column="HGPR_DGMT_CD"/>
		<result property="dgstYnCtn" column="DGST_YN_CTN"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="rtrnCnfrCqy" column="RTRN_CNFR_CQY"/>
		<result property="ptntNm2" column="PTNT_NM_2"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="injcPlacCd1" column="INJC_PLAC_CD_1"/>
		<result property="wardCd1" column="WARD_CD_1"/>
		<result property="mcdpCd1" column="MCDP_CD_1"/>
		<result property="mdprClsfDetlCd" column="MDPR_CLSF_DETL_CD"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="drugOrdrUnslCtn" column="DRUG_ORDR_UNSL_CTN"/>
		<result property="cmmdUnsbCtn" column="CMMD_UNSB_CTN"/>
		<result property="spsbCtn1" column="SPSB_CTN_1"/>
		<result property="trgtYn" column="TRGT_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgOrdrLablPrin () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgOrdrLablPrin-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgOrdrLablPrin"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgOrdrLablPrin-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgOrdrLablPrin */
		<![CDATA[ 
				select   
				        z.ORDR_YMD
				     ,  z.MDTN_NO_DVSN_CD
				     ,  z.AFI_MDTN_NO_STR
				     ,  z.ORDR_SNO
				     ,  z.MDPR_CD
				     ,  z.MDPR_NM
				     ,  z.PTDV_CD
				     ,  z.MDPR_CLSF_CD
				     ,  z.DRAP_DVSN_CD
				     ,  z.CMMD_STTS_CD
				     ,  z.PCKN_UNAD_QTY
				     ,  z.PCUN_NM
				     ,  z.ICUN_ADMN_VLM
				     ,  z.ICUN_CD
				     ,  z.SLCT_UNIT_DVSN_CD
				     ,  z.MDTN_DDCN
				     ,  z.DRUS_CD
				     ,  z.MDNT
				     ,  z.TOTL_CLCL_QTY
				     ,  z.INVN_TOTL_QTY
				     ,  z.PHDP_CMMD_BNDL_NO
				     ,  z.DRBN_NO
				     ,  z.MIX_KIND_CD
				     ,  z.BSIS_CMMD_PLAC_CD
				     ,  z.SPSB_CTN
				     ,  z.FDNO_YN
				     ,  z.ISDV_CD
				     ,  z.DRUG_ORDR_INPT_DT
				     ,  z.SDPF_EXRE_CD
				     ,  (select nvl(ABRV_DPRT_CD, z.INJC_PLAC_CD) from HZDEPTMMT where DPRT_CD(+)= z.INJC_PLAC_CD) INJC_PLAC_CD
				     ,  z.OHOR_RTRN_YN
				     ,  z.BEMD_NO
				     ,  z.ATTR_NO
				     ,  z.DURV_RESN_CTN
				     ,  z.PTNO
				     ,  z.RPTN_DT
				     ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)= z.MCDP_CD), z.MCDP_CD) MCDP_CD
				     ,  z.WARD_CD
				     ,  z.ODDR_ID
				     ,  z.GNDR_ID
				     ,  z.RCPC_YN
				     ,  z.UPDT_BEMD_NO
				     ,  z.DRUG_INJC_DVSN_CD
				     ,  z.PHDP_OROC_DPRT_CD
				     ,  z.TKMD_CCHN_YN
				     ,  z.IHOH_DVSN_CD
				     ,  z.NRDR_YN
				     ,  z.PSDG_YN
				     ,  z.CLNC_YN
				     ,  z.MDCR_YMD
				     ,  z.ENVL_MEMO_CTN1  ENVL_MEMO_CTN_1
				     ,  z.ENVL_MEMO_CTN2  ENVL_MEMO_CTN_2
				     ,  z.PTNT_NM
				     ,  z.FRRN
				     ,  z.BRRN
				     ,  z.AFI_AGE_VL_STR
				     ,  z.GEND_CD
				     ,  z.PTNT_TLNO        PTNT_TLNO
				     ,  z.PTNT_TLNO2       PTNT_TLNO_2
				     ,  z.PTNT_TLNO3       PTNT_TLNO_3
				     ,  z.ISTY_CD
				     ,  z.MDPR_NM_2        ORDR_NM
				     ,  z.ORDR_NM          ODDR_NM
				     ,  z.GNDR_NM
				     ,  z.SBSN_MDPR_ABSL_DSLW_YN
				     ,  z.USER_LCNS_NO
				     ,  z.KPNG_PLAC_CD
				     ,  z.PTRM_NO
				     ,  decode(z.INJT_STER_CMMD_YN,'Y', fn_sd_availableperiod_s2(z.ORDR_YMD,z.MDTN_NO_DVSN_CD,z.MDTN_NO_3,z.MDTN_LCDV_CD,z.PHDP_CMMD_BNDL_NO, z.MDPR_CD), '') AFI_VALD_HH_STR
				     ,  z.RELS_YN
				     ,  z.WARD_LABL_PRIN_YN
				     ,  z.EDI_CD
				     ,  z.ISTY_ASST_CD
				     ,  (select b1.LAST_USE_VLM
				           from SDIJSTMAT a1
				              , SDIJSTPST b1
				              , SDDDGCDMT c1
				          where c1.MDPR_CD = z.MDPR_CD
				            and b1.MDPR_CD = z.MDPR_CD
				            and c1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
				            and b1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
				            and (  (nvl(z.MDPR_CLSF_DETL_CD, 'xx') <> '10'   and z.INJT_STER_CMMD_YN = 'Y' )
				                  or
				                   (nvl(z.MDPR_CLSF_DETL_CD, 'xx') = '10' )
				                )            
				            and rownum < 2)    NMBR_VL   /* PREMEDML */
						,  (select a1.ACDG_PHDP_UNSB_MEMO
				              from SDIJSTMAT a1
				                  , SDIJSTPST b1
				                  , SDDDGCDMT c1
				              where c1.MDPR_CD = z.MDPR_CD
				                and b1.MDPR_CD = z.MDPR_CD
				                and c1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
				                and b1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
				                and (  (nvl(z.MDPR_CLSF_DETL_CD, 'xx') <> '05'   and z.INJT_STER_CMMD_YN = 'Y' )
				                      or
				                       (nvl(z.MDPR_CLSF_DETL_CD, 'xx') = '05' )
				                    )
				                and rownum < 2)    ACDG_PHDP_UNSB_MEMO   /* PREMEDML */
				     ,  z.SCIN_CD
				     ,  z.MDTN_STRT_YMD
				     ,  z.SCIN_NM
				     ,  z.MDTN_NO_3
				     ,  z.AFI_IPDV_NM
				     ,  z.ACKN_EDI_CD
				     ,  z.PTNT_TYPE_NM_2
				     ,  z.AFI_ISTY_ASST_NM_2
				     ,  z.CHCN_YN
				     ,  z.STST_DVSN_CD
				     ,  z.ATMT_CLAM_YN
				     ,  z.WSCN_SNGN_YN
				     ,  z.NTNL_CD
				     ,  z.PCUN_INLS_QTY
				     ,  z.AFI_MDPR_ORLM_AGE_DDCN_STR
				     ,  z.AFI_ERRM_LCTN_NM
				     ,  z.KORN_PDCT_NM
		             ,  decode(		
				              decode(	(select nvl(sum(case when b.RTRN_DETL_DVSN_CD = 'B' then 1
		                                                     else b.RTRN_RQST_CQY
		                                                     end ) ,0)   /* 미수령 반납은 강제로 1을 리턴.*/
					     	              from SDJDGRTNT b
						                 where z.ORDR_YMD = b.ORDR_YMD
						                  and  z.ORDR_SNO = b.ORDR_SNO
			                              and  z.MDTN_NO = b.MDTN_NO
							              /*and  ((b.RTRN_CNFR_YMD is not null) or (b.RTRN_CNFR_YMD is null and b.RTRN_DETL_DVSN_CD = 'B'))*/
							              and  z.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
							              and  z.MDTN_LCDV_CD = b.MDTN_LCDV_CD
		                                  and  b.RTRN_DETL_DVSN_CD != 'Z'  /* 잔량 반납 제외 */
							        ), 0 , '' , 'Y')
						      ,'Y', '[반납]', '')
		              || decode(		
		                         decode(  (select count(*)
		                                    from (
		                               select 1
		                                 from MDDCREQMT b  /*간호반납신청*/
		                                where b.PTNO     = z.PTNO
		                                  and b.ORDR_YMD = z.ORDR_YMD
		                                  and b.ORDR_SNO = z.ORDR_SNO
		                              )                                   
		                       ), 0 , '' , 'Y')
		                ,'Y', '[신청]', '')
			    || decode(z.dc_dvsn_cd, 'Y', '[DC]/', 'X', '[취소]/', '') 
			    || z.SMRY_MDPR_NM		AS SMRY_MDPR_NM
				     ,  z.SHDN_YN
				     ,  z.AFI_CMMD_AFTR_KPNG_PLAC_NM
				     ,  z.RCPC_DT
				     ,  z.VALD_HH2      AFI_VALD_HH_STR_1
				     ,  z.MDTN_LCDV_CD
				     ,  z.HGPR_DGMT_CD
				     ,  z.DGST_YN_CTN 
				     ,  z.AFI_ORDR_SNO_STR
				     ,  z.RTRN_CNFR_CQY
				     ,  z.PTNT_NM_2
				     ,  z.HGRS_HGCC_MDPR_YN
				     ,  z.INJC_PLAC_CD       INJC_PLAC_CD_1
				     ,  z.WARD_CD1           WARD_CD_1
				     ,  z.MCDP_CD            MCDP_CD_1
				     , z.MDPR_CLSF_DETL_CD
				     , #{inqrDvsnCd}                     as INQR_DVSN_CD
				     , #{inptClntPrgmId}                 as INPT_CLNT_PRGM_ID
					 , z.ward_labl_prin_yn
				     , z.prin_dt
		             , trim(replace(replace(replace(replace(replace(replace(z.DRUG_ORDR_UNSL_CTN,'[고위험]',''),'[냉장]',''),'[차광]',''),'[실온,차광]',''),'[상온,차광]',''), '[냉장,차광]' , '' )) DRUG_ORDR_UNSL_CTN
		             , z.CMMD_UNSB_CTN as CMMD_UNSB_CTN
		             , z.SPSB_CTN_1
		             , z.TRGT_YN
				      from (
				            select
				                    to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD
				                 ,  a.MDTN_NO_DVSN_CD
				                 ,  lpad(to_char(a.MDTN_NO), 4, '0')   AFI_MDTN_NO_STR
		                         ,  a.MDTN_NO
				                 ,  a.ORDR_SNO
				                 ,  a.MDPR_CD
				                 ,  FN_SD_GETHGCTMDPRNM_S(a.MDPR_CD,b.MDPR_NM) as MDPR_NM
				                 ,  FN_SD_GETHGCTMDPRNM_S(a.MDPR_CD,b.SMRY_MDPR_NM) as SMRY_MDPR_NM		                 
				                 ,  e.PTDV_CD
				                 ,  a.MDPR_CLSF_CD
				                 ,  a.DRAP_DVSN_CD
				                 ,  a.CMMD_STTS_CD
				                 ,  decode(a.DRAP_DVSN_CD, '2', a.PCKN_UNAD_QTY, round(a.PCKN_UNAD_QTY, 2) )   PCKN_UNAD_QTY
				                 ,  a.PCUN_NM
				                 ,  decode(a.DRAP_DVSN_CD, '2', a.ICUN_ADMN_VLM, round(a.ICUN_ADMN_VLM, 2) )   ICUN_ADMN_VLM
				                 ,  a.ICUN_CD
				                 ,  a.SLCT_UNIT_DVSN_CD
				                 ,  a.MDTN_DDCN
				                 ,  a.DRUS_CD
				                 ,  a.MDNT
				                 ,  decode(a.DRAP_DVSN_CD, '2', decode(h.FRNS_CTRL_DVSN_CD, null, a.TOTL_CLCL_QTY, a.INVN_TOTL_QTY)
				                               , round(decode(h.FRNS_CTRL_DVSN_CD, null, a.TOTL_CLCL_QTY, a.INVN_TOTL_QTY), 2))  TOTL_CLCL_QTY
				                 ,  decode(a.DRAP_DVSN_CD, '2', a.INVN_TOTL_QTY, round(a.INVN_TOTL_QTY, 2))             INVN_TOTL_QTY
				                 ,  a.PHDP_CMMD_BNDL_NO
				                 ,  a.DRBN_NO
				                 ,  nvl(a.MIX_KIND_CD, '*')  MIX_KIND_CD
				                 ,  a.BSIS_CMMD_PLAC_CD
				                 ,  fn_sd_isnumber_s(a.SPSB_CTN) SPSB_CTN
				                 ,  null                        as FDNO_YN
				                 ,  a.ISDV_CD
				                 ,  to_char(e.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT
				                 ,  a.SDPF_EXRE_CD
				                 ,  a.INJC_PLAC_CD
				                 ,  a.OHOR_RTRN_YN
				                 ,  a.BEMD_NO
				                 ,  a.ATTR_NO
				                 ,  a.DURV_RESN_CTN
				                 ,  e.PTNO
				                 ,  to_char(e.RPTN_DT, 'YYYYMMDDHH24MISS')  RPTN_DT
				                 ,  e.MCDP_CD
				                 ,  nvl(k.ABRV_DPRT_CD, e.WARD_CD)  WARD_CD
				                 ,  e.ODDR_ID
				                 ,  e.GNDR_ID
				                 ,  e.RCPC_YN
				                 ,  e.UPDT_BEMD_NO
				                 ,  e.DRUG_INJC_DVSN_CD
				                 ,  e.PHDP_OROC_DPRT_CD
				                 ,  e.TKMD_CCHN_YN
				                 ,  e.IHOH_DVSN_CD
				                 ,  e.NRDR_YN
				                 ,  e.PSDG_YN
				                 ,  e.CLNC_YN
				                 ,  to_char(e.MDCR_YMD, 'YYYYMMDD')   MDCR_YMD
				                 ,  decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN1, c.ENVL_MEMO_CTN3)                             ENVL_MEMO_CTN1
				                 ,  decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN2, c.ENVL_MEMO_CTN4)                             ENVL_MEMO_CTN2
				                 ,  decode( fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD), '', substr(f.PTNT_NM, 1, 11)
				                                     ,substr(f.PTNT_NM, 1, 9))||fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD)  PTNT_NM
				                 ,  f.FRRN
				                 ,  f.BRRN
				                 ,  case when (trunc(months_between(a.ORDR_YMD, f.BTDT)/12)) > 5 then to_char(trunc(months_between(a.ORDR_YMD, f.BTDT)/12))
				         				 else to_char(trunc(months_between(a.ORDR_YMD, f.BTDT)/12) ||'-'|| trunc(mod(months_between(a.ORDR_YMD, f.BTDT), 12)))
				            		end   AFI_AGE_VL_STR    /* 나이 */
				                 ,  f.GEND_CD
				                 ,  ( select max(PTNT_TLNO)  from APPTCNPNV t1 where  t1.PTNO = a.PTNO  and t1.CNPN_DVSN_CD = 'BH' )  PTNT_TLNO
				                 ,  ( select max(PTNT_TLNO)  from APPTCNPNV t2 where  t2.PTNO = a.PTNO  and t2.CNPN_DVSN_CD = 'BP' )  PTNT_TLNO2
				                 ,  ( select max(PTNT_TLNO)  from APPTCNPNV t3 where  t3.PTNO = a.PTNO  and t3.CNPN_DVSN_CD = 'EA' )  PTNT_TLNO3
				                 ,  h.ISTY_CD
				                 ,  ( select t.PHRM_DTLS_CTRL_NM from SDMCTRLMT t  where t.PHRM_CTRL_CD = 'SD158' and t.PHRM_DTLS_CTRL_CD = a.MDPR_CD )  MDPR_NM_2
				                 ,  ( select USER_NM from CCUSRDPHT t where  t.USER_ID = e.ODDR_ID )   ORDR_NM
				                 ,  ( select USER_NM from CCUSRDPHT t where  t.USER_ID = e.GNDR_ID )   GNDR_NM
				                 ,  nvl(( select 'Y' from SDDREPLCT t where t.MDPR_CD = a.MDPR_CD and rownum =1  )  , 'N')  SBSN_MDPR_ABSL_DSLW_YN
				                 ,  ( select g2.USER_LCNS_NO
				                        from CCUSRDPHT g
				                           , CCUSERAMT g2
				                       where
				                             g.USER_ID  = e.ODDR_ID
				                         and g2.LGIN_ID = g.LGIN_ID
				                    )                               USER_LCNS_NO
				                 ,  b.KPNG_PLAC_CD
				                 ,  j.PTRM_NO
				                 ,  null           VALD_HH -- b.VALD_HH
				                 ,  b.RELS_YN
				                 ,  ''             edi_cd
				                 ,  ''             isty_asst_cd
				                 ,  fn_md_main_scin('1', a.PTNO, h.MDRP_NO) as SCIN_CD 
				                 ,  to_char(a.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS')  mdtn_strt_ymd
				                 ,  fn_md_main_scin('2', a.PTNO, h.MDRP_NO) as SCIN_NM      
				                 ,  a.MDTN_NO      mdtn_no_3
				                 ,  ''             afi_ipdv_nm
				                 ,  ''             ackn_edi_cd
				                 ,  ''             ptnt_type_nm_2
				                 ,  ''             afi_isty_asst_nm_2
				                 ,  ( select  CHCN_YN from APRCADBLT j2 where j2.MDRP_NO = h.MDRP_NO ) CHCN_YN
				                 ,  b.STST_DVSN_CD
				                 ,  'N'                     atmt_clam_yn
				                 ,  b.WSCN_SNGN_YN
				                 ,  nvl(f.NTNL_CD, 'KR')   NTNL_CD
				                 ,  b.PCUN_INLS_QTY
				                 ,  ''                      afi_mdpr_orlm_age_ddcn_str
				                 ,  ''                      afi_errm_lctn_nm
				                 ,  b.KORN_PDCT_NM
				                 ,  decode( ( select t.PHRM_DTLS_CTRL_NM from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD158' and t.PHRM_DTLS_CTRL_CD = a.MDPR_CD ), null, 'N', 'Y')  SHDN_YN
				                 ,  decode(b.INJT_STER_CMMD_YN, 'Y', nvl(FN_SD_GETKPNGINFO_S('1', a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_LCDV_CD,  a.MDTN_NO, a.PHDP_CMMD_BNDL_NO, a.MDPR_CD) ,'') , '')  afi_cmmd_aftr_kpng_plac_nm
				                 ,  to_char(a.RCPC_DT, 'YYYYMMDDHH24MI')   RCPC_DT
				                 ,  decode(b.INJT_STER_CMMD_YN,'Y', nvl(FN_SD_GETKPNGINFO_S('2', a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_LCDV_CD,  a.MDTN_NO, a.PHDP_CMMD_BNDL_NO, a.MDPR_CD) ,'') , '') VALD_HH2
				                 ,  a.MDTN_LCDV_CD
				                 ,  decode( (select t.PHRM_DTLS_CTRL_CD
				                               from SDMCTRLMT t
				                              where t.PHRM_CTRL_CD = 'SD931'
				                                and t.PHRM_DTLS_CTRL_CD = a.MDPR_CD  ), null, 'N', 'Y' )   HGPR_DGMT_CD
				                 ,  decode( (select t.DETL_CD_NM
				                               from SDCMCDDMV t
				                              where t.COMN_GRP_CD = 'SD166'
				                                and t.COMN_DTLS_CD = a.MDPR_CD  ), null, '' , 'Y' )  DGST_YN_CTN -- AFI_SHDN_KPNG_DGST_YN
				                 ,  lpad(to_char(a.ORDR_SNO), 2, '0')    AFI_ORDR_SNO_STR
				                 ,  0                                  as RTRN_CNFR_CQY
				                  ,  decode( fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD), '', substr(f.PTNT_NM, 1, 18)
				                                     ,substr(f.PTNT_NM, 1, 16))|| fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD)   PTNT_NM_2
				                  ,  b.HGRS_HGCC_MDPR_YN
				                  , case when #{afiItemSortSqncStr} = '2' then
				                               decode(a.MDTN_NO_DVSN_CD||b.BSIS_CMMD_PLAC_CD||a.BSIS_CMMD_PLAC_CD||nvl(b.PTP_MDPR_YN,'N'),'D31N','Z','A')
				                             || to_char(a.ORDR_YMD,'YYYYMMDD')
				                             || a.MDTN_NO_DVSN_CD
				                             || lpad(to_char(a.MDTN_NO), 4, '0')
				                             || a.BSIS_CMMD_PLAC_CD
				                             ||  lpad(to_char( a.PHDP_CMMD_BNDL_NO), 4,'0')
				                             || nvl(b.WSCN_SNGN_YN,'N')
				                             || decode(b.KPNG_PLAC_CD,'1','1','3','2','7','1','3')
				                             || b.KPNG_PLAC_CD|| rpad(a.MDPR_CD,10,' ')
				                             || lpad(to_char( a.ORDR_SNO), 10,'0' )
				                         when #{afiItemSortSqncStr} = '3' then
				                                decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' '), '1')
				                             || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' ')
				                                     , decode(a.MDTN_NO_DVSN_CD||b.BSIS_CMMD_PLAC_CD||a.BSIS_CMMD_PLAC_CD||nvl(b.PTP_MDPR_YN,'N'),'D31N','Z','A'))
				                             || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' ')
				                                     , decode(a.MIX_KIND_CD,NULL,'0',decode(nvl(b.WSCN_SNGN_YN,'N'),'Y','0',a.MIX_KIND_CD)))
				                             || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' '), a.DRAP_DVSN_CD )
				                             || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' ')
				                                     , decode(nvl(a.MIX_KIND_CD,'0'),'0',rpad(a.MDPR_CD,10,' '),decode(nvl(b.WSCN_SNGN_YN,'N'),'Y',rpad(a.MDPR_CD,10,' '),'ZZZ')) )
				                             || lpad( to_char(k.PHDP_CMMD_SQNC_VL ) , 10, '0' )
				                             || rpad( k.ABRV_DPRT_CD, 7,'0' )
				                             || lpad(to_char(  j.PTRM_NO) ,5, '0')
				                             || f.PTNO || to_char(a.ORDR_YMD,'YYYYMMDD')
				                             || a.MDTN_NO_DVSN_CD
				                             || lpad( to_char( a.MDTN_NO), 4, '0')
				                             || lpad( to_char( a.PHDP_CMMD_BNDL_NO ), 4,'0' )
				                             || decode(b.KPNG_PLAC_CD,'1','1','3','2','7','1','3')
				                             || b.KPNG_PLAC_CD
				                         when #{afiItemSortSqncStr} = '4' then
				                                case when b.MDPR_CLSF_CD = '2' then 9 else 1 end
				                             || lpad( to_char(k.PHDP_CMMD_SQNC_VL ) , 10, '0' )
				                             || rpad( k.ABRV_DPRT_CD, 7,'0' )
				                             || rpad(a.MDPR_CD,10,' ')
				                             || lpad(to_char(  j.PTRM_NO) ,5, '0') || f.PTNO
				                             || to_char( a.ORDR_YMD, 'YYYYMMDD')
				                             || a.MDTN_NO_DVSN_CD
				                             || lpad( to_char( a.MDTN_NO), 4, '0')
				                             || lpad( to_char( a.PHDP_CMMD_BNDL_NO ), 4,'0' )
				                         else
				                                decode(a.MDTN_NO_DVSN_CD
				                                        ||b.BSIS_CMMD_PLAC_CD
				                                        ||a.BSIS_CMMD_PLAC_CD
				                                        ||nvl(b.PTP_MDPR_YN,'N'),'D31N','Z','A')
				                                        || lpad( to_char(k.PHDP_CMMD_SQNC_VL ) , 10, '0' )
				                             || rpad( k.ABRV_DPRT_CD, 7,'0' )
				                             || lpad(to_char(  j.PTRM_NO) ,5, '0')
				                             || e.PTNO || to_char( a.ORDR_YMD, 'YYYYMMDD')
				                             || e.MDTN_NO_DVSN_CD
				                             || lpad( to_char( a.MDTN_NO), 4, '0')
				                             || lpad( to_char( a.PHDP_CMMD_BNDL_NO ), 4,'0' )
				                             || decode(a.BSIS_CMMD_PLAC_CD,'8', decode(m.PHRM_DTLS_CTRL_CD,null,'Z','1'),'B', decode(m.PHRM_DTLS_CTRL_CD,null,'Y','1')
				                                     , decode(a.BSIS_CMMD_PLAC_CD,'7','Z',nvl(b.WSCN_SNGN_YN, 'N')))
				                             || decode(a.BSIS_CMMD_PLAC_CD,'8', 'Z','B', 'Z',e.DRUG_INJC_DVSN_CD)
				                             || decode(a.BSIS_CMMD_PLAC_CD,'8', 'Z','B', 'Z',decode(b.KPNG_PLAC_CD,'1','1','3','2','7','1','3')||b.KPNG_PLAC_CD)
				                             || decode(a.BSIS_CMMD_PLAC_CD,'8', 'Z','B', 'Z',rpad(a.MDPR_CD,10,' ')) || lpad( to_char( a.ORDR_SNO ), 10,'0' )
				                     end   orderkey
				                  ,  b.INJT_STER_CMMD_YN
				                  ,  e.WARD_CD WARD_CD1
				                  ,  b.mdpr_clsf_detl_cd
								  ,  a.ward_labl_prin_yn
								  ,  to_char(a.prin_dt, 'yyyyMMddhh24miss') prin_dt
		                          ,  h.DRUG_ORDR_UNSL_CTN
		                          ,  b.CMMD_UNSB_CTN
		                          ,  h.DC_DVSN_CD
		                          ,  n.PHRM_DTLS_CTRL_NM as SPSB_CTN_1
		                          ,  min(case
		                                   when (select fn_cc_get_cnst_vl('SDB_001','ACDG_RBTC_USE_YN') from dual) = 'N' then 'N'
		                                   when b.MDPR_CLSF_DETL_CD = '10' and a.PCKN_UNAD_QTY != 1 then 'N'  -- 수액의 포장단위1회량이 1이 아니면 대상 아님
		                                   else decode(o.PHRM_DTLS_CTRL_CD, null, 'N', 'Y')
		                                 end) over (partition by a.ORDR_YMD,a.MDTN_LCDV_CD,a.MDTN_NO_DVSN_CD,a.MDTN_NO,a.PHDP_CMMD_BNDL_NO)        as TRGT_YN
				              from
				                     SDPORDDET a,
				                     SDDDGCDMT b,
				                     SDDMETCDT c,
				                     SDPORDBAT e,
				                     APPTPTNTV f,
				                     MDMEDORDT h,
				                     APRCRPTNT j,
				                     HZDEPTMMT k,
				                     SDJFIXQTT l,
				                     SDMCTRLMT m,
		                             SDMCTRLMT n,
		                             SDMCTRLMT o
				         where a.ORDR_YMD    >= to_date(#{ordrYmd1} , 'YYYYMMDD')
				           and a.ORDR_YMD    <= to_date(#{ordrYmd2} , 'YYYYMMDD')
				           and a.MDTN_LCDV_CD = #{mdtnLcdvCd}                   
				           /*--------------------------------------------------------------------------------------------------------------*/
				           /* MIX처방(항암/항생/MIX주사) 일괄변경 조건
				           /*--------------------------------------------------------------------------------------------------------------*/
				           and a.MDTN_NO_DVSN_CD   in ('A', 'B', 'E', 'C', 'S')                    /* 투약번호구분코드  A 병동정규 / B 병동추가 / E 병동응급 / C 단기입원 */                   
				           and instr(#{afiMdtnNoDvsnNm}, a.MDTN_NO_DVSN_CD) > 0                   
				           and a.BSIS_CMMD_PLAC_CD in ('8', '9', 'B', 'V')  /* BSIS_CMMD_PLAC_CD : 8 무균제(기타)MIX / 9 항생제MIX / B 항암제MIX / V 임상시험약-MIX */ /* 임상시험약-MIX 추가 */ /* 2020.08.26 수정 */
				           and instr(#{afiBsisCmmdPlacNm}, a.BSIS_CMMD_PLAC_CD) > 0                   
				           and a.PTDV_CD            = #{ptdvCd}                          /* 응급실 환자가 MIX처방은 없음 */
				           and a.CMMD_STTS_CD       < '6'                                /* 5 투약완료(약품출고) */
				           and a.CMMD_STTS_CD       = nvl(#{cmmdSttsCd}, a.CMMD_STTS_CD) /* 5 투약완료(약품출고) */                   
				           and a.DRAP_DVSN_CD       = '2'                     /* 약적용구분코드  1 내복약 / 2 주사약 / 3 외용약 / 9 기타 */
				           and a.MDPR_CLSF_CD  not in ('2', '3', '8')         /* 약품분류코드  1 일반의약품 / 2 향정신성의약품 / 3 마약 / 5 제제약품 / 6 원료약품 / 7 조영제 / 8 TPN / 9 묶음약 */ /* TPN 처방 같은 조제실이라 하더라도 따로 뽑는다 */
				           and a.DRUS_CD           != 'IRB'                   /* 임상시험약용(주사) */
				           and a.MDTN_NO >= case when nvl(#{mdtnNo1}, 0) = 0 then a.MDTN_NO
				                                                             else #{mdtnNo1}
				                            end
				           and a.MDTN_NO <= case when nvl(#{mdtnNo2}, 0) = 0 then a.MDTN_NO
				                                                             else #{mdtnNo2}
				                            end
				           and a.PHDP_CMMD_BNDL_NO = case when nvl(#{phdpCmmdBndlNo}, 0) = 0 then a.PHDP_CMMD_BNDL_NO
				                                                                             else #{phdpCmmdBndlNo}     /* RP */
				                                     end                   		           
				           /*--------------------------------------------------------------------------------------------------------------*/
				               and  a.ORDR_SNO          = decode(nvl(#{afiOrdrSnoStr} , 'X'), 'R', a.ORDR_SNO, nvl(#{afiOrdrSnoStr}, a.ORDR_SNO))	               
				               and  b.MDPR_CD           = a.MDPR_CD           
				               and  c.DRUS_CD(+)        = a.DRUS_CD
				               and  e.ORDR_YMD          = a.ORDR_YMD
				               and  e.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
				               and  e.MDTN_NO           = a.MDTN_NO
				               and  e.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
				               and  e.WARD_CD           = nvl(#{wardCd} , e.WARD_CD)
				               and  f.PTNO              = a.PTNO
				               and  h.PTNO              = a.PTNO
				               and  h.ORDR_YMD          = a.ORDR_YMD
				               and  h.ORDR_SNO          = a.ORDR_SNO
				               and  j.MDRP_NO           = h.MDRP_NO
				               and  l.DPRT_CD(+)        = a.INJC_PLAC_CD
				               and  l.MDPR_CD(+)        = a.MDPR_CD
				               and  l.EQPT_FDNO_DVSN_CD(+)    = '2'
				               and  k.DPRT_CD(+) = e.WARD_CD
				               and  m.PHRM_CTRL_CD     (+)  = 'SD149'
				               and  m.PHRM_DTLS_CTRL_CD(+)  = a.MDPR_CD
		                       and  n.PHRM_CTRL_CD     (+)  = 'SD170'  /* 약품 특이사항*/	
		                       and  n.PHRM_DTLS_CTRL_CD(+)  = a.MDPR_CD
		                       and  o.PHRM_CTRL_CD     (+)  = 'SDD_017'  /* 항암제조제로봇 대상약품 */
		                       and  o.PHRM_DTLS_CTRL_CD(+)  = a.MDPR_CD
				      ) z
				      order by z.orderkey;
				]]>		
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptAcdgOrdrLablPrin-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN_1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno2" column="PTNT_TLNO_2"/>
		<result property="ptntTlno3" column="PTNT_TLNO_3"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="afiValdHhStr" column="AFI_VALD_HH_STR"/>
		<result property="relsYn" column="RELS_YN"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="istyAsstCd" column="ISTY_ASST_CD"/>
		<result property="nmbrVl" column="NMBR_VL"/>
		<result property="acdgPhdpUnsbMemo" column="ACDG_PHDP_UNSB_MEMO"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="mdtnStrtYmd" column="MDTN_STRT_YMD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="mdtnNo3" column="MDTN_NO_3"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="acknEdiCd" column="ACKN_EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="chcnYn" column="CHCN_YN"/>
		<result property="ststDvsnCd" column="STST_DVSN_CD"/>
		<result property="atmtClamYn" column="ATMT_CLAM_YN"/>
		<result property="wscnSngnYn" column="WSCN_SNGN_YN"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="pcunInlsQty" column="PCUN_INLS_QTY"/>
		<result property="afiMdprOrlmAgeDdcnStr" column="AFI_MDPR_ORLM_AGE_DDCN_STR"/>
		<result property="afiErrmLctnNm" column="AFI_ERRM_LCTN_NM"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="shdnYn" column="SHDN_YN"/>
		<result property="afiCmmdAftrKpngPlacNm" column="AFI_CMMD_AFTR_KPNG_PLAC_NM"/>
		<result property="rcpcDt" column="RCPC_DT"/>
		<result property="afiValdHhStr1" column="AFI_VALD_HH_STR_1"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="hgprDgmtCd" column="HGPR_DGMT_CD"/>
		<result property="dgstYnCtn" column="DGST_YN_CTN"/>
		<result property="afiOrdrSnoStr" column="AFI_ORDR_SNO_STR"/>
		<result property="rtrnCnfrCqy" column="RTRN_CNFR_CQY"/>
		<result property="ptntNm2" column="PTNT_NM_2"/>
		<result property="hgrsHgccMdprYn" column="HGRS_HGCC_MDPR_YN"/>
		<result property="injcPlacCd1" column="INJC_PLAC_CD_1"/>
		<result property="wardCd1" column="WARD_CD_1"/>
		<result property="mcdpCd1" column="MCDP_CD_1"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="wardLablPrinYn" column="WARD_LABL_PRIN_YN"/>
		<result property="mdprClsfDetlCd" column="MDPR_CLSF_DETL_CD"/>
		<result property="othsCmmdUnsbCtn" column="OTHS_CMMD_UNSB_CTN"/>
		<result property="drugOrdrUnslCtn" column="DRUG_ORDR_UNSL_CTN"/>
		<result property="spsbCtn1" column="SPSB_CTN_1"/>
		<result property="trgtYn" column="TRGT_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptAcdgOrdrLablPrin () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptAcdgOrdrLablPrin-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptAcdgOrdrLablPrin"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptAcdgOrdrLablPrin-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptAcdgOrdrLablPrin */
		<![CDATA[
		 select  /*+ sdd_porddev_l11$S01_라벨 강제출력 */ 
				                z.ORDR_YMD
				             ,  z.MDTN_NO_DVSN_CD
				             ,  z.AFI_MDTN_NO_STR
				             ,  z.ORDR_SNO
				             ,  z.MDPR_CD
		                     ,  z.MDPR_NM
				             ,  z.PTDV_CD
				             ,  z.MDPR_CLSF_CD
				             ,  z.DRAP_DVSN_CD
				             ,  z.CMMD_STTS_CD
				             ,  z.PCKN_UNAD_QTY
				             ,  z.PCUN_NM
				             ,  z.ICUN_ADMN_VLM
				             ,  z.ICUN_CD
				             ,  z.SLCT_UNIT_DVSN_CD
				             ,  z.MDTN_DDCN
				             ,  z.DRUS_CD
				             ,  z.MDNT
				             ,  z.TOTL_CLCL_QTY
				             ,  z.INVN_TOTL_QTY
				             ,  z.PHDP_CMMD_BNDL_NO
				             ,  z.DRBN_NO
				             ,  z.MIX_KIND_CD
				             ,  z.BSIS_CMMD_PLAC_CD
				             ,  z.SPSB_CTN
				             ,  z.FDNO_YN
				             ,  z.ISDV_CD
				             ,  z.DRUG_ORDR_INPT_DT
				             ,  z.SDPF_EXRE_CD
				             ,  (select nvl(ABRV_DPRT_CD, z.INJC_PLAC_CD) from HZDEPTMMT where DPRT_CD(+)= z.INJC_PLAC_CD) INJC_PLAC_CD
				             ,  z.OHOR_RTRN_YN
				             ,  z.BEMD_NO
				             ,  z.ATTR_NO
				             ,  z.DURV_RESN_CTN
				             ,  z.PTNO
				             ,  z.RPTN_DT
				             ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)= z.MCDP_CD), z.MCDP_CD) MCDP_CD
				             ,  z.WARD_CD
				             ,  z.ODDR_ID
				             ,  z.GNDR_ID
				             ,  z.RCPC_YN
				             ,  z.UPDT_BEMD_NO
				             ,  z.DRUG_INJC_DVSN_CD
				             ,  z.PHDP_OROC_DPRT_CD
				             ,  z.TKMD_CCHN_YN
				             ,  z.IHOH_DVSN_CD
				             ,  z.NRDR_YN
				             ,  z.PSDG_YN
				             ,  z.CLNC_YN
				             ,  z.MDCR_YMD
				             ,  z.ENVL_MEMO_CTN1  ENVL_MEMO_CTN_1
				             ,  z.ENVL_MEMO_CTN2  ENVL_MEMO_CTN_2
				             ,  z.PTNT_NM
				             ,  z.FRRN
				             ,  z.BRRN
				             ,  z.AFI_AGE_VL_STR
				             ,  z.GEND_CD
				             ,  z.PTNT_TLNO        PTNT_TLNO
				             ,  z.PTNT_TLNO2       PTNT_TLNO_2
				             ,  z.PTNT_TLNO3       PTNT_TLNO_3
				             ,  z.ISTY_CD
				             ,  z.MDPR_NM_2        ORDR_NM
				             ,  z.ORDR_NM          ODDR_NM
				             ,  z.GNDR_NM
				             ,  z.SBSN_MDPR_ABSL_DSLW_YN
				             ,  z.USER_LCNS_NO
				             ,  z.KPNG_PLAC_CD
				             ,  z.PTRM_NO
				             ,  decode(z.INJT_STER_CMMD_YN,'Y', fn_sd_availableperiod_s2(z.ORDR_YMD,z.MDTN_NO_DVSN_CD,z.MDTN_NO_3,z.MDTN_LCDV_CD,z.PHDP_CMMD_BNDL_NO, z.mdpr_cd), '') AFI_VALD_HH_STR
				             ,  z.RELS_YN
				             ,  z.EDI_CD
				             ,  z.ISTY_ASST_CD
				             ,  (select b1.LAST_USE_VLM
						           from SDIJSTMAT a1
						              , SDIJSTPST b1
						              , SDDDGCDMT c1
						          where c1.MDPR_CD = z.MDPR_CD
						            and b1.MDPR_CD = z.MDPR_CD
						            and c1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
						            and b1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
						            and (  (nvl(z.MDPR_CLSF_DETL_CD, 'xx') <> '10'   and z.INJT_STER_CMMD_YN = 'Y' )
						                  or
						                   (nvl(z.MDPR_CLSF_DETL_CD, 'xx') = '10' )
						                )            
						            and rownum < 2)    NMBR_VL   /* PREMEDML */
							 ,  (select a1.ACDG_PHDP_UNSB_MEMO
					               from SDIJSTMAT a1
					                  , SDIJSTPST b1
					                  , SDDDGCDMT c1
					              where c1.MDPR_CD = z.MDPR_CD
					                and b1.MDPR_CD = z.MDPR_CD
					                and c1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
					                and b1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
					                and (  (nvl(z.MDPR_CLSF_DETL_CD, 'xx') <> '05'   and z.INJT_STER_CMMD_YN = 'Y' )
					                      or
					                       (nvl(z.MDPR_CLSF_DETL_CD, 'xx') = '05' )
					                    )
					                and rownum < 2)    ACDG_PHDP_UNSB_MEMO   /* PREMEDML */
				             ,  z.SCIN_CD
				             ,  z.MDTN_STRT_YMD
				             ,  z.SCIN_NM
				             ,  z.MDTN_NO_3
				             ,  z.AFI_IPDV_NM
				             ,  z.ACKN_EDI_CD
				             ,  z.PTNT_TYPE_NM_2
				             ,  z.AFI_ISTY_ASST_NM_2
				             ,  z.CHCN_YN
				             ,  z.STST_DVSN_CD
				             ,  z.ATMT_CLAM_YN
				             ,  z.WSCN_SNGN_YN
				             ,  z.NTNL_CD
				             ,  z.PCUN_INLS_QTY
				             ,  z.AFI_MDPR_ORLM_AGE_DDCN_STR
				             ,  z.AFI_ERRM_LCTN_NM
				             ,  z.KORN_PDCT_NM
				             ,  decode(		
				              decode(	(select nvl(sum(case when b.RTRN_DETL_DVSN_CD = 'B' then 1
		                                                     else b.RTRN_RQST_CQY
		                                                     end ) ,0)   /* 미수령 반납은 강제로 1을 리턴.*/
					     	              from SDJDGRTNT b
						                 where z.ORDR_YMD = b.ORDR_YMD
						                  and  z.ORDR_SNO = b.ORDR_SNO
			                              and  z.MDTN_NO = b.MDTN_NO
							              /*and  ((b.RTRN_CNFR_YMD is not null) or (b.RTRN_CNFR_YMD is null and b.RTRN_DETL_DVSN_CD = 'B'))*/
							              and  z.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
							              and  z.MDTN_LCDV_CD = b.MDTN_LCDV_CD
		                                  and  b.RTRN_DETL_DVSN_CD != 'Z'  /* 잔량 반납 제외 */
							        ), 0 , '' , 'Y')
						      ,'Y', '[반납]', '')
		              || decode(		
		                         decode(  (select count(*)
		                                    from (
		                               select 1
		                                 from MDDCREQMT b  /*간호반납신청*/
		                                where b.PTNO     = z.PTNO
		                                  and b.ORDR_YMD = z.ORDR_YMD
		                                  and b.ORDR_SNO = z.ORDR_SNO
		                              )                                   
		                       ), 0 , '' , 'Y')
		                ,'Y', '[신청]', '')
			    || decode(z.dc_dvsn_cd, 'Y', '[DC]/', 'X', '[취소]/', '') 
			    || z.SMRY_MDPR_NM		AS SMRY_MDPR_NM
				             ,  z.SHDN_YN
				             ,  z.AFI_CMMD_AFTR_KPNG_PLAC_NM
				             ,  z.RCPC_DT
				             ,  z.VALD_HH2      AFI_VALD_HH_STR_1
				             ,  z.MDTN_LCDV_CD
				             ,  z.HGPR_DGMT_CD
				             ,  z.DGST_YN_CTN 
				             ,  z.AFI_ORDR_SNO_STR
				             ,  z.RTRN_CNFR_CQY
				             ,  z.PTNT_NM_2
				             ,  z.HGRS_HGCC_MDPR_YN
				             ,  z.INJC_PLAC_CD       INJC_PLAC_CD_1
				             ,  z.WARD_CD1           WARD_CD_1
				             ,  z.MCDP_CD            MCDP_CD_1
				             , #{inqrDvsnCd}                     as INQR_DVSN_CD
				             , #{inptClntPrgmId}                 as INPT_CLNT_PRGM_ID
							 , z.prin_dt
							 , z.ward_labl_prin_yn
		                     , z.mdpr_clsf_detl_cd
		                     , z.OTHS_CMMD_UNSB_CTN
		                     , trim(replace(replace(replace(replace(replace(replace(z.DRUG_ORDR_UNSL_CTN,'[고위험]',''),'[냉장]',''),'[차광]',''),'[실온,차광]',''),'[상온,차광]',''), '[냉장,차광]' , '' )) DRUG_ORDR_UNSL_CTN
		                     , z.SPSB_CTN_1		
		                     , z.TRGT_YN
		          from (
		                select   /*+ no_expand index_rs(e SDPORDBAT_I08) leading(e a l m c b f h j k) use_nl(a l m c b f h j k) */
		                        to_char(a.ORDR_YMD, 'YYYYMMDD')    ORDR_YMD
		                     ,  a.MDTN_NO_DVSN_CD
		                     ,  lpad(to_char(a.MDTN_NO), 4, '0')   AFI_MDTN_NO_STR
		                     ,  a.MDTN_NO
		                     ,  a.ORDR_SNO
		                     ,  a.MDPR_CD
		                     ,  FN_SD_GETHGCTMDPRNM_S(a.MDPR_CD,b.MDPR_NM) as MDPR_NM
		                     ,  FN_SD_GETHGCTMDPRNM_S(a.MDPR_CD,b.SMRY_MDPR_NM) as SMRY_MDPR_NM		  
		                     ,  e.PTDV_CD
		                     ,  a.MDPR_CLSF_CD
		                     ,  a.DRAP_DVSN_CD
		                     ,  a.CMMD_STTS_CD
		                     ,  decode(a.DRAP_DVSN_CD, '2', a.PCKN_UNAD_QTY, round(a.PCKN_UNAD_QTY, 2) )   PCKN_UNAD_QTY
		                     ,  a.PCUN_NM
		                     ,  decode(a.DRAP_DVSN_CD, '2', a.ICUN_ADMN_VLM, round(a.ICUN_ADMN_VLM, 2) )   ICUN_ADMN_VLM
		                     ,  a.ICUN_CD
		                     ,  a.SLCT_UNIT_DVSN_CD
		                     ,  a.MDTN_DDCN
		                     ,  a.DRUS_CD
		                     ,  a.MDNT
		                     ,  decode(a.DRAP_DVSN_CD, '2', decode(h.FRNS_CTRL_DVSN_CD, null, a.TOTL_CLCL_QTY, a.INVN_TOTL_QTY)
		                                   , round(decode(h.FRNS_CTRL_DVSN_CD, null, a.TOTL_CLCL_QTY, a.INVN_TOTL_QTY), 2))  TOTL_CLCL_QTY
		                     ,  decode(a.DRAP_DVSN_CD, '2', a.INVN_TOTL_QTY, round(a.INVN_TOTL_QTY, 2))             INVN_TOTL_QTY
		                     ,  a.PHDP_CMMD_BNDL_NO
		                     ,  a.DRBN_NO
		                     ,  nvl(a.MIX_KIND_CD, '*')  MIX_KIND_CD
		                     ,  a.BSIS_CMMD_PLAC_CD
		                     ,  fn_sd_isnumber_s(a.SPSB_CTN) SPSB_CTN
		                     ,  null                        as FDNO_YN
		                     ,  a.ISDV_CD
		                     ,  to_char(e.ORDR_DT, 'YYYYMMDDHH24MISS') DRUG_ORDR_INPT_DT
		                     ,  a.SDPF_EXRE_CD
		                     ,  a.INJC_PLAC_CD
		                     ,  a.OHOR_RTRN_YN
		                     ,  a.BEMD_NO
		                     ,  a.ATTR_NO
		                     ,  a.DURV_RESN_CTN
		                     ,  e.PTNO
		                     ,  to_char(e.RPTN_DT, 'YYYYMMDDHH24MISS')  RPTN_DT
		                     ,  e.MCDP_CD
		                     ,  nvl(k.ABRV_DPRT_CD, e.WARD_CD)  WARD_CD
		                     ,  e.ODDR_ID
		                     ,  e.GNDR_ID
		                     ,  a.RCPC_YN
		                     ,  e.UPDT_BEMD_NO
		                     ,  e.DRUG_INJC_DVSN_CD
		                     ,  e.PHDP_OROC_DPRT_CD
		                     ,  e.TKMD_CCHN_YN
		                     ,  e.IHOH_DVSN_CD
		                     ,  e.NRDR_YN
		                     ,  e.PSDG_YN
		                     ,  e.CLNC_YN
		                     ,  to_char(e.MDCR_YMD, 'YYYYMMDD')   MDCR_YMD
		                     ,  decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN1, c.ENVL_MEMO_CTN3)                             ENVL_MEMO_CTN1
		                     ,  decode(nvl(f.NTNL_CD, 'KR'), 'KR', c.ENVL_MEMO_CTN2, c.ENVL_MEMO_CTN4)                             ENVL_MEMO_CTN2
		                     ,  decode( fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD), '', substr(f.PTNT_NM, 1, 11)
		                                         ,substr(f.PTNT_NM, 1, 9))||fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD)  PTNT_NM
		                     ,  f.FRRN
		                     ,  f.BRRN
		                     ,  case when (trunc(months_between(a.ORDR_YMD, f.BTDT)/12)) > 5 then to_char(trunc(months_between(a.ORDR_YMD, f.BTDT)/12))
				         				 else to_char(trunc(months_between(a.ORDR_YMD, f.BTDT)/12) ||'-'|| trunc(mod(months_between(a.ORDR_YMD, f.BTDT), 12)))
				            		end   AFI_AGE_VL_STR    /* 나이 */
		                     ,  f.GEND_CD
		                     ,  ( select max(PTNT_TLNO)  from APPTCNPNV t1 where  t1.PTNO = a.PTNO  and t1.CNPN_DVSN_CD = 'BH' )  PTNT_TLNO
		                     ,  ( select max(PTNT_TLNO)  from APPTCNPNV t2 where  t2.PTNO = a.PTNO  and t2.CNPN_DVSN_CD = 'BP' )  PTNT_TLNO2
		                     ,  ( select max(PTNT_TLNO)  from APPTCNPNV t3 where  t3.PTNO = a.PTNO  and t3.CNPN_DVSN_CD = 'EA' )  PTNT_TLNO3
		                     ,  h.ISTY_CD
		                     ,  ( select t.PHRM_DTLS_CTRL_NM from SDMCTRLMT t  where t.PHRM_CTRL_CD = 'SD158' and t.PHRM_DTLS_CTRL_CD = a.MDPR_CD )  MDPR_NM_2
		                     ,  ( select USER_NM from CCUSRDPHT t where  t.USER_ID = e.ODDR_ID )   ORDR_NM
		                     ,  ( select USER_NM from CCUSRDPHT t where  t.USER_ID = e.GNDR_ID )   GNDR_NM
		                     ,  nvl(( select 'Y' from SDDREPLCT t where t.MDPR_CD = a.MDPR_CD and rownum =1  )  , 'N')  SBSN_MDPR_ABSL_DSLW_YN
		                     ,  ( select g2.USER_LCNS_NO
		                            from CCUSRDPHT g
		                               , CCUSERAMT g2
		                           where
		                                 g.USER_ID  = e.ODDR_ID
		                             and g2.LGIN_ID = g.LGIN_ID
		                        )                               USER_LCNS_NO
		                     ,  b.KPNG_PLAC_CD
		                     ,  j.PTRM_NO
		                     ,  null           VALD_HH -- b.VALD_HH
		                     ,  b.RELS_YN
		                    -- ,  ''             ward_labl_prin_yn
		                     ,  ''             edi_cd
		                     ,  ''             isty_asst_cd
		                     ,  fn_md_main_scin('1', a.PTNO, h.MDRP_NO)             SCIN_CD
		                     ,  to_char(a.MDTN_STRT_YMD, 'YYYYMMDDHH24MISS')  mdtn_strt_ymd
		                     ,  fn_md_main_scin('2', a.PTNO, h.MDRP_NO)             SCIN_NM
		                     ,  a.MDTN_NO      MDTN_NO_3
		                     ,  ''             afi_ipdv_nm
		                     ,  ''             ackn_edi_cd
		                     ,  ''             ptnt_type_nm_2
		                     ,  ''             afi_isty_asst_nm_2
		                     ,  ( select  CHCN_YN from APRCADBLT j2 where j2.MDRP_NO = h.MDRP_NO ) CHCN_YN
		                     ,  b.STST_DVSN_CD
		                     ,  'N'                     atmt_clam_yn
		                     ,  b.WSCN_SNGN_YN
		                     ,  nvl(f.NTNL_CD, 'KR')   NTNL_CD
		                     ,  b.PCUN_INLS_QTY
		                     ,  ''                      afi_mdpr_orlm_age_ddcn_str
		                     ,  ''                      afi_errm_lctn_nm
		                     ,  b.KORN_PDCT_NM
		                     ,  decode( ( select t.PHRM_DTLS_CTRL_NM from SDMCTRLMT t where t.PHRM_CTRL_CD = 'SD158' and t.PHRM_DTLS_CTRL_CD = a.MDPR_CD ), null, 'N', 'Y')  SHDN_YN
		                     ,  decode(b.INJT_STER_CMMD_YN, 'Y', nvl(FN_SD_GETKPNGINFO_S('1', a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_LCDV_CD,  a.MDTN_NO, a.PHDP_CMMD_BNDL_NO, a.MDPR_CD) ,'') , '')  afi_cmmd_aftr_kpng_plac_nm
		                     ,  to_char(a.RCPC_DT, 'YYYYMMDDHH24MI')   RCPC_DT
		                     ,  decode(b.INJT_STER_CMMD_YN,'Y', nvl(FN_SD_GETKPNGINFO_S('2', a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_LCDV_CD,  a.MDTN_NO, a.PHDP_CMMD_BNDL_NO, a.MDPR_CD) ,'') , '') VALD_HH2
		                     ,  a.MDTN_LCDV_CD
		                     ,  decode( (select t.PHRM_DTLS_CTRL_CD
		                                   from SDMCTRLMT t
		                                  where t.PHRM_CTRL_CD = 'SD931'
		                                    and t.PHRM_DTLS_CTRL_CD = a.MDPR_CD  ), null, 'N', 'Y' )   HGPR_DGMT_CD
		                     ,  decode( (select t.DETL_CD_NM
		                                   from SDCMCDDMV t
		                                  where t.COMN_GRP_CD = 'SD166'
		                                    and t.COMN_DTLS_CD = a.MDPR_CD  ), null, '' , 'Y' )  DGST_YN_CTN -- AFI_SHDN_KPNG_DGST_YN
		                     ,  lpad(to_char(a.ORDR_SNO), 2, '0')    AFI_ORDR_SNO_STR
		                     ,  0                                  as RTRN_CNFR_CQY
		                      ,  decode( fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD), '', substr(f.PTNT_NM, 1, 18)
		                                         ,substr(f.PTNT_NM, 1, 16))|| fn_sd_getamfmfg_s(e.PTNO, e.MDCR_YMD, e.PTDV_CD)   PTNT_NM_2
		                      ,  b.HGRS_HGCC_MDPR_YN
		                      , case when #{afiItemSortSqncStr} = '2' then
		                                   decode(a.MDTN_NO_DVSN_CD||b.BSIS_CMMD_PLAC_CD||a.BSIS_CMMD_PLAC_CD||nvl(b.PTP_MDPR_YN,'N'),'D31N','Z','A')
		                                 || to_char(a.ORDR_YMD,'YYYYMMDD')
		                                 || a.MDTN_NO_DVSN_CD
		                                 || lpad(to_char(a.MDTN_NO), 4, '0')
		                                 || a.BSIS_CMMD_PLAC_CD
		                                 ||  lpad(to_char( a.PHDP_CMMD_BNDL_NO), 4,'0')
		                                 || nvl(b.WSCN_SNGN_YN,'N')
		                                 || decode(b.KPNG_PLAC_CD,'1','1','3','2','7','1','3')
		                                 || b.KPNG_PLAC_CD|| rpad(a.MDPR_CD,10,' ')
		                                 || lpad(to_char( a.ORDR_SNO), 10,'0' )
		                             when #{afiItemSortSqncStr} = '3' then
		                                    decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' '), '1')
		                                 || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' ')
		                                         , decode(a.MDTN_NO_DVSN_CD||b.BSIS_CMMD_PLAC_CD||a.BSIS_CMMD_PLAC_CD||nvl(b.PTP_MDPR_YN,'N'),'D31N','Z','A'))
		                                 || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' ')
		                                         , decode(a.MIX_KIND_CD,NULL,'0',decode(nvl(b.WSCN_SNGN_YN,'N'),'Y','0',a.MIX_KIND_CD)))
		                                 || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' '), a.DRAP_DVSN_CD )
		                                 || decode(a.MDTN_NO_DVSN_CD||a.MDPR_CLSF_CD, 'A3', rpad(a.MDPR_CD,10,' '), 'D3', rpad(a.MDPR_CD,10,' ')
		                                         , decode(nvl(a.MIX_KIND_CD,'0'),'0',rpad(a.MDPR_CD,10,' '),decode(nvl(b.WSCN_SNGN_YN,'N'),'Y',rpad(a.MDPR_CD,10,' '),'ZZZ')) )
		                                 || lpad( to_char(k.PHDP_CMMD_SQNC_VL ) , 10, '0' )
		                                 || rpad( k.ABRV_DPRT_CD, 7,'0' )
		                                 || lpad(to_char(  j.PTRM_NO) ,5, '0')
		                                 || f.PTNO || to_char(a.ORDR_YMD,'YYYYMMDD')
		                                 || a.MDTN_NO_DVSN_CD
		                                 || lpad( to_char( a.MDTN_NO), 4, '0')
		                                 || lpad( to_char( a.PHDP_CMMD_BNDL_NO ), 4,'0' )
		                                 || decode(b.KPNG_PLAC_CD,'1','1','3','2','7','1','3')
		                                 || b.KPNG_PLAC_CD
		                             when #{afiItemSortSqncStr} = '4' then
		                                    case when b.MDPR_CLSF_CD = '2' then 9 else 1 end
		                                 || lpad( to_char(k.PHDP_CMMD_SQNC_VL ) , 10, '0' )
		                                 || rpad( k.ABRV_DPRT_CD, 7,'0' )
		                                 || rpad(a.MDPR_CD,10,' ')
		                                 || lpad(to_char(  j.PTRM_NO) ,5, '0') || f.PTNO
		                                 || to_char( a.ORDR_YMD, 'YYYYMMDD')
		                                 || a.MDTN_NO_DVSN_CD
		                                 || lpad( to_char( a.MDTN_NO), 4, '0')
		                                 || lpad( to_char( a.PHDP_CMMD_BNDL_NO ), 4,'0' )
		                             else
		                                    decode(a.MDTN_NO_DVSN_CD
		                                            ||b.BSIS_CMMD_PLAC_CD
		                                            ||a.BSIS_CMMD_PLAC_CD
		                                            ||nvl(b.PTP_MDPR_YN,'N'),'D31N','Z','A')
		                                            || lpad( to_char(k.PHDP_CMMD_SQNC_VL ) , 10, '0' )
		                                 || rpad( k.ABRV_DPRT_CD, 7,'0' )
		                                 || lpad(to_char(  j.PTRM_NO) ,5, '0')
		                                 || e.PTNO || to_char( a.ORDR_YMD, 'YYYYMMDD')
		                                 || e.MDTN_NO_DVSN_CD
		                                 || lpad( to_char( a.MDTN_NO), 4, '0')
		                                 || lpad( to_char( a.PHDP_CMMD_BNDL_NO ), 4,'0' )
		                                 || decode(a.BSIS_CMMD_PLAC_CD,'8', decode(m.PHRM_DTLS_CTRL_CD,null,'Z','1'),'B', decode(m.PHRM_DTLS_CTRL_CD,null,'Y','1')
		                                         , decode(a.BSIS_CMMD_PLAC_CD,'7','Z',nvl(b.WSCN_SNGN_YN, 'N')))
		                                 || decode(a.BSIS_CMMD_PLAC_CD,'8', 'Z','B', 'Z',e.DRUG_INJC_DVSN_CD)
		                                 || decode(a.BSIS_CMMD_PLAC_CD,'8', 'Z','B', 'Z',decode(b.KPNG_PLAC_CD,'1','1','3','2','7','1','3')||b.KPNG_PLAC_CD)
		                                 || decode(a.BSIS_CMMD_PLAC_CD,'8', 'Z','B', 'Z',rpad(a.MDPR_CD,10,' ')) || lpad( to_char( a.ORDR_SNO ), 10,'0' )
		                         end   orderkey
		                      ,  b.INJT_STER_CMMD_YN
		                      ,  e.WARD_CD WARD_CD1
		                      ,  b.mdpr_clsf_detl_cd
							  ,  to_char(a.prin_dt, 'yyyyMMddhh24miss') PRIN_DT
		                      ,  a.WARD_LABL_PRIN_YN
		                      ,  h.DRUG_ORDR_UNSL_CTN
		                      ,  b.OTHS_CMMD_UNSB_CTN
		                      ,  h.DC_DVSN_CD
		                      ,  n.PHRM_DTLS_CTRL_NM as SPSB_CTN_1
		                      ,  min(case
		                               when (select fn_cc_get_cnst_vl('SDB_001','ACDG_RBTC_USE_YN') from dual) = 'N' then 'N'
		                               when b.MDPR_CLSF_DETL_CD = '10' and a.PCKN_UNAD_QTY != 1 then 'N'  -- 수액의 포장단위1회량이 1이 아니면 대상 아님
		                               else decode(o.PHRM_DTLS_CTRL_CD, null, 'N', 'Y')
		                             end) over (partition by a.ORDR_YMD,a.MDTN_LCDV_CD,a.MDTN_NO_DVSN_CD,a.MDTN_NO,a.PHDP_CMMD_BNDL_NO)        as TRGT_YN
		                  from
		                         SDPORDDET a,
		                         SDDDGCDMT b,
		                         SDDMETCDT c,
		                         SDPORDBAT e,
		                         APPTPTNTV f,
		                         MDMEDORDT h,
		                         APRCRPTNT j,
		                         HZDEPTMMT k,
		                         SDJFIXQTT l,
		                         SDMCTRLMT m,
		                         SDMCTRLMT n,
		                         SDMCTRLMT o
		                 where a.ORDR_YMD    >= to_date(#{ordrYmd1} , 'YYYYMMDD')
		                   and a.ORDR_YMD    <= to_date(#{ordrYmd2} , 'YYYYMMDD')
		                   and a.MDTN_LCDV_CD = #{mdtnLcdvCd}
		                   /*--------------------------------------------------------------------------------------------------------------*/
		                   /* MIX처방(항암/항생/MIX주사) 일괄변경 조건
		                   /*--------------------------------------------------------------------------------------------------------------*/
		                   and a.MDTN_NO_DVSN_CD in ('O', 'Z', 'C')
		                   and instr(#{afiMdtnNoDvsnNm}, a.MDTN_NO_DVSN_CD) > 0
		                   and a.BSIS_CMMD_PLAC_CD in ('8', '9', 'B', 'V')  /* BSIS_CMMD_PLAC_CD : 8 무균제(기타)MIX / 9 항생제MIX / B 항암제MIX / V 임상시험약-MIX */ /* 임상시험약-MIX 추가 */ /* 2020.08.26 수정 */
		                   and instr(#{afiBsisCmmdPlacNm}, a.BSIS_CMMD_PLAC_CD) > 0
		                   and nvl(a.OSLF_ADMN_DRUG_YN, 'N') != 'Y'    /* 외래(OZ) DSC퇴원(T) 응급실퇴원(GH) 병동퇴원(DFPQ)은 자가주사 안 나오도록 */
		                   and nvl(a.DRUS_CD, 'X')           != 'SAVE' /* SAVE 단독처방 제외 */
		                   /*--------------------------------------------------------------------------------------------------------------*/
		                   and (
		                         (nvl(#{inptClntPrgmId}, '********') = 'SDG101F1') 
		                      or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     
									and 
		                          	a.MDTN_NO_DVSN_CD in ('O', 'Z')                      
									and
			                        nvl(a.RCPC_YN, 'N') in ('Y', 'W') /* W  인공신장 */ 
									--and
		                          	--nvl(a.WARD_LABL_PRIN_YN, 'N') = 'N'
									)
		                      or (nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     
									and
		                          	a.MDTN_NO_DVSN_CD in ('C')                          
								 --	and                                              
		                         -- nvl(a.WARD_LABL_PRIN_YN, 'N') = 'N'
									)
		                       )
		                   /*-----------------------------------------------------------------------------*/
		                   and  a.MDTN_LCDV_CD      = decode(#{mdtnLcdvCd} , null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )
		                   and  a.MDTN_NO between  #{mdtnNo1}
		                                      and  #{mdtnNo2}                   
		                   and  a.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} ,0, a.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
		                   and  a.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
		                   and  a.ORDR_SNO          = decode(nvl(#{afiOrdrSnoStr} , 'X'), 'R', a.ORDR_SNO, nvl(#{afiOrdrSnoStr}, a.ORDR_SNO))
		                   and  b.MDPR_CD           = a.MDPR_CD
		                   /* 출고여부 nvl(b.RELS_YN, 'N') = 'Y'
		                   SDC703F1 전체                                출고여부체크 X
		                   SDG205F1 병동MIX                             출고여부체크 X
		                   SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
		                   SDG101F1 MIX                                 출고여부체크 X
		                   */
		                   and  c.DRUS_CD(+)        = a.DRUS_CD
		                   and  e.ORDR_YMD          = a.ORDR_YMD
		                   and  e.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		                   and  e.MDTN_NO           = a.MDTN_NO
		                   and  e.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		                   and  e.WARD_CD           = nvl(#{wardCd} , e.WARD_CD)
		                   and  f.PTNO              = a.PTNO
		                   and  h.PTNO              = a.PTNO
		                   and  h.ORDR_YMD          = a.ORDR_YMD
		                   and  h.ORDR_SNO          = a.ORDR_SNO
		                   and  j.MDRP_NO           = h.MDRP_NO
		                   and  l.DPRT_CD(+)        = a.INJC_PLAC_CD
		                   and  l.MDPR_CD(+)        = a.MDPR_CD
		                   and  l.EQPT_FDNO_DVSN_CD(+)    = '2'
		                   and  k.DPRT_CD(+) = e.WARD_CD
		                   and  m.PHRM_CTRL_CD     (+)  = 'SD149'
		                   and  m.PHRM_DTLS_CTRL_CD(+)  = a.MDPR_CD
		                   and  n.PHRM_CTRL_CD     (+)  = 'SD170'  /* 약품 특이사항*/	
		                   and  n.PHRM_DTLS_CTRL_CD(+)  = a.MDPR_CD
		                   and  o.PHRM_CTRL_CD     (+)  = 'SDD_017'  /* 항암제조제로봇 대상약품 */
		                   and  o.PHRM_DTLS_CTRL_CD(+)  = a.MDPR_CD
		             ]]>
		               <choose>
		                 <when test='afiMdtnNoDvsnNm =="C"'>
		         /*          and  z.PTNO(+)     = a.PTNO
		                   and  z.ORDR_YMD(+) = a.ORDR_YMD
		                   and  z.ORDR_SNO(+) = a.ORDR_SNO*/
		                 </when>
		                 <otherwise>
		          /*         and  z.PTNO     = a.PTNO
		                   and  z.ORDR_YMD = a.ORDR_YMD
		                   and  z.ORDR_SNO = a.ORDR_SNO*/
		                 </otherwise>
		               </choose>
		             <![CDATA[
		          ) z
		          order by z.orderkey;
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgCmmdPresPrin-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="hghtVl" column="HGHT_VL"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvDprtCd1" column="ABRV_DPRT_CD_1"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="scinCd" column="SCIN_CD"/>
		<result property="scinNm" column="SCIN_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="afiNrdrCct" column="AFI_NRDR_CCT"/>
		<result property="afiDgstItrcNm" column="AFI_DGST_ITRC_NM"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="afiMdtnNoStr" column="AFI_MDTN_NO_STR"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="nextMdcrYmd" column="NEXT_MDCR_YMD"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="tkmdCcfeYn" column="TKMD_CCFE_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="afiInjcPlacNm" column="AFI_INJC_PLAC_NM"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="newYn" column="NEW_YN"/>
		<result property="afiOrocNm" column="AFI_OROC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="adrItrcMemoCtn" column="ADR_ITRC_MEMO_CTN"/>
		<result property="cmmdFinsDt" column="CMMD_FINS_DT"/>
		<result property="hgccMdprYn" column="HGCC_MDPR_YN"/>
		<result property="hgccMdprResnCd" column="HGCC_MDPR_RESN_CD"/>
		<result property="rmrkCtn" column="RMRK_CTN"/>
		<result property="cmmdUnsbCtn" column="CMMD_UNSB_CTN"/>
		<result property="nmbrVl" column="NMBR_VL"/>
		<result property="unsbCtn" column="UNSB_CTN"/>
		<result property="alrgHxMemoCtn" column="ALRG_HX_MEMO_CTN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="audtRmrkCtn" column="AUDT_RMRK_CTN"/>
		<result property="fdnoYn" column="FDNO_YN"/>
		<result property="careMpngClsfNm" column="CARE_MPNG_CLSF_NM"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="inptClntPrgmId" column="INPT_CLNT_PRGM_ID"/>
		<result property="orderKey1" column="ORDER_KEY_1"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgCmmdPresPrin () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgCmmdPresPrin-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgCmmdPresPrin"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgCmmdPresPrin-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listAcdgCmmdPresPrin */
		<![CDATA[
				select  /*+ sdd_pordbat_l88$S01_외래MIX처방전 조회 */
				            to_char(a.ORDR_YMD, 'yyyymmdd')   as ORDR_YMD                                  /* 처방일자     */
				         ,  a.MDTN_LCDV_CD                    as MDTN_LCDV_CD
				         ,  a.MDTN_NO_DVSN_CD                 as MDTN_NO_DVSN_CD /* 투약번호구분 */
				         ,  a.MDTN_NO                         as MDTN_NO          /* 투약번호     */
				         ,  (
				                select  /*+ ordered use_nl(y z)      */
				                        nvl(max(z.MDTN_NO), 0)  MDTN_NO
				                  from
				                        SDPORDBAT y
				                     ,  SDPORDDET z
				                 where  y.ORDR_YMD         = a.ORDR_YMD
				                   and  y.MDTN_NO_DVSN_CD  = a.MDTN_NO_DVSN_CD
				                   and  y.PTNO             = a.PTNO
				                   and  y.MDTN_NO          < a.MDTN_NO
				                   and  y.MDTN_LCDV_CD     = a.MDTN_LCDV_CD
				                   and  y.MCDP_CD          = a.MCDP_CD
				                   and  y.PHDP_OROC_DPRT_CD          = a.PHDP_OROC_DPRT_CD
				                   and  y.GNDR_ID          = a.GNDR_ID
				                   and  y.CMMD_CMBN_CTN is not null
				                   and  y.MDTN_NO >   (
				                                select
				                                        nvl(max(v.MDTN_NO), 0)  MDTN_NO
				                                  from
				                                        SDPORDBAT v
				                                 where  v.ORDR_YMD        = y.ORDR_YMD
				                                   and  v.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
				                                   and  v.PTNO    = y.PTNO
				                                   and  v.MCDP_CD = y.MCDP_CD
				                                   and  v.PHDP_OROC_DPRT_CD = y.PHDP_OROC_DPRT_CD
				                                   and  v.GNDR_ID = y.GNDR_ID
				                                   and  v.DRUG_PRSS_CD > '0'
				                                   and  v.DRUG_INJC_DVSN_CD in ('1', '2')
				                                   and  v.MDTN_NO < a.MDTN_NO
				                                   and  v.RCPC_YN = 'Y'
				                         )
				                   and  z.ORDR_YMD        = y.ORDR_YMD
				                   and  z.MDTN_NO_DVSN_CD = y.MDTN_NO_DVSN_CD
				                   and  z.MDTN_NO         = y.MDTN_NO
				                   and  z.MDTN_LCDV_CD    = y.MDTN_LCDV_CD
				                   and  instr(#{afiBsisCmmdPlacNm}, z.BSIS_CMMD_PLAC_CD) > 0
				                   and  z.PRIN_DT is not null
				             )       BEMD_NO                                      /* 수정전번호   */
				         ,  a.PTNO                                                /* 환자번호     */
				         ,  d.PTNT_NM                                             /* 환자명       */
				         ,  d.GEND_CD                                             /* 성별         */
				         ,  case when (trunc(months_between(a.ORDR_YMD, d.BTDT)/12)) > 5 then to_char(trunc(months_between(a.ORDR_YMD, d.BTDT)/12))
				         		  else to_char(trunc(months_between(a.ORDR_YMD, d.BTDT)/12) ||'-'|| trunc(mod(months_between(a.ORDR_YMD, d.BTDT), 12)))
				            	  end   AFI_AGE_VL_STR    /* 나이 */
				         ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)    as BDWG_VL      /* 몸무게 */
						 ,  fn_sd_getheight_s(a.PTNO, a.ORDR_YMD)    as HGHT_VL
				         ,  a.WARD_CD                                                                  as WARD_CD        /* 병동코드 */
				         , (select a1.ABRV_DPRT_CD from HZDEPTMMT a1 where a1.DPRT_CD(+) = a.WARD_CD) as ABRV_DPRT_CD_1 /* 병동코드명 */
				         ,  b.PTRM_NO
				         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
				         ,  a.MCDP_CD                                             /* 진료과       */
				         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
				         ,  a.ODDR_ID                                             /* 처방의       */
				         ,  e.USER_NM       AFI_ODDR_NM                             /* 처방의명     */
		                 ,  a.GNDR_ID                                             /* 주치의       */
				         ,  m.USER_NM       GNDR_NM                             /* 처방의명     */
				         ,  fn_md_main_scin('1', a.PTNO, b.MDRP_NO)                 SCIN_CD                               /* 상병코드      */
				         ,  fn_md_main_scin('2', a.PTNO, b.MDRP_NO)                 SCIN_NM                                /* 상병명       */
				         ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
				         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
				         ,  (
				                select
				                        decode(count(x.MDPR_CD), 1, 'Y', 'N')
				                  from
				                        SDPORDDET x
				                 where  x.ORDR_YMD        = a.ORDR_YMD
				                   and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				                   and  x.MDTN_NO         = a.MDTN_NO
				                   and  x.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
				                   and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
				                   and  x.MDPR_CLSF_CD = '3'
				                   and  rownum < 2
				             )     NRDR_YN                                   /* 마약포함여부 */
				         ,  (
				            select
				                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
				              from
				                    SDPORDDET x
				             where  x.ORDR_YMD = a.ORDR_YMD
				               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				               and  x.MDTN_NO = a.MDTN_NO
				               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
				               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
				               and  x.MDPR_CLSF_CD = '2'
				               and  rownum < 2
				            )    PSDG_YN                                     /* 향정포함여부 */
				         ,  (
				            select  /*+ ordered use_nl(x y)     */
				                    decode(count(x.MDPR_CD), 1, 'Y', 'N')
				              from
				                    SDPORDDET x
				                 ,  SDDDGCDMT y
				             where  x.ORDR_YMD = a.ORDR_YMD
				               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				               and  x.MDTN_NO = a.MDTN_NO
				               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
				               and  instr(#{afiBsisCmmdPlacNm}, x.BSIS_CMMD_PLAC_CD) > 0
				               and  x.MDPR_CLSF_CD = '3'
				               and  y.MDPR_CD = x.MDPR_CD
				               and  nvl(y.MDPR_CLSF_DETL_CD, '0') in ('13', '14')  /* 13: 임상시험약, 14: 임상약(항암제) */
				               and  rownum < 2
				             )     CLNC_YN                                     /* 임상포함여부 */
				         ,  a.TKMD_CCHN_YN                                     /* 복약지도여부 */
				         ,  b.ORDR_SNO                                         /* 처방순번     */
				         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
				         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
				         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
				                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
				         ,  b.MDPR_CD                                          /* 약품코드     */
				         ,  b.MDPR_NM                                          /* 약품명       */
				         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
				         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
				         ,  f.ICUN_CD                                          /* 함량단위     */
				         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
				         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
				         ,  b.MDNT                                             /* 횟수         */
				         ,  b.MDTN_DDCN                                        /* 일수         */
				         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
				         ,  b.DRUS_CD                                          /* 용법         */
				         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN1, g.ENVL_MEMO_CTN3)  as ENVL_MEMO_CTN1
				         ,  decode(nvl(d.NTNL_CD, 'KR'), 'KR', g.ENVL_MEMO_CTN2, g.ENVL_MEMO_CTN4)  as ENVL_MEMO_CTN2
				         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                                  , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                                  , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                                  , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
				                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
				                                      , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN3
				         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정' )
				                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
				                                              , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '6', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                    , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포')),
				                                     ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN4
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
				                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
				                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 /* 용법Text3    */
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
				                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
				                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4 /* 용법Text4    */
				         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
				         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
				         ,  replace(replace(b.SPSB_CTN, chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
				         ,  f.KPNG_PLAC_CD                                /* 보관장소     */
				         ,  i.DETL_CD_NM                               /* 보관장소명   */
				         ,  (
				                select
				                       '*'
				                  from
				                        SZPATCMMT x                        /* 환자COMMENT    */
				                 where  x.PTNO = a.PTNO
				                   and  x.EXCF_CD = 'SD'
				                   /* and  x.PTNT_CMNT_SNO >= 20001
				                   and  x.PTNT_CMNT_SNO <= 40000 */
				                   and  x.PTNT_CMNT_DVSN_CD in ('21','C2')
				                   and  x.SPSB_CTN is not null
				                   and  rownum < 2
				             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
				         ,  a.DRUG_INJC_DVSN_CD                                   /* 약주사구분   */
				         ,  (
				            select
				                    count(*)
				              from
				                    SDPORDDET x
				             where  x.ORDR_YMD = a.ORDR_YMD
				               and  x.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				               and  x.MDTN_NO = a.MDTN_NO
				               and  x.MDTN_LCDV_CD = a.MDTN_LCDV_CD
				               and  x.MDPR_CLSF_CD = '3'
				               and  x.DRAP_DVSN_CD != '2'
				         )        AFI_NRDR_CCT                                /* 마약개수     */
				         ,  '' AFI_DGST_ITRC_NM  /*연령별 처방 제한*/
				         ,  b.DURV_RESN_CTN
				         ,   decode(		
				              decode(	(select nvl(sum(case when x.RTRN_DETL_DVSN_CD = 'B' then 1
		                                                     else x.RTRN_RQST_CQY
		                                                     end ) ,0)   /* 미수령 반납은 강제로 1을 리턴.*/
					     	              from SDJDGRTNT x
						                 where a.ORDR_YMD = x.ORDR_YMD
						                  and  b.ORDR_SNO = x.ORDR_SNO
			                              and  a.MDTN_NO = x.MDTN_NO
							              /*and  ((x.RTRN_CNFR_YMD is not null) or (x.RTRN_CNFR_YMD is null and x.RTRN_DETL_DVSN_CD = 'B'))*/
							              and  a.MDTN_NO_DVSN_CD = x.MDTN_NO_DVSN_CD
							              and  a.MDTN_LCDV_CD = x.MDTN_LCDV_CD
		                                  and  x.RTRN_DETL_DVSN_CD != 'Z'  /* 잔량 반납 제외 */
							        ), 0 , '' , 'Y')
						      ,'Y', '[반납]', '')
		              || decode(		
		                         decode(  (select count(*)
		                                    from (
		                               select 1
		                                 from MDDCREQMT x  /*간호반납신청*/
		                                where x.PTNO     = a.PTNO
		                                  and x.ORDR_YMD = a.ORDR_YMD
		                                  and x.ORDR_SNO = b.ORDR_SNO
		                              )                                   
		                       ), 0 , '' , 'Y')
		                ,'Y', '[신청]', '')
			    || decode(b.dc_dvsn_cd, 'Y', '[DC]/', 'X', '[취소]/', '') 
			    || FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.SMRY_MDPR_NM)		AS SMRY_MDPR_NM     /* 라벨출력용 요약상품명 */
				         ,  (
				                select
				                        max(to_char(x.ORDR_YMD, 'yyyymmdd')||x.MDTN_NO)
				                  from
				                        SDPORDBAT x
				                 where  x.ORDR_YMD              >= sysdate - 120
				                   and  x.ORDR_YMD              < a.ORDR_YMD
				                   and  x.MDTN_NO_DVSN_CD       = a.MDTN_NO_DVSN_CD
				                   and  x.MDTN_LCDV_CD          = a.MDTN_LCDV_CD
				                   and  x.PTNO                  = a.PTNO
				                   and  x.MCDP_CD               = a.MCDP_CD
				                   and  x.DRUG_PRSS_CD          < '6'
				                   and  x.INJC_PRSS_CD          < '6'
				                   and  x.MIX_INJC_PRSS_CD      < '6'
				                   and  x.OTPT_MIX_INJC_PRSS_CD < '6'
				             )      AFI_MDTN_NO_STR           /* 이전 동일과 처방일 */
				         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
				         ,  (
				                select
				                        to_char(min(x1.MDCR_YMD), 'yyyymmdd')
				                  from
				                        APRCRPTNT x1
				                 where  x1.PTNO = a.PTNO
				                   and  nvl(x1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
				                   and  x1.MCDP_CD = a.MCDP_CD
				                   and  x1.MDCR_ANDV_CD not in ('7', '8', '9')
				                   and  x1.MDCR_YMD > a.ORDR_YMD
				             )   NEXT_MDCR_YMD
				         ,  b.DRUG_PRIN_YN
				         ,  (
				                select
				                        decode(count(*), 0, 'Y', 'N')
				                  from
				                        SDODGGUIT x2
				                      , APRCRPTNT x3
				                 where  x2.PTNO = a.PTNO
				                   and  x2.PTDV_CD = 'O'
				                   and  x3.MDRP_NO = x2.MDRP_NO
				                   and  x3.MDCR_DT < a.MDCR_YMD
				                   and  x2.TKMD_CCHN_YMD < a.ORDR_YMD
				             )     TKMD_CCFE_YN
				         ,  case
				                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
				                 else f.KORN_PDCT_NM
				             end        KORN_PDCT_NM            /*   한글상품명            */
				         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
				         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
				         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
				         ,  (
				                select
				                        max(x.SUBGRPCODE)
				                  from
				                        SDCMCDDMV x
				                 where  x.COMN_GRP_CD = 'SD156'
				                   and  x.COMN_DTLS_CD = b.MDPR_CD
				             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
				         ,  a.MCCN_CD
				         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=b.INJC_PLAC_CD), b.INJC_PLAC_CD) AFI_INJC_PLAC_NM
				         ,  FN_SD_GETAUDFGLIST_S9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD
				                         , #{phdpCmmdBndlNo}, #{afiBsisCmmdPlacNm}, #{drapDvsnCd}
				                               , #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
				         ,  d.FRRN
				         ,  b.DRUS_CD1  /* 처방용법 */
				         ,  decode(b.PRTX_RLTN_RESN_VL, 'T', b.PRTX_RLTN_RESN_CTN, k.DETL_CD_NM)   CLMN_NM_1
				         ,  ''   CLMN_NM_2
				         ,  ''   NEW_YN
				         ,  nvl((select m.MDCR_DTLS_CTRL_NM from MZCTRLMMT m where MDCR_CTRL_CD = 'MM184' and m.MDCR_DTLS_CTRL_CD = a.PHDP_OROC_DPRT_CD),'') AFI_OROC_NM
				         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'')  AFI_CNTR_NM
				         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCDP_CD),'')  ABRV_DPRT_CD
				         , (select 'Y' as ADR_ITRC_MEMO_CTN from SDCADRPAT a1 where a1.PTNO = a.PTNO and rownum = 1) as ADR_ITRC_MEMO_CTN
				         , to_char(b.cmmd_fins_dt, 'yyyyMMddhh24miss') as CMMD_FINS_DT
				         , f.HGCC_MDPR_YN
				         , f.HGCC_MDPR_RESN_CD
				         , l.detl_cd_nm as RMRK_CTN --고주의약품사유 명 
				         , f.CMMD_UNSB_CTN
				         ,  (select b1.LAST_USE_VLM
					           from SDIJSTMAT a1
					              , SDIJSTPST b1
					              , SDDDGCDMT c1
					          where c1.MDPR_CD = b.MDPR_CD
					            and b1.MDPR_CD = b.MDPR_CD
					            and c1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
					            and b1.MIX_RPRS_PDCT_CD = a1.MIX_RPRS_PDCT_CD
					            and (  (nvl(f.MDPR_CLSF_DETL_CD, 'xx') <> '10'   and f.INJT_STER_CMMD_YN = 'Y' )
					                  or
					                   (nvl(f.MDPR_CLSF_DETL_CD, 'xx') = '10' )
					                )            
					            and rownum < 2)    NMBR_VL   /* 조제량 */
					     , b.UNSB_CTN	/*복약지도 특이사항내용 */
					     , b.ALRG_HX_MEMO_CTN	/*복약지도 알러지이력메모내용 */
						 , to_char(b.MDCR_YMD, 'yyyyMMdd')	as MDCR_YMD
						 , b.CODV_CD									as CODV_CD
						 , (select replace(replace(x.AUDT_RMRK_CTN, chr(13)||chr(10), ''), chr(10), '') 
							  from SDAAUDRPT x
		                     where x.TRGT_ORDR_YMD1 = a.ORDR_YMD
		  						and x.TRGT_MDTN_LCDV_CD1 = a.MDTN_LCDV_CD
		                        and x.TRGT_MDTN_NO_DVSN_CD1 = a.MDTN_NO_DVSN_CD
		                        and x.TRGT_MDTN_NO1 = a.MDTN_NO
		                        and x.TRGT_ORDR_SNO1 = b.ORDR_SNO
							) as AUDT_RMRK_CTN
						 , decode((select '1'
		                               from SDJFIXQTT x
		                               where x.DPRT_CD = b.INJC_PLAC_CD
		                                  and x.MDPR_CD = b.MDPR_CD
		                                  and rownum =1
		                             ), '1', 'Y', 'N') as FDNO_YN
						 , ( select
		      					 --x.CARE_MPNG_LRCL_CD      as CARE_MPNG_FXNG_VL_CD
						           y.CARE_MPNG_CLSF_NM      as CARE_MPNG_CLSF_NM
						         --,  y.SORT_SQNC as SORT_SQNC
		    				from  (
		            					select  distinct
		               						     c.CARE_MPNG_LRCL_CD
		            					from  SUCAMPDET c
		           				   	   where c.CARE_MPNG_CD like 'C' || '%'
		            				     and c.CARE_MPNG_LRCL_CD in (select  
												      										 x.DIET_CLSF_CD
												  									from  MNWDIETMT x  /*  식사기본    */
																				  where  x.MDRP_NO       =  b.MDRP_NO
												   									 and  x.DIST_YMD      <=  a.ORDR_YMD
												 									 and  x.DIET_FNSH_YMD >= a.ORDR_YMD
																				--   and  a.DIET_CLSF_CD = 'G'
												   									and  x.DIDV_CD IN ('1','2','3','4')
																					)
		          					) x
		      					 ,  (
		           					 select  CARE_MPNG_CLSF_CD
		                					 ,  CARE_MPNG_CLSF_NM
		                 				     ,  SORT_SQNC
		            				 from  SUCAMAPMT
		             				where  CARE_MPNG_DVSN_CD = '2'
		         					 ) y
		    				 where x.CARE_MPNG_LRCL_CD = y.CARE_MPNG_CLSF_CD
		    				   and rownum < 2) as CARE_MPNG_CLSF_NM
				         , #{inqrDvsnCd}                                        as INQR_DVSN_CD
				         , #{inptClntPrgmId}                                    as INPT_CLNT_PRGM_ID        
		                 , case when #{dprtSqncAplyYn} = 'Y' then nvl((select CTRL_SORT_SQNC
		                                                       from SDMCTRLMT z 
		                                                      where PHRM_CTRL_CD ='SDA_005'
		                                                        and z.PHRM_DTLS_CTRL_CD = b.INJC_PLAC_CD), '9999')
		                                           else 1
		                        end as ORDER_KEY_1
			 	      from
				            SDPORDBAT a                               /* 약처방내역기본 */
				         ,  (
				            select   /*+ LEADING(b f a)  INDEX(b SDPORDDET_I11) */
				                    b.ORDR_YMD
				                 ,  b.MDTN_NO_DVSN_CD
				                 ,  b.MDTN_NO
				                 ,  b.ORDR_SNO
				                 ,  b.PTDV_CD
				                 ,  b.MDPR_CD
				                 ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,d.MDPR_NM)      as MDPR_NM
				                 ,  b.MDPR_CLSF_CD
				                 ,  b.DRAP_DVSN_CD
				                 ,  b.CMMD_STTS_CD
				                 ,  b.PCKN_UNAD_QTY
				                 ,  b.PCUN_NM
				                 ,  b.ICUN_ADMN_VLM
				                 ,  b.ICUN_CD
				                 ,  b.SLCT_UNIT_DVSN_CD
				                 ,  b.MDTN_DDCN
				                 ,  b.DRUS_CD
				                 ,  b.MDNT
				                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
				                 ,  b.INVN_TOTL_QTY
				                 ,  b.DRBN_NO
				                 ,  b.PHDP_CMMD_BNDL_NO
				                 ,  b.MIX_KIND_CD
				                 ,  b.BSIS_CMMD_PLAC_CD
				                 ,  b.SPSB_CTN
				                 ,  b.FDNO_MDPR_CNFR_DT
				                 ,  b.ISDV_CD
				                 ,  b.DRUG_ORDR_INPT_DT
				                 ,  b.SDPF_EXRE_CD
				                 ,  b.PRIN_DT
				                 ,  b.PRMR_BRCD_SCAN_DT
				                 ,  b.CMMD_FINS_DT
				                 ,  b.MDTN_DT
				                 ,  b.MDTN_STRT_YMD
				                 ,  b.INJC_PLAC_CD
				                 ,  b.OHOR_RTRN_YN
				                 ,  b.BEMD_NO
				                 ,  b.ATTR_NO
				                 ,  case
				                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
				                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
				                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
				                     end      DURV_RESN_CTN
				                 ,  b.RCPC_YN
				                 ,  b.RCPC_DT
				                 ,  b.WARD_LABL_PRIN_YN
				                 ,  b.LAST_UPDR_ID
				                 ,  b.LAST_UPDT_IP
				                 ,  b.LAST_UPDT_DT
				                 ,  b.PHRM_IMPL_YMD
				                 ,  b.CUNT_TRNM_MDPR_COT
				                 ,  a.DRUG_PRIN_YN
				                 ,  a.MDTN_LCDV_CD
				                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
				                 ,  h.PRTX_RLTN_RESN_VL
				                 ,  h.PRTX_RLTN_RESN_CTN
				                 ,  h.MDRP_NO
				                 ,  j.WARD_CD
				                 ,  j.PTRM_NO
				                 ,  (select 
				                 			a.unsb_ctn
				                       from sdodgguit a
				                      where a.TKMD_CCHN_ymd = (select max(b.tkmd_cchn_ymd)
				                      								 from sdodgguit b
												                    where b.MDRP_NO = h.MDRP_NO
												                      and b.PTDV_CD = h.codv_cd
												                   )
										and a.MDRP_NO = h.MDRP_NO
									    and a.PTDV_CD = h.CODV_CD
									 ) UNSB_CTN
							  	 ,  (select 
				                 			a.ALRG_HX_MEMO_CTN
				                       from sdodgguit a
				                      where a.TKMD_CCHN_ymd = (select max(b.tkmd_cchn_ymd)
				                      								 from sdodgguit b
												                    where b.MDRP_NO = h.MDRP_NO
												                      and b.PTDV_CD = h.codv_cd
												                   )
										and a.MDRP_NO = h.MDRP_NO
									    and a.PTDV_CD = h.CODV_CD
									 ) ALRG_HX_MEMO_CTN	 
								, j.mdcr_ymd							 
								, h.codv_cd
		                        , h.dc_dvsn_cd
				              from
				                    SDPORDDET b,
				                    SDDDGCDMT d,
				                    SDDMETCDT c,
				                    SDPORDBAT a,
				                    APPTPTNTV f,
				                    MDMEDORDT h,
				                    APRCRPTNT j,
				                    HZDEPTMMT k,
				                    SDJFIXQTT l,
				                    SDMCTRLMT m
				                  , (
				                      select distinct
				                             b1.PTNO
				                           , b1.ORDR_YMD
				                           , b1.ORDR_SNO
				                        from MNIRECEIT a1 /* 외래치료실주사접수 */
				                           , MNIOUTACT b1 /* 외래액팅 */
				                       where a1.INJC_PRRN_YMD between to_date(#{ordrYmd3}, 'yyyymmdd' )
				                                                  and to_date(#{ordrYmd4}, 'yyyymmdd' )/* 주사예정일자 */
				                         and a1.ENRM_YN        = 'Y'  /* 입실여부 */
				                         and a1.ENRM_CNCL_DT is null /* 입실취소일시 */
				                         /* and nvl(a1.ENRM_CNCL_YN , 'N') = 'N' */
				                         and b1.PTNO          = a1.ptno
				                         and b1.IJAC_APNT_YMD = a1.INJC_PRRN_YMD
				                    ) z
				              where b.ORDR_YMD    >= to_date(#{ordrYmd1} , 'YYYYMMDD')
				                and b.ORDR_YMD    <= to_date(#{ordrYmd2} , 'YYYYMMDD')
				                and b.MDTN_LCDV_CD = #{mdtnLcdvCd}
				                /*--------------------------------------------------------------------------------------------------------------*/
				                /* MIX처방(항암/항생/MIX주사) 일괄변경 조건
				                /*--------------------------------------------------------------------------------------------------------------*/
				                and b.MDTN_NO_DVSN_CD in ('O', 'Z', 'C', 'A', 'B', 'E', 'S')
				                and instr(#{afiMdtnNoDvsnNm}, b.MDTN_NO_DVSN_CD) > 0
				                and b.BSIS_CMMD_PLAC_CD in ('8', '9', 'B')  /* BSIS_CMMD_PLAC_CD : 8 무균제(기타)MIX / 9 항생제MIX / B 항암제MIX */
				                and instr(#{afiBsisCmmdPlacNm}, b.BSIS_CMMD_PLAC_CD) > 0
				                and nvl(b.OSLF_ADMN_DRUG_YN, 'N') != 'Y'    /* 외래(OZ) DSC퇴원(T) 응급실퇴원(GH) 병동퇴원(DFPQ)은 자가주사 안 나오도록 */
				                and nvl(b.DRUS_CD, 'X')           != 'SAVE' /* SAVE 단독처방 제외 */
				                /*--------------------------------------------------------------------------------------------------------------*/
				                and (
				                      ( nvl(#{inptClntPrgmId}, '********')  = 'SDG101F1')
				                   or ( 	nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     
				                   	    and b.MDTN_NO_DVSN_CD in ('O', 'Z')                      
				                        and nvl(b.RCPC_YN, 'N') in ('Y', 'W') /* W : 인공신장 */ 
				                        --and nvl(b.WARD_LABL_PRIN_YN, 'N') = 'N'
				                       )
				                   or ( 	nvl(#{inptClntPrgmId}, '********') != 'SDG101F1'     
				                   		and b.MDTN_NO_DVSN_CD in ('C', 'A', 'B', 'E', 'S')                           
				                        --and nvl(b.WARD_LABL_PRIN_YN, 'N') = 'N'
			                          )
				                    )
				                /*--------------------------------------------------------------------------------------------------------------*/                		                
				                /*-----------------------------------------------------------------------------*/               
				                and  b.MDTN_LCDV_CD      = decode(#{mdtnLcdvCd} , null, b.MDTN_LCDV_CD, 'A', b.MDTN_LCDV_CD, #{mdtnLcdvCd} )
				                and  b.MDTN_NO between  #{mdtnNo1}
				                                   and  #{mdtnNo2}                
				                and  b.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} ,0, b.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
				                and  b.CMMD_STTS_CD < '6' /* 조제상태코드 : 7 삭제처방, 8 수정처방 */
				                and  b.ORDR_SNO          = decode(nvl(#{afiOrdrSnoStr} , 'X'), 'R', b.ORDR_SNO, nvl(#{afiOrdrSnoStr}, b.ORDR_SNO))
				                and  d.MDPR_CD           = b.MDPR_CD
				                /* 출고여부 nvl(d.RELS_YN, 'N') = 'Y'
				                SDC703F1 전체                                출고여부체크 X
				                SDG205F1 병동MIX                             출고여부체크 X
				                SDC100F1 외래MIX, 단기입원MIX, 임상시험약국  출고여부체크 X
				                SDG101F1 MIX                                 출고여부체크 X
				                */
				                and  c.DRUS_CD(+)        = b.DRUS_CD
				                and  a.ORDR_YMD          = b.ORDR_YMD
				                and  a.MDTN_NO_DVSN_CD   = b.MDTN_NO_DVSN_CD
				                and  a.MDTN_NO           = b.MDTN_NO
				                and  a.MDTN_LCDV_CD      = b.MDTN_LCDV_CD
				                and  a.WARD_CD           = nvl(#{wardCd} , a.WARD_CD)
				                and  f.PTNO              = b.PTNO
				                and  h.PTNO              = b.PTNO
				                and  h.ORDR_YMD          = b.ORDR_YMD
				                and  h.ORDR_SNO          = b.ORDR_SNO
				                and  j.MDRP_NO           = h.MDRP_NO
				                and  l.DPRT_CD(+)        = b.INJC_PLAC_CD
				                and  l.MDPR_CD(+)        = b.MDPR_CD
				                and  l.EQPT_FDNO_DVSN_CD(+)    = '2'
				                and  k.DPRT_CD(+) = a.WARD_CD
				                and  m.PHRM_CTRL_CD     (+)  = 'SD149'
				                and  m.PHRM_DTLS_CTRL_CD(+)  = b.MDPR_CD
				          ]]>
				            <choose>
				              <when test='afiMdtnNoDvsnNm=="XX" or afiMdtnNoDvsnNm=="YY"'> -- 기존 O, Z (외래, 외래 시간외) 인경우 재출력이 가능해야 하므로 임시로 변경
				                and  z.PTNO     = b.PTNO
				                and  z.ORDR_YMD = b.ORDR_YMD
				                and  z.ORDR_SNO = b.ORDR_SNO
				              </when>
				              <otherwise>
				                and  z.PTNO (+)     = b.PTNO
				                and  z.ORDR_YMD (+) = b.ORDR_YMD
				                and  z.ORDR_SNO (+) = b.ORDR_SNO
				              </otherwise>
				            </choose>
				          <![CDATA[                
				            )  b                                      /* 약처방내역상세 */
				         ,  APPTPTNTV d                               /* 환자마스터     */
				         ,  CCUSRDPHT e                               /* 사용자마스터   */
				         ,  CCUSERAMT e2
						 ,  CCUSRDPHT m                               /* 사용자마스터   */	
				         ,  SDDDGCDMT f                               /* 처방코드마스터 */
				         ,  SDDMETCDT g                               /* 용법코드마스터 */
				         ,  HZDEPTMMT h                               /* 부서코드마스터 */
				         ,  SDCMCDDMV i                               /* 공통코드마스터 */
				         ,  SDCMCDDMV k                               /* 공통코드마스터 */
				         ,  SDCMCDDMV l                               /* 공통코드마스터 */		   
				     where  a.ORDR_YMD    >= to_date(#{ordrYmd1} , 'YYYYMMDD')
				       and  a.ORDR_YMD    <= to_date(#{ordrYmd2} , 'YYYYMMDD')
				       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
				       and  a.MDTN_NO         between #{mdtnNo1} and  #{mdtnNo2}
				       and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
				       and  b.ORDR_YMD        = a.ORDR_YMD
				       and  b.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD
				       and  b.MDTN_NO         = a.MDTN_NO
				       and  b.MDTN_LCDV_CD    = a.MDTN_LCDV_CD
				       and  d.PTNO            = a.PTNO
				       and  e.USER_ID(+)      = a.ODDR_ID
					   and  m.USER_ID(+) 	= a.GNDR_ID
				       and  e2.LGIN_ID(+)     = e.LGIN_ID
				       and  f.MDPR_CD         = b.MDPR_CD
				       and  g.DRUS_CD         = b.DRUS_CD
				       and  h.DPRT_CD         = a.MCDP_CD
				       and  i.COMN_GRP_CD(+)  = 'SD003'
				       and  i.COMN_DTLS_CD(+) = nvl(f.KPNG_PLAC_CD, '9')
				       and  k.COMN_GRP_CD(+)  = 'MM079'
				       and  k.COMN_DTLS_CD(+) = b.PRTX_RLTN_RESN_VL
				       and  l.COMN_GRP_CD (+) = 'SDB_007' --고주의약품사유코드
				       and  l.COMN_DTLS_CD(+) = nvl(f.HGCC_MDPR_RESN_CD, 'xx')
				     order
				        by  ORDER_KEY_1 
		                 ,  a.ORDR_YMD
				         ,  a.MDTN_NO_DVSN_CD
				         ,  a.MDTN_NO
				         ,  a.MDTN_LCDV_CD
				         ,  b.BSIS_CMMD_PLAC_CD
				         ,  b.PHDP_CMMD_BNDL_NO
				         ,  b.MDPR_CD;
		]]>				 
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIpdvCd-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ipdvCd" column="IPDV_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIpdvCd () 
        Description :                                           급여구분코드조회
                                            
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIpdvCd-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIpdvCd"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIpdvCd-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIpdvCd */
		<![CDATA[
		select   PTNO
		       , to_char(ORDR_YMD,'yyyymmdd') as ORDR_YMD
		       , ORDR_SNO
		       , ORDR_CD
		       , IPDV_CD
		  from ACCLMCCLT
		 where PTNO = #{ptno}
		   and ORDR_YMD = to_date(#{ordrYmd},'yyyymmdd')
		   and ORDR_SNO = #{ordrSno}
		   and ORDR_CD  = #{ordrCd}
		   and CNCL_DT is null
		]]>
	</select>







   <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-executeMgmvMain (SP_SD_MGMV_MAIN 호출) 
        Description : 
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
    -->	
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-executeMgmvMain"  statementType="CALLABLE"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-executeMgmvMain */
		{ call SP_SD_MGMV_MAIN (
		                        #{dvsnCd, mode=IN, jdbcType=VARCHAR, javaType=String},  /* in_jobgubun */
						        #{dprtCd, mode=IN, jdbcType=VARCHAR, javaType=String} , /* in_deptcd */
						        #{afiMdprRelsDvsnCd, mode=IN, jdbcType=VARCHAR, javaType=String}, /* in_ioflag */
						        #{adtnInfmCtn, mode=IN, jdbcType=VARCHAR, javaType=String}, /* in_addinfo */
						        #{rtrnCqy, mode=IN, jdbcType=NUMERIC, javaType=java.math.BigDecimal},  /* in_rejtqty */
						        #{smtnRelsDvsnVl, mode=IN, jdbcType=VARCHAR, javaType=String}, /* in_jobtype */				                
						        #{gvUserId, mode=IN, jdbcType=VARCHAR, javaType=String}, /* in_editid */
						        #{gvUserIp, mode=IN, jdbcType=VARCHAR, javaType=String}, /* in_editip */
						        #{gvClntPrgmId, mode=IN, jdbcType=VARCHAR, javaType=String}, /* in_gvClntPrgmId */
						        #{gvSrvrPrgmId, mode=IN, jdbcType=VARCHAR, javaType=String}, /* in_gvSrvrPrgmId */				                				                
		                        #{etcCtn1, mode=IN, jdbcType=VARCHAR, javaType=String}, /* 일련번호 */				                				                 
						        #{prsgCct, mode=OUT, jdbcType=NUMERIC, javaType=java.math.BigDecimal}, /* out_code */
						        #{afiErrMesgCtn, mode=OUT, jdbcType=VARCHAR, javaType=String} /* out_msg */ 
						               ) 
		}
	</select>	

	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneVoAdd-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="dprtCd" column="DPRT_CD"/>
		<result property="afiMdprRelsDvsnCd" column="AFI_MDPR_RELS_DVSN_CD"/>
		<result property="adtnInfmCtn" column="ADTN_INFM_CTN"/>
		<result property="rtrnCqy" column="RTRN_CQY"/>
		<result property="prsgCct" column="PRSG_CCT"/>
		<result property="afiErrMesgCtn" column="AFI_ERR_MESG_CTN"/>
		<result property="smtnRelsDvsnVl" column="SMTN_RELS_DVSN_VL"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneVoAdd (vo 항목 추가용) 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneVoAdd-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneVoAdd"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneVoAdd-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneVoAdd */
		select '' DPRT_CD
		      ,'' AFI_MDPR_RELS_DVSN_CD
		      ,'' ADTN_INFM_CTN
		      ,0 RTRN_CQY
		      ,0 PRSG_CCT
		      ,'' AFI_ERR_MESG_CTN
		      ,'' SMTN_RELS_DVSN_VL
		  from dual;
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLablByAtc-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="inqrCct" column="INQR_CCT"/>
		<result property="inqrCct1" column="INQR_CCT1"/>
		<result property="sbDrusCd" column="SB_DRUS_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcknUnadQty2" column="PCKN_UNAD_QTY2"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="prinPageNo" column="PRIN_PAGE_NO"/>
		<result property="totlPageCnt" column="TOTL_PAGE_CNT"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mrnnTkngYn" column="MRNN_TKNG_YN"/>
		<result property="lnchTkngYn" column="LNCH_TKNG_YN"/>
		<result property="evnnTkngYn" column="EVNN_TKNG_YN"/>
		<result property="slepBefrTkngYn" column="SLEP_BEFR_TKNG_YN"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="oddrAbrvDprtCd2" column="ODDR_ABRV_DPRT_CD2"/>
		<result property="phrmPtntMemo" column="PHRM_PTNT_MEMO"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="wardCd2" column="WARD_CD2"/>
		<result property="drapDvsnCd2" column="DRAP_DVSN_CD2"/>
		<result property="mdprClsfCd2" column="MDPR_CLSF_CD2"/>
		<result property="tkmdCatnLablCd" column="TKMD_CATN_LABL_CD"/>
		<result property="rcpcDt" column="RCPC_DT"/>
		<result property="dprtCd" column="DPRT_CD"/>
		<result property="ptntMemo" column="PTNT_MEMO"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="afiAgeVlStr2" column="AFI_AGE_VL_STR2"/>
		<result property="phrmDtlsCtrlNm" column="PHRM_DTLS_CTRL_NM"/>
		<result property="cmmdUnsbCtn" column="CMMD_UNSB_CTN"/>
		<result property="subjIdntNo" column="SUBJ_IDNT_NO"/>
		<result property="subjVistNm" column="SUBJ_VIST_NM"/>
		<result property="subjAdmnVl" column="SUBJ_ADMN_VL"/>
		<result property="clncExamMdprCtn" column="CLNC_EXAM_MDPR_CTN"/>
		<result property="ntmRflcYn" column="NTM_RFLC_YN"/>
		<result property="oslfAdmnDrugYn" column="OSLF_ADMN_DRUG_YN"/>
		<result property="abrvDprtCd2" column="ABRV_DPRT_CD2"/>
		<result property="abrvDprtCd3" column="ABRV_DPRT_CD3"/>
		<result property="mdprTkvrDt" column="MDPR_TKVR_DT"/>
		<result property="rmrkCtn" column="RMRK_CTN"/>
		<result property="dvsnVl" column="DVSN_VL"/>
		<result property="dgstAdmnNtm" column="DGST_ADMN_NTM"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="totlQtyClclYn" column="TOTL_QTY_CLCL_YN"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="btdt" column="BTDT"/>
		<result property="drugDlvyDprtCd" column="DRUG_DLVY_DPRT_CD"/>
		<result property="phrmDtlsCtrlNm1" column="PHRM_DTLS_CTRL_NM_1"/>
		<result property="mdprClsfDetlCd" column="MDPR_CLSF_DETL_CD"/>
		<result property="careMpngClsfNm" column="CARE_MPNG_CLSF_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLablByAtc () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLablByAtc-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLablByAtc"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLablByAtc-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLablByAtc */
		<![CDATA[   
		select      ORDR_YMD                                       /* 처방일자     */
		         ,  INQR_CCT
		         ,  INQR_CCT1
		         ,  SB_DRUS_CD
		         ,  drus_cd
		         ,  MDTN_NO_DVSN_CD                      /* 투약번호구분 */
		         ,  MDTN_NO                                                               /* 투약번호     */
		         ,  PTNO                                                /* 환자번호     */
		         ,  PTNT_NM                                             /* 환자명       */
		         ,  GEND_CD                                             /* 성별         */
		         ,  NTNL_CD                          /* 국적코드     */
		         ,  MCDP_CD                                  /* 진료과       */
		         ,  KORN_DPRT_NM                                        /* 진료과명     */
		         ,  ODDR_ID                                             /* 처방의       */
		         ,  AFI_ODDR_NM                                  /* 처방의명     */
		         ,  ORDR_DT           /* 입력일시     */
		         ,  PRIN_DT           /* 출력일시     */
		         ,  TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  ORDR_SNO                                         /* 처방순번     */
		         ,  PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  AFI_MIX_KIND_NM
		         ,  MDPR_CD                                          /* 약품코드     */
		         ,  MDPR_NM                                          /* 약품명       */
		         ,  SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  ICUN_CD                                          /* 함량단위     */
		         ,  ROUND(PCKN_UNAD_QTY,3) as PCKN_UNAD_QTY 		   /* 일회량(포장) */ 
				 ,  PCKN_UNAD_QTY as PCKN_UNAD_QTY2 		   /* 일회량(포장) */ 
		         ,  INVN_PCUN_CD                                     /* 포장단위     */
		         ,  MDNT                                             /* 횟수         */
		         ,  MDTN_DDCN                                        /* 일수         */
		         ,  BSIS_CMMD_PLAC_CD                                /* 조제장소     */
		         ,  ENVL_MEMO_CTN1    /* 용법Text1 */
		         ,  ENVL_MEMO_CTN2   /* 용법Text2 */
		         ,  ENVL_MEMO_CTN3 /* 용법Text3    */
		         ,  ENVL_MEMO_CTN4 /* 용법Text4    */
		         ,  ROUND(INVN_TOTL_QTY,3) as INVN_TOTL_QTY /*2020-08-13 kjh*/
		         ,  MIX_KIND_CD                   /* MIX구분      */
		         ,  SPSB_CTN                         /* 처방특기사항 */
		         ,  KPNG_PLAC_CD                                        /* 보관장소     */
		         ,  DETL_CD_NM                                          /* 보관장소명   */
		         ,  PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  DRUG_INJC_DVSN_CD                                    /* 약주사구분   */
		         ,  DURV_RESN_CTN
		         ,  SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  OTPT_CUNT_TRNM_YN
		         ,  DRUG_PRIN_YN
		         ,  KORN_PDCT_NM            /*   한글상품명            */
		         ,  USER_LCNS_NO                     /*   의사면허번호          */
		         ,  ZPAD_NM
		         ,  DEAD_NM
		         ,  AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  MDTN_LCDV_CD
		         ,  MCCN_CD
		         ,  INJC_PLAC_CD
		         ,  AFI_ORDR_AUDT_DVSN_NM_1
		         ,  FRRN
		         ,  DRUS_CD1  /* 처방용법 */
		         ,  PRIN_PAGE_NO
		         ,  TOTL_PAGE_CNT
		         ,  MDRP_NO
		         ,  PTDV_CD
		         ,  MRNN_TKNG_YN
		         ,  LNCH_TKNG_YN
		         ,  EVNN_TKNG_YN
		         ,  SLEP_BEFR_TKNG_YN
		         ,  PHDP_OROC_DPRT_CD
		         ,  ABRV_DPRT_CD
				 ,  BDWG_VL  /* 몸무게  */
		         ,  ODDR_ABRV_DPRT_CD2		/* 가정간호사  */
				 ,	PHRM_PTNT_MEMO  /* 약국에서 작성한 환자메모  */
				 ,  PTRM_NO		
				 ,  WARD_CD2 	
				 ,  DRAP_DVSN_CD2	
				 ,  MDPR_CLSF_CD2 	
			     ,  TKMD_CATN_LABL_CD 	
				 ,  RCPC_DT	
				 ,  DPRT_CD	
				 ,  PTNT_MEMO		/*의사 comment */    
				 ,  AFI_AGE_VL_STR /*나이(처방쪽 함수사용) 추가 2020-06-04 by kjh */ 
				 ,  AFI_AGE_VL_STR2 /*나이 추가 2020-08-25 by kjh */
				 ,  REGEXP_REPLACE(LISTAGG(PHRM_DTLS_CTRL_NM, ',') WITHIN GROUP (ORDER BY PHRM_DTLS_CTRL_NM) OVER(PARTITION BY rmrk_ctn), '([^,]+)(,\1)*(,|$)', '\1\3') as PHRM_DTLS_CTRL_NM       /*약국세부제어명  추가 2020-06-10 by kjh*/
			     ,	CMMD_UNSB_CTN /*임상약일 때 조제 특이사항 2020-06-15 by kjh*/
				 ,  SUBJ_IDNT_NO    /*임상처방전 정보 추가 2020-06-19 by kjh*/
			     ,  SUBJ_VIST_NM    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	SUBJ_ADMN_VL as SUBJ_ADMN_VL    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	CLNC_EXAM_MDPR_CTN as CLNC_EXAM_MDPR_CTN       /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	NTM_RFLC_YN	/*약품정보의 횟수반영 추가 2020-06-19 by kjh*/
				 ,  OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
				 ,  ABRV_DPRT_CD2  /*병동 코드 2020-07-24 by kjh*/
				 ,  ABRV_DPRT_CD3 /* 진료과 2020-07-24 by kjh*/
				 ,  MDPR_TKVR_DT		/*집계 일시 2020-07-24 by kjh*/ 
		 		 ,  RMRK_CTN
		         ,  (case when instr(RMRK_CTN,'/') > 0 then 'N'
				          else 'Y'
				     end)         as DVSN_VL
		         ,  DGST_ADMN_NTM
			     ,  INQR_DVSN_CD as INQR_DVSN_CD /* 용법 별 라벨출력 : 1, 개별 라벨출력 : 2 */	
		         ,  TOTL_QTY_CLCL_YN
		         ,  DRBN_NO
		         ,  BTDT
				 ,  DRUG_DLVY_DPRT_CD
		         ,  PHRM_DTLS_CTRL_NM_1
		         ,  MDPR_CLSF_DETL_CD
		         , ( select
					           y.CARE_MPNG_CLSF_NM      as CARE_MPNG_CLSF_NM
					from  (
				      			select  distinct c.CARE_MPNG_LRCL_CD
				      			from  SUCAMPDET c
				      			where c.CARE_MPNG_CD like 'C' || '%'
				        		and c.CARE_MPNG_LRCL_CD in (select  
																	 x.DIET_CLSF_CD
															from  MNWDIETMT x  /*  식사기본    */
														   where  x.MDRP_NO        =  MDRP_NO
														     and  x.DIST_YMD      <=  ORDR_YMD
															 and  x.DIET_FNSH_YMD >=  ORDR_YMD
															 and  x.DIDV_CD IN ('1','2','3','4')
															)
				      		  ) x
				  			, (
				       			select  CARE_MPNG_CLSF_CD
				           			 ,  CARE_MPNG_CLSF_NM
				           		     ,  SORT_SQNC
				        	    from  SUCAMAPMT
				        		where  CARE_MPNG_DVSN_CD = '2'
				     		 ) y
					 where x.CARE_MPNG_LRCL_CD = y.CARE_MPNG_CLSF_CD
					   and rownum < 2) as CARE_MPNG_CLSF_NM 
		from (
		        select   
		            to_char(b.ORDR_YMD, 'yyyymmdd')       ORDR_YMD                                  /* 처방일자     */
		         ,  1 as INQR_CCT /* rank() over (partition by b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no order by b.ordr_sno) */
		         ,  1 as INQR_CCT1 /* count(*) over (partition by b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no)  */
		         ,  b.drus_cd SB_DRUS_CD
		         ,  b.drus_cd
		         ,  b.MDTN_NO_DVSN_CD                     MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  b.MDTN_NO                                                               /* 투약번호     */
		         ,  b.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		         ,  b.MCDP_CD                           as MCDP_CD        /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  b.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                           /* 처방의명     */
		         ,  to_char(b.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		         ,  b.TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  b.ORDR_SNO                                         /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                          /* 약품코드     */
		         ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.MDPR_NM)    MDPR_NM     /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  f.ICUN_CD                                          /* 함량단위     */
		         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		         ,  b.MDNT                                             /* 횟수         */
		         ,  b.MDTN_DDCN                                        /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
				 ,  g.ENVL_MEMO_CTN1
				 ,  g.ENVL_MEMO_CTN2
				 ,  g.ENVL_MEMO_CTN3
				 ,  g.ENVL_MEMO_CTN4     
		/*         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
				                                                                                      , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                                      , 'A', '__정'
				                                                                                      , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                                      , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
				                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                        , 'A', '__정'
				                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
				                                                                                        , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN1   
				         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
				                                                                        , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                        , 'A', '__정'
				                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
				                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                        , 'A', '__정'
				                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
				                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
				                                                                                          , ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN2
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4   */
		         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(fn_sd_isnumber_s(b.SPSB_CTN), chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                        /* 보관장소     */
		         ,  i.DETL_CD_NM                                          /* 보관장소명   */
		         ,  (
		                select
		                        x.PTNT_CMNT_SNO
		                  from
		                        SZPATCMMT x                        /* 환자COMMENT    */
		                 where  x.PTNO = b.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   and  x.PTNT_CMNT_DVSN_CD in ('21', 'C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  b.DRUG_INJC_DVSN_CD                                    /* 약주사구분   */            
		         ,  b.DURV_RESN_CTN
		         ,  f.SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */        
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN         
		         ,  b.DRUG_PRIN_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = b.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = b.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  b.MDTN_LCDV_CD
		         ,  b.MCCN_CD
		         ,  b.INJC_PLAC_CD
		         ,  fn_sd_getaudfglist_s9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD, #{phdpCmmdBndlNo}
		                         , #{afiBsisCmmdPlacNm}, #{drapDvsnCd}, #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  '0' PRIN_PAGE_NO
		         ,  0 TOTL_PAGE_CNT
		         ,  b.MDRP_NO
		         ,  b.PTDV_CD
		         ,  m.MRNN_TKNG_YN
		         ,  m.LNCH_TKNG_YN
		         ,  m.EVNN_TKNG_YN
		         ,  m.SLEP_BEFR_TKNG_YN
		         ,  nvl( b.PHDP_OROC_DPRT_CD,'')  PHDP_OROC_DPRT_CD
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = b.MCCN_CD),'') ABRV_DPRT_CD
				 ,  fn_sd_getweight_s(b.PTNO, b.ORDR_YMD)    as BDWG_VL /* 몸무게 2020-05-29 by kjh */
		         ,  ( select b1.ABRV_DPRT_CD
				      from HZDEPTMMT b1
				      where b1.DPRT_CD = b.OROC_DPRT_CD
				    )   as ODDR_ABRV_DPRT_CD2		/* 가정간호사 2020-05-29 by kjh */
						  , (select WM_CONCAT(aa.SPSB_CTN)
									     from  SZPATCMMT aa
											where aa.ptno = b.ptno
				      		  	  and  aa.PTNT_CMNT_SNO >= (
											                            select max(PTNT_CMNT_SNO) - 1
											                              from SZPATCMMT bb
											                             where 1=1
											                               and aa.ptno              = bb.ptno
											                               and aa.EXCF_CD           = bb.EXCF_CD
											                               and aa.PTNT_CMNT_DVSN_CD = bb.PTNT_CMNT_DVSN_CD
																              )
											 )    PHRM_PTNT_MEMO
				 ,  b.PTRM_NO	as PTRM_NO		/*병실번호2020-06-02 by kjh*/
				 ,  b.WARD_CD2 as WARD_CD2 	/*병실코드2020-06-02 by kjh*/
				 ,  f.DRAP_DVSN_CD as DRAP_DVSN_CD2	/*약적용구분코드 (내복/외용/주사) 2020-06-03 by kjh*/
				 ,  f.MDPR_CLSF_CD as MDPR_CLSF_CD2 	/*약품분류코드(마약) 2020-06-03 by kjh */
			     ,  f.TKMD_CATN_LABL_CD as TKMD_CATN_LABL_CD 	/*  복약라벨 표현 2020-06-03 by kjh*/
				 ,  to_char(b.RCPC_DT,'yyyymmddHH24MISS') as RCPC_DT	/*수납 일시 2020-06-03 by kjh*/	
				 ,  h.DPRT_CD as DPRT_CD	/*택배 코드 2020-06-04 by kjh*/
		         , trim(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(b.spsb_ctn,'[유사발음]',''),'[유사코드]',''),'[유사외관]',''),'[음식주의]',''),'[고위험]',''),'[고주의]',''),'[냉장]',''),'[차광]',''),'[냉동]',''),'[실온,차광]',''),'[냉장,차광]',''),'[상온,차광]',''),'[기타]',''),'[냉장금기]',''),'[냉장금기,차광]',''),'[용량다양]',''),'[출혈주의]',''),'[고농도]','')) PTNT_MEMO		/*의사 comment */
				 ,  fn_md_getage ('1',d.BTDT,sysdate) as AFI_AGE_VL_STR /*나이(처방쪽 함수사용) 추가 2020-06-04 by kjh */ 
				 ,  fn_md_getage ('2',d.BTDT,sysdate) as AFI_AGE_VL_STR2 /*나이 추가 2020-08-25 by kjh */
				 ,	n.PHRM_DTLS_CTRL_NM as PHRM_DTLS_CTRL_NM /*약국세부제어명  추가 2020-06-10 by kjh*/
			     ,	f.CMMD_UNSB_CTN as CMMD_UNSB_CTN /*임상약일 때 조제 특이사항 2020-06-15 by kjh*/
				 ,  b.SUBJ_IDNT_NO as SUBJ_IDNT_NO    /*임상처방전 정보 추가 2020-06-19 by kjh*/
			     ,  b.SUBJ_VIST_NM as SUBJ_VIST_NM    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.SUBJ_ADMN_VL as SUBJ_ADMN_VL    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.CLNC_EXAM_MDPR_CTN as CLNC_EXAM_MDPR_CTN       /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	nvl(f.NTM_RFLC_YN,'N') as NTM_RFLC_YN	/*약품정보의 횟수반영 추가 2020-06-19 by kjh*/
				 ,  b.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
				 ,  ( select b1.ABRV_DPRT_CD from HZDEPTMMT b1 where b1.DPRT_CD = b.WARD_CD)  as ABRV_DPRT_CD2  /*병동 코드 2020-07-24 by kjh*/
				 ,  ( select b1.ABRV_DPRT_CD from HZDEPTMMT b1 where b1.DPRT_CD = b.MCDP_CD)  as ABRV_DPRT_CD3 /* 진료과 2020-07-24 by kjh*/
				 ,  b.MDPR_TKVR_DT as MDPR_TKVR_DT		/*집계 일시 2020-07-24 by kjh*/ 
				 ,  LISTAGG(b.ordr_sno, '/') WITHIN GROUP (ORDER BY b.ordr_sno) OVER(PARTITION BY b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no, b.DRBN_NO, b.mdtn_ddcn) AS RMRK_CTN
		         ,  decode(g.dgst_admn_ntm, 0 , b.MDNT, g.dgst_admn_ntm) AS DGST_ADMN_NTM
		 		 ,  '1' as INQR_DVSN_CD
		         ,  case when nvl(f.TOTL_QTY_CLCL_YN, 'N') = 'N' then 'Y'
		                 when nvl(f.TOTL_QTY_CLCL_CD, 'XXX') = 'OT' then 'Y'
		                 else 'N'
		                 end as TOTL_QTY_CLCL_YN
		         , b.DRBN_NO
		         , to_char(d.BTDT,'yyyymmdd') as BTDT
				 , g.DRUG_DLVY_DPRT_CD  as DRUG_DLVY_DPRT_CD
		         , o.PHRM_DTLS_CTRL_NM  as PHRM_DTLS_CTRL_NM_1
		         , f.MDPR_CLSF_DETL_CD  as MDPR_CLSF_DETL_CD 
		      from
		           (
		            select  /*+ ordered use_nl(a b c)   */
		                    b.ORDR_YMD
		                 ,  b.PTNO
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.MDRP_NO
						 ,	h.OROC_DPRT_CD	as OROC_DPRT_CD /* 가정간호사 2020-05-29 by kjh */
				         ,  (select WARD_CD  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as WARD_CD2    /* 병동코드 추가 2020-06-02 by kjh */
						 ,  (select PTRM_NO  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as PTRM_NO    /* 병실번호 추가 2020-06-02 by kjh */
						 ,  h.SUBJ_IDNT_NO   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_VIST_NM   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_ADMN_VL   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.CLNC_EXAM_MDPR_CTN  /*임상처방전 정보 추가 2020-06-19 by kjh*/
						 ,  h.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
						 ,  to_char(b.MDPR_TKVR_DT, 'YYYYMMDDHH24MISS')  AS MDPR_TKVR_DT  /* 2020-07-24 집계일시*/
						 ,  h.MCDP_CD
						 ,  h.ODDR_ID
						 ,  a.ORDR_DT
						 ,  a.TKMD_CCHN_YN 
						 ,  a.DRUG_INJC_DVSN_CD
						 ,  a.MCCN_CD
						 ,  a.PHDP_OROC_DPRT_CD
						 ,  a.WARD_CD
		                 ,  nvl(h.SNGN_BNDL_YN, 'N') SNGN_BNDL_YN
		                 ,  b.RCPC_PNTM_CMMD_STTS_MDFC_YN
		              from
		                    SDPORDBAT a
		                 ,  SDPORDDET b
		                 ,  MDMEDORDT h
		             where  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		               and  a.MDTN_NO = #{mdtnNo}
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */               
		               and  b.ORDR_YMD          = a.ORDR_YMD
		               and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		               and  b.MDTN_NO           = a.MDTN_NO
		               and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		               and  b.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} , 0, b.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
		               and  b.BSIS_CMMD_PLAC_CD = #{bsisCmmdPlacCd}
		               and  nvl(b.DRUS_CD, 'X') != 'SAVE'          
		               and  h.PTNO = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = b.ORDR_SNO
		               and  nvl(h.SNGN_BNDL_YN, 'N') = 'N'
		               and not exists (select '1' 
		                                from (
		                                        select x.ordr_ymd, x.mdtn_no_dvsn_cd, x.mdtn_no, x.drus_cd , COUNT(*) OVER () as cnt
		                                           from sdporddet x
		                                          where x.ordr_ymd = b.ordr_ymd
		                                            and x.mdtn_no_dvsn_cd = b.mdtn_no_dvsn_cd
		                                            and x.mdtn_no = b.mdtn_no
		                                            and x.bsis_cmmd_plac_cd = b.BSIS_CMMD_PLAC_CD 
		                                        group by x.ordr_ymd, x.mdtn_no_dvsn_cd, x.mdtn_no, x.drus_cd ) a
		                                where  a.cnt > 1 )
		               and ( ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
				                       not exists ( select  'Y'
				                                      from  SDJDGRTNT s
				                                     where  s.ORDR_YMD        = b.ORDR_YMD
				                                       and  s.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
				                                       and  s.MDTN_NO         = b.MDTN_NO
				                                       and  s.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
				                                       and  s.ORDR_SNO        = b.ORDR_SNO
				                                       and  s.MDPR_CD         = b.MDPR_CD
				                                       and  nvl(s.MDPR_RTRN_NTM, -1) != 0
				                                       and  b.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
				                                                                  from  SDJDGRTNT t
				                                                                 where  s.ORDR_YMD         = t.ORDR_YMD
				                                                                   and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
				                                                                   and  s.MDTN_NO          = t.MDTN_NO
				                                                                   and  s.ORDR_SNO         = t.ORDR_SNO
				                                                                   and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
				                                                                   and  s.MDPR_CD          = t.MDPR_CD
				                                                                   and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
				                                                                   and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
				                                  )
				                     )
				                   )
						       and (   b.MDTN_NO_DVSN_CD in ('O','Z') and 
		                               (
		                                 ( B.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6') AND B.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y' )  OR
		                                 ( B.BSIS_CMMD_PLAC_CD  = 'A' AND B.DRAP_DVSN_CD               != '2' ) OR
		                                 ( B.BSIS_CMMD_PLAC_CD  = '7' AND NVL(B.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )
		                               OR
		                               B.MDTN_NO_DVSN_CD IN ('G','H','I','D','F','P','Q','S','T') AND 
		                               (
		                                 ( B.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6', 'A') AND B.DRAP_DVSN_CD != '2') OR   /* 경구외용    */   
		                                 ( B.BSIS_CMMD_PLAC_CD  = '7' AND NVL(B.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )	                                       
		                           )            
		            )  b                                      /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMV e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDDMETCDT m
		 		 ,  SDMCTRLMT n								  /* 약국제어 정보 - 복약주의라벨 추가 2020-06-10 by kjh */
		         ,  SDMCTRLMT o								  /* 약국제어 정보  */
		     where  
		            d.PTNO  = b.PTNO
		       and  e.USER_ID = b.ODDR_ID
		       and  e2.LGIN_ID = e.LGIN_ID
		       and  f.MDPR_CD = b.MDPR_CD
		/*       and  ( (nvl(f.DGMT_RGST_TYPE_CD, '1') <> '2' and nvl(f.RELS_YN, 'N') = 'Y')
		             or (nvl(f.DGMT_RGST_TYPE_CD, '1') = '2')
		            )
		       and  ( (nvl(f.DGMT_RGST_TYPE_CD, '1') <> '2' and b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y')
		             or (nvl(f.DGMT_RGST_TYPE_CD, '1') = '2')
		            )
		*/
		]]>
		<if test='"5".equals(bsisCmmdPlacCd)'>
		<![CDATA[
		/*       and  (
		             (f.BSIS_CMMD_PLAC_CD = '3' and f.dgfr_cd <> '02' and
		                ( (f.dgfr_cd = '01' and mod(b.PCKN_UNAD_QTY, 0.25) = 0)
		                    or
		                   (f.dgfr_cd <> '01' ) 
		                )
		             )
		             or
		             (f.BSIS_CMMD_PLAC_CD <> '1' and f.bsis_cmmd_plac_cd <> '3' and f.bsis_cmmd_plac_cd <> '5')            
		             )
		*/
		]]>
		</if>
		<![CDATA[       
		       and  g.DRUS_CD = b.DRUS_CD
		       and  h.DPRT_CD = b.MCDP_CD
		       and  i.COMN_GRP_CD = 'SD003'
		       and  i.COMN_DTLS_CD = nvl(f.KPNG_PLAC_CD, '9')
		       and  m.DRUS_CD = b.DRUS_CD
			   and  n.PHRM_CTRL_CD(+) = 'SDA_009'
			   and  n.PHRM_DTLS_CTRL_CD (+) = f.TKMD_CATN_LABL_CD /*복약주의라벨 추가 2020-06-10 by kjh  */
		       and  o.PHRM_CTRL_CD(+) = 'SD170'
			   and  o.PHRM_DTLS_CTRL_CD (+) = f.MDPR_CD /* 라벨주의사항  */
		union all
		select   
		            to_char(b.ORDR_YMD, 'yyyymmdd')       ORDR_YMD                                  /* 처방일자     */
		         ,  1 as INQR_CCT    /* rank() over (partition by b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no order by b.ordr_sno, l.sb_drus_cd) as INQR_CCT */
		         ,  1 as INQR_CCT1   /* count(*) over (partition by b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no) as INQR_CCT1 */
		         ,  nvl(l.sb_drus_cd, b.drus_cd) as SB_DRUS_CD
		         ,  b.DRUS_CD
		         ,  b.MDTN_NO_DVSN_CD                     MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  b.MDTN_NO                                                               /* 투약번호     */
		         ,  b.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		         ,  b.MCDP_CD                           as MCDP_CD        /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  b.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                           /* 처방의명     */
		         ,  to_char(b.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		         ,  b.TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  b.ORDR_SNO                                         /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                          /* 약품코드     */
		         ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.MDPR_NM)    MDPR_NM     /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  f.ICUN_CD                                          /* 함량단위     */
		         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		         ,  b.MDNT                                             /* 횟수         */
		         ,  b.MDTN_DDCN                                        /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
				 ,  nvl(j.envl_memo_ctn1, m.ENVL_MEMO_CTN1)   ENVL_MEMO_CTN1
				 ,  nvl(j.envl_memo_ctn2, m.ENVL_MEMO_CTN2)   ENVL_MEMO_CTN2
				 ,  nvl(j.envl_memo_ctn3, m.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3
				 ,  nvl(j.envl_memo_ctn4, m.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4     
		/*         ,  replace( replace( replace( replace( nvl(j.envl_memo_ctn1, m.ENVL_MEMO_CTN1), '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		                                                                                      , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                              , 'A', '__정'
		                                                                                      , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD,  '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                 , 'A', '__정'
		                                                                         , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                         , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		                                                                                        , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN1    
		         ,  replace( replace( replace( replace( nvl(j.envl_memo_ctn2, m.ENVL_MEMO_CTN2), '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		                                                                        , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                , 'A', '__정'
		                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                , 'A', '__정'
		                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                                                                          , ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN2  
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(nvl(j.envl_memo_ctn3, m.ENVL_MEMO_CTN3), 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(nvl(j.envl_memo_ctn3, m.ENVL_MEMO_CTN3), 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(nvl(j.envl_memo_ctn3, m.ENVL_MEMO_CTN3), 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(nvl(j.envl_memo_ctn3, m.ENVL_MEMO_CTN3), 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(nvl(j.envl_memo_ctn4, m.ENVL_MEMO_CTN4), 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(nvl(j.envl_memo_ctn4, m.ENVL_MEMO_CTN4), 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(nvl(j.envl_memo_ctn4, m.ENVL_MEMO_CTN4), 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(nvl(j.envl_memo_ctn4, m.ENVL_MEMO_CTN4), 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4     */
		         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(fn_sd_isnumber_s(b.SPSB_CTN), chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                        /* 보관장소     */
		         ,  i.DETL_CD_NM                                          /* 보관장소명   */
		         ,  (
		                select
		                        x.PTNT_CMNT_SNO
		                  from
		                        SZPATCMMT x                        /* 환자COMMENT    */
		                 where  x.PTNO = b.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   and  x.PTNT_CMNT_DVSN_CD in ('21', 'C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  b.DRUG_INJC_DVSN_CD                                    /* 약주사구분   */
		         ,  b.DURV_RESN_CTN
		         ,  f.SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		         ,  b.DRUG_PRIN_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = b.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = b.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  b.MDTN_LCDV_CD
		         ,  b.MCCN_CD
		         ,  b.INJC_PLAC_CD
		         ,  fn_sd_getaudfglist_s9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD, #{phdpCmmdBndlNo}
		                         , #{afiBsisCmmdPlacNm}  , #{drapDvsnCd} , #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  '0' PRIN_PAGE_NO
		         ,  0 TOTL_PAGE_CNT
		         ,  b.MDRP_NO
		         ,  b.PTDV_CD
		         ,  m.MRNN_TKNG_YN
		         ,  m.LNCH_TKNG_YN
		         ,  m.EVNN_TKNG_YN
		         ,  m.SLEP_BEFR_TKNG_YN
		         ,  nvl( b.PHDP_OROC_DPRT_CD,'')  PHDP_OROC_DPRT_CD
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = b.MCCN_CD),'') ABRV_DPRT_CD
				 ,  fn_sd_getweight_s(b.PTNO, b.ORDR_YMD)    as BDWG_VL /* 몸무게 2020-05-29 by kjh */
		         ,  ( select b1.ABRV_DPRT_CD
				      from HZDEPTMMT b1
				      where b1.DPRT_CD = b.OROC_DPRT_CD
				    )                                            as ODDR_ABRV_DPRT_CD2		/* 가정간호사 2020-05-29 by kjh*/
						  , (select WM_CONCAT(aa.SPSB_CTN)
									     from  SZPATCMMT aa
											where aa.ptno = b.ptno
				      		  	  and  aa.PTNT_CMNT_SNO >= (
											                            select max(PTNT_CMNT_SNO) - 1
											                              from SZPATCMMT bb
											                             where 1=1
											                               and aa.ptno              = bb.ptno
											                               and aa.EXCF_CD           = bb.EXCF_CD
											                               and aa.PTNT_CMNT_DVSN_CD = bb.PTNT_CMNT_DVSN_CD
																              )
											 )    PHRM_PTNT_MEMO
				 ,  b.PTRM_NO	as PTRM_NO		/*병실번호2020-06-02 by kjh*/
				 ,  b.WARD_CD2 as WARD_CD2 	/*병실코드2020-06-02 by kjh*/
				 ,  f.DRAP_DVSN_CD as DRAP_DVSN_CD2	/*약적용구분코드 (내복/외용/주사) 2020-06-03 by kjh*/
				 ,  f.MDPR_CLSF_CD as MDPR_CLSF_CD2 	/*약품분류코드(마약) 2020-06-03 by kjh */
			     ,  f.TKMD_CATN_LABL_CD as TKMD_CATN_LABL_CD 	/*  복약라벨 표현 2020-06-03 by kjh*/
				 ,  to_char(b.RCPC_DT,'yyyymmddHH24MISS') as RCPC_DT	/*수납 일시 2020-06-03 by kjh*/	
				 ,  h.DPRT_CD as DPRT_CD	/*택배 코드 2020-06-04 by kjh*/
				 , trim(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(b.spsb_ctn,'[유사발음]',''),'[유사코드]',''),'[유사외관]',''),'[음식주의]',''),'[고위험]',''),'[고주의]',''),'[냉장]',''),'[차광]',''),'[냉동]',''),'[실온,차광]',''),'[냉장,차광]',''),'[상온,차광]',''),'[기타]',''),'[냉장금기]',''),'[냉장금기,차광]',''),'[용량다양]',''),'[출혈주의]',''),'[고농도]','')) PTNT_MEMO		/*의사 comment */
				 ,  fn_md_getage ('1',d.BTDT,sysdate) as AFI_AGE_VL_STR /*나이(처방쪽 함수사용) 추가 2020-06-04 by kjh */
				 ,  fn_md_getage ('2',d.BTDT,sysdate) as AFI_AGE_VL_STR2 /*나이 추가 2020-08-25 by kjh */
				 ,	n.PHRM_DTLS_CTRL_NM as PHRM_DTLS_CTRL_NM /*약국세부제어명  추가 2020-06-10 by kjh*/
			     ,	f.CMMD_UNSB_CTN as CMMD_UNSB_CTN /*임상약일 때 조제 특이사항 2020-06-15 by kjh*/
				 ,  b.SUBJ_IDNT_NO as SUBJ_IDNT_NO    /*임상처방전 정보 추가 2020-06-19 by kjh*/
			     ,  b.SUBJ_VIST_NM as SUBJ_VIST_NM    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.SUBJ_ADMN_VL as SUBJ_ADMN_VL    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.CLNC_EXAM_MDPR_CTN as CLNC_EXAM_MDPR_CTN       /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	nvl(f.NTM_RFLC_YN,'N') as NTM_RFLC_YN	/*약품정보의 횟수반영 추가 2020-06-19 by kjh*/
				 ,  b.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
				 ,  ( select b1.ABRV_DPRT_CD from HZDEPTMMT b1 where b1.DPRT_CD = b.WARD_CD)  as ABRV_DPRT_CD2  /*병동 코드 2020-07-24 by kjh*/
				 ,  ( select b1.ABRV_DPRT_CD from HZDEPTMMT b1 where b1.DPRT_CD = b.MCDP_CD)  as ABRV_DPRT_CD3 /* 진료과 2020-07-24 by kjh*/
				 ,  b.MDPR_TKVR_DT as MDPR_TKVR_DT		/*집계 일시 2020-07-24 by kjh*/ 
		 		 ,  LISTAGG(b.ordr_sno, '/') WITHIN GROUP (ORDER BY b.ordr_sno) OVER(PARTITION BY b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no, b.DRBN_NO, nvl(l.sb_drus_cd, b.drus_cd), b.mdtn_ddcn) AS RMRK_CTN
		         ,  decode(nvl(j.dgst_admn_ntm, m.dgst_admn_ntm), 0 , b.MDNT, nvl(j.dgst_admn_ntm, m.dgst_admn_ntm)) AS DGST_ADMN_NTM
		 		 ,  '1' as INQR_DVSN_CD
		         ,  case when nvl(f.TOTL_QTY_CLCL_YN, 'N') = 'N' then 'Y'
		                 when nvl(f.TOTL_QTY_CLCL_CD, 'XXX') = 'OT' then 'Y'
		                 else 'N'
		                 end as TOTL_QTY_CLCL_YN
		         , b.DRBN_NO
		         , to_char(d.BTDT,'yyyymmdd') as BTDT
				 , g.DRUG_DLVY_DPRT_CD  as DRUG_DLVY_DPRT_CD
		         , o.PHRM_DTLS_CTRL_NM  as PHRM_DTLS_CTRL_NM_1 
		         , f.MDPR_CLSF_DETL_CD  as MDPR_CLSF_DETL_CD 
		      from
		            (
		            select  /*+ ordered use_nl(a b c)   */
		                    b.ORDR_YMD
		                 ,  b.PTNO
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.MDRP_NO
						 ,	h.OROC_DPRT_CD	as OROC_DPRT_CD /* 가정간호사 2020-05-29 by kjh */
				         ,  (select WARD_CD  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as WARD_CD2    /* 병동코드 추가 2020-06-02 by kjh */
						 ,  (select PTRM_NO  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as PTRM_NO    /* 병실번호 추가 2020-06-02 by kjh */
						 ,  h.SUBJ_IDNT_NO   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_VIST_NM   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_ADMN_VL   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.CLNC_EXAM_MDPR_CTN  /*임상처방전 정보 추가 2020-06-19 by kjh*/
						 ,  h.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
						 ,  to_char(b.MDPR_TKVR_DT, 'YYYYMMDDHH24MISS')  AS MDPR_TKVR_DT  /* 2020-07-24 집계일시*/
						 ,  a.MCDP_CD
						 ,  h.ODDR_ID
						 ,  a.ORDR_DT
						 ,  a.TKMD_CCHN_YN 
						 ,  a.DRUG_INJC_DVSN_CD
						 ,  a.MCCN_CD
						 ,  a.PHDP_OROC_DPRT_CD
						 ,  a.WARD_CD
		                 ,  nvl(h.SNGN_BNDL_YN, 'N') SNGN_BNDL_YN
		                 ,  b.RCPC_PNTM_CMMD_STTS_MDFC_YN
		              from
		                    SDPORDBAT a
		                 ,  sdporddet b
		                 ,  MDMEDORDT h
		             where  1=1
		               and  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd} 
		               and  a.MDTN_NO = #{mdtnNo}
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */                            
		               and  b.CMMD_STTS_CD < '6'
		               and  b.ORDR_YMD          = a.ORDR_YMD
		               and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		               and  b.MDTN_NO           = a.MDTN_NO
		               and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		               and  b.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} , 0, b.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
		               and  b.BSIS_CMMD_PLAC_CD = #{bsisCmmdPlacCd}     
		               and  nvl(b.DRUS_CD, 'X') != 'SAVE'      
		               and  h.PTNO = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = b.ORDR_SNO
		               and  nvl(h.SNGN_BNDL_YN, 'N') = 'N'
		               and  exists (select '1' 
		                                from (
		                                        select x.ordr_ymd, x.mdtn_no_dvsn_cd, x.mdtn_no, x.drus_cd , COUNT(*) OVER () as cnt
		                                           from sdporddet x
		                                          where x.ordr_ymd = b.ordr_ymd
		                                            and x.mdtn_no_dvsn_cd = b.mdtn_no_dvsn_cd
		                                            and x.mdtn_no = b.mdtn_no
		                                            and x.bsis_cmmd_plac_cd = b.BSIS_CMMD_PLAC_CD                                        
		                                        group by x.ordr_ymd, x.mdtn_no_dvsn_cd, x.mdtn_no, x.drus_cd ) a
		                                where  a.cnt > 1 )
		               and ( ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
				                       not exists ( select  'Y'
				                                      from  SDJDGRTNT s
				                                     where  s.ORDR_YMD        = b.ORDR_YMD
				                                       and  s.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
				                                       and  s.MDTN_NO         = b.MDTN_NO
				                                       and  s.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
				                                       and  s.ORDR_SNO        = b.ORDR_SNO
				                                       and  s.MDPR_CD         = b.MDPR_CD
				                                       and  nvl(s.MDPR_RTRN_NTM, -1) != 0
				                                       and  b.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
				                                                                  from  SDJDGRTNT t
				                                                                 where  s.ORDR_YMD         = t.ORDR_YMD
				                                                                   and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
				                                                                   and  s.MDTN_NO          = t.MDTN_NO
				                                                                   and  s.ORDR_SNO         = t.ORDR_SNO
				                                                                   and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
				                                                                   and  s.MDPR_CD          = t.MDPR_CD
				                                                                   and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
				                                                                   and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
				                                  )
				                     )
				                   )
						       and (   b.MDTN_NO_DVSN_CD in ('O','Z') and 
		                               (
		                                 ( B.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6') AND B.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y' )  OR
		                                 ( B.BSIS_CMMD_PLAC_CD  = 'A' AND B.DRAP_DVSN_CD               != '2' ) OR
		                                 ( B.BSIS_CMMD_PLAC_CD  = '7' AND NVL(B.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )
		                               OR
		                               B.MDTN_NO_DVSN_CD IN ('G','H','I','D','F','P','Q','S','T') AND 
		                               (
		                                 ( B.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6', 'A') AND B.DRAP_DVSN_CD != '2') OR   /* 경구외용    */   
		                                 ( B.BSIS_CMMD_PLAC_CD  = '7' AND NVL(B.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )	                                       
		                           )            
		            )  b                                             /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMV e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDDMETCDT m
		 		 ,  SDMCTRLMT n																/* 약국제어 정보 - 복약주의라벨 추가 2020-06-10 by kjh */
		         ,  (
		                select
		                        a.DRUS_CD
		                     ,  a.DRAP_DVSN_CD
		                     ,  a.DGST_ADMN_NTM
		                     ,  decode(b.NORN_SNO, 1 , 'D2A'    ,23, 'DPA' 
		                                          ,2 , 'D2AA'   ,24, 'DPE' 
		                                          ,3 , 'D2E'    ,25, 'P2' 
		                                          ,4 , 'DMW'    ,26, 'P3' 
		                                          ,5 , 'DMWA'   ,27, 'P4' 
		                                          ,6 , 'DMWE'   ,28, 'D15A' 
		                                          ,7 , 'A7'     ,29, 'D15E' 
		                                          ,8 , 'A8'     ,30, 'D1P' 
		                                          ,9 , 'A9'     ,31, 'D1PA' 
		                                          ,10, 'D1A'    ,32, 'D1PE' 
		                                          ,11, 'D1AA'   ,33, 'P7' 
		                                          ,12, 'D1E'    ,34, 'P8' 
		                                          ,13, 'DM'     ,35, 'P9' 
		                                          ,14, 'DMA'    ,36, 'DBM' 
		                                          ,15, 'DME'    ,37, 'DBMA' 
		                                          ,16, 'A10'    ,38, 'DBME' 
		                                          ,17, 'A11'    ,39, 'D2P' 
		                                          ,18, 'A12'    ,40, 'D2PA' 
		                                          ,19, 'DA'     ,41, 'D2PE'                       
		                                          ,20, 'DAA'    ,42, 'P10'                      
		                                          ,21, 'DAE'    ,43, 'P11'                      
		                                          ,22, 'DP'     ,44, 'HS', null) SB_DRUS_CD 
		                        , a.ENVL_MEMO_CTN1
		                        , a.ENVL_MEMO_CTN2
		                        , a.ENVL_MEMO_CTN3
		                        , a.ENVL_MEMO_CTN4                                                            
		                  from
		                        SDDMETCDT a
		                     ,  CCDUMMYMT b
		                 where  b.NORN_SNO > 0
		                   and  b.NORN_SNO <= 44
		                   and  substr(SB_DRUS_CD, b.NORN_SNO, 1) = 'Y'
		             )  l
		         ,  SDDMETCDT j
		         ,  SDMCTRLMT o
		     where  
		            d.PTNO  = b.PTNO
		       and  e.USER_ID = b.ODDR_ID
		       and  e2.LGIN_ID   = e.LGIN_ID
		       and  f.MDPR_CD = b.MDPR_CD    
		/*       and  ( (nvl(f.DGMT_RGST_TYPE_CD, '1') <> '2' and nvl(f.RELS_YN, 'N') = 'Y')
		             or (nvl(f.DGMT_RGST_TYPE_CD, '1') = '2')
		            )
		       and  ( (nvl(f.DGMT_RGST_TYPE_CD, '1') <> '2' and b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y')
		             or (nvl(f.DGMT_RGST_TYPE_CD, '1') = '2')
		            ) 
		*/
		]]>
		<if test='"5".equals(bsisCmmdPlacCd)'>
		<![CDATA[
		/*		and  (
		             (f.BSIS_CMMD_PLAC_CD = '3' and f.dgfr_cd <> '02' and
		                ( (f.dgfr_cd = '01' and mod(b.PCKN_UNAD_QTY, 0.25) = 0)
		                    or
		                   (f.dgfr_cd <> '01' ) 
		                )
		             )
		             or
		             (f.BSIS_CMMD_PLAC_CD <> '1' and f.bsis_cmmd_plac_cd <> '3' and f.bsis_cmmd_plac_cd <> '5')            
		             )
		*/
		]]>
		</if>
		<![CDATA[     
		       and  g.DRUS_CD = b.DRUS_CD
		       and  h.DPRT_CD = b.MCDP_CD
		       and  i.COMN_GRP_CD = 'SD003'
		       and  i.COMN_DTLS_CD = nvl(f.KPNG_PLAC_CD, '9')
		       and  m.DRUS_CD = b.DRUS_CD
			   and  n.PHRM_CTRL_CD(+) = 'SDA_009'
			   and  n.PHRM_DTLS_CTRL_CD (+) = f.TKMD_CATN_LABL_CD/*복약주의라벨 추가 2020-06-10 by kjh  */
			   and  b.drus_cd = m.drus_cd
			   and  m.drus_cd =  l.drus_cd (+)
			   and  l.sb_drus_cd = j.drus_cd (+)
		       and  o.PHRM_CTRL_CD(+) = 'SD170'
			   and  o.PHRM_DTLS_CTRL_CD (+) = f.MDPR_CD /* 라벨주의사항  */
		union all
		select   
		            to_char(b.ORDR_YMD, 'yyyymmdd')       ORDR_YMD                                  /* 처방일자     */
		         ,  1 as INQR_CCT /* rank() over (partition by b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no order by b.ordr_sno) */
		         ,  1 as INQR_CCT1 /* count(*) over (partition by b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no) */
		         ,  b.drus_cd SB_DRUS_CD
		         ,  b.drus_cd
		         ,  b.MDTN_NO_DVSN_CD                     MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  b.MDTN_NO                                                               /* 투약번호     */
		         ,  b.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                   /* 국적코드     */
		         ,  b.MCDP_CD                           as MCDP_CD        /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  b.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                           /* 처방의명     */
		         ,  to_char(b.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT           /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT           /* 출력일시     */
		         ,  b.TKMD_CCHN_YN                                     /* 복약지도여부 */
		         ,  b.ORDR_SNO                                         /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                /* Rp           */
		         ,  b.MDPR_CLSF_CD                                     /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                     /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                          /* 약품코드     */
		         ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.MDPR_NM)    MDPR_NM     /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                    /* 일회량(함량) */
		         ,  f.ICUN_CD                                          /* 함량단위     */
		         ,  b.PCKN_UNAD_QTY                                    /* 일회량(포장) */
		         ,  f.INVN_PCUN_CD                                     /* 포장단위     */
		         ,  b.MDNT                                             /* 횟수         */
		         ,  b.MDTN_DDCN                                        /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                /* 조제장소     */
				 ,  g.ENVL_MEMO_CTN1
				 ,  g.ENVL_MEMO_CTN2
				 ,  g.ENVL_MEMO_CTN3
				 ,  g.ENVL_MEMO_CTN4     
		/*         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		                                                                         			  , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                              , 'A', '__정'
		                                                                                      , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                 , 'A', '__정'
		                                                                         , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                         , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		                                                                                        , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN1    
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		                                                                         , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                 , 'A', '__정'
		                                                                         , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                         , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1' , decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                , 'A', '__정'
		                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                                                                          , ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN2   
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4    */
		         ,  decode( b.DRAP_DVSN_CD, '1', decode( f.TOTL_QTY_CLCL_CD, 'OT', b.INVN_TOTL_QTY, b.TOTL_CLCL_QTY), b.INVN_TOTL_QTY)      INVN_TOTL_QTY  /* 총량 */
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(fn_sd_isnumber_s(b.SPSB_CTN), chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                        /* 보관장소     */
		         ,  i.DETL_CD_NM                                          /* 보관장소명   */
		         ,  (
		                select
		                        x.PTNT_CMNT_SNO
		                  from
		                        SZPATCMMT x                        /* 환자COMMENT    */
		                 where  x.PTNO = b.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   and  x.PTNT_CMNT_DVSN_CD in ('21', 'C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  b.DRUG_INJC_DVSN_CD                                    /* 약주사구분   */
		         ,  b.DURV_RESN_CTN
		         ,  f.SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		         ,  b.DRUG_PRIN_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = b.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = b.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  b.MDTN_LCDV_CD
		         ,  b.MCCN_CD
		         ,  b.INJC_PLAC_CD
		         ,  fn_sd_getaudfglist_s9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD, #{phdpCmmdBndlNo}
		                         , #{afiBsisCmmdPlacNm}, #{drapDvsnCd}, #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  '0' PRIN_PAGE_NO
		         ,  0 TOTL_PAGE_CNT
		         ,  b.MDRP_NO
		         ,  b.PTDV_CD
		         ,  m.MRNN_TKNG_YN
		         ,  m.LNCH_TKNG_YN
		         ,  m.EVNN_TKNG_YN
		         ,  m.SLEP_BEFR_TKNG_YN
		         ,  nvl( b.PHDP_OROC_DPRT_CD,'')  PHDP_OROC_DPRT_CD
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = b.MCCN_CD),'') ABRV_DPRT_CD
				 ,  fn_sd_getweight_s(b.PTNO, b.ORDR_YMD)    as BDWG_VL /* 몸무게 2020-05-29 by kjh */
		         ,  ( select b1.ABRV_DPRT_CD
				      from HZDEPTMMT b1
				      where b1.DPRT_CD = b.OROC_DPRT_CD
				    )                                            as ODDR_ABRV_DPRT_CD2		/* 가정간호사 2020-05-29 by kjh*/
						  , (select WM_CONCAT(aa.SPSB_CTN)
									     from  SZPATCMMT aa
											where aa.ptno = b.ptno
				      		  	  and  aa.PTNT_CMNT_SNO >= (
											                            select max(PTNT_CMNT_SNO) - 1
											                              from SZPATCMMT bb
											                             where 1=1
											                               and aa.ptno              = bb.ptno
											                               and aa.EXCF_CD           = bb.EXCF_CD
											                               and aa.PTNT_CMNT_DVSN_CD = bb.PTNT_CMNT_DVSN_CD
																              )
											 )    PHRM_PTNT_MEMO
				 ,  b.PTRM_NO	as PTRM_NO		/*병실번호2020-06-02 by kjh*/
				 ,  b.WARD_CD2 as WARD_CD2 	/*병실코드2020-06-02 by kjh*/
				 ,  f.DRAP_DVSN_CD as DRAP_DVSN_CD2	/*약적용구분코드 (내복/외용/주사) 2020-06-03 by kjh*/
				 ,  f.MDPR_CLSF_CD as MDPR_CLSF_CD2 	/*약품분류코드(마약) 2020-06-03 by kjh */
			     ,  f.TKMD_CATN_LABL_CD as TKMD_CATN_LABL_CD 	/*  복약라벨 표현 2020-06-03 by kjh*/
				 ,  to_char(b.RCPC_DT,'yyyymmddHH24MISS') as RCPC_DT	/*수납 일시 2020-06-03 by kjh*/	
				 ,  h.DPRT_CD as DPRT_CD	/*택배 코드 2020-06-04 by kjh*/
				 , trim(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(b.spsb_ctn,'[유사발음]',''),'[유사코드]',''),'[유사외관]',''),'[음식주의]',''),'[고위험]',''),'[고주의]',''),'[냉장]',''),'[차광]',''),'[냉동]',''),'[실온,차광]',''),'[냉장,차광]',''),'[상온,차광]',''),'[기타]',''),'[냉장금기]',''),'[냉장금기,차광]',''),'[용량다양]',''),'[출혈주의]',''),'[고농도]','')) PTNT_MEMO		/*의사 comment */
				 ,  fn_md_getage ('1',d.BTDT,sysdate) as AFI_AGE_VL_STR /*나이(처방쪽 함수사용) 추가 2020-06-04 by kjh */ 
				 ,  fn_md_getage ('2',d.BTDT,sysdate) as AFI_AGE_VL_STR2 /*나이 추가 2020-08-25 by kjh */ 
				 ,	n.PHRM_DTLS_CTRL_NM as PHRM_DTLS_CTRL_NM /*약국세부제어명  추가 2020-06-10 by kjh*/
			     ,	f.CMMD_UNSB_CTN as CMMD_UNSB_CTN /*임상약일 때 조제 특이사항 2020-06-15 by kjh*/
				 ,  b.SUBJ_IDNT_NO as SUBJ_IDNT_NO    /*임상처방전 정보 추가 2020-06-19 by kjh*/
			     ,  b.SUBJ_VIST_NM as SUBJ_VIST_NM    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.SUBJ_ADMN_VL as SUBJ_ADMN_VL    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.CLNC_EXAM_MDPR_CTN as CLNC_EXAM_MDPR_CTN       /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	nvl(f.NTM_RFLC_YN,'N') as NTM_RFLC_YN	/*약품정보의 횟수반영 추가 2020-06-19 by kjh*/
				 ,  b.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
				 ,  ( select b1.ABRV_DPRT_CD from HZDEPTMMT b1 where b1.DPRT_CD = b.WARD_CD)  as ABRV_DPRT_CD2  /*병동 코드 2020-07-24 by kjh*/
				 ,  ( select b1.ABRV_DPRT_CD from HZDEPTMMT b1 where b1.DPRT_CD = b.MCDP_CD)  as ABRV_DPRT_CD3 /* 진료과 2020-07-24 by kjh*/
				 ,  b.MDPR_TKVR_DT as MDPR_TKVR_DT		/*집계 일시 2020-07-24 by kjh*/ 
		         ,  LISTAGG(b.ordr_sno, '/') WITHIN GROUP (ORDER BY b.ordr_sno) OVER(PARTITION BY b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no, b.ordr_sno) AS RMRK_CTN
		         ,  decode(g.dgst_admn_ntm, 0 , b.MDNT, g.dgst_admn_ntm) AS DGST_ADMN_NTM 		 
		 		 ,  '2' as INQR_DVSN_CD
		         ,  case when nvl(f.TOTL_QTY_CLCL_YN, 'N') = 'N' then 'Y'
		                 when nvl(f.TOTL_QTY_CLCL_CD, 'XXX') = 'OT' then 'Y'
		                 else 'N'
		                 end as TOTL_QTY_CLCL_YN
		         , b.DRBN_NO
		         , to_char(d.BTDT,'yyyymmdd') as BTDT
				 , g.DRUG_DLVY_DPRT_CD  as DRUG_DLVY_DPRT_CD
		         , o.PHRM_DTLS_CTRL_NM  as PHRM_DTLS_CTRL_NM_1 
		         , f.MDPR_CLSF_DETL_CD  as MDPR_CLSF_DETL_CD  
		      from
		            (
		            select  /*+ ordered use_nl(a b c)   */
		                    b.ORDR_YMD
		                 ,  b.PTNO
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.MDRP_NO
						 ,	h.OROC_DPRT_CD	as OROC_DPRT_CD /* 가정간호사 2020-05-29 by kjh */
				         ,  (select WARD_CD  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as WARD_CD2    /* 병동코드 추가 2020-06-02 by kjh */
						 ,  (select PTRM_NO  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as PTRM_NO    /* 병실번호 추가 2020-06-02 by kjh */
						 ,  h.SUBJ_IDNT_NO   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_VIST_NM   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_ADMN_VL   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.CLNC_EXAM_MDPR_CTN  /*임상처방전 정보 추가 2020-06-19 by kjh*/
						 ,  h.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
						 ,  to_char(b.MDPR_TKVR_DT, 'YYYYMMDDHH24MISS')  AS MDPR_TKVR_DT  /* 2020-07-24 집계일시*/
						 ,  a.MCDP_CD
						 ,  h.ODDR_ID
						 ,  a.ORDR_DT
						 ,  a.TKMD_CCHN_YN 
						 ,  a.DRUG_INJC_DVSN_CD
						 ,  a.MCCN_CD
						 ,  a.PHDP_OROC_DPRT_CD
						 ,  a.WARD_CD
		                 ,  nvl(h.SNGN_BNDL_YN, 'N') SNGN_BNDL_YN
		                 ,  b.RCPC_PNTM_CMMD_STTS_MDFC_YN
		              from
		                    SDPORDBAT a
		                 ,  sdporddet b
		                 ,  MDMEDORDT h
		             where  1=1      
		               and  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		               and  a.MDTN_NO = #{mdtnNo}
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */                      
		               and  b.CMMD_STTS_CD < '6'
		               and  b.ORDR_YMD          = a.ORDR_YMD
		               and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		               and  b.MDTN_NO           = a.MDTN_NO
		               and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		               and  b.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} , 0, b.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
		               and  b.BSIS_CMMD_PLAC_CD = #{bsisCmmdPlacCd}       
		               and  nvl(b.DRUS_CD, 'X') != 'SAVE'
		               and  h.PTNO = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = b.ORDR_SNO
		               and ( ( b.BSIS_CMMD_PLAC_CD in ('1', '2', '3', '4', '5', '6', '7', 'A') and
				                       not exists ( select  'Y'
				                                      from  SDJDGRTNT s
				                                     where  s.ORDR_YMD        = b.ORDR_YMD
				                                       and  s.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
				                                       and  s.MDTN_NO         = b.MDTN_NO
				                                       and  s.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
				                                       and  s.ORDR_SNO        = b.ORDR_SNO
				                                       and  s.MDPR_CD         = b.MDPR_CD
				                                       and  nvl(s.MDPR_RTRN_NTM, -1) != 0
				                                       and  b.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
				                                                                  from  SDJDGRTNT t
				                                                                 where  s.ORDR_YMD         = t.ORDR_YMD
				                                                                   and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
				                                                                   and  s.MDTN_NO          = t.MDTN_NO
				                                                                   and  s.ORDR_SNO         = t.ORDR_SNO
				                                                                   and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
				                                                                   and  s.MDPR_CD          = t.MDPR_CD
				                                                                   and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
				                                                                   and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
				                                  )
				                     )
				                   )
						       and (   b.MDTN_NO_DVSN_CD in ('O','Z') and 
		                               (
		                                 ( B.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6') AND B.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y' )  OR
		                                 ( B.BSIS_CMMD_PLAC_CD  = 'A' AND B.DRAP_DVSN_CD               != '2' ) OR
		                                 ( B.BSIS_CMMD_PLAC_CD  = '7' AND NVL(B.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )
		                               OR
		                               B.MDTN_NO_DVSN_CD IN ('G','H','I','D','F','P','Q','S','T') AND 
		                               (
		                                 ( B.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6', 'A') AND B.DRAP_DVSN_CD != '2') OR   /* 경구외용    */   
		                                 ( B.BSIS_CMMD_PLAC_CD  = '7' AND NVL(B.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )	                                       
		                           )            
		            )  b                                             /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMV e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDDMETCDT m
		 		 ,  SDMCTRLMT n																/* 약국제어 정보 - 복약주의라벨 추가 2020-06-10 by kjh */
		         ,  SDMCTRLMT o
		     where  
		            b.BSIS_CMMD_PLAC_CD = #{bsisCmmdPlacCd}
		       and  d.PTNO  = b.PTNO
		       and  e.USER_ID = b.ODDR_ID
		       and  e2.LGIN_ID   = e.LGIN_ID
		       and  f.MDPR_CD = b.MDPR_CD
		/*       and  ( (nvl(f.DGMT_RGST_TYPE_CD, '1') <> '2' and nvl(f.RELS_YN, 'N') = 'Y')
		             or (nvl(f.DGMT_RGST_TYPE_CD, '1') = '2')
		            )
		       and  ( (nvl(f.DGMT_RGST_TYPE_CD, '1') <> '2' and b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y')
		             or (nvl(f.DGMT_RGST_TYPE_CD, '1') = '2')
		            )
		*/
		]]>
		<if test='"5".equals(bsisCmmdPlacCd)'>
		<![CDATA[
		/*       and  (   (f.BSIS_CMMD_PLAC_CD  = '1' )
		                or (f.bsis_cmmd_plac_cd = '5') 
		                or (f.BSIS_CMMD_PLAC_CD = '3' and (f.dgfr_cd = '02' or (f.dgfr_cd = '01' and mod(b.PCKN_UNAD_QTY, 0.25) <> 0) ))
		                or (b.SNGN_BNDL_YN = 'Y')
		            )
		*/
		]]>
		</if>
		<if test='"3".equals(bsisCmmdPlacCd)'>
		<![CDATA[
		       and  b.SNGN_BNDL_YN = 'Y'
		]]>
		</if>
		<![CDATA[
		       and  g.DRUS_CD = b.DRUS_CD
		       and  h.DPRT_CD = b.MCDP_CD
		       and  i.COMN_GRP_CD = 'SD003'
		       and  i.COMN_DTLS_CD = nvl(f.KPNG_PLAC_CD, '9')
		       and  m.DRUS_CD = b.DRUS_CD
			   and  n.PHRM_CTRL_CD(+) = 'SDA_009'
			   and  n.PHRM_DTLS_CTRL_CD (+) = f.TKMD_CATN_LABL_CD/*복약주의라벨 추가 2020-06-10 by kjh  */
		       and  o.PHRM_CTRL_CD(+) = 'SD170'
			   and  o.PHRM_DTLS_CTRL_CD (+) = f.MDPR_CD /* 라벨주의사항  */
		)	   
		     order
		        by
		           ABRV_DPRT_CD2
		        ,  ORDR_YMD
		        ,  MDTN_NO_DVSN_CD
		        ,  MDTN_NO 
		        ,  decode(BSIS_CMMD_PLAC_CD,'1','1','3','2','2','3','5','4','4','5','A','6','7','7')
		        ,  INQR_DVSN_CD
		        ,  rank() over (partition by ordr_ymd, mdtn_no_dvsn_cd, mdtn_no order by ordr_sno)
		        ,  case when instr(SB_DRUS_CD , 'M') > 0 then '1'
		                when instr(SB_DRUS_CD , 'D') > 0 then '2'
		                when instr(SB_DRUS_CD, 'E') > 0 then '3'
		                else '4'       
		           end  
		        , MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLabl-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="inqrCct" column="INQR_CCT"/>
		<result property="inqrCct1" column="INQR_CCT1"/>
		<result property="sbDrusCd" column="SB_DRUS_CD"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ptno" column="PTNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ntnlCd" column="NTNL_CD"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="ordrDt" column="ORDR_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="afiMixKindNm" column="AFI_MIX_KIND_NM"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcknUnadQty2" column="PCKN_UNAD_QTY2"/>
		<result property="invnPcunCd" column="INVN_PCUN_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN2"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN4"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="kpngPlacCd" column="KPNG_PLAC_CD"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="ptntCmntSno" column="PTNT_CMNT_SNO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="smryMdprNm" column="SMRY_MDPR_NM"/>
		<result property="otptCuntTrnmYn" column="OTPT_CUNT_TRNM_YN"/>
		<result property="drugPrinYn" column="DRUG_PRIN_YN"/>
		<result property="kornPdctNm" column="KORN_PDCT_NM"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="zpadNm" column="ZPAD_NM"/>
		<result property="deadNm" column="DEAD_NM"/>
		<result property="afiTkmdCchnDvsnNm" column="AFI_TKMD_CCHN_DVSN_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="mccnCd" column="MCCN_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="afiOrdrAudtDvsnNm1" column="AFI_ORDR_AUDT_DVSN_NM_1"/>
		<result property="frrn" column="FRRN"/>
		<result property="drusCd1" column="DRUS_CD1"/>
		<result property="prinPageNo" column="PRIN_PAGE_NO"/>
		<result property="totlPageCnt" column="TOTL_PAGE_CNT"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mrnnTkngYn" column="MRNN_TKNG_YN"/>
		<result property="lnchTkngYn" column="LNCH_TKNG_YN"/>
		<result property="evnnTkngYn" column="EVNN_TKNG_YN"/>
		<result property="slepBefrTkngYn" column="SLEP_BEFR_TKNG_YN"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="abrvDprtCd" column="ABRV_DPRT_CD"/>
		<result property="bdwgVl" column="BDWG_VL"/>
		<result property="oddrAbrvDprtCd2" column="ODDR_ABRV_DPRT_CD2"/>
		<result property="phrmPtntMemo" column="PHRM_PTNT_MEMO"/>
		<result property="ptrmNo" column="PTRM_NO"/>
		<result property="wardCd2" column="WARD_CD2"/>
		<result property="drapDvsnCd2" column="DRAP_DVSN_CD2"/>
		<result property="mdprClsfCd2" column="MDPR_CLSF_CD2"/>
		<result property="tkmdCatnLablCd" column="TKMD_CATN_LABL_CD"/>
		<result property="rcpcDt" column="RCPC_DT"/>
		<result property="dprtCd" column="DPRT_CD"/>
		<result property="ptntMemo" column="PTNT_MEMO"/>
		<result property="afiAgeVlStr" column="AFI_AGE_VL_STR"/>
		<result property="afiAgeVlStr2" column="AFI_AGE_VL_STR2"/>
		<result property="phrmDtlsCtrlNm" column="PHRM_DTLS_CTRL_NM"/>
		<result property="cmmdUnsbCtn" column="CMMD_UNSB_CTN"/>
		<result property="subjIdntNo" column="SUBJ_IDNT_NO"/>
		<result property="subjVistNm" column="SUBJ_VIST_NM"/>
		<result property="subjAdmnVl" column="SUBJ_ADMN_VL"/>
		<result property="clncExamMdprCtn" column="CLNC_EXAM_MDPR_CTN"/>
		<result property="ntmRflcYn" column="NTM_RFLC_YN"/>
		<result property="oslfAdmnDrugYn" column="OSLF_ADMN_DRUG_YN"/>
		<result property="abrvDprtCd2" column="ABRV_DPRT_CD2"/>
		<result property="abrvDprtCd3" column="ABRV_DPRT_CD3"/>
		<result property="mdprTkvrDt" column="MDPR_TKVR_DT"/>
		<result property="rmrkCtn" column="RMRK_CTN"/>
		<result property="dvsnVl" column="DVSN_VL"/>
		<result property="dgstAdmnNtm" column="DGST_ADMN_NTM"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
		<result property="totlQtyClclYn" column="TOTL_QTY_CLCL_YN"/>
		<result property="btdt" column="BTDT"/>
		<result property="drugDlvyDprtCd" column="DRUG_DLVY_DPRT_CD"/>
		<result property="phrmDtlsCtrlNm1" column="PHRM_DTLS_CTRL_NM_1"/>
		<result property="mdprClsfDetlCd" column="MDPR_CLSF_DETL_CD"/>
		<result property="careMpngClsfNm" column="CARE_MPNG_CLSF_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLabl () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLabl-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLabl"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLabl-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOtptCmmdLabl */
		<![CDATA[
		select  /*+ sdd_pordbat_l84$S01_외래라벨 출력 */
		            to_char(a.ORDR_YMD, 'yyyymmdd')       ORDR_YMD                                  /* 처방일자     */
		         ,  1 as INQR_CCT
		         ,  1 as INQR_CCT1
		         ,  b.DRUS_CD as SB_DRUS_CD
		         ,  b.DRUS_CD aS DRUS_CD
		         ,  decode(a.CMMD_PRSR_YN, 'Y', 'P', 'C', 'C', 'T', 'V', a.MDTN_NO_DVSN_CD)  MDTN_NO_DVSN_CD /* 투약번호구분 */
		         ,  a.MDTN_NO                                             /* 투약번호     */
		         ,  a.PTNO                                                /* 환자번호     */
		         ,  d.PTNT_NM                                             /* 환자명       */
		         ,  d.GEND_CD                                             /* 성별         */
		         ,  nvl(d.NTNL_CD, 'KR')       NTNL_CD                    /* 국적코드     */
		         ,  a.MCDP_CD                           as MCDP_CD        /* 진료과       */
		         ,  h.KORN_DPRT_NM                                        /* 진료과명     */
		         ,  b.ODDR_ID                                             /* 처방의       */
		         ,  e.USER_NM       AFI_ODDR_NM                           /* 처방의명     */
		         ,  to_char(a.ORDR_DT, 'yyyymmddHH24MISS')      ORDR_DT   /* 입력일시     */
		         ,  to_char(b.PRIN_DT, 'yyyymmddHH24MISS')      PRIN_DT   /* 출력일시     */
		         ,  a.TKMD_CCHN_YN                                        /* 복약지도여부 */
		         ,  b.ORDR_SNO                                            /* 처방순번     */
		         ,  b.PHDP_CMMD_BNDL_NO                                   /* Rp           */
		         ,  b.MDPR_CLSF_CD                                        /* 약품분류     */
		         ,  b.DRAP_DVSN_CD                                        /* 적용구분     */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '&')
		                                      , '5', decode(nvl(b.MIX_KIND_CD, '3'), '3', ' ', '%'), ' ') AFI_MIX_KIND_NM
		         ,  b.MDPR_CD                                             /* 약품코드     */
		         ,  FN_SD_GETHGCTMDPRNM_S(b.MDPR_CD,f.MDPR_NM)    MDPR_NM     /* 약품명       */
		         ,  b.SLCT_UNIT_DVSN_CD                                   /* 처방선택구분 */
		         ,  b.ICUN_ADMN_VLM                                       /* 일회량(함량) */
		         ,  f.ICUN_CD                                             /* 함량단위     */
				 ,  ROUND(b.PCKN_UNAD_QTY,3) as PCKN_UNAD_QTY 		      /* 일회량(포장) */ 
		         ,  b.PCKN_UNAD_QTY as PCKN_UNAD_QTY2
		         ,  f.INVN_PCUN_CD                                        /* 포장단위     */
		         ,  b.MDNT                                                /* 횟수         */
		         ,  b.MDTN_DDCN                                           /* 일수         */
		         ,  b.BSIS_CMMD_PLAC_CD                                   /* 조제장소     */
				 ,  g.ENVL_MEMO_CTN1
				 ,  g.ENVL_MEMO_CTN2
				 ,  g.ENVL_MEMO_CTN3
				 ,  g.ENVL_MEMO_CTN4     
		/*         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN1, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		                                                                                      , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                              , 'A', '__정'
		                                                                                      , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                                      , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포' ))
		                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                , 'A', '__정'
		                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포') )
		                                                                                        , ' 회', '@@회'), ' 일', '1일')     ENVL_MEMO_CTN1   
		         ,  replace( replace( replace( replace( g.ENVL_MEMO_CTN2, '포(정)', decode(b.BSIS_CMMD_PLAC_CD
		                                                                        , '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                , 'A', '__정'
		                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                  , '정(포)', decode(b.BSIS_CMMD_PLAC_CD, '1', decode(upper(b.PCUN_NM), 'C', '__정', 'T', '__정', 'PKG', '__포', '__'||b.PCUN_NM)
				                                                                , 'A', '__정'
		                                                                        , 'O', decode(b.PCKN_UNAD_QTY, 0.5, '0.5(반) 정', '__정')
		                                                                        , '4', decode(upper(b.PCUN_NM), 'PKG', '__포', '__'||b.PCUN_NM), '1포'))
		                                                                                          , ' 회', '@@회'), ' 일', '1일')      ENVL_MEMO_CTN2   
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN3, 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN3, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN3)   ENVL_MEMO_CTN3 
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '4', replace(g.ENVL_MEMO_CTN4, 'tablet', b.PCUN_NM)
		                                      , '2', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '3', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', '')
		                                      , '5', replace(replace(g.ENVL_MEMO_CTN4, 'tablet', '1 package'), '__', ''), g.ENVL_MEMO_CTN4)   ENVL_MEMO_CTN4     */
			     ,  ROUND(b.INVN_TOTL_QTY,3) as INVN_TOTL_QTY /*2020-08-03 kjh*/
		         ,  nvl(b.MIX_KIND_CD, 'N')    MIX_KIND_CD                   /* MIX구분      */
		         ,  replace(replace(fn_sd_isnumber_s(b.SPSB_CTN), chr(13)||chr(10), ''), chr(10), '')        SPSB_CTN                         /* 처방특기사항 */
		         ,  f.KPNG_PLAC_CD                                        /* 보관장소     */
		         ,  i.DETL_CD_NM                                          /* 보관장소명   */
		         ,  (
		                select
		                        x.PTNT_CMNT_SNO
		                  from
		                        SZPATCMMT x                        
		                 where  x.PTNO = a.PTNO
		                   and  x.EXCF_CD = 'SD'
		                   and  x.PTNT_CMNT_DVSN_CD in ('21', 'C2')
		                   and  x.SPSB_CTN is not null
		                   and  rownum < 2
		             )      PTNT_CMNT_SNO                                  /* 환자COMMENT여부 */
		         ,  a.DRUG_INJC_DVSN_CD                                    /* 약주사구분   */
		         ,  b.DURV_RESN_CTN
		         ,  f.SMRY_MDPR_NM    /* 라벨출력용 요약상품명 */
		         ,  decode(b.BSIS_CMMD_PLAC_CD, '6', decode(sign(b.INVN_TOTL_QTY - b.CUNT_TRNM_MDPR_COT), 1, '*', ''), '')  OTPT_CUNT_TRNM_YN
		         ,  b.DRUG_PRIN_YN
		         ,  case
		                 when ascii(substr(d.PTNT_NM, 1, 1)) < 129 then f.ENSN_PDCT_NM
		                 else f.KORN_PDCT_NM
		             end        KORN_PDCT_NM            /*   한글상품명            */
		         ,  e2.USER_LCNS_NO                     /*   의사면허번호          */
		         ,  (select z.ZPAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) ZPAD_NM
		         ,  (select z.DEAD_NM  from APPTADRSV z where z.PTNO = a.PTNO and z.ADRS_USGE_CD = 'A' and z.ADRS_SNO = 1 and rownum = 1) DEAD_NM
		         ,  (
		                select
		                        max(x.SUBGRPCODE)
		                  from
		                        SDCMCDDMV x
		                 where  x.COMN_GRP_CD = 'SD156'
		                   and  x.COMN_DTLS_CD = b.MDPR_CD
		             )         AFI_TKMD_CCHN_DVSN_NM                                /* 복약지도 구분 : 1-암환자,2-이식환자,4-Warfarin,6-흡입기 */
		         ,  a.MDTN_LCDV_CD
		         ,  a.MCCN_CD
		         ,  b.INJC_PLAC_CD
		         ,  fn_sd_getaudfglist_s9(b.ORDR_YMD, b.MDTN_NO_DVSN_CD, b.MDTN_NO, b.MDTN_LCDV_CD, #{phdpCmmdBndlNo}
		                         , #{afiBsisCmmdPlacNm}, #{drapDvsnCd}, #{otptPhrmRqstYn}, null)   AFI_ORDR_AUDT_DVSN_NM_1
		         ,  d.FRRN
		         ,  b.DRUS_CD1  /* 처방용법 */
		         ,  '0' PRIN_PAGE_NO
		         ,  0 TOTL_PAGE_CNT
		         ,  b.MDRP_NO
		         ,  a.PTDV_CD
		         ,  m.MRNN_TKNG_YN
		         ,  m.LNCH_TKNG_YN
		         ,  m.EVNN_TKNG_YN
		         ,  m.SLEP_BEFR_TKNG_YN
		         ,  nvl( a.PHDP_OROC_DPRT_CD,'')  PHDP_OROC_DPRT_CD
		         ,  nvl((select h.ABRV_DPRT_CD from HZDEPTMMT h where h.DPRT_CD = a.MCCN_CD),'') ABRV_DPRT_CD
				 ,  fn_sd_getweight_s(a.PTNO, a.ORDR_YMD)    as BDWG_VL 
		         ,  ( select b1.ABRV_DPRT_CD
				      from HZDEPTMMT b1
				      where b1.DPRT_CD = b.OROC_DPRT_CD
				    )                                            as ODDR_ABRV_DPRT_CD2		
				 , (select WM_CONCAT(aa.SPSB_CTN)
					    from  SZPATCMMT aa
						 where aa.ptno = a.ptno
				       and  aa.PTNT_CMNT_SNO >= (
							                             select max(PTNT_CMNT_SNO) - 1
								                             from SZPATCMMT bb
								                            where 1=1
								                              and aa.ptno              = bb.ptno
								                              and aa.EXCF_CD           = bb.EXCF_CD
								                              and aa.PTNT_CMNT_DVSN_CD = bb.PTNT_CMNT_DVSN_CD
																              )
						)    PHRM_PTNT_MEMO		 
				 ,  b.PTRM_NO	as PTRM_NO		/*병실번호2020-06-02 by kjh*/
				 ,  b.WARD_CD2 as WARD_CD2 	/*병실코드2020-06-02 by kjh*/ /*2020-07-24 주석 처리 */
				 ,  f.DRAP_DVSN_CD as DRAP_DVSN_CD2	/*약적용구분코드 (내복/외용/주사) 2020-06-03 by kjh*/
				 ,  f.MDPR_CLSF_CD as MDPR_CLSF_CD2 	/*약품분류코드(마약) 2020-06-03 by kjh */
			     ,  f.TKMD_CATN_LABL_CD as TKMD_CATN_LABL_CD 	/*  복약라벨 표현 2020-06-03 by kjh*/
				 ,  to_char(b.RCPC_DT,'yyyymmddHH24MISS') as RCPC_DT	/*수납 일시 2020-06-03 by kjh*/	
				 ,  h.DPRT_CD as DPRT_CD	/*택배 코드 2020-06-04 by kjh*/
		         , trim(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(b.spsb_ctn,'[유사발음]',''),'[유사코드]',''),'[유사외관]',''),'[음식주의]',''),'[고위험]',''),'[고주의]',''),'[냉장]',''),'[차광]',''),'[냉동]',''),'[실온,차광]',''),'[냉장,차광]',''),'[상온,차광]',''),'[기타]',''),'[냉장금기]',''),'[냉장금기,차광]',''),'[용량다양]',''),'[출혈주의]',''),'[고농도]','')) PTNT_MEMO		/*의사 comment */
				 ,  fn_md_getage ('1',d.BTDT,sysdate) as AFI_AGE_VL_STR /*나이 추가 2020-08-25 by kjh */
				 ,  fn_md_getage ('2',d.BTDT,sysdate) as AFI_AGE_VL_STR2 /*나이(처방쪽 함수사용) 추가 2020-06-04 by kjh */ 
				 ,	n.PHRM_DTLS_CTRL_NM as PHRM_DTLS_CTRL_NM /*약국세부제어명  추가 2020-06-10 by kjh*/
			     ,	f.CMMD_UNSB_CTN as CMMD_UNSB_CTN /*임상약일 때 조제 특이사항 2020-06-15 by kjh*/
				 ,  b.SUBJ_IDNT_NO as SUBJ_IDNT_NO    /*임상처방전 정보 추가 2020-06-19 by kjh*/
			     ,  b.SUBJ_VIST_NM as SUBJ_VIST_NM    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.SUBJ_ADMN_VL as SUBJ_ADMN_VL    /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	b.CLNC_EXAM_MDPR_CTN as CLNC_EXAM_MDPR_CTN       /*임상처방전 정보 추가 2020-06-19 by kjh*/
				 ,	nvl(f.NTM_RFLC_YN,'N') as NTM_RFLC_YN	/*약품정보의 횟수반영 추가 2020-06-19 by kjh*/
				 ,  b.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
				 ,  ( select b1.ABRV_DPRT_CD
					  from HZDEPTMMT b1
					  where b1.DPRT_CD = b.WARD_CD2
				     )  as ABRV_DPRT_CD2  /*병동 코드 2020-07-24 by kjh*/ 
				 ,  ( select b1.ABRV_DPRT_CD
					  from HZDEPTMMT b1
					  where b1.DPRT_CD = a.MCDP_CD
					 )  as ABRV_DPRT_CD3 /* 진료과 2020-07-24 by kjh*/
				 ,  to_char(b.MDPR_TKVR_DT, 'yyyymmddhh24miss') as MDPR_TKVR_DT
				 ,  LISTAGG(b.ordr_sno, '/') WITHIN GROUP (ORDER BY b.ordr_sno) OVER(PARTITION BY b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no, b.ordr_sno) AS RMRK_CTN
		         ,  (case when instr(LISTAGG(b.ordr_sno, '/') WITHIN GROUP (ORDER BY b.ordr_sno) OVER(PARTITION BY b.ordr_ymd, b.mdtn_no_dvsn_cd, b.mdtn_no, b.ordr_sno),'/') > 0 then 'N'
				          else 'Y'
				     end)         as DVSN_VL
		         ,  decode(g.dgst_admn_ntm, 0 , b.MDNT, g.dgst_admn_ntm) AS DGST_ADMN_NTM
		 		 ,  '2' as INQR_DVSN_CD   /* 용법 별 라벨출력 : 1, 개별 라벨출력 : 2 */	
		         ,  case when nvl(f.TOTL_QTY_CLCL_YN, 'N') = 'N' then 'Y'
		                 when nvl(f.TOTL_QTY_CLCL_CD, 'XXX') = 'OT' then 'Y'
		                 else 'N'
		                 end as TOTL_QTY_CLCL_YN
		         , to_char(d.BTDT,'yyyymmdd') as BTDT
		         , g.DRUG_DLVY_DPRT_CD  as DRUG_DLVY_DPRT_CD
		         , o.PHRM_DTLS_CTRL_NM  as PHRM_DTLS_CTRL_NM_1
		         , f.MDPR_CLSF_DETL_CD  as MDPR_CLSF_DETL_CD
		         , ( select
					           y.CARE_MPNG_CLSF_NM      as CARE_MPNG_CLSF_NM
					from  (
				      			select  distinct c.CARE_MPNG_LRCL_CD
				      			from  SUCAMPDET c
				      			where c.CARE_MPNG_CD like 'C' || '%'
				        		and c.CARE_MPNG_LRCL_CD in (select  
																	 x.DIET_CLSF_CD
															from  MNWDIETMT x  /*  식사기본    */
														   where  x.MDRP_NO        = b.MDRP_NO
														     and  x.DIST_YMD      <= b.ORDR_YMD
															 and  x.DIET_FNSH_YMD >= b.ORDR_YMD
															 and  x.DIDV_CD IN ('1','2','3','4')
															)
				      		  ) x
				  			, (
				       			select  CARE_MPNG_CLSF_CD
				           			 ,  CARE_MPNG_CLSF_NM
				           		     ,  SORT_SQNC
				        	    from  SUCAMAPMT
				        		where  CARE_MPNG_DVSN_CD = '2'
				     		 ) y
					 where x.CARE_MPNG_LRCL_CD = y.CARE_MPNG_CLSF_CD
					   and rownum < 2) as CARE_MPNG_CLSF_NM 
		      from
		            SDPORDBAT a                               /* 약처방내역기본 */
		         ,  (
		            select  /*+ ordered use_nl(a b c)   */
		                    b.ORDR_YMD
		                 ,  b.MDTN_NO_DVSN_CD
		                 ,  b.MDTN_NO
		                 ,  b.ORDR_SNO
		                 ,  b.PTDV_CD
		                 ,  b.MDPR_CD
		                 ,  b.MDPR_CLSF_CD
		                 ,  b.DRAP_DVSN_CD
		                 ,  b.CMMD_STTS_CD
		                 ,  b.PCKN_UNAD_QTY
		                 ,  b.PCUN_NM
		                 ,  b.ICUN_ADMN_VLM
		                 ,  b.ICUN_CD
		                 ,  b.SLCT_UNIT_DVSN_CD
		                 ,  b.MDTN_DDCN
		                 ,  b.DRUS_CD
		                 ,  b.MDNT
		                 ,  decode(h.FRNS_CTRL_DVSN_CD, null, b.TOTL_CLCL_QTY, b.INVN_TOTL_QTY) TOTL_CLCL_QTY
		                 ,  b.INVN_TOTL_QTY
		                 ,  b.DRBN_NO
		                 ,  b.PHDP_CMMD_BNDL_NO
		                 ,  b.MIX_KIND_CD
		                 ,  b.BSIS_CMMD_PLAC_CD
		                 ,  b.SPSB_CTN
		                 ,  b.FDNO_MDPR_CNFR_DT
		                 ,  b.ISDV_CD
		                 ,  b.DRUG_ORDR_INPT_DT
		                 ,  b.SDPF_EXRE_CD
		                 ,  b.PRIN_DT
		                 ,  b.PRMR_BRCD_SCAN_DT
		                 ,  b.CMMD_FINS_DT
		                 ,  b.MDTN_DT
		                 ,  b.MDTN_STRT_YMD
		                 ,  b.INJC_PLAC_CD
		                 ,  b.OHOR_RTRN_YN
		                 ,  b.BEMD_NO
		                 ,  b.ATTR_NO
		                 ,  case
		                         when b.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then b.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                         when b.DURV_RESN_CTN is not null then b.DURV_RESN_CTN
		                         when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		                     end      DURV_RESN_CTN
		                 ,  b.RCPC_YN
		                 ,  b.RCPC_DT
		                 ,  b.WARD_LABL_PRIN_YN
		                 ,  b.LAST_UPDR_ID
		                 ,  b.LAST_UPDT_IP
		                 ,  b.LAST_UPDT_DT
		                 ,  b.PHRM_IMPL_YMD
		                 ,  b.CUNT_TRNM_MDPR_COT
		                 ,  a.DRUG_PRIN_YN
		                 ,  a.MDTN_LCDV_CD
		                 ,  h.DRUS_CD DRUS_CD1  /* 처방용법 */
		                 ,  h.MDRP_NO
						 ,	h.OROC_DPRT_CD	as OROC_DPRT_CD 
				         ,  (select WARD_CD  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as WARD_CD2    /* 병동코드 추가 2020-06-02 by kjh */
						 ,  (select PTRM_NO  from APRCRPTNT where MDRP_NO = h.MDRP_NO) as PTRM_NO    /* 병실번호 추가 2020-06-02 by kjh */
						 ,  h.SUBJ_IDNT_NO   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_VIST_NM   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.SUBJ_ADMN_VL   /*임상처방전 정보 추가 2020-06-19 by kjh*/
				         ,  h.CLNC_EXAM_MDPR_CTN  /*임상처방전 정보 추가 2020-06-19 by kjh*/
						 ,  h.OSLF_ADMN_DRUG_YN		/*자가투여약여부 2020-06-30 by kjh*/
		                 ,  b.OSLF_ADMN_DRUG_YN   as OSLF_ADMN_DRUG_YN2		/*자가투여약여부(약접수 상) 2020-07-24 by..lsw*/
		                 ,  b.MDPR_TKVR_DT
		                 ,  h.ODDR_ID
		                 ,  b.RCPC_PNTM_CMMD_STTS_MDFC_YN
		              from
		                    SDPORDBAT a
		                 ,  SDPORDDET b
		                 ,  MDMEDORDT h
		             where  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		               and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		               and  a.MDTN_NO = #{mdtnNo}
		               and  a.MDTN_LCDV_CD = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
					   and  instr(#{afiBsisCmmdPlacNm}, b.bsis_cmmd_plac_cd) > 0
		               and  b.ORDR_YMD          = a.ORDR_YMD
		               and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		               and  b.MDTN_NO           = a.MDTN_NO
		               and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		               and  b.PHDP_CMMD_BNDL_NO = decode(#{phdpCmmdBndlNo} , 0, b.PHDP_CMMD_BNDL_NO, #{phdpCmmdBndlNo} )
		               and  nvl(b.DRUS_CD, 'X') != 'SAVE'
		               and  b.DRAP_DVSN_CD = nvl(#{drapDvsnCd} , b.DRAP_DVSN_CD)
		               and  h.PTNO = a.PTNO
		               and  h.ORDR_YMD = a.ORDR_YMD
		               and  h.ORDR_SNO = b.ORDR_SNO
		               and (
				                       not exists ( select  'Y'
				                                      from  SDJDGRTNT s
				                                     where  s.ORDR_YMD        = b.ORDR_YMD
				                                       and  s.MDTN_NO_DVSN_CD = b.MDTN_NO_DVSN_CD
				                                       and  s.MDTN_NO         = b.MDTN_NO
				                                       and  s.MDTN_LCDV_CD    = b.MDTN_LCDV_CD
				                                       and  s.ORDR_SNO        = b.ORDR_SNO
				                                       and  s.MDPR_CD         = b.MDPR_CD
				                                       and  nvl(s.MDPR_RTRN_NTM, -1) != 0
				                                       and  b.INVN_TOTL_QTY <= (select  sum(RTRN_RQST_CQY)
				                                                                  from  SDJDGRTNT t
				                                                                 where  s.ORDR_YMD         = t.ORDR_YMD
				                                                                   and  s.MDTN_NO_DVSN_CD  = t.MDTN_NO_DVSN_CD
				                                                                   and  s.MDTN_NO          = t.MDTN_NO
				                                                                   and  s.ORDR_SNO         = t.ORDR_SNO
				                                                                   and  s.MDTN_LCDV_CD     = t.MDTN_LCDV_CD
				                                                                   and  s.MDPR_CD          = t.MDPR_CD
				                                                                   and  t.RTRN_DETL_DVSN_CD = 'B' /* A 수령반납, B 미수령반납, Z 잔량반납 */
				                                                                   and  nvl(t.MDPR_RTRN_NTM, -1) != 0)
				                                  )
				                   )
		                       and (   b.MDTN_NO_DVSN_CD in ('O','Z') and 
		                               (
		                                 ( b.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6') AND b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y' )  OR
		                                 ( b.BSIS_CMMD_PLAC_CD  = 'A' AND b.DRAP_DVSN_CD               != '2' ) OR
		                                 ( b.BSIS_CMMD_PLAC_CD  = '7' AND NVL(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )
		                               OR
		                               b.MDTN_NO_DVSN_CD IN ('G','H','I','D','F','P','Q','S','T') AND 
		                               (
		                                 ( b.BSIS_CMMD_PLAC_CD IN ('1', '2', '3', '4', '5', '6', 'A') AND b.DRAP_DVSN_CD != '2') OR   /* 경구외용    */   
		                                 ( b.BSIS_CMMD_PLAC_CD  = '7' AND NVL(b.OSLF_ADMN_DRUG_YN, 'N') = 'Y' )     /* 자가주사만 */
		                                )	                                       
		                           )            
		            )  b                                      /* 약처방내역상세 */
		         ,  APPTPTNTV d                               /* 환자마스터     */
		         ,  CCUSRDPHT e                               /* 사용자마스터   */
		         ,  CCUSERAMV e2
		         ,  SDDDGCDMT f                               /* 처방코드마스터 */
		         ,  SDDMETCDT g                               /* 용법코드마스터 */
		         ,  HZDEPTMMT h                               /* 부서코드마스터 */
		         ,  SDCMCDDMV i                               /* 공통코드마스터 */
		         ,  SDDMETCDT m
		 		 ,  SDMCTRLMT n																/* 약국제어 정보 - 복약주의라벨 추가 2020-06-10 by kjh */
		         ,  SDMCTRLMT o
		     where  a.ORDR_YMD        = to_date(#{ordrYmd} , 'YYYYMMDD')
		       and  a.MDTN_NO_DVSN_CD = #{mdtnNoDvsnCd}
		       and  a.MDTN_NO         = #{mdtnNo}
		       and  a.MDTN_LCDV_CD    = decode(#{mdtnLcdvCd}, null, a.MDTN_LCDV_CD, 'A', a.MDTN_LCDV_CD, #{mdtnLcdvCd} )  /* 투약위치 */
		       and  b.ORDR_YMD          = a.ORDR_YMD
		       and  b.MDTN_NO_DVSN_CD   = a.MDTN_NO_DVSN_CD
		       and  b.MDTN_NO           = a.MDTN_NO
		       and  b.MDTN_LCDV_CD      = a.MDTN_LCDV_CD
		       and  d.PTNO  = a.PTNO
		       and  e.USER_ID = b.ODDR_ID
		       and  e2.LGIN_ID   = e.LGIN_ID
		       and  f.MDPR_CD = b.MDPR_CD
		/*       and  (   (b.BSIS_CMMD_PLAC_CD NOT IN ('T', 'U', 'V') and nvl(f.RELS_YN, 'N') = 'Y')
		             or (b.BSIS_CMMD_PLAC_CD IN ('T', 'U', 'V') )
		            )
		       and  (   (b.BSIS_CMMD_PLAC_CD NOT IN ('T', 'U', 'V') and b.RCPC_PNTM_CMMD_STTS_MDFC_YN = 'Y')
		             or (b.BSIS_CMMD_PLAC_CD IN ('T', 'U', 'V') )
		            )
		*/
		       and  g.DRUS_CD = b.DRUS_CD
		       and  h.DPRT_CD = a.MCDP_CD
		       and  i.COMN_GRP_CD = 'SD003'
		       and  i.COMN_DTLS_CD = nvl(f.KPNG_PLAC_CD, '9')
		       and  m.DRUS_CD = b.DRUS_CD
			   and  n.PHRM_CTRL_CD(+) = 'SDA_009'
			   and  n.PHRM_DTLS_CTRL_CD (+) = f.TKMD_CATN_LABL_CD/*복약주의라벨 추가 2020-06-10 by kjh  */
		       and  o.PHRM_CTRL_CD(+) = 'SD170'
		 	   and  o.PHRM_DTLS_CTRL_CD (+) = f.MDPR_CD /* 라벨주의사항  */   
		     order
		        by
		            a.ORDR_YMD
		         ,  a.MDTN_NO_DVSN_CD
		         ,  a.MDTN_NO
		         ,  decode(BSIS_CMMD_PLAC_CD,'1','1','3','2','2','3','5','4','4','5','A','6','7','7')
		         ,  b.PHDP_CMMD_BNDL_NO
		         ,  b.MDPR_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheetForM-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="mdtnNoDvsnCd" column="MDTN_NO_DVSN_CD"/>
		<result property="mdtnNo" column="MDTN_NO"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdprCd" column="MDPR_CD"/>
		<result property="ptdvCd" column="PTDV_CD"/>
		<result property="mdprClsfCd" column="MDPR_CLSF_CD"/>
		<result property="drapDvsnCd" column="DRAP_DVSN_CD"/>
		<result property="cmmdSttsCd" column="CMMD_STTS_CD"/>
		<result property="pcknUnadQty" column="PCKN_UNAD_QTY"/>
		<result property="pcunNm" column="PCUN_NM"/>
		<result property="icunAdmnVlm" column="ICUN_ADMN_VLM"/>
		<result property="icunCd" column="ICUN_CD"/>
		<result property="slctUnitDvsnCd" column="SLCT_UNIT_DVSN_CD"/>
		<result property="mdtnDdcn" column="MDTN_DDCN"/>
		<result property="drusCd" column="DRUS_CD"/>
		<result property="mdnt" column="MDNT"/>
		<result property="totlClclQty" column="TOTL_CLCL_QTY"/>
		<result property="invnTotlQty" column="INVN_TOTL_QTY"/>
		<result property="phdpCmmdBndlNo" column="PHDP_CMMD_BNDL_NO"/>
		<result property="drbnNo" column="DRBN_NO"/>
		<result property="mixKindCd" column="MIX_KIND_CD"/>
		<result property="bsisCmmdPlacCd" column="BSIS_CMMD_PLAC_CD"/>
		<result property="spsbCtn" column="SPSB_CTN"/>
		<result property="fdnoMdprCnfrDt" column="FDNO_MDPR_CNFR_DT"/>
		<result property="isdvCd" column="ISDV_CD"/>
		<result property="drugOrdrInptDt" column="DRUG_ORDR_INPT_DT"/>
		<result property="sdpfExreCd" column="SDPF_EXRE_CD"/>
		<result property="injcPlacCd" column="INJC_PLAC_CD"/>
		<result property="ohorRtrnYn" column="OHOR_RTRN_YN"/>
		<result property="bemdNo" column="BEMD_NO"/>
		<result property="attrNo" column="ATTR_NO"/>
		<result property="durvResnCtn" column="DURV_RESN_CTN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rptnDt" column="RPTN_DT"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="rcpcYn" column="RCPC_YN"/>
		<result property="updtBemdNo" column="UPDT_BEMD_NO"/>
		<result property="drugInjcDvsnCd" column="DRUG_INJC_DVSN_CD"/>
		<result property="phdpOrocDprtCd" column="PHDP_OROC_DPRT_CD"/>
		<result property="tkmdCchnYn" column="TKMD_CCHN_YN"/>
		<result property="ihohDvsnCd" column="IHOH_DVSN_CD"/>
		<result property="nrdrYn" column="NRDR_YN"/>
		<result property="psdgYn" column="PSDG_YN"/>
		<result property="clncYn" column="CLNC_YN"/>
		<result property="mdcrYmd" column="MDCR_YMD"/>
		<result property="mdprNm" column="MDPR_NM"/>
		<result property="envlMemoCtn1" column="ENVL_MEMO_CTN_1"/>
		<result property="envlMemoCtn2" column="ENVL_MEMO_CTN_2"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ptntTlno" column="PTNT_TLNO"/>
		<result property="ptntTlno1" column="PTNT_TLNO_1"/>
		<result property="istyCd" column="ISTY_CD"/>
		<result property="istyNm" column="ISTY_NM"/>
		<result property="afiOddrNm" column="AFI_ODDR_NM"/>
		<result property="gndrNm" column="GNDR_NM"/>
		<result property="sbsnMdprAbslDslwYn" column="SBSN_MDPR_ABSL_DSLW_YN"/>
		<result property="userLcnsNo" column="USER_LCNS_NO"/>
		<result property="kpngPlacNm" column="KPNG_PLAC_NM"/>
		<result property="valdHh" column="VALD_HH"/>
		<result property="insrEdiCd" column="INSR_EDI_CD"/>
		<result property="spsdId" column="SPSD_ID"/>
		<result property="scinCdCtn" column="SCIN_CD_CTN"/>
		<result property="scinCdCtn2" column="SCIN_CD_CTN_2"/>
		<result property="clmnNm1" column="CLMN_NM_1"/>
		<result property="scinClncDxNm" column="SCIN_CLNC_DX_NM"/>
		<result property="afiIpdvNm" column="AFI_IPDV_NM"/>
		<result property="ediCd" column="EDI_CD"/>
		<result property="ptntTypeNm2" column="PTNT_TYPE_NM_2"/>
		<result property="afiIstyAsstNm2" column="AFI_ISTY_ASST_NM_2"/>
		<result property="nxtrApntYmd" column="NXTR_APNT_YMD"/>
		<result property="valdYmd" column="VALD_YMD"/>
		<result property="totlQtyClclCd" column="TOTL_QTY_CLCL_CD"/>
		<result property="hgcnKeepEtreCtn" column="HGCN_KEEP_ETRE_CTN"/>
		<result property="afiOnbrDvsnNm" column="AFI_ONBR_DVSN_NM"/>
		<result property="mdtnLcdvCd" column="MDTN_LCDV_CD"/>
		<result property="afiPtqlCnfrNm" column="AFI_PTQL_CNFR_NM"/>
		<result property="afiOrdrAudtDvsnNm" column="AFI_ORDR_AUDT_DVSN_NM"/>
		<result property="scinCd2" column="SCIN_CD_2"/>
		<result property="scinNm2" column="SCIN_NM_2"/>
		<result property="adrsDetlNm" column="ADRS_DETL_NM"/>
		<result property="hicrNo" column="HICR_NO"/>
		<result property="bssyId" column="BSSY_ID"/>
		<result property="afiHimcNm" column="AFI_HIMC_NM"/>
		<result property="afiCntrNm" column="AFI_CNTR_NM"/>
		<result property="ptntTypeCd" column="PTNT_TYPE_CD"/>
		<result property="clmnNm2" column="CLMN_NM_2"/>
		<result property="imagPathNm" column="IMAG_PATH_NM"/>
		<result property="afiPtdvNm" column="AFI_PTDV_NM"/>
		<result property="afiOtdpNm" column="AFI_OTDP_NM"/>
		<result property="clamMdprCd" column="CLAM_MDPR_CD"/>
		<result property="ohprPrinNtm" column="OHPR_PRIN_NTM"/>
		<result property="ptntEnsnNm" column="PTNT_ENSN_NM"/>
		<result property="ptntEnsnLsnm" column="PTNT_ENSN_LSNM"/>
		<result property="usrEnNm" column="USR_EN_NM"/>
		<result property="ensnMdprNm" column="ENSN_MDPR_NM"/>
		<result property="envlMemoCtn3" column="ENVL_MEMO_CTN_3"/>
		<result property="envlMemoCtn4" column="ENVL_MEMO_CTN_4"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="afiInsrIpdvNm" column="AFI_INSR_IPDV_NM"/>
		<result property="adrsDetlNm" column="ADRS_DETL_NM"/>
		<result property="istyCd1" column="ISTY_CD1"/>
		<result property="istyNm1" column="ISTY_NM1"/>
		<result property="istyDtlsCd1" column="ISTY_DTLS_CD1"/>
		<result property="istyDtlsNm1" column="ISTY_DTLS_NM1"/>
		<result property="istyDtlsCd2" column="ISTY_DTLS_CD2"/>
		<result property="istyDtlsNm2" column="ISTY_DTLS_NM2"/>
		<result property="onbrDvsnCd" column="ONBR_DVSN_CD"/>
		<result property="prinYmd" column="PRIN_YMD"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="rcprInsyId" column="RCPR_INSY_ID"/>
		<result property="kornDprtNm" column="KORN_DPRT_NM"/>
		<result property="hsptNm" column="HSPT_NM"/>
		<result property="hsptRprsTlno" column="HSPT_RPRS_TLNO"/>
		<result property="hsptRprsFxno" column="HSPT_RPRS_FXNO"/>
		<result property="abrvDprtNm" column="ABRV_DPRT_NM"/>
		<result property="emailId" column="EMAIL_ID"/>
		<result property="blhsAdrsNm" column="BLHS_ADRS_NM"/>
		<result property="hsptRprsUrlCtn" column="HSPT_RPRS_URL_CTN"/>
		<result property="ptadAstnMcdpCd" column="PTAD_ASTN_MCDP_CD"/>
		<result property="mcdpNm" column="MCDP_NM"/>
		<result property="drlcKindCd" column="DRLC_KIND_CD"/>
		<result property="drlcKindCdCtn" column="DRLC_KIND_CD_CTN"/>
		<result property="afiKornMcdpNm" column="AFI_KORN_MCDP_NM"/>
		<result property="asgnCnpnTlno" column="ASGN_CNPN_TLNO"/>
		<result property="emadNm" column="EMAD_NM"/>
		<result property="ingrNm" column="INGR_NM"/>
		<result property="pwdrResnCtn" column="PWDR_RESN_CTN"/>
		<result property="afiInvnPcunNm" column="AFI_INVN_PCUN_NM"/>
		<result property="subTypeCd" column="SUB_TYPE_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheetForM () 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheetForM-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheetForM"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheetForM-result" useCache="true" flushCache="false">
		 <![CDATA[
		select  /*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-listOutPhdpSheetForM */ 
		        /*+  leading (a d ) sdd_porddet_l92$S01_원외처방전을 조회 */
		             to_char(a.ordr_ymd, 'yyyymmdd') as ORDR_YMD       /* 처방일자             */
		         ,  a.MDTN_NO_DVSN_CD                                   /* 처방형태구분         */
		         ,  a.MDTN_NO                                           /* 투약번호             */
		         ,  d.ORDR_SNO                                          /* 처방번호             */
		         ,  d.MDPR_CD                                           /* 약품코드             */
		         ,  a.PTDV_CD                                           /* 환자구분             */
		         ,  d.MDPR_CLSF_CD                                      /* 약분류               */
		         ,  d.DRAP_DVSN_CD                                      /* 약적용구분           */
		         ,  d.CMMD_STTS_CD                                      /* 조제 STATUS          */
		         ,  d.PCKN_UNAD_QTY                                     /* 투여량(포장)         */
		         ,  d.PCUN_NM                                           /* 단위(포장)           */
		         ,  d.ICUN_ADMN_VLM                                     /* 투여량(함량)         */
		         ,  d.ICUN_CD                                           /* 단위(함량)           */
		         ,  d.SLCT_UNIT_DVSN_CD                                 /* 투여량TYPE           */
		         ,  d.MDTN_DDCN                                         /* 일수                 */
		         ,  d.DRUS_CD                                           /* 용법                 */
		         ,  d.MDNT                                              /* 횟수                 */
		         ,  d.TOTL_CLCL_QTY                                     /* 총량(계산)           */
		         ,  d.INVN_TOTL_QTY                                     /* 총량(재고)           */
		         ,  d.PHDP_CMMD_BNDL_NO                                 /* 약묶음번호           */
		         ,  d.DRBN_NO                                           /* 약묶음번호           */
		         ,  d.MIX_KIND_CD                                       /* MIX종류              */
		         ,  d.BSIS_CMMD_PLAC_CD                                 /* 조제장소             */
		         --,  replace(replace(d.SPSB_CTN, chr(13)||chr(10), ' '), chr(10), ' ') SPSB_CTN /* 특기사항             */
				 ,  trim(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(d.spsb_ctn,'[유사발음]',''),'[유사코드]',''),'[유사외관]',''),'[음식주의]',''),'[고위험]',''),'[고주의]',''),'[냉장]',''),'[차광]',''),'[냉동]',''),'[실온,차광]',''),'[냉장,차광]',''),'[상온,차광]',''),'[기타]',''),'[냉장금기]',''),'[냉장금기,차광]',''),'[출혈주의]','')) SPSB_CTN		/*조제참조*/    --2020-09-07 by kjh 수정
		         ,  d.FDNO_MDPR_CNFR_DT                                 /* 정수품유무           */
		         ,  d.ISDV_CD                                           /* 보험구분(수납시)     */
		         ,  to_char(d.DRUG_ORDR_INPT_DT, 'YYYYMMDDHH24MISS')   DRUG_ORDR_INPT_DT /* 입력일시             */
		         ,  d.SDPF_EXRE_CD                                      /* 의약분업예외사유코드 */
		         ,  d.INJC_PLAC_CD                                      /* 주사장소             */
		         ,  d.OHOR_RTRN_YN                                      /* 원외처방반납여부     */
		         ,  d.BEMD_NO                                           /* 투석실 처방번호      */
		         ,  d.ATTR_NO                                           /* AUTO TRACK번호       */
		         ,  substrb(case
		                when d.DURV_RESN_CTN is not null and h.AGE_TABO_ORRE_CTN is not null then d.DURV_RESN_CTN||',(연령금기)'||h.AGE_TABO_ORRE_CTN
		                when d.DURV_RESN_CTN is not null then d.DURV_RESN_CTN
		                when h.AGE_TABO_ORRE_CTN is not null then '(연령금기)'||h.AGE_TABO_ORRE_CTN
		            end  , 1, 146 )     DURV_RESN_CTN                               /* 상호작용 comment     */
		         ,  a.PTNO                                              /* 환자번호             */
		         ,  to_char(a.RPTN_DT, 'YYYYMMDDHH24MISS') RPTN_DT      /* 접수일시             */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.MCDP_CD),a.MCDP_CD) MCDP_CD /* 진료과               */
		         ,  nvl((select ABRV_DPRT_CD from HZDEPTMMT where DPRT_CD(+)=a.WARD_CD), '*')   WARD_CD    /* 병동                 */
		         ,  h.ODDR_ID                                           /* 처방의(외래,병동)    */
		         ,  decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) GNDR_ID     /* 주치의(병동)         */
		         ,  a.RCPC_YN                                           /* 수납구분             */
		         ,  a.UPDT_BEMD_NO                                      /* 수정전 투약번호      */
		         ,  a.DRUG_INJC_DVSN_CD                                 /* 약주사구분           */
		         ,  a.PHDP_OROC_DPRT_CD                                 /* 처방발생원           */
		         ,  a.TKMD_CCHN_YN                                      /* 복약지도여부         */
		         ,  a.IHOH_DVSN_CD                                      /* 원내외구분           */
		         ,  a.NRDR_YN                                           /* 마약여부             */
		         ,  a.PSDG_YN                                           /* 향정여부             */
		         ,  a.CLNC_YN                                           /* 임상여부             */
		         ,  to_char(a.MDCR_YMD, 'YYYYMMDDHH24MISS')  MDCR_YMD          /* 입원일자(내원일시)   */
		         ,  e.KORN_PDCT_NM        MDPR_NM                              /* 약품명               */
		         ,  f.TKMD_INFT_DRUS_CTN  ENVL_MEMO_CTN_1               /* 봉투1                */
		         ,  '' ENVL_MEMO_CTN_2                                   /* 봉투2                */
		         ,  b.PTNT_NM                                           /* 환자명               */
		         ,  b.FRRN                                              /* 주민번호1            */
		         ,  b.BRRN                                              /* 주민번호2            */
		         ,  trunc(months_between(a.ORDR_YMD, b.BTDT)/12)  AGE_CTN
		         ,  b.GEND_CD                                            /* 성별                 */
		         ,  fn_sd_gethidetelno_s((select z.PTNT_TLNO
		                                           from APPTCNPNV z
		                                          where z.PTNO = b.PTNO
		                                            and CNPN_DVSN_CD = 'BH'
		                                               and CNPN_SNO = 1
		                                               and rownum = 1))  PTNT_TLNO                  /* 전화번호(집)         */
		         ,  fn_sd_gethidetelno_s((select z.PTNT_TLNO
		                                           from APPTCNPNV z
		                                          where z.PTNO = b.PTNO
		                                            and CNPN_DVSN_CD = 'BP'
		                                            and CNPN_SNO = 1
		                                            and rownum = 1))   PTNT_TLNO_1               /* 전화번호(핸드폰)     */
		         ,  case when ( (#{mcclWorkPrkyVl} is not null)
		                        and (h.CODV_CD not in ('D','I')) ) then
		                                                                (
		                                                                 select ac1.ISTY_CD
		                                                                   from ACCLMCCTT ac1
		                                                                  where ac1.PTNO = h.PTNO
		                                                                    and ac1.ORDR_YMD = h.ORDR_YMD
		                                                                    and ac1.ORDR_SNO = h.ORDR_SNO
		                                                                    and ac1.MCCL_WORK_PRKY_VL = #{mcclWorkPrkyVl}  /*수납 전 계산상태 데이터. */
		                                                                    and ac1.CODV_CD in ('O', 'H', 'E')
		                                                                    and ac1.ORTA_NM = 'MDMEDORDT'
		                                                                    and nvl(ac1.CNCL_DT,to_date('29991231','yyyymmdd')) = to_date('29991231','yyyymmdd')
		                                                                    and rownum = 1
		                                                                )
		                 else h.ISTY_CD
		            end   ISTY_CD   /* 급여종별코드         */
		         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                from CCCMCDDMT A, CCCMCDDLT B
		               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                 and A.COMN_GRP_CD  = 'AI003'
		                 and A.COMN_DTLS_CD = h.ISTY_CD
		                 and B.LNGG_CD(+) = nvl( '', '*') )  ISTY_NM           /* 급여종별이름         */
		         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = h.ODDR_ID ) AFI_ODDR_NM                   /* 처방의(외래,병동)    */
		         ,  ( select  USER_NM from CCUSRDPHT where   USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) ) GNDR_NM /* 주치의(병동)         */
		         ,  ''                 sbsn_mdpr_absl_dslw_yn             /* 대체약품절대불가     */
		         ,  g2.USER_LCNS_NO    user_lcns_no                       /* 면허번호             */
		         ,  ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                from CCCMCDDMT A, CCCMCDDLT B
		               where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                 and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                 and A.COMN_GRP_CD = 'SD003'
		                 and A.COMN_DTLS_CD = e.KPNG_PLAC_CD
		                 and B.LNGG_CD(+) = nvl( '', '*') )      KPNG_PLAC_NM  /* 보관장소             */
		         ,  0 VALD_HH -- e.VALD_HH                                             /* 유효시간             */
		         ,  i.INSR_EDI_CD                                         /* EDI 코드             */
		         ,  subStr(fn_sd_getvcode_s(h.ISTY_ASST_CD, a.ORDR_YMD), 1, 4)   SPSD_ID 
		         ,  (select  
		                   max(max(decode(decode(t.MAIN_SCIN_YN, 'Y', 0, rownum), 0, decode(t.SCIN_CD, u.SCIN_STST_CD, t.SCIN_CD, u.SCIN_STST_CD), '')))||
		                   max(max(decode(decode(t.MAIN_SCIN_YN, 'Y', 0, rownum), 1, ' '||decode(t.SCIN_CD, u.SCIN_STST_CD, t.SCIN_CD, u.SCIN_STST_CD), '')))||
		                   max(max(decode(decode(t.MAIN_SCIN_YN, 'Y', 0, rownum), 2, ' '||decode(t.SCIN_CD, u.SCIN_STST_CD, t.SCIN_CD, u.SCIN_STST_CD), '')))||
		                   max(max(decode(decode(t.MAIN_SCIN_YN, 'Y', 0, rownum), 3, ' '||decode(t.SCIN_CD, u.SCIN_STST_CD, t.SCIN_CD, u.SCIN_STST_CD), '')))||
		                   max(max(decode(decode(t.MAIN_SCIN_YN, 'Y', 0, rownum), 4, ' '||decode(t.SCIN_CD, u.SCIN_STST_CD, t.SCIN_CD, u.SCIN_STST_CD), '')))||
		                   max(max(decode(decode(t.MAIN_SCIN_YN, 'Y', 0, rownum), 5, ' '||decode(t.SCIN_CD, u.SCIN_STST_CD, t.SCIN_CD, u.SCIN_STST_CD), '')))||
		                   max(max(decode(decode(t.MAIN_SCIN_YN, 'Y', 0, rownum), 6, ' '||decode(t.SCIN_CD, u.SCIN_STST_CD, t.SCIN_CD, u.SCIN_STST_CD), '')))
		                   SCIN_CD_CTN
		               from
		                   (
		                    select
		                          x.MAIN_SCIN_YN
		                       ,  x.SCIN_CD
		                       ,  y.MDCR_DT
		                      from
		                          MDPADIAGT x
		                       ,  APRCRPTNT y
		                       ,  MDMEDORDT z
		                     where
		                          z.PTNO   = d.ptno
		                     and  z.ORDR_YMD = d.ordr_Ymd
		                     and  z.ORDR_SNO = d.ordr_Sno
		                     and  x.MDRP_NO = y.MDRP_NO
		                     and  x.MDRP_NO = z.MDRP_NO
		                     and  x.MCDP_CD = (select DPRT_CD from HZDEPTMMT where dprt_cd= h.mcdp_Cd and USE_YN='Y' and rownum < 2)
		                    /* and  h.gndr_Id = decode( d.ptdv_Cd, 'O', x.CHDR_ID , h.gndr_Id )       MultiMainDiag  */
		                  )  t
		                 ,  MRBSSCINT u
		             where
		                  u.SCIN_CD(+) = t.SCIN_CD
		            and  t.MDCR_DT between u.APLY_YMD(+) and u.FNSH_YMD(+) + 0.99999
		            group  by
		                decode(t.MAIN_SCIN_YN,'Y',0,rownum),
		                 t.SCIN_CD)     SCIN_CD_CTN     -- 상병코드 한 줄로 표시                  /* 상병코드             */
		         ,  ''     SCIN_CD_CTN_2   -- qr코드용 상병 한 줄로 표시             /* QR코드용 상병        */
		         ,  ''     CLMN_NM_1                                                 /* 컬럼명1            */
		         ,  h.HGCN_KEEP_ETRE_CTN        SCIN_CLNC_DX_NM                      /* 상병명,  2007.07.16 여기서는 고함량유지 특기사항            */
		         ,  ''   AFI_IPDV_NM                                                 /* 계산내역급여구분     */
		         ,  ''   EDI_CD                                                      /* 계산내역EDI코드      */
		         ,  ''   PTNT_TYPE_NM_2                                              /* 계산내역환자유형     */
		         ,  ''   AFI_ISTY_ASST_NM_2                                          /* 계산내역유형보조     */
		         ,  ''   NXTR_APNT_YMD   /*        해당진료과의 다음예약일자               * 외국인코드           */
		         ,  fn_sd_getnextday_s(to_char(a.ordr_ymd, 'yyyymmdd'))  VALD_YMD
		         ,  e.TOTL_QTY_CLCL_CD   /* 총량계산코드  vald_ymd와 분리  */
		         ,  h.HGCN_KEEP_RESN_CD||' '
		                || ( select nvl(B.DETL_CD_NM, A.DETL_CD_NM)
		                       from CCCMCDDMT A, CCCMCDDLT B
		                      where A.COMN_GRP_CD = B.COMN_GRP_CD(+)
		                        and A.COMN_DTLS_CD = B.COMN_DTLS_CD(+)
		                        and A.COMN_GRP_CD = 'MM105'
		                        and A.COMN_DTLS_CD = h.HGCN_KEEP_RESN_CD
		                        and B.LNGG_CD(+) = nvl( '', '*') )   HGCN_KEEP_ETRE_CTN
		         ,  '' AFI_ONBR_DVSN_NM                                 /* 본인부담코드 */
		         ,  a.MDTN_LCDV_CD                                      /* 투약위치              */
		         ,  ''  AFI_PTQL_CNFR_NM                                /* 환자자격구분명 */
		         ,  fn_sd_getoprtyntext_s( a.PTNO, a.ORDR_YMD, a.MDTN_NO_DVSN_CD, a.MDTN_NO, a.MDTN_LCDV_CD, a.MCDP_CD ) AFI_ORDR_AUDT_DVSN_NM   
		         ,  ''  SCIN_CD_2                                       /* 본인부담율인상 상병코드 */
		         ,  ''    SCIN_NM_2                                     /* 본인부담율인상 상병명   */
		         ,  decode(a.NRDR_YN, 'Y', n.ZPAD_NM||' '||n.DEAD_NM, '') ADRS_DETL_NM      /* 주소(마약있을때만) */
		         ,  ''   HICR_NO                                        /* 증번호                  */
		         ,  ''    BSSY_ID                                       /* 조합기호                */
		         ,  m.PTAD_ASTN_MCDP_CD   AFI_HIMC_NM                   /* EDI 진료과목            */
		         ,  (select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD=a.MCCN_CD)      AFI_CNTR_NM                       /* 센터명                  */
		         ,  ''  PTNT_TYPE_CD   --sPattyp_imsi
		         ,  '' CLMN_NM_2
		         ,  '' imag_path_nm
		         ,  decode( a.PTDV_CD  , 'O','외래', 'H', '가정간호', 'G', '건강의학', 'E', '응급실', 'D', 'DSC', 'I', '병동', a.PTDV_CD)  AFI_PTDV_NM
		         ,  ''                    AFI_OTDP_NM
		         ,  ''                    CLAM_MDPR_CD
		         ,  a.OHPR_PRIN_NTM       OHPR_PRIN_NTM
		         ,  b.PTNT_ENSN_NM        PTNT_ENSN_NM
		         ,  b.PTNT_ENSN_LSNM      PTNT_ENSN_LSNM
		         ,  ( select  USER_ENSN_NM from CCUSRDPHT where   USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, a.GNDR_ID), a.GNDR_ID) ) USR_EN_NM /* 주치의(병동) - 영문        */
		         ,  e.MDPR_NM             ENSN_MDPR_NM
		         ,  f.ENVL_MEMO_CTN3      ENVL_MEMO_CTN_3                              /* 봉투3                */
		         ,  f.ENVL_MEMO_CTN4      ENVL_MEMO_CTN_4                              /* 봉투4                */
		         ,	m.KORN_DPRT_NM		  KORN_DPRT_NM							        /* 한글진료과명				 */
				 , ( select decode(h.ORDR_IPDV_CD, '3', nvl((select DETL_CD_NM from CCCMCDDMT where 1=1 and comn_grp_cd = 'AIA_032' and COMN_DTLS_CD = i.SCRG_INPY_ONBR_RT), decode(F_A.COMN_DTLS_CD, '1', '1:', '2', '2:', '7' ,'3:','4','4:','5','5:','A','Z:','' ) || nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM))
		                  , nvl(
							     (select decode(aa.COMN_DTLS_CD,'7','3','A','Z',aa.COMN_DTLS_CD) ||':' || nvl(bb.DETL_CD_NM, aa.DETL_CD_NM)
		                            from CCCMCDDMT aa
		                               , CCCMCDDLT bb
		                           where 1=1
		                             and aa.COMN_GRP_CD  = 'AI041'
		                             and aa.COMN_GRP_CD  = bb.COMN_GRP_CD(+)
			                         and aa.COMN_DTLS_CD = bb.COMN_DTLS_CD(+)
			                         and aa.COMN_DTLS_CD  = nvl(s.IPDV_CD,h.ORDR_IPDV_CD) /* 처방상급여정보 */
			                         and rownum = 1
			                      )
						     /* 처방상에 보헙급여코드가 없으면 수가마스터정보상의 급여정보를 보여줌 */
							, decode(F_A.COMN_DTLS_CD, '1', '1:', '2', '2:', '7' ,'3:','4','4:','5','5:','A','Z:','' ) || nvl(F_B.DETL_CD_NM, F_A.DETL_CD_NM) )
					)
					  from CCCMCDDMT F_A,
						   CCCMCDDLT F_B
				     where  F_A.COMN_GRP_CD  = F_B.COMN_GRP_CD(+)
					   and F_A.COMN_DTLS_CD = F_B.COMN_DTLS_CD(+)
					   and F_A.COMN_GRP_CD  = 'AI041'
					   and F_A.COMN_DTLS_CD =  nvl(s.IPDV_CD,h.ORDR_IPDV_CD)  
					   and F_B.LNGG_CD(+) = nvl('', '*')) as AFI_INSR_IPDV_NM  /*보험,선별급여 2020-06-11 by kjh*/  /* 급여 바코드구분을 위해 쿼리 수정 //ocs 에선 무조건 나머지 그외는 급여로 리턴 By..lsw */
		         /* 모바일 IF로 인해 추가된 항목 */
		         ,  n.ZPAD_NM||' '||n.DEAD_NM  as  ADRS_DETL_NM     /* 환자 주소 */			
		         ,  decode( nvl(h.ISTY_CD , q.ISTY_CD), '80', 'H', '90', 'G', decode(substr(nvl(h.ISTY_CD , q.ISTY_CD), 1, 1),'1','H','2','M','3','I','5','S',''))  as ISTY_CD1 /* 보험유형코드(1)  H:건강, I:산재, S:자보, M:의료급여, G:일반 */
		         ,  decode(nvl(h.ISTY_CD , q.ISTY_CD), '80', '건강보험', '90', '기타', decode(substr(nvl(h.ISTY_CD , q.ISTY_CD), 1, 1),'1','건강보험','2','의료보호','3','산업재해','5','자동차보험',''))  as ISTY_NM1 /* 보험유형코드(1)  H:건강, I:산재, S:자보, M:의료급여, G:일반 */ 
		         ,  decode( nvl(h.ISTY_CD , q.ISTY_CD), '12', 'C', '13', 'E', '14', 'F', '') as ISTY_DTLS_CD1
		         ,  decode(nvl(h.ISTY_CD , q.ISTY_CD), '12', '차상위', '13', '차상위 만성', '14', '장애인', '') as ISTY_DTLS_NM1
		         ,  decode( nvl(h.ISTY_CD , q.ISTY_CD), '21', '1', '22', '2', '23', '2', '') as ISTY_DTLS_CD2           /* 보호종별 */
		         ,  decode(nvl(h.ISTY_CD , q.ISTY_CD), '21', '1', '22', '2', '23', '2', '') as ISTY_DTLS_NM2   /* 처방전 표시 보험세부 이름 */  
		         ,  ''   as ONBR_DVSN_CD             /* 본인부담구분코드(M015) */      
		         ,  to_char(p.PRIN_DT,'YYYYMMDD')  as PRIN_YMD            /* 처방전교부일자(20181212) */
		         ,  to_char(p.PRIN_DT,'YYYYMMDDhh24mi')  as PRIN_DT       /* 처방전발급시각(201812120359) */
		         ,  o.RCPR_INSY_ID       as RCPR_INSY_ID           /* 병원 번호 */
		        ,  (select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD=a.MCCN_CD)   as KORN_DPRT_NM                /* 센터명 */
		        ,  o.HSPT_NM            as HSPT_NM                /* 병원명 */
		        ,  o.RPRS_TLNO          as HSPT_RPRS_TLNO              /* 병원전화번호 */
		        ,  ''                   as HSPT_RPRS_FXNO               /* 병원팩스번호 */
		        ,  o.HSPT_NM            as ABRV_DPRT_NM              /* 병원명 약칭 */
		        ,  ''                   as EMAIL_ID              /* 병원 이메일 */
		        ,  o.ZPAD_NM || ' ' ||o.DEAD_NM      as BLHS_ADRS_NM              /* 병원주소 */
		        ,  o.HSPT_RPRS_URL_CTN               as HSPT_RPRS_URL_CTN             /* 병원홈페이지 */
		        ,  m.PTAD_ASTN_MCDP_CD             as PTAD_ASTN_MCDP_CD                   /* EDI 진료과목            */
		        ,  nvl((select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD(+)=a.MCDP_CD),a.MCDP_CD) as MCDP_NM     /* 진료과명 */
		        ,  '1'                as DRLC_KIND_CD           /* 의사면허종별(1:의사) */
		        ,  '의사'               as DRLC_KIND_CD_CTN           /* 의사면허종별명(의사) */
		        ,  nvl((select KORN_DPRT_NM from HZDEPTMMT where DPRT_CD(+)=a.MCDP_CD),a.MCDP_CD) as AFI_KORN_MCDP_NM     /* 의사진료과명 */
		        ,  ''                 as ASGN_CNPN_TLNO                      /* 의사전화번호 */
		        ,  ''                 as EMAD_NM                    /* 의사이메일 */
		        , e.ingr_nm as INGR_NM
		        , LISTAGG(decode(d.mix_kind_cd , '2' , 'Y' , 'N'), '') WITHIN GROUP (ORDER BY d.ordr_ymd, d.mdtn_no) OVER(PARTITION BY d.ordr_ymd, d.mdtn_no_dvsn_cd, d.mdtn_no) as PWDR_RESN_CTN
		        ,  decode(e.DGFR_CD,'BTL','1','PKG','1','0') as AFI_INVN_PCUN_NM  /* 포장구분 1:병팩단위, 0:그외약품 */  
		        /* 모바일 IF로 인해 추가된 항목 */
		        ,  h.SUB_TYPE_CD  /* 원무v코드에 따른 해당 구분자로 원외처방전 분리여부 결정*/
		      from
		            SDPORDBAT a
		         ,  APPTPTNTV b
		         ,  SDPORDDET d
		         ,  SDDDGCDMT e
		         ,  SDDMETCDT f
		         ,  CCUSRDPHT g
		         ,  CCUSERAMV g2
		         ,  MDMEDORDT h
		         ,  AIMFMDFET i
		         ,  MNEERRPAT k
		         ,  HZDEPTMMT m
		         ,  APPTADRSV n
		         /* 모바일 IF로 인해 추가된 항목 */
		         ,  CCCHOSPMT o
		         ,  SDPOPRINT p
		         /* 모바일 IF로 인해 추가된 항목 */
		         ,  aprcrptnt q
		         ,  AIMFMDFET r       
		         ,  ACCLMCCLT s
		     where  1=1
		]]>
		       <choose>
		       	<when test='ordrYmd != "" and ordrYmd != null'>
		 <![CDATA[
		       and  a.ORDR_YMD = to_date(#{ordrYmd}, 'YYYYMMDD')
		]]>
		       	</when> 
		       	<when test='ordrYmd == "" or ordrYmd == null'>
		 <![CDATA[
		       and  a.ORDR_YMD >= add_months(sysdate, -6) /* 처방일자             */
		       and  a.ORDR_YMD <= sysdate /* 처방일자             */
		]]>
		       	</when>       
		       </choose>
		 <![CDATA[
		       and  a.ptno = #{ptno}
		       and  a.MDTN_NO_DVSN_CD = 'K'           /* 처방형태구분         */
		       and  a.MDTN_NO between decode(#{mdtnNo1} , 0 , a.mdtn_no , #{mdtnNo1})         /* 투약번호             */
		                          and decode(#{mdtnNo2} , 0 , a.mdtn_no , #{mdtnNo2})         /* 투약번호             */
		       and  a.MDTN_LCDV_CD = 'M' /* 투약위치 */
		       and  b.PTNO  = a.PTNO                            /* 환자번호             */
		       and  d.ORDR_YMD        = a.ORDR_YMD              /* 처방일자             */
		       and  d.MDTN_NO_DVSN_CD = a.MDTN_NO_DVSN_CD       /* 투약번호구분         */
		       and  d.MDTN_NO         = a.MDTN_NO               /* 투약번호             */
		       and  d.MDTN_LCDV_CD    = a.MDTN_LCDV_CD          /* 투약위치             */
		       and  d.CMMD_STTS_CD not in ('7', '8')            /* 진도                 */
		       and  nvl(d.OHOR_RTRN_YN, 'N') <> 'Y'             /* 반납처방제외         */
		       and  e.MDPR_CD = d.MDPR_CD                       /* 약품코드             */
		       and  f.DRUS_CD = d.DRUS_CD                       /* 용법                 */
		       and  g.USER_ID = decode(a.PTDV_CD, 'E', nvl(k.DSCH_ITDR_ID, h.ODDR_ID), h.ODDR_ID)    /* 처방의(외래,병동)    */
		       and  g2.LGIN_ID = g.LGIN_ID
		       and  h.MDRP_NO = decode(#{mdrpNo} , 0 , h.MDRP_NO, nvl(#{mdrpNo} , h.MDRP_NO))
		       and  h.PTNO     = a.PTNO
		       and  h.ORDR_YMD = a.ORDR_YMD
		       and  h.ORDR_SNO = d.ORDR_SNO
		       and  h.ORDR_SNO = d.ORDR_SNO
		       and  nvl(h.DC_DVSN_CD, 'N') != 'X'
		       and  i.MDFE_CD  (+)  = d.MDPR_CD
		       and  i.APST_YMD (+) <= d.ORDR_YMD
		       and  i.APFN_YMD (+) >= d.ORDR_YMD
		       and  k.PTNO   (+) = a.PTNO                       /* 환자번호             */
		       and  k.COHS_DT(+) = a.MDCR_YMD                   /* 내원일시             */
		       and  m.DPRT_CD = a.MCDP_CD
		       and  n.PTNO         (+) = a.PTNO
		       and  n.ADRS_USGE_CD (+) = 'A'
		       and  n.ADRS_SNO     (+) = 1
		       /* 모바일 IF로 인해 추가된 항목 */
		       and  (o.APST_YMD < sysdate  and  o.APFN_YMD >= trunc(sysdate))
		       and  p.ORDR_YMD  (+) = a.ORDR_YMD
		       and  p.MDTN_NO_DVSN_CD (+) = a.MDTN_NO_DVSN_CD 
		       and  p.MDTN_LCDV_CD (+) = a.MDTN_LCDV_CD
		       and  p.MDTN_NO   (+) = a.MDTN_NO
		       and  p.PRIN_SNO (+) = 1
		       /* 모바일 IF로 인해 추가된 항목 */
		       and  q.MDRP_NO = h.MDRP_NO
		       and  r.MDFE_CD = h.ORDR_CD
		       and  nvl(h.ORDR_YMD,sysdate) between r.APST_YMD
		                                        and r.APFN_YMD      
		       and  s.PTNO      (+) = h.PTNO
		       and  s.ORDR_YMD  (+) = h.ORDR_YMD
		       and  s.ORDR_SNO  (+) = h.ORDR_SNO
		       and  s.MDFE_CD   (+) = h.ORDR_CD 
		       and  s.IHOH_ORDV_CD (+) ='O'                                       
		       and  s.CNCL_DT   (+) is null
		     order
		        by
		            a.ORDR_YMD
		          , a.MDTN_NO
				  , decode(d.DRAP_DVSN_CD, '1', '1', '3', '2', '2','3','4')
				  , d.DRUS_CD
				  , d.PHDP_CMMD_BNDL_NO
				  , a.MDTN_NO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIncsQlfcInfm-result" type="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO">
	
		<result property="dsstOcrnAcdnYmd" column="DSST_OCRN_ACDN_YMD"/>
		<result property="incsMdanId" column="INCS_MDAN_ID"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIncsQlfcInfm (산재자격정보조회) 
        Description :                       
		parameterType : com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO
		resultMap : com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIncsQlfcInfm-result
    -->
	<select id="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIncsQlfcInfm"  parameterType="com.sds.healthcare.ehr.sup.sd.sdp.vo.SdpCmmdDetlComnDVO"  resultMap="com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIncsQlfcInfm-result" useCache="true" flushCache="false">
		<![CDATA[
		select  /*SQL_ID: com-sds-healthcare-ehr-sup-sd-sdp-dao-SdpCmmdDetlComnDAO-selectOneIncsQlfcInfm */
		        to_char(a.DSST_OCRN_ACDN_YMD,'yyyymmdd')        as DSST_OCRN_ACDN_YMD
		     ,  (select x.INCS_MDAN_ID
		           from CCCHOSPMT x
		          where to_date(#{ordrYmd},'yyyymmdd') between x.APST_YMD
		                                                   and x.APFN_YMD
		            and rownum = 1)                             as INCS_MDAN_ID
		  from  (
		        select  a.DSST_OCRN_ACDN_YMD
		          from  APQLINCST a
		         where  a.PTNO = #{ptno}
		           and  a.DSST_OCRN_ACDN_YMD <= to_date(#{ordrYmd},'yyyymmdd')
		         order  by
		                a.DSST_OCRN_ACDN_YMD desc
		        ) a
		 where  rownum < 2
		]]>
	</select>



</mapper>