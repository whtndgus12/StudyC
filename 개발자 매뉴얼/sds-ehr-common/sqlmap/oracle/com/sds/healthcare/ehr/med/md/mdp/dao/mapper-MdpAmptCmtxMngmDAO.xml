<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : mapper_MdpAmptCmtxMngmDAO_sql.xml 
    Description :                                      병동협진관리
                  -->
<mapper namespace="MdpAmptCmtxMngmDAO">




    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-insertAmptCmtx (병동협진 입력) 
        Description :                                           병동협진 입력
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
    -->	
	<insert id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-insertAmptCmtx"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  >
		<![CDATA[
			/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-insertAmptCmtx */
			INSERT  /*+ MdpAmptCmtxMngmDAO-insertAmptCmtx_병동협진입력 */
			  into  MDCONSRCT
			        (
			        PTNO                            /* 환자번호 */
			     ,  ORDR_YMD                        /* 처방일자 */
			     ,  ORDR_SNO                        /* 처방일련번호 */
			     ,  MDRP_NO                         /* 진료접수번호 */
			     ,  PTAD_MDRP_NO                    /* 원무진료접수번호 */
			     ,  CODV_CD                         /* 내원구분코드 */
			     ,  PTAD_CODV_CD                    /* 원무내원구분코드 */
			     ,  OROC_DPRT_CD                    /* 처방발생원코드 */
			     ,  MCDP_CD                         /* 진료과코드 */
			     ,  WARD_CD                         /* 병동코드 */
			     ,  CHDR_ID                         /* 지정의사ID */
			     ,  GNDR_ID                         /* 주치의사ID */
			     ,  CMTX_DVSN_CD                    /* 협진구분코드 */
			     ,  ORDR_CD                         /* 처방코드 */
			     ,  ODDR_ID                         /* 처방의사ID */
			     ,  ODDR_MCDP_CD                    /* 처방의사진료과코드 */
			     ,  CMTX_REFR_CTN                   /* 협진의뢰내용 */
			     ,  WNTD_DR_ID                      /* 희망의사ID */
			     ,  WNTD_DR_MCDP_CD                 /* 희망의사진료과코드 */
			     ,  CMTX_RPLY_CTN                   /* 협진회신내용 */
			     ,  ER_YN                           /* 응급여부 */
			     ,  PTAD_CLBA_YMD                   /* 원무계산기준일자 */
			     ,  CLRS_PRJC_CD                    /* 임상연구과제코드 */
			     ,  CLRS_PRJC_DR_ID                 /* 임상연구과제의사ID */
			     ,  INFM_DMND_TMLM_DVSN_CD          /* 정보요구시한구분코드 */
			     ,  DGTK_REAS_CTN                   /* 약물복용이유내용 */
			     ,  DX_NM                           /* 진단명 */
			     ,  DRUG_PRVC_CTN                   /* 약출처내용 */
			     ,  RTRN_STTS_CD                    /* 반납상태코드 */
			     ,  RTRN_RQST_DT                    /* 반납요청일시 */
			     ,  RTRN_RQPR_ID                    /* 반납요청자ID */
			     ,  RPTN_DT                         /* 접수일시 */
			     ,  CMTX_MDPR_RMRK_CTN              /* 협진약품비고내용 */
			     ,  CMTX_STTS_CD                    /* 협진상태코드 */
			     ,  CMTX_STTS_DT                    /* 협진상태일시 */
			     ,  RPLY_ALRM_DVSN_CD               /* 회신알람구분코드 */
			     ,  ER_RESN_CD                      /* 응급사유코드 */
			     ,  HSLC_DVSN_CD                    /* 병원위치구분코드 */
			     ,  MCCN_CD                         /* 진료센터코드 */
			     ,  REFR_XML_BD                     /* 의뢰XML자료 */
			     ,  REFR_FORM_NO                    /* 의뢰서식번호 */
			     ,  WNTD_SCTN_CD                    /* 희망섹션코드 */
			     ,  DLTN_YN                         /* 삭제여부 */
			     ,  CNCL_YN                         /* 취소여부 */
			     ,  LNKN_ORDR_CLTY_CD               /* 연결처방분류유형코드 */
			     ,  LNKN_ORDR_YMD                   /* 연결처방일자 */
			     ,  LNKN_ORDR_SNO                   /* 연결처방일련번호 */
		         ,  CHFR_YN                         /* 무료여부*/
		         ,  CLCL_EXCL_YN                    /* 계산제외여부(지원부서 협진 사용 용도)*/
			     ,  FRST_RGSR_ID                    /* 최초등록자ID */
			     ,  FRST_RGST_IP                    /* 최초등록IP */
			     ,  FRST_RGST_DT                    /* 최초등록일시 */
			     ,  FRST_RGST_CLNT_PRGM_ID          /* 최초등록SMC클라이언트프로그램ID */
			     ,  FRST_RGST_SRVR_PRGM_ID          /* 최초등록SMC서버프로그램ID */
			     ,  LAST_UPDR_ID                    /* 최종수정자ID */
			     ,  LAST_UPDT_IP                    /* 최종수정IP */
			     ,  LAST_UPDT_DT                    /* 최종수정일시 */
			     ,  LAST_UPDT_CLNT_PRGM_ID          /* 최종수정SMC클라이언트프로그램ID */
			     ,  LAST_UPDT_SRVR_PRGM_ID          /* 최종수정SMC서버프로그램ID */
			     ,  WNTD_DT                         /* 희망일자 */
			        )
			values  (
			        #{ptno}                                                             /* 환자번호 */
			     ,  to_date(#{ordrYmd}, 'yyyymmdd')                                     /* 처방일자 */
			     ,  #{ordrSno}                                                          /* 처방일련번호 */
			     ,  #{mdrpNo}                                                           /* 진료접수번호 */
			     ,  #{mdrpNo}                                                           /* 원무진료접수번호 */
			     ,  #{codvCd}                                                           /* 내원구분코드 */
			     ,  #{ptadCodvCd}                                                       /* 원무내원구분코드 */
			     ,  #{orocDprtCd}                                                       /* 처방발생원코드 */
			     ,  #{mcdpCd}                                                           /* 진료과코드 */
			     ,  #{wardCd}                                                           /* 병동코드 */
			     ,  #{chdrId}                                                           /* 지정의사ID */
			     ,  #{gndrId}                                                           /* 주치의사ID */
			     ,  #{cmtxDvsnCd}                                                       /* 협진구분코드 */
			     ,  #{ordrCd}                                                           /* 처방코드 */
			     ,  #{oddrId}                                                           /* 처방의사ID */
			     ,  #{oddrMcdpCd}                                                       /* 처방의사진료과코드 */
			     ,  #{cmtxRefrCtn}                                                      /* 협진의뢰내용 */
			     ,  #{wntdDrId}                                                         /* 희망의사ID */
			     ,  #{wntdDrMcdpCd}                                                     /* 희망의사진료과코드 */
			     ,  #{cmtxRplyCtn}                                                      /* 협진회신내용 */
			     ,  #{erYn}                                                             /* 응급여부 */
			     ,  (select MDCR_DT from APRCRPTNT where MDRP_NO = #{mdrpNo})           /* 원무계산기준일자 */
			     ,  #{clrsPrjcCd}                                                       /* 임상연구과제코드 */
			     ,  #{clrsPrjcDrId}                                                     /* 임상연구과제의사ID */
			     ,  #{infmDmndTmlmDvsnCd}                                               /* 정보요구시한구분코드 */
			     ,  #{dgtkReasCtn}                                                      /* 약물복용이유내용 */
			     ,  #{dxNm}                                                             /* 진단명 */
			     ,  #{drugPrvcCtn}                                                      /* 약출처내용 */
			     ,  #{rtrnSttsCd}                                                       /* 반납상태코드 */
			     ,  to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')                          /* 반납요청일시 */
			     ,  #{rtrnRqprId}                                                       /* 반납요청자ID */
			     ,  to_date(#{rptnDt}, 'yyyymmddhh24miss')                              /* 접수일시 */
			     ,  #{cmtxMdprRmrkCtn}                                                  /* 협진약품비고내용 */
			     ,  #{cmtxSttsCd}                                                       /* 협진상태코드 */
			     ,  sysdate                                                             /* 협진상태일시 */
			     ,  #{rplyAlrmDvsnCd}                                                   /* 회신알람구분코드 */
			     ,  #{erResnCd}                                                         /* 응급사유코드 */
			     ,  #{hslcDvsnCd}                                                       /* 병원위치구분코드 */
			     ,  #{mccnCd}                                                           /* 진료센터코드 */
			     ,  #{refrXmlBdByte}                                                    /* 의뢰XML자료 */
			     ,  #{refrFormNo}                                                       /* 의뢰서식번호 */
			     ,  #{wntdSctnCd}                                                       /* 희망섹션코드 */
			     ,  'N'                                                                 /* 삭제여부 */
			     ,  'N'                                                                 /* 취소여부 */
			     ,  #{lnknOrdrCltyCd}                                                   /* 연결처방분류유형코드 */
			     ,  to_date(#{lnknOrdrYmd}, 'yyyymmdd')                                 /* 연결처방일자 */
			     ,  #{lnknOrdrSno}                                                      /* 연결처방일련번호 */
		         ,  #{chfrYn}                                                           /* 무료여부*/
		         ,  #{clclExclYn}                                                       /* 계산제외여부(지원부서 협진 사용 용도)*/
			     ,  #{gvUserId}
			     ,  #{gvUserIp}
			     ,  sysdate
			     ,  #{gvClntPrgmId}
			     ,  #{gvSrvrPrgmId}
			     ,  #{gvUserId}
			     ,  #{gvUserIp}
			     ,  sysdate
			     ,  #{gvClntPrgmId}
			     ,  #{gvSrvrPrgmId}
			     ,  to_date(#{wntdDt}, 'yyyymmdd')
			        )
			]]>
	</insert>




    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateAmptCmtxRefr (병동협진의뢰 수정) 
        Description :                                           병동협진의뢰 수정
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateAmptCmtxRefr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateAmptCmtxRefr */
		UPDATE  /*+ MdpAmptCmtxMngmDAO-updateAmptCmtxRefr_병동협진의뢰 수정 */
		        MDCONSRCT
		   set  LAST_UPDR_ID            =   #{gvUserId}
		     ,  LAST_UPDT_IP            =   #{gvUserIp}
		     ,  LAST_UPDT_DT            =   sysdate
		     ,  LAST_UPDT_CLNT_PRGM_ID  =   #{gvClntPrgmId}
		     ,  LAST_UPDT_SRVR_PRGM_ID  =   #{gvSrvrPrgmId}
		/* 0 → 1   임시저장 → 입력완료 시 */
		 <if test='codvCd != null'>
		     ,  CODV_CD                 =   #{codvCd}                               /* 환자구분 */
		 </if>
		 <if test='ptadCodvCd != null'>
		     ,  PTAD_CODV_CD            =   #{ptadCodvCd}                           /* 원무환자구분 */
		 </if>
		 <if test='mcdpCd != null'>
		     ,  OROC_DPRT_CD            =   #{orocDprtCd}                           /* 처방발생원 */
		 </if>
		 <if test='mcdpCd != null'>
		     ,  MCDP_CD                 =   #{mcdpCd}                               /* 진료과 */
		 </if>
		 <if test='wardCd != null'>
		     ,  WARD_CD                 =   #{wardCd}                               /* 병동 */
		 </if>
		 <if test='chdrId != null'>
		     ,  CHDR_ID                 =   #{chdrId}                               /* 주치의사 */
		 </if>
		 <if test='gndrId != null'>
		     ,  GNDR_ID                 =   #{gndrId}                               /* 담당의사 */
		 </if>
		 <if test='oddrMcdpCd != null'>
		     ,  ODDR_MCDP_CD            =   #{oddrMcdpCd}                           /* 처방의사진료과(의뢰의사진료과) */
		 </if>
		 <if test='oddrId != null'>
		     ,  ODDR_ID                 =   #{oddrId}                               /* 처방의사(의뢰의사) */
		 </if>
		/* 1 → 2    의뢰확인 (전달확인) */
		 <if test='dlivId != null'>
		     ,  DLIV_ID                 =   #{dlivId}                               /* 전달자ID */
		 </if>
		 <if test='dlivCnfrDt != null'>
		     ,  DLIV_CNFR_DT            =   to_date(#{dlivCnfrDt}, 'yyyymmddhh24miss')  /* 전달자확인일시 */
		 </if>
		/* 1 → 1    의뢰수정 */
		 <if test='ordrCd != null'>
		     ,  ORDR_CD                 =   #{ordrCd}                               /* 처방코드 */
		 </if>
		 <if test='wntdDrId != null'>
		     ,  WNTD_DR_ID              =   #{wntdDrId}                             /* 희망의사ID*/
		 </if>
		 <if test='wntdDrMcdpCd != null'>
		     ,  WNTD_DR_MCDP_CD   =   #{wntdDrMcdpCd}                    /* 희망의사희망의사진료과코드 */
		 </if>
		 <if test='erYn != null'>
		     ,  ER_YN                   =   #{erYn}                                 /* 응급여부 */
		 </if>
		 <if test='erResnCd != null'>
		     ,  ER_RESN_CD              =   #{erResnCd}                             /* 응급사유코드 */
		 </if>
		 <if test='clrsPrjcCd != null'>
		     ,  CLRS_PRJC_CD            =   #{clrsPrjcCd}                           /* 임상연구 프로젝트코드 */
		 </if>
		 <if test='clrsPrjcDrId != null'>
		     ,  CLRS_PRJC_DR_ID         =   #{clrsPrjcDrId}                         /* 임상연구 의사ID */
		 </if>
		 <if test='wntdSctnCd != null'>
		     ,  WNTD_SCTN_CD            =   #{wntdSctnCd}                           /* 희망섹션 */
		 </if>
		 <if test='rplyAlrmDvsnCd != null'>
		     ,  RPLY_ALRM_DVSN_CD       =   #{rplyAlrmDvsnCd}                       /* 회신알람구분코드 */
		 </if>
		 <if test='cmtxSttsCd != null'>
		     ,  CMTX_STTS_CD            =   #{cmtxSttsCd}                           /* 협진상태코드 */
		 </if>
		 <if test='cmtxSttsDt != null'>
		     ,  CMTX_STTS_DT            =   to_date(#{cmtxSttsDt}, 'yyyymmddhh24miss')  /* 협진상태일시 */
		 </if>
		 <if test='cmtxRefrCtn != null'>
		     ,  CMTX_REFR_CTN           =   #{cmtxRefrCtn}                          /* 협진의뢰내용 */
		 </if>
		 <if test='refrXmlBdByte != null'>
		     ,  REFR_XML_BD             =   #{refrXmlBdByte}                        /* 의뢰XML자료 */
		 </if>
		 <if test='refrFormNo != null'>
		     ,  REFR_FORM_NO            =   #{refrFormNo}                           /* 의뢰서식번호 */
		 </if>
		/* 약품식별의뢰 */
		 <if test='dgtkReasCtn != null'>
		     ,  DGTK_REAS_CTN           =   #{dgtkReasCtn}                          /* 약물복용이유(또는 질환) */
		 </if>
		 <if test='dxNm != null'>
		     ,  DX_NM                   =   #{dxNm}                                 /* 진단명 */
		 </if>
		 <if test='drugPrvcCtn != null'>
		     ,  DRUG_PRVC_CTN           =   #{drugPrvcCtn}                          /* 약의 출처 */
		 </if>
		 <if test='rtrnRqstDt != null'>
		     ,  RTRN_RQST_DT            =   to_date(#{rtrnRqstDt}, 'yyyymmddhh24miss')  /* 반납요청일시 */
		 </if>
		 <if test='rtrnSttsCd != null'>
		     ,  RTRN_STTS_CD            =   #{rtrnSttsCd}                           /* 반납상태코드 */
		 </if>
		 <if test='infmDmndTmlmDvsnCd != null'>
		     ,  INFM_DMND_TMLM_DVSN_CD  =   #{infmDmndTmlmDvsnCd}                   /* 정보요구시한구분 */
		 </if>
		/* 협진상태 변경 */
		 <if test='dltnYn != null'>
		     ,  DLTN_YN                 =   #{dltnYn}                               /* 삭제여부 */
		 </if>
		 <if test='cnclYn != null'>
		     ,  CNCL_YN                 =   #{cnclYn}                               /* 취소여부 */
		 </if>
		 <if test='cncrId != null'>
		     ,  CNCR_ID                 =   #{cncrId}                               /* 취소자ID */
		 </if>
		 <if test='cnclDt != null'>
		     ,  CNCL_DT                 =   to_date(#{cnclDt}, 'yyyymmddhh24miss')  /*  취소일시 */
		 </if>
		 <if test='midlRplrId != null'>
		     ,  MIDL_RPLR_ID            =   #{midlRplrId}                           /* 중간회신ID */
		 </if>
		 <if test='midlRplyCnfrDt != null'>
		     ,  MIDL_RPLY_CNFR_DT       =   to_date(#{midlRplyCnfrDt}, 'yyyymmddhh24miss')  /* 중간회신 확인일시 */
		 </if>
		 <if test='yo75TotlDninPtntYn != null'>
		     ,  YO75_TOTL_DNIN_PTNT_YN  =   #{yo75TotlDninPtntYn}                   /* 만75세총의치보험환자여부 */
		 </if>
		 <if test='rplyYmd != null'>
		     ,  RPLY_YMD                =   to_date(#{rplyYmd}, 'yyyymmddhh24miss') /* 회신일자(최초) */
		 </if>
		 <if test='rplyDrMcdpCd != null'>
		     ,  RPLY_DR_MCDP_CD         =   #{rplyDrMcdpCd}                         /* 회신진료과 */
		 </if>
		 <if test='rplyDrId != null'>
		     ,  RPLY_DR_ID              =   #{rplyDrId}                             /* 회신의사 */
		 </if>
		 <if test='rplyFormNo != null'>
		     ,  RPLY_FORM_NO            =   #{rplyFormNo}                           /* 회신서식번호 */
		 </if>
		 <if test='rplyXmlBdByte != null'>
		     ,  RPLY_XML_BD             =   #{rplyXmlBdByte}                        /* 회신XML자료 */
		 </if>
		 <if test='cmtxRplyCtn != null'>
		     ,  CMTX_RPLY_CTN           =   #{cmtxRplyCtn}                          /* 협진회신내용 */
		 </if>
		 <if test='implYmd != null'>
		     ,  IMPL_YMD                =   to_date(#{implYmd}, 'yyyymmdd')         /* 실시일자 */
		 </if>
		 <if test='lastRplyId != null'>
		     ,  LAST_RPLY_ID            =   #{lastRplyId}                           /* 최종회신ID */
		 </if>
		 <if test='lastRplyCnfrDt != null'>
		     ,  LAST_RPLY_CNFR_DT       =   to_date(#{lastRplyCnfrDt}, 'yyyymmddhh24miss')  /* 최종회신확인일시 */
		 </if>
		 <if test='adtnRplyYn != null'>
		     ,  ADTN_RPLY_YN            =   #{adtnRplyYn}                           /* 추가회신여부 */
		 </if>
		 <if test='adtnRplyDt != null'>
		     ,  ADTN_RPLY_DT            =   to_date(#{adtnRplyDt}, 'yyyymmddhh24miss')      /* 추가회신일시 */
		 </if>
		/* 인증정보 */
		 <if test='athnId != null'>
		     ,  ATHN_ID                 =   #{athnId}                               /* 인증자ID */
		 </if>
		 <if test='crtfIp != null'>
		     ,  CRTF_IP                 =   #{crtfIp}                               /* 인증IP */
		 </if>
		 <if test='crtfDt != null'>
		     ,  CRTF_DT                 =   to_date(#{crtfDt}, 'yyyymmddhh24miss')  /* 인증일시 */
		 </if>
		/* 기타 */
		 <if test='prinDt != null'>
		     ,  PRIN_DT                 =   to_date(#{prinDt}, 'yyyymmddhh24miss')  /* 출력일시 */
		 </if>
		 <if test='apntDt != null'>
		     ,  APNT_DT                 =   to_date(#{apntDt}, 'yyyymmddhh24miss')  /* 예약일시 */
		 </if>
		 <if test='asnrId != null'>
		     ,  ASNR_ID                 =   #{asnrId}                               /* 배정자ID */
		 </if>
		 <if test='asgmDt != null'>
		     ,  ASGM_DT                 =   to_date(#{asgmDt}, 'yyyymmddhh24miss')  /* 배정일시 */
		 </if>
		<if test='chfrYn != null'>
		     ,  CHFR_YN                 =   #{chfrYn}                               /* 무료여부 */
		</if>
		<if test='wntdDt != null'>
		<![CDATA[
			,  WNTD_DT                 =   to_date(#{wntdDt},'yyyymmdd')           /* 희망일자 */
		]]>
		</if>
		/* 계산제외여부 지원부서 협진 사용 용도 */
		<!-- #{workNm} 개별 조회옵션 지정 -->
		<choose>
		<when test='workNm != null and workNm == "impl"'> /* 협진실시 */
		  <if test='clclExclYn != null'>
		    , CLCL_EXCL_YN = #{clclExclYn}
		  </if>
		</when>
		<when test='workNm != null and workNm == "rplyMidl"'> /* 중간회신 */
		  <if test='clclExclYn != null'>
		    , CLCL_EXCL_YN = #{clclExclYn}
		  </if>
		</when>
		<when test='workNm != null and workNm == "implCncl"'> /* 협진실시 취소 */
		  <if test='clclExclYn != null'>
		    , CLCL_EXCL_YN = #{clclExclYn}
		  </if>
		</when>
		<when test='workNm != null '> 
			<if test='workNm == "backRefr" or workNm == "backMidl" '>
			 , RCST_CD = 'N'
		     , RCPC_DT = null
			 , VIA_ADMS_RCST_CD = 'N' 	
		    </if> 
		</when>
		</choose>
		 where  PTNO                     =   #{ptno}
		   and  ORDR_YMD                 =   to_date(#{ordrYmd}, 'YYYYMMDD')
		   and  ORDR_SNO                 =   #{ordrSno}
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listAmptCmtx-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="catnFlagCtn" column="CATN_FLAG_CTN"/>
		<result property="cmtxSttsCd" column="CMTX_STTS_CD"/>
		<result property="cmtxSttsNm" column="CMTX_STTS_NM"/>
		<result property="cmtxDvsnCd" column="CMTX_DVSN_CD"/>
		<result property="cmtxDvsnNm" column="CMTX_DVSN_NM"/>
		<result property="oddrMcdpCd" column="ODDR_MCDP_CD"/>
		<result property="oddrAbrvMcdpCd" column="ODDR_ABRV_MCDP_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="rplyYmd" column="RPLY_YMD"/>
		<result property="rplyDt" column="RPLY_DT"/>
		<result property="rplyDrMcdpCd" column="RPLY_DR_MCDP_CD"/>
		<result property="rplyDrAbrvMcdpCd" column="RPLY_DR_ABRV_MCDP_CD"/>
		<result property="rplyDrId" column="RPLY_DR_ID"/>
		<result property="rplyDrNm" column="RPLY_DR_NM"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="erYn" column="ER_YN"/>
		<result property="erResnCd" column="ER_RESN_CD"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="clrsPrjcCd" column="CLRS_PRJC_CD"/>
		<result property="clrsPrjcDrId" column="CLRS_PRJC_DR_ID"/>
		<result property="clrsPrjcDrNm" column="CLRS_PRJC_DR_NM"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvMcdpCd" column="ABRV_MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvWardCd" column="ABRV_WARD_CD"/>
		<result property="careWardCd" column="CARE_WARD_CD"/>
		<result property="careAbrvWardCd" column="CARE_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="chdrId" column="CHDR_ID"/>
		<result property="chdrNm" column="CHDR_NM"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="dxNm" column="DX_NM"/>
		<result property="wntdDrMcdpCd" column="WNTD_DR_MCDP_CD"/>
		<result property="wntdDrAbrvMcdpCd" column="WNTD_DR_ABRV_MCDP_CD"/>
		<result property="wntdDrMcdpNm" column="WNTD_DR_MCDP_NM"/>
		<result property="wntdDrId" column="WNTD_DR_ID"/>
		<result property="wntdDrNm" column="WNTD_DR_NM"/>
		<result property="implYmd" column="IMPL_YMD"/>
		<result property="inptUserDvsnCd" column="INPT_USER_DVSN_CD"/>
		<result property="wntdSctnCd" column="WNTD_SCTN_CD"/>
		<result property="cmtxSttsDt" column="CMTX_STTS_DT"/>
		<result property="erSmsrTrnmYn" column="ER_SMSR_TRNM_YN"/>
		<result property="rplyAlrmDvsnCd" column="RPLY_ALRM_DVSN_CD"/>
		<result property="dlivId" column="DLIV_ID"/>
		<result property="dlivCnfrDt" column="DLIV_CNFR_DT"/>
		<result property="midlRplrId" column="MIDL_RPLR_ID"/>
		<result property="midlRplrNm" column="MIDL_RPLR_NM"/>
		<result property="midlRplyCnfrDt" column="MIDL_RPLY_CNFR_DT"/>
		<result property="lastRplyId" column="LAST_RPLY_ID"/>
		<result property="lastRplyCnfrDt" column="LAST_RPLY_CNFR_DT"/>
		<result property="oddrClno" column="ODDR_CLNO"/>
		<result property="imagEn" column="IMAG_EN"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="cmtxRefrWrtgYn" column="CMTX_REFR_WRTG_YN"/>
		<result property="cmtxRplyWrtgYn" column="CMTX_RPLY_WRTG_YN"/>
		<result property="hour24WthnRplyYn" column="HOUR24_WTHN_RPLY_YN"/>
		<result property="mltdYn" column="MLTD_YN"/>
		<result property="yo75TotlDninPtntYn" column="YO75_TOTL_DNIN_PTNT_YN"/>
		<result property="apntDt" column="APNT_DT"/>
		<result property="asgmDt" column="ASGM_DT"/>
		<result property="asnrId" column="ASNR_ID"/>
		<result property="asnrNm" column="ASNR_NM"/>
		<result property="cnfrDvsnCd" column="CNFR_DVSN_CD"/>
		<result property="lmttAnagValdYmd" column="LMTT_ANAG_VALD_YMD"/>
		<result property="athnId" column="ATHN_ID"/>
		<result property="athnNm" column="ATHN_NM"/>
		<result property="crtfIp" column="CRTF_IP"/>
		<result property="crtfDt" column="CRTF_DT"/>
		<result property="inqrDdlnYmd" column="INQR_DDLN_YMD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listAmptCmtx (병동협진내역 조회) 
        Description :                                           병동협진내역 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listAmptCmtx-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listAmptCmtx"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listAmptCmtx-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listAmptCmtx */
		<![CDATA[
		select  /*+ MdpAmptCmtxMngmDAO-listAmptCmtx_병동협진내역 조회 */
		        a.PTNO                                              as PTNO                     /* 환자번호 */
		     ,  to_char(a.ORDR_YMD, 'yyyymmdd')                     as ORDR_YMD                 /* 처방일자 */
		     ,  a.ORDR_SNO                                          as ORDR_SNO                 /* 처방일련번호 */
		     ,  a.MDRP_NO                                           as MDRP_NO                  /* 진료접수번호 */
		     ,  to_char(b.MDCR_DT, 'yyyymmddhh24miss')              as MDCR_DT                  /* 진료일시 */
		     ,  c.PTNT_NM                                           as PTNT_NM                  /* 환자명 */
		     ,  c.GEND_CD                                           as GEND_CD                  /* 성별코드 */
		     ,  to_char(c.BTDT, 'yyyymmdd')                         as BTDT                     /* 생년월일 */
		     ,  FN_QD_CAUTION_COLOR(a.PTNO)                         as CATN_FLAG_CTN            /* 주의플래그내용 ('1' 녹색/감염, '2' 오렌지/감염(격리) */
		     ,  a.CMTX_STTS_CD                                      as CMTX_STTS_CD             /* 협진상태코드(MM320) 0:임시저장 1:의뢰 2:전달확인 3:중간회신 4:최종회신 9:취소 */
		     ,  (   select  DETL_CD_NM
		              from  CCCMCDDMT
		             where  COMN_GRP_CD  = 'MM320'
		               and  COMN_DTLS_CD = a.CMTX_STTS_CD
		        ) || decode(a.ADTN_RPLY_YN, 'Y', '(추)', '')        as CMTX_STTS_NM             /* 협진상태명 */
		     ,  a.CMTX_DVSN_CD                                      as CMTX_DVSN_CD             /* 협진구분코드 */
		     ,  (   select  DETL_CD_NM
		              from  CCCMCDDMT
		             where  COMN_GRP_CD  = 'MM266'
		               and  COMN_DTLS_CD = a.CMTX_DVSN_CD
		        )                                                   as CMTX_DVSN_NM             /* 협진구분명 */
		     ,  a.ODDR_MCDP_CD                                      as ODDR_MCDP_CD             /* 처방의사진료과코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.ODDR_MCDP_CD
		        )                                                   as ODDR_ABRV_MCDP_CD        /* 처방의사약어진료과코드 */
		     ,  a.ODDR_ID                                           as ODDR_ID                  /* 처방의사ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.ODDR_ID
		        )                                                   as ODDR_NM                  /* 처방의사명 */
		     ,  to_char(a.RPLY_YMD, 'yyyymmdd')                     as RPLY_YMD                 /* 회신일자 */
		     ,  to_char(a.RPLY_YMD, 'yyyymmddhh24miss')             as RPLY_DT                  /* 회신일시 */
		     ,  a.RPLY_DR_MCDP_CD                                   as RPLY_DR_MCDP_CD          /* 회신의사진료과코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.RPLY_DR_MCDP_CD
		        )                                                   as RPLY_DR_ABRV_MCDP_CD     /* 회신의사약어진료과코드 */
		     ,  a.RPLY_DR_ID                                        as RPLY_DR_ID               /* 회신의사ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.RPLY_DR_ID
		        )                                                   as RPLY_DR_NM               /* 회신의사명 */
		     ,  a.CODV_CD                                           as CODV_CD                  /* 내원구분코드 */
		     ,  a.ER_YN                                             as ER_YN                    /* 응급여부 */
		     ,  a.ER_RESN_CD                                        as ER_RESN_CD               /* 응급사유코드 */
		     ,  a.RCST_CD                                           as RCST_CD                  /* 수납상태코드 */
		     ,  a.CLRS_PRJC_CD                                      as CLRS_PRJC_CD             /* 임상연구과제코드 */
		     ,  a.CLRS_PRJC_DR_ID                                   as CLRS_PRJC_DR_ID          /* 임상연구과제의사ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.CLRS_PRJC_DR_ID
		        )                                                   as CLRS_PRJC_DR_NM          /* 임상연구과제의사명 */
		     ,  a.MCDP_CD                                           as MCDP_CD                  /* 진료과코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.MCDP_CD
		        )                                                   as ABRV_MCDP_CD             /* 약어진료과코드 */
		     ,  a.WARD_CD                                           as WARD_CD                  /* 병동코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.WARD_CD
		        )                                                   as ABRV_WARD_CD             /* 약어병동코드 */
		     ,  b.CARE_WARD_CD                                      as CARE_WARD_CD
		     ,  (   select  ABRV_DPRT_CD
		              from  HZDEPTMMT
		             where  DPRT_CD = b.CARE_WARD_CD
		        )                                                   as CARE_ABRV_WARD_CD        /* 재원약어병동코드 */
		     ,  b.CARE_PTRM_NO                                      as CARE_PTRM_NO
		     ,  a.CHDR_ID                                           as CHDR_ID                  /* 지정의사ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.CHDR_ID
		        )                                                   as CHDR_NM                  /* 지정의사명 */
		     ,  a.GNDR_ID                                           as GNDR_ID                  /* 주치의사ID */
		     ,  a.ORDR_CD                                           as ORDR_CD                  /* 처방코드 */
		     ,  (   nvl((SELECT x.ORDR_NM
						   FROM AIMFMDFET x
						  WHERE x.MDFE_CD = a.ORDR_CD
						    AND x.APST_YMD <= a.ordr_ymd
						    AND x.APFN_YMD >= a.ordr_ymd
						    AND rownum = 1)
		                   ,(select  x.ORDR_NM
		                       from  MDORDRCMT x
		                      where  x.ORDR_CD = a.ORDR_CD
		                        and  rownum = 1)
		                )
		        )                                                   as ORDR_NM                  /* 처방명 */
		     ,  a.DX_NM                                             as DX_NM                     /* 진단명 */
		     ,  a.WNTD_DR_MCDP_CD                                   as WNTD_DR_MCDP_CD          /* 희망의사진료과코드 */
		     ,  d.ABRV_DPRT_CD                                      as WNTD_DR_ABRV_MCDP_CD     /* 희망의사약어진료과코드 */
		     ,  d.KORN_DPRT_NM                                      as WNTD_DR_MCDP_NM          /* 희망의사진료과명 */
		     ,  a.WNTD_DR_ID                                        as WNTD_DR_ID               /* 희망의사ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.WNTD_DR_ID
		        )                                                   as WNTD_DR_NM               /* 희망의사명 */
		     ,  to_char(a.IMPL_YMD, 'yyyymmdd')                     as IMPL_YMD                 /* 실시일자 */
		     ,  a.INPT_USER_DVSN_CD                                 as INPT_USER_DVSN_CD        /* 입력사용자구분코드 (1.의사 2.간호사) */
		     ,  a.WNTD_SCTN_CD                                      as WNTD_SCTN_CD             /* 희망섹션코드 */
		     ,  to_char(a.CMTX_STTS_DT, 'yyyymmddhh24miss')         as CMTX_STTS_DT             /* 협진상태일시 */
		     ,  a.ER_SMSR_TRNM_YN                                   as ER_SMSR_TRNM_YN          /* 응급SMS송신여부 */
		     ,  a.RPLY_ALRM_DVSN_CD                                 as RPLY_ALRM_DVSN_CD        /* 회신알람구분코드 */  -- (신청시 중간,최종)
		     ,  a.DLIV_ID                                           as DLIV_ID                  /* 전달자ID */
		     ,  to_char(a.DLIV_CNFR_DT, 'yyyymmddhh24miss')         as DLIV_CNFR_DT             /* 전달자확인일시 */
		     ,  a.MIDL_RPLR_ID                                      as MIDL_RPLR_ID             /* 중간회신자ID */
		     ,  (   select  USER_NM
				              from  CCUSRDPHT
				             where  USER_ID = a.MIDL_RPLR_ID
				        )                                                   as MIDL_RPLR_NM             /* 중간회신자명 */
		     ,  to_char(a.MIDL_RPLY_CNFR_DT, 'yyyymmddhh24miss')    as MIDL_RPLY_CNFR_DT        /* 중간회신확인일시 */
		     ,  a.LAST_RPLY_ID                                      as LAST_RPLY_ID             /* 최종회신ID */
		     ,  to_char(a.LAST_RPLY_CNFR_DT, 'yyyymmddhh24miss')    as LAST_RPLY_CNFR_DT        /* 최종회신확인일시 */
		     ,  (   select  fn_ap_wrap_telno(CLNO,'')
		              from  CCUSERAMV
		             where  LGIN_ID = a.ODDR_ID
		        )                                                   as ODDR_CLNO                /* 처방의사 휴대전화 */
		     ,  case
		            when exists (   select  1
		                              from  MDBMIMGRT
		                             where  PTNO     = a.PTNO
		                               and  ORDR_YMD = a.ORDR_YMD
		                               and  ORDR_SNO = a.ORDR_SNO
		                        ) then 'Y'
		            else 'N'
		            end                                             as IMAG_EN                  /* 이미지유무 */
		     ,  to_char(a.FRST_RGST_DT, 'yyyymmddhh24miss')         as FRST_RGST_DT             /* 최초등록일시 */
		     ,  to_char(a.PRIN_DT, 'yyyymmddhh24miss')              as PRIN_DT                  /* 출력일시 */
		     ,  decode(nvl(length(a.REFR_XML_BD), 0), 0, 'N', 'Y')  as CMTX_REFR_WRTG_YN        /* 협진의뢰작성여부 */
		     ,  decode(nvl(length(a.RPLY_XML_BD), 0), 0, 'N', 'Y')  as CMTX_RPLY_WRTG_YN        /* 협진회신작성여부 */
		     ,  case
		            when a.CMTX_STTS_CD = '4' then  case
		                                                when sign((a.FRST_RGST_DT + 1) - a.RPLY_YMD) = 1 then 'Y'
		                                                else 'N'
		                                                end
		            else ''
		            end                                             as HOUR24_WTHN_RPLY_YN      /* 24시간이내회신여부 */
		     ,  nvl((   select  'Y'
		                  from  HZDEPTMMT
		                 where  DPRT_CD = a.MCCN_CD
		                   and  MLTD_CNTR_DVSN_CD is not nulL
		        ), 'N')                                             as MLTD_YN                  /* 다학제여부 */
		     ,  a.YO75_TOTL_DNIN_PTNT_YN                            as YO75_TOTL_DNIN_PTNT_YN   /* 만75세총의치보험환자여부 */
		     ,  to_char(a.APNT_DT, 'yyyymmddhh24miss')              as APNT_DT                  /* 예약시간 */
		     ,  to_char(a.ASGM_DT, 'yyyymmddhh24miss')              as ASGM_DT                  /* 배정일시 */
		     ,  a.ASNR_ID                                           as ASNR_ID                  /* 배정자ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID     =   a.ASNR_ID
		        )                                                   as ASNR_NM                  /* 배정자명 */
		     ,  h.CNFR_DVSN_CD                                      as CNFR_DVSN_CD             /* 확인구분코드 */
		     ,  to_char(h.LMTT_ANAG_VALD_YMD, 'yyyymmdd')           as LMTT_ANAG_VALD_YMD       /* 제한항균제승인일자 */
		     ,  a.ATHN_ID                                           as ATHN_ID                  /* 인증자ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.ATHN_ID
		        )                                                   as ATHN_NM                  /* 인증자명 */
		     ,  a.CRTF_IP                                           as CRTF_IP                  /* 인증IP */
		     ,  to_char(a.CRTF_DT, 'yyyymmddhh24miss')              as CRTF_DT                  /* 인증일시 */
		     ,  nvl((select to_char(trunc(sysdate) + to_number(x.NRPL_CMTX_INPE_VL),'yyyymmdd')
			           from MDBINDVET x
			          where x.USER_ID = a.ODDR_ID
			            and x.NRPL_CMTX_INPE_VL is not null),to_char(trunc(sysdate+1),'yyyymmdd')) as INQR_DDLN_YMD /* 노티조회가능일자 */
		  from  MDCONSRCT a
		     ,  APRCRPTNT b
		     ,  APPTPTNTT c
		     ,  HZDEPTMMT d
		     ,  MDANTBRIT h         -- 제한항균제협진의뢰
		 where  nvl(a.DLTN_YN, 'N') =   'N'                     /* 삭제건 제외 */
		   and  b.MDRP_NO           =   a.MDRP_NO
		   and  b.CNCL_DT is null
		   and  c.PTNO              =   a.PTNO
		   and  d.DPRT_CD       (+) =   a.WNTD_DR_MCDP_CD       /* 희망의사진료과코드 */
		   and  h.PTNO          (+) =   a.PTNO
		   and  h.ORDR_YMD      (+) =   a.ORDR_YMD
		   and  h.ORDR_SNO      (+) =   a.ORDR_SNO
		]]>
		 <if test='codvCd != null and codvCd == "O"'>
		   and  a.CODV_CD = #{codvCd}
		 </if>
		 <if test='codvCd != null and codvCd != "O"'>
		   and  a.CODV_CD <![CDATA[ <> ]]> 'O'
		 </if>
		 <if test='strtYmd != null and strtYmd != ""'>
		   and  a.ORDR_YMD between to_date(#{strtYmd}, 'yyyymmdd') and to_date(#{fnshYmd}, 'yyyymmdd')
		 </if>
		 <if test='ptno != null and ptno != ""'>
		   and  a.PTNO              =   #{ptno}
		 </if>
		 <if test='mdrpNo != null and mdrpNo != ""'>
		   and  a.MDRP_NO           =   #{mdrpNo}
		 </if>
		 <if test='wardCd != null and wardCd != ""'>
		   and  a.WARD_CD           =   #{wardCd}
		 </if>
		 <if test='oddrMcdpCd != null and oddrMcdpCd != ""'>
		   and  a.ODDR_MCDP_CD      =   #{oddrMcdpCd}
		 </if>
		 <if test='oddrId != null and oddrId != ""'>
		 <![CDATA[
		   and  a.ODDR_ID in (select b.USER_ID
							    from (
								        select distinct b.LGIN_ID
								          from CCUSERAMT a
								              ,CCUSRDPHT b
								         where a.LGIN_ID = b.LGIN_ID
								           and (b.USER_ID = #{oddrId} or b.LGIN_ID = #{oddrId})
								         group by b.LGIN_ID
								       ) a
								      ,ccusrdpht b
								 where a.LGIN_ID = b.LGIN_ID)
		 ]]>
		 </if>
		 <if test='mcdpCd != null and mcdpCd != ""'>
		   and  a.MCDP_CD           =   #{mcdpCd}
		 </if>
		 <if test='chdrId != null and chdrId != ""'>
		 <![CDATA[
		 	and  a.CHDR_ID in (select b.USER_ID
							    from (
								        select distinct b.LGIN_ID
								          from CCUSERAMT a
								              ,CCUSRDPHT b
								         where a.LGIN_ID = b.LGIN_ID
								           and (b.USER_ID = #{chdrId} or b.LGIN_ID = #{chdrId})
								         group by b.LGIN_ID
								       ) a
								      ,ccusrdpht b
								 where a.LGIN_ID = b.LGIN_ID)
		 ]]>
		 </if>
		 <if test='wntdDrMcdpCd != null and wntdDrMcdpCd != ""'>
		   and  a.WNTD_DR_MCDP_CD   =   #{wntdDrMcdpCd}
		 </if>
		 <if test='wntdDrId != null and wntdDrId != ""'>
		 <![CDATA[
		  and  a.WNTD_DR_ID in (select b.USER_ID
							    from (
								        select distinct b.LGIN_ID
								          from CCUSERAMT a
								              ,CCUSRDPHT b
								         where a.LGIN_ID = b.LGIN_ID
								           and (b.USER_ID = #{wntdDrId} or b.LGIN_ID = #{wntdDrId})
								         group by b.LGIN_ID
								       ) a
								      ,ccusrdpht b
								 where a.LGIN_ID = b.LGIN_ID)
		 ]]>
		 </if>
		 <if test='rplyDrId != null and rplyDrId != ""'>
		 <![CDATA[
		  and  a.RPLY_DR_ID in (select b.USER_ID
							    from (
								        select distinct b.LGIN_ID
								          from CCUSERAMT a
								              ,CCUSRDPHT b
								         where a.LGIN_ID = b.LGIN_ID
								           and (b.USER_ID = #{rplyDrId} or b.LGIN_ID = #{rplyDrId})
								         group by b.LGIN_ID
								       ) a
								      ,ccusrdpht b
								 where a.LGIN_ID = b.LGIN_ID)
		 ]]>
		 </if>
		 <if test='wntdSctnCd != null and wntdSctnCd != ""'>
		   and  a.WNTD_SCTN_CD      =   #{wntdSctnCd}
		 </if>
		 <if test='ordrCd != null and ordrCd != ""'>
		   and  a.ORDR_CD           =   #{ordrCd}
		 </if>
		 <if test='cmtxDvsnCd != null and cmtxDvsnCd != ""'>
		   and  a.CMTX_DVSN_CD      =   #{cmtxDvsnCd}      /* 협진구분코드(MM266) 1:진료협진 2:제한항균제 7:약품식별 8:영양상담 9:검사협진 E:외래회송 G:입원회송 F:창상위원회*/
		 </if>
		 <if test='rplyYmd != null and rplyYmd != ""'>
		   and  a.RPLY_YMD between to_date(#{rplyYmd}, 'yyyymmdd') and to_date(#{rplyYmd}, 'yyyymmdd') + 0.99999
		 </if>
		 <if test='sthsYn != null and sthsYn == "Y"'>
		   <!-- #{sthsYn} -->
		   and  (   (   b.DSCH_DT = to_date('29991231','yyyymmdd')
		            ) or
		            (   b.CODV_CD = 'E' and
		                exists (    select  1                   /* 응급실협진중 입원전환된 환자가 퇴원하지 않은 경우 */
		                              from  APRCRLTNT h1
		                                 ,  APRCRPTNT a1
		                             where  h1.MDRP_RLTN_MDRP_NO    =   b.MDRP_NO
		                               and  h1.MDRP_RLTN_DVSN_CD    =   '01'
		                               and  a1.MDRP_NO              =   h1.MDRP_NO
		                               and  a1.DSCH_DT              =   to_date('29991231','yyyymmdd')
		                               and  a1.CNCL_DT is null      )
		            )
		        )
		 </if>
		 <choose>
		   <when test='inqrDvsnNm != null and inqrDvsnNm == "refrScrn"'>
		   <!-- #{inqrDvsnNm} 개별 조회옵션 지정 -->
		   <![CDATA[
		   and  a.CMTX_DVSN_CD in ('1','8','9','E','G','F','H','Z')       /* 협진구분코드(MM266) 1:진료협진 8:영양상담 9:검사협진 E:외래회송 G:입원회송 F:창상위원회 H:회송예고 Z:지원협진만 조회대상*/
		   and  (a.ORDR_CD not in (select z.MDCR_DTLS_CTRL_CD
		                             from mzctrlmmt z
		                            where z.mdcr_ctrl_cd = 'MDP_035')
		          or
		         a.ORDR_CD is null) -- 약제팀 TDM 의뢰내역은 협진의뢰 화면에서는 조회되지 않도록 조건 추가. 별도의 의뢰화면 있음. MDP029F1 - taebum
		   ]]>
		   </when>
		   <when test='inqrDvsnNm != null and inqrDvsnNm == "rplyScrn"'>
		   and  a.CMTX_STTS_CD not in ('0', '9')        /* 협진회신화면은 임시저장, 취소 상태는 조회대상 제외 */
		   </when>
		   <when test='inqrDvsnNm != null and inqrDvsnNm == "excpStts9"'>
		   and  a.CMTX_STTS_CD != '9'                   /* 취소상태 제외 */
		   </when>
		   <when test='inqrDvsnNm != null and inqrDvsnNm == "excpStts0"'>
		   and  a.CMTX_STTS_CD != '0'                   /* 임시저장 상태 제외 */
		   </when>
		 </choose>
		 <choose>
		   <when test='rplyYn != null and rplyYn == "N"'>
		   <!-- #{rplyYn} 회신여부 -->
		   and  (    (a.RPLY_YMD is null)
				  or (a.CMTX_STTS_CD  = '3')         /* 20211101 중간회신도 미회신으로  AAQI2110002 김다영샘 요청 */
				) 
		   </when>
		   <when test='rplyYn != null and rplyYn == "Y"'>
		   and  a.RPLY_YMD is not null
		   </when>
		 </choose>
		 <choose>
		   <when test='crtfYn != null and crtfYn == "N"'>
		   <!-- #{crtfYn} 인증, 미인증 구분 -->
		   and  a.ATHN_ID is null
		   </when>
		   <when test='crtfYn != null and crtfYn == "Y"'>
		   and  a.ATHN_ID is not null
		   </when>
		 </choose>
		 <choose>
		   <when test='sortSqncNm != null and sortSqncNm == "DESC"'>
		   <!-- #{sortSqncNm} 오름차순, 내림차순 정렬기준 -->
		 order
		    by  ORDR_YMD desc
		     ,  PTNO
		     ,  ORDR_SNO desc
		   </when>
		   <otherwise>
		 order
		    by  ORDR_YMD
		     ,  PTNO
		     ,  ORDR_SNO
		   </otherwise>
		 </choose>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listDndtWkpr-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="userId" column="USER_ID"/>
		<result property="userNm" column="USER_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listDndtWkpr (부서별 당직근무자 조회) 
        Description :                                           부서별 당직근무자 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listDndtWkpr-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listDndtWkpr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listDndtWkpr-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listDndtWkpr */
		<![CDATA[
		select  /*+ MdpAmptCmtxMngmDAO-listDndtWkpr_부서별 당직근무자 조회 */
		        b.USER_ID           as USER_ID
		     ,  b.USER_NM           as USER_NM
		  from  ETDNDTWKT a     /* 당직근무스케쥴정보 */
		     ,  CCUSRDPHT b     /* 사용자진료조직관계이력 */
		 where  a.DNDT_WRKN_YMD between to_char(to_date(nvl(#{baseYmd}, to_char(sysdate, 'YYYYMMDD')),'yyyymmdd') - 1, 'yyyymmdd')
		                            and nvl(#{baseYmd}, to_char(sysdate, 'YYYYMMDD'))  /*  전날 17:00~08:00 당직인분도 있음 */
		   and  a.MCDP_CD       =   #{mcdpCd}
		   and  a.DNDT_DVSN_CD in ('12', '13')      /* 당직구분코드 */
		   and  a.DNDT_STRT_DT  <=  sysdate         /* 당직시작일시 */
		   and  a.DNDT_FNSH_DT  >=  sysdate         /* 당직종료일시 */
		   and  b.USER_ID       =   a.DTDR_ID
		   and  b.APST_YMD      <=  sysdate         /* 적용시작일자 */
		   and  b.APFN_YMD      >=  sysdate         /* 적용종료일자 */
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOrdr-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOrdr (영양상담 처방 조회) 
        Description :                                           영양상담 처방 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOrdr-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOrdr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOrdr-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOrdr */
		select  /* MdpAmptCmtxMngmDAO-listNtcnOrdr 영양상담 처방코드 조회 */
		        b.MDFE_CD           as ORDR_CD
		     ,  b.MDFE_KORN_NM      as ORDR_NM
		  from  SUCTRLMMT a /* 영양급식제어정보 */
		     ,  AIMFMDFET b /* 수가코드  */
		 where  a.NTRT_MLSR_CTRL_CD =   'SU_CMTX'
		   and  b.MDFE_CD           =   a.NTRT_MLSR_DTLS_CTRL_CD
		   and  trunc(sysdate) between  b.APST_YMD and  b.APFN_YMD
		 order
		    by  b.MDFE_CD
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listPastCmtxImag-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="imagSno" column="IMAG_SNO"/>
		<result property="imagCtnByte" column="IMAG_CTN_BYTE"/>
		<result property="imagCtn" column="IMAG_CTN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listPastCmtxImag (과거 협진이미지 조회) 
        Description :                                           과거 협진이미지 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listPastCmtxImag-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listPastCmtxImag"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listPastCmtxImag-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listPastCmtxImag */
		select  /* MdpAmptCmtxMngmDAO-listPastCmtxImag 과거협진이미지 조회 */
		        IMAG_SNO        as IMAG_SNO         /* 이미지일련번호 */
		     ,  IMAG_CTN        as IMAG_CTN_BYTE    /* 이미지내용 */
		     ,  ''              as IMAG_CTN
		  from  MDBMIMGRT
		 where  PTNO        =   #{ptno}
		   and  ORDR_YMD    =   to_date(#{ordrYmd}, 'yyyymmdd')
		   and  ORDR_SNO    =   #{ordrSno}
		 order
		    by  IMAG_SNO
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneAmptCmtxDetl-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="ageCtn" column="AGE_CTN"/>
		<result property="frrn" column="FRRN"/>
		<result property="brrn" column="BRRN"/>
		<result property="careWardCd" column="CARE_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="careAbrvWardCd" column="CARE_ABRV_WARD_CD"/>
		<result property="oddrMcdpCd" column="ODDR_MCDP_CD"/>
		<result property="oddrAbrvMcdpCd" column="ODDR_ABRV_MCDP_CD"/>
		<result property="oddrMcdpNm" column="ODDR_MCDP_NM"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="oddrClno" column="ODDR_CLNO"/>
		<result property="ocfmNm" column="OCFM_NM"/>
		<result property="chdrId" column="CHDR_ID"/>
		<result property="chdrNm" column="CHDR_NM"/>
		<result property="implYmd" column="IMPL_YMD"/>
		<result property="rplyYmd" column="RPLY_YMD"/>
		<result property="rplyDrMcdpCd" column="RPLY_DR_MCDP_CD"/>
		<result property="rplyDrAbrvMcdpCd" column="RPLY_DR_ABRV_MCDP_CD"/>
		<result property="rplyDrMcdpNm" column="RPLY_DR_MCDP_NM"/>
		<result property="rplyDrId" column="RPLY_DR_ID"/>
		<result property="rplyDrNm" column="RPLY_DR_NM"/>
		<result property="midlRplrId" column="MIDL_RPLR_ID"/>
		<result property="midlRplrNm" column="MIDL_RPLR_NM"/>
		<result property="midlRplyCnfrDt" column="MIDL_RPLY_CNFR_DT"/>
		<result property="lastRplyId" column="LAST_RPLY_ID"/>
		<result property="lastRplrNm" column="LAST_RPLR_NM"/>
		<result property="lastRplyCnfrDt" column="LAST_RPLY_CNFR_DT"/>
		<result property="erYn" column="ER_YN"/>
		<result property="erResnCd" column="ER_RESN_CD"/>
		<result property="clrsPrjcCd" column="CLRS_PRJC_CD"/>
		<result property="cmtxRefrCtn" column="CMTX_REFR_CTN"/>
		<result property="cmtxRplyCtn" column="CMTX_RPLY_CTN"/>
		<result property="refrXmlBdByte" column="REFR_XML_BD_BYTE"/>
		<result property="refrXmlBd" column="REFR_XML_BD"/>
		<result property="rplyXmlBdByte" column="RPLY_XML_BD_BYTE"/>
		<result property="rplyXmlBd" column="RPLY_XML_BD"/>
		<result property="refrFormNo" column="REFR_FORM_NO"/>
		<result property="rplyFormNo" column="RPLY_FORM_NO"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="dxNm" column="DX_NM"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="ptadMdrpNo" column="PTAD_MDRP_NO"/>
		<result property="cnclPsblYn" column="CNCL_PSBL_YN"/>
		<result property="rcpcDt" column="RCPC_DT"/>
		<result property="viaAdmsRcstCd" column="VIA_ADMS_RCST_CD"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="imagEn" column="IMAG_EN"/>
		<result property="lastUpdrId" column="LAST_UPDR_ID"/>
		<result property="lastUpdtDt" column="LAST_UPDT_DT"/>
		<result property="cmtxSttsCd" column="CMTX_STTS_CD"/>
		<result property="cmtxDvsnCd" column="CMTX_DVSN_CD"/>
		<result property="wntdDrMcdpCd" column="WNTD_DR_MCDP_CD"/>
		<result property="wntdDrAbrvMcdpCd" column="WNTD_DR_ABRV_MCDP_CD"/>
		<result property="wntdDrMcdpNm" column="WNTD_DR_MCDP_NM"/>
		<result property="wntdDrId" column="WNTD_DR_ID"/>
		<result property="wntdDrNm" column="WNTD_DR_NM"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvMcdpCd" column="ABRV_MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvWardCd" column="ABRV_WARD_CD"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
		<result property="dltnYn" column="DLTN_YN"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="infmDmndTmlmDvsnCd" column="INFM_DMND_TMLM_DVSN_CD"/>
		<result property="infmDmndTmlmDvsnNm" column="INFM_DMND_TMLM_DVSN_NM"/>
		<result property="dgtkReasCtn" column="DGTK_REAS_CTN"/>
		<result property="dxNm" column="DX_NM"/>
		<result property="drugPrvcCtn" column="DRUG_PRVC_CTN"/>
		<result property="rtrnRqstDt" column="RTRN_RQST_DT"/>
		<result property="rtrnSttsCd" column="RTRN_STTS_CD"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="apntDt" column="APNT_DT"/>
		<result property="lnknOrdrCltyCd" column="LNKN_ORDR_CLTY_CD"/>
		<result property="lnknOrdrYmd" column="LNKN_ORDR_YMD"/>
		<result property="lnknOrdrSno" column="LNKN_ORDR_SNO"/>
		<result property="wntdDt" column="WNTD_DT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneAmptCmtxDetl (병동협진 상세내용 조회 (by PK)) 
        Description :                                           병동협진 상세내용 조회 (by PK)
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneAmptCmtxDetl-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneAmptCmtxDetl"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneAmptCmtxDetl-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneAmptCmtxDetl */
		<![CDATA[
		SELECT  /*+ MdpAmptCmtxMngmDAO-selectOneAmptCmtxDetl_병동협진 내용 조회 */
		        a.PTNO                                              as PTNO                     /* 환자번호 */
		     ,  to_char(a.ORDR_YMD, 'yyyymmdd')                     as ORDR_YMD                 /* 처방일자 */
		     ,  a.ORDR_SNO                                          as ORDR_SNO                 /* 처방일련번호 */
		     ,  b.PTNT_NM                                           as PTNT_NM                  /* 환자명 */
		     ,  b.GEND_CD                                           as GEND_CD                  /* 성별코드 */
		     ,  FN_MD_GETAGE('2', b.BTDT, sysdate)                  as AGE_CTN                  /* 연령내용 */
		     ,  b.FRRN                                              as FRRN
		     ,  b.BRRN                                              as BRRN
		     ,  c.CARE_WARD_CD                                      as CARE_WARD_CD             /* 간호병동코드 */
		     ,  c.CARE_PTRM_NO                                      as CARE_PTRM_NO             /* 간호병실번호 */
		     ,  (   select  ABRV_DPRT_CD
		              from  HZDEPTMMT
		             where  DPRT_CD = c.CARE_WARD_CD
		        )                                                   as CARE_ABRV_WARD_CD        /* 간호약어병동코드 */
		     ,  a.ODDR_MCDP_CD                                      as ODDR_MCDP_CD             /* 처방의사진료과코드 */
		     ,  (   select  ABRV_DPRT_CD
		              from  HZDEPTMMT
		             where  DPRT_CD = a.ODDR_MCDP_CD
		        )                                                   as ODDR_ABRV_MCDP_CD        /* 처방의사약어진료과코드 */
		     ,  (   select  KORN_DPRT_NM
		              from  HZDEPTMMT
		             where  DPRT_CD = a.ODDR_MCDP_CD
		        )                                                   as ODDR_MCDP_NM             /* 처방의사진료과명 */
		     ,  a.ODDR_ID                                           as ODDR_ID                  /* 처방의사ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.ODDR_ID
		        )                                                   as ODDR_NM                  /* 처방의사명 */
		]]>
		<choose>
		    <when test='inqrDvsnCd != null and inqrDvsnCd == "A"'>
		     ,  (   select EXTS_TLNO_CTN
		              from HZDEPTMMT
		             where DPRT_CD = a.ODDR_MCDP_CD
		               and rownum = 1
		        )                                                   as ODDR_CLNO                /* 처방의사 휴대전화 (약품식별의뢰는 부서 내선번호를 출력)*/
		    </when>
		    <otherwise>
		     ,  (   select  fn_ap_wrap_telno(CLNO,'')
		              from  CCUSERAMV
		             where  LGIN_ID = a.ODDR_ID
		        )                                                   as ODDR_CLNO                /* 처방의사 휴대전화 */
		    </otherwise>
		</choose>
		<![CDATA[
		     ,  (   select  y.DETL_CD_NM
		              from  CCUSERAMV x
		                 ,  CCCMCDDMT y
		             where  x.LGIN_ID = a.ODDR_ID
		               and  y.COMN_GRP_CD = 'GP006'
		               and  y.COMN_DTLS_CD = x.OCFM_CD
		               and  rownum = 1
		        )                                                   as OCFM_NM                  /* 직종명 */
		     ,  a.CHDR_ID                                           as CHDR_ID                  /* 지정의사ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.CHDR_ID
		        )                                                   as CHDR_NM                  /* 지정의사명 */
		     ,  to_char(a.IMPL_YMD, 'yyyymmdd')                     as IMPL_YMD
		     ,  to_char(a.RPLY_YMD, 'yyyymmddhh24miss')             as RPLY_YMD                 /* 회신일자 */
		     ,  a.RPLY_DR_MCDP_CD                                   as RPLY_DR_MCDP_CD          /* 회신의사진료과코드 */
		     ,  (   select  ABRV_DPRT_CD
		              from  HZDEPTMMT
		             where  DPRT_CD = a.RPLY_DR_MCDP_CD
		        )                                                   as RPLY_DR_ABRV_MCDP_CD     /* 회신의사약어진료과코드 */
		     ,  (   select  KORN_DPRT_NM
		              from  HZDEPTMMT
		             where  DPRT_CD = a.RPLY_DR_MCDP_CD
		        )                                                   as RPLY_DR_MCDP_NM          /* 회신의사진료과명 */
		     ,  a.RPLY_DR_ID                                        as RPLY_DR_ID               /* 회신의사ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.RPLY_DR_ID
		        )                                                   as RPLY_DR_NM               /* 회신의사명 */
		     ,  a.MIDL_RPLR_ID                                      as MIDL_RPLR_ID             /* 중간회신자ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.MIDL_RPLR_ID
		        )                                                   as MIDL_RPLR_NM             /* 중간회신자명 */
		     ,  to_char(a.MIDL_RPLY_CNFR_DT, 'yyyymmddhh24miss')    as MIDL_RPLY_CNFR_DT        /* 중간회신확인일시 */
		     ,  a.LAST_RPLY_ID                                      as LAST_RPLY_ID             /* 최종회신ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.LAST_RPLY_ID
		        )                                                   as LAST_RPLR_NM             /* 최종회신자명 */
		     ,  to_char(a.LAST_RPLY_CNFR_DT, 'yyyymmddhh24miss')    as LAST_RPLY_CNFR_DT        /* 최종회신확인일시 */
		     ,  a.ER_YN                                             as ER_YN                    /* 응급여부 */
		     ,  a.ER_RESN_CD                                        as ER_RESN_CD               /* 응급사유코드 */
		     ,  a.CLRS_PRJC_CD                                      as CLRS_PRJC_CD             /* 임상연구과제코드 */
		     ,  a.CMTX_REFR_CTN                                     as CMTX_REFR_CTN            /* 협진의뢰내용 */
		     ,  a.CMTX_RPLY_CTN                                     as CMTX_RPLY_CTN            /* 협진회신내용 */
		     ,  a.REFR_XML_BD                                       as REFR_XML_BD_BYTE         /* 의뢰XML자료 */
		     ,  ''                                                  as REFR_XML_BD
		     ,  a.RPLY_XML_BD                                       as RPLY_XML_BD_BYTE         /* 회신XML자료 */
		     ,  ''                                                  as RPLY_XML_BD
		     ,  a.REFR_FORM_NO                                      as REFR_FORM_NO             /* 의뢰서식번호 */
		     ,  a.RPLY_FORM_NO                                      as RPLY_FORM_NO             /* 회신서식번호 */
		     ,  a.ORDR_CD                                           as ORDR_CD                  /* 처방코드 */
		     ,  (   nvl((SELECT x.ORDR_NM
						   FROM AIMFMDFET x
						  WHERE x.MDFE_CD = a.ORDR_CD
						    AND x.APST_YMD <= a.ordr_ymd
						    AND x.APFN_YMD >= a.ordr_ymd
						    AND rownum = 1)
		                   ,(select  x.ORDR_NM
		                       from  MDORDRCMT x
		                      where  x.ORDR_CD = a.ORDR_CD
		                        and  rownum = 1)
		                )
		        )                                                   as ORDR_NM                  /* 처방명 */
		     ,  a.DX_NM                                             as DX_NM                     /* 진단명 */
		     ,  a.MDRP_NO                                           as MDRP_NO                  /* 진료접수번호 */
		     ,  a.PTAD_MDRP_NO                                      as PTAD_MDRP_NO             /* 2021.11.02 추가 원무진료 접수 번호 (수납체크용)*/ 
			 ,(
		            select
		                    case
		                        when x.codv_cd = 'I' and nvl(x.CHCK_STTS_CD, 'N') = 'N' then 'Y'                    /* 심사전 */
		                        when x.codv_cd = 'E' and x.dsch_dt = to_date('2999-12-31', 'yyyy-mm-dd') then 'Y'   /* 응급실 퇴실 완료 전 */
		                        else 'N'
		                    end
		            from    aprcrptnt x
		            where   x.mdrp_no = a.ptad_mdrp_no
		            and     x.cncl_dt is null
		        )   cncl_psbl_yn     /* 취소 가능 여부 */
		     ,to_char(a.RCPC_DT,'yyyymmddhh24miss')  as RCPC_DT									/* 수납일시 */
		     ,a.VIA_ADMS_RCST_CD 					 as VIA_ADMS_RCST_CD						/* 경유입원 수납상태 코드 */
		     ,  to_char(c.MDCR_DT, 'yyyymmddhh24miss')              as MDCR_DT                  /* 진료일시 */
		     ,  case
		            when exists (   select  1
		                              from  MDBMIMGRT
		                             where  PTNO     = a.PTNO
		                               and  ORDR_YMD = a.ORDR_YMD
		                               and  ORDR_SNO = a.ORDR_SNO
		                        ) then 'Y'
		            else 'N'
		            end                                             as IMAG_EN                  /* 이미지유무 */
		     ,  a.LAST_UPDR_ID                                      as LAST_UPDR_ID             /* 최종수정자ID */
		     ,  to_char(a.LAST_UPDT_DT, 'yyyymmddhh24miss')         as LAST_UPDT_DT             /* 최종수정일시 */
		     ,  a.CMTX_STTS_CD                                      as CMTX_STTS_CD             /* 협진상태코드 */
		     ,  a.CMTX_DVSN_CD                                      as CMTX_DVSN_CD             /* 협진구분코드 */
		     ,  a.WNTD_DR_MCDP_CD                                   as WNTD_DR_MCDP_CD          /* 희망진료과   */
		     ,  d.ABRV_DPRT_CD                                      as WNTD_DR_ABRV_MCDP_CD     /* 희망진료과약어코드 */
		     ,  d.KORN_DPRT_NM                                      as WNTD_DR_MCDP_NM          /* 희망진료과명 */
		     ,  a.WNTD_DR_ID                                        as WNTD_DR_ID               /* 희망의사ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.WNTD_DR_ID
		        )                                                   as WNTD_DR_NM               /* 희망의사명 */
		     ,  a.MCDP_CD                                           as MCDP_CD                  /* 환자진료부서코드 */
		     ,  (   select  ABRV_DPRT_CD
		              from  HZDEPTMMT
		             where  DPRT_CD = a.MCDP_CD
		        )                                                   as ABRV_MCDP_CD
		     ,  a.WARD_CD                                           as WARD_CD
		     ,  (   select  ABRV_DPRT_CD
		              from  HZDEPTMMT
		             where  DPRT_CD = a.WARD_CD
		        )                                                   as ABRV_WARD_CD
		     ,  to_char(a.FRST_RGST_DT, 'yyyymmddhh24miss')         as FRST_RGST_DT             /* 최초등록일시 */
		     ,  a.DLTN_YN                                           as DLTN_YN                  /* 삭제여부 */
		     ,  a.RCST_CD                                           as RCST_CD                  /* 수납상태코드 */
		     ,  a.INFM_DMND_TMLM_DVSN_CD                            as INFM_DMND_TMLM_DVSN_CD   /* 정보요구시한구분코드 */
		     ,  (   select  DETL_CD_NM
		              from  CCCMCDDMT
		             where  COMN_GRP_CD     =   'MDM_012'
		               and  COMN_DTLS_CD    =   a.INFM_DMND_TMLM_DVSN_CD
		        )                                                   as INFM_DMND_TMLM_DVSN_NM   /* 정보요구시한구분명 */
		     ,  a.DGTK_REAS_CTN                                     as DGTK_REAS_CTN            /* 약물복용이유(또는 질환) */
		     ,  a.DX_NM                                             as DX_NM                    /* 진단명 */
		     ,  a.DRUG_PRVC_CTN                                     as DRUG_PRVC_CTN            /* 약의 출처 */
		     ,  to_char(a.RTRN_RQST_DT, 'YYYYMMDDHH24MISS')         as RTRN_RQST_DT             /* 반납요청일시 */
		     ,  a.RTRN_STTS_CD                                      as RTRN_STTS_CD             /* 반납상태코드 */
		     ,  to_char(a.PRIN_DT, 'YYYYMMDDHH24MISS')              as PRIN_DT                  /* 출력일시 */
		     ,  to_char(a.APNT_DT, 'YYYYMMDDHH24MISS')              as APNT_DT                  /* 예약시간 */
		     ,  a.LNKN_ORDR_CLTY_CD                                 as LNKN_ORDR_CLTY_CD        /* 연결처방분류유형코드 */
		     ,  to_char(a.LNKN_ORDR_YMD, 'yyyymmdd')                as LNKN_ORDR_YMD            /* 연결처방일자 */
		     ,  a.LNKN_ORDR_SNO                                     as LNKN_ORDR_SNO            /* 연결처방일련번호 */
		     ,  to_char(a.WNTD_DT, 'YYYYMMDD')                      as WNTD_DT                  /* 희망일자 */
		  from  MDCONSRCT a
		     ,  APPTPTNTT b
		     ,  APRCRPTNT c
		     ,  HZDEPTMMT d
		 where  a.PTNO          =   #{ptno}
		   and  a.ORDR_YMD      =   to_date(#{ordrYmd}, 'yyyymmdd')
		   and  a.ORDR_SNO      =   #{ordrSno}
		   and  b.PTNO          =   a.PTNO
		   and  c.MDRP_NO       =   a.MDRP_NO
		   and  d.DPRT_CD   (+) =   a.WNTD_DR_MCDP_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneApsValdOprtCct-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="cct" column="CCT"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneApsValdOprtCct (APS 유효수술 건수 조회) 
        Description :                                           APS 유효수술 건수 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneApsValdOprtCct-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneApsValdOprtCct"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneApsValdOprtCct-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneApsValdOprtCct */
		<![CDATA[
		select  /*+ MdpAmptCmtxMngmDAO-selectOneApsValdOprtCct_7일이내 확정수술 건수 조회 */
		        count(a.PTNO) as CCT
		  from  MDOPSCHET a
		 where  a.PTNO = #{ptno}
		   and  a.OPRT_YMD between to_date(#{ordrYmd},'YYYYMMDD') - 7
		                       and to_date(#{ordrYmd},'YYYYMMDD') + 1       /* 의뢰일자 기준으로 과거 7일부터 내일까지 */
		   and  (nvl(a.ER_YN,'N') = 'Y' or a.OPRT_STTS_CD not in ('1','9')) /* 응급수술 또는 확정수술  */
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneNewOrdrSno-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="ordrSno" column="ORDR_SNO"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneNewOrdrSno (처방순번 채번) 
        Description :                                           처방순번 채번
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneNewOrdrSno-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneNewOrdrSno"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneNewOrdrSno-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneNewOrdrSno */
		<![CDATA[
		select  /*+ MdpAmptCmtxMngmDAO-selectOneNewOrdrSno_처방일련번호 채번 */
		        nvl(max(ORDR_SNO), 0) + 1   as ORDR_SNO
		  from  MDCONSRCT
		 where  ORDR_YMD = to_date(#{ordrYmd}, 'yyyymmdd')
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneRcmnAnag-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="apstYmd" column="APST_YMD"/>
		<result property="apfnYmd" column="APFN_YMD"/>
		<result property="frstRgsrId" column="FRST_RGSR_ID"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneRcmnAnag (추천 항균제 조회) 
        Description :                                           유효한 추천 항균제 내역을 조회힌다.
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneRcmnAnag-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneRcmnAnag"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneRcmnAnag-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneRcmnAnag */
		select  /* 유효한 추천항균제 조회 */
		        a.MDRP_NO                       as MDRP_NO
		     ,  a.ORDR_CD                       as ORDR_CD
		     ,  to_char(APST_YMD, 'YYYYMMDD')   as APST_YMD
		     ,  to_char(APFN_YMD, 'YYYYMMDD')   as APFN_YMD
		     ,  a.FRST_RGSR_ID                  as FRST_RGSR_ID
		  from  MDANTBRCT a
		 where  a.MDRP_NO   =   #{mdrpNo}
		   and  a.ORDR_CD   =   #{ordrCd}
		   and  trunc(sysdate) between a.APST_YMD and a.APFN_YMD
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneDummy-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="workNm" column="WORK_NM"/>
		<result property="midlRplyPublYn" column="MIDL_RPLY_PUBL_YN"/>
		<result property="inqrDvsnCd" column="INQR_DVSN_CD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneDummy (selectOneDummy) 
        Description :                                           selectOneDummy
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneDummy-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneDummy"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneDummy-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-selectOneDummy */
		select  'A'         as WORK_NM
		     ,  'N'         as MIDL_RPLY_PUBL_YN        -- 중간회신공개여부
		     ,  'A'         as INQR_DVSN_CD /* 조회구분코드 */
		  from  dual
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listMoblCmtxRply-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="ptno" column="PTNO"/>
		<result property="ordrYmd" column="ORDR_YMD"/>
		<result property="ordrSno" column="ORDR_SNO"/>
		<result property="mdrpNo" column="MDRP_NO"/>
		<result property="mdcrDt" column="MDCR_DT"/>
		<result property="ptntNm" column="PTNT_NM"/>
		<result property="gendCd" column="GEND_CD"/>
		<result property="btdt" column="BTDT"/>
		<result property="cmtxSttsCd" column="CMTX_STTS_CD"/>
		<result property="cmtxSttsNm" column="CMTX_STTS_NM"/>
		<result property="cmtxDvsnCd" column="CMTX_DVSN_CD"/>
		<result property="cmtxDvsnNm" column="CMTX_DVSN_NM"/>
		<result property="oddrMcdpCd" column="ODDR_MCDP_CD"/>
		<result property="oddrAbrvMcdpCd" column="ODDR_ABRV_MCDP_CD"/>
		<result property="oddrId" column="ODDR_ID"/>
		<result property="oddrNm" column="ODDR_NM"/>
		<result property="rplyYmd" column="RPLY_YMD"/>
		<result property="rplyDt" column="RPLY_DT"/>
		<result property="rplyDrMcdpCd" column="RPLY_DR_MCDP_CD"/>
		<result property="rplyDrAbrvMcdpCd" column="RPLY_DR_ABRV_MCDP_CD"/>
		<result property="rplyDrId" column="RPLY_DR_ID"/>
		<result property="codvCd" column="CODV_CD"/>
		<result property="erYn" column="ER_YN"/>
		<result property="erResnCd" column="ER_RESN_CD"/>
		<result property="rcstCd" column="RCST_CD"/>
		<result property="clrsPrjcCd" column="CLRS_PRJC_CD"/>
		<result property="clrsPrjcDrId" column="CLRS_PRJC_DR_ID"/>
		<result property="clrsPrjcDrNm" column="CLRS_PRJC_DR_NM"/>
		<result property="mcdpCd" column="MCDP_CD"/>
		<result property="abrvMcdpCd" column="ABRV_MCDP_CD"/>
		<result property="wardCd" column="WARD_CD"/>
		<result property="abrvWardCd" column="ABRV_WARD_CD"/>
		<result property="careWardCd" column="CARE_WARD_CD"/>
		<result property="careAbrvWardCd" column="CARE_ABRV_WARD_CD"/>
		<result property="carePtrmNo" column="CARE_PTRM_NO"/>
		<result property="chdrId" column="CHDR_ID"/>
		<result property="chdrNm" column="CHDR_NM"/>
		<result property="gndrId" column="GNDR_ID"/>
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
		<result property="wntdDrMcdpCd" column="WNTD_DR_MCDP_CD"/>
		<result property="wntdDrAbrvMcdpCd" column="WNTD_DR_ABRV_MCDP_CD"/>
		<result property="wntdDrMcdpNm" column="WNTD_DR_MCDP_NM"/>
		<result property="wntdDrId" column="WNTD_DR_ID"/>
		<result property="wntdDrNm" column="WNTD_DR_NM"/>
		<result property="implYmd" column="IMPL_YMD"/>
		<result property="inptUserDvsnCd" column="INPT_USER_DVSN_CD"/>
		<result property="wntdSctnCd" column="WNTD_SCTN_CD"/>
		<result property="cmtxSttsDt" column="CMTX_STTS_DT"/>
		<result property="erSmsrTrnmYn" column="ER_SMSR_TRNM_YN"/>
		<result property="rplyAlrmDvsnCd" column="RPLY_ALRM_DVSN_CD"/>
		<result property="dlivId" column="DLIV_ID"/>
		<result property="dlivCnfrDt" column="DLIV_CNFR_DT"/>
		<result property="midlRplrId" column="MIDL_RPLR_ID"/>
		<result property="rplyDrNm" column="RPLY_DR_NM"/>
		<result property="midlRplyCnfrDt" column="MIDL_RPLY_CNFR_DT"/>
		<result property="lastRplyId" column="LAST_RPLY_ID"/>
		<result property="lastRplyCnfrDt" column="LAST_RPLY_CNFR_DT"/>
		<result property="oddrClno" column="ODDR_CLNO"/>
		<result property="frstRgstDt" column="FRST_RGST_DT"/>
		<result property="prinDt" column="PRIN_DT"/>
		<result property="cmtxRefrWrtgYn" column="CMTX_REFR_WRTG_YN"/>
		<result property="cmtxRplyWrtgYn" column="CMTX_RPLY_WRTG_YN"/>
		<result property="hour24WthnRplyYn" column="HOUR24_WTHN_RPLY_YN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listMoblCmtxRply (모바일협진회신목록조회) 
        Description :                                           모바일협진회신목록조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listMoblCmtxRply-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listMoblCmtxRply"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listMoblCmtxRply-result" useCache="true" flushCache="false">
		<![CDATA[
		select  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listMoblCmtxRply */
		        a.PTNO                                              as PTNO                     /* 환자번호 */
		     ,  to_char(a.ORDR_YMD, 'yyyymmdd')                     as ORDR_YMD                 /* 처방일자 */
		     ,  a.ORDR_SNO                                          as ORDR_SNO                 /* 처방일련번호 */
		     ,  a.MDRP_NO                                           as MDRP_NO                  /* 진료접수번호 */
		     ,  to_char(b.MDCR_DT, 'yyyymmddhh24miss')              as MDCR_DT                  /* 진료일시 */
		     ,  c.PTNT_NM                                           as PTNT_NM                  /* 환자명 */
		     ,  c.GEND_CD                                           as GEND_CD                  /* 성별코드 */
		     ,  to_char(c.BTDT, 'yyyymmdd')                         as BTDT                     /* 생년월일 */
		     ,  a.CMTX_STTS_CD                                      as CMTX_STTS_CD             /* 협진상태코드(MM320) 0:임시저장 1:의뢰 2:전달확인 3:중간회신 4:최종회신 9:취소 */
		     ,  (   select  DETL_CD_NM
		              from  CCCMCDDMT
		             where  COMN_GRP_CD  = 'MM320'
		               and  COMN_DTLS_CD = a.CMTX_STTS_CD
		        ) || decode(a.ADTN_RPLY_YN, 'Y', '(추)', '')        as CMTX_STTS_NM             /* 협진상태명 */
		     ,  a.CMTX_DVSN_CD                                      as CMTX_DVSN_CD             /* 협진구분코드 */
		     ,  (   select  DETL_CD_NM
		              from  CCCMCDDMT
		             where  COMN_GRP_CD  = 'MM266'
		               and  COMN_DTLS_CD = a.CMTX_DVSN_CD
		        )                                                   as CMTX_DVSN_NM             /* 협진구분명 */
		     ,  a.ODDR_MCDP_CD                                      as ODDR_MCDP_CD             /* 처방의사진료과코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.ODDR_MCDP_CD
		        )                                                   as ODDR_ABRV_MCDP_CD        /* 처방의사약어진료과코드 */
		     ,  a.ODDR_ID                                           as ODDR_ID                  /* 처방의사ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.ODDR_ID
		        )                                                   as ODDR_NM                  /* 처방의사명 */
		     ,  to_char(a.RPLY_YMD, 'yyyymmdd')                     as RPLY_YMD                 /* 회신일자 */
		     ,  to_char(a.RPLY_YMD, 'yyyymmddhh24miss')             as RPLY_DT                  /* 회신일시 */
		     ,  a.RPLY_DR_MCDP_CD                                   as RPLY_DR_MCDP_CD          /* 회신의사진료과코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.RPLY_DR_MCDP_CD
		        )                                                   as RPLY_DR_ABRV_MCDP_CD     /* 회신의사약어진료과코드 */
		     ,  a.RPLY_DR_ID                                        as RPLY_DR_ID               /* 회신의사ID */
		     ,  a.CODV_CD                                           as CODV_CD                  /* 내원구분코드 */
		     ,  a.ER_YN                                             as ER_YN                    /* 응급여부 */
		     ,  a.ER_RESN_CD                                        as ER_RESN_CD               /* 응급사유코드 */
		     ,  a.RCST_CD                                           as RCST_CD                  /* 수납상태코드 */
		     ,  a.CLRS_PRJC_CD                                      as CLRS_PRJC_CD             /* 임상연구과제코드 */
		     ,  a.CLRS_PRJC_DR_ID                                   as CLRS_PRJC_DR_ID          /* 임상연구과제의사ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.CLRS_PRJC_DR_ID
		        )                                                   as CLRS_PRJC_DR_NM          /* 임상연구과제의사명 */
		     ,  a.MCDP_CD                                           as MCDP_CD                  /* 진료과코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.MCDP_CD
		        )                                                   as ABRV_MCDP_CD             /* 약어진료과코드 */
		     ,  a.WARD_CD                                           as WARD_CD                  /* 병동코드 */
		     ,  (   select  f_a.ABRV_DPRT_CD
		              from  HZDEPTMMT f_a
		             where  f_a.DPRT_CD = a.WARD_CD
		        )                                                   as ABRV_WARD_CD             /* 약어병동코드 */
		     ,  b.CARE_WARD_CD                                      as CARE_WARD_CD
		     ,  (   select  ABRV_DPRT_CD
		              from  HZDEPTMMT
		             where  DPRT_CD = b.CARE_WARD_CD
		        )                                                   as CARE_ABRV_WARD_CD        /* 재원약어병동코드 */
		     ,  b.CARE_PTRM_NO                                      as CARE_PTRM_NO
		     ,  a.CHDR_ID                                           as CHDR_ID                  /* 지정의사ID */
		     ,  (   select  USER_NM
		              from  CCUSRDPHT
		             where  USER_ID = a.CHDR_ID
		        )                                                   as CHDR_NM                  /* 지정의사명 */
		     ,  a.GNDR_ID                                           as GNDR_ID                  /* 주치의사ID */
		     ,  a.ORDR_CD                                           as ORDR_CD                  /* 처방코드 */
		     ,  (   select  ORDR_NM
		              from  MDORDRCMT
		             where  ORDR_CD = a.ORDR_CD
		        )                                                   as ORDR_NM                  /* 처방명 */
		     ,  a.WNTD_DR_MCDP_CD                                   as WNTD_DR_MCDP_CD          /* 희망의사진료과코드 */
		     ,  d.ABRV_DPRT_CD                                      as WNTD_DR_ABRV_MCDP_CD     /* 희망의사약어진료과코드 */
		     ,  d.KORN_DPRT_NM                                      as WNTD_DR_MCDP_NM          /* 희망의사진료과명 */
		     ,  a.WNTD_DR_ID                                        as WNTD_DR_ID               /* 희망의사ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.WNTD_DR_ID
		        )                                                   as WNTD_DR_NM               /* 희망의사명 */
		     ,  to_char(a.IMPL_YMD, 'yyyymmdd')                     as IMPL_YMD                 /* 실시일자 */
		     ,  a.INPT_USER_DVSN_CD                                 as INPT_USER_DVSN_CD        /* 입력사용자구분코드 (1.의사 2.간호사) */
		     ,  a.WNTD_SCTN_CD                                      as WNTD_SCTN_CD             /* 희망섹션코드 */
		     ,  to_char(a.CMTX_STTS_DT, 'yyyymmddhh24miss')         as CMTX_STTS_DT             /* 협진상태일시 */
		     ,  a.ER_SMSR_TRNM_YN                                   as ER_SMSR_TRNM_YN          /* 응급SMS송신여부 */
		     ,  a.RPLY_ALRM_DVSN_CD                                 as RPLY_ALRM_DVSN_CD        /* 회신알람구분코드 */  -- (신청시 중간,최종)
		     ,  a.DLIV_ID                                           as DLIV_ID                  /* 전달자ID */
		     ,  to_char(a.DLIV_CNFR_DT, 'yyyymmddhh24miss')         as DLIV_CNFR_DT             /* 전달자확인일시 */
		     ,  a.MIDL_RPLR_ID                                      as MIDL_RPLR_ID             /* 중간회신자ID */
		     ,  (   select  f_a.USER_NM
		              from  CCUSRDPHT f_a
		             where  f_a.USER_ID = a.MIDL_RPLR_ID
		        )                                                   as RPLY_DR_NM               /* 중간회신자명 */
		     ,  to_char(a.MIDL_RPLY_CNFR_DT, 'yyyymmddhh24miss')    as MIDL_RPLY_CNFR_DT        /* 중간회신확인일시 */
		     ,  a.LAST_RPLY_ID                                      as LAST_RPLY_ID             /* 최종회신ID */
		     ,  to_char(a.LAST_RPLY_CNFR_DT, 'yyyymmddhh24miss')    as LAST_RPLY_CNFR_DT        /* 최종회신확인일시 */
		     ,  (   select  fn_ap_wrap_telno(CLNO,'')
		              from  CCUSERAMV
		             where  LGIN_ID = a.ODDR_ID
		        )                                                   as ODDR_CLNO                /* 처방의사 휴대전화 */
		     ,  to_char(a.FRST_RGST_DT, 'yyyymmddhh24miss')         as FRST_RGST_DT             /* 최초등록일시 */
		     ,  to_char(a.PRIN_DT, 'yyyymmddhh24miss')              as PRIN_DT                  /* 출력일시 */
		     ,  decode(nvl(length(a.REFR_XML_BD), 0), 0, 'N', 'Y')  as CMTX_REFR_WRTG_YN        /* 협진의뢰작성여부 */
		     ,  decode(nvl(length(a.RPLY_XML_BD), 0), 0, 'N', 'Y')  as CMTX_RPLY_WRTG_YN        /* 협진회신작성여부 */
		     ,  case
		            when a.CMTX_STTS_CD = '4' then  case
		                                                when sign((a.FRST_RGST_DT + 1) - a.RPLY_YMD) = 1 then 'Y'
		                                                else 'N'
		                                                end
		            else ''
		            end                                             as HOUR24_WTHN_RPLY_YN      /* 24시간이내회신여부 */
		  from  MDCONSRCT a
		     ,  APRCRPTNT b
		     ,  APPTPTNTT c
		     ,  HZDEPTMMT d
		 where  nvl(a.DLTN_YN, 'N') =   'N'                     /* 삭제건 제외 */
		   and  b.MDRP_NO           =   a.MDRP_NO
		   and  b.CNCL_DT is null
		   and  c.PTNO              =   a.PTNO
		   and  d.DPRT_CD       (+) =   a.WNTD_DR_MCDP_CD       /* 희망의사진료과코드 */
		   and  a.ORDR_YMD between to_date(#{strtYmd}, 'yyyymmdd') and to_date(#{fnshYmd}, 'yyyymmdd')
		   and  a.WNTD_DR_MCDP_CD   =   #{wntdDrMcdpCd}
		   and  a.MIDL_RPLR_ID        =   nvl(#{midlRplrId}, a.MIDL_RPLR_ID)
		   and  a.CMTX_DVSN_CD = '1'          /* 진료협진만 : MM266  */
		   and  a.CMTX_STTS_CD = '3'  		  /* 중간회신 상태 : MM320 */
		   and  a.CMTX_RPLY_CTN is not null   /* 회신내용이 있고                   */
		   and  a.RPLY_XML_BD is null         /* XML 회신은 없는 경우       */
		 order
		    by  ORDR_YMD
		     ,  PTNO
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listBswrNotiTrgt-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="rplyDrId" column="RPLY_DR_ID"/>
		<result property="inqrDdlnYmd" column="INQR_DDLN_YMD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listBswrNotiTrgt (업무노티 대상 조회) 
        Description :                                           컨설트 의뢰시, 업무노티 대상을 조회한다 (MDBINDVET.NRPL_CMTX_INQR_DVSN_CD 참조)
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listBswrNotiTrgt-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listBswrNotiTrgt"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listBswrNotiTrgt-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listBswrNotiTrgt */
		select a.LGIN_ID as RPLY_DR_ID
		     , to_char(trunc(sysdate) + to_number(c.NRPL_CMTX_INPE_VL),'yyyymmdd') as INQR_DDLN_YMD
		  from
		       CCUSERAMT a -- NEXMED-EHR 사용자
		     , CCUSRDPHT b -- NEXMED-EHR 사용자 역할정보
		     , MDBINDVET c -- 개인환경정보
		 where
		       a.LGIN_ID not like 'S%'
		   and a.OCFM_CD        = 'HAA'
		   and a.USER_STTS_CD  != '9'
		   and sysdate between nvl(b.APST_YMD, sysdate - 1) and nvl(b.APFN_YMD, sysdate + 1)
		   and b.LGIN_ID       = a.LGIN_ID
		   and c.USER_ID       = b.USER_ID
		   and c.NRPL_CMTX_INPE_VL is not null
		   and (
		         (c.NRPL_CMTX_INQR_DVSN_CD = '1' and (#{wntdDrId} = c.USER_ID or #{midlRplrId} = c.USER_ID))
		          or
		         (c.NRPL_CMTX_INQR_DVSN_CD = '2' and b.MDCR_DPRT_CD  = #{wntdDrMcdpCd})
		       )
		<if test="userId != null and userId != ''">
		   and a.LGIN_ID = #{userId}
		</if>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRplyCmtxCnfrTrgtNurs-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="userId" column="USER_ID"/>
		<result property="inqrDdlnYmd" column="INQR_DDLN_YMD"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRplyCmtxCnfrTrgtNurs (회신협진 확인대상 간호사List 조회) 
        Description :                                           회신협진 확인대상 간호사List 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRplyCmtxCnfrTrgtNurs-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRplyCmtxCnfrTrgtNurs"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRplyCmtxCnfrTrgtNurs-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRplyCmtxCnfrTrgtNurs */
		select A.LGIN_ID     AS USER_ID
		     , to_char(trunc(sysdate+1),'yyyymmdd') as INQR_DDLN_YMD
		  from CCUSERAMT a   /* 사용자 */
			 , CCUSRDPHT b   /* 사용자 역할정보 */
		 where
		       a.OCFM_CD       = 'HAB'                           /* 직종코드 (HAB : 간호사)   */
		   and a.USER_STTS_CD not in ('9')                       /* '8' 휴직, '9' 퇴직 제외    */
		   and TRUNC(SYSDATE) BETWEEN a.APST_YMD AND a.APFN_YMD  /* 적용시작일~적용종료일 = 현재 재직 */
		   and b.USER_ID = A.LGIN_ID                             /* 사용자ID */
		   and TRUNC(SYSDATE) BETWEEN b.APST_YMD AND b.APFN_YMD  /* 적용시작일~적용종료일 = 현재 재직 */
		   and b.MDCR_DPRT_CD = #{careWardCd}
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRecvBswrNotcCctInqr-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="reptNtm" column="REPT_NTM"/>
		<result property="detlCdNm" column="DETL_CD_NM"/>
		<result property="notcDvsnCd" column="NOTC_DVSN_CD"/>
		<result property="iconName" column="ICON_NAME"/>
		<result property="formName" column="FORM_NAME"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRecvBswrNotcCctInqr (업무노티 카운트 조회) 
        Description :                                           업무노티 카운트 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRecvBswrNotcCctInqr-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRecvBswrNotcCctInqr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRecvBswrNotcCctInqr-result" useCache="true" flushCache="false">
		<![CDATA[
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listRecvBswrNotcCctInqr */
		select COUNT(a.RGST_SNO) AS "REPT_NTM"
		     , c.DETL_CD_NM
		     , a.NOTC_DVSN_CD
		     , d.COMN_ITEM_CHRC_VL AS "ICON_NAME"
		     , e.COMN_ITEM_CHRC_VL AS "FORM_NAME"
		  from
		     (
				select /*+ INDEX (A CUNOTIDMT_I02) LEADING(A) USE_NL(B) */
				       a.RGST_YMD
				     , a.RGST_SNO
				     , b.NOTC_DVSN_CD
				  from
				       CUNOTIDMT A -- 노티대상자
				     , CUNOTIMMT B -- 노티
				 where A.RCVR_ID  = #{rcvrId}
				   and A.INQR_DDLN_YMD >= trunc(sysdate)
				   and A.INQR_YN  = 'N'  -- 조회 여부(Y-조회, N-미조회)
				   and (A.NOTC_DLTN_YN is null or A.NOTC_DLTN_YN = 'N')
				   and A.RGST_YMD = B.RGST_YMD
				   and A.RGST_SNO = B.RGST_SNO
				   and B.TRSM_TYPE_CD = '4'
				   and B.TITL_NM is not null
				   and B.NOTC_DVSN_CD in ('M3','M4') -- M3:의사노티, M4:간호노티
		     ) a
		     , CCCMCDDMT c -- 공통코드값
		     , CCCMCDIDT d -- 공통코드추가항목값 (ICON_NAME)
		     , CCCMCDIDT e -- 공통코드추가항목값 (FORM_NAME)
		 where a.NOTC_DVSN_CD = c.COMN_DTLS_CD
		   and c.COMN_GRP_CD  = 'CUC_018'
		   and c.COMN_GRP_CD  = d.COMN_GRP_CD
		   and c.COMN_DTLS_CD = d.COMN_DTLS_CD
		   and d.COMN_ITEM_CD = 'ICON_NAME'
		   and c.COMN_GRP_CD  = e.COMN_GRP_CD
		   and c.COMN_DTLS_CD = e.COMN_DTLS_CD
		   and e.COMN_ITEM_CD = 'FORM_NAME'
		 group
		    by a.NOTC_DVSN_CD
		     , c.DETL_CD_NM
		     , d.COMN_ITEM_CHRC_VL
		     , e.COMN_ITEM_CHRC_VL
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listUsrRedvBswrNotc-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="rgstYmd" column="RGST_YMD"/>
		<result property="rgstSno" column="RGST_SNO"/>
		<result property="afiRturVl1" column="AFI_RTUR_VL_1"/>
		<result property="wrtrId" column="WRTR_ID"/>
		<result property="afiRturVl2" column="AFI_RTUR_VL_2"/>
		<result property="wrtgDt" column="WRTG_DT"/>
		<result property="rturVl" column="RTUR_VL"/>
		<result property="titlNm" column="TITL_NM"/>
		<result property="notcCtn" column="NOTC_CTN"/>
		<result property="gradDvsnCd" column="GRAD_DVSN_CD"/>
		<result property="afiRturVl3" column="AFI_RTUR_VL_3"/>
		<result property="trsmTypeCd" column="TRSM_TYPE_CD"/>
		<result property="afiRturVl4" column="AFI_RTUR_VL_4"/>
		<result property="dlvyFalrAdtnWorkYn" column="DLVY_FALR_ADTN_WORK_YN"/>
		<result property="ptno" column="PTNO"/>
		<result property="rcvrId" column="RCVR_ID"/>
		<result property="afiRturVl5" column="AFI_RTUR_VL_5"/>
		<result property="fldrDvsnCd" column="FLDR_DVSN_CD"/>
		<result property="inqrYn" column="INQR_YN"/>
		<result property="afiRturVl" column="AFI_RTUR_VL"/>
		<result property="dltnDt" column="DLTN_DT"/>
		<result property="dlvyYn" column="DLVY_YN"/>
		<result property="afiReptNtm1" column="AFI_REPT_NTM_1"/>
		<result property="afiRturVl6" column="AFI_RTUR_VL_6"/>
		<result property="afiRturVl7" column="AFI_RTUR_VL_7"/>
		<result property="afiRturVl8" column="AFI_RTUR_VL_8"/>
		<result property="respRqstYn" column="RESP_RQST_YN"/>
		<result property="notcRcvrCtn" column="NOTC_RCVR_CTN"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listUsrRedvBswrNotc (개인별 업무노티 수신함 list 조회) 
        Description :                                           개인별 업무노티 수신함 list 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listUsrRedvBswrNotc-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listUsrRedvBswrNotc"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listUsrRedvBswrNotc-result" useCache="true" flushCache="false">
				<![CDATA[
				select /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listUsrRedvBswrNotc */
				       /*+ LEADING(B) USE_NL(A) INDEX(B CUNOTIDMT_I01) */
					   to_char(a.RGST_YMD,'yyyy-mm-dd')  as RGST_YMD -- 등록일자
					 , a.RGST_SNO                        as RGST_SNO -- 등록일련번호
					 , '0'                               as AFI_RTUR_VL_1
					 , A.WRTR_ID                         as WRTR_ID  -- 작성자ID
					 , NVL((select USER_NM
						      from CCUSRDPHT
						     where USER_ID = A.WRTR_ID),'DARWIN') as AFI_RTUR_VL_2 -- 작성자명
					 , to_char(A.WRTG_DT,'yyyy-mm-dd')            as WRTG_DT -- 작성일자
					 , to_char(A.WRTG_DT,'YYYY-MM-DD HH24:MI:SS') as RTUR_VL -- 작성일시
					 , decode(A.PTNO, null, A.TITL_NM,
							 decode(instr(A.TITL_NM,A.PTNO,1),0,'['||A.PTNO||' '||
									 (select PTNT_NM
									    from APPTPTNTV
									   where PTNO = A.PTNO)
									 ||'] '||A.TITL_NM, A.TITL_NM )) as TITL_NM -- 제목명
					 , ''                                            as NOTC_CTN -- 노티내용
					 , (select DETL_CD_NM
					      from CCCMCDDMT
					     where COMN_GRP_CD  = 'CUC_019'
					       and COMN_DTLS_CD = A.GRAD_DVSN_CD)        as GRAD_DVSN_CD -- 노티등급구분코드 (보통,중요,긴급)
					 , (select PTNO||' / '||PTNT_NM||' / '||decode(GEND_CD,'M','남','여')||' / '||
						      case when floor(months_between(trunc(sysdate), BTDT)) > 36  then
							    		floor(months_between(trunc(sysdate), BTDT)/12)||'세'
								   when floor(months_between(trunc(sysdate), BTDT)) <= 36 and floor(months_between(trunc(sysdate), BTDT))>= 1 then
										floor(months_between(trunc(sysdate), BTDT))||'개월'
								   when floor(months_between(trunc(sysdate), BTDT)) = 0 then
										floor(trunc(sysdate)- BTDT)||'일'
							  end
						  from APPTPTNTV
						 where PTNO = A.PTNO) as AFI_RTUR_VL_3 /* 환자명 */
					 , a.TRSM_TYPE_CD         as TRSM_TYPE_CD  /* 발신유형코드(4:업무노티) */
					 , (select DETL_CD_NM
						  from CCCMCDDMT
						 where COMN_GRP_CD = 'CUC_020'
						   and COMN_DTLS_CD = A.TRSM_TYPE_CD)   as AFI_RTUR_VL_4 /* 발신유형코드명  */
					 , A.DLVY_FALR_ADTN_WORK_YN                 as DLVY_FALR_ADTN_WORK_YN /* 전달실패추가작업여부 */
					 , A.PTNO                                   as PTNO /* 환자번호 */
					 , B.RCVR_ID                                as RCVR_ID /* 수신자ID */
					 , (select  USER_NM
						  from  CCUSRDPHT
						 where  USER_ID = B.RCVR_ID)              as AFI_RTUR_VL_5 /* 수진자명 */
					 , B.FLDR_DVSN_CD                             as FLDR_DVSN_CD  /* 폴더구분코드(수신/발신/폐기/보관) */
					 , B.INQR_YN                                  as INQR_YN       /* 조회여부 */
					 , to_char(B.INQR_DT,'YYYY-MM-DD HH24:MI:SS') as AFI_RTUR_VL   /* 조회일시 */
					 , to_char(B.DLTN_DT,'yyyy-mm-dd')            as DLTN_DT       /* 삭제일시 */
					 , B.DLVY_YN                                  as DLVY_YN       /* 전달여부 */
					 , (select count(*)
					      from CUNOTIPMT
						 where RGST_YMD = A.RGST_YMD
						   and RGST_SNO = A.RGST_SNO) as AFI_REPT_NTM_1 /* 노티파라미터수 */
				     , (select sum(decode(nvl(INQR_YN,'N'),'Y',1,0))||'/'||count(*)
						  from CUNOTIDMT C
						 where RGST_YMD = A.RGST_YMD
						   and RGST_SNO = A.RGST_SNO)           as AFI_RTUR_VL_6 /* 노티확인비율 */
					 , (select HZDEPTMMT.KORN_DPRT_NM
						  from CCUSRDPHT
						     , HZDEPTMMT
						 where A.WRTR_ID =  CCUSRDPHT.USER_ID
						   and CCUSRDPHT.MDCR_DPRT_CD = HZDEPTMMT.DPRT_CD ) as AFI_RTUR_VL_7 /* 작성자부서명 */
				     , decode((select 1
								 from CUNOTIAFT
								where RGST_YMD = A.RGST_YMD
								  and RGST_SNO = A.RGST_SNO
								  and rownum = 1),1, '§ ','  ') ||
						      (select DETL_CD_NM
						         from CCCMCDDMT
						        where COMN_GRP_CD  = 'CUC_018'
							      and COMN_DTLS_CD = A.NOTC_DVSN_CD) as AFI_RTUR_VL_8 /* 노티구분코드(진료협진노티:M3, 간호협진노티:M4) */
					 , A.RESP_RQST_YN                                as RESP_RQST_YN /* 답변요청여부 */
				     , (select LISTAGG(RCVR_ID, ',') WITHIN GROUP (ORDER BY RCVR_ID)
				          from CUNOTIDMT x -- 노티대상자
				         where x.RGST_YMD = a.RGST_YMD
				           and x.RGST_SNO = a.RGST_SNO
				           and (x.NOTC_SNDG_CNCL_YN is null or x.NOTC_SNDG_CNCL_YN = 'N')
				           and ((x.NOTC_DLTN_YN = 'N') or x.NOTC_DLTN_YN is null)) as NOTC_RCVR_CTN  /* 동일노티 수신자ID */
				 from  CUNOTIMMT A -- 노티
				     , CUNOTIDMT B -- 노티대상자
				where B.RCVR_ID = #{rcvrId}
				  and (b.INQR_DDLN_YMD >= trunc(sysdate)
				       or
				       b.INQR_DDLN_YMD = trunc(sysdate+1))
				  and B.FLDR_DVSN_CD = #{fldrDvsnCd}
				  and A.NOTC_DVSN_CD like #{notcDvsnCd}||'%'
				  and A.TRSM_TYPE_CD = '4'
				  and ((A.NOTC_APNT_SNDG_EN = 'Y') or A.NOTC_APNT_SNDG_EN is null)    /* 노티 예약발송 발송전 노티건 제외 */
				  and ((A.TITL_NM like #{titlNm}||'%') and
				   	  (
					    (nvl( replace(#{userNm},'%',''),'*') = '*' )
					     or
					    ( A.WRTR_ID in (select USER_ID
						  				  from CCUSRDPHT
										 where APST_YMD <= sysdate
										   and APFN_YMD >= sysdate
										   and USER_NM like #{userNm}||'%')))
					  )
				  and A.RGST_YMD = B.RGST_YMD
				  and A.RGST_SNO = B.RGST_SNO
				  and (B.NOTC_SNDG_CNCL_YN is null or B.NOTC_SNDG_CNCL_YN = 'N' ) /* 노티수신자 발송취소건  제외  */
				  and ((B.NOTC_DLTN_YN = 'N') or B.NOTC_DLTN_YN is null)          /* 노티수신자함 삭제건 제외  */
				order by
				      A.WRTG_DT desc
		]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateBswrNotcInqrYn (업무노티 조회여부 갱신) 
        Description :                                           업무노티 조회여부 갱신
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateBswrNotcInqrYn"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  >
		update /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateBswrNotcInqrYn */
				       CUNOTIDMT
				   set INQR_YN                = #{inqrYn}
					 , INQR_DT                = sysdate
					 , LAST_UPDR_ID           = #{gvLginId}
				     , LAST_UPDT_IP           = #{gvUserIp}
					 , LAST_UPDT_DT           = sysdate
					 , LAST_UPDT_CLNT_PRGM_ID = #{gvClntPrgmId}
					 , LAST_UPDT_SRVR_PRGM_ID = #{gvSrvrPrgmId}
				 where  RGST_YMD = to_date( #{rgstYmd},'yyyy-mm-dd' )
				   and  RGST_SNO = #{rgstSno}
				 <if test='notcDvsnCd != null and notcDvsnCd != "M4"'>
				   and  RCVR_ID  = #{rcvrId}
				 </if>
	</update>


	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOutOrdr-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="ordrCd" column="ORDR_CD"/>
		<result property="ordrNm" column="ORDR_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOutOrdr (영양상담 외래환자 처방코드 조회) 
        Description :                       
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOutOrdr-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOutOrdr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOutOrdr-result" useCache="true" flushCache="false">
		<![CDATA[
		select  /*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listNtcnOutOrdr */
		        b.MDFE_CD           as ORDR_CD
		     ,  b.MDFE_KORN_NM      as ORDR_NM
		  from  SUCTRLMMT a /* 영양급식제어정보 */
		     ,  AIMFMDFET b /* 수가코드  */
		 where  a.NTRT_MLSR_CTRL_CD =   'SU_DBML'
		   and  b.MDFE_CD           =   a.NTRT_MLSR_DTLS_CTRL_CD
		   and  trunc(sysdate) between  b.APST_YMD and  b.APFN_YMD
		 order
		    by  b.MDFE_CD
		]]>
	</select>




	<resultMap id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listECHOperExam-result" type="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO">
	
		<result property="mdcrDtlsCtrlCd" column="MDCR_DTLS_CTRL_CD"/>
		<result property="opstPrrnDt" column="OPST_PRRN_DT"/>
		<result property="cscrNm" column="CSCR_NM"/>
		<result property="cmtxOprtCscrNm" column="CMTX_OPRT_CSCR_NM"/>
	</resultMap>
	
    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listECHOperExam () 
        Description :                                           심초음파(ECH) 의뢰시 가장 최근 수술예정 및 가장 최근 검사 조회
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
		resultMap : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listECHOperExam-result
    -->
	<select id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listECHOperExam"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  resultMap="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listECHOperExam-result" useCache="true" flushCache="false">
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listECHOperExam */
		<![CDATA[
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-listECHOperExam */
		SELECT 'O1' MDCR_DTLS_CTRL_CD
		       ,TO_CHAR(A.OPST_PRRN_DT,'YYYY-MM-DD') OPST_PRRN_DT
		      ,A.CSCR_NM
		      ,B.CMTX_OPRT_CSCR_NM
		  FROM
		    (
		    SELECT A.*
		      FROM
		        (
		        SELECT A.*
		          FROM MDOPSCHET A
		         WHERE A.OPRT_YMD >= SYSDATE   --현재일시 기준 가장 최근 수술예정일
		           AND A.CNCL_YMD IS NULL
		           AND A.PTNO = #{ptno}
		           AND A.OPRT_STTS_CD <> '9' --취소
		         ORDER BY A.OPST_PRRN_DT
		         )A
		      WHERE ROWNUM =1
		    ) A
		    ,MDOPSCCOT B
		WHERE B.PTNO(+) = A.PTNO
		  AND B.OPRT_YMD(+) = A.OPRT_YMD
		  AND B.OPRT_SNO(+) = A.OPRT_SNO
		  AND B.CMTX_OPRT_CSCR_NM(+) IS NOT NULL
		  AND ROWNUM = 1
		UNION ALL
		SELECT A.MDCR_DTLS_CTRL_CD
		      ,to_char(A.ENFR_DT,'yyyy-mm-dd')
		      ,A.EXMN_CD
		      ,A.EXRS_NCVL_VL
		  FROM
		    (
		    SELECT A.ENFR_DT
		          ,C.EXMN_CD
		          ,D.MDCR_DTLS_CTRL_CD
		          ,ROW_NUMBER() OVER (PARTITION BY D.MDCR_DTLS_CTRL_CD ORDER BY A.ENFR_DT DESC) RNUM
		          ,C.EXRS_NCVL_VL
		      FROM MDEXMORDT A
		          ,SZRESULMT C
		          ,( WITH MDK_0179_TMP AS
		                        (
		                        SELECT CTRL_SORT_SQNC,MDCR_CTRL_CD,MDCR_DTLS_CTRL_CD,MDCR_DTLS_CTRL_NM,MDCR_CTRL_CHRC_VL1,MDCR_CTRL_CHRC_VL2,MDCR_CTRL_CHRC_VL3,MDCR_CTRL_CHRC_VL4,MDCR_CTRL_CHRC_VL5
		                          FROM MZCTRLMMT
		                         WHERE MDCR_CTRL_CD = 'MDK_0179'
		                        )
		                        SELECT EXMN_CD,MDCR_DTLS_CTRL_CD,MDCR_DTLS_CTRL_NM,CTRL_SORT_SQNC
		                          FROM MDK_0179_TMP
		                         UNPIVOT(
		                                 EXMN_CD FOR MDCR_CTRL_CHRC_VL IN (MDCR_CTRL_CHRC_VL1,MDCR_CTRL_CHRC_VL2,MDCR_CTRL_CHRC_VL3,MDCR_CTRL_CHRC_VL4,MDCR_CTRL_CHRC_VL5)
		                         )
		           )D
		     WHERE 1=1
		       AND A.PTNO = #{ptno}
		       AND A.ENFR_DT  >= TRUNC(SYSDATE)-180  --검사시행일자 최근 6개월
		       AND NVL(A.TMPR_ORDR_YN,'N') = 'N'
		       AND NVL(A.DC_DVSN_CD,'N') = 'N'
		       AND C.PTNO = A.PTNO
		       AND C.ORDR_YMD = A.ORDR_YMD
		       AND C.ORDR_SNO = A.ORDR_SNO
		       AND C.EXMN_PRSS_CD = 'G'
		       AND C.EXMN_CD = D.EXMN_CD
		)A
		WHERE A.RNUM = 1
		]]>
	</select>






    <!--
        SQL Name : com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateAcclmccltBackRefr () 
        Description :                                           최종회신 취소시 수납내역 수정
                                            
		parameterType : com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO
    -->	
	<update id="com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateAcclmccltBackRefr"  parameterType="com.sds.healthcare.ehr.med.md.mdp.vo.MdpAmptCmtxMngmDVO"  >
		/*SQL_ID: com-sds-healthcare-ehr-med-md-mdp-dao-MdpAmptCmtxMngmDAO-updateAcclmccltBackRefr */
		/* 계산내역 취소 */
		update
		        ACCLMCCLT a
		set
		        CNCL_DT                 = sysdate
		     ,  LAST_UPDR_ID            =   #{gvUserId}
		     ,  LAST_UPDT_IP            =   #{gvUserIp}
		     ,  LAST_UPDT_DT            =   sysdate
		     ,  LAST_UPDT_CLNT_PRGM_ID  =   #{gvClntPrgmId}
		     ,  LAST_UPDT_SRVR_PRGM_ID  =   #{gvSrvrPrgmId}
		where   a.mdrp_no = #{ptadMdrpNo}
		and     a.ptno = #{ptno}
		and     a.ordr_ymd = to_date(#{ordrYmd}, 'YYYYMMDD')
		and     a.ordr_sno = #{ordrSno}
		and     a.cncl_dt is null
		and     a.orta_nm = 'MDCONSRCT'
	</update>

</mapper>